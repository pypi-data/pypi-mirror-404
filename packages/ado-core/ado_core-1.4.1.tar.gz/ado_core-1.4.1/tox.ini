[tox]
# Test matrix: Python versions 3.10-3.13
envlist: py3{10-13}

# We use the macos modifier to ensure we can exclude tests
# that require wheels that are not available on macOS
# (e.g., CUDA)
[testenv:py3{10-13}-macos]
description = "Tests to run on macOS machines"
platform = darwin

# Default test environment configuration
[testenv]
# Use uv for faster dependency resolution and installation
runner = uv-venv-lock-runner
description = "Tests to run on Linux machines"

# Tests consider linux by default
platform = linux

# Pass through CI environment variable for CI/CD detection
passenv=
    CI

# Environment variables for test execution
setenv=
    LC_ALL=en_GB.UTF-8
    LOGLEVEL=DEBUG
    RAY_TASK_MAX_RETRIES=0

# PEP 735 dependency groups from pyproject.toml
dependency_groups =
    dev
    test

# External commands allowed to be executed
allowlist_externals=
    printenv
    ls
    pwd
    rm
    uv
    pip

# Test commands executed in sequence
commands=
    # Display environment variables for debugging
    printenv
    
    # List installed packages
    uv pip list
    
    # Core test suite with coverage, parallel execution, and work stealing
    pytest -n auto --cov=orchestrator --cov=plugins/operators --dist worksteal -rx -vv --log-level=INFO --color=yes tests/
    
    # SFTTrainer tests (skipped on Python 3.13 due to compatibility issues)
    !py313: pytest -n auto --dist worksteal -rx -vv --log-level=INFO --color=yes plugins/actuators/sfttrainer/ado_actuators/sfttrainer/tests/
    
    # Test custom experiment examples
    ado describe experiment calculate_density
    run_experiment examples/density_example/point.yaml
    
    # Autoconf plugin tests
    pytest -n auto --dist worksteal -rx -vv --log-level=INFO --color=yes plugins/custom_experiments/autoconf/autoconf/test/
    
    # Ray Tune operator functionality tests
    ado get operator ray_tune
    ado template operation --operator-name=ray_tune
    
    # Random Walk operator functionality tests
    ado get operator random_walk
    ado template operation --operator-name=random_walk
    
    # vLLM Performance actuator tests (skipped on macOS due to compatibility issues)
    !macos: ado get actuators vllm_performance --details
    !macos: ado describe experiment test-deployment-v1
    !macos: ado template space --from-experiment test-deployment-v1
    
    # Run experiment command tests
    run_experiment examples/optimization_test_functions/point.yaml
    
    # Multi-cloud ML example tests (space creation, LHC sampler, random walk)
    ado create space -f examples/ml-multi-cloud/ml_multicloud_space.yaml --with store=tests/resources/ml_multicloud_sample_store.yaml
    ado -lINFO create operation -f examples/ml-multi-cloud/lhc_sampler.yaml --use-latest space
    ado -lINFO create op -f examples/ml-multi-cloud/randomwalk_ml_multicloud_operation.yaml --use-latest space
