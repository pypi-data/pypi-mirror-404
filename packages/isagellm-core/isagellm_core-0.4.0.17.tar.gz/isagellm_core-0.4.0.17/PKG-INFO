Metadata-Version: 2.4
Name: isagellm-core
Version: 0.4.0.17
Summary: sageLLM core runtime with PD separation (MVP)
Author: IntelliStream Team
License: Proprietary - IntelliStream
Classifier: Development Status :: 3 - Alpha
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Requires-Python: ==3.11.*
Description-Content-Type: text/markdown
Requires-Dist: pydantic>=2.0.0
Requires-Dist: pyyaml>=6.0.0
Requires-Dist: isagellm-protocol<0.5.0,>=0.4.0.0
Requires-Dist: isagellm-backend<0.5.0,>=0.4.0.0
Requires-Dist: isagellm-comm<0.5.0,>=0.4.0.0
Requires-Dist: isagellm-kv-cache<0.5.0,>=0.4.0.0
Requires-Dist: fastapi>=0.100.0
Requires-Dist: uvicorn>=0.22.0
Requires-Dist: torch>=2.0.0
Requires-Dist: transformers>=4.35.0
Requires-Dist: accelerate>=0.26.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: pytest-timeout>=2.0.0; extra == "dev"
Requires-Dist: ruff>=0.8.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"
Requires-Dist: types-PyYAML>=6.0.0; extra == "dev"
Requires-Dist: pre-commit>=3.0.0; extra == "dev"
Requires-Dist: isage-pypi-publisher>=0.2.0; extra == "dev"

# sagellm-core

## Protocol Compliance (Mandatory)

- MUST follow Protocol v0.1: https://github.com/intellistream/sagellm-docs/blob/main/docs/specs/protocol_v0.1.md
- Any globally shared definitions (fields, error codes, metrics, IDs, schemas) MUST be added to Protocol first.

[![CI](https://github.com/intellistream/sagellm-core/actions/workflows/ci.yml/badge.svg)](https://github.com/intellistream/sagellm-core/actions/workflows/ci.yml)
[![PyPI](https://img.shields.io/pypi/v/isagellm-core.svg)](https://pypi.org/project/isagellm-core/)
[![Python](https://img.shields.io/pypi/pyversions/isagellm-core.svg)](https://pypi.org/project/isagellm-core/)
[![License](https://img.shields.io/github/license/intellistream/sagellm-core.svg)](https://github.com/intellistream/sagellm-core/blob/main/LICENSE)
[![Code style: ruff](https://img.shields.io/badge/code%20style-ruff-000000.svg)](https://github.com/astral-sh/ruff)

sageLLM Core - å¼•æ“Žåè°ƒå±‚ä¸Žè¿è¡Œæ—¶ç³»ç»Ÿ

## æž¶æž„å®šä½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sagellm-core (å¼•æ“Žåè°ƒå±‚) â† æœ¬ä»“åº“                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LLMEngine (Hardware-Agnostic, vLLM v1 style)      â”‚    â”‚
â”‚  â”‚  â€¢ ç»Ÿä¸€æŽ¨ç†æŽ¥å£: generate, stream, execute         â”‚    â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨åŽç«¯é€‰æ‹© (auto-detect cuda/ascend/cpu)      â”‚    â”‚
â”‚  â”‚  â€¢ é…ç½®é©±åŠ¨ (LLMEngineConfig)                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Configuration System (config.py)                  â”‚    â”‚
â”‚  â”‚  â€¢ YAML/JSON é…ç½®è§£æž                               â”‚    â”‚
â”‚  â”‚  â€¢ Pydantic v2 ç±»åž‹éªŒè¯                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  sagellm-backend (ç¡¬ä»¶æŠ½è±¡å±‚)                               â”‚
â”‚  â€¢ BackendProvider (CPU/CUDA/Ascend)                       â”‚
â”‚  â€¢ Stream/Event/KVBlock ç®¡ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èŒè´£åˆ†ç¦»**ï¼š
- âœ… **Core è´Ÿè´£**ï¼šLLMEngine (ç¡¬ä»¶æ— å…³)ã€é…ç½®ã€åè°ƒ
- âœ… **Backend è´Ÿè´£**ï¼šç¡¬ä»¶æŠ½è±¡ã€è®¾å¤‡ç®¡ç†ã€Provider å®žçŽ°

## Features

- ðŸ”§ å¼•æ“ŽæŠ½è±¡å±‚ä¸Žè‡ªæè¿°æž¶æž„
- ðŸ­ EngineFactory - æ”¯æŒè‡ªåŠ¨å‘çŽ°ä¸Žä¼˜å…ˆçº§é€‰æ‹©
- ðŸŽ¯ å†…ç½®å¼•æ“Žå®žçŽ°ï¼ˆCPU/CUDA/Embeddingï¼‰
- ðŸ”Œ æ’ä»¶ç³»ç»Ÿ - æ‰©å±•å¼•æ“Žä¸ŽåŽç«¯
- âš™ï¸ é…ç½®ç³»ç»Ÿ - YAML/JSON + Pydantic v2
- âœ… CPU-First - æ—  GPU æµ‹è¯•æ”¯æŒ

## MoEï¼ˆè§„åˆ’ä¸­ï¼‰

- MoE è·¯ç”±/è°ƒåº¦/æ‰§è¡Œå›¾ç”± **sagellm-core** ä¸»è´£
- ä¾èµ– **sagellm-comm**ï¼ˆall-to-all/æ‹“æ‰‘é€šä¿¡ï¼‰ä¸Ž **sagellm-backend**ï¼ˆä¸“å®¶ç®—å­/å†…æ ¸ï¼‰
- éœ€å…ˆåœ¨ Protocol ä¸­è¡¥å……å…¨å±€å­—æ®µï¼ˆå¦‚ router å…ƒæ•°æ®ã€ä¸“å®¶è´Ÿè½½æŒ‡æ ‡ï¼‰

## å®‰è£…

```bash
# ä»Ž PyPI å®‰è£…ï¼ˆè‡ªåŠ¨å®‰è£… protocol + backend ä¾èµ–ï¼‰
pip install isagellm-core
```

## ðŸš€ å¼€å‘è€…å¿«é€Ÿå¼€å§‹

```bash
git clone git@github.com:intellistream/sagellm-core.git
cd sagellm-core
./quickstart.sh   # ä¸€é”®å®‰è£…å¼€å‘çŽ¯å¢ƒï¼ˆå«ä¾èµ–ï¼‰

# æˆ–æ‰‹åŠ¨å®‰è£…
pip install -e ".[dev]"
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
pytest tests/ -v
```

> ðŸ’¡ **æç¤º**ï¼š`isagellm-protocol` å’Œ `isagellm-backend` ä¼šè‡ªåŠ¨ä»Ž PyPI å®‰è£…ã€‚
> å¦‚éœ€æœ¬åœ°è”è°ƒï¼š
> ```bash
> pip install -e ../sagellm-protocol
> pip install -e ../sagellm-backend
> ```

## Configuration System

### ä½¿ç”¨æ–¹æ³•

```python
from sagellm_core import load_config, create_backend, create_engine

# ä»Ž YAML/JSON åŠ è½½é…ç½®
config = load_config("config.yaml")

# åˆ›å»º backend å’Œ engineï¼ˆé€šè¿‡æ’ä»¶å‘çŽ°ï¼‰
backend = create_backend(config.backend)
engine = create_engine(config.engine, backend)
```

### Configuration Structure

Main configuration components:
- `BackendConfig`: Device and backend settings
- `EngineConfig`: Inference engine configuration
- `WorkloadConfig`: Workload parameters
- `OutputConfig`: Output paths and logging

### é…ç½®ç¤ºä¾‹

#### ç¤ºä¾‹é…ç½®æ–‡ä»¶

- [config_cpu.yaml](examples/config_cpu.yaml) - CPU æ¨¡å¼ï¼ˆCI/å¼€å‘ï¼‰
- [config_cuda.yaml](examples/config_cuda.yaml) - CUDA ç”Ÿäº§æ¨¡å¼
- [config_ascend.yaml](examples/config_ascend.yaml) - æ˜‡è…¾ç”Ÿäº§æ¨¡å¼
- [config_minimal.json](examples/config_minimal.json) - æœ€å° JSON é…ç½®

æ›´å¤šä¿¡æ¯å‚è§ [examples/README.md](examples/README.md)

### é…ç½®æ ¼å¼

æ”¯æŒ YAMLï¼ˆæŽ¨èï¼‰å’Œ JSON æ ¼å¼ï¼š

```yaml
backend:
  kind: cpu
engine:
  kind: cpu
  model: sshleifer/tiny-gpt2
workload:
  segments: [short, long, stress]
  concurrency: 4
output:
  metrics_path: ./metrics.json
```

### æ’ä»¶è§£æž

å½“é…ç½®æŒ‡å®šçš„ backend/engine kind æœªå®‰è£…æ—¶ï¼Œä¼šæŠ›å‡º `PluginResolutionError`ï¼š

```python
from sagellm_core import create_backend, BackendConfig, PluginResolutionError

try:
    backend = create_backend(BackendConfig(kind="ascend_cann", device="npu:0"))
except PluginResolutionError as e:
    print(f"é”™è¯¯: {e}")
    # è¾“å‡º: No implementation found for sagellm.backends kind='ascend_cann'.
    #       Install hint: pip install isagellm-backend-ascend_cann
```

## Development Guide

### å¿«é€Ÿå¼€å§‹

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/intellistream/sagellm-core.git
cd sagellm-core

# å®‰è£…å¼€å‘ä¾èµ–
pip install -e ".[dev]"

# å®‰è£… pre-commit hooks
pre-commit install

# éªŒè¯çŽ¯å¢ƒ
pytest tests/ -v
```

### Testing and Quality

#### Pre-commit Hooks

å®‰è£…åŽï¼Œæ¯æ¬¡ `git commit` ä¼šè‡ªåŠ¨è¿è¡Œï¼š
- **Ruff**: ä»£ç æ ¼å¼åŒ– + Lint æ£€æŸ¥
- **Mypy**: é™æ€ç±»åž‹æ£€æŸ¥
- **YAML/JSON**: é…ç½®æ–‡ä»¶éªŒè¯

```bash
# æ‰‹åŠ¨è¿è¡Œæ‰€æœ‰ hooks
pre-commit run --all-files

# ç»•è¿‡ hooksï¼ˆç´§æ€¥æƒ…å†µï¼‰
git commit --no-verify
```

#### Running Tests

```bash
# Run all tests
pytest tests/ -v

# Run specific test module
pytest tests/unit/test_demo.py -v

# Generate coverage report
pytest tests/ --cov=sagellm_core --cov-report=html
```

#### Continuous Integration

GitHub Actions automatically runs on each PR:
- Code linting and formatting checks
- Tests across Python 3.10, 3.11, 3.12
- Package build verification

### Code Style

This project uses:
- **Ruff** for formatting and linting
- **Mypy** for type checking
- **Type hints** are required for all functions

For detailed guidelines, see [CONTRIBUTING.md](CONTRIBUTING.md)

### ä»£ç æ£€æŸ¥

```bash
# æ ¼å¼åŒ–ä»£ç 
ruff format .

# Lint æ£€æŸ¥
ruff check .

# ç±»åž‹æ£€æŸ¥
mypy src/sagellm_core

# ä¸€é”®æ£€æŸ¥æ‰€æœ‰
pre-commit run --all-files
```

## ä¾èµ–

- `pydantic>=2.0.0`: é…ç½®æ ¡éªŒ
- `pyyaml>=6.0.0`: YAML é…ç½®æ”¯æŒ
- `isagellm-protocol>=0.1.0,<0.2.0`: åè®®å®šä¹‰ï¼ˆLevel 0ï¼‰
- `isagellm-backend>=0.1.0,<0.2.0`: åŽç«¯æŠ½è±¡ï¼ˆLevel 1ï¼‰

## Related Packages

- `isagellm-protocol` - Protocol definitions
- `isagellm-backend` - Backend abstraction layer
- `isagellm` - Main package with CLI

For more packages, see the [sageLLM ecosystem](https://github.com/intellistream/sagellm)

## ðŸ”„ è´¡çŒ®æŒ‡å—

è¯·éµå¾ªä»¥ä¸‹å·¥ä½œæµç¨‹ï¼š

1. **åˆ›å»º Issue** - æè¿°é—®é¢˜/éœ€æ±‚
   ```bash
   gh issue create --title "[Bug] æè¿°" --label "bug,sagellm-core"
   ```

2. **å¼€å‘ä¿®å¤** - åœ¨æœ¬åœ° `fix/#123-xxx` åˆ†æ”¯è§£å†³
   ```bash
   git checkout -b fix/#123-xxx origin/main-dev
   # å¼€å‘ã€æµ‹è¯•...
   pytest -v
   ruff format . && ruff check . --fix
   ```

3. **å‘èµ· PR** - æäº¤åˆ° `main-dev` åˆ†æ”¯
   ```bash
   gh pr create --base main-dev --title "Fix: æè¿°" --body "Closes #123"
   ```

4. **åˆå¹¶** - å®¡æ‰¹åŽåˆå¹¶åˆ° `main-dev`

æ›´å¤šè¯¦æƒ…è§ [.github/copilot-instructions.md](.github/copilot-instructions.md)
