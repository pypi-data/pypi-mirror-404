<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>flexllm Chat</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11"></script>
<style>
:root { color-scheme: light; }
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Helvetica, Arial, sans-serif; background: #faf9f5; color: #111827; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

/* Header */
.header { display: flex; align-items: center; justify-content: space-between; padding: 1.25rem 1.5rem; background: #faf9f5; flex-shrink: 0; }
.header-left { display: flex; align-items: center; gap: 0.75rem; }
.logo { font-weight: 600; font-size: 1.25rem; color: #111827; }
.model-name { font-size: 13px; color: #6b7280; background: #f3f4f6; padding: 3px 10px; border-radius: 12px; }
.btn-new { width: 32px; height: 32px; padding: 0; background: #faf9f5; border: 1px solid #e5e7eb; border-radius: 0.5rem; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all .2s; }
.btn-new:hover { background: #f3f4f6; border-color: #d1d5db; color: #374151; }

/* Messages */
.messages { flex: 1; overflow-y: auto; padding: 2rem 1.5rem 3rem; display: flex; flex-direction: column; gap: 0.75rem; background: #faf9f5; }
.message { display: flex; max-width: 48rem; width: 100%; margin: 0 auto 0.5rem; }
.message.user { justify-content: flex-end; }
.message.ai { justify-content: flex-start; }
.bubble { line-height: 1.6; font-size: 15px; overflow-wrap: break-word; }
.message.user .bubble { background: #f3f4f6; color: #0d0d0d; border-radius: 1.25rem; padding: 0.8rem 1rem; max-width: 65%; transition: background-color .2s; }
.message.user .bubble:hover { background: #e5e7eb; }
.message.ai .bubble { background: transparent; color: #0d0d0d; padding: 0.5rem; margin-left: -0.5rem; border-radius: 0.5rem; max-width: 100%; transition: background-color .2s; }
.message.ai .bubble:hover { background: #f9fafb; }

/* Markdown in AI bubble */
.message.ai .bubble p { margin: 0.5em 0; }
.message.ai .bubble p:first-child { margin-top: 0; }
.message.ai .bubble p:last-child { margin-bottom: 0; }
.message.ai .bubble pre { margin: 0.8em 0; border-radius: 8px; overflow-x: auto; background: #fafafa !important; border: 1px solid #e5e7eb; position: relative; }
.message.ai .bubble pre code { padding: 14px; display: block; font-size: 13px; line-height: 1.5; background: transparent !important; }
.message.ai .bubble code { font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace; font-size: 0.9em; background: #f3f4f6; padding: 2px 5px; border-radius: 4px; }
.message.ai .bubble pre code { background: transparent !important; padding: 0; }
.message.ai .bubble ul, .message.ai .bubble ol { padding-left: 1.5em; margin: 0.5em 0; }
.message.ai .bubble blockquote { border-left: 3px solid #2563eb; padding-left: 12px; margin: 0.5em 0; color: #6b7280; }
.message.ai .bubble table { border-collapse: collapse; margin: 0.5em 0; width: 100%; }
.message.ai .bubble th, .message.ai .bubble td { border: 1px solid #d1d5db; padding: 6px 12px; text-align: left; }
.message.ai .bubble th { background: #f3f4f6; }

/* Copy button */
.code-block-wrapper { position: relative; }
.copy-btn { position: absolute; top: 6px; right: 6px; background: #ffffff; border: 1px solid #d1d5db; color: #6b7280; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; opacity: 0; transition: opacity .2s; }
.code-block-wrapper:hover .copy-btn { opacity: 1; }
.copy-btn:hover { background: #f3f4f6; color: #374151; }

/* Welcome */
.welcome { flex: 1; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 15px; }

/* Input area */
.input-area { padding: 1rem; padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px)); background: #faf9f5; flex-shrink: 0; }
.input-wrapper { max-width: 48rem; margin: 0 auto; border: 1px solid #d1d5db; border-radius: 1rem; background: #ffffff; display: flex; flex-direction: column; transition: border-color .2s, box-shadow .2s; }
.input-wrapper:focus-within { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
.input-wrapper textarea { flex: 1; resize: none; border: none; border-radius: 1rem 1rem 0 0; padding: 0.8rem 1rem 0.4rem; font-size: 1rem; font-family: inherit; background: transparent; color: #111827; outline: none; min-height: 80px; max-height: 200px; line-height: 1.5; }
.input-wrapper textarea::placeholder { color: #9ca3af; }
.input-actions { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; }
.btn-send { background: #111827; color: #ffffff; border: 1px solid #111827; border-radius: 0.5rem; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .2s; flex-shrink: 0; }
.btn-send:hover:not(:disabled) { background: #2563eb; border-color: #2563eb; }
.btn-send:disabled { cursor: not-allowed; border-color: #d1d5db; background: #e5e7eb; color: #9ca3af; }
.btn-stop { background: #ffffff !important; border-color: #111827 !important; color: #111827 !important; }
.btn-stop:hover:not(:disabled) { background: #f3f4f6 !important; }

/* Thinking block */
.thinking-block { margin-bottom: 8px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
.thinking-toggle { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f9fafb; cursor: pointer; font-size: 13px; color: #6b7280; user-select: none; border: none; width: 100%; text-align: left; transition: background-color .2s; }
.thinking-toggle:hover { background: #f3f4f6; }
.thinking-toggle .arrow { transition: transform .2s; display: inline-block; }
.thinking-toggle.open .arrow { transform: rotate(90deg); }
.thinking-content { padding: 8px 12px; font-size: 13px; color: #6b7280; line-height: 1.5; white-space: pre-wrap; display: none; max-height: 300px; overflow-y: auto; }
.thinking-content.open { display: block; }
.thinking-label { animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

/* Cursor blink */
.cursor { display: inline-block; width: 2px; height: 1em; background: #111827; animation: blink 1s step-end infinite; vertical-align: text-bottom; margin-left: 2px; }
@keyframes blink { 50% { opacity: 0; } }

/* Message actions (retry) */
.msg-actions { max-width: 48rem; margin: -4px auto 0; display: flex; gap: 8px; }
.msg-action-btn { background: none; border: none; color: #9ca3af; font-size: 12px; cursor: pointer; padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; transition: all .2s; }
.msg-action-btn:hover { color: #374151; background: #f3f4f6; }

/* Context toggle button */
.btn-ctx { border: 1px solid #e5e7eb; color: #6b7280; background: transparent; border-radius: 0.5rem; height: 36px; padding: 0 10px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all .2s; flex-shrink: 0; }
.btn-ctx:hover { border-color: #d1d5db; color: #374151; background: #f3f4f6; }
.btn-ctx.active { background: #111827; color: #ffffff; border-color: #111827; }
.btn-ctx.active:hover { background: #2563eb; border-color: #2563eb; }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <span class="logo">flexllm</span>
    <span class="model-name" id="modelName">loading...</span>
  </div>
  <button class="btn-new" onclick="newChat()" title="New Chat">+</button>
</div>

<div class="messages" id="messages">
  <div class="welcome" id="welcome">Send a message to start chatting</div>
</div>

<div class="input-area">
  <div class="input-wrapper">
    <textarea id="input" rows="1" placeholder="Type your message... (Enter to send, Shift+Enter for newline)" autofocus></textarea>
    <div class="input-actions">
      <button class="btn-ctx" id="ctxBtn" onclick="toggleContext()" title="切换是否携带对话上下文">上下文</button>
      <button class="btn-send" id="sendBtn" onclick="sendMessage()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const ctxBtn = document.getElementById('ctxBtn');
const welcomeEl = document.getElementById('welcome');
const modelNameEl = document.getElementById('modelName');

let chatHistory = [];
let isStreaming = false;
let abortController = null;
let withContext = false;

// Configure marked
marked.setOptions({
  highlight: (code, lang) => {
    if (lang && hljs.getLanguage(lang)) {
      return hljs.highlight(code, { language: lang }).value;
    }
    return hljs.highlightAuto(code).value;
  },
  breaks: true,
});

// Load config
fetch('/api/config').then(r => r.json()).then(cfg => {
  modelNameEl.textContent = cfg.model || 'unknown';
}).catch(() => {
  modelNameEl.textContent = 'offline';
});

// Auto-resize textarea
inputEl.addEventListener('input', () => {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
});

inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function newChat() {
  chatHistory = [];
  messagesEl.innerHTML = '<div class="welcome" id="welcome">Send a message to start chatting</div>';
  if (abortController) { abortController.abort(); abortController = null; }
  setStreaming(false);
  inputEl.focus();
}

function setStreaming(val) {
  isStreaming = val;
  sendBtn.disabled = val;
  if (val) {
    sendBtn.classList.add('btn-stop');
    sendBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';
    sendBtn.onclick = stopStreaming;
  } else {
    sendBtn.classList.remove('btn-stop');
    sendBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>';
    sendBtn.onclick = sendMessage;
    sendBtn.disabled = false;
  }
}

function stopStreaming() {
  if (abortController) { abortController.abort(); abortController = null; }
  setStreaming(false);
  // Remove cursor
  const cursor = document.querySelector('.cursor');
  if (cursor) cursor.remove();
}

function addMessage(role, content) {
  const welcomeDiv = document.getElementById('welcome');
  if (welcomeDiv) welcomeDiv.remove();

  const div = document.createElement('div');
  div.className = `message ${role}`;
  div.innerHTML = `<div class="bubble"></div>`;

  const bubble = div.querySelector('.bubble');
  if (role === 'user') {
    bubble.textContent = content;
  } else {
    bubble.innerHTML = renderMarkdown(content);
  }

  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return bubble;
}

function renderMarkdown(text) {
  let html = marked.parse(text);
  // Wrap pre blocks for copy button
  html = html.replace(/<pre><code(.*?)>([\s\S]*?)<\/code><\/pre>/g,
    '<div class="code-block-wrapper"><button class="copy-btn" onclick="copyCode(this)">Copy</button><pre><code$1>$2</code></pre></div>');
  return html;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function copyCode(btn) {
  const code = btn.nextElementSibling.querySelector('code');
  navigator.clipboard.writeText(code.textContent).then(() => {
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}

function toggleContext() {
  withContext = !withContext;
  ctxBtn.classList.toggle('active', withContext);
}

async function sendMessage() {
  const text = inputEl.value.trim();
  if (!text || isStreaming) return;

  inputEl.value = '';
  inputEl.style.height = 'auto';

  addMessage('user', text);
  chatHistory.push({ role: 'user', content: text });

  const messages = withContext ? [...chatHistory] : [{ role: 'user', content: text }];
  await doSend(messages);
}

function retryLast() {
  if (isStreaming || chatHistory.length === 0) return;
  // 移除最后的 assistant 回复
  if (chatHistory[chatHistory.length - 1].role === 'assistant') {
    chatHistory.pop();
  }
  // 移除 DOM 中最后的 AI 消息和操作按钮
  const actions = messagesEl.querySelector('.msg-actions');
  if (actions) actions.remove();
  const aiMsgs = messagesEl.querySelectorAll('.message.ai');
  if (aiMsgs.length) aiMsgs[aiMsgs.length - 1].remove();

  doSend([...chatHistory]);
}

async function doSend(messages) {
  // 移除旧的操作按钮
  const oldActions = messagesEl.querySelector('.msg-actions');
  if (oldActions) oldActions.remove();

  setStreaming(true);
  abortController = new AbortController();

  const aiBubble = addMessage('ai', '');
  aiBubble.innerHTML = '<span class="cursor"></span>';
  let fullContent = '';
  let thinkingContent = '';

  function updateBubble() {
    let html = '';
    if (thinkingContent) {
      html += `<div class="thinking-block">
        <button class="thinking-toggle open" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
          <span class="arrow">&#9654;</span> <span class="thinking-label">Thinking...</span>
        </button>
        <div class="thinking-content open">${escapeHtml(thinkingContent)}</div>
      </div>`;
    }
    html += renderMarkdown(fullContent) + '<span class="cursor"></span>';
    aiBubble.innerHTML = html;
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  try {
    const resp = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages }),
      signal: abortController.signal,
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const jsonStr = line.slice(6);
        try {
          const event = JSON.parse(jsonStr);
          if (event.type === 'thinking') {
            thinkingContent += event.content;
            updateBubble();
          } else if (event.type === 'content') {
            fullContent += event.content;
            updateBubble();
          } else if (event.type === 'done') {
            // done
          } else if (event.type === 'error') {
            fullContent += `\n\n**Error:** ${event.message}`;
            updateBubble();
          }
        } catch {}
      }
    }
  } catch (e) {
    if (e.name !== 'AbortError') {
      fullContent += fullContent ? `\n\n**Error:** ${e.message}` : `**Error:** ${e.message}`;
    }
  }

  // Finalize
  let finalHtml = '';
  if (thinkingContent) {
    finalHtml += `<div class="thinking-block">
      <button class="thinking-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
        <span class="arrow">&#9654;</span> Thought for a moment
      </button>
      <div class="thinking-content">${escapeHtml(thinkingContent)}</div>
    </div>`;
  }
  finalHtml += renderMarkdown(fullContent || '*(empty response)*');
  aiBubble.innerHTML = finalHtml;
  if (fullContent) {
    chatHistory.push({ role: 'assistant', content: fullContent });
  }

  // 添加重试按钮
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'msg-actions';
  actionsDiv.innerHTML = '<button class="msg-action-btn" onclick="retryLast()">↻ 重试</button>';
  messagesEl.appendChild(actionsDiv);

  setStreaming(false);
  abortController = null;
  inputEl.focus();
}
</script>
</body>
</html>
