"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[8402],{8402:(t,e,n)=>{n.r(e),n.d(e,{d2Plugin:()=>o});var i=n(89379),r=n(28004);class a{constructor(){this.nodes=new Map,this.edges=[],this.containers=new Map,this.currentContainer=null,this.containerStack=[],this.reset()}reset(){this.nodes.clear(),this.edges=[],this.containers.clear(),this.containerStack=[],this.currentContainer=null}parse(t){this.reset();const e=t.split("\n").map(t=>t.trim()).filter(t=>t&&!t.startsWith("#"));for(const n of e)this.parseLine(n);return{nodes:Array.from(this.nodes.values()),edges:this.edges,containers:Array.from(this.containers.values())}}parseLine(t){if(t.endsWith("{")){const e=t.replace("{","").trim();return this.currentContainer&&this.containerStack.push(this.currentContainer),this.currentContainer=e,void this.containers.set(e,{id:e,label:e,type:"container",children:[],parent:this.containerStack.length>0?this.containerStack[this.containerStack.length-1]:null})}"}"!==t?t.includes("->")||t.includes("<->")||t.includes("<-")?this.parseConnection(t):t.includes(":")&&(t.includes("{")||t.includes("}"))?this.parseNodeWithProperties(t):t.includes(":")?this.parseSimpleNode(t):t.includes(".")&&t.includes(":")&&this.parseStyleDefinition(t):this.currentContainer=this.containerStack.pop()||null}parseConnection(t){const e=t.match(/([^-<>]+)(\s*<?-+>?\s*)([^-<>]+)(?:\s*:\s*(.+))?/);if(e){var n;let t=e[1].trim();const i=e[2].trim();let r=e[3].trim();const a=null===(n=e[4])||void 0===n?void 0:n.trim();t=this.resolvePath(t),r=this.resolvePath(r),this.ensureNode(t),this.ensureNode(r);const s={source:this.normalizeNodeId(t),target:this.normalizeNodeId(r),label:a||"",bidirectional:i.includes("<->"),reversed:i.startsWith("<-")&&!i.includes("<->")};this.edges.push(s)}}parseSimpleNode(t){const e=t.split(":");if(e.length>=2){const t=e[0].trim(),n=e.slice(1).join(":").trim();this.nodes.set(t,{id:this.normalizeNodeId(t),label:n||t,originalId:t,container:this.currentContainer}),this.currentContainer&&this.containers.has(this.currentContainer)&&this.containers.get(this.currentContainer).children.push(t)}}parseNodeWithProperties(t){const e=t.match(/([^:]+):\s*\{([^}]+)\}/);if(e){const t=e[1].trim(),n=e[2].trim(),i=this.nodes.get(t)||{id:this.normalizeNodeId(t),label:t,originalId:t,container:this.currentContainer},r=this.parseProperties(n);Object.assign(i,r),this.nodes.set(t,i),this.currentContainer&&this.containers.has(this.currentContainer)&&this.containers.get(this.currentContainer).children.push(t)}}parseStyleDefinition(t){const e=t.match(/([^:]+):\s*(.+)/);if(e){const t=e[1].trim();e[2].trim();if(t.startsWith("*.")){t.substring(2)}}}parseProperties(t){const e={},n=t.split(";");for(const i of n){const[t,n]=i.split(":").map(t=>t.trim());t&&n&&(e[t]=n)}return e}resolvePath(t){if(t.includes(".")){const e=t.split(".");return e[e.length-1]}return t}ensureNode(t){this.nodes.has(t)||this.nodes.set(t,{id:this.normalizeNodeId(t),label:t,originalId:t,container:this.currentContainer})}normalizeNodeId(t){return t.replace(/[^a-zA-Z0-9]/g,"_")}}class s{constructor(){this.elk=null}async initialize(){if(!this.elk){const t=(await n.e(52604).then(n.t.bind(n,52604,23))).default;this.elk=new t}}async layout(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(0===t.length)return{nodes:[],edges:[]};await this.initialize();const r={id:"root",layoutOptions:(0,i.A)({"elk.algorithm":n.algorithm||"layered","elk.direction":n.direction||"DOWN","elk.spacing.nodeNode":n.nodeSpacing||"50","elk.layered.spacing.nodeNodeBetweenLayers":n.layerSpacing||"50","elk.spacing.edgeNode":"30","elk.spacing.edgeEdge":"15","elk.layered.crossingMinimization.strategy":"LAYER_SWEEP","elk.layered.nodePlacement.strategy":"BRANDES_KOEPF","elk.layered.cycleBreaking.strategy":"GREEDY","elk.insideSelfLoops.activate":"true"},n),children:t.map(t=>({id:t.id,width:this.calculateNodeWidth(t.label||t.id),height:this.calculateNodeHeight(t.label||t.id),labels:t.label?[{text:t.label,layoutOptions:{"elk.labelManager":"none"}}]:[],layoutOptions:{"elk.nodeSize.constraints":"NODE_LABELS","elk.nodeSize.options":"DEFAULT_MINIMUM_SIZE COMPUTE_PADDING","elk.padding":"[top=10,left=15,bottom=10,right=15]"}})),edges:e.map(t=>({id:"".concat(t.source,"_").concat(t.target),sources:[t.source],targets:[t.target],labels:t.label?[{text:t.label,layoutOptions:{"elk.edgeLabels.placement":"CENTER"}}]:[],layoutOptions:{"elk.edge.type":t.bidirectional?"UNDIRECTED":"DIRECTED"}}))};try{var a;const n=await this.elk.layout(r);return{nodes:(null===(a=n.children)||void 0===a?void 0:a.map(e=>{const n=t.find(t=>t.id===e.id);return(0,i.A)((0,i.A)({},n),{},{x:e.x||0,y:e.y||0,width:e.width||100,height:e.height||50})}))||[],edges:e}}catch(s){return console.warn("ELK layout failed, falling back to simple layout:",s),this.simpleGridLayout(t,e)}}calculateNodeWidth(t){return Math.max(80,Math.min(8*t.length+30,200))}calculateNodeHeight(t){const e=Math.ceil(8*t.length/180);return Math.max(40,40+16*(e-1))}simpleGridLayout(t,e){const n=Math.ceil(Math.sqrt(t.length));return t.forEach((t,e)=>{const i=Math.floor(e/n),r=e%n;t.x=150*r+100,t.y=150*i+100,t.width=this.calculateNodeWidth(t.label||t.id),t.height=this.calculateNodeHeight(t.label||t.id)}),{nodes:t,edges:e}}}const o={name:"d2-renderer",priority:6,sizingConfig:{sizingStrategy:"auto-expand",needsDynamicHeight:!0,needsOverflowVisible:!0,observeResize:!0,containerStyles:{width:"100%",height:"auto",overflow:"visible"}},canHandle:t=>"object"===typeof t&&null!==t&&"d2"===t.type&&"string"===typeof t.definition&&t.definition.trim().length>0,isDefinitionComplete:t=>{if(!t||0===t.trim().length)return!1;const e=t.trim().split("\n").filter(t=>t.trim());if(0===e.length)return!1;const n=e.some(t=>t.includes("->")||t.includes("<->")||t.includes("<-")),i=e.some(t=>t.includes(":"));return n||i},render:async(t,e,n,i)=>{try{if(n.isStreaming&&!n.forceRender){if(!o.isDefinitionComplete(n.definition))return void(t.innerHTML='\n                        <div style="text-align: center; padding: 20px; background-color: '.concat(i?"#1f1f1f":"#f6f8fa",'; border: 1px dashed #ccc; border-radius: 4px;">\n                            <p>Waiting for complete D2 definition...</p>\n                        </div>\n                    '))}const d=(0,r.k)(n.definition,"d2"),l=new a,{nodes:c,edges:h,containers:p}=l.parse(d);if(0===c.length)return void(t.innerHTML='\n                    <div style="text-align: center; padding: 20px; color: '.concat(i?"#ff6b6b":"#d63031",';">\n                        <p>No nodes found in D2 definition</p>\n                    </div>\n                '));const f=new s,g={algorithm:n.layout||"layered",direction:p.length>0?"DOWN":"RIGHT",nodeSpacing:"60",layerSpacing:"80"},u=await f.layout(c,h,g);t.innerHTML="";const m=e.select(t).append("svg").attr("width","100%").attr("height",()=>{const t=Math.max(...u.nodes.map(t=>t.y+t.height));return Math.max(400,t+100)+"px"}).attr("viewBox",()=>{const t=Math.max(...u.nodes.map(t=>t.x+t.width)),e=Math.max(...u.nodes.map(t=>t.y+t.height));return"0 0 ".concat(Math.max(800,t+100)," ").concat(Math.max(400,e+100))}),y={node:i?"#4361ee":"#e3f2fd",nodeStroke:i?"#4cc9f0":"#1976d2",edge:i?"#f72585":"#666666",text:i?"#ffffff":"#000000"};p.length>0&&m.selectAll(".container").data(p).enter().append("rect").attr("class","container").attr("x",t=>Math.min(...t.children.map(t=>{const e=u.nodes.find(e=>e.originalId===t);return e?e.x-20:0}))).attr("y",t=>Math.min(...t.children.map(t=>{const e=u.nodes.find(e=>e.originalId===t);return e?e.y-20:0}))).attr("width",t=>Math.max(...t.children.map(t=>{const e=u.nodes.find(e=>e.originalId===t);return e?e.x+e.width+40:100}))-Math.min(...t.children.map(t=>{const e=u.nodes.find(e=>e.originalId===t);return e?e.x-20:0}))).attr("height",t=>Math.max(...t.children.map(t=>{const e=u.nodes.find(e=>e.originalId===t);return e?e.y+e.height+40:50}))-Math.min(...t.children.map(t=>{const e=u.nodes.find(e=>e.originalId===t);return e?e.y-20:0}))).attr("fill","none").attr("stroke",i?"#4cc9f0":"#1976d2").attr("stroke-width",2).attr("stroke-dasharray","5,5").attr("rx",10),m.append("defs").append("marker").attr("id","arrowhead").attr("viewBox","0 -5 10 10").attr("refX",8).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill",y.edge),m.selectAll(".edge").data(u.edges).enter().append("line").attr("class","edge").attr("x1",t=>{const e=u.nodes.find(e=>e.id===t.source);return e?e.x+e.width/2:0}).attr("y1",t=>{const e=u.nodes.find(e=>e.id===t.source);return e?e.y+e.height/2:0}).attr("x2",t=>{const e=u.nodes.find(e=>e.id===t.target);return e?e.x+e.width/2:0}).attr("y2",t=>{const e=u.nodes.find(e=>e.id===t.target);return e?e.y+e.height/2:0}).attr("stroke",y.edge).attr("stroke-width",2).attr("marker-end","url(#arrowhead)");const x=m.selectAll(".node").data(u.nodes).enter().append("g").attr("class","node").attr("transform",t=>"translate(".concat(t.x,", ").concat(t.y,")"));x.append("rect").attr("width",t=>t.width).attr("height",t=>t.height).attr("fill",y.node).attr("stroke",y.nodeStroke).attr("stroke-width",2).attr("rx",5),x.append("text").attr("x",t=>t.width/2).attr("y",t=>t.height/2).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill",y.text).attr("font-family","Arial, sans-serif").attr("font-size","12px").text(t=>t.label),m.selectAll(".edge-label").data(u.edges.filter(t=>t.label)).enter().append("text").attr("class","edge-label").attr("x",t=>{const e=u.nodes.find(e=>e.id===t.source),n=u.nodes.find(e=>e.id===t.target);return e&&n?(e.x+e.width/2+n.x+n.width/2)/2:0}).attr("y",t=>{const e=u.nodes.find(e=>e.id===t.source),n=u.nodes.find(e=>e.id===t.target);return e&&n?(e.y+e.height/2+n.y+n.height/2)/2:0}).attr("text-anchor","middle").attr("dominant-baseline","middle").attr("fill",y.text).attr("font-family","Arial, sans-serif").attr("font-size","10px").attr("background",i?"#1f1f1f":"#ffffff").text(t=>t.label)}catch(d){console.error("D2 rendering error:",d),t.innerHTML='\n                <div style="\n                    padding: 20px;\n                    background-color: '.concat(i?"#2a1f1f":"#fff2f0",";\n                    border: 1px solid ").concat(i?"#a61d24":"#ffa39e",";\n                    border-radius: 6px;\n                    color: ").concat(i?"#ff7875":"#cf1322",';\n                ">\n                    <strong>D2 Rendering Error:</strong>\n                    <pre style="margin: 10px 0; white-space: pre-wrap;">').concat(d instanceof Error?d.message:"Unknown error",'</pre>\n                    <details style="margin-top: 10px;">\n                        <summary style="cursor: pointer; font-weight: bold;">Show D2 Definition</summary>\n                        <pre style="\n                            margin: 10px 0;\n                            padding: 10px;\n                            background-color: ').concat(i?"#1f1f1f":"#f6f8fa",';\n                            border-radius: 4px;\n                            overflow-x: auto;\n                            white-space: pre-wrap;\n                        "><code>').concat(n.definition,"</code></pre>\n                    </details>\n                </div>\n            ")}}}}}]);
//# sourceMappingURL=8402.5bd263bd.chunk.js.map