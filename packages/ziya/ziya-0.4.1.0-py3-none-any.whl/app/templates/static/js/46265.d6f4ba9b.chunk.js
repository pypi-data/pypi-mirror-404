"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[46265],{46265:(e,n,t)=>{t.r(n),t.d(n,{default:()=>_});var s=t(89379),a=t(65043),i=(t(85271),t(6381)),o=t(32442),l=t(42214),r=t(6658),c=t(22019),d=t(91957),m=t(94828),g=t(15492),h=t(76775),p=t(57721),u=t(47609),x=t(46833),f=t(15615),y=t(88143),v=t(31219),j=t(94471),C=t(61966),A=t(33359),w=t(70579);const b=e=>{let{index:n,isInline:t=!1}=e;const{currentMessages:b,currentConversationId:k,addMessageToConversation:S,setIsStreaming:M,setConversations:I,streamingConversations:R,addStreamingConversation:z,streamedContentMap:E,setStreamedContentMap:N,removeStreamingConversation:T,editingMessageIndex:F,setEditingMessageIndex:K}=(0,i.v)(),[_,O]=(0,a.useState)(b[n].content),{checkedKeys:D}=(0,l.X)(),[W,B]=(0,a.useState)([]),[L,P]=(0,a.useState)(!1),H=(0,a.useRef)(null),Y=(0,a.useRef)(null),{TextArea:U}=r.A,q=F===n;(0,a.useEffect)(()=>{q&&Y.current&&setTimeout(()=>{Y.current&&Y.current.focus()},100)},[q]),(0,a.useEffect)(()=>{u.v.getCapabilities().then(e=>P(e.supports_vision||!1)).catch(()=>P(!1))},[]),(0,a.useEffect)(()=>{if(q){const e=b[n].images||[];B(e)}},[q,n,b]);const X=async e=>{if(!e||0===e.length)return;if(W.length+e.length>5)c.Ay.warning("Maximum ".concat(5," images per message"));else{for(let t=0;t<e.length;t++){const s=e[t];if(s.type.startsWith("image/"))if(s.size>5242880)c.Ay.error("".concat(s.name," is too large (max 5MB)"));else try{const e=new FileReader,n=await new Promise((n,t)=>{e.onload=()=>n(e.result),e.onerror=t,e.readAsDataURL(s)}),t=n.match(/^data:(.+);base64,(.+)$/);if(!t)throw new Error("Invalid image data format");const[,a,i]=t,o=new Image;await new Promise((e,t)=>{o.onload=e,o.onerror=t,o.src=n});const l={data:i,mediaType:a,filename:s.name,size:s.size,width:o.width,height:o.height};B(e=>[...e,l]),c.Ay.success("Added ".concat(s.name))}catch(n){console.error("Error reading image:",n),c.Ay.error("Failed to load ".concat(s.name))}else c.Ay.error("".concat(s.name," is not an image file"))}H.current&&(H.current.value="")}};return(0,w.jsxs)("div",{children:[t&&q&&null,q&&!t&&(0,w.jsxs)("div",{style:{width:"100%"},children:[(0,w.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px",width:"100%"},children:[(0,w.jsx)("div",{className:"message-sender",children:"You:"}),(0,w.jsxs)(d.A,{children:[(0,w.jsx)(m.A,{title:"Attach image",children:(0,w.jsx)(g.Ay,{icon:(0,w.jsx)(x.A,{}),onClick:()=>{var e;L?null===(e=H.current)||void 0===e||e.click():c.Ay.warning("Current model does not support image attachments")},size:"small",disabled:!L||W.length>=5})}),(0,w.jsx)(m.A,{title:"Cancel editing",children:(0,w.jsx)(g.Ay,{icon:(0,w.jsx)(f.A,{}),onClick:()=>{K(null),O(b[n].content)},size:"small",children:"Cancel"})}),(0,w.jsx)(m.A,{title:"Save changes to context",children:(0,w.jsx)(g.Ay,{icon:(0,w.jsx)(y.A,{}),onClick:()=>{I(e=>e.map(e=>{if(e.id===k){const t=e.messages.map((e,t)=>t===n?(0,s.A)((0,s.A)({},e),{},{content:_,images:W.length>0?W:void 0,_timestamp:Date.now()}):e);return(0,s.A)((0,s.A)({},e),{},{messages:t,_version:Date.now()})}return e})),K(null)},size:"small",children:"Save"})}),(0,w.jsx)(m.A,{title:"Send to model, remove newer responses",children:(0,w.jsx)(g.Ay,{icon:(0,w.jsx)(v.A,{}),onClick:async()=>{K(null),B([]),N(new Map);const e=b.slice(0,n+1);e[n]=(0,s.A)((0,s.A)({},e[n]),{},{content:_,images:W.length>0?W:void 0,_timestamp:Date.now(),_edited:!0,_truncatedAfter:!0}),I(n=>n.map(n=>n.id===k?(0,s.A)((0,s.A)({},n),{},{messages:e,_version:Date.now(),_editInProgress:!0}):n)),z(k);try{await(0,o.fu)(e,_,(0,p.F)(D),k,E,N,M,T,S,R.has(k))&&I(e=>e.map(e=>e.id===k?(0,s.A)((0,s.A)({},e),{},{_editInProgress:!1}):e))}catch(t){console.error("Error sending message:",t),T(k)}finally{M(!1)}},size:"small",type:"primary",children:"Submit"})})]})]}),W.length>0&&(0,w.jsx)("div",{style:{marginBottom:"12px",display:"flex",gap:"8px",flexWrap:"wrap"},children:W.map((e,n)=>(0,w.jsxs)("div",{style:{position:"relative",display:"inline-block"},children:[(0,w.jsx)(h.A,{src:"data:".concat(e.mediaType,";base64,").concat(e.data),alt:e.filename||"Attached image",width:120,height:120,style:{objectFit:"cover",borderRadius:"4px",border:"1px solid #d9d9d9"},preview:{mask:(0,w.jsx)(j.A,{})}}),(0,w.jsx)(g.Ay,{type:"primary",danger:!0,size:"small",icon:(0,w.jsx)(C.A,{}),onClick:()=>(e=>{B(n=>n.filter((n,t)=>t!==e))})(n),style:{position:"absolute",top:4,right:4,minWidth:"24px",height:"24px",padding:"0 4px"}})]},n))}),(0,w.jsx)(U,{ref:Y,autoFocus:!0,style:{width:"100%",minHeight:"100px",resize:"vertical"},value:_,onChange:e=>O(e.target.value),autoSize:{minRows:3,maxRows:20},placeholder:"Edit your message...",onDragOver:e=>{e.preventDefault(),e.stopPropagation()},onDrop:async e=>{if(e.preventDefault(),e.stopPropagation(),!L)return void c.Ay.warning("Current model does not support image attachments");const n=e.dataTransfer.files;n&&n.length>0&&await X(n)}}),(0,w.jsx)("input",{ref:H,type:"file",accept:"image/*",multiple:!0,style:{display:"none"},onChange:async e=>{await X(e.target.files)}})]}),!q&&(t||!q)&&(0,w.jsx)(m.A,{title:"Edit",children:(0,w.jsx)(g.Ay,{icon:(0,w.jsx)(A.A,{}),onClick:()=>{K(n)}})})]})};var k=t(91686),S=t(42144),M=t(22643),I=t(9356),R=t(8347);const z=(0,a.memo)(e=>{let{previousModel:n,newModel:t,changeKey:s}=e;const{isDarkMode:a}=(0,R.D)(),i={container:{padding:"12px 16px",borderRadius:"8px",backgroundColor:a?"rgba(25, 118, 210, 0.15)":"rgba(25, 118, 210, 0.08)",border:"1px solid ".concat(a?"#2c6cb0":"#90caf9"),marginBottom:"12px",marginTop:"4px",display:"flex",alignItems:"center",boxShadow:a?"0 2px 8px rgba(0, 0, 0, 0.15)":"0 1px 3px rgba(0, 0, 0, 0.1)"},icon:{fontSize:"20px",marginRight:"12px",color:a?"#90caf9":"#1976d2"},text:{color:a?"#e3f2fd":"#0d47a1",fontWeight:500,fontSize:"14px"},modelName:{fontWeight:600,color:a?"#bbdefb":"#1565c0"}};return(0,w.jsxs)("div",{style:i.container,children:[(0,w.jsx)("span",{style:i.icon,children:"\ud83d\udd04"}),(0,w.jsxs)("span",{style:i.text,children:["Model changed from ",(0,w.jsx)("span",{style:i.modelName,children:n})," to ",(0,w.jsx)("span",{style:i.modelName,children:t})]})]})},(e,n)=>(!e.changeKey||!n.changeKey||e.changeKey===n.changeKey)&&(e.previousModel===n.previousModel&&e.newModel===n.newModel&&e.changeKey===n.changeKey));z.displayName="ModelChangeNotification";const E=z;var N=t(8627),T=t(89277),F=t(26944);const K=(0,a.memo)(e=>{let{enableCodeApply:n,onOpenShellConfig:t}=e;const{currentMessages:r,editingMessageIndex:c,isTopToBottom:d,isLoadingConversation:u,addStreamingConversation:x,streamingConversations:f,currentConversationId:y,setIsStreaming:v,setStreamedContentMap:C,isStreaming:A,addMessageToConversation:R,removeStreamingConversation:z,streamedContentMap:K,userHasScrolled:_,updateProcessingState:O,setConversations:D,toggleMessageMute:W,recordManualScroll:B}=(0,i.v)(),{checkedKeys:L}=(0,l.X)(),P=(0,N.ot)(),H=(0,a.useRef)(!0),Y=(0,a.useMemo)(()=>({isCurrentlyStreaming:f.has(y),hasStreamedContent:K.has(y)&&""!==K.get(y),streamedContent:K.get(y)||""}),[f,K,y]),{isCurrentlyStreaming:U,hasStreamedContent:q}=Y,X=(0,a.useRef)(!1),Q=(0,a.useRef)(null),V=(0,a.useRef)({});(0,a.useEffect)(()=>{var e;V.current={},null===(e=Q.current)||void 0===e||e.resetAfterIndex(0)},[r.length]);(0,a.useCallback)(e=>{var n,t,s,a,i;if(V.current[e])return V.current[e];const o=d?e:r.length-1-e,l=r[o];if(!l)return 100;const c=(null===(n=l.content)||void 0===n?void 0:n.length)||0;if("system"===l.role)return 60;if(null!==(t=l.content)&&void 0!==t&&t.includes("```diff")||null!==(s=l.content)&&void 0!==s&&s.includes("diff --git")){const e=l.content.split("\n").length;return Math.min(5e3,200+22*e)}if(null!==(a=l.content)&&void 0!==a&&a.includes("```")){const e=l.content.split("\n").length;return Math.min(3e3,180+20*e)}return null!==(i=l.content)&&void 0!==i&&i.includes("\x3c!-- TOOL_BLOCK")?Math.min(2e3,150+15*Math.floor(c/100)):Math.min(2e3,100+22*Math.floor(c/80))},[r,d]);const $=(0,a.useCallback)((e,n)=>{var t;V.current[e]!==n&&(V.current[e]=n,null===(t=Q.current)||void 0===t||t.resetAfterIndex(e))},[]),G=(0,a.useCallback)(e=>{const n=r[e];if(!n||"human"!==n.role)return!1;const t=e+1,s=t<r.length,a=s?r[t]:null;return!s||"assistant"!==(null===a||void 0===a?void 0:a.role)},[r]),J=(0,a.useCallback)(e=>G(e)?(0,w.jsx)(m.A,{title:"The AI response may have failed. Click to retry.",children:(0,w.jsx)(g.Ay,{icon:(0,w.jsx)(S.A,{}),type:"primary",size:"small",onClick:async()=>{const n=r[e],t=document.querySelector(".chat-container");if(t){(d?t.scrollHeight-t.scrollTop-t.clientHeight<50:t.scrollTop<50)||(B(),console.log("\ud83d\udcdc Retry while scrolled away - position locked"))}x(y);try{const e=r.filter(e=>!e.muted);await(0,o.fu)(e,n.content,(0,p.F)(L||[]),y,K,C,v,z,R,f.has(y),e=>O(y,e))}catch(s){v(!1),z(y),console.error("Error retrying message:",s)}},children:"Retry AI Response"})}):null,[G,r,d,B,x,y,L,K,C,v,z,R,f,O]),Z=(0,a.useCallback)(e=>{if(c===e)return null;const n=r[e];return G(e)?null:n&&"system"!==n.role?(0,w.jsx)(m.A,{title:n.muted?"Unmute (include in context)":"Mute (exclude from context)",children:(0,w.jsx)(g.Ay,{icon:n.muted?(0,w.jsx)(M.A,{}):(0,w.jsx)(I.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{W(y,e)}})}):null},[c,r,G,W,y]),ee=(0,a.useCallback)(e=>{if(c===e)return null;const n=r[e];return G(e)?null:n&&"human"===n.role?U?null:(0,w.jsx)(m.A,{title:"Resubmit this question",children:(0,w.jsx)(g.Ay,{icon:(0,w.jsx)(S.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{C(new Map);const t=r.slice(0,e+1),a=t.filter(e=>!e.muted);D(e=>e.map(e=>e.id===y?(0,s.A)((0,s.A)({},e),{},{messages:t,_version:Date.now()}):e)),x(y),(async()=>{try{await(0,o.fu)(a,n.content,(0,p.F)(L||[]),y,K,C,v,z,R,f.has(y),e=>O(y,e))}catch(e){v(!1),z(y),console.error("Error resubmitting message:",e)}})(),P("")}})}):null},[c,r,G,U,C,D,y,x,L,K,C,v,z,R,f,O,P]),ne=(0,a.useRef)(new Map);(0,a.useEffect)(()=>{ne.current.forEach((e,n)=>{if(e){const t=e.getBoundingClientRect().height;t>0&&$(n,t)}})});(0,a.useCallback)(e=>{let{index:a,style:i}=e;const o=d?a:r.length-1-a,l=r[o],m=o+1,g=m<r.length,p=g?r[m]:null;if(!l)return(0,w.jsx)("div",{style:i});const u="human"===l.role&&!U&&!q&&(o===r.length-1||g&&"assistant"!==(null===p||void 0===p?void 0:p.role));"system"===l.role&&l.modelChange?"".concat(l.modelChange.from,"->").concat(l.modelChange.to):l.content;return(0,w.jsx)("div",{ref:e=>{e&&ne.current.set(a,e)},style:(0,s.A)((0,s.A)({},i),{},{overflow:"visible"}),className:"message ".concat(l.role||"").concat(l.muted?" muted":"").concat(u?" needs-response":""),children:"system"===l.role&&l.modelChange?(0,w.jsx)(E,{previousModel:l.modelChange.from,changeKey:l.modelChange.changeKey,newModel:l.modelChange.to}):l.content?(0,w.jsxs)(w.Fragment,{children:["human"===l.role&&(0,w.jsxs)("div",{style:{display:c===o?"none":"flex",justifyContent:"space-between"},children:[(0,w.jsxs)("div",{className:"message-sender",children:["You",l._isFeedback&&"pending"===l._feedbackStatus&&(0,w.jsx)("span",{style:{color:"#faad14",fontSize:"12px",marginLeft:"4px",fontStyle:"italic"},children:"(pending feedback)"}),":"]}),(0,w.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:[Z(o),ee(o),u&&J(o),(0,w.jsx)(b,{index:o,isInline:!0})]})]}),"human"===l.role&&c===o?(0,w.jsx)(b,{index:o,isInline:!1}):"human"===l.role&&l.content?(0,w.jsxs)(w.Fragment,{children:[l.images&&l.images.length>0&&(0,w.jsx)("div",{style:{marginBottom:"12px",display:"flex",gap:"8px",flexWrap:"wrap"},children:l.images.map((e,n)=>(0,w.jsxs)("div",{style:{position:"relative",display:"inline-block"},children:[(0,w.jsx)(h.A,{src:"data:".concat(e.mediaType,";base64,").concat(e.data),alt:e.filename||"Attached image",width:120,height:120,style:{objectFit:"cover",borderRadius:"4px",border:"1px solid #d9d9d9"},preview:{mask:(0,w.jsx)(j.A,{})}}),e.filename&&(0,w.jsx)("div",{style:{fontSize:"11px",textAlign:"center",marginTop:"4px",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis"},children:e.filename})]},n))}),(0,w.jsx)("div",{className:"message-content",children:(0,w.jsx)(F.MarkdownRenderer,{markdown:l.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:A||f.has(y)})})]}):"assistant"===l.role&&l.content?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,w.jsx)("div",{className:"message-sender",children:"AI:"}),(0,w.jsx)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:Z(o)}),J(o)]}),(0,w.jsx)("div",{className:"message-content",children:(0,w.jsx)(F.MarkdownRenderer,{markdown:l.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:A||f.has(y)})})]}):null]}):null},"message-".concat(l.id||o))},[r,d,U,q,c,Z,ee,J,n,A,f,y,$]);const te=d?r:[...r].reverse(),se=(0,a.useRef)(0),ae=(0,a.useRef)(new Set),ie=(0,a.useRef)(new Set);(0,a.useCallback)(e=>K.has(e)&&""!==K.get(e),[K]);(0,a.useEffect)(()=>{Math.abs(r.length-se.current)>2&&((0,T.QU)()&&(0,T.cY)("Conversation messages updated:",{messageCount:r.length,previousCount:se.current,isVisible:H.current,displayOrder:d?"top-down":"bottom-up"}),se.current=r.length);const e=new IntersectionObserver(e=>{e.forEach(e=>{H.current=e.isIntersecting})},{threshold:.1});return()=>e.disconnect()},[d,r.length]),(0,a.useEffect)(()=>{const e=X.current?new Set([y]):new Set,n=(new Set(Array.from(f)),X.current),t=U;X.current=t;(f.size<e.size||n&&!t)&&(n&&!t?console.log("\u2705 Current conversation finished streaming"):f.size<e.size&&(console.log("\ud83d\udccc Background conversation finished - locking scroll position"),B()))},[U,f,y,B]),(0,a.useEffect)(()=>{const e=e=>{const{previousModel:n,newModel:t}=e.detail,s="".concat(n,"->").concat(t);ie.current.has(s)||(ie.current.add(s),n&&t&&R({role:"system",content:"Model changed from ".concat(n," to ").concat(t),modelChange:{from:n,to:t,changeKey:s}},y))};return window.addEventListener("modelChanged",e),()=>{ie.current.clear(),ae.current.clear(),window.removeEventListener("modelChanged",e)}},[y,R]);const oe=u?r.length>0?"Loading messages (".concat(r.length," loaded)..."):"Loading conversation...":"",le=u&&r.length>0,re=u&&0===r.length;return(0,w.jsxs)("div",{style:{position:"relative"},children:[re&&(0,w.jsx)("div",{style:{position:"fixed",top:"var(--header-height)",left:"var(--folder-panel-width)",right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e3},children:(0,w.jsx)(k.A,{size:"large",tip:oe})}),(0,w.jsxs)("div",{style:{opacity:u?.5:1,minHeight:"50px"},className:"conversation-messages-container",children:[le&&(0,w.jsxs)("div",{style:{position:"sticky",top:0,backgroundColor:"rgba(0, 0, 0, 0.7)",color:"#fff",padding:"8px 16px",borderRadius:"4px",margin:"8px 0",display:"flex",alignItems:"center",gap:"8px",zIndex:1e3},children:[(0,w.jsx)(k.A,{size:"small"}),(0,w.jsx)("span",{children:oe})]}),(null===te||void 0===te?void 0:te.map((e,s)=>{const a=d?s:r.length-1-s,i=a+1,o=i<r.length,l=o?r[i]:null,m="human"===e.role&&!U&&!q&&(a===r.length-1||o&&"assistant"!==(null===l||void 0===l?void 0:l.role));"system"===e.role&&e.modelChange?"".concat(e.modelChange.from,"->").concat(e.modelChange.to):e.content;return(0,w.jsx)("div",{className:"message ".concat(e.role||"").concat(e.muted?" muted":"").concat(m?" needs-response":""),children:"system"===e.role&&e.modelChange?(0,w.jsx)(E,{previousModel:e.modelChange.from,changeKey:e.modelChange.changeKey,newModel:e.modelChange.to}):e.content?(0,w.jsxs)(w.Fragment,{children:["human"===e.role&&(0,w.jsxs)("div",{style:{display:c===a?"none":"flex",justifyContent:"space-between"},children:[(0,w.jsxs)("div",{className:"message-sender",children:["You",e._isFeedback&&"pending"===e._feedbackStatus&&(0,w.jsx)("span",{style:{color:"#faad14",fontSize:"12px",marginLeft:"4px",fontStyle:"italic"},children:"(pending feedback)"}),":"]}),(0,w.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:[Z(a),ee(a),m&&J(a),(0,w.jsx)(b,{index:a,isInline:!0})]})]}),"human"===e.role&&c===a?(0,w.jsx)(b,{index:a,isInline:!1}):"human"===e.role&&(e.content||e.images&&e.images.length>0)?(0,w.jsxs)(w.Fragment,{children:[e.images&&e.images.length>0&&(0,w.jsx)("div",{style:{marginBottom:"12px",display:"flex",gap:"8px",flexWrap:"wrap"},children:e.images.map((e,n)=>(0,w.jsxs)("div",{style:{position:"relative",display:"inline-block"},children:[(0,w.jsx)(h.A,{src:"data:".concat(e.mediaType,";base64,").concat(e.data),alt:e.filename||"Attached image",width:120,height:120,style:{objectFit:"cover",borderRadius:"4px",border:"1px solid #d9d9d9"},preview:{mask:(0,w.jsx)(j.A,{})}}),e.filename&&(0,w.jsx)("div",{style:{fontSize:"11px",textAlign:"center",marginTop:"4px",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis"},children:e.filename})]},n))}),e.content&&(0,w.jsx)("div",{className:"message-content",children:(0,w.jsx)(F.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:A||f.has(y)})})]}):"assistant"===e.role&&e.content?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,w.jsx)("div",{className:"message-sender",children:"AI:"}),(0,w.jsx)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:Z(a)}),J(a)]}),(0,w.jsx)("div",{className:"message-content",children:(0,w.jsx)(F.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:A||f.has(y)})})]}):null]}):null},"message-".concat(e.id||s))}))||null,(!te||0===te.length)&&(0,w.jsx)("div",{style:{textAlign:"center",padding:"2rem",color:"#999"},children:"No messages in this conversation yet."})]})]})},(e,n)=>e.enableCodeApply===n.enableCodeApply);K.displayName="Conversation";const _=K}}]);
//# sourceMappingURL=46265.d6f4ba9b.chunk.js.map