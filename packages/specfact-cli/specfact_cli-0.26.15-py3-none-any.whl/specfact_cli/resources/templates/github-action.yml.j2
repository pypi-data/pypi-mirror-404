# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yamllint disable rule:line-length rule:truthy
name: SpecFact CLI Validation

on:
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - "docs/**"
      - "**.md"
      - "**.mdc"
  push:
    branches: [main, dev]
    paths-ignore:
      - "docs/**"
      - "**.md"
      - "**.mdc"
  workflow_dispatch:
    inputs:
      budget:
        description: "Time budget in seconds"
        required: false
        default: "{{ budget }}"
        type: string
      mode:
        description: "Enforcement mode (block, warn, log)"
        required: false
        default: "block"
        type: choice
        options:
          - block
          - warn
          - log
      version_check_mode:
        description: "Version check mode (info, warn, block)"
        required: false
        default: "warn"
        type: choice
        options:
          - info
          - warn
          - block

jobs:
  specfact-validation:
    name: Contract Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "{{ python_version }}"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install hatch

      - name: Install SpecFact CLI
        run: |
          echo "üì¶ Installing SpecFact CLI..."
          pip install specfact-cli

      - name: Set validation parameters
        id: validation
        run: |
          BUDGET="${INPUT_BUDGET:-{{ budget }}}"
          MODE="${INPUT_MODE:-block}"
          VERSION_CHECK_MODE="${INPUT_VERSION_CHECK_MODE:-info}"
          echo "budget=$BUDGET" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "version_check_mode=$VERSION_CHECK_MODE" >> $GITHUB_OUTPUT
          echo "SPECFACT_BUDGET=$BUDGET" >> $GITHUB_ENV
          echo "SPECFACT_MODE=$MODE" >> $GITHUB_ENV
          echo "SPECFACT_VERSION_CHECK_MODE=$VERSION_CHECK_MODE" >> $GITHUB_ENV

      - name: Run Contract Validation
        id: repro
        continue-on-error: true
        run: |
          specfact repro --verbose --budget {% raw %}${{ steps.validation.outputs.budget }}{% endraw %} || true
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Version check
        id: version_check
        continue-on-error: true
        run: |
          VERSION_CHECK_MODE="{% raw %}${{ steps.validation.outputs.version_check_mode }}{% endraw %}"
          echo "üìå Checking bundle version recommendation (mode: $VERSION_CHECK_MODE)..."
          if specfact project version check --repo .; then
            echo "version_check_passed=true" >> $GITHUB_OUTPUT
          else
            echo "version_check_passed=false" >> $GITHUB_OUTPUT
            if [ "$VERSION_CHECK_MODE" = "warn" ]; then
              echo "‚ö†Ô∏è Version check recommendation not followed (warn mode - continuing)"
            elif [ "$VERSION_CHECK_MODE" = "block" ]; then
              echo "‚ùå Version check recommendation not followed (block mode - failing)"
              exit 1
            else
              echo "‚ÑπÔ∏è Version check recommendation available (info mode - continuing)"
            fi
          fi

      - name: Find latest repro report
        id: report
        if: always()
        run: |
          REPORT_DIR=".specfact/reports/enforcement"
          if [ -d "$REPORT_DIR" ]; then
            LATEST_REPORT=$(find "$REPORT_DIR" -name "report-*.yaml" -type f -printf "%T@ %p\n" | sort -n | tail -1 | cut -d' ' -f2-)
            if [ -n "$LATEST_REPORT" ]; then
              echo "path=$LATEST_REPORT" >> $GITHUB_OUTPUT
              echo "SPECFACT_REPORT_PATH=$LATEST_REPORT" >> $GITHUB_ENV
            fi
          fi

      - name: Create GitHub annotations
        id: annotations
        if: always() && {% raw %}steps.report.outputs.path != ''{% endraw %}
        run: |
          python -m specfact_cli.utils.github_annotations || true

      - name: Generate PR comment
        id: pr-comment
        if: always() && {% raw %}github.event_name == 'pull_request' && steps.report.outputs.path != ''{% endraw %}
        run: |
          python -m specfact_cli.utils.github_annotations
          if [ -f ".specfact/pr-comment.md" ]; then
            echo "comment_path=.specfact/pr-comment.md" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        if: always() && {% raw %}github.event_name == 'pull_request' && steps.pr-comment.outputs.comment_path != ''{% endraw %}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentPath = '{% raw %}${{ steps.pr-comment.outputs.comment_path }}{% endraw %}';
            if (fs.existsSync(commentPath)) {
              const comment = fs.readFileSync(commentPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: specfact-report
          path: |
            .specfact/reports/enforcement/*.yaml
            .specfact/pr-comment.md
          if-no-files-found: ignore

      - name: Fail workflow if validation failed
        if: {% raw %}steps.repro.outputs.exit_code != '0' && steps.validation.outputs.mode == 'block'{% endraw %}
        run: |
          echo "‚ùå Validation failed. Exiting with error code."
          exit 1

