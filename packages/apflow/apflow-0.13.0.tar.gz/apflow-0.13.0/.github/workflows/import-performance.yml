name: Import Performance Check

on:
  workflow_dispatch:

jobs:
  check-imports:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -e ".[cli]"
      
      - name: Check for circular imports
        run: |
          python scripts/detect_circular_imports.py
      
      - name: Check CLI startup performance
        run: |
          echo "Checking CLI startup time..."
          START=$(python -c "import time; print(time.time())")
          python -c "import apflow.cli.main"
          END=$(python -c "import time; print(time.time())")
          ELAPSED=$(python -c "print($END - $START)")
          
          echo "CLI import time: ${ELAPSED}s"
          
          # Fail if import takes more than 1.5 seconds
          python -c "
          import sys
          elapsed = float('$ELAPSED')
          threshold = 1.5
          if elapsed > threshold:
              print(f'❌ FAIL: CLI import took {elapsed:.2f}s (threshold: {threshold}s)')
              sys.exit(1)
          else:
              print(f'✅ PASS: CLI import took {elapsed:.2f}s (threshold: {threshold}s)')
          "
      
      - name: Check for heavy imports at module level
        run: |
          # Get all changed Python files
          git diff --name-only origin/main...HEAD | grep '\.py$' | xargs -r python scripts/check_heavy_imports.py || true
      
      - name: Verify extensions are not loaded at CLI startup
        run: |
          python -c "
          import sys
          import apflow.cli.main
          
          heavy_deps = ['litellm', 'crewai', 'torch', 'transformers']
          loaded = [dep for dep in heavy_deps if dep in sys.modules]
          
          if loaded:
              print(f'❌ FAIL: Heavy dependencies loaded at CLI startup: {loaded}')
              sys.exit(1)
          else:
              print('✅ PASS: No heavy dependencies at CLI startup')
          "
