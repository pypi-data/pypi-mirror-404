{"version":3,"file":"releaseStore-FS4gHexT.js","names":[],"sources":["../../src/platform/updates/common/releaseService.ts","../../src/platform/updates/common/releaseStore.ts"],"sourcesContent":["import type { AxiosError, AxiosResponse } from 'axios'\nimport axios from 'axios'\nimport { ref, watch } from 'vue'\n\nimport { getComfyApiBaseUrl } from '@/config/comfyApi'\nimport type { components, operations } from '@/types/comfyRegistryTypes'\nimport { isAbortError } from '@/utils/typeGuardUtil'\n\n// Use generated types from OpenAPI spec\nexport type ReleaseNote = components['schemas']['ReleaseNote']\ntype GetReleasesParams = operations['getReleaseNotes']['parameters']['query']\n\n// Use generated error response type\ntype ErrorResponse = components['schemas']['ErrorResponse']\n\nconst releaseApiClient = axios.create({\n  baseURL: getComfyApiBaseUrl(),\n  headers: {\n    'Content-Type': 'application/json'\n  }\n})\n\n// Release service for fetching release notes\nexport const useReleaseService = () => {\n  const isLoading = ref(false)\n  const error = ref<string | null>(null)\n\n  watch(\n    () => getComfyApiBaseUrl(),\n    (url) => {\n      releaseApiClient.defaults.baseURL = url\n    }\n  )\n\n  // No transformation needed - API response matches the generated type\n\n  // Handle API errors with context\n  const handleApiError = (\n    err: unknown,\n    context: string,\n    routeSpecificErrors?: Record<number, string>\n  ): string => {\n    if (!axios.isAxiosError(err))\n      return err instanceof Error\n        ? `${context}: ${err.message}`\n        : `${context}: Unknown error occurred`\n\n    const axiosError = err as AxiosError<ErrorResponse>\n\n    if (axiosError.response) {\n      const { status, data } = axiosError.response\n\n      if (routeSpecificErrors && routeSpecificErrors[status])\n        return routeSpecificErrors[status]\n\n      switch (status) {\n        case 400:\n          return `Bad request: ${data?.message || 'Invalid input'}`\n        case 401:\n          return 'Unauthorized: Authentication required'\n        case 403:\n          return `Forbidden: ${data?.message || 'Access denied'}`\n        case 404:\n          return `Not found: ${data?.message || 'Resource not found'}`\n        case 500:\n          return `Server error: ${data?.message || 'Internal server error'}`\n        default:\n          return `${context}: ${data?.message || axiosError.message}`\n      }\n    }\n\n    return `${context}: ${axiosError.message}`\n  }\n\n  // Execute API request with error handling\n  const executeApiRequest = async <T>(\n    apiCall: () => Promise<AxiosResponse<T>>,\n    errorContext: string,\n    routeSpecificErrors?: Record<number, string>\n  ): Promise<T | null> => {\n    isLoading.value = true\n    error.value = null\n\n    try {\n      const response = await apiCall()\n      return response.data\n    } catch (err) {\n      // Don't treat cancellations as errors\n      if (isAbortError(err)) return null\n\n      error.value = handleApiError(err, errorContext, routeSpecificErrors)\n      return null\n    } finally {\n      isLoading.value = false\n    }\n  }\n\n  // Fetch release notes from API\n  const getReleases = async (\n    params: GetReleasesParams,\n    signal?: AbortSignal\n  ): Promise<ReleaseNote[] | null> => {\n    const endpoint = '/releases'\n    const errorContext = 'Failed to get releases'\n    const routeSpecificErrors = {\n      400: 'Invalid project or version parameter'\n    }\n\n    const apiResponse = await executeApiRequest(\n      () =>\n        releaseApiClient.get<ReleaseNote[]>(endpoint, {\n          params,\n          signal\n        }),\n      errorContext,\n      routeSpecificErrors\n    )\n\n    return apiResponse\n  }\n\n  return {\n    isLoading,\n    error,\n    getReleases\n  }\n}\n","import { until } from '@vueuse/core'\nimport { defineStore } from 'pinia'\nimport { compare, valid } from 'semver'\nimport { computed, ref } from 'vue'\n\nimport { isCloud } from '@/platform/distribution/types'\nimport { useSettingStore } from '@/platform/settings/settingStore'\nimport { useSystemStatsStore } from '@/stores/systemStatsStore'\nimport { isElectron } from '@/utils/envUtil'\nimport { stringToLocale } from '@/utils/formatUtil'\n\nimport { useReleaseService } from './releaseService'\nimport type { ReleaseNote } from './releaseService'\n\n// Store for managing release notes\nexport const useReleaseStore = defineStore('release', () => {\n  // State\n  const releases = ref<ReleaseNote[]>([])\n  const isLoading = ref(false)\n  const error = ref<string | null>(null)\n\n  // Services\n  const releaseService = useReleaseService()\n  const systemStatsStore = useSystemStatsStore()\n  const settingStore = useSettingStore()\n\n  const currentVersion = computed(() => {\n    if (isCloud) {\n      return systemStatsStore?.systemStats?.system?.cloud_version ?? ''\n    }\n    return systemStatsStore?.systemStats?.system?.comfyui_version ?? ''\n  })\n\n  // Release data from settings\n  const locale = computed(() => settingStore.get('Comfy.Locale'))\n  const releaseVersion = computed(() =>\n    settingStore.get('Comfy.Release.Version')\n  )\n  const releaseStatus = computed(() => settingStore.get('Comfy.Release.Status'))\n  const releaseTimestamp = computed(() =>\n    settingStore.get('Comfy.Release.Timestamp')\n  )\n  const showVersionUpdates = computed(() =>\n    settingStore.get('Comfy.Notification.ShowVersionUpdates')\n  )\n\n  // Most recent release\n  const recentRelease = computed(() => {\n    return releases.value[0] ?? null\n  })\n\n  // 3 most recent releases\n  const recentReleases = computed(() => {\n    return releases.value.slice(0, 3)\n  })\n\n  // Helper constants\n  const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000 // 3 days\n\n  const compareVersions = (\n    releaseVersion: string,\n    currentVer: string\n  ): number => {\n    if (valid(releaseVersion) && valid(currentVer)) {\n      return compare(releaseVersion, currentVer)\n    }\n    // Non-semver (e.g. git hash): assume different = newer\n    return releaseVersion === currentVer ? 0 : 1\n  }\n\n  // New version available?\n  const isNewVersionAvailable = computed(\n    () =>\n      !!recentRelease.value &&\n      compareVersions(\n        recentRelease.value.version,\n        currentVersion.value || '0.0.0'\n      ) > 0\n  )\n\n  const isLatestVersion = computed(\n    () =>\n      !!recentRelease.value &&\n      compareVersions(\n        recentRelease.value.version,\n        currentVersion.value || '0.0.0'\n      ) === 0\n  )\n\n  const hasMediumOrHighAttention = computed(() => {\n    const attention = recentRelease.value?.attention\n    return attention === 'medium' || attention === 'high'\n  })\n\n  // Show toast if needed\n  const shouldShowToast = computed(() => {\n    // Only show on desktop version\n    if (!isElectron() || isCloud) {\n      return false\n    }\n\n    // Skip if notifications are disabled\n    if (!showVersionUpdates.value) {\n      return false\n    }\n\n    if (!isNewVersionAvailable.value) {\n      return false\n    }\n\n    // Skip if low attention\n    if (!hasMediumOrHighAttention.value) {\n      return false\n    }\n\n    // Skip if user already skipped or changelog seen\n    if (\n      releaseVersion.value === recentRelease.value?.version &&\n      ['skipped', 'changelog seen'].includes(releaseStatus.value)\n    ) {\n      return false\n    }\n\n    return true\n  })\n\n  // Show red-dot indicator\n  const shouldShowRedDot = computed(() => {\n    // Only show on desktop version\n    if (!isElectron() || isCloud) {\n      return false\n    }\n\n    // Skip if notifications are disabled\n    if (!showVersionUpdates.value) {\n      return false\n    }\n\n    // Already latest → no dot\n    if (!isNewVersionAvailable.value) {\n      return false\n    }\n\n    const { version } = recentRelease.value\n\n    // Changelog seen → clear dot\n    if (\n      releaseVersion.value === version &&\n      releaseStatus.value === 'changelog seen'\n    ) {\n      return false\n    }\n\n    // Attention medium / high (levels 2 & 3)\n    if (hasMediumOrHighAttention.value) {\n      // Persist until changelog is opened\n      return true\n    }\n\n    // Attention low (level 1) and skipped → keep up to 3 d\n    if (\n      releaseVersion.value === version &&\n      releaseStatus.value === 'skipped' &&\n      releaseTimestamp.value &&\n      Date.now() - releaseTimestamp.value >= THREE_DAYS_MS\n    ) {\n      return false\n    }\n\n    // Not skipped → show\n    return true\n  })\n\n  const shouldShowPopup = computed(() => {\n    if (!isElectron() && !isCloud) {\n      return false\n    }\n\n    if (!showVersionUpdates.value) {\n      return false\n    }\n\n    if (!recentRelease.value) {\n      return false\n    }\n\n    // Skip version check if current version isn't semver (e.g. git hash)\n    const skipVersionCheck = !valid(currentVersion.value)\n    if (!skipVersionCheck && !isLatestVersion.value) {\n      return false\n    }\n\n    if (\n      releaseVersion.value === recentRelease.value.version &&\n      releaseStatus.value === \"what's new seen\"\n    ) {\n      return false\n    }\n\n    return true\n  })\n\n  // Action handlers for user interactions\n  async function handleSkipRelease(version: string): Promise<void> {\n    if (\n      version !== recentRelease.value?.version ||\n      releaseStatus.value === 'changelog seen'\n    ) {\n      return\n    }\n\n    await settingStore.set('Comfy.Release.Version', version)\n    await settingStore.set('Comfy.Release.Status', 'skipped')\n    await settingStore.set('Comfy.Release.Timestamp', Date.now())\n  }\n\n  async function handleShowChangelog(version: string): Promise<void> {\n    if (version !== recentRelease.value?.version) {\n      return\n    }\n\n    await settingStore.set('Comfy.Release.Version', version)\n    await settingStore.set('Comfy.Release.Status', 'changelog seen')\n    await settingStore.set('Comfy.Release.Timestamp', Date.now())\n  }\n\n  async function handleWhatsNewSeen(version: string): Promise<void> {\n    if (version !== recentRelease.value?.version) {\n      return\n    }\n\n    await settingStore.set('Comfy.Release.Version', version)\n    await settingStore.set('Comfy.Release.Status', \"what's new seen\")\n    await settingStore.set('Comfy.Release.Timestamp', Date.now())\n  }\n\n  // Fetch releases from API\n  async function fetchReleases(): Promise<void> {\n    if (isLoading.value) {\n      return\n    }\n\n    if (!isCloud && !showVersionUpdates.value) {\n      return\n    }\n\n    // Skip fetching if API nodes are disabled via argv\n    if (\n      systemStatsStore.systemStats?.system?.argv?.includes(\n        '--disable-api-nodes'\n      )\n    ) {\n      return\n    }\n    isLoading.value = true\n    error.value = null\n\n    try {\n      // Ensure system stats are loaded\n      if (!systemStatsStore.systemStats) {\n        await until(systemStatsStore.isInitialized)\n      }\n\n      const fetchedReleases = await releaseService.getReleases({\n        project: isCloud ? 'cloud' : 'comfyui',\n        current_version: currentVersion.value,\n        form_factor: systemStatsStore.getFormFactor(),\n        locale: stringToLocale(locale.value)\n      })\n\n      if (fetchedReleases !== null) {\n        releases.value = fetchedReleases\n      } else if (releaseService.error.value) {\n        error.value = releaseService.error.value\n      }\n    } catch (err) {\n      error.value =\n        err instanceof Error ? err.message : 'Unknown error occurred'\n    } finally {\n      isLoading.value = false\n    }\n  }\n\n  // Initialize store\n  async function initialize(): Promise<void> {\n    await fetchReleases()\n  }\n\n  return {\n    releases,\n    isLoading,\n    error,\n    recentRelease,\n    recentReleases,\n    shouldShowToast,\n    shouldShowRedDot,\n    shouldShowPopup,\n    shouldShowUpdateButton: isNewVersionAvailable,\n    handleSkipRelease,\n    handleShowChangelog,\n    handleWhatsNewSeen,\n    fetchReleases,\n    initialize\n  }\n})\n"],"mappings":"0gBACkB,IACS,IAEQ,IAEN,CASvB,EAAmB,EAAM,OAAO,CACpC,QAAS,GAAoB,CAC7B,QAAS,CACP,eAAgB,mBACjB,CACF,CAAC,CAGW,sBAA0B,CACrC,IAAM,EAAY,EAAI,GAAM,CACtB,EAAQ,EAAmB,KAAK,CAEtC,MACQ,GAAoB,CACzB,GAAQ,CACP,EAAiB,SAAS,QAAU,GAEvC,CAKD,IAAM,gBACJ,EACA,EACA,IACW,CACX,GAAI,CAAC,EAAM,aAAa,EAAI,CAC1B,OAAO,aAAe,MAClB,GAAG,EAAQ,IAAI,EAAI,UACnB,GAAG,EAAQ,0BAEjB,IAAM,EAAa,EAEnB,GAAI,EAAW,SAAU,CACvB,GAAM,CAAE,SAAQ,QAAS,EAAW,SAEpC,GAAI,GAAuB,EAAoB,GAC7C,OAAO,EAAoB,GAE7B,OAAQ,EAAR,CACE,IAAK,KACH,MAAO,gBAAgB,GAAM,SAAW,kBAC1C,IAAK,KACH,MAAO,wCACT,IAAK,KACH,MAAO,cAAc,GAAM,SAAW,kBACxC,IAAK,KACH,MAAO,cAAc,GAAM,SAAW,uBACxC,IAAK,KACH,MAAO,iBAAiB,GAAM,SAAW,0BAC3C,QACE,MAAO,GAAG,EAAQ,IAAI,GAAM,SAAW,EAAW,WAIxD,MAAO,GAAG,EAAQ,IAAI,EAAW,WAI7B,kBAAoB,MACxB,EACA,EACA,IACsB,CACtB,EAAU,MAAQ,GAClB,EAAM,MAAQ,KAEd,GAAI,CAEF,OADiB,MAAM,GAAS,EAChB,WACT,EAAK,CAKZ,OAHI,EAAa,EAAI,GAErB,EAAM,MAAQ,eAAe,EAAK,EAAc,EAAoB,EAFtC,YAItB,CACR,EAAU,MAAQ,KAKhB,YAAc,MAClB,EACA,IAQoB,MAAM,sBAEtB,EAAiB,IAAmB,YAAU,CAC5C,SACA,SACD,CAAC,CAVe,yBACO,CAC1B,IAAK,uCACN,CAUA,CAKH,MAAO,CACL,YACA,QACA,YACD,sBC7HmB,IACM,UAEE,IAEN,IACQ,IACI,IACT,IACI,IAEG,CAIrB,EAAkB,EAAY,cAAiB,CAE1D,IAAM,EAAW,EAAmB,EAAE,CAAC,CACjC,EAAY,EAAI,GAAM,CACtB,EAAQ,EAAmB,KAAK,CAGhC,EAAiB,mBAAmB,CACpC,EAAmB,GAAqB,CACxC,EAAe,GAAiB,CAEhC,EAAiB,MACjB,EACK,GAAkB,aAAa,QAAQ,eAAiB,GAE1D,GAAkB,aAAa,QAAQ,iBAAmB,GACjE,CAGI,EAAS,MAAe,EAAa,IAAI,eAAe,CAAC,CACzD,EAAiB,MACrB,EAAa,IAAI,wBAAwB,CAC1C,CACK,EAAgB,MAAe,EAAa,IAAI,uBAAuB,CAAC,CACxE,EAAmB,MACvB,EAAa,IAAI,0BAA0B,CAC5C,CACK,EAAqB,MACzB,EAAa,IAAI,wCAAwC,CAC1D,CAGK,EAAgB,MACb,EAAS,MAAM,IAAM,KAC5B,CAGI,EAAiB,MACd,EAAS,MAAM,MAAM,EAAG,EAAE,CACjC,CAKI,iBACJ,EACA,KAEA,EAAA,EAAA,OAAU,EAAe,GAAA,EAAA,EAAA,OAAU,EAAW,EAC5C,EAAA,EAAA,SAAe,EAAgB,EAAW,CAGrC,IAAmB,EAAa,EAAI,EAIvC,EAAwB,MAE1B,CAAC,CAAC,EAAc,OAChB,gBACE,EAAc,MAAM,QACpB,EAAe,OAAS,QACzB,CAAG,EACP,CAEK,EAAkB,MAEpB,CAAC,CAAC,EAAc,OAChB,gBACE,EAAc,MAAM,QACpB,EAAe,OAAS,QACzB,GAAK,EACT,CAEK,EAA2B,MAAe,CAC9C,IAAM,EAAY,EAAc,OAAO,UACvC,OAAO,IAAc,UAAY,IAAc,QAC/C,CAGI,EAAkB,MAqBtB,EAnBI,CAAC,GAAY,EAAI,GAKjB,CAAC,EAAmB,OAIpB,CAAC,EAAsB,OAKvB,CAAC,EAAyB,OAM5B,EAAe,QAAU,EAAc,OAAO,SAC9C,CAAC,UAAW,iBAAiB,CAAC,SAAS,EAAc,MAAM,EAM7D,CAGI,EAAmB,MAAe,CAYtC,GAVI,CAAC,GAAY,EAAI,GAKjB,CAAC,EAAmB,OAKpB,CAAC,EAAsB,MACzB,MAAO,GAGT,GAAM,CAAE,WAAY,EAAc,MA2BlC,OAvBE,EAAe,QAAU,GACzB,EAAc,QAAU,iBAEjB,GAIL,EAAyB,MAEpB,GAIT,EACE,EAAe,QAAU,GACzB,EAAc,QAAU,WACxB,EAAiB,OACjB,KAAK,KAAK,CAAG,EAAiB,OAAS,SAOzC,CAEI,EAAkB,MAmBtB,EAlBI,CAAC,GAAY,EAAI,CAAC,GAIlB,CAAC,EAAmB,OAIpB,CAAC,EAAc,QAKM,EAAA,EAAA,OAAO,EAAe,MAAM,EAC5B,CAAC,EAAgB,OAKxC,EAAe,QAAU,EAAc,MAAM,SAC7C,EAAc,QAAU,mBAM1B,CAGF,eAAe,kBAAkB,EAAgC,CAE7D,IAAY,EAAc,OAAO,SACjC,EAAc,QAAU,mBAK1B,MAAM,EAAa,IAAI,wBAAyB,EAAQ,CACxD,MAAM,EAAa,IAAI,uBAAwB,UAAU,CACzD,MAAM,EAAa,IAAI,0BAA2B,KAAK,KAAK,CAAC,EAG/D,eAAe,oBAAoB,EAAgC,CAC7D,IAAY,EAAc,OAAO,UAIrC,MAAM,EAAa,IAAI,wBAAyB,EAAQ,CACxD,MAAM,EAAa,IAAI,uBAAwB,iBAAiB,CAChE,MAAM,EAAa,IAAI,0BAA2B,KAAK,KAAK,CAAC,EAG/D,eAAe,mBAAmB,EAAgC,CAC5D,IAAY,EAAc,OAAO,UAIrC,MAAM,EAAa,IAAI,wBAAyB,EAAQ,CACxD,MAAM,EAAa,IAAI,uBAAwB,kBAAkB,CACjE,MAAM,EAAa,IAAI,0BAA2B,KAAK,KAAK,CAAC,EAI/D,eAAe,eAA+B,CACxC,MAAU,OAIV,GAAC,GAAW,CAAC,EAAmB,QAMlC,GAAiB,aAAa,QAAQ,MAAM,SAC1C,sBACD,CAKH,CADA,EAAU,MAAQ,GAClB,EAAM,MAAQ,KAEd,GAAI,CAEG,EAAiB,aACpB,MAAM,EAAM,EAAiB,cAAc,CAG7C,IAAM,EAAkB,MAAM,EAAe,YAAY,CACvD,QAAS,EAAU,QAAU,UAC7B,gBAAiB,EAAe,MAChC,YAAa,EAAiB,eAAe,CAC7C,OAAQ,EAAe,EAAO,MAAM,CACrC,CAAC,CAEE,IAAoB,KAEb,EAAe,MAAM,QAC9B,EAAM,MAAQ,EAAe,MAAM,OAFnC,EAAS,MAAQ,QAIZ,EAAK,CACZ,EAAM,MACJ,aAAe,MAAQ,EAAI,QAAU,gCAC/B,CACR,EAAU,MAAQ,KAKtB,eAAe,YAA4B,CACzC,MAAM,eAAe,CAGvB,MAAO,CACL,WACA,YACA,QACA,gBACA,iBACA,kBACA,mBACA,kBACA,uBAAwB,EACxB,kBACA,oBACA,mBACA,cACA,WACD,EACD"}