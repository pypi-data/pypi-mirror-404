{"version":3,"mappings":";utCAwMqB,IAEG,IAEL,IACoB,KACX,IACI,IACO,IACA,KACD,IAO/B,IACY,g5CAyGb,EAAoB,0BACpB,GAAkB,IAAS,0DAxGjC,IAAM,EAAc,IAAuB,CACrC,CAAE,IAAG,KAAM,IAAQ,CAEnB,CACJ,uBACA,cACA,wBACA,mBACA,mBACA,uBACA,qBACA,wBACE,GAAgB,CAEd,CAAE,KAAM,IAA2B,IAAsB,CAEzD,EAAU,MAAe,CAC7B,IAAM,EAAO,EAAiB,MAE9B,OADK,EACE,GAAY,eADD,IAEnB,CACK,EAAY,MAChB,GAAa,EAAQ,MAAO,EAAqB,MAAK,CACxD,CAEM,EAAc,MAAe,CACjC,GAAI,CAAC,EAAmB,OAAO,aAAc,MAAO,GACpD,IAAM,EAAO,IAAI,KAAK,EAAmB,MAAM,aAAY,CACrD,EAAM,OAAO,EAAK,SAAS,CAAC,CAAC,SAAS,EAAG,IAAG,CAGlD,MAAO,GAFO,OAAO,EAAK,UAAU,CAAG,EAAE,CAAC,SAAS,EAAG,IAAG,CAEzC,GAAG,EAAI,GADV,OAAO,EAAK,aAAa,CAAC,CAAC,MAAM,GAAE,IAEjD,CAEK,EAAwB,MAC5B,EAAqB,MACjB,EAAE,wCAAyC,CACzC,KAAM,EAAY,MACnB,EACD,EAAE,yCAA0C,CAC1C,KAAM,EAAY,MACnB,EACP,CAEM,EAAmB,MAAe,CACtC,IAAM,EAAU,GAAe,EAAQ,MAAK,CAE5C,OAAO,EADO,EAAqB,MAAQ,EAAU,GAAK,EAC5C,EACf,CAEK,EAAyB,MACvB,GAAG,EAAoB,MAAM,KAAK,EAAiB,QAC3D,CAYM,EAAe,MAA0B,CAC7C,IAAM,EAAM,EAAQ,MAEd,EAAsB,CAC1B,CACE,IAAK,cACL,KAAM,SACN,MAAO,EAAE,4BAA4B,IAAM,CAC3C,MAAO,EAAE,iCACV,CACD,CACE,IAAK,MACL,KAAM,UACN,MAAO,EAAE,yBACV,CACD,CACE,IAAK,aACL,KAAM,UACN,MAAO,EAAE,iCAEb,CAUA,OARI,GAAgB,EAAI,CAAC,aACvB,EAAS,KAAK,CACZ,IAAK,cACL,KAAM,UACN,MAAO,EAAE,iCACV,EAGI,GACR,CAEK,CAAE,eAAc,sBAAqB,iBAAgB,oBACzD,IAAuB,CAEnB,CAAE,sBAAqB,iBAAkB,GAAuB,CAMtE,SAAS,mBAAoB,CAC3B,IAAM,EAAe,aAAa,QAAQ,EAAiB,CAC3D,GAAI,CAAC,EAAc,OAEnB,IAAM,EAAY,SAAS,EAAc,GAAE,CAG3C,GAAI,KAAK,KAAK,CAAG,EAAY,GAAiB,CAC5C,aAAa,WAAW,EAAiB,CACzC,OAIG,GAAc,CACnB,aAAa,WAAW,EAAiB,QAG3C,MAAgB,CACd,OAAO,iBAAiB,QAAS,kBAAiB,EACnD,CAED,OAAsB,CACpB,OAAO,oBAAoB,QAAS,kBAAiB,EACtD,82FCxRoB,KAGE,IACJ,IACa,IACA,KACW,IACX,IACO,IACf,wTAExB,IAAM,EAAoC,aAEtC,OAAO,gLACX,CAEM,CAAE,SAAU,GAAgB,CAC5B,EAAwB,MACtB,IAAW,EAAM,sBACzB,CAEM,CAAE,eAAc,aAAc,GAAgB,CAE9C,CAAE,uBAAsB,wBAAyB,GAAgB,CAEjE,CAAE,mBAAkB,uBAAsB,wBAC9C,GAAuB,CAEnB,+BAAmC,CACvC,OAAO,KACL,EAAa,EAAU,oBAAqB,CAAE,cAAe,GAAM,CAAC,CACpE,SACF","names":[],"ignoreList":[],"sources":["../../src/platform/cloud/subscription/components/SubscriptionPanelContentLegacy.vue","../../src/platform/cloud/subscription/components/SubscriptionPanel.vue"],"sourcesContent":["<template>\n  <div class=\"grow overflow-auto\">\n    <div class=\"rounded-2xl border border-interface-stroke p-6\">\n      <div>\n        <div class=\"flex items-center justify-between gap-2\">\n          <div class=\"flex flex-col gap-2\">\n            <div class=\"text-sm font-bold text-text-primary\">\n              {{ subscriptionTierName }}\n            </div>\n            <div class=\"flex items-baseline gap-1 font-inter font-semibold\">\n              <span class=\"text-2xl\">${{ tierPrice }}</span>\n              <span class=\"text-base\">{{ $t('subscription.perMonth') }}</span>\n            </div>\n            <div\n              v-if=\"isActiveSubscription\"\n              class=\"text-sm text-text-secondary\"\n            >\n              <template v-if=\"isCancelled\">\n                {{\n                  $t('subscription.expiresDate', {\n                    date: formattedEndDate\n                  })\n                }}\n              </template>\n              <template v-else>\n                {{\n                  $t('subscription.renewsDate', {\n                    date: formattedRenewalDate\n                  })\n                }}\n              </template>\n            </div>\n          </div>\n\n          <Button\n            v-if=\"isActiveSubscription\"\n            variant=\"secondary\"\n            class=\"ml-auto rounded-lg px-4 py-2 text-sm font-normal text-text-primary bg-interface-menu-component-surface-selected\"\n            @click=\"\n              async () => {\n                await authActions.accessBillingPortal()\n              }\n            \"\n          >\n            {{ $t('subscription.manageSubscription') }}\n          </Button>\n          <Button\n            v-if=\"isActiveSubscription\"\n            variant=\"primary\"\n            class=\"rounded-lg px-4 py-2 text-sm font-normal text-text-primary\"\n            @click=\"showSubscriptionDialog\"\n          >\n            {{ $t('subscription.upgradePlan') }}\n          </Button>\n\n          <SubscribeButton\n            v-if=\"!isActiveSubscription\"\n            :label=\"$t('subscription.subscribeNow')\"\n            size=\"sm\"\n            :fluid=\"false\"\n            class=\"text-xs\"\n            @subscribed=\"handleRefresh\"\n          />\n        </div>\n      </div>\n\n      <div class=\"flex flex-col lg:flex-row gap-6 pt-9\">\n        <div class=\"flex flex-col shrink-0\">\n          <div class=\"flex flex-col gap-3\">\n            <div\n              :class=\"\n                cn(\n                  'relative flex flex-col gap-6 rounded-2xl p-5',\n                  'bg-modal-panel-background'\n                )\n              \"\n            >\n              <Button\n                variant=\"muted-textonly\"\n                size=\"icon-sm\"\n                class=\"absolute top-4 right-4\"\n                :loading=\"isLoadingBalance\"\n                @click=\"handleRefresh\"\n              >\n                <i class=\"pi pi-sync text-text-secondary text-sm\" />\n              </Button>\n\n              <div class=\"flex flex-col gap-2\">\n                <div class=\"text-sm text-muted\">\n                  {{ $t('subscription.totalCredits') }}\n                </div>\n                <Skeleton v-if=\"isLoadingBalance\" width=\"8rem\" height=\"2rem\" />\n                <div v-else class=\"text-2xl font-bold\">\n                  {{ totalCredits }}\n                </div>\n              </div>\n\n              <!-- Credit Breakdown -->\n              <table class=\"text-sm text-muted\">\n                <tbody>\n                  <tr>\n                    <td class=\"pr-4 font-bold text-left align-middle\">\n                      <Skeleton\n                        v-if=\"isLoadingBalance\"\n                        width=\"5rem\"\n                        height=\"1rem\"\n                      />\n                      <span v-else>{{ includedCreditsDisplay }}</span>\n                    </td>\n                    <td class=\"align-middle\" :title=\"creditsRemainingLabel\">\n                      {{ creditsRemainingLabel }}\n                    </td>\n                  </tr>\n                  <tr>\n                    <td class=\"pr-4 font-bold text-left align-middle\">\n                      <Skeleton\n                        v-if=\"isLoadingBalance\"\n                        width=\"3rem\"\n                        height=\"1rem\"\n                      />\n                      <span v-else>{{ prepaidCredits }}</span>\n                    </td>\n                    <td\n                      class=\"align-middle\"\n                      :title=\"$t('subscription.creditsYouveAdded')\"\n                    >\n                      {{ $t('subscription.creditsYouveAdded') }}\n                    </td>\n                  </tr>\n                </tbody>\n              </table>\n\n              <div class=\"flex items-center justify-between\">\n                <a\n                  href=\"https://platform.comfy.org/profile/usage\"\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  class=\"text-sm underline text-center text-muted\"\n                >\n                  {{ $t('subscription.viewUsageHistory') }}\n                </a>\n                <Button\n                  v-if=\"isActiveSubscription\"\n                  variant=\"secondary\"\n                  class=\"p-2 min-h-8 rounded-lg text-sm font-normal text-text-primary bg-interface-menu-component-surface-selected\"\n                  @click=\"handleAddApiCredits\"\n                >\n                  {{ $t('subscription.addCredits') }}\n                </Button>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div class=\"flex flex-col gap-2\">\n          <div class=\"text-sm text-text-primary\">\n            {{ $t('subscription.yourPlanIncludes') }}\n          </div>\n\n          <div class=\"flex flex-col gap-0\">\n            <div\n              v-for=\"benefit in tierBenefits\"\n              :key=\"benefit.key\"\n              class=\"flex items-center gap-2 py-2\"\n            >\n              <i\n                v-if=\"benefit.type === 'feature'\"\n                class=\"pi pi-check text-xs text-text-primary\"\n              />\n              <span\n                v-else-if=\"benefit.type === 'metric' && benefit.value\"\n                class=\"text-sm font-normal whitespace-nowrap text-text-primary\"\n              >\n                {{ benefit.value }}\n              </span>\n              <span class=\"text-sm text-muted\">\n                {{ benefit.label }}\n              </span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- View More Details - Outside main content -->\n    <div class=\"flex items-center gap-2 py-4\">\n      <i class=\"pi pi-external-link text-muted\"></i>\n      <a\n        href=\"https://www.comfy.org/cloud/pricing\"\n        target=\"_blank\"\n        rel=\"noopener noreferrer\"\n        class=\"text-sm underline hover:opacity-80 text-muted\"\n      >\n        {{ $t('subscription.viewMoreDetailsPlans') }}\n      </a>\n    </div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport Skeleton from 'primevue/skeleton'\nimport { computed, onBeforeUnmount, onMounted } from 'vue'\nimport { useI18n } from 'vue-i18n'\n\nimport Button from '@/components/ui/button/Button.vue'\nimport { useFirebaseAuthActions } from '@/composables/auth/useFirebaseAuthActions'\nimport SubscribeButton from '@/platform/cloud/subscription/components/SubscribeButton.vue'\nimport { useSubscription } from '@/platform/cloud/subscription/composables/useSubscription'\nimport { useSubscriptionActions } from '@/platform/cloud/subscription/composables/useSubscriptionActions'\nimport { useSubscriptionCredits } from '@/platform/cloud/subscription/composables/useSubscriptionCredits'\nimport { useSubscriptionDialog } from '@/platform/cloud/subscription/composables/useSubscriptionDialog'\nimport {\n  DEFAULT_TIER_KEY,\n  TIER_TO_KEY,\n  getTierCredits,\n  getTierFeatures,\n  getTierPrice\n} from '@/platform/cloud/subscription/constants/tierPricing'\nimport { cn } from '@/utils/tailwindUtil'\n\nconst authActions = useFirebaseAuthActions()\nconst { t, n } = useI18n()\n\nconst {\n  isActiveSubscription,\n  isCancelled,\n  formattedRenewalDate,\n  formattedEndDate,\n  subscriptionTier,\n  subscriptionTierName,\n  subscriptionStatus,\n  isYearlySubscription\n} = useSubscription()\n\nconst { show: showSubscriptionDialog } = useSubscriptionDialog()\n\nconst tierKey = computed(() => {\n  const tier = subscriptionTier.value\n  if (!tier) return DEFAULT_TIER_KEY\n  return TIER_TO_KEY[tier] ?? DEFAULT_TIER_KEY\n})\nconst tierPrice = computed(() =>\n  getTierPrice(tierKey.value, isYearlySubscription.value)\n)\n\nconst refillsDate = computed(() => {\n  if (!subscriptionStatus.value?.renewal_date) return ''\n  const date = new Date(subscriptionStatus.value.renewal_date)\n  const day = String(date.getDate()).padStart(2, '0')\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const year = String(date.getFullYear()).slice(-2)\n  return `${month}/${day}/${year}`\n})\n\nconst creditsRemainingLabel = computed(() =>\n  isYearlySubscription.value\n    ? t('subscription.creditsRemainingThisYear', {\n        date: refillsDate.value\n      })\n    : t('subscription.creditsRemainingThisMonth', {\n        date: refillsDate.value\n      })\n)\n\nconst planTotalCredits = computed(() => {\n  const credits = getTierCredits(tierKey.value)\n  const total = isYearlySubscription.value ? credits * 12 : credits\n  return n(total)\n})\n\nconst includedCreditsDisplay = computed(\n  () => `${monthlyBonusCredits.value} / ${planTotalCredits.value}`\n)\n\n// Tier benefits for v-for loop\ntype BenefitType = 'metric' | 'feature'\n\ninterface Benefit {\n  key: string\n  type: BenefitType\n  label: string\n  value?: string\n}\n\nconst tierBenefits = computed((): Benefit[] => {\n  const key = tierKey.value\n\n  const benefits: Benefit[] = [\n    {\n      key: 'maxDuration',\n      type: 'metric',\n      value: t(`subscription.maxDuration.${key}`),\n      label: t('subscription.maxDurationLabel')\n    },\n    {\n      key: 'gpu',\n      type: 'feature',\n      label: t('subscription.gpuLabel')\n    },\n    {\n      key: 'addCredits',\n      type: 'feature',\n      label: t('subscription.addCreditsLabel')\n    }\n  ]\n\n  if (getTierFeatures(key).customLoRAs) {\n    benefits.push({\n      key: 'customLoRAs',\n      type: 'feature',\n      label: t('subscription.customLoRAsLabel')\n    })\n  }\n\n  return benefits\n})\n\nconst { totalCredits, monthlyBonusCredits, prepaidCredits, isLoadingBalance } =\n  useSubscriptionCredits()\n\nconst { handleAddApiCredits, handleRefresh } = useSubscriptionActions()\n\n// Focus-based polling: refresh balance when user returns from Stripe checkout\nconst PENDING_TOPUP_KEY = 'pending_topup_timestamp'\nconst TOPUP_EXPIRY_MS = 5 * 60 * 1000 // 5 minutes\n\nfunction handleWindowFocus() {\n  const timestampStr = localStorage.getItem(PENDING_TOPUP_KEY)\n  if (!timestampStr) return\n\n  const timestamp = parseInt(timestampStr, 10)\n\n  // Clear expired tracking (older than 5 minutes)\n  if (Date.now() - timestamp > TOPUP_EXPIRY_MS) {\n    localStorage.removeItem(PENDING_TOPUP_KEY)\n    return\n  }\n\n  // Refresh and clear tracking to prevent repeated calls\n  void handleRefresh()\n  localStorage.removeItem(PENDING_TOPUP_KEY)\n}\n\nonMounted(() => {\n  window.addEventListener('focus', handleWindowFocus)\n})\n\nonBeforeUnmount(() => {\n  window.removeEventListener('focus', handleWindowFocus)\n})\n</script>\n\n<style scoped>\n:deep(.bg-comfy-menu-secondary) {\n  background-color: transparent;\n}\n</style>\n","<template>\n  <TabPanel value=\"PlanCredits\" class=\"subscription-container h-full\">\n    <div class=\"flex h-full flex-col gap-6\">\n      <div class=\"flex items-center gap-2\">\n        <span class=\"text-2xl font-inter font-semibold leading-tight\">\n          {{\n            isActiveSubscription\n              ? $t('subscription.title')\n              : $t('subscription.titleUnsubscribed')\n          }}\n        </span>\n        <div class=\"pt-1\">\n          <CloudBadge\n            reverse-order\n            background-color=\"var(--p-dialog-background)\"\n          />\n        </div>\n      </div>\n\n      <!-- Workspace mode: workspace-aware subscription content -->\n      <SubscriptionPanelContentWorkspace v-if=\"teamWorkspacesEnabled\" />\n      <!-- Legacy mode: user-level subscription content -->\n      <SubscriptionPanelContentLegacy v-else />\n\n      <div\n        class=\"flex items-center justify-between border-t border-interface-stroke pt-3\"\n      >\n        <div class=\"flex gap-2\">\n          <Button\n            variant=\"muted-textonly\"\n            class=\"text-xs text-text-secondary\"\n            @click=\"handleLearnMoreClick\"\n          >\n            <i class=\"pi pi-question-circle text-text-secondary text-xs\" />\n            {{ $t('subscription.learnMore') }}\n          </Button>\n          <Button\n            variant=\"muted-textonly\"\n            class=\"text-xs text-text-secondary\"\n            @click=\"handleOpenPartnerNodesInfo\"\n          >\n            <i class=\"pi pi-question-circle text-text-secondary text-xs\" />\n            {{ $t('subscription.partnerNodesCredits') }}\n          </Button>\n          <Button\n            variant=\"muted-textonly\"\n            class=\"text-xs text-text-secondary\"\n            :loading=\"isLoadingSupport\"\n            @click=\"handleMessageSupport\"\n          >\n            <i class=\"pi pi-comment text-text-secondary text-xs\" />\n            {{ $t('subscription.messageSupport') }}\n          </Button>\n        </div>\n\n        <Button\n          variant=\"muted-textonly\"\n          class=\"text-xs text-text-secondary\"\n          @click=\"handleInvoiceHistory\"\n        >\n          {{ $t('subscription.invoiceHistory') }}\n          <i class=\"pi pi-external-link text-text-secondary text-xs\" />\n        </Button>\n      </div>\n    </div>\n  </TabPanel>\n</template>\n\n<script setup lang=\"ts\">\nimport TabPanel from 'primevue/tabpanel'\nimport { computed, defineAsyncComponent } from 'vue'\n\nimport CloudBadge from '@/components/topbar/CloudBadge.vue'\nimport Button from '@/components/ui/button/Button.vue'\nimport { useExternalLink } from '@/composables/useExternalLink'\nimport { useFeatureFlags } from '@/composables/useFeatureFlags'\nimport SubscriptionPanelContentLegacy from '@/platform/cloud/subscription/components/SubscriptionPanelContentLegacy.vue'\nimport { useSubscription } from '@/platform/cloud/subscription/composables/useSubscription'\nimport { useSubscriptionActions } from '@/platform/cloud/subscription/composables/useSubscriptionActions'\nimport { isCloud } from '@/platform/distribution/types'\n\nconst SubscriptionPanelContentWorkspace = defineAsyncComponent(\n  () =>\n    import('@/platform/cloud/subscription/components/SubscriptionPanelContentWorkspace.vue')\n)\n\nconst { flags } = useFeatureFlags()\nconst teamWorkspacesEnabled = computed(\n  () => isCloud && flags.teamWorkspacesEnabled\n)\n\nconst { buildDocsUrl, docsPaths } = useExternalLink()\n\nconst { isActiveSubscription, handleInvoiceHistory } = useSubscription()\n\nconst { isLoadingSupport, handleMessageSupport, handleLearnMoreClick } =\n  useSubscriptionActions()\n\nconst handleOpenPartnerNodesInfo = () => {\n  window.open(\n    buildDocsUrl(docsPaths.partnerNodesPricing, { includeLocale: true }),\n    '_blank'\n  )\n}\n</script>\n"],"file":"SubscriptionPanel-Q6AnUIJP.js"}