{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["../../src/config/firebase.ts","../../src/components/auth/WorkspaceAuthGate.vue","../../src/views/layouts/LayoutDefault.vue","../../src/platform/navigation/preservedQueryTracker.ts","../../src/platform/cloud/onboarding/onboardingCloudRoutes.ts","../../src/router.ts","../../src/components/dialog/GlobalDialog.vue","../../src/App.vue","../../src/main.ts","../../index.html"],"sourcesContent":["import type { FirebaseOptions } from 'firebase/app'\n\nimport { isCloud } from '@/platform/distribution/types'\nimport { remoteConfig } from '@/platform/remoteConfig/remoteConfig'\n\nconst DEV_CONFIG: FirebaseOptions = {\n  apiKey: 'AIzaSyDa_YMeyzV0SkVe92vBZ1tVikWBmOU5KVE',\n  authDomain: 'dreamboothy-dev.firebaseapp.com',\n  databaseURL: 'https://dreamboothy-dev-default-rtdb.firebaseio.com',\n  projectId: 'dreamboothy-dev',\n  storageBucket: 'dreamboothy-dev.appspot.com',\n  messagingSenderId: '313257147182',\n  appId: '1:313257147182:web:be38f6ebf74345fc7618bf',\n  measurementId: 'G-YEVSMYXSPY'\n}\n\nconst PROD_CONFIG: FirebaseOptions = {\n  apiKey: 'AIzaSyC2-fomLqgCjb7ELwta1I9cEarPK8ziTGs',\n  authDomain: 'dreamboothy.firebaseapp.com',\n  databaseURL: 'https://dreamboothy-default-rtdb.firebaseio.com',\n  projectId: 'dreamboothy',\n  storageBucket: 'dreamboothy.appspot.com',\n  messagingSenderId: '357148958219',\n  appId: '1:357148958219:web:f5917f72e5f36a2015310e',\n  measurementId: 'G-3ZBD3MBTG4'\n}\n\nconst BUILD_TIME_CONFIG = __USE_PROD_CONFIG__ ? PROD_CONFIG : DEV_CONFIG\n\n/**\n * Returns the Firebase configuration for the current environment.\n * - Cloud builds use runtime configuration delivered via feature flags\n * - OSS / localhost builds fall back to the build-time config determined by __USE_PROD_CONFIG__\n */\nexport function getFirebaseConfig(): FirebaseOptions {\n  if (!isCloud) {\n    return BUILD_TIME_CONFIG\n  }\n\n  const runtimeConfig = remoteConfig.value.firebase_config\n  return runtimeConfig ?? BUILD_TIME_CONFIG\n}\n","<template>\n  <slot v-if=\"isReady\" />\n  <div\n    v-else\n    class=\"fixed inset-0 z-[1100] flex items-center justify-center bg-[var(--p-mask-background)]\"\n  >\n    <ProgressSpinner />\n  </div>\n</template>\n\n<script setup lang=\"ts\">\n/**\n * WorkspaceAuthGate - Conditional auth checkpoint for workspace mode.\n *\n * This gate ensures proper initialization order for workspace-scoped auth:\n * 1. Wait for Firebase auth to resolve\n * 2. Check if teamWorkspacesEnabled feature flag is on\n * 3. If YES: Initialize workspace token and store before rendering\n * 4. If NO: Render immediately using existing Firebase auth\n *\n * This prevents race conditions where API calls use Firebase tokens\n * instead of workspace tokens when the workspace feature is enabled.\n */\nimport { promiseTimeout, until } from '@vueuse/core'\nimport { storeToRefs } from 'pinia'\nimport ProgressSpinner from 'primevue/progressspinner'\nimport { onMounted, ref } from 'vue'\n\nimport { useFeatureFlags } from '@/composables/useFeatureFlags'\nimport { isCloud } from '@/platform/distribution/types'\nimport { refreshRemoteConfig } from '@/platform/remoteConfig/refreshRemoteConfig'\nimport { useTeamWorkspaceStore } from '@/platform/workspace/stores/teamWorkspaceStore'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\n\nconst FIREBASE_INIT_TIMEOUT_MS = 16_000\nconst CONFIG_REFRESH_TIMEOUT_MS = 10_000\n\nconst isReady = ref(!isCloud)\n\nasync function initialize(): Promise<void> {\n  if (!isCloud) return\n\n  const authStore = useFirebaseAuthStore()\n  const { isInitialized, currentUser } = storeToRefs(authStore)\n\n  try {\n    // Step 1: Wait for Firebase auth to resolve\n    // This is shared with router guard - both wait for the same thing,\n    // but this gate blocks rendering while router guard blocks navigation\n    if (!isInitialized.value) {\n      await until(isInitialized).toBe(true, {\n        timeout: FIREBASE_INIT_TIMEOUT_MS\n      })\n    }\n\n    // Step 2: If not authenticated, nothing more to do\n    // Unauthenticated users don't have workspace context\n    if (!currentUser.value) {\n      isReady.value = true\n      return\n    }\n\n    // Step 3: Refresh feature flags with auth context\n    // This ensures teamWorkspacesEnabled reflects the authenticated user's state\n    // Timeout prevents hanging if server is slow/unresponsive\n    try {\n      await Promise.race([\n        refreshRemoteConfig({ useAuth: true }),\n        promiseTimeout(CONFIG_REFRESH_TIMEOUT_MS).then(() => {\n          throw new Error('Config refresh timeout')\n        })\n      ])\n    } catch (error) {\n      console.warn(\n        '[WorkspaceAuthGate] Failed to refresh remote config:',\n        error\n      )\n      // Continue - feature flags will use defaults (teamWorkspacesEnabled=false)\n      // App will render with Firebase auth fallback\n    }\n\n    // Step 4: THE CHECKPOINT - Are we in workspace mode?\n    const { flags } = useFeatureFlags()\n    if (!flags.teamWorkspacesEnabled) {\n      // Not in workspace mode - use existing Firebase auth flow\n      // No additional initialization needed\n      isReady.value = true\n      return\n    }\n\n    // Step 5: WORKSPACE MODE - Full initialization\n    await initializeWorkspaceMode()\n  } catch (error) {\n    console.error('[WorkspaceAuthGate] Initialization failed:', error)\n  } finally {\n    // Always render (graceful degradation)\n    // If workspace init failed, API calls fall back to Firebase token\n    isReady.value = true\n  }\n}\n\nasync function initializeWorkspaceMode(): Promise<void> {\n  // Initialize the full workspace store which handles:\n  // - Restoring workspace token from session (fast path for refresh)\n  // - Fetching workspace list\n  // - Switching to last used workspace if needed\n  // - Setting active workspace\n  try {\n    const workspaceStore = useTeamWorkspaceStore()\n    if (workspaceStore.initState === 'uninitialized') {\n      await workspaceStore.initialize()\n    }\n  } catch (error) {\n    // Log but don't block - workspace UI features may not work but app will render\n    // API calls will fall back to Firebase token\n    console.warn(\n      '[WorkspaceAuthGate] Failed to initialize workspace store:',\n      error\n    )\n  }\n}\n\n// Initialize on mount. This gate should be placed on the authenticated layout\n// (LayoutDefault) so it mounts fresh after login and unmounts on logout.\n// The router guard ensures only authenticated users reach this layout.\nonMounted(() => {\n  void initialize()\n})\n</script>\n","<template>\n  <WorkspaceAuthGate>\n    <main class=\"relative h-full w-full overflow-hidden\">\n      <router-view />\n    </main>\n  </WorkspaceAuthGate>\n</template>\n\n<script setup lang=\"ts\">\nimport { useFavicon } from '@vueuse/core'\n\nimport WorkspaceAuthGate from '@/components/auth/WorkspaceAuthGate.vue'\n\nuseFavicon('/assets/favicon.ico')\n</script>\n","import type { Router } from 'vue-router'\n\nimport {\n  capturePreservedQuery,\n  hydratePreservedQuery\n} from '@/platform/navigation/preservedQueryManager'\n\nexport const installPreservedQueryTracker = (\n  router: Router,\n  definitions: Array<{ namespace: string; keys: string[] }>\n) => {\n  const trackedDefinitions = definitions.map((definition) => ({\n    ...definition\n  }))\n\n  router.beforeEach((to, _from, next) => {\n    const queryKeys = new Set(Object.keys(to.query))\n\n    trackedDefinitions.forEach(({ namespace, keys }) => {\n      hydratePreservedQuery(namespace)\n      const shouldCapture = keys.some((key) => queryKeys.has(key))\n      if (shouldCapture) {\n        capturePreservedQuery(namespace, to.query, keys)\n      }\n    })\n\n    next()\n  })\n}\n","import type { RouteRecordRaw } from 'vue-router'\n\nexport const cloudOnboardingRoutes: RouteRecordRaw[] = [\n  {\n    path: '/cloud',\n    component: () =>\n      import('@/platform/cloud/onboarding/components/CloudLayoutView.vue'),\n    children: [\n      {\n        path: 'login',\n        name: 'cloud-login',\n        component: () =>\n          import('@/platform/cloud/onboarding/CloudLoginView.vue'),\n        beforeEnter: async (to, _from, next) => {\n          // Only redirect if not explicitly switching accounts\n          if (!to.query.switchAccount) {\n            const { useCurrentUser } =\n              await import('@/composables/auth/useCurrentUser')\n            const { isLoggedIn } = useCurrentUser()\n\n            if (isLoggedIn.value) {\n              // User is already logged in, redirect to user-check\n              // user-check will handle survey, or main page routing\n              return next({ name: 'cloud-user-check' })\n            }\n          }\n          next()\n        }\n      },\n      {\n        path: 'signup',\n        name: 'cloud-signup',\n        component: () =>\n          import('@/platform/cloud/onboarding/CloudSignupView.vue')\n      },\n      {\n        path: 'forgot-password',\n        name: 'cloud-forgot-password',\n        component: () =>\n          import('@/platform/cloud/onboarding/CloudForgotPasswordView.vue')\n      },\n      {\n        path: 'survey',\n        name: 'cloud-survey',\n        component: () =>\n          import('@/platform/cloud/onboarding/CloudSurveyView.vue'),\n        meta: { requiresAuth: true }\n      },\n      {\n        path: 'user-check',\n        name: 'cloud-user-check',\n        component: () =>\n          import('@/platform/cloud/onboarding/UserCheckView.vue'),\n        meta: { requiresAuth: true }\n      },\n      {\n        path: 'sorry-contact-support',\n        name: 'cloud-sorry-contact-support',\n        component: () =>\n          import('@/platform/cloud/onboarding/CloudSorryContactSupportView.vue')\n      },\n      {\n        path: 'auth-timeout',\n        name: 'cloud-auth-timeout',\n        component: () =>\n          import('@/platform/cloud/onboarding/CloudAuthTimeoutView.vue'),\n        props: true\n      },\n      {\n        path: 'subscribe',\n        name: 'cloud-subscribe',\n        component: () =>\n          import('@/platform/cloud/onboarding/CloudSubscriptionRedirectView.vue'),\n        meta: { requiresAuth: true }\n      }\n    ]\n  }\n]\n","import { until } from '@vueuse/core'\nimport { storeToRefs } from 'pinia'\nimport {\n  createRouter,\n  createWebHashHistory,\n  createWebHistory\n} from 'vue-router'\nimport type { RouteLocationNormalized } from 'vue-router'\n\nimport { useFeatureFlags } from '@/composables/useFeatureFlags'\nimport { isCloud } from '@/platform/distribution/types'\nimport { useDialogService } from '@/services/dialogService'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\nimport { useUserStore } from '@/stores/userStore'\nimport { isElectron } from '@/utils/envUtil'\nimport LayoutDefault from '@/views/layouts/LayoutDefault.vue'\n\nimport { installPreservedQueryTracker } from '@/platform/navigation/preservedQueryTracker'\nimport { PRESERVED_QUERY_NAMESPACES } from '@/platform/navigation/preservedQueryNamespaces'\nimport { cloudOnboardingRoutes } from './platform/cloud/onboarding/onboardingCloudRoutes'\n\nconst isFileProtocol = window.location.protocol === 'file:'\n\n/**\n * Determine base path for the router.\n * - Electron: always root\n * - Cloud: use Vite's BASE_URL (configured at build time)\n * - Standard web (including reverse proxy subpaths): use window.location.pathname\n *   to support deployments like http://mysite.com/ComfyUI/\n */\nfunction getBasePath(): string {\n  if (isElectron()) return '/'\n  if (isCloud) return import.meta.env?.BASE_URL || '/'\n  return window.location.pathname\n}\n\nconst basePath = getBasePath()\n\nconst router = createRouter({\n  history: isFileProtocol\n    ? createWebHashHistory()\n    : // Base path must be specified to ensure correct relative paths\n      // Example: For URL 'http://localhost:7801/ComfyBackendDirect',\n      // we need this base path or assets will incorrectly resolve from 'http://localhost:7801/'\n      createWebHistory(basePath),\n  routes: [\n    ...(isCloud ? cloudOnboardingRoutes : []),\n    {\n      path: '/',\n      component: LayoutDefault,\n      children: [\n        {\n          path: '',\n          name: 'GraphView',\n          component: () => import('@/views/GraphView.vue'),\n          beforeEnter: async (_to, _from, next) => {\n            // Then check user store\n            const userStore = useUserStore()\n            await userStore.initialize()\n            if (userStore.needsLogin) {\n              next('/user-select')\n            } else {\n              next()\n            }\n          }\n        },\n        {\n          path: 'user-select',\n          name: 'UserSelectView',\n          component: () => import('@/views/UserSelectView.vue')\n        }\n      ]\n    }\n  ],\n\n  scrollBehavior(_to, _from, savedPosition) {\n    if (savedPosition) {\n      return savedPosition\n    } else {\n      return { top: 0 }\n    }\n  }\n})\n\ninstallPreservedQueryTracker(router, [\n  {\n    namespace: PRESERVED_QUERY_NAMESPACES.TEMPLATE,\n    keys: ['template', 'source', 'mode']\n  },\n  {\n    namespace: PRESERVED_QUERY_NAMESPACES.INVITE,\n    keys: ['invite']\n  }\n])\n\nif (isCloud) {\n  const { flags } = useFeatureFlags()\n  const PUBLIC_ROUTE_NAMES = new Set([\n    'cloud-login',\n    'cloud-signup',\n    'cloud-forgot-password',\n    'cloud-sorry-contact-support'\n  ])\n  const PUBLIC_ROUTE_PATHS = new Set([\n    '/cloud/login',\n    '/cloud/signup',\n    '/cloud/forgot-password',\n    '/cloud/sorry-contact-support'\n  ])\n\n  function isPublicRoute(to: RouteLocationNormalized) {\n    const name = String(to.name)\n    if (PUBLIC_ROUTE_NAMES.has(name)) return true\n    const path = to.path\n    return PUBLIC_ROUTE_PATHS.has(path)\n  }\n  // Global authentication guard\n  router.beforeEach(async (to, _from, next) => {\n    const authStore = useFirebaseAuthStore()\n\n    // Wait for Firebase auth to initialize\n    // Timeout after 16 seconds\n    if (!authStore.isInitialized) {\n      try {\n        const { isInitialized } = storeToRefs(authStore)\n        await until(isInitialized).toBe(true, { timeout: 16_000 })\n      } catch (error) {\n        console.error('Auth initialization failed:', error)\n        return next({ name: 'cloud-auth-timeout' })\n      }\n    }\n\n    // Pass authenticated users\n    const authHeader = await authStore.getAuthHeader()\n    const isLoggedIn = !!authHeader\n\n    // Allow public routes\n    if (isPublicRoute(to)) {\n      return next()\n    }\n\n    // Special handling for user-check\n    // These routes need auth but handle their own routing logic\n    if (to.name === 'cloud-user-check') {\n      if (to.meta.requiresAuth && !isLoggedIn) {\n        return next({ name: 'cloud-login' })\n      }\n      return next()\n    }\n\n    // Prevent redirect loop when coming from user-check\n    if (_from.name === 'cloud-user-check' && to.path === '/') {\n      return next()\n    }\n\n    const query =\n      to.fullPath === '/'\n        ? undefined\n        : { previousFullPath: encodeURIComponent(to.fullPath) }\n\n    // Check if route requires authentication\n    if (to.meta.requiresAuth && !isLoggedIn) {\n      return next({\n        name: 'cloud-login',\n        query\n      })\n    }\n\n    // Handle other protected routes\n    if (!isLoggedIn) {\n      // For Electron, use dialog\n      if (isElectron()) {\n        const dialogService = useDialogService()\n        const loginSuccess = await dialogService.showSignInDialog()\n        return loginSuccess ? next() : next(false)\n      }\n\n      // For web, redirect to login\n      return next({\n        name: 'cloud-login',\n        query\n      })\n    }\n\n    // User is logged in - check if they need onboarding (when enabled)\n    // For root path, check actual user status to handle waitlisted users\n    if (!isElectron() && isLoggedIn && to.path === '/') {\n      if (!flags.onboardingSurveyEnabled) {\n        return next()\n      }\n      // Import auth functions dynamically to avoid circular dependency\n      const { getSurveyCompletedStatus } =\n        await import('@/platform/cloud/onboarding/auth')\n      try {\n        // Check user's actual status\n        const surveyCompleted = await getSurveyCompletedStatus()\n\n        // Survey is required for all users (when feature flag enabled)\n        if (!surveyCompleted) {\n          return next({ name: 'cloud-survey' })\n        }\n      } catch (error) {\n        console.error('Failed to check user status:', error)\n        // On error, redirect to user-check as fallback\n        return next({ name: 'cloud-user-check' })\n      }\n    }\n\n    // User is logged in and accessing protected route\n    return next()\n  })\n}\n\nexport default router\n","<!-- The main global dialog to show various things -->\n<template>\n  <Dialog\n    v-for=\"item in dialogStore.dialogStack\"\n    :key=\"item.key\"\n    v-model:visible=\"item.visible\"\n    :class=\"[\n      'global-dialog',\n      item.key === 'global-settings' && teamWorkspacesEnabled\n        ? 'settings-dialog-workspace'\n        : ''\n    ]\"\n    v-bind=\"item.dialogComponentProps\"\n    :pt=\"getDialogPt(item)\"\n    :aria-labelledby=\"item.key\"\n  >\n    <template #header>\n      <div v-if=\"!item.dialogComponentProps?.headless\">\n        <component\n          :is=\"item.headerComponent\"\n          v-if=\"item.headerComponent\"\n          v-bind=\"item.headerProps\"\n          :id=\"item.key\"\n        />\n        <h3 v-else :id=\"item.key\">\n          {{ item.title || ' ' }}\n        </h3>\n      </div>\n    </template>\n\n    <component\n      :is=\"item.component\"\n      v-bind=\"item.contentProps\"\n      :maximized=\"item.dialogComponentProps.maximized\"\n    />\n\n    <template v-if=\"item.footerComponent\" #footer>\n      <component :is=\"item.footerComponent\" v-bind=\"item.footerProps\" />\n    </template>\n  </Dialog>\n</template>\n\n<script setup lang=\"ts\">\nimport { merge } from 'es-toolkit/compat'\nimport Dialog from 'primevue/dialog'\nimport type { DialogPassThroughOptions } from 'primevue/dialog'\nimport { computed } from 'vue'\n\nimport { useFeatureFlags } from '@/composables/useFeatureFlags'\nimport { isCloud } from '@/platform/distribution/types'\nimport type { DialogComponentProps } from '@/stores/dialogStore'\nimport { useDialogStore } from '@/stores/dialogStore'\n\nconst { flags } = useFeatureFlags()\nconst teamWorkspacesEnabled = computed(\n  () => isCloud && flags.teamWorkspacesEnabled\n)\n\nconst dialogStore = useDialogStore()\n\nfunction getDialogPt(item: {\n  key: string\n  dialogComponentProps: DialogComponentProps\n}): DialogPassThroughOptions {\n  const isWorkspaceSettingsDialog =\n    item.key === 'global-settings' && teamWorkspacesEnabled.value\n  const basePt = item.dialogComponentProps.pt || {}\n\n  if (isWorkspaceSettingsDialog) {\n    return merge(basePt, {\n      mask: { class: 'p-8' }\n    })\n  }\n  return basePt\n}\n</script>\n\n<style>\n@reference '../../assets/css/style.css';\n\n.global-dialog .p-dialog-header {\n  @apply p-2 2xl:p-[var(--p-dialog-header-padding)];\n  @apply pb-0;\n}\n\n.global-dialog .p-dialog-content {\n  @apply p-2 2xl:p-[var(--p-dialog-content-padding)];\n  @apply pt-0;\n}\n\n/* Workspace mode: wider settings dialog */\n.settings-dialog-workspace {\n  width: 100%;\n  max-width: 1440px;\n  height: 100%;\n}\n\n.settings-dialog-workspace .p-dialog-content {\n  width: 100%;\n  height: 100%;\n  overflow-y: auto;\n}\n\n.manager-dialog {\n  height: 80vh;\n  max-width: 1724px;\n  max-height: 1026px;\n}\n\n@media (min-width: 3000px) {\n  .manager-dialog {\n    max-width: 2200px;\n    max-height: 1320px;\n  }\n}\n</style>\n","<template>\n  <router-view />\n  <ProgressSpinner\n    v-if=\"isLoading\"\n    class=\"absolute inset-0 flex h-[unset] items-center justify-center\"\n  />\n  <GlobalDialog />\n  <BlockUI full-screen :blocked=\"isLoading\" />\n</template>\n\n<script setup lang=\"ts\">\nimport { captureException } from '@sentry/vue'\nimport BlockUI from 'primevue/blockui'\nimport ProgressSpinner from 'primevue/progressspinner'\nimport { computed, onMounted } from 'vue'\n\nimport GlobalDialog from '@/components/dialog/GlobalDialog.vue'\nimport config from '@/config'\nimport { useWorkspaceStore } from '@/stores/workspaceStore'\nimport { useConflictDetection } from '@/workbench/extensions/manager/composables/useConflictDetection'\n\nimport { electronAPI, isElectron } from './utils/envUtil'\nimport { app } from '@/scripts/app'\n\nconst workspaceStore = useWorkspaceStore()\napp.extensionManager = useWorkspaceStore()\n\nconst conflictDetection = useConflictDetection()\nconst isLoading = computed<boolean>(() => workspaceStore.spinner)\n\nconst showContextMenu = (event: MouseEvent) => {\n  const { target } = event\n  switch (true) {\n    case target instanceof HTMLTextAreaElement:\n    case target instanceof HTMLInputElement && target.type === 'text':\n      // TODO: Context input menu explicitly for text input\n      electronAPI()?.showContextMenu({ type: 'text' })\n      return\n  }\n}\n\nonMounted(() => {\n  window['__COMFYUI_FRONTEND_VERSION__'] = config.app_version\n\n  if (isElectron()) {\n    document.addEventListener('contextmenu', showContextMenu)\n  }\n\n  // Handle preload errors that occur during dynamic imports (e.g., stale chunks after deployment)\n  // See: https://vite.dev/guide/build#load-error-handling\n  window.addEventListener('vite:preloadError', (event) => {\n    event.preventDefault()\n    // eslint-disable-next-line no-undef\n    if (__DISTRIBUTION__ === 'cloud') {\n      captureException(event.payload, {\n        tags: { error_type: 'vite_preload_error' }\n      })\n    } else {\n      console.error('[vite:preloadError]', event.payload)\n    }\n  })\n\n  // Initialize conflict detection in background\n  // This runs async and doesn't block UI setup\n  void conflictDetection.initializeConflictDetection()\n})\n</script>\n","import { definePreset } from '@primevue/themes'\nimport Aura from '@primevue/themes/aura'\nimport * as Sentry from '@sentry/vue'\nimport { initializeApp } from 'firebase/app'\nimport { createPinia } from 'pinia'\nimport 'primeicons/primeicons.css'\nimport PrimeVue from 'primevue/config'\nimport ConfirmationService from 'primevue/confirmationservice'\nimport ToastService from 'primevue/toastservice'\nimport Tooltip from 'primevue/tooltip'\nimport { createApp } from 'vue'\nimport { VueFire, VueFireAuth } from 'vuefire'\n\nimport { getFirebaseConfig } from '@/config/firebase'\nimport '@/lib/litegraph/public/css/litegraph.css'\nimport router from '@/router'\nimport { useBootstrapStore } from '@/stores/bootstrapStore'\n\nimport App from './App.vue'\n// Intentionally relative import to ensure the CSS is loaded in the right order (after litegraph.css)\nimport './assets/css/style.css'\nimport { i18n } from './i18n'\n\n/**\n * CRITICAL: Load remote config FIRST for cloud builds to ensure\n * window.__CONFIG__is available for all modules during initialization\n */\nimport { isCloud } from '@/platform/distribution/types'\n\nif (isCloud) {\n  const { refreshRemoteConfig } =\n    await import('@/platform/remoteConfig/refreshRemoteConfig')\n  await refreshRemoteConfig({ useAuth: false })\n}\n\nconst ComfyUIPreset = definePreset(Aura, {\n  semantic: {\n    // @ts-expect-error fixme ts strict error\n    primary: Aura['primitive'].blue\n  }\n})\n\nconst firebaseApp = initializeApp(getFirebaseConfig())\n\nconst app = createApp(App)\nconst pinia = createPinia()\n\nSentry.init({\n  app,\n  dsn: __SENTRY_DSN__,\n  enabled: __SENTRY_ENABLED__,\n  release: __COMFYUI_FRONTEND_VERSION__,\n  normalizeDepth: 8,\n  tracesSampleRate: isCloud ? 1.0 : 0,\n  replaysSessionSampleRate: 0,\n  replaysOnErrorSampleRate: 0,\n  // Only set these for non-cloud builds\n  ...(isCloud\n    ? {}\n    : {\n        integrations: [],\n        autoSessionTracking: false,\n        defaultIntegrations: false\n      })\n})\napp.directive('tooltip', Tooltip)\napp\n  .use(router)\n  .use(PrimeVue, {\n    theme: {\n      preset: ComfyUIPreset,\n      options: {\n        prefix: 'p',\n        cssLayer: {\n          name: 'primevue',\n          order: 'theme, base, primevue'\n        },\n        // This is a workaround for the issue with the dark mode selector\n        // https://github.com/primefaces/primevue/issues/5515\n        darkModeSelector: '.dark-theme, :root:has(.dark-theme)'\n      }\n    }\n  })\n  .use(ConfirmationService)\n  .use(ToastService)\n  .use(pinia)\n  .use(i18n)\n  .use(VueFire, {\n    firebaseApp,\n    modules: [VueFireAuth()]\n  })\n\nconst bootstrapStore = useBootstrapStore(pinia)\nvoid bootstrapStore.startStoreBootstrap()\n\napp.mount('#vue-app')\n","<!doctype html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\" />\n    <title>ComfyUI</title>\n    <meta\n      name=\"viewport\"\n      content=\"width=device-width, initial-scale=1.0, user-scalable=no\"\n    />\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"materialdesignicons.min.css\" />\n\n    <!-- Fullscreen mode on mobile browsers -->\n    <meta name=\"mobile-web-app-capable\" content=\"yes\" />\n    <!-- Status bar style (eg. black or transparent) -->\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black\" />\n    <style>\n      @media (prefers-color-scheme: dark) {\n        body {\n          /* Setting it early for background during load */\n          --bg-color: #202020;\n          --fg-color: #ffffff;\n        }\n      }\n      html,\n      body {\n        width: 100%;\n        height: 100%;\n        margin: 0;\n      }\n      body {\n        display: grid;\n        background-color: var(--bg-color);\n        background-image: var(--bg-img);\n        background-position: center;\n        background-size: cover;\n        background-repeat: no-repeat;\n      }\n      #vue-app:has(#loading-logo) {\n        display: contents;\n        color: var(--fg-color);\n        & #loading-logo {\n          place-self: center;\n          font-size: clamp(2px, 1vw, 6px);\n          line-height: 1;\n          overflow: hidden;\n          max-width: 100vw;\n          border-radius: 20ch;\n        }\n      }\n      .visually-hidden {\n        position: absolute;\n        width: 1px;\n        height: 1px;\n        padding: 0;\n        margin: -1px;\n        overflow: hidden;\n        clip-path: inset(50%);\n        white-space: nowrap;\n        border: 0;\n      }\n    </style>\n    <link rel=\"manifest\" href=\"manifest.json\" />\n  </head>\n\n  <body class=\"litegraph grid\">\n    <div id=\"vue-app\">\n      <span class=\"visually-hidden\" role=\"status\">Loading ComfyUI...</span>\n      <svg\n        width=\"520\"\n        height=\"520\"\n        viewBox=\"0 0 520 520\"\n        fill=\"none\"\n        xmlns=\"http://www.w3.org/2000/svg\"\n        id=\"loading-logo\"\n      >\n        <mask\n          id=\"mask0_227_285\"\n          style=\"mask-type: alpha\"\n          maskUnits=\"userSpaceOnUse\"\n          x=\"0\"\n          y=\"0\"\n          width=\"520\"\n          height=\"520\"\n        >\n          <path\n            d=\"M0 184.335C0 119.812 0 87.5502 12.5571 62.9055C23.6026 41.2274 41.2274 23.6026 62.9055 12.5571C87.5502 0 119.812 0 184.335 0H335.665C400.188 0 432.45 0 457.094 12.5571C478.773 23.6026 496.397 41.2274 507.443 62.9055C520 87.5502 520 119.812 520 184.335V335.665C520 400.188 520 432.45 507.443 457.094C496.397 478.773 478.773 496.397 457.094 507.443C432.45 520 400.188 520 335.665 520H184.335C119.812 520 87.5502 520 62.9055 507.443C41.2274 496.397 23.6026 478.773 12.5571 457.094C0 432.45 0 400.188 0 335.665V184.335Z\"\n            fill=\"#EEFF30\"\n          />\n        </mask>\n        <g mask=\"url(#mask0_227_285)\">\n          <rect y=\"0.751831\" width=\"520\" height=\"520\" fill=\"#172DD7\" />\n          <path\n            d=\"M176.484 428.831C168.649 428.831 162.327 425.919 158.204 420.412C153.966 414.755 152.861 406.857 155.171 398.749L164.447 366.178C165.187 363.585 164.672 360.794 163.059 358.636C161.446 356.483 158.921 355.216 156.241 355.216H129.571C121.731 355.216 115.409 352.308 111.289 346.802C107.051 341.14 105.946 333.242 108.258 325.134L140.124 213.748L143.642 201.51C148.371 184.904 165.62 171.407 182.097 171.407H214.009C217.817 171.407 221.167 168.868 222.215 165.183L232.769 128.135C237.494 111.545 254.742 98.048 271.219 98.048L339.468 97.9264L389.431 97.9221C397.268 97.9221 403.59 100.831 407.711 106.337C411.949 111.994 413.054 119.892 410.744 128L396.457 178.164C391.734 194.75 374.485 208.242 358.009 208.242L289.607 208.372H257.706C253.902 208.372 250.557 210.907 249.502 214.588L222.903 307.495C222.159 310.093 222.673 312.892 224.291 315.049C225.904 317.202 228.428 318.469 231.107 318.469C231.113 318.469 276.307 318.381 276.307 318.381H326.122C333.959 318.381 340.281 321.29 344.402 326.796C348.639 332.457 349.744 340.355 347.433 348.463L333.146 398.619C328.423 415.209 311.174 428.701 294.698 428.701L226.299 428.831H176.484Z\"\n            fill=\"#F0FF41\"\n          />\n        </g>\n      </svg>\n    </div>\n    <script type=\"module\" src=\"src/main.ts\"></script>\n  </body>\n</html>\n"],"file":"index-D9WcDu65.js"}