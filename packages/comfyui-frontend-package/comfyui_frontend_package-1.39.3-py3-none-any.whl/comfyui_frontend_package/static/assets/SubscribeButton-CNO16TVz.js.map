{"version":3,"file":"SubscribeButton-CNO16TVz.js","names":[],"sources":["../../src/platform/cloud/subscription/components/SubscribeButton.vue","../../src/platform/cloud/subscription/components/SubscribeButton.vue"],"sourcesContent":["<template>\n  <Button\n    :size\n    :loading=\"isLoading\"\n    :disabled=\"disabled || isPolling\"\n    variant=\"primary\"\n    :style=\"\n      variant === 'gradient'\n        ? {\n            background: 'var(--color-subscription-button-gradient)',\n            color: 'var(--color-white)'\n          }\n        : undefined\n    \"\n    :class=\"cn('font-bold', fluid && 'w-full')\"\n    @click=\"handleSubscribe\"\n  >\n    {{ label || $t('subscription.required.subscribe') }}\n  </Button>\n</template>\n\n<script setup lang=\"ts\">\nimport { onBeforeUnmount, ref, watch } from 'vue'\n\nimport Button from '@/components/ui/button/Button.vue'\nimport { useSubscription } from '@/platform/cloud/subscription/composables/useSubscription'\nimport { isCloud } from '@/platform/distribution/types'\nimport { useTelemetry } from '@/platform/telemetry'\nimport { cn } from '@/utils/tailwindUtil'\n\nconst {\n  size = 'lg',\n  fluid = true,\n  variant = 'default',\n  label,\n  disabled = false\n} = defineProps<{\n  label?: string\n  size?: 'sm' | 'lg'\n  variant?: 'default' | 'gradient'\n  fluid?: boolean\n  disabled?: boolean\n}>()\n\nconst emit = defineEmits<{\n  subscribed: []\n}>()\n\nconst { subscribe, isActiveSubscription, fetchStatus, showSubscriptionDialog } =\n  useSubscription()\n\nconst telemetry = useTelemetry()\n\nconst isLoading = ref(false)\nconst isPolling = ref(false)\nlet pollInterval: number | null = null\nconst isAwaitingStripeSubscription = ref(false)\n\nconst POLL_INTERVAL_MS = 3000 // Poll every 3 seconds\nconst MAX_POLL_DURATION_MS = 5 * 60 * 1000 // Stop polling after 5 minutes\n\nconst startPollingSubscriptionStatus = () => {\n  isPolling.value = true\n  isLoading.value = true\n\n  const startTime = Date.now()\n\n  const poll = async () => {\n    try {\n      if (Date.now() - startTime > MAX_POLL_DURATION_MS) {\n        stopPolling()\n        return\n      }\n\n      await fetchStatus()\n\n      if (isActiveSubscription.value) {\n        stopPolling()\n        telemetry?.trackMonthlySubscriptionSucceeded()\n        emit('subscribed')\n      }\n    } catch (error) {\n      console.error(\n        '[SubscribeButton] Error polling subscription status:',\n        error\n      )\n    }\n  }\n\n  void poll()\n  pollInterval = window.setInterval(poll, POLL_INTERVAL_MS)\n}\n\nconst stopPolling = () => {\n  if (pollInterval) {\n    clearInterval(pollInterval)\n    pollInterval = null\n  }\n  isPolling.value = false\n  isLoading.value = false\n}\n\nwatch(\n  [isAwaitingStripeSubscription, isActiveSubscription],\n  ([awaiting, isActive]) => {\n    if (isCloud && awaiting && isActive) {\n      emit('subscribed')\n      isAwaitingStripeSubscription.value = false\n    }\n  }\n)\n\nconst handleSubscribe = async () => {\n  if (isCloud) {\n    useTelemetry()?.trackSubscription('subscribe_clicked')\n    isAwaitingStripeSubscription.value = true\n    showSubscriptionDialog()\n    return\n  }\n\n  isLoading.value = true\n  try {\n    await subscribe()\n\n    startPollingSubscriptionStatus()\n  } catch (error) {\n    console.error('[SubscribeButton] Error initiating subscription:', error)\n    isLoading.value = false\n  }\n}\n\nonBeforeUnmount(() => {\n  stopPolling()\n  isAwaitingStripeSubscription.value = false\n})\n</script>\n","<template>\n  <Button\n    :size\n    :loading=\"isLoading\"\n    :disabled=\"disabled || isPolling\"\n    variant=\"primary\"\n    :style=\"\n      variant === 'gradient'\n        ? {\n            background: 'var(--color-subscription-button-gradient)',\n            color: 'var(--color-white)'\n          }\n        : undefined\n    \"\n    :class=\"cn('font-bold', fluid && 'w-full')\"\n    @click=\"handleSubscribe\"\n  >\n    {{ label || $t('subscription.required.subscribe') }}\n  </Button>\n</template>\n\n<script setup lang=\"ts\">\nimport { onBeforeUnmount, ref, watch } from 'vue'\n\nimport Button from '@/components/ui/button/Button.vue'\nimport { useSubscription } from '@/platform/cloud/subscription/composables/useSubscription'\nimport { isCloud } from '@/platform/distribution/types'\nimport { useTelemetry } from '@/platform/telemetry'\nimport { cn } from '@/utils/tailwindUtil'\n\nconst {\n  size = 'lg',\n  fluid = true,\n  variant = 'default',\n  label,\n  disabled = false\n} = defineProps<{\n  label?: string\n  size?: 'sm' | 'lg'\n  variant?: 'default' | 'gradient'\n  fluid?: boolean\n  disabled?: boolean\n}>()\n\nconst emit = defineEmits<{\n  subscribed: []\n}>()\n\nconst { subscribe, isActiveSubscription, fetchStatus, showSubscriptionDialog } =\n  useSubscription()\n\nconst telemetry = useTelemetry()\n\nconst isLoading = ref(false)\nconst isPolling = ref(false)\nlet pollInterval: number | null = null\nconst isAwaitingStripeSubscription = ref(false)\n\nconst POLL_INTERVAL_MS = 3000 // Poll every 3 seconds\nconst MAX_POLL_DURATION_MS = 5 * 60 * 1000 // Stop polling after 5 minutes\n\nconst startPollingSubscriptionStatus = () => {\n  isPolling.value = true\n  isLoading.value = true\n\n  const startTime = Date.now()\n\n  const poll = async () => {\n    try {\n      if (Date.now() - startTime > MAX_POLL_DURATION_MS) {\n        stopPolling()\n        return\n      }\n\n      await fetchStatus()\n\n      if (isActiveSubscription.value) {\n        stopPolling()\n        telemetry?.trackMonthlySubscriptionSucceeded()\n        emit('subscribed')\n      }\n    } catch (error) {\n      console.error(\n        '[SubscribeButton] Error polling subscription status:',\n        error\n      )\n    }\n  }\n\n  void poll()\n  pollInterval = window.setInterval(poll, POLL_INTERVAL_MS)\n}\n\nconst stopPolling = () => {\n  if (pollInterval) {\n    clearInterval(pollInterval)\n    pollInterval = null\n  }\n  isPolling.value = false\n  isLoading.value = false\n}\n\nwatch(\n  [isAwaitingStripeSubscription, isActiveSubscription],\n  ([awaiting, isActive]) => {\n    if (isCloud && awaiting && isActive) {\n      emit('subscribed')\n      isAwaitingStripeSubscription.value = false\n    }\n  }\n)\n\nconst handleSubscribe = async () => {\n  if (isCloud) {\n    useTelemetry()?.trackSubscription('subscribe_clicked')\n    isAwaitingStripeSubscription.value = true\n    showSubscriptionDialog()\n    return\n  }\n\n  isLoading.value = true\n  try {\n    await subscribe()\n\n    startPollingSubscriptionStatus()\n  } catch (error) {\n    console.error('[SubscribeButton] Error initiating subscription:', error)\n    isLoading.value = false\n  }\n}\n\nonBeforeUnmount(() => {\n  stopPolling()\n  isAwaitingStripeSubscription.value = false\n})\n</script>\n"],"mappings":"scCwBmB,IACa,IACR,IACK,IACV,CA8Bb,EAAmB,IACnB,EAAuB,IAAS,6MAftC,IAAM,EAAO,EAIP,CAAE,YAAW,uBAAsB,cAAa,0BACpD,GAAgB,CAEZ,EAAY,GAAa,CAEzB,EAAY,EAAI,GAAK,CACrB,EAAY,EAAI,GAAK,CACvB,EAA8B,KAC5B,EAA+B,EAAI,GAAK,CAKxC,mCAAuC,CAC3C,EAAU,MAAQ,GAClB,EAAU,MAAQ,GAElB,IAAM,EAAY,KAAK,KAAI,CAErB,KAAO,SAAY,CACvB,GAAI,CACF,GAAI,KAAK,KAAK,CAAG,EAAY,EAAsB,CACjD,aAAY,CACZ,OAGF,MAAM,GAAY,CAEd,EAAqB,QACvB,aAAY,CACZ,GAAW,mCAAkC,CAC7C,EAAK,aAAY,QAEZ,EAAO,CACd,QAAQ,MACN,uDACA,EACF,GAIC,MAAK,CACV,EAAe,OAAO,YAAY,KAAM,EAAgB,EAGpD,gBAAoB,CACxB,AAEE,KADA,cAAc,EAAY,CACX,MAEjB,EAAU,MAAQ,GAClB,EAAU,MAAQ,IAGpB,EACE,CAAC,EAA8B,EAAqB,EACnD,CAAC,EAAU,KAAc,CACpB,GAAW,GAAY,IACzB,EAAK,aAAY,CACjB,EAA6B,MAAQ,KAG3C,CAEA,IAAM,gBAAkB,SAAY,CAClC,GAAI,EAAS,CACX,GAAc,EAAE,kBAAkB,oBAAmB,CACrD,EAA6B,MAAQ,GACrC,GAAuB,CACvB,OAGF,EAAU,MAAQ,GAClB,GAAI,CACF,MAAM,GAAU,CAEhB,gCAA+B,OACxB,EAAO,CACd,QAAQ,MAAM,mDAAoD,EAAK,CACvE,EAAU,MAAQ,YAItB,MAAsB,CACpB,aAAY,CACZ,EAA6B,MAAQ,IACtC"}