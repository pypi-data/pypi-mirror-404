{"version":3,"file":"LegacyCreditsPanel-DlfXUR2g.js","names":[],"sources":["../../src/components/common/UserCredit.vue","../../src/components/common/UserCredit.vue","../../src/services/customerEventsService.ts","../../src/components/dialog/content/setting/UsageLogsTable.vue","../../src/components/dialog/content/setting/UsageLogsTable.vue","../../src/components/dialog/content/setting/LegacyCreditsPanel.vue","../../src/components/dialog/content/setting/LegacyCreditsPanel.vue"],"sourcesContent":["<template>\n  <div v-if=\"balanceLoading\" class=\"flex items-center gap-1\">\n    <div class=\"flex items-center gap-2\">\n      <Skeleton shape=\"circle\" width=\"1.5rem\" height=\"1.5rem\" />\n    </div>\n    <div class=\"flex-1\"></div>\n    <Skeleton width=\"8rem\" height=\"2rem\" />\n  </div>\n  <div v-else class=\"flex items-center gap-1\">\n    <Tag\n      v-if=\"!showCreditsOnly\"\n      severity=\"secondary\"\n      rounded\n      class=\"p-1 text-amber-400\"\n    >\n      <template #icon>\n        <i class=\"icon-[lucide--component]\" />\n      </template>\n    </Tag>\n    <div :class=\"textClass\">\n      {{ showCreditsOnly ? formattedCreditsOnly : formattedBalance }}\n    </div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport Skeleton from 'primevue/skeleton'\nimport Tag from 'primevue/tag'\nimport { computed } from 'vue'\nimport { useI18n } from 'vue-i18n'\n\nimport { formatCreditsFromCents } from '@/base/credits/comfyCredits'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\n\nconst { textClass, showCreditsOnly } = defineProps<{\n  textClass?: string\n  showCreditsOnly?: boolean\n}>()\n\nconst authStore = useFirebaseAuthStore()\nconst balanceLoading = computed(() => authStore.isFetchingBalance)\nconst { t, locale } = useI18n()\n\nconst formattedBalance = computed(() => {\n  const cents =\n    authStore.balance?.effective_balance_micros ??\n    authStore.balance?.amount_micros ??\n    0\n  const amount = formatCreditsFromCents({\n    cents,\n    locale: locale.value\n  })\n  return `${amount} ${t('credits.credits')}`\n})\n\nconst formattedCreditsOnly = computed(() => {\n  const cents =\n    authStore.balance?.effective_balance_micros ??\n    authStore.balance?.amount_micros ??\n    0\n  const amount = formatCreditsFromCents({\n    cents,\n    locale: locale.value,\n    numberOptions: { minimumFractionDigits: 0, maximumFractionDigits: 0 }\n  })\n  return amount\n})\n</script>\n","<template>\n  <div v-if=\"balanceLoading\" class=\"flex items-center gap-1\">\n    <div class=\"flex items-center gap-2\">\n      <Skeleton shape=\"circle\" width=\"1.5rem\" height=\"1.5rem\" />\n    </div>\n    <div class=\"flex-1\"></div>\n    <Skeleton width=\"8rem\" height=\"2rem\" />\n  </div>\n  <div v-else class=\"flex items-center gap-1\">\n    <Tag\n      v-if=\"!showCreditsOnly\"\n      severity=\"secondary\"\n      rounded\n      class=\"p-1 text-amber-400\"\n    >\n      <template #icon>\n        <i class=\"icon-[lucide--component]\" />\n      </template>\n    </Tag>\n    <div :class=\"textClass\">\n      {{ showCreditsOnly ? formattedCreditsOnly : formattedBalance }}\n    </div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport Skeleton from 'primevue/skeleton'\nimport Tag from 'primevue/tag'\nimport { computed } from 'vue'\nimport { useI18n } from 'vue-i18n'\n\nimport { formatCreditsFromCents } from '@/base/credits/comfyCredits'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\n\nconst { textClass, showCreditsOnly } = defineProps<{\n  textClass?: string\n  showCreditsOnly?: boolean\n}>()\n\nconst authStore = useFirebaseAuthStore()\nconst balanceLoading = computed(() => authStore.isFetchingBalance)\nconst { t, locale } = useI18n()\n\nconst formattedBalance = computed(() => {\n  const cents =\n    authStore.balance?.effective_balance_micros ??\n    authStore.balance?.amount_micros ??\n    0\n  const amount = formatCreditsFromCents({\n    cents,\n    locale: locale.value\n  })\n  return `${amount} ${t('credits.credits')}`\n})\n\nconst formattedCreditsOnly = computed(() => {\n  const cents =\n    authStore.balance?.effective_balance_micros ??\n    authStore.balance?.amount_micros ??\n    0\n  const amount = formatCreditsFromCents({\n    cents,\n    locale: locale.value,\n    numberOptions: { minimumFractionDigits: 0, maximumFractionDigits: 0 }\n  })\n  return amount\n})\n</script>\n","import type { AxiosError, AxiosResponse } from 'axios'\nimport axios from 'axios'\nimport { ref, watch } from 'vue'\nimport { useI18n } from 'vue-i18n'\n\nimport { getComfyApiBaseUrl } from '@/config/comfyApi'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\nimport type { components, operations } from '@/types/comfyRegistryTypes'\nimport { isAbortError } from '@/utils/typeGuardUtil'\n\nexport enum EventType {\n  CREDIT_ADDED = 'credit_added',\n  ACCOUNT_CREATED = 'account_created',\n  API_USAGE_STARTED = 'api_usage_started',\n  API_USAGE_COMPLETED = 'api_usage_completed'\n}\n\ntype CustomerEventsResponse =\n  operations['GetCustomerEvents']['responses']['200']['content']['application/json']\n\ntype CustomerEventsResponseQuery =\n  operations['GetCustomerEvents']['parameters']['query']\n\nexport type AuditLog = components['schemas']['AuditLog']\n\nconst customerApiClient = axios.create({\n  baseURL: getComfyApiBaseUrl(),\n  headers: {\n    'Content-Type': 'application/json'\n  }\n})\n\nexport const useCustomerEventsService = () => {\n  const isLoading = ref(false)\n  const error = ref<string | null>(null)\n  const { d } = useI18n()\n\n  watch(\n    () => getComfyApiBaseUrl(),\n    (url) => {\n      customerApiClient.defaults.baseURL = url\n    }\n  )\n\n  const handleRequestError = (\n    err: unknown,\n    context: string,\n    routeSpecificErrors?: Record<number, string>\n  ) => {\n    // Don't treat cancellation as an error\n    if (isAbortError(err)) return\n\n    let message: string\n    if (!axios.isAxiosError(err)) {\n      message = `${context} failed: ${err instanceof Error ? err.message : String(err)}`\n    } else {\n      const axiosError = err as AxiosError<{ message: string }>\n      const status = axiosError.response?.status\n      if (status && routeSpecificErrors?.[status]) {\n        message = routeSpecificErrors[status]\n      } else {\n        message =\n          axiosError.response?.data?.message ??\n          `${context} failed with status ${status}`\n      }\n    }\n\n    error.value = message\n  }\n\n  const executeRequest = async <T>(\n    requestCall: () => Promise<AxiosResponse<T>>,\n    options: {\n      errorContext: string\n      routeSpecificErrors?: Record<number, string>\n    }\n  ): Promise<T | null> => {\n    const { errorContext, routeSpecificErrors } = options\n\n    isLoading.value = true\n    error.value = null\n\n    try {\n      const response = await requestCall()\n      return response.data\n    } catch (err) {\n      handleRequestError(err, errorContext, routeSpecificErrors)\n      return null\n    } finally {\n      isLoading.value = false\n    }\n  }\n\n  function formatEventType(eventType: string) {\n    switch (eventType) {\n      case 'credit_added':\n        return 'Credits Added'\n      case 'account_created':\n        return 'Account Created'\n      case 'api_usage_completed':\n        return 'API Usage'\n      default:\n        return eventType\n    }\n  }\n\n  function formatDate(dateString: string): string {\n    const date = new Date(dateString)\n\n    return d(date, {\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    })\n  }\n\n  function formatJsonKey(key: string) {\n    return key\n      .split('_')\n      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n      .join(' ')\n  }\n\n  function formatJsonValue(value: any) {\n    if (typeof value === 'number') {\n      // Format numbers with commas and decimals if needed\n      return value.toLocaleString()\n    }\n    if (typeof value === 'string' && value.match(/^\\d{4}-\\d{2}-\\d{2}/)) {\n      // Format dates nicely\n      return new Date(value).toLocaleString()\n    }\n    return value\n  }\n\n  function getEventSeverity(eventType: string) {\n    switch (eventType) {\n      case 'credit_added':\n        return 'success'\n      case 'account_created':\n        return 'info'\n      case 'api_usage_completed':\n        return 'warning'\n      default:\n        return 'info'\n    }\n  }\n\n  function hasAdditionalInfo(event: AuditLog) {\n    const { amount, api_name, model, ...otherParams } = event.params || {}\n    return Object.keys(otherParams).length > 0\n  }\n\n  function getTooltipContent(event: AuditLog) {\n    const { ...params } = event.params || {}\n\n    return Object.entries(params)\n      .map(([key, value]) => {\n        const formattedKey = formatJsonKey(key)\n        const formattedValue = formatJsonValue(value)\n        return `<strong>${formattedKey}:</strong> ${formattedValue}`\n      })\n      .join('<br>')\n  }\n\n  function formatAmount(amountMicros?: number) {\n    if (!amountMicros) return '0.00'\n    return (amountMicros / 100).toFixed(2)\n  }\n\n  async function getMyEvents({\n    page = 1,\n    limit = 10\n  }: CustomerEventsResponseQuery = {}): Promise<CustomerEventsResponse | null> {\n    const errorContext = 'Fetching customer events'\n    const routeSpecificErrors = {\n      400: 'Invalid input, object invalid',\n      404: 'Not found'\n    }\n\n    // Get auth headers\n    const authHeaders = await useFirebaseAuthStore().getAuthHeader()\n    if (!authHeaders) {\n      error.value = 'Authentication header is missing'\n      return null\n    }\n\n    const result = await executeRequest<CustomerEventsResponse>(\n      () =>\n        customerApiClient.get('/customers/events', {\n          params: { page, limit },\n          headers: authHeaders\n        }),\n      { errorContext, routeSpecificErrors }\n    )\n\n    return result\n  }\n\n  return {\n    // State\n    isLoading,\n    error,\n\n    // Methods\n    getMyEvents,\n    formatEventType,\n    getEventSeverity,\n    formatAmount,\n    hasAdditionalInfo,\n    formatDate,\n    formatJsonKey,\n    formatJsonValue,\n    getTooltipContent\n  }\n}\n","<template>\n  <div>\n    <div v-if=\"loading\" class=\"flex items-center justify-center p-8\">\n      <ProgressSpinner />\n    </div>\n    <div v-else-if=\"error\" class=\"p-4\">\n      <Message severity=\"error\" :closable=\"false\">{{ error }}</Message>\n    </div>\n    <DataTable\n      v-else\n      :value=\"events\"\n      :paginator=\"true\"\n      :rows=\"pagination.limit\"\n      :total-records=\"pagination.total\"\n      :first=\"dataTableFirst\"\n      :lazy=\"true\"\n      class=\"p-datatable-sm custom-datatable\"\n      @page=\"onPageChange\"\n    >\n      <Column field=\"event_type\" :header=\"$t('credits.eventType')\">\n        <template #body=\"{ data }\">\n          <Badge\n            :value=\"customerEventService.formatEventType(data.event_type)\"\n            :severity=\"customerEventService.getEventSeverity(data.event_type)\"\n          />\n        </template>\n      </Column>\n      <Column field=\"details\" :header=\"$t('credits.details')\">\n        <template #body=\"{ data }\">\n          <div class=\"event-details\">\n            <!-- Credits Added -->\n            <template v-if=\"data.event_type === EventType.CREDIT_ADDED\">\n              <div class=\"font-semibold text-green-500\">\n                {{ $t('credits.added') }} ${{\n                  customerEventService.formatAmount(data.params?.amount)\n                }}\n              </div>\n            </template>\n\n            <!-- Account Created -->\n            <template v-else-if=\"data.event_type === EventType.ACCOUNT_CREATED\">\n              <div>{{ $t('credits.accountInitialized') }}</div>\n            </template>\n\n            <!-- API Usage -->\n            <template\n              v-else-if=\"data.event_type === EventType.API_USAGE_COMPLETED\"\n            >\n              <div class=\"flex flex-col gap-1\">\n                <div class=\"font-semibold\">\n                  {{ data.params?.api_name || 'API' }}\n                </div>\n                <div class=\"text-sm text-smoke-400\">\n                  {{ $t('credits.model') }}: {{ data.params?.model || '-' }}\n                </div>\n              </div>\n            </template>\n          </div>\n        </template>\n      </Column>\n      <Column field=\"createdAt\" :header=\"$t('credits.time')\">\n        <template #body=\"{ data }\">\n          {{ customerEventService.formatDate(data.createdAt) }}\n        </template>\n      </Column>\n      <Column field=\"params\" :header=\"$t('credits.additionalInfo')\">\n        <template #body=\"{ data }\">\n          <Button\n            v-if=\"customerEventService.hasAdditionalInfo(data)\"\n            v-tooltip.top=\"{\n              escape: false,\n              value: tooltipContentMap.get(data.event_id) || '',\n              pt: {\n                text: {\n                  style: {\n                    width: 'max-content !important'\n                  }\n                }\n              }\n            }\"\n            variant=\"textonly\"\n            size=\"icon-sm\"\n            :aria-label=\"$t('credits.additionalInfo')\"\n          >\n            <i class=\"pi pi-info-circle\" />\n          </Button>\n        </template>\n      </Column>\n    </DataTable>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport Badge from 'primevue/badge'\nimport Column from 'primevue/column'\nimport DataTable from 'primevue/datatable'\nimport Message from 'primevue/message'\nimport ProgressSpinner from 'primevue/progressspinner'\nimport { computed, ref } from 'vue'\n\nimport Button from '@/components/ui/button/Button.vue'\nimport { useTelemetry } from '@/platform/telemetry'\nimport type { AuditLog } from '@/services/customerEventsService'\nimport {\n  EventType,\n  useCustomerEventsService\n} from '@/services/customerEventsService'\n\nconst events = ref<AuditLog[]>([])\nconst loading = ref(true)\nconst error = ref<string | null>(null)\n\nconst customerEventService = useCustomerEventsService()\n\nconst pagination = ref({\n  page: 1,\n  limit: 7,\n  total: 0,\n  totalPages: 0\n})\n\nconst dataTableFirst = computed(\n  () => (pagination.value.page - 1) * pagination.value.limit\n)\n\nconst tooltipContentMap = computed(() => {\n  const map = new Map<string, string>()\n  events.value.forEach((event) => {\n    if (customerEventService.hasAdditionalInfo(event) && event.event_id) {\n      map.set(event.event_id, customerEventService.getTooltipContent(event))\n    }\n  })\n  return map\n})\n\nconst loadEvents = async () => {\n  loading.value = true\n  error.value = null\n\n  try {\n    const response = await customerEventService.getMyEvents({\n      page: pagination.value.page,\n      limit: pagination.value.limit\n    })\n\n    if (response) {\n      if (response.events) {\n        events.value = response.events\n      }\n\n      if (response.page) {\n        pagination.value.page = response.page\n      }\n\n      if (response.limit) {\n        pagination.value.limit = response.limit\n      }\n\n      if (response.total) {\n        pagination.value.total = response.total\n      }\n\n      if (response.totalPages) {\n        pagination.value.totalPages = response.totalPages\n      }\n\n      // Check if a pending top-up has completed\n      useTelemetry()?.checkForCompletedTopup(response.events)\n    } else {\n      error.value = customerEventService.error.value || 'Failed to load events'\n    }\n  } catch (err) {\n    error.value = err instanceof Error ? err.message : 'Unknown error'\n    console.error('Error loading events:', err)\n  } finally {\n    loading.value = false\n  }\n}\n\nconst onPageChange = (event: { page: number }) => {\n  pagination.value.page = event.page + 1\n  loadEvents().catch((error) => {\n    console.error('Error loading events:', error)\n  })\n}\n\nconst refresh = async () => {\n  pagination.value.page = 1\n  await loadEvents()\n}\n\ndefineExpose({\n  refresh\n})\n</script>\n","<template>\n  <div>\n    <div v-if=\"loading\" class=\"flex items-center justify-center p-8\">\n      <ProgressSpinner />\n    </div>\n    <div v-else-if=\"error\" class=\"p-4\">\n      <Message severity=\"error\" :closable=\"false\">{{ error }}</Message>\n    </div>\n    <DataTable\n      v-else\n      :value=\"events\"\n      :paginator=\"true\"\n      :rows=\"pagination.limit\"\n      :total-records=\"pagination.total\"\n      :first=\"dataTableFirst\"\n      :lazy=\"true\"\n      class=\"p-datatable-sm custom-datatable\"\n      @page=\"onPageChange\"\n    >\n      <Column field=\"event_type\" :header=\"$t('credits.eventType')\">\n        <template #body=\"{ data }\">\n          <Badge\n            :value=\"customerEventService.formatEventType(data.event_type)\"\n            :severity=\"customerEventService.getEventSeverity(data.event_type)\"\n          />\n        </template>\n      </Column>\n      <Column field=\"details\" :header=\"$t('credits.details')\">\n        <template #body=\"{ data }\">\n          <div class=\"event-details\">\n            <!-- Credits Added -->\n            <template v-if=\"data.event_type === EventType.CREDIT_ADDED\">\n              <div class=\"font-semibold text-green-500\">\n                {{ $t('credits.added') }} ${{\n                  customerEventService.formatAmount(data.params?.amount)\n                }}\n              </div>\n            </template>\n\n            <!-- Account Created -->\n            <template v-else-if=\"data.event_type === EventType.ACCOUNT_CREATED\">\n              <div>{{ $t('credits.accountInitialized') }}</div>\n            </template>\n\n            <!-- API Usage -->\n            <template\n              v-else-if=\"data.event_type === EventType.API_USAGE_COMPLETED\"\n            >\n              <div class=\"flex flex-col gap-1\">\n                <div class=\"font-semibold\">\n                  {{ data.params?.api_name || 'API' }}\n                </div>\n                <div class=\"text-sm text-smoke-400\">\n                  {{ $t('credits.model') }}: {{ data.params?.model || '-' }}\n                </div>\n              </div>\n            </template>\n          </div>\n        </template>\n      </Column>\n      <Column field=\"createdAt\" :header=\"$t('credits.time')\">\n        <template #body=\"{ data }\">\n          {{ customerEventService.formatDate(data.createdAt) }}\n        </template>\n      </Column>\n      <Column field=\"params\" :header=\"$t('credits.additionalInfo')\">\n        <template #body=\"{ data }\">\n          <Button\n            v-if=\"customerEventService.hasAdditionalInfo(data)\"\n            v-tooltip.top=\"{\n              escape: false,\n              value: tooltipContentMap.get(data.event_id) || '',\n              pt: {\n                text: {\n                  style: {\n                    width: 'max-content !important'\n                  }\n                }\n              }\n            }\"\n            variant=\"textonly\"\n            size=\"icon-sm\"\n            :aria-label=\"$t('credits.additionalInfo')\"\n          >\n            <i class=\"pi pi-info-circle\" />\n          </Button>\n        </template>\n      </Column>\n    </DataTable>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport Badge from 'primevue/badge'\nimport Column from 'primevue/column'\nimport DataTable from 'primevue/datatable'\nimport Message from 'primevue/message'\nimport ProgressSpinner from 'primevue/progressspinner'\nimport { computed, ref } from 'vue'\n\nimport Button from '@/components/ui/button/Button.vue'\nimport { useTelemetry } from '@/platform/telemetry'\nimport type { AuditLog } from '@/services/customerEventsService'\nimport {\n  EventType,\n  useCustomerEventsService\n} from '@/services/customerEventsService'\n\nconst events = ref<AuditLog[]>([])\nconst loading = ref(true)\nconst error = ref<string | null>(null)\n\nconst customerEventService = useCustomerEventsService()\n\nconst pagination = ref({\n  page: 1,\n  limit: 7,\n  total: 0,\n  totalPages: 0\n})\n\nconst dataTableFirst = computed(\n  () => (pagination.value.page - 1) * pagination.value.limit\n)\n\nconst tooltipContentMap = computed(() => {\n  const map = new Map<string, string>()\n  events.value.forEach((event) => {\n    if (customerEventService.hasAdditionalInfo(event) && event.event_id) {\n      map.set(event.event_id, customerEventService.getTooltipContent(event))\n    }\n  })\n  return map\n})\n\nconst loadEvents = async () => {\n  loading.value = true\n  error.value = null\n\n  try {\n    const response = await customerEventService.getMyEvents({\n      page: pagination.value.page,\n      limit: pagination.value.limit\n    })\n\n    if (response) {\n      if (response.events) {\n        events.value = response.events\n      }\n\n      if (response.page) {\n        pagination.value.page = response.page\n      }\n\n      if (response.limit) {\n        pagination.value.limit = response.limit\n      }\n\n      if (response.total) {\n        pagination.value.total = response.total\n      }\n\n      if (response.totalPages) {\n        pagination.value.totalPages = response.totalPages\n      }\n\n      // Check if a pending top-up has completed\n      useTelemetry()?.checkForCompletedTopup(response.events)\n    } else {\n      error.value = customerEventService.error.value || 'Failed to load events'\n    }\n  } catch (err) {\n    error.value = err instanceof Error ? err.message : 'Unknown error'\n    console.error('Error loading events:', err)\n  } finally {\n    loading.value = false\n  }\n}\n\nconst onPageChange = (event: { page: number }) => {\n  pagination.value.page = event.page + 1\n  loadEvents().catch((error) => {\n    console.error('Error loading events:', error)\n  })\n}\n\nconst refresh = async () => {\n  pagination.value.page = 1\n  await loadEvents()\n}\n\ndefineExpose({\n  refresh\n})\n</script>\n","<template>\n  <TabPanel value=\"Credits\" class=\"credits-container h-full\">\n    <!-- Legacy Design -->\n    <div class=\"flex h-full flex-col\">\n      <h2 class=\"mb-2 text-2xl font-bold\">\n        {{ $t('credits.credits') }}\n      </h2>\n\n      <Divider />\n\n      <div class=\"flex flex-col gap-2\">\n        <h3 class=\"text-sm font-medium text-muted\">\n          {{ $t('credits.yourCreditBalance') }}\n        </h3>\n        <div class=\"flex items-center justify-between\">\n          <UserCredit text-class=\"text-3xl font-bold\" />\n          <Skeleton v-if=\"loading\" width=\"2rem\" height=\"2rem\" />\n          <Button\n            v-else-if=\"isActiveSubscription\"\n            :loading=\"loading\"\n            @click=\"handlePurchaseCreditsClick\"\n          >\n            {{ $t('credits.purchaseCredits') }}\n          </Button>\n        </div>\n        <div class=\"flex flex-row items-center\">\n          <Skeleton\n            v-if=\"balanceLoading\"\n            width=\"12rem\"\n            height=\"1rem\"\n            class=\"text-xs\"\n          />\n          <div v-else-if=\"formattedLastUpdateTime\" class=\"text-xs text-muted\">\n            {{ $t('credits.lastUpdated') }}: {{ formattedLastUpdateTime }}\n          </div>\n          <Button\n            variant=\"muted-textonly\"\n            size=\"icon-sm\"\n            :aria-label=\"$t('g.refresh')\"\n            @click=\"() => authActions.fetchBalance()\"\n          >\n            <i class=\"pi pi-refresh\" />\n          </Button>\n        </div>\n      </div>\n\n      <div class=\"flex items-center justify-between\">\n        <h3>{{ $t('credits.activity') }}</h3>\n        <Button\n          variant=\"muted-textonly\"\n          :loading=\"loading\"\n          @click=\"handleCreditsHistoryClick\"\n        >\n          <i class=\"pi pi-arrow-up-right\" />\n          {{ $t('credits.invoiceHistory') }}\n        </Button>\n      </div>\n\n      <template v-if=\"creditHistory.length > 0\">\n        <div class=\"grow\">\n          <DataTable :value=\"creditHistory\" :show-headers=\"false\">\n            <Column field=\"title\" :header=\"$t('g.name')\">\n              <template #body=\"{ data }\">\n                <div class=\"text-sm font-medium\">{{ data.title }}</div>\n                <div class=\"text-xs text-muted\">{{ data.timestamp }}</div>\n              </template>\n            </Column>\n            <Column field=\"amount\" :header=\"$t('g.amount')\">\n              <template #body=\"{ data }\">\n                <div\n                  :class=\"[\n                    'text-center text-base font-medium',\n                    data.isPositive ? 'text-sky-500' : 'text-red-400'\n                  ]\"\n                >\n                  {{ data.isPositive ? '+' : '-' }}${{\n                    formatMetronomeCurrency(data.amount, 'usd')\n                  }}\n                </div>\n              </template>\n            </Column>\n          </DataTable>\n        </div>\n      </template>\n\n      <Divider />\n\n      <UsageLogsTable ref=\"usageLogsTableRef\" />\n\n      <div class=\"flex flex-row gap-2\">\n        <Button variant=\"muted-textonly\" @click=\"handleFaqClick\">\n          <i class=\"pi pi-question-circle\" />\n          {{ $t('credits.faqs') }}\n        </Button>\n        <Button variant=\"muted-textonly\" @click=\"handleOpenPartnerNodesInfo\">\n          <i class=\"pi pi-question-circle\" />\n          {{ $t('subscription.partnerNodesCredits') }}\n        </Button>\n        <Button variant=\"muted-textonly\" @click=\"handleMessageSupport\">\n          <i class=\"pi pi-comments\" />\n          {{ $t('credits.messageSupport') }}\n        </Button>\n      </div>\n    </div>\n  </TabPanel>\n</template>\n\n<script setup lang=\"ts\">\nimport Column from 'primevue/column'\nimport DataTable from 'primevue/datatable'\nimport Divider from 'primevue/divider'\nimport Skeleton from 'primevue/skeleton'\nimport TabPanel from 'primevue/tabpanel'\nimport { computed, ref, watch } from 'vue'\n\nimport UserCredit from '@/components/common/UserCredit.vue'\nimport UsageLogsTable from '@/components/dialog/content/setting/UsageLogsTable.vue'\nimport Button from '@/components/ui/button/Button.vue'\nimport { useFirebaseAuthActions } from '@/composables/auth/useFirebaseAuthActions'\nimport { useExternalLink } from '@/composables/useExternalLink'\nimport { useSubscription } from '@/platform/cloud/subscription/composables/useSubscription'\nimport { useTelemetry } from '@/platform/telemetry'\nimport { useDialogService } from '@/services/dialogService'\nimport { useCommandStore } from '@/stores/commandStore'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\nimport { formatMetronomeCurrency } from '@/utils/formatUtil'\n\ninterface CreditHistoryItemData {\n  title: string\n  timestamp: string\n  amount: number\n  isPositive: boolean\n}\n\nconst { buildDocsUrl, docsPaths } = useExternalLink()\nconst dialogService = useDialogService()\nconst authStore = useFirebaseAuthStore()\nconst authActions = useFirebaseAuthActions()\nconst commandStore = useCommandStore()\nconst telemetry = useTelemetry()\nconst { isActiveSubscription } = useSubscription()\nconst loading = computed(() => authStore.loading)\nconst balanceLoading = computed(() => authStore.isFetchingBalance)\n\nconst usageLogsTableRef = ref<InstanceType<typeof UsageLogsTable> | null>(null)\n\nconst formattedLastUpdateTime = computed(() =>\n  authStore.lastBalanceUpdateTime\n    ? authStore.lastBalanceUpdateTime.toLocaleString()\n    : ''\n)\n\nwatch(\n  () => authStore.lastBalanceUpdateTime,\n  (newTime, oldTime) => {\n    if (newTime && newTime !== oldTime && usageLogsTableRef.value) {\n      usageLogsTableRef.value.refresh()\n    }\n  }\n)\n\nconst handlePurchaseCreditsClick = () => {\n  // Track purchase credits entry from Settings > Credits panel\n  useTelemetry()?.trackAddApiCreditButtonClicked()\n  dialogService.showTopUpCreditsDialog()\n}\n\nconst handleCreditsHistoryClick = async () => {\n  await authActions.accessBillingPortal()\n}\n\nconst handleMessageSupport = async () => {\n  telemetry?.trackHelpResourceClicked({\n    resource_type: 'help_feedback',\n    is_external: true,\n    source: 'credits_panel'\n  })\n  await commandStore.execute('Comfy.ContactSupport')\n}\n\nconst handleFaqClick = () => {\n  window.open(\n    buildDocsUrl('/tutorials/api-nodes/faq', { includeLocale: true }),\n    '_blank'\n  )\n}\n\nconst handleOpenPartnerNodesInfo = () => {\n  window.open(\n    buildDocsUrl(docsPaths.partnerNodesPricing, { includeLocale: true }),\n    '_blank'\n  )\n}\n\nconst creditHistory = ref<CreditHistoryItemData[]>([])\n</script>\n","<template>\n  <TabPanel value=\"Credits\" class=\"credits-container h-full\">\n    <!-- Legacy Design -->\n    <div class=\"flex h-full flex-col\">\n      <h2 class=\"mb-2 text-2xl font-bold\">\n        {{ $t('credits.credits') }}\n      </h2>\n\n      <Divider />\n\n      <div class=\"flex flex-col gap-2\">\n        <h3 class=\"text-sm font-medium text-muted\">\n          {{ $t('credits.yourCreditBalance') }}\n        </h3>\n        <div class=\"flex items-center justify-between\">\n          <UserCredit text-class=\"text-3xl font-bold\" />\n          <Skeleton v-if=\"loading\" width=\"2rem\" height=\"2rem\" />\n          <Button\n            v-else-if=\"isActiveSubscription\"\n            :loading=\"loading\"\n            @click=\"handlePurchaseCreditsClick\"\n          >\n            {{ $t('credits.purchaseCredits') }}\n          </Button>\n        </div>\n        <div class=\"flex flex-row items-center\">\n          <Skeleton\n            v-if=\"balanceLoading\"\n            width=\"12rem\"\n            height=\"1rem\"\n            class=\"text-xs\"\n          />\n          <div v-else-if=\"formattedLastUpdateTime\" class=\"text-xs text-muted\">\n            {{ $t('credits.lastUpdated') }}: {{ formattedLastUpdateTime }}\n          </div>\n          <Button\n            variant=\"muted-textonly\"\n            size=\"icon-sm\"\n            :aria-label=\"$t('g.refresh')\"\n            @click=\"() => authActions.fetchBalance()\"\n          >\n            <i class=\"pi pi-refresh\" />\n          </Button>\n        </div>\n      </div>\n\n      <div class=\"flex items-center justify-between\">\n        <h3>{{ $t('credits.activity') }}</h3>\n        <Button\n          variant=\"muted-textonly\"\n          :loading=\"loading\"\n          @click=\"handleCreditsHistoryClick\"\n        >\n          <i class=\"pi pi-arrow-up-right\" />\n          {{ $t('credits.invoiceHistory') }}\n        </Button>\n      </div>\n\n      <template v-if=\"creditHistory.length > 0\">\n        <div class=\"grow\">\n          <DataTable :value=\"creditHistory\" :show-headers=\"false\">\n            <Column field=\"title\" :header=\"$t('g.name')\">\n              <template #body=\"{ data }\">\n                <div class=\"text-sm font-medium\">{{ data.title }}</div>\n                <div class=\"text-xs text-muted\">{{ data.timestamp }}</div>\n              </template>\n            </Column>\n            <Column field=\"amount\" :header=\"$t('g.amount')\">\n              <template #body=\"{ data }\">\n                <div\n                  :class=\"[\n                    'text-center text-base font-medium',\n                    data.isPositive ? 'text-sky-500' : 'text-red-400'\n                  ]\"\n                >\n                  {{ data.isPositive ? '+' : '-' }}${{\n                    formatMetronomeCurrency(data.amount, 'usd')\n                  }}\n                </div>\n              </template>\n            </Column>\n          </DataTable>\n        </div>\n      </template>\n\n      <Divider />\n\n      <UsageLogsTable ref=\"usageLogsTableRef\" />\n\n      <div class=\"flex flex-row gap-2\">\n        <Button variant=\"muted-textonly\" @click=\"handleFaqClick\">\n          <i class=\"pi pi-question-circle\" />\n          {{ $t('credits.faqs') }}\n        </Button>\n        <Button variant=\"muted-textonly\" @click=\"handleOpenPartnerNodesInfo\">\n          <i class=\"pi pi-question-circle\" />\n          {{ $t('subscription.partnerNodesCredits') }}\n        </Button>\n        <Button variant=\"muted-textonly\" @click=\"handleMessageSupport\">\n          <i class=\"pi pi-comments\" />\n          {{ $t('credits.messageSupport') }}\n        </Button>\n      </div>\n    </div>\n  </TabPanel>\n</template>\n\n<script setup lang=\"ts\">\nimport Column from 'primevue/column'\nimport DataTable from 'primevue/datatable'\nimport Divider from 'primevue/divider'\nimport Skeleton from 'primevue/skeleton'\nimport TabPanel from 'primevue/tabpanel'\nimport { computed, ref, watch } from 'vue'\n\nimport UserCredit from '@/components/common/UserCredit.vue'\nimport UsageLogsTable from '@/components/dialog/content/setting/UsageLogsTable.vue'\nimport Button from '@/components/ui/button/Button.vue'\nimport { useFirebaseAuthActions } from '@/composables/auth/useFirebaseAuthActions'\nimport { useExternalLink } from '@/composables/useExternalLink'\nimport { useSubscription } from '@/platform/cloud/subscription/composables/useSubscription'\nimport { useTelemetry } from '@/platform/telemetry'\nimport { useDialogService } from '@/services/dialogService'\nimport { useCommandStore } from '@/stores/commandStore'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\nimport { formatMetronomeCurrency } from '@/utils/formatUtil'\n\ninterface CreditHistoryItemData {\n  title: string\n  timestamp: string\n  amount: number\n  isPositive: boolean\n}\n\nconst { buildDocsUrl, docsPaths } = useExternalLink()\nconst dialogService = useDialogService()\nconst authStore = useFirebaseAuthStore()\nconst authActions = useFirebaseAuthActions()\nconst commandStore = useCommandStore()\nconst telemetry = useTelemetry()\nconst { isActiveSubscription } = useSubscription()\nconst loading = computed(() => authStore.loading)\nconst balanceLoading = computed(() => authStore.isFetchingBalance)\n\nconst usageLogsTableRef = ref<InstanceType<typeof UsageLogsTable> | null>(null)\n\nconst formattedLastUpdateTime = computed(() =>\n  authStore.lastBalanceUpdateTime\n    ? authStore.lastBalanceUpdateTime.toLocaleString()\n    : ''\n)\n\nwatch(\n  () => authStore.lastBalanceUpdateTime,\n  (newTime, oldTime) => {\n    if (newTime && newTime !== oldTime && usageLogsTableRef.value) {\n      usageLogsTableRef.value.refresh()\n    }\n  }\n)\n\nconst handlePurchaseCreditsClick = () => {\n  // Track purchase credits entry from Settings > Credits panel\n  useTelemetry()?.trackAddApiCreditButtonClicked()\n  dialogService.showTopUpCreditsDialog()\n}\n\nconst handleCreditsHistoryClick = async () => {\n  await authActions.accessBillingPortal()\n}\n\nconst handleMessageSupport = async () => {\n  telemetry?.trackHelpResourceClicked({\n    resource_type: 'help_feedback',\n    is_external: true,\n    source: 'credits_panel'\n  })\n  await commandStore.execute('Comfy.ContactSupport')\n}\n\nconst handleFaqClick = () => {\n  window.open(\n    buildDocsUrl('/tutorials/api-nodes/faq', { includeLocale: true }),\n    '_blank'\n  )\n}\n\nconst handleOpenPartnerNodesInfo = () => {\n  window.open(\n    buildDocsUrl(docsPaths.partnerNodesPricing, { includeLocale: true }),\n    '_blank'\n  )\n}\n\nconst creditHistory = ref<CreditHistoryItemData[]>([])\n</script>\n"],"mappings":"u0BC0BqB,IACL,IAEQ,KAEe,IACF,+MAOrC,IAAM,EAAY,GAAqB,CACjC,EAAiB,MAAe,EAAU,kBAAiB,CAC3D,CAAE,IAAG,UAAW,GAAQ,CAExB,EAAmB,MAShB,GAJQ,EAAuB,CACpC,MAJA,EAAU,SAAS,0BACnB,EAAU,SAAS,eACnB,EAGA,OAAQ,EAAO,MAChB,CAAA,CACgB,GAAG,EAAE,kBAAkB,GACzC,CAEK,EAAuB,MAKZ,EAAuB,CACpC,MAJA,EAAU,SAAS,0BACnB,EAAU,SAAS,eACnB,EAGA,OAAQ,EAAO,MACf,cAAe,CAAE,sBAAuB,EAAG,sBAAuB,GACnE,CAAA,CAEF,6hBCjEiB,IACS,IACH,KAEW,IACE,KAER,CAEjB,EAAA,SAAA,EAAL,OACL,GAAA,aAAA,eACA,EAAA,gBAAA,kBACA,EAAA,kBAAA,oBACA,EAAA,oBAAA,6BAWI,EAAoB,EAAM,OAAO,CACrC,QAAS,GAAoB,CAC7B,QAAS,CACP,eAAgB,mBACjB,CACF,CAAC,CAEW,6BAAiC,CAC5C,IAAM,EAAY,EAAI,GAAM,CACtB,EAAQ,EAAmB,KAAK,CAChC,CAAE,KAAM,GAAS,CAEvB,MACQ,GAAoB,CACzB,GAAQ,CACP,EAAkB,SAAS,QAAU,GAExC,CAED,IAAM,oBACJ,EACA,EACA,IACG,CAEH,GAAI,GAAa,EAAI,CAAE,OAEvB,IAAI,EACJ,GAAI,CAAC,EAAM,aAAa,EAAI,CAC1B,EAAU,GAAG,EAAQ,WAAW,aAAe,MAAQ,EAAI,QAAU,OAAO,EAAI,OAC3E,CACL,IAAM,EAAa,EACb,EAAS,EAAW,UAAU,OACpC,AAGE,EAHE,GAAU,IAAsB,GACxB,EAAoB,GAG5B,EAAW,UAAU,MAAM,SAC3B,GAAG,EAAQ,sBAAsB,IAIvC,EAAM,MAAQ,GAGV,eAAiB,MACrB,EACA,IAIsB,CACtB,GAAM,CAAE,eAAc,uBAAwB,EAE9C,EAAU,MAAQ,GAClB,EAAM,MAAQ,KAEd,GAAI,CAEF,OADiB,MAAM,GAAa,EACpB,WACT,EAAK,CAEZ,OADA,mBAAmB,EAAK,EAAc,EAAoB,CACnD,YACC,CACR,EAAU,MAAQ,KAItB,SAAS,gBAAgB,EAAmB,CAC1C,OAAQ,EAAR,CACE,IAAK,eACH,MAAO,gBACT,IAAK,kBACH,MAAO,kBACT,IAAK,sBACH,MAAO,YACT,QACE,OAAO,GAIb,SAAS,WAAW,EAA4B,CAG9C,OAAO,EAFM,IAAI,KAAK,EAAW,CAElB,CACb,MAAO,QACP,IAAK,UACL,KAAM,UACN,OAAQ,UACT,CAAC,CAGJ,SAAS,cAAc,EAAa,CAClC,OAAO,EACJ,MAAM,IAAI,CACV,IAAK,GAAS,EAAK,OAAO,EAAE,CAAC,aAAa,CAAG,EAAK,MAAM,EAAE,CAAC,CAC3D,KAAK,IAAI,CAGd,SAAS,gBAAgB,EAAY,CASnC,OARI,OAAO,GAAU,SAEZ,EAAM,gBAAgB,CAE3B,OAAO,GAAU,UAAY,EAAM,MAAM,qBAAqB,CAEzD,IAAI,KAAK,EAAM,CAAC,gBAAgB,CAElC,EAGT,SAAS,iBAAiB,EAAmB,CAC3C,OAAQ,EAAR,CACE,IAAK,eACH,MAAO,UACT,IAAK,kBACH,MAAO,OACT,IAAK,sBACH,MAAO,UACT,QACE,MAAO,QAIb,SAAS,kBAAkB,EAAiB,CAC1C,GAAM,CAAE,SAAQ,WAAU,QAAO,GAAG,GAAgB,EAAM,QAAU,EAAE,CACtE,OAAO,OAAO,KAAK,EAAY,CAAC,OAAS,EAG3C,SAAS,kBAAkB,EAAiB,CAC1C,GAAM,CAAE,GAAG,GAAW,EAAM,QAAU,EAAE,CAExC,OAAO,OAAO,QAAQ,EAAO,CAC1B,KAAK,CAAC,EAAK,KAGH,WAFc,cAAc,EAAI,CAER,aADR,gBAAgB,EAAM,GAE7C,CACD,KAAK,OAAO,CAGjB,SAAS,aAAa,EAAuB,CAE3C,OADK,GACG,EAAe,KAAK,QAAQ,EAAE,CADZ,OAI5B,eAAe,YAAY,CACzB,OAAO,EACP,QAAQ,IACuB,EAAE,CAA0C,CAC3E,IACM,EAAsB,CAC1B,IAAK,gCACL,IAAK,YACN,CAGK,EAAc,MAAM,GAAsB,CAAC,eAAe,CAehE,OAdK,EAKU,MAAM,mBAEjB,EAAkB,IAAI,oBAAqB,CACzC,OAAQ,CAAE,OAAM,QAAO,CACvB,QAAS,EACV,CAAC,CACJ,CAAE,wCAAc,sBAAqB,CACtC,EAXC,EAAM,MAAQ,mCACP,MAeX,MAAO,CAEL,YACA,QAGA,YACA,gBACA,iBACA,aACA,kBACA,WACA,cACA,gBACA,kBACD,kDE1He,IACC,IACG,IACF,IACQ,IAGT,IACU,KAKtB,6TAEP,IAAM,EAAS,EAAgB,EAAE,CAAA,CAC3B,EAAU,EAAI,GAAI,CAClB,EAAQ,EAAmB,KAAI,CAE/B,EAAuB,0BAAyB,CAEhD,EAAa,EAAI,CACrB,KAAM,EACN,MAAO,EACP,MAAO,EACP,WAAY,EACb,CAAA,CAEK,EAAiB,OACd,EAAW,MAAM,KAAO,GAAK,EAAW,MAAM,MACvD,CAEM,EAAoB,MAAe,CACvC,IAAM,EAAM,IAAI,IAMhB,OALA,EAAO,MAAM,QAAS,GAAU,CAC1B,EAAqB,kBAAkB,EAAM,EAAI,EAAM,UACzD,EAAI,IAAI,EAAM,SAAU,EAAqB,kBAAkB,EAAM,CAAA,EAExE,CACM,GACR,CAEK,WAAa,SAAY,CAC7B,EAAQ,MAAQ,GAChB,EAAM,MAAQ,KAEd,GAAI,CACF,IAAM,EAAW,MAAM,EAAqB,YAAY,CACtD,KAAM,EAAW,MAAM,KACvB,MAAO,EAAW,MAAM,MACzB,CAAA,CAEG,GACE,EAAS,SACX,EAAO,MAAQ,EAAS,QAGtB,EAAS,OACX,EAAW,MAAM,KAAO,EAAS,MAG/B,EAAS,QACX,EAAW,MAAM,MAAQ,EAAS,OAGhC,EAAS,QACX,EAAW,MAAM,MAAQ,EAAS,OAGhC,EAAS,aACX,EAAW,MAAM,WAAa,EAAS,YAIzC,GAAc,EAAE,uBAAuB,EAAS,OAAM,EAEtD,EAAM,MAAQ,EAAqB,MAAM,OAAS,8BAE7C,EAAK,CACZ,EAAM,MAAQ,aAAe,MAAQ,EAAI,QAAU,gBACnD,QAAQ,MAAM,wBAAyB,EAAG,QAClC,CACR,EAAQ,MAAQ,KAId,aAAgB,GAA4B,CAChD,EAAW,MAAM,KAAO,EAAM,KAAO,EACrC,YAAY,CAAC,MAAO,GAAU,CAC5B,QAAQ,MAAM,wBAAyB,EAAK,EAC7C,EAGG,QAAU,SAAY,CAC1B,EAAW,MAAM,KAAO,EACxB,MAAM,YAAW,SAGnB,EAAa,CACX,QACD,CAAA,q0DErFkB,IACG,IACF,IACC,IACA,KAGE,KACI,IACR,KACoB,KACP,KACA,IACH,KACI,KACD,IACK,KACG,qeASxC,GAAM,CAAE,eAAc,aAAc,IAAgB,CAC9C,EAAgB,IAAiB,CACjC,EAAY,GAAqB,CACjC,EAAc,IAAuB,CACrC,EAAe,IAAgB,CAC/B,EAAY,GAAa,CACzB,CAAE,wBAAyB,IAAgB,CAC3C,EAAU,MAAe,EAAU,QAAO,CAC1C,EAAiB,MAAe,EAAU,kBAAiB,CAE3D,EAAoB,EAAgD,KAAI,CAExE,EAA0B,MAC9B,EAAU,sBACN,EAAU,sBAAsB,gBAAe,CAC/C,GACN,CAEA,MACQ,EAAU,uBACf,EAAS,IAAY,CAChB,GAAW,IAAY,GAAW,EAAkB,OACtD,EAAkB,MAAM,SAAQ,EAGtC,CAEA,IAAM,+BAAmC,CAEvC,GAAc,EAAE,gCAA+B,CAC/C,EAAc,wBAAuB,EAGjC,0BAA4B,SAAY,CAC5C,MAAM,EAAY,qBAAoB,EAGlC,qBAAuB,SAAY,CACvC,GAAW,yBAAyB,CAClC,cAAe,gBACf,YAAa,GACb,OAAQ,gBACT,CAAA,CACD,MAAM,EAAa,QAAQ,uBAAsB,EAG7C,mBAAuB,CAC3B,OAAO,KACL,EAAa,2BAA4B,CAAE,cAAe,GAAM,CAAC,CACjE,SACF,EAGI,+BAAmC,CACvC,OAAO,KACL,EAAa,EAAU,oBAAqB,CAAE,cAAe,GAAM,CAAC,CACpE,SACF,EAGI,EAAgB,EAA6B,EAAE,CAAA"}