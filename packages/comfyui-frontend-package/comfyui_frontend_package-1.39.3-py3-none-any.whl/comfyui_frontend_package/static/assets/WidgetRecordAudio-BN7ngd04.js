import{i as e,n as t}from"./rolldown-runtime-BKYq3fBv.js";import{$n as n,Cr as r,Gn as i,Gr as a,Mr as o,Nn as s,Rr as c,Tr as l,Xn as u,Xr as d,Xt as ee,Zn as f,ai as p,ar as m,br as te,c as h,er as g,gr as _,ir as ne,li as re,mr as v,sr as y,ui as b,xr as x}from"./vendor-primevue-Cg-HmKZY.js";import{Qn as ie,fn as S,i as C,r as w}from"./vendor-other-CoxDvJ0a.js";import{in as T,rn as E}from"./api-CJ30itpV.js";import{r as D,s as O}from"./i18n-gOSvTADh.js";import{at as k,it as A}from"./dialogService-DvYmp2_F.js";import{r as j,t as ae}from"./audioUtils-D6gqopTc.js";import{n as M,t as N}from"./audioService-BaXZa7El.js";function render(e,t){return r(),g(`svg`,P,[...t[0]||=[f(`g`,{fill:`none`,stroke:`currentColor`,"stroke-linecap":`round`,"stroke-linejoin":`round`,"stroke-width":`2`},[f(`path`,{d:`M12 19v3m7-12v2a7 7 0 0 1-14 0v-2`}),f(`rect`,{width:`6`,height:`13`,x:`9`,y:`2`,rx:`3`})],-1)]])}var P,F,I=t((()=>{s(),P={viewBox:`0 0 24 24`,width:`1.2em`,height:`1.2em`},F=a({name:`lucide-mic`,render})}));function useAudioPlayback(e,t={}){let n=d(!1),r=d(0),i=d(null);async function play(){if(!e.value)return!1;try{return await e.value.play(),n.value=!0,!0}catch(e){return console.warn(`Audio playback failed:`,e),n.value=!1,!1}}function stop(){e.value&&(e.value.pause(),e.value.currentTime=0),n.value=!1,t.onPlaybackEnded&&t.onPlaybackEnded()}function onPlaybackEnded(){n.value=!1,t.onPlaybackEnded&&t.onPlaybackEnded()}function onMetadataLoaded(){e.value?.duration&&t.onMetadataLoaded&&t.onMetadataLoaded(e.value.duration)}async function resetAudioElement(){r.value+=1,await _()}function getCurrentTime(){return e.value?.currentTime||0}function getDuration(){return e.value?.duration||0}return{isPlaying:n,audioElementKey:r,play,stop,onPlaybackEnded,onMetadataLoaded,resetAudioElement,getCurrentTime,getDuration,playbackTimerInterval:i}}var L=t((()=>{s()}));function useAudioRecorder(e={}){let t=d(!1),n=d(null),r=d([]),i=d(null),a=d(null);async function startRecording(){try{a.value?.startsWith(`blob:`)&&URL.revokeObjectURL(a.value),r.value=[],a.value=null,await M().registerWavEncoder(),i.value=await navigator.mediaDevices.getUserMedia({audio:!0}),n.value=new C(i.value,{mimeType:`audio/wav`}),n.value.ondataavailable=e=>{r.value.push(e.data)},n.value.onstop=async()=>{let t=new Blob(r.value,{type:`audio/wav`});a.value?.startsWith(`blob:`)&&URL.revokeObjectURL(a.value),a.value=URL.createObjectURL(t),e.onRecordingComplete&&await e.onRecordingComplete(t),cleanup()},n.value.start(100),t.value=!0}catch(t){throw e.onError&&e.onError(t),t}}function stopRecording(){n.value&&n.value.state!==`inactive`?n.value.stop():cleanup()}function cleanup(){t.value=!1,i.value&&=(i.value.getTracks().forEach(e=>e.stop()),null)}function dispose(){stopRecording(),a.value&&=(URL.revokeObjectURL(a.value),null)}return x(()=>{dispose()}),{isRecording:t,recordedURL:a,mediaRecorder:n,startRecording,stopRecording,dispose}}var R=t((()=>{w(),s(),N()}));function useAudioWaveform(e={}){let{barCount:t=18,minHeight:n=4,maxHeight:r=32}=e,i=d(Array.from({length:t},()=>({height:16}))),a=d(null),o=d(null),s=d(null),c=d(null),l=d(null);function initWaveform(){i.value=Array.from({length:t},()=>({height:Math.random()*(r-n)+n}))}function updateWaveform(e){e.value&&(o.value&&s.value?updateWaveformFromAudio():updateWaveformRandom(),c.value=requestAnimationFrame(()=>updateWaveform(e)))}function updateWaveformFromAudio(){if(!o.value||!s.value)return;o.value.getByteFrequencyData(s.value);let e=Math.floor(s.value.length/t);i.value=i.value.map((t,i)=>{let a=0;for(let t=0;t<e;t++)a+=s.value[i*e+t]||0;return{height:a/e/255*(r-n)+n}})}function updateWaveformRandom(){i.value=i.value.map(e=>({height:Math.max(n,Math.min(r,e.height+(Math.random()-.5)*4))}))}async function setupAudioContext(){a.value&&a.value.state!==`closed`&&await a.value.close(),a.value=null,l.value=null}async function setupRecordingVisualization(e){a.value=new window.AudioContext,o.value=a.value.createAnalyser(),a.value.createMediaStreamSource(e).connect(o.value),o.value.fftSize=256,s.value=new Uint8Array(o.value.frequencyBinCount)}async function setupPlaybackVisualization(e){return a.value&&a.value.state!==`closed`&&await a.value.close(),l.value=null,e?(a.value=new window.AudioContext,o.value=a.value.createAnalyser(),l.value=a.value.createMediaElementSource(e),l.value.connect(o.value),o.value.connect(a.value.destination),o.value.fftSize=256,s.value=new Uint8Array(o.value.frequencyBinCount),!0):!1}function stopWaveform(){c.value&&=(cancelAnimationFrame(c.value),null)}function dispose(){stopWaveform(),a.value&&a.value.state!==`closed`&&a.value.close(),a.value=null,l.value=null}return x(()=>{dispose()}),{waveformBars:i,initWaveform,updateWaveform,setupAudioContext,setupRecordingVisualization,setupPlaybackVisualization,stopWaveform,dispose}}var oe=t((()=>{s()})),z,B,V,H,U,W,G,K,q,J,Y,X,Z,Q=t((()=>{I(),s(),S(),h(),D(),E(),k(),N(),L(),R(),oe(),j(),z={class:`relative`},B={class:`mb-4`},V={key:0,class:`flex h-14 w-full min-w-0 items-center gap-2 rounded-lg px-3 bg-node-component-surface text-text-secondary`},H={class:`flex shrink-0 items-center gap-1`},U={class:`text-xs`},W={class:`text-sm`},G={class:`flex h-8 min-w-0 flex-1 items-center gap-2 overflow-hidden`},K=[`title`],q=[`title`],J=[`title`],Y=[`title`],X=[`src`],Z=y({__name:`WidgetRecordAudio`,props:v({readonly:{type:Boolean},nodeId:{}},{modelValue:{default:``},modelModifiers:{}}),emits:[`update:modelValue`],setup(e){let t=e,a=d(),s=``,h=useAudioRecorder({onRecordingComplete:handleRecordingComplete,onError:()=>{T().addAlert(O(`g.micPermissionDenied`)||`Microphone permission denied`)}}),_=useAudioWaveform({barCount:18,minHeight:4,maxHeight:32}),v=useAudioPlayback(a,{onPlaybackEnded:handlePlaybackEnded,onMetadataLoaded:e=>{!k.value&&!w.value&&(y.value=Math.floor(e))}}),y=d(0),{pause:S,resume:C}=ie(()=>{y.value+=1},1e3,{immediate:!1}),{isRecording:w,recordedURL:E}=h,{waveformBars:D}=_,{isPlaying:k,audioElementKey:j}=v,N=u(()=>w.value||k.value),P=o(e,`modelValue`),I=u(()=>!t.nodeId||!A.canvas.graph?null:A.canvas.graph.getNodeById(t.nodeId));async function handleRecordingComplete(e){try{let t=await M().convertBlobToFileAndSubmit(e);P.value=t,s=t}catch{T().addAlert(`Failed to upload recorded audio`)}}async function handleStartRecording(){if(!t.readonly)try{if(await _.setupAudioContext(),await h.startRecording(),h.mediaRecorder.value){let e=h.mediaRecorder.value.stream;e&&await _.setupRecordingVisualization(e)}y.value=0,C(),_.initWaveform(),_.updateWaveform(N)}catch(e){console.error(`Failed to start recording:`,e)}}function handleStopRecording(){h.stopRecording(),S(),_.stopWaveform()}async function handlePlayRecording(){if(!E.value||(y.value=0,await v.resetAudioElement(),await new Promise(e=>setTimeout(e,50)),!a.value)||!await _.setupPlaybackVisualization(a.value))return;await v.play(),_.initWaveform(),_.updateWaveform(N);let e=setInterval(()=>{y.value=Math.floor(v.getCurrentTime())},100);v.playbackTimerInterval.value=e}function handleStopPlayback(){v.stop(),handlePlaybackEnded()}function handlePlaybackEnded(){_.stopWaveform(),v.playbackTimerInterval.value!==null&&(clearInterval(v.playbackTimerInterval.value),v.playbackTimerInterval.value=null);let e=v.getDuration();e?y.value=Math.floor(e):y.value=0}async function serializeValue(){return w.value&&h.mediaRecorder.value&&(h.mediaRecorder.value.stop(),await new Promise((e,t)=>{let n=0,checkRecording=()=>{!w.value&&P.value?e(void 0):++n>=50?t(Error(`Recording serialization timeout after 5 seconds`)):setTimeout(checkRecording,100)};checkRecording()})),P.value||s||``}function registerWidgetSerialization(){let e=I.value;if(!e?.widgets)return;let t=e.widgets.find(e=>e.name===`audio`);t&&(t.serializeValue=serializeValue)}return te(()=>{_.initWaveform(),registerWidgetSerialization()}),x(()=>{v.playbackTimerInterval.value!==null&&(clearInterval(v.playbackTimerInterval.value),v.playbackTimerInterval.value=null)}),(e,t)=>{let o=F;return r(),g(`div`,z,[f(`div`,B,[m(p(ee),{class:`text-base-foreground w-full border-0 bg-secondary-background hover:bg-secondary-background-hover`,disabled:p(w)||e.readonly,onClick:handleStartRecording},{default:c(()=>[ne(b(p(O)(`g.startRecording`,`Start Recording`))+` `,1),m(o,{class:`ml-1`})]),_:1},8,[`disabled`])]),p(w)||p(k)||p(E)?(r(),g(`div`,V,[f(`div`,H,[f(`span`,U,b(p(w)?p(O)(`g.listening`,`Listening...`):p(k)?p(O)(`g.playing`,`Playing...`):p(E)?p(O)(`g.ready`,`Ready`):``),1),f(`span`,W,b(p(ae)(y.value)),1)]),f(`div`,G,[(r(!0),g(i,null,l(p(D),(e,t)=>(r(),g(`div`,{key:t,class:`max-h-8 min-h-1 w-0.75 rounded-[1.5px] bg-slate-100 transition-all duration-100`,style:re({height:e.height+`px`}),title:`Bar ${t+1}: ${e.height}px`},null,12,K))),128))]),p(w)?(r(),g(`button`,{key:0,title:p(O)(`g.stopRecording`,`Stop Recording`),class:`flex shrink-0 size-8 animate-pulse items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors`,onClick:handleStopRecording},t[2]||=[f(`div`,{class:`size-2.5 rounded-sm bg-danger-100`},null,-1)],8,q)):!p(w)&&p(E)&&!p(k)?(r(),g(`button`,{key:1,title:p(O)(`g.playRecording`)||`Play Recording`,class:`flex shrink-0 size-8 items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors`,onClick:handlePlayRecording},t[3]||=[f(`i`,{class:`text-text-secondary icon-[lucide--play] size-4`},null,-1)],8,J)):p(k)?(r(),g(`button`,{key:2,title:p(O)(`g.stopPlayback`)||`Stop Playback`,class:`flex shrink-0 size-8 items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors`,onClick:handleStopPlayback},t[4]||=[f(`i`,{class:`text-text-secondary icon-[lucide--square] size-4`},null,-1)],8,Y)):n(``,!0)])):n(``,!0),p(E)?(r(),g(`audio`,{ref_key:`audioRef`,ref:a,key:p(j),src:p(E),class:`hidden`,onEnded:t[0]||=(...e)=>p(v).onPlaybackEnded&&p(v).onPlaybackEnded(...e),onLoadedmetadata:t[1]||=(...e)=>p(v).onMetadataLoaded&&p(v).onMetadataLoaded(...e)},null,40,X)):n(``,!0)])}}})})),$;t((()=>{Q(),Q(),$=Z}))();export{$ as default};
//# sourceMappingURL=WidgetRecordAudio-BN7ngd04.js.map