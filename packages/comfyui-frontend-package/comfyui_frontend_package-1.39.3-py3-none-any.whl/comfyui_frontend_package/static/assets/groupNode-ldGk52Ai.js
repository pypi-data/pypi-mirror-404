import{i as e,n as t}from"./rolldown-runtime-BKYq3fBv.js";import{Ct as n,wt as r}from"./vendor-other-CoxDvJ0a.js";import{Ct as i,D as a,L as o,Qt as s,R as c,T as l,Tt as u,i as d,in as f,k as p,r as m,rn as h,v as g,wt as ee,y as _}from"./api-CJ30itpV.js";import{r as te,s as v}from"./i18n-gOSvTADh.js";import{$o as y,Ai as ne,Bt as re,Ct as b,Ei as x,Ga as S,Ja as C,Lt as w,Oi as ie,Qo as T,Rt as E,St as D,Ti as ae,Xa as oe,Ya as se,Za as ce,_o as le,at as O,bo as ue,bt as de,cn as fe,ft as pe,go as k,gt as A,ho as j,ht as M,it as N,ki as P,mo as F,mt as I,n as L,nn as R,pt as z,qa as B,rn as V,sn as me,t as he,wi as ge,xt as _e,yo as ve}from"./dialogService-DvYmp2_F.js";var ExecutableGroupNodeChildDTO,ye=t((()=>{_(),ExecutableGroupNodeChildDTO=class extends a{groupNodeHandler;constructor(e,t,n,r,i){super(e,t,n,r),this.groupNodeHandler=i}resolveInput(e){if(this.id.split(`:`).length>2)throw Error(`Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.`);let t=this.node.getInputNode(e);if(!t)return;let n=this.node.getInputLink(e);if(!n)throw Error(`Failed to get input link`);let r=String(t.id),i=this.nodesByExecutionId?.get(r);if(!i){let e=r.split(`:`).at(-1);e!==void 0&&(i=this.nodesByExecutionId?.get(e))}if(!i)throw Error(`Failed to get input node ${r} for group node child ${this.id} with slot ${e}`);return{node:i,origin_id:r,origin_slot:n.origin_slot}}}})),be=t((()=>{}));function merge(e,t){for(let n in t){let r=t[n];if(typeof r==`object`&&r){let t=e[n];t||=e[n]={},merge(t,r)}else e[n]=r}return e}var H,ManageGroupDialog,U=t((()=>{u(),_(),h(),O(),B(),se(),z(),$(),be(),H=Symbol(),ManageGroupDialog=class extends C{tabs;selectedNodeIndex;selectedTab=`Inputs`;selectedGroup;modifications={};nodeItems;app;groupNodeType;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){let e=this.selectedNodeIndex;if(e==null)throw Error(`No node selected`);let t=this.nodeItems[e];if(!t?.dataset.nodeindex)throw Error(`Invalid node item`);return+t.dataset.nodeindex}constructor(e){super(),this.app=e,this.element=S(`dialog.comfy-group-manage`,{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove(`active`),this.tabs[this.selectedTab].page.classList.remove(`active`),this.tabs[e].tab.classList.add(`active`),this.tabs[e].page.classList.add(`active`),this.selectedTab=e}changeNode(e,t){!t&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove(`selected`),this.nodeItems[e].classList.add(`selected`),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab===`Inputs`&&this.changeTab(`Widgets`),!this.buildWidgetsPage()&&this.selectedTab===`Widgets`&&this.changeTab(`Outputs`),!this.buildOutputsPage()&&this.selectedTab===`Outputs`&&this.changeTab(`Inputs`),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=g.registered_node_types[`${i}>`+this.selectedGroup],this.groupData=Y.getGroupData(this.groupNodeType)}changeGroup(e,t=!0){this.selectedGroup=e,this.getGroupData();let n=this.groupData.nodeData.nodes;if(this.nodeItems=n.map((e,t)=>S(`li.draggable-item`,{dataset:{nodeindex:e.index+``},onclick:()=>{this.changeNode(t)}},[S(`span.drag-handle`),S(`div`,{textContent:e.title??e.type},e.title?S(`span`,{textContent:e.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),t)this.selectedNodeIndex=null,this.changeNode(0);else{let e=this.draggable.getAllItems().findIndex(e=>e.classList.contains(`selected`));e===-1&&(e=this.selectedNodeIndex),this.changeNode(e,!0)}let r=[...n];this.draggable?.dispose(),this.draggable=new pe(this.innerNodesList,`li`),this.draggable.addEventListener(`dragend`,e=>{let{oldPosition:t,newPosition:n}=e.detail;if(t!==n){r.splice(n,0,r.splice(t,1)[0]);for(let e=0;e<r.length;e++)this.storeModification({nodeIndex:r[e].index,section:H,prop:`order`,value:e})}})}storeModification(e){let{nodeIndex:t,section:n,prop:r,value:i}=e,a=this.selectedGroup,o=this.modifications[a]??={},s=o.nodes??={},c=s[t??this.selectedNodeInnerIndex]??={},l=c[n]??={};if(typeof i==`object`&&i){let e=l[r]??={};Object.assign(e,i)}else l[r]=i}getEditElement(e,t,n,r,i,a=!0){let o=n===r?``:n,s=this.selectedGroup,c=(this.modifications[s]?.nodes)?.[this.selectedNodeInnerIndex]?.[e]?.[t];return c&&(c.name!=null&&(o=c.name),c.visible!=null&&(i=c.visible)),S(`div`,[S(`input`,{value:o,placeholder:r,type:`text`,onchange:n=>{this.storeModification({section:e,prop:String(t),value:{name:n.target.value}})}}),S(`label`,{textContent:`Visible`},[S(`input`,{type:`checkbox`,checked:i,disabled:!a,onchange:n=>{this.storeModification({section:e,prop:String(t),value:{visible:!!n.target.checked}})}})])])}buildWidgetsPage(){let e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],t=Object.keys(e??{}),n=N.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...t.map(t=>this.getEditElement(`input`,t,e[t],t,n?.[t]?.visible!==!1))),!!t.length}buildInputsPage(){let e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],t=Object.keys(e??{}),n=N.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input,r=t.map(t=>{let r=e[t];return r?this.getEditElement(`input`,t,r,t,n?.[t]?.visible!==!1):null}).filter(e=>e!==null);return this.inputsPage.replaceChildren(...r),!!t.length}buildOutputsPage(){let e=this.groupData.nodeData.nodes,t=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),n=t?.output??[],r=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],i=N.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,a=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!==`PrimitiveNode`,o=n.map((e,n)=>{let o=r?.[n],s=t?.output_name?.[n]??String(e),c=i?.[n]?.name,l=i?.[n]?.visible||o!=null;return(!c||c===s)&&(c=``),this.getEditElement(`output`,n,c,s,l,a)});return this.outputsPage.replaceChildren(...o),!!n.length}show(e){let t=typeof e==`string`?e:void 0,n=Object.keys(N.rootGraph.extra?.groupNodes??{}).sort((e,t)=>e.localeCompare(t));this.innerNodesList=S(`ul.comfy-group-manage-list-items`),this.widgetsPage=S(`section.comfy-group-manage-node-page`),this.inputsPage=S(`section.comfy-group-manage-node-page`),this.outputsPage=S(`section.comfy-group-manage-node-page`);let r=S(`div`,[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[[`Inputs`,this.inputsPage],[`Widgets`,this.widgetsPage],[`Outputs`,this.outputsPage]].reduce((e,[t,n])=>(e[t]={tab:S(`a`,{onclick:()=>{this.changeTab(t)},textContent:t}),page:n},e),{});let a=S(`div.comfy-group-manage-outer`,[S(`header`,[S(`h2`,`Group Nodes`),S(`select`,{onchange:e=>{this.changeGroup(e.target.value)}},n.map(e=>S(`option`,{textContent:e,selected:`${i}>${e}`===t,value:e})))]),S(`main`,[S(`section.comfy-group-manage-list`,this.innerNodesList),S(`section.comfy-group-manage-node`,[S(`header`,Object.values(this.tabs).map(e=>e.tab)),r])]),S(`footer`,[S(`button.comfy-btn`,{onclick:()=>{if(N.rootGraph.nodes.find(e=>e.type===`workflow>`+this.selectedGroup)){f().addAlert(`This group node is in use in the current workflow, please first remove these.`);return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete N.rootGraph.extra.groupNodes[this.selectedGroup],g.unregisterNodeType(`${i}>`+this.selectedGroup)),this.show()}},`Delete Group Node`),S(`button.comfy-btn`,{onclick:async()=>{let e,t=[],n={};for(let r in this.modifications){let a=N.rootGraph.extra.groupNodes[r],o=a.config??={},s=this.modifications[r]?.nodes;if(s){let e=Object.keys(s);if(s[e[0]]?.[H]){let t=[],n={},r={};for(let r of e){let e=s[r][H].order;t[e]=a.nodes[+r],n[e]=s[r],t[e].index=e}let i=a.nodes.length;for(let e of a.links){let t=e[0],n=e[2];t!=null&&t<i&&(e[0]=a.nodes[t].index),n!=null&&n<i&&(e[2]=a.nodes[n].index)}if(a.external)for(let e of a.external){let t=e[0];t!=null&&t<i&&(e[0]=a.nodes[t].index)}for(let t of e)o[+t]&&(r[a.nodes[+t].index]=o[+t]),delete o[+t];a.nodes=t,s=n,a.config=o=r}merge(o,s)}n[r]=a,e||=N.rootGraph.nodes.reduce((e,t)=>{let n=t.type??``;return e[n]??=[],e[n].push(t),e},{});let c=e[`${i}>`+r];c&&t.push(...c)}await J.registerFromWorkflow(n,[]);for(let e of t)e.recreate?.();this.modifications={},this.app.canvas.setDirty(!0,!0),this.changeGroup(this.selectedGroup,!1)}},`Save`),S(`button.comfy-btn`,{onclick:()=>this.element.close()},`Close`)])]);this.element.replaceChildren(a),this.changeGroup(t?n.find(e=>`workflow>${e}`===t)??n[0]:n[0]),this.element.showModal(),this.element.addEventListener(`close`,()=>{this.draggable?.dispose(),this.element.remove()})}},window.comfyAPI=window.comfyAPI||{},window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{},window.comfyAPI.groupNodeManage.ManageGroupDialog=ManageGroupDialog})),W,getRange,mergeNumericInputSpec,mergeComboInputSpec,mergeCommonInputSpec,mergeInputSpec,xe=t((()=>{n(),k(),de(),W=new Set([`default`,`forceInput`,`defaultInput`,`control_after_generate`,`multiline`,`tooltip`,`dynamicPrompts`]),getRange=e=>({min:e.min??-1/0,max:e.max??1/0}),mergeNumericInputSpec=(e,t)=>{let n=e[0],r=e[1]??{},i=t[1]??{},a=getRange(r),o=getRange(i);if(a.min>o.max||a.max<o.min)return null;let s=r.step??1,c=i.step??1,l={min:Math.max(a.min,o.min),max:Math.min(a.max,o.max),step:_e(s,c)};return mergeCommonInputSpec([n,{...r,...l}],[n,{...i,...l}])},mergeComboInputSpec=(e,t)=>{let n=e[1]??{},i=t[1]??{},a=F(e),o=F(t),s=r.intersection(a,o);return s.length===0?null:mergeCommonInputSpec([`COMBO`,{...n,options:s}],[`COMBO`,{...i,options:s}])},mergeCommonInputSpec=(e,t)=>{let n=j(e),i=e[1]??{},a=t[1]??{};return r.union(r.keys(i),r.keys(a)).filter(e=>!W.has(e)).every(e=>{let t=i[e],n=a[e];return t===n||r.isNil(t)&&r.isNil(n)})?[n,{...i,...a}]:null},mergeInputSpec=(e,t)=>j(e)===j(t)?ue(e)||ve(e)?mergeNumericInputSpec(e,t):le(e)?mergeComboInputSpec(e,t):mergeCommonInputSpec(e,t):null})),isPrimitiveNode,Se=t((()=>{isPrimitiveNode=e=>e.type===`PrimitiveNode`}));function getWidgetConfig(e){return e.widget?.[w]??e.widget?.[E]?.()??[`*`,{}]}function getConfig(e){let{nodeData:t}=this.constructor;return t?.input?.required?.[e]??t?.input?.optional?.[e]}function convertToInput(e,t){return console.warn(`Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now.`),e.inputs.find(e=>e.widget?.name===t.name)}function getWidgetType(e){let t=e[0];return t instanceof Array&&(t=`COMBO`),{type:t}}function setWidgetConfig(e,t){if(!e.widget||(t?e.widget[E]=()=>t:delete e.widget,!(e instanceof o)))return;let n=e.node.graph;if(!n)return;let r=n.links[e.link??-1];if(!r)return;let i=n.getNodeById(r.origin_id);!i||!isPrimitiveNode(i)||(t?i.recreateWidget():N.configuringGraph||(i.disconnectOutput(0),i.onLastDisconnect()))}function mergeIfValid(e,t,n,r,i){i||=getWidgetConfig(e);let a=mergeInputSpec(i,t);if(a||n){a&&(e.widget[w]=a);let t=r?.call(this);if(t){let e=t.options.min,n=t.options.max;e!=null&&t.value<e&&(t.value=e),n!=null&&t.value>n&&(t.value=n),t.callback(t.value)}}return{customConfig:a?.[1]??{}}}var G,PrimitiveNode,K=t((()=>{T(),_(),c(),O(),P(),re(),xe(),ce(),Se(),G=`Run widget replace on values`,PrimitiveNode=class extends p{controlValues;lastType;static category;constructor(e){super(e),this.addOutput(`connect to widget input`,`*`),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(G in this.properties))&&this.addProperty(G,!1,`boolean`)}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;let t=[...this.outputs[0].links.map(e=>this.graph.links[e]),...e],n=this.widgets?.[0].value;n&&this.properties[G]&&(n=oe(this.graph,n));for(let e of t){let t=this.graph?.getNodeById(e.target_id),r=t?.inputs[e.target_slot];if(!r){console.warn(`Unable to resolve node or input for link`,e);continue}let i=r.widget?.name;if(!i){console.warn(`Invalid widget or widget name`,r.widget);continue}let a=t.widgets?.find(e=>e.name===i);if(!a){console.warn(`Unable to find widget "${i}" on node [${t.id}]`);continue}a.value=n,a.callback?.(a.value,N.canvas,t,N.canvas.graph_mouse,{})}}refreshComboInNode(){let e=this.widgets?.[0];e?.type===`combo`&&(e.options.values=this.outputs[0].widget[E]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this._onFirstConnection(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){let t=this.widgets[e];t&&(t.value=this.widgets_values[e])}this._mergeWidgetConfig()}}onConnectionsChange(e,t,n){if(N.configuringGraph)return;let r=this.outputs[0].links;n?r?.length&&!this.widgets?.length&&this._onFirstConnection():(this._mergeWidgetConfig(),r?.length||this.onLastDisconnect())}onConnectOutput(e,t,n,r,i){if(!n.widget&&!(n.type in x))return!1;if(this.outputs[e].links?.length){let e=this._isValidConnection(n);return e&&this.applyToGraph([{target_id:r.id,target_slot:i}]),e}return!0}_onFirstConnection(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}let t=this.outputs[0].links[0],n=this.graph.links[t];if(!n)return;let r=this.graph.getNodeById(n.target_id);if(!r||!r.inputs)return;let i=r.inputs[n.target_slot];if(!i)return;let a;if(i.widget)a=i.widget;else{if(!(i.type in x))return;a={name:i.name,[E]:()=>[i.type,{}]}}let o=a[E]?.();if(!o)return;let{type:s}=getWidgetType(o);this.outputs[0].type=s,this.outputs[0].name=s,this.outputs[0].widget=a,this._createWidget(a[w]??o,r,a.name,e)}_createWidget(e,t,n,r){let i=e[0];i instanceof Array&&(i=`COMBO`);let[a,o]=this.size,s;if(s=ne(i)?(x[i](this,`value`,e,N)||{}).widget:this.addWidget(i,`value`,null,()=>{},{}),t?.widgets&&s){let e=t.widgets.find(e=>e.name===n);e&&(s.value=e.value)}if(!e?.[1]?.control_after_generate&&(s.type===`number`||s.type===`combo`)){let t=this.widgets_values?.[1];t||=`fixed`,ie(this,s,t,void 0,e),this.widgets?.[1]&&(s.linkedWidgets=[this.widgets[1]]);let n=this.widgets_values?.[2];n&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=n)}let c=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&c?.length===this.widgets.length-1)for(let e=0;e<c.length;e++)this.widgets[e+1].value=c[e];if(s.callback=y(s.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],a),Math.max(this.size[1],o)]),!r){let e=this.computeSize();this.size[0]<e[0]&&(this.size[0]=e[0]),this.size[1]<e[1]&&(this.size[1]=e[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){let e=this.widgets?.map(e=>e.value);if(this._removeWidgets(),this._onFirstConnection(!0),e?.length&&this.widgets)for(let t=0;t<this.widgets.length;t++)this.widgets[t].value=e[t];return this.widgets?.[0]}_mergeWidgetConfig(){let e=this.outputs[0],t=e.links??[],n=!!e.widget?.[w];if(n&&delete e.widget?.[w],t?.length<2&&n){t.length&&this.recreateWidget();return}let r=e.widget?.[E]?.();if(r&&!(!(r[0]===`INT`||r[0]===`FLOAT`)||!this.graph))for(let e of t){let t=this.graph.links[e];if(!t)continue;let r=this.graph.getNodeById(t.target_id);if(!r)continue;let i=r.inputs[t.target_slot];this._isValidConnection(i,n)}}_isValidConnection(e,t){let n=this.outputs?.[0],r=e.widget?.[E]?.();return r?!!mergeIfValid.call(this,n,r,t,this.recreateWidget):!1}_removeWidgets(){if(this.widgets){for(let e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type=`*`,this.outputs[0].name=`connect to widget input`,delete this.outputs[0].widget,this._removeWidgets()}},N.registerExtension({name:`Comfy.WidgetInputs`,async beforeRegisterNodeDef(e,t){e.prototype.convertWidgetToInput=function(){return console.warn(`Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now.`),!1},e.prototype.onGraphConfigured=y(e.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(let e of this.inputs)if(e.widget){let t=e.widget.name;e.widget[E]||(e.widget[E]=()=>getConfig.call(this,t)),this.widgets?.find(e=>e.name===t)||this.removeInput(this.inputs.findIndex(t=>t===e))}}}),e.prototype.onConfigure=y(e.prototype.onConfigure,function(){if(!N.configuringGraph&&this.inputs){for(let e of this.inputs)if(e.widget&&!e.widget[E]){let t=e.widget.name;e.widget[E]=()=>getConfig.call(this,t)}}});let n=e.prototype.onInputDblClick;e.prototype.onInputDblClick=function(...[e,...t]){let r=n?.apply(this,[e,...t]),i=this.inputs[e];if(!i.widget&&!(i.type in x)&&!((i.widget?.[E])?.()?.[0]instanceof Array))return r;let a=g.createNode(`PrimitiveNode`),o=N.canvas.graph;if(!a||!o)return r;o?.add(a);let s=[this.pos[0]-a.size[0]-30,this.pos[1]];for(;o.getNodeOnPos(s[0],s[1],o.nodes);)s[1]+=g.NODE_TITLE_HEIGHT;return a.pos=s,a.connect(0,this,e),a.title=i.name,r}},registerCustomNodes(){g.registerNodeType(`PrimitiveNode`,Object.assign(PrimitiveNode,{title:`Primitive`})),PrimitiveNode.category=`utils`}}),window.comfyAPI=window.comfyAPI||{},window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{},window.comfyAPI.widgetInputs.PrimitiveNode=PrimitiveNode,window.comfyAPI.widgetInputs.getWidgetConfig=getWidgetConfig,window.comfyAPI.widgetInputs.convertToInput=convertToInput,window.comfyAPI.widgetInputs.setWidgetConfig=setWidgetConfig,window.comfyAPI.widgetInputs.mergeIfValid=mergeIfValid}));async function convertSelectedNodesToGroupNode(){let e=Object.values(N.canvas.selected_nodes??{});if(e.length===0)throw Error(`No nodes selected`);if(e.length===1)throw Error(`Please select multiple nodes to convert to group node`);for(let t of e){if(t instanceof l)throw Error(`Selected nodes contain a subgraph node`);if(Y.isGroupNode(t))throw Error(`Selected nodes contain a group node`)}return await Y.fromNodes(e)}function ungroupSelectedGroupNodes(){let e=Object.values(N.canvas.selected_nodes??{});for(let t of e)Y.isGroupNode(t)&&t.convertToNodes?.()}function manageGroupNodes(e){new ManageGroupDialog(N).show(e)}var q,GroupNodeBuilder,J,Y,replaceLegacySeparators,convertDisabled,X,Z,Q,$=t((()=>{u(),te(),_(),h(),s(),he(),R(),me(),ge(),ye(),b(),M(),d(),O(),U(),K(),q={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(e){let t=`${i}>${e}`;return N.rootGraph.extra?.groupNodes?.[e]?N.rootGraph.nodes.find(e=>e.type===t)?q.InUse.InWorkflow:q.InUse.Registered:q.InUse.Free},storeGroupNode(e,t){let n=N.rootGraph.extra;n||(N.rootGraph.extra=n={});let r=n.groupNodes;r||(n.groupNodes=r={}),r[e]=t}},GroupNodeBuilder=class{nodes;nodeData;constructor(e){this.nodes=e}async build(){let e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),q.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){let e=await L().prompt({title:v(`groupNode.create`),message:v(`groupNode.enterName`),defaultValue:``});if(e){switch(q.isInUseGroupNode(e)){case q.InUse.InWorkflow:f().addAlert(`An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.`);return;case q.InUse.Registered:if(!confirm(`A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?`))return;break}return e}}sortNodes(){let e=N.rootGraph.computeExecutionOrder(!1);this.nodes=this.nodes.map(t=>({index:e.indexOf(t),node:t})).sort((e,t)=>e.index-t.index||String(e.node.id).localeCompare(String(t.node.id))).map(({node:e})=>e)}getNodeData(){let storeLinkTypes=e=>{for(let t of e.links){let e=N.rootGraph.getNodeById(t[4])?.outputs?.[Number(t[1])]?.type;e!==void 0&&t.push(e)}},storeExternalLinks=e=>{e.external=[];for(let t=0;t<this.nodes.length;t++){let n=this.nodes[t];if(n.outputs?.length)for(let r=0;r<n.outputs.length;r++){let i=!1,a=n.outputs[r],o=a.type;if(a.links?.length){for(let e of a.links){let t=N.rootGraph.links[e];if(t&&(o===`*`&&(o=t.type),!N.canvas.selected_nodes[t.target_id])){i=!0;break}}i&&e.external.push([t,r,String(o)])}}}},e=N.canvas?.graph;if(!e)return{nodes:[],links:[],external:[]};let t=A(this.nodes,e),n=JSON.parse(t);return n.external=[],storeLinkTypes(n),storeExternalLinks(n),n}},J=class GroupNodeConfig{name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,t){this.name=e,this.nodeData=t,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=i){this.nodeDef={output:[],output_name:[],output_is_list:[],output_node:!1,name:e+`>`+this.name,display_name:this.name,category:`group nodes`+(`>`+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(e=>e.type).join(`, `)}`,python_module:`custom_nodes.`+this.name,[D]:this},this.inputs=[];let t={},n={};for(let e=0;e<this.nodeData.nodes.length;e++){let r=this.nodeData.nodes[e];r.index=e,this.processNode(r,t,n)}for(let e of this._convertedToProcess)e();this._convertedToProcess=[],this.nodeDef&&(await N.registerNodeDef(`${i}>`+this.name,this.nodeDef),fe().addNodeDef(this.nodeDef))}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(let e of this.nodeData.links){let[t,n,r,i]=e;if(t==null||n==null||r==null||i==null)continue;let a=Number(t),o=Number(n),s=Number(r),c=Number(i);this.linksFrom[a]||(this.linksFrom[a]={}),this.linksFrom[a][o]||(this.linksFrom[a][o]=[]),this.linksFrom[a][o].push(e),this.linksTo[s]||(this.linksTo[s]={}),this.linksTo[s][c]=e}if(this.nodeData.external)for(let e of this.nodeData.external){let t=Number(e[0]),n=Number(e[1]),r=e[2];r!=null&&(this.externalFrom[t]?this.externalFrom[t][n]=r:this.externalFrom[t]={[n]:r})}}processNode(e,t,n){let r=this.getNodeDef(e);if(!r)return;let i={...r.input?.required,...r.input?.optional};this.inputs.push(this.processNodeInputs(e,t,i)),r.output?.length&&this.processNodeOutputs(e,n,r)}getNodeDef(e){if(e.type){let t=Z[e.type];if(t)return t}let t=e.index;if(t==null)return;let n=this.linksFrom[t];if(e.type===`PrimitiveNode`){if(!n)return;let r=n[0]?.[0]?.[5]??null;if(r===`COMBO`){let t=(e.outputs?.[0])?.widget?.name,i=n[0]?.[0]?.[2];if(t&&i!=null){let e=this.nodeData.nodes[Number(i)]?.type;if(e){let n=Z[e],i=(n?.input?.required?.[t]??n?.input?.optional?.[t])?.[0];r=typeof i==`string`||typeof i==`number`?i:null}}}return this.primitiveDefs[t]={input:{required:{value:[r,{}]}},output:[r],output_name:[],output_is_list:[]}}else if(e.type===`Reroute`){let r=this.linksTo[t];if(r&&n&&!this.externalFrom[t]?.[0])return null;let i={},a=`*`;if(n){let e=n[0]??[];for(let t of e){let e=t[2],n=t[3];if(e==null||n==null)continue;let r=this.nodeData.nodes[Number(e)],o=r?.inputs?.[Number(n)];if(o?.type&&a===`*`&&(a=o.type),o?.widget&&r?.type){let e=Z[r.type],t=e?.input?.required?.[o.widget.name]??e?.input?.optional?.[o.widget.name];if(t){let e=[t[0],i];i=mergeIfValid({widget:e},t,!1,void 0,e)?.customConfig??i}}}}else if(r){let e=r[0];if(e){let t=e[0],n=e[1];if(t!=null&&n!=null){let e=this.nodeData.nodes[Number(t)]?.outputs?.[Number(n)];e&&typeof e==`object`&&`type`in e&&(a=String(e.type??`*`))}}}else{for(let t of this.nodeData.links)if(t[2]===e.index){let e=t[5];e!=null&&(a=String(e));break}if(a===`*`){let e=this.externalFrom[t]?.[0];e&&(a=String(e))}}return i.forceInput=!0,{input:{required:{[a]:[a,i]}},output:[a],output_name:[],output_is_list:[]}}console.warn(`Skipping virtual node `+e.type+` when building group node `+this.name)}getInputConfig(e,t,n,r,i){let a=(this.nodeData.config?.[e.index??-1])?.input?.[t],o=a?.name??e.inputs?.find(e=>e.name===t)?.label??t,s=o,c=``;if((e.type===`PrimitiveNode`&&e.title||o in n)&&(c=`${e.title??e.type} `,s=o=`${c}${t}`,o in n&&(o=`${c}${n[o]} ${t}`)),n[s]=(n[s]??1)+1,(t===`seed`||t===`noise_seed`)&&(i||={},i.control_after_generate=`${c}control_after_generate`),r[0]===`IMAGEUPLOAD`){i||={};let t=e.index??-1,n=typeof r[1]==`object`&&r[1]!==null?r[1]:{},a=`widget`in n&&typeof n.widget==`string`?n.widget:`image`;i.widget=this.oldToNewWidgetMap[t]?.[a]??`image`}if(i){let e=typeof r[1]==`object`&&r[1]?r[1]:{};r=[r[0],{...e,...i}]}return{name:o,config:r,customConfig:a}}processWidgetInputs(e,t,n,r){let i=[],a=new Map,o=t.index??-1,s=this.oldToNewWidgetMap[o]={};for(let o of n){let n=e[o];if(Array.isArray(n)&&n.length>=1&&typeof n[0]==`string`&&ae().inputIsWidget(n)){let n=t.inputs?.findIndex(e=>e.name===o&&e.widget?.name===o)??-1;if(n>-1)a.set(n,o),s[o]=null;else{let{name:n,config:i}=this.getInputConfig(t,o,r,e[o]);this.nodeDef?.input?.required&&(this.nodeDef.input.required[n]=i),s[o]=n,this.newToOldWidgetMap[n]={node:t,inputName:o}}}else i.push(o)}return{converted:a,slots:i}}checkPrimitiveConnection(e,t,n){let r=e[0];if(r!=null&&this.nodeData.nodes[Number(r)]?.type===`PrimitiveNode`){let r=Number(e[0]),i=Number(e[2]),a=this.primitiveDefs[r];if(!a)return;let o=n[t],s=a.input.required.value,c=mergeIfValid({widget:s},o,!1,void 0,s),l=n[t]?.[1];s[1]=c?.customConfig??l?{...typeof l==`object`?l:{}}:{};let u=this.oldToNewWidgetMap[r]?.value;if(u){let e=u.substring(0,u.length-6);s[1].control_after_generate=!0,s[1].control_prefix=e}let d=this.widgetToPrimitive[i];d||=this.widgetToPrimitive[i]={};let f=d[t];Array.isArray(f)?f.push(r):typeof f==`number`?d[t]=[f,r]:d[t]=r;let p=this.primitiveToWidget[r];p||=this.primitiveToWidget[r]=[],p.push({nodeId:i,inputName:t})}}processInputSlots(e,t,n,r,i,a){let o=t.index??-1;this.nodeInputs[o]={};for(let s=0;s<n.length;s++){let c=n[s];if(r[s]){this.checkPrimitiveConnection(r[s],c,e);continue}let{name:l,config:u,customConfig:d}=this.getInputConfig(t,c,a,e[c]);this.nodeInputs[o][c]=l,d?.visible!==!1&&(this.nodeDef?.input?.required&&(this.nodeDef.input.required[l]=u),i[s]=this.inputCount++)}}processConvertedWidgets(e,t,n,r,i,a,o){let s=[...r.keys()].sort().map(e=>r.get(e));for(let r=0;r<s.length;r++){let c=s[r];if(!c)continue;if(i[n.length+r]){this.checkPrimitiveConnection(i[n.length+r],c,e);continue}let{name:l,config:u}=this.getInputConfig(t,c,o,e[c],{defaultInput:!0});this.nodeDef?.input?.required&&(this.nodeDef.input.required[l]=u),this.newToOldWidgetMap[l]={node:t,inputName:c};let d=t.index??-1;this.oldToNewWidgetMap[d]||(this.oldToNewWidgetMap[d]={}),this.oldToNewWidgetMap[d][c]=l,a[n.length+r]=this.inputCount++}}_convertedToProcess=[];processNodeInputs(e,t,n){let r=[],i=Object.keys(n);if(!i.length)return;let{converted:a,slots:o}=this.processWidgetInputs(n,e,i,t),s=e.index??-1,c=this.linksTo[s]??{},l=this.oldToNewInputMap[s]={};return this.processInputSlots(n,e,o,c,l,t),this._convertedToProcess.push(()=>this.processConvertedWidgets(n,e,o,a,c,l,t)),r}processNodeOutputs(e,t,n){let r=e.index??-1,i=this.oldToNewOutputMap[r]={},a=n.output??[];for(let o=0;o<a.length;o++){let s=this.linksFrom[r]?.[o]&&!this.externalFrom[r]?.[o],c=(this.nodeData.config?.[e.index??-1])?.output?.[o],l=c?.visible??!s;if(this.outputVisibility.push(l),!l)continue;this.nodeDef?.output&&(i[o]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:o},this.nodeDef.output.push(a[o]),this.nodeDef.output_is_list?.push(n.output_is_list?.[o]??!1));let u=c?.name;if(!u){let t=a[o];u=n.output_name?.[o]??(typeof t==`string`?t:void 0);let r=e.outputs?.find(e=>e.name===u);r?.label&&(u=r.label)}let d=String(u??`output_${o}`);if(d in t){let n=`${e.title??e.type} `;d=`${n}${u??o}`,d in t&&(d=`${n}${e.index} ${u??o}`)}t[d]=1,this.nodeDef?.output_name?.push(d)}}static async registerFromWorkflow(e,t){for(let n in e){let r=e[n],a=!1;for(let o of r.nodes)(!o.type||!(o.type in g.registered_node_types))&&(t.push({type:o.type??`unknown`,hint:` (In group node '${i}>${n}')`}),t.push({type:`${i}>`+n,action:{text:`Remove from workflow`,callback:t=>{delete e[n];let r=t.target;r.textContent=`Removed`,r.style.pointerEvents=`none`,r.style.opacity=`0.7`}}}),a=!0);a||await new GroupNodeConfig(n,r).registerType()}}},Y=class GroupNodeHandler{node;groupData;innerNodes=null;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[D],this.node.setInnerNodes=e=>{this.innerNodes=e;for(let t=0;t<this.innerNodes.length;t++){let n=this.innerNodes[t];n.graph??=this.node.graph;for(let e of n.widgets??[])e.type===`converted-widget`&&(e.serializeValue=e.origSerializeValue);n.index=t,n.getInputNode=t=>{let r=n.index??0,i=this.groupData.oldToNewInputMap[r]?.[t];if(i!=null)return this.node.getInputNode(i);let a=this.groupData.linksTo[r]?.[t];if(!a)return null;let o=a[0];if(o==null)return null;let s=e[Number(o)];return s.type===`PrimitiveNode`?null:s},n.getInputLink=t=>{let r=n.index??0,i=this.groupData.oldToNewInputMap[r]?.[t];if(i!=null){let e=this.node.inputs[i].link;if(e==null)return null;let r=N.rootGraph.links[e];return r?{...r,target_id:n.id,target_slot:+t}:null}let a=this.groupData.linksTo[r]?.[t];if(!a)return null;let o=a[0];return o==null?null:{origin_id:e[Number(o)].id,origin_slot:a[1],target_id:n.id,target_slot:+t}}}},this.node.updateLink=e=>{e={...e};let t=this.groupData.newToOldOutputMap[e.origin_slot];if(!t||!this.innerNodes)return null;let n=t.node.index??0,r=this.innerNodes[n],i;for(;r?.type===`Reroute`;)i=r.getInputLink(0),r=r.getInputNode(0);return r?i&&GroupNodeHandler.isGroupNode(r)&&r.updateLink?r.updateLink(i):(e.origin_id=r.id,e.origin_slot=i?.origin_slot??t.slot,e):null},this.node.getInnerNodes=(e,t=[],n=[],r=new Set)=>{if(r.has(this.node))throw Error(`RecursionError: while flattening subgraph`);if(r.add(this.node),!this.innerNodes){let e=this.groupData.nodeData.nodes.map((e,t)=>{if(!e.type)return null;let n=g.createNode(e.type);return n?(n.configure(e),n.id=`${this.node.id}:${t}`,n.graph=this.node.graph,n):null}).filter(e=>e!==null);this.node.setInnerNodes?.(e)}this.updateInnerWidgets();let i=[...t,this.node.id],a=this.node.graph?.getNodeById(t.at(-1))??void 0;for(let t of this.innerNodes??[]){t.graph??=this.node.graph;let r=String(t.id);t.id=r.split(`:`).at(-1);let o=new ExecutableGroupNodeChildDTO(t,i,e,a);t.id=r,o.groupNodeHandler=this,n.push(o)}return n},this.node.recreate=async()=>{let e=this.node.id,t=this.node.size,n=this.node.convertToNodes?.();if(!n)return null;let r=g.createNode(this.node.type);if(!r)return null;r.id=e,r.setInnerNodes?.(n);let i=GroupNodeHandler.getHandler(r);i?.populateWidgets(),N.rootGraph.add(r),r.setSize?.([Math.max(r.size[0],t[0]),Math.max(r.size[1],t[1])]);let a=new GroupNodeBuilder(n).getNodeData();return i&&(i.groupData.nodeData.links=a.links,i.replaceNodes(n)),r},this.node.convertToNodes=()=>{let addInnerNodes=()=>{let e={...this.groupData.nodeData};e.nodes=[...e.nodes];let t=this.node.getInnerNodes?.(),n=[];for(let r=0;r<e.nodes.length;r++){let i=t?.[r]?.id;i==null||typeof i==`number`&&isNaN(i)?i=void 0:n.push(i),e.nodes[r]={...e.nodes[r],id:i}}I(JSON.stringify(e),N.canvas);let[r,i]=this.node.pos,a,o,s=n.length?n:Object.keys(N.canvas.selected_nodes),c=[];for(let e=0;e<s.length;e++){let n=s[e],r=N.rootGraph.getNodeById(n),i=t?.[e];if(!r||(c.push(r),(o==null||r.pos[0]<o)&&(o=r.pos[0]),(a==null||r.pos[1]<a)&&(a=r.pos[1]),!r.widgets||!i))continue;let l=this.groupData.oldToNewWidgetMap[i.index??0];if(l){let e=Object.keys(l);for(let t of e){let e=l[t];if(!e)continue;let n=this.node.widgets?.findIndex(t=>t.name===e)??-1;if(n!==-1)if(i.type===`PrimitiveNode`)for(let e=0;e<r.widgets.length;e++){let t=this.node.widgets?.[n+e];t&&(r.widgets[e].value=t.value)}else{let e=this.node.widgets?.[n],i=r.widgets.find(e=>e.name===t);if(!i||!e)continue;i.value=e.value;let a=e.linkedWidgets??[];for(let e=0;e<a.length;e++){let t=i.linkedWidgets?.[e];t&&a[e]&&(t.value=a[e].value)}}}}}for(let e of c)e.pos[0]-=(o??0)-r,e.pos[1]-=(a??0)-i;return{newNodes:c,selectedIds:s}},reconnectInputs=t=>{for(let n in this.groupData.oldToNewInputMap){let r=t[Number(n)],i=N.rootGraph.getNodeById(r);if(!i)continue;let a=this.groupData.oldToNewInputMap[Number(n)];for(let t in a){let n=a[Number(t)];if(n==null)continue;let r=e.inputs[n];if(r.link==null)continue;let o=N.rootGraph.links[r.link];o&&N.rootGraph.getNodeById(o.origin_id)?.connect(o.origin_slot,i,+t)}}},reconnectOutputs=t=>{for(let n=0;n<e.outputs?.length;n++){let r=e.outputs[n];if(!r.links)continue;let i=[...r.links];for(let e of i){let r=this.groupData.newToOldOutputMap[n];if(!r)continue;let i=N.rootGraph.links[e];if(!i)continue;let a=N.rootGraph.getNodeById(i.target_id),o=N.rootGraph.getNodeById(t[r.node.index??0]);a&&o?.connect(r.slot,a,i.target_slot)}}};N.canvas.emitBeforeChange();try{let{newNodes:e,selectedIds:t}=addInnerNodes();return reconnectInputs(t),reconnectOutputs(t),N.rootGraph.remove(this.node),e}finally{N.canvas.emitAfterChange()}};let t=this.node.getExtraMenuOptions,n=this.node;this.node.getExtraMenuOptions=function(e,r){t?.call(this,e,r);let i=r.findIndex(e=>e?.content===`Outputs`);return i===-1?i=r.length:i++,r.splice(i,0,null,{content:`Convert to nodes`,callback:async()=>{let e=n.convertToNodes;return e?.()}},{content:`Manage Group Node`,callback:()=>manageGroupNodes(this.type)}),[]};let r=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(e,t,n,i){r?.call(this,e,t,n,i);let a=e.fillStyle;e.beginPath(),e.rect(11,-t+11,2,2),e.rect(14,-t+11,2,2),e.rect(17,-t+11,2,2),e.rect(11,-t+14,2,2),e.rect(14,-t+14,2,2),e.rect(17,-t+14,2,2),e.rect(11,-t+17,2,2),e.rect(14,-t+17,2,2),e.rect(17,-t+17,2,2),e.fillStyle=this.boxcolor||g.NODE_DEFAULT_BOXCOLOR,e.fill(),e.fillStyle=a};let i=e.onDrawForeground,a=this.groupData.nodeData;e.onDrawForeground=function(t,n,r){i?.call(this,t,n,r);let o=V().nodeProgressStates[this.id];if(o&&o.state===`running`&&this.runningInternalNodeId!==null){let n=typeof this.runningInternalNodeId==`number`?this.runningInternalNodeId:parseInt(String(this.runningInternalNodeId),10),r=a.nodes[n];if(!r)return;let i=`Running ${r.title||r.type} (${this.runningInternalNodeId}/${a.nodes.length})`;t.save(),t.font=`12px sans-serif`;let o=t.measureText(i);t.fillStyle=e.boxcolor||g.NODE_DEFAULT_BOXCOLOR,t.beginPath(),t.roundRect(0,-g.NODE_TITLE_HEIGHT-20,o.width+12,20,5),t.fill(),t.fillStyle=`#fff`,t.fillText(i,6,-g.NODE_TITLE_HEIGHT-6),t.restore()}};let o=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,o?.call(this)};let s=this.node.onNodeCreated,c=this.groupData;this.node.onNodeCreated=function(){if(!this.widgets)return;let e=c.nodeData.config;if(e)for(let t in e){let n=e[t]?.input;if(n)for(let e in n){if(n[e]?.visible!==!1)continue;let r=c.oldToNewWidgetMap[Number(t)]?.[e],i=this.widgets.find(e=>e.name===r);i&&(i.type=`hidden`,i.computeSize=()=>[0,-4])}}return s?.call(this)};let handleEvent=(e,t,n)=>{let handler=({detail:r})=>{let i=t(r);if(!i||N.rootGraph.getNodeById(i))return;let a=this.innerNodes?.findIndex(e=>e.id==i)??-1;a>-1&&(this.node.runningInternalNodeId=a,m.dispatchCustomEvent(e,n(r,`${this.node.id}`,this.node)))};return m.addEventListener(e,handler),handler},l=handleEvent(`executing`,e=>typeof e==`string`?e:void 0,(e,t)=>t),u=handleEvent(`executed`,e=>typeof e==`object`?e?.display_node||e?.node:void 0,(e,t,n)=>({...typeof e==`object`?e:{},node:t,display_node:t,merge:!n.resetExecution})),d=e.onRemoved;this.node.onRemoved=function(){d?.call(this),m.removeEventListener(`executing`,l),m.removeEventListener(`executed`,u)},this.node.refreshComboInNode=e=>{for(let t in this.groupData.newToOldWidgetMap){let n=this.node.widgets?.find(e=>e.name===t);if(n?.type===`combo`){let r=this.groupData.newToOldWidgetMap[t];if(!r.node.type)continue;let i=e[r.node.type],a=i?.input?.required?.[r.inputName]??i?.input?.optional?.[r.inputName];if(!a)continue;n.options.values=a[0];let o=n.options.values;r.inputName!==`image`&&!o.includes(n.value)&&(n.value=o[0],n.callback?.(n.value))}}}}updateInnerWidgets(){if(this.innerNodes)for(let e in this.groupData.newToOldWidgetMap){let t=this.node.widgets?.find(t=>t.name===e);if(!t)continue;let n=t.value,r=this.groupData.newToOldWidgetMap[e],i=r.node.index??0,a=this.innerNodes[i];if(!a)continue;if(a.type===`PrimitiveNode`){a.primitiveValue=n;let e=this.groupData.primitiveToWidget[i];for(let t of e??[]){let e=typeof t.nodeId==`number`?t.nodeId:Number(t.nodeId),r=this.innerNodes[e]?.widgets?.find(e=>e.name===t.inputName);r&&(r.value=n)}continue}else if(a.type===`Reroute`){let e=this.groupData.linksFrom[i];if(e)for(let[,,t,r]of e[0]??[]){if(t==null||r==null)continue;let e=this.innerNodes[Number(t)];if(!e)continue;let i=e.inputs?.[Number(r)];if(i?.widget){let t=i.widget.name,r=e.widgets?.find(e=>e.name===t);r&&(r.value=n)}}}let o=a.widgets?.find(e=>e.name===r.inputName);o&&(o.value=n)}}populatePrimitive(e,t,n){let r=this.groupData.widgetToPrimitive[t]?.[n];if(r==null)return!1;let i=this.groupData.oldToNewWidgetMap[Array.isArray(r)?r[0]:r]?.value;if(!i)return!1;let a=this.node.widgets?.findIndex(e=>e.name===i)??-1;if(a>-1&&this.innerNodes){let e=Array.isArray(r)?r[0]:r,t=this.innerNodes[e];if(!t?.widgets)return!0;let n=t.widgets.length;n-1!==(this.node.widgets?.[a]?.linkedWidgets?.length??0)&&(n=1);for(let e=0;e<n;e++){let n=this.node.widgets?.[a+e],r=t.widgets[e];n&&r&&(n.value=r.value)}}return!0}populateReroute(e,t,n){if(e.type!==`Reroute`)return;let r=this.groupData.linksFrom[t]?.[0]?.[0];if(!r)return;let i=r[2],a=r[3];if(i==null||a==null)return;let o=this.groupData.nodeData.nodes[Number(i)],s=o?.inputs;if(!s?.[Number(a)]?.widget)return;let c=(s?.length??0)-(o?.widgets_values?.length??0),l=o?.widgets_values?.[Number(a)-c];if(l==null)return;let u=Object.values(n)[0],d=this.node.widgets?.find(e=>e.name===u);d&&(d.value=l)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){let t=this.groupData.nodeData.nodes[e],n=this.groupData.oldToNewWidgetMap[e]??{},r=Object.keys(n);if(!t.widgets_values?.length){this.populateReroute(t,e,n);continue}let i=0;for(let a=0;a<r.length;a++){let o=r[a],s=n[o],c=this.node.widgets.findIndex(e=>e.name===s),l=this.node.widgets[c];if(this.populatePrimitive(t,e,o)||c===-1){let t=this.innerNodes?.[e]?.widgets?.find(e=>e.name===o);i+=t?.linkedWidgets?.length??0}if(c===-1)continue;l.value=t.widgets_values?.[a+i];let u=l.linkedWidgets??[];for(let e=0;e<u.length;e++)this.node.widgets[c+e+1].value=t.widgets_values?.[a+ ++i]}}}replaceNodes(e){let t,n;for(let r=0;r<e.length;r++){let i=e[r];(n==null||i.pos[0]<n)&&(n=i.pos[0]),(t==null||i.pos[1]<t)&&(t=i.pos[1]),this.linkOutputs(i,r),N.rootGraph.remove(i),i.id=`${this.node.id}:${r}`}this.linkInputs(),this.node.pos=[n??0,t??0]}linkOutputs(e,t){if(e.outputs)for(let n of e.outputs){if(!n.links)continue;let e=[...n.links];for(let n of e){let e=N.rootGraph.links[n];if(!e)continue;let r=N.rootGraph.getNodeById(e.target_id),i=this.groupData.oldToNewOutputMap[t]?.[e.origin_slot];i!=null&&r&&this.node.connect(i,r,e.target_slot)}}}linkInputs(){for(let e of this.groupData.nodeData.links??[]){let[,t,n,r,i]=e;if(i==null||typeof i==`object`)continue;let a=N.rootGraph.getNodeById(i);if(!a||n==null||r==null)continue;let o=this.groupData.oldToNewInputMap[Number(n)]?.[Number(r)];o!=null&&(typeof t==`number`||typeof t==`string`)&&a.connect(t,this.node.id,o)}}static getGroupData(e){if(typeof e==`function`)return e.nodeData?.[D];let t=e.nodeData;return t?.[D]?t[D]:e.constructor?.nodeData?.[D]}static getHandler(e){let t=e[D];return!t&&GroupNodeHandler.isGroupNode(e)&&(t=new GroupNodeHandler(e),e[D]=t),t}static isGroupNode(e){return!!e.constructor?.nodeData?.[D]}static async fromNodes(e){let t=new GroupNodeBuilder(e),n=await t.build();if(!n)return;let{name:r,nodeData:a}=n;await new J(r,a).registerType();let o=g.createNode(`${i}>${r}`);if(!o)return;o.setInnerNodes?.(t.nodes);let s=GroupNodeHandler.getHandler(o);return s?.populateWidgets(),N.rootGraph.add(o),s?.replaceNodes(t.nodes),o}},replaceLegacySeparators=e=>{for(let t of e)typeof t.type==`string`&&t.type.startsWith(`workflow/`)&&(t.type=t.type.replace(/^workflow\//,`${i}>`))},convertDisabled=e=>e.length<2||!!e.find(e=>Y.isGroupNode(e)),X=`Comfy.GroupNode`,Q={name:X,commands:[{id:`Comfy.GroupNode.ConvertSelectedNodesToGroupNode`,label:`Convert selected nodes to group node`,icon:`pi pi-sitemap`,versionAdded:`1.3.17`,function:()=>convertSelectedNodesToGroupNode()},{id:`Comfy.GroupNode.UngroupSelectedGroupNodes`,label:`Ungroup selected group nodes`,icon:`pi pi-sitemap`,versionAdded:`1.3.17`,function:()=>ungroupSelectedGroupNodes()},{id:`Comfy.GroupNode.ManageGroupNodes`,label:`Manage group nodes`,icon:`pi pi-cog`,versionAdded:`1.3.17`,function:(...e)=>manageGroupNodes(e[0])}],keybindings:[{commandId:`Comfy.GroupNode.ConvertSelectedNodesToGroupNode`,combo:{alt:!0,key:`g`}},{commandId:`Comfy.GroupNode.UngroupSelectedGroupNodes`,combo:{alt:!0,shift:!0,key:`G`}}],getCanvasMenuItems(e){let t=[],n=!convertDisabled(Object.values(e.selected_nodes??{}));t.push({content:`Convert to Group Node (Deprecated)`,disabled:!n,callback:async()=>convertSelectedNodesToGroupNode()});let r=e.graph?.extra?.groupNodes,i=!r||!Object.keys(r).length;return t.push({content:`Manage Group Nodes`,disabled:i,callback:()=>manageGroupNodes()}),t},getNodeMenuItems(e){return Y.isGroupNode(e)?[]:[{content:`Convert to Group Node (Deprecated)`,disabled:!!convertDisabled(Object.values(N.canvas.selected_nodes??{})),callback:async()=>convertSelectedNodesToGroupNode()}]},async beforeConfigureGraph(e,t){let n=e?.extra?.groupNodes;n&&(replaceLegacySeparators(e.nodes),await J.registerFromWorkflow(n,t))},addCustomNodeDefs(e){Z=e},nodeCreated(e){if(Y.isGroupNode(e)){e[D]=new Y(e);let t=Y.getHandler(e);e.title&&t?.groupData?.nodeData&&q.storeGroupNode(e.title,t.groupData.nodeData)}},async refreshComboInNodes(e){Object.assign(Z,e);let t=N.rootGraph.extra?.groupNodes;t&&await J.registerFromWorkflow(t,[])}},N.registerExtension(Q),window.comfyAPI=window.comfyAPI||{},window.comfyAPI.groupNode=window.comfyAPI.groupNode||{},window.comfyAPI.groupNode.GroupNodeConfig=J,window.comfyAPI.groupNode.GroupNodeHandler=Y}));export{K as a,U as c,getWidgetConfig as i,Y as n,mergeIfValid as o,$ as r,setWidgetConfig as s,J as t};
//# sourceMappingURL=groupNode-ldGk52Ai.js.map