import{i as e,n as t}from"./rolldown-runtime-BKYq3fBv.js";import{i as n,in as r,r as i,rn as a}from"./api-CJ30itpV.js";import{r as o,s}from"./i18n-gOSvTADh.js";import{Ga as c,Ka as l,at as u,ht as d,is as f,it as p,mt as m,n as h,ns as g,qa as _,t as v}from"./dialogService-DvYmp2_F.js";import{n as y,r as b,t as x}from"./groupNode-ldGk52Ai.js";var S,C,ManageTemplates,w,clipboardAction,T;t((()=>{f(),o(),a(),v(),d(),n(),u(),_(),b(),S=`Comfy.NodeTemplates`,C=`comfy.templates.json`,ManageTemplates=class extends l{templates=[];draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add(`comfy-manage-templates`),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src=`data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=`,this.importInput=c(`input`,{type:`file`,accept:`.json`,multiple:!0,style:{display:`none`},parent:document.body,onchange:()=>this.importAll()})}createButtons(){let e=super.createButtons();return e[0].textContent=`Close`,e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(c(`button`,{type:`button`,textContent:`Export`,onclick:()=>this.exportAll()})),e.unshift(c(`button`,{type:`button`,textContent:`Import`,onclick:()=>{this.importInput.click()}})),e}async load(){let e=[],t=await i.getUserData(C);if(t.status===200)try{e=await t.json()}catch{}else t.status!==404&&console.error(t.status+` `+t.statusText);return e??[]}async store(){let e=JSON.stringify(this.templates,void 0,4);try{await i.storeUserData(C,e,{stringify:!1})}catch(e){console.error(e),r().addAlert(e.message)}}async importAll(){for(let e of this.importInput.files)if(e.type===`application/json`||e.name.endsWith(`.json`)){let t=new FileReader;t.onload=async()=>{let e=JSON.parse(t.result);if(e?.templates){for(let t of e.templates)t?.name&&t?.data&&this.templates.push(t);await this.store()}},await t.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){r().addAlert(s(`toastMessages.noTemplatesToExport`));return}let e=JSON.stringify({templates:this.templates},null,2);g(`node_templates.json`,new Blob([e],{type:`application/json`}))}show(){super.show(c(`div`,{},this.templates.flatMap((e,t)=>{let n;return[c(`div`,{dataset:{id:t.toString()},className:`templateManagerRow`,style:{display:`grid`,gridTemplateColumns:`1fr auto`,border:`1px dashed transparent`,gap:`5px`,backgroundColor:`var(--comfy-menu-bg)`},ondragstart:e=>{this.draggedEl=e.currentTarget,e.currentTarget.style.opacity=`0.6`,e.currentTarget.style.border=`1px dashed yellow`,e.dataTransfer.effectAllowed=`move`,e.dataTransfer.setDragImage(this.emptyImg,0,0)},ondragend:e=>{e.target.style.opacity=`1`,e.currentTarget.style.border=`1px dashed transparent`,e.currentTarget.removeAttribute(`draggable`),this.element.querySelectorAll(`.templateManagerRow`).forEach((e,t)=>{var n=Number.parseInt(e.dataset.id);e==this.draggedEl&&n!=t&&this.templates.splice(t,0,this.templates.splice(n,1)[0]),e.dataset.id=t.toString()}),this.store()},ondragover:e=>{if(e.preventDefault(),e.currentTarget==this.draggedEl)return;let t=e.currentTarget.getBoundingClientRect();e.clientY>t.top+t.height/2?e.currentTarget.parentNode.insertBefore(this.draggedEl,e.currentTarget.nextSibling):e.currentTarget.parentNode.insertBefore(this.draggedEl,e.currentTarget)}},[c(`label`,{textContent:`Name: `,style:{cursor:`grab`},onmousedown:e=>{e.target.localName==`label`&&(e.currentTarget.parentNode.draggable=`true`)}},[c(`input`,{value:e.name,dataset:{name:e.name},style:{transitionProperty:`background-color`,transitionDuration:`0s`},onchange:e=>{clearTimeout(this.saveVisualCue);var t=e.target,n=t.parentNode.parentNode;this.templates[n.dataset.id].name=t.value.trim()||`untitled`,this.store(),t.style.backgroundColor=`rgb(40, 95, 40)`,t.style.transitionDuration=`0s`,this.saveVisualCue=setTimeout(function(){t.style.transitionDuration=`.7s`,t.style.backgroundColor=`var(--comfy-input-bg)`},15)},onkeypress:e=>{var t=e.target;clearTimeout(this.saveVisualCue),t.style.transitionDuration=`0s`,t.style.backgroundColor=`var(--comfy-input-bg)`},$:e=>n=e})]),c(`div`,{},[c(`button`,{textContent:`Export`,style:{fontSize:`12px`,fontWeight:`normal`},onclick:()=>{let t=JSON.stringify({templates:[e]},null,2),r=new Blob([t],{type:`application/json`});g((n.value||e.name)+`.json`,r)}}),c(`button`,{textContent:`Delete`,style:{fontSize:`12px`,color:`red`,fontWeight:`normal`},onclick:e=>{let t=e.target.parentNode.parentNode;t.parentNode.removeChild(t),this.templates.splice(t.dataset.id*1,1),this.store();var n=this;setTimeout(function(){n.element.querySelectorAll(`.templateManagerRow`).forEach((e,t)=>{e.dataset.id=t.toString()})},0)}})])])]})))}},w=new ManageTemplates,clipboardAction=async e=>{let t=localStorage.getItem(`litegrapheditor_clipboard`);await e(),localStorage.setItem(`litegrapheditor_clipboard`,t)},T={name:S,getCanvasMenuItems(e){let t=[];t.push(null),t.push({content:`Save Selected as Template`,disabled:!Object.keys(p.canvas.selected_nodes||{}).length,callback:async()=>{let e=await h().prompt({title:s(`nodeTemplates.saveAsTemplate`),message:s(`nodeTemplates.enterName`),defaultValue:``});e?.trim()&&clipboardAction(()=>{p.canvas.copyToClipboard();let t=localStorage.getItem(`litegrapheditor_clipboard`);t=JSON.parse(t||`{}`);let n=Object.keys(p.canvas.selected_nodes);for(let e=0;e<n.length;e++){let r=p.canvas.graph?.getNodeById(n[e]),i=r?.constructor.nodeData;if(!r)continue;let a=y.getGroupData(r);if(a){let n=a.nodeData;if(t.groupNodes||={},i==null)throw TypeError(`nodeData is not set`);t.groupNodes[i.name]=n,t.nodes[e].type=i.name}}w.templates.push({name:e,data:JSON.stringify(t)}),w.store()})}});let n=w.templates.map(e=>({content:e.name,callback:()=>{clipboardAction(async()=>{let t=JSON.parse(e.data);await x.registerFromWorkflow(t.groupNodes??{},[]),t.reroutes?(localStorage.setItem(`litegrapheditor_clipboard`,e.data),p.canvas.pasteFromClipboard()):m(e.data,p.canvas)})}}));return n.push(null,{content:`Manage`,callback:()=>w.show()}),t.push({content:`Node Templates`,submenu:{options:n}}),t}},p.registerExtension(T)}))();
//# sourceMappingURL=nodeTemplates-DUDiWGdC.js.map