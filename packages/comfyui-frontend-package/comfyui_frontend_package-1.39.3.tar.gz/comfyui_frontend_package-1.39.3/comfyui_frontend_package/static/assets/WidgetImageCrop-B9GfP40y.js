import{i as e,n as t}from"./rolldown-runtime-BKYq3fBv.js";import{$n as n,Cr as r,Fr as i,Gn as a,Mr as o,Nn as s,Pr as c,Tr as l,Un as u,Vn as d,Xn as f,Xr as p,Zn as m,ai as h,ar as g,br as _,er as v,li as y,mr as b,si as x,sr as S,ui as C,zr as w}from"./vendor-primevue-Cg-HmKZY.js";import{In as T,fn as E}from"./vendor-other-CoxDvJ0a.js";import{at as D,en as O,it as k,tn as A}from"./dialogService-DvYmp2_F.js";import{n as j,t as M}from"./WidgetBoundingBox-Dp-sBDFW.js";function useImageCrop(e,t){let{imageEl:n,containerEl:r,modelValue:a}=t,o=A(),s=p(null),c=p(null),l=p(!1),u=p(0),d=p(0),m=p(0),h=p(0),g=p(1),v=p(0),y=p(0),b=f({get:()=>a.value.x,set:e=>{a.value.x=e}}),x=f({get:()=>a.value.y,set:e=>{a.value.y=e}}),S=f({get:()=>a.value.width||512,set:e=>{a.value.width=e}}),C=f({get:()=>a.value.height||512,set:e=>{a.value.height=e}}),w=p(!1),E=p(0),D=p(0),O=p(0),j=p(0),M=p(!1),L=p(null),R=p(0),z=p(0),B=p(0),V=p(0),H=p(0),U=p(0);T(r,()=>{n.value&&c.value&&updateDisplayedDimensions()});let getInputImageUrl=()=>{if(!s.value)return null;let e=s.value.getInputNode(0);if(!e)return null;let t=o.getNodeImageUrls(e);return t?.length?t[0]:null},updateImageUrl=()=>{c.value=getInputImageUrl()},updateDisplayedDimensions=()=>{if(!n.value||!r.value)return;let e=n.value,t=r.value;if(u.value=e.naturalWidth,d.value=e.naturalHeight,u.value<=0||d.value<=0){g.value=1;return}let i=t.clientWidth,a=t.clientHeight,o=u.value/d.value;o>i/a?(m.value=i,h.value=i/o,v.value=0,y.value=(a-h.value)/2):(h.value=a,m.value=a*o,v.value=(i-m.value)/2,y.value=0),u.value<=0||m.value<=0?g.value=1:g.value=m.value/u.value},getEffectiveScale=()=>{let e=r.value;if(!e||u.value<=0||m.value<=0)return 1;let t=e.getBoundingClientRect(),n=e.clientWidth;return!n||!t.width?1:m.value/n*t.width/u.value},W=f(()=>({left:`${v.value+b.value*g.value-I}px`,top:`${y.value+x.value*g.value-I}px`,width:`${S.value*g.value}px`,height:`${C.value*g.value}px`})),G=f(()=>c.value?{backgroundImage:`url(${c.value})`,backgroundSize:`${m.value}px ${h.value}px`,backgroundPosition:`-${b.value*g.value}px -${x.value*g.value}px`,backgroundRepeat:`no-repeat`}:{}),K=f(()=>{let e=v.value+b.value*g.value,t=y.value+x.value*g.value,n=S.value*g.value,r=C.value*g.value;return[{direction:`top`,class:`h-2 cursor-ns-resize`,style:{left:`${e+N}px`,top:`${t-N/2}px`,width:`${Math.max(0,n-N*2)}px`}},{direction:`bottom`,class:`h-2 cursor-ns-resize`,style:{left:`${e+N}px`,top:`${t+r-N/2}px`,width:`${Math.max(0,n-N*2)}px`}},{direction:`left`,class:`w-2 cursor-ew-resize`,style:{left:`${e-N/2}px`,top:`${t+N}px`,height:`${Math.max(0,r-N*2)}px`}},{direction:`right`,class:`w-2 cursor-ew-resize`,style:{left:`${e+n-N/2}px`,top:`${t+N}px`,height:`${Math.max(0,r-N*2)}px`}},{direction:`nw`,class:`cursor-nwse-resize rounded-sm bg-white/80`,style:{left:`${e-P/2}px`,top:`${t-P/2}px`,width:`${P}px`,height:`${P}px`}},{direction:`ne`,class:`cursor-nesw-resize rounded-sm bg-white/80`,style:{left:`${e+n-P/2}px`,top:`${t-P/2}px`,width:`${P}px`,height:`${P}px`}},{direction:`sw`,class:`cursor-nesw-resize rounded-sm bg-white/80`,style:{left:`${e-P/2}px`,top:`${t+r-P/2}px`,width:`${P}px`,height:`${P}px`}},{direction:`se`,class:`cursor-nwse-resize rounded-sm bg-white/80`,style:{left:`${e+n-P/2}px`,top:`${t+r-P/2}px`,width:`${P}px`,height:`${P}px`}}]}),handleImageLoad=()=>{l.value=!1,updateDisplayedDimensions()},handleImageError=()=>{l.value=!1,c.value=null},capturePointer=e=>e.target.setPointerCapture(e.pointerId),releasePointer=e=>e.target.releasePointerCapture(e.pointerId),handleDragStart=e=>{c.value&&(w.value=!0,E.value=e.clientX,D.value=e.clientY,O.value=b.value,j.value=x.value,capturePointer(e))},handleDragMove=e=>{if(!w.value)return;let t=getEffectiveScale();if(t===0)return;let n=(e.clientX-E.value)/t,r=(e.clientY-D.value)/t,i=u.value-S.value,a=d.value-C.value;b.value=Math.round(Math.max(0,Math.min(i,O.value+n))),x.value=Math.round(Math.max(0,Math.min(a,j.value+r)))},handleDragEnd=e=>{w.value&&(w.value=!1,releasePointer(e))},handleResizeStart=(e,t)=>{c.value&&(e.stopPropagation(),M.value=!0,L.value=t,R.value=e.clientX,z.value=e.clientY,B.value=b.value,V.value=x.value,H.value=S.value,U.value=C.value,capturePointer(e))},handleResizeMove=e=>{if(!M.value||!L.value)return;let t=getEffectiveScale();if(t===0)return;let n=L.value,r=(e.clientX-R.value)/t,i=(e.clientY-z.value)/t,a=n===`left`||n===`nw`||n===`sw`,o=n===`right`||n===`ne`||n===`se`,s=n===`top`||n===`nw`||n===`ne`,c=n===`bottom`||n===`sw`||n===`se`,l=B.value,f=V.value,p=H.value,m=U.value;if(a){let e=H.value-F,t=-B.value,n=Math.max(t,Math.min(e,r));l=B.value+n,p=H.value-n}else if(o){let e=u.value-B.value;p=Math.max(F,Math.min(e,H.value+r))}if(s){let e=U.value-F,t=-V.value,n=Math.max(t,Math.min(e,i));f=V.value+n,m=U.value-n}else if(c){let e=d.value-V.value;m=Math.max(F,Math.min(e,U.value+i))}(a||o)&&(b.value=Math.round(l),S.value=Math.round(p)),(s||c)&&(x.value=Math.round(f),C.value=Math.round(m))},handleResizeEnd=e=>{M.value&&(M.value=!1,L.value=null,releasePointer(e))},initialize=()=>{e!=null&&(s.value=k.rootGraph?.getNodeById(e)||null),updateImageUrl()};return i(()=>o.nodeOutputs,()=>updateImageUrl(),{deep:!0}),i(()=>o.nodePreviewImages,()=>updateImageUrl(),{deep:!0}),_(initialize),{imageUrl:c,isLoading:l,cropX:b,cropY:x,cropWidth:S,cropHeight:C,cropBoxStyle:W,cropImageStyle:G,resizeHandles:K,handleImageLoad,handleImageError,handleDragStart,handleDragMove,handleDragEnd,handleResizeStart,handleResizeMove,handleResizeEnd}}var N,P,F,I,L=t((()=>{E(),s(),D(),O(),N=8,P=10,F=16,I=2})),R,z,B,V,H,U,W,G=t((()=>{s(),j(),L(),R={key:0,class:`flex size-full items-center justify-center`},z={class:`text-sm`},B={key:1,class:`flex size-full flex-col items-center justify-center text-center`},V={class:`text-sm`},H=[`src`,`alt`],U=[`onPointerdown`],W=S({__name:`WidgetImageCrop`,props:b({nodeId:{}},{modelValue:{default:()=>({x:0,y:0,width:512,height:512})},modelModifiers:{}}),emits:[`update:modelValue`],setup(e){let t=e,i=o(e,`modelValue`),s=c(`imageEl`),f=c(`containerEl`),{imageUrl:p,isLoading:_,cropBoxStyle:b,cropImageStyle:S,resizeHandles:T,handleImageLoad:E,handleImageError:D,handleDragStart:O,handleDragMove:k,handleDragEnd:A,handleResizeStart:j,handleResizeMove:N,handleResizeEnd:P}=useImageCrop(t.nodeId,{imageEl:s,containerEl:f,modelValue:i});return(e,t)=>(r(),v(`div`,{class:`widget-expands relative flex h-full w-full flex-col gap-1`,onPointerdown:t[9]||=u(()=>{},[`stop`]),onPointermove:t[10]||=u(()=>{},[`stop`]),onPointerup:t[11]||=u(()=>{},[`stop`])},[m(`div`,{ref_key:`containerEl`,ref:f,class:`relative min-h-0 flex-1 overflow-hidden rounded-[5px] bg-node-component-surface`},[h(_)?(r(),v(`div`,R,[m(`span`,z,C(e.$t(`imageCrop.loading`)),1)])):h(p)?(r(),v(`img`,{key:2,ref_key:`imageEl`,ref:s,src:h(p),alt:e.$t(`imageCrop.cropPreviewAlt`),draggable:`false`,class:`block size-full object-contain select-none brightness-50`,onLoad:t[0]||=(...e)=>h(E)&&h(E)(...e),onError:t[1]||=(...e)=>h(D)&&h(D)(...e),onDragstart:t[2]||=u(()=>{},[`prevent`])},null,40,H)):(r(),v(`div`,B,[t[12]||=m(`i`,{class:`mb-2 icon-[lucide--image] h-12 w-12`},null,-1),m(`p`,V,C(e.$t(`imageCrop.noInputImage`)),1)])),h(p)&&!h(_)?(r(),v(`div`,{key:3,class:`absolute box-content cursor-move overflow-hidden border-2 border-white`,style:y(h(b)),onPointerdown:t[3]||=(...e)=>h(O)&&h(O)(...e),onPointermove:t[4]||=(...e)=>h(k)&&h(k)(...e),onPointerup:t[5]||=(...e)=>h(A)&&h(A)(...e)},[m(`div`,{class:`pointer-events-none size-full`,style:y(h(S))},null,4)],36)):n(``,!0),(r(!0),v(a,null,l(h(T),e=>w((r(),v(`div`,{key:e.direction,class:x([`absolute`,e.class]),style:y(e.style),onPointerdown:t=>h(j)(t,e.direction),onPointermove:t[6]||=(...e)=>h(N)&&h(N)(...e),onPointerup:t[7]||=(...e)=>h(P)&&h(P)(...e)},null,46,U)),[[d,h(p)&&!h(_)]])),128))],512),g(M,{modelValue:i.value,"onUpdate:modelValue":t[8]||=e=>i.value=e,class:`shrink-0`},null,8,[`modelValue`])],32))}})})),K;t((()=>{G(),G(),K=W}))();export{K as default};
//# sourceMappingURL=WidgetImageCrop-B9GfP40y.js.map