{"version":3,"file":"audioService-BaXZa7El.js","names":[],"sources":["../../src/services/audioService.ts"],"sourcesContent":["import { register } from 'extendable-media-recorder'\nimport { connect } from 'extendable-media-recorder-wav-encoder'\n\nimport { useToastStore } from '@/platform/updates/common/toastStore'\nimport { api } from '@/scripts/api'\n\nexport interface AudioRecordingError {\n  type: 'permission' | 'not_supported' | 'encoder' | 'recording' | 'unknown'\n  message: string\n  originalError?: unknown\n}\n\nlet isEncoderRegistered: boolean = false\n\nexport const useAudioService = () => {\n  const handleError = (\n    type: AudioRecordingError['type'],\n    message: string,\n    originalError?: unknown\n  ) => {\n    console.error(`Audio Service Error (${type}):`, message, originalError)\n  }\n\n  const stopAllTracks = (currentStream: MediaStream | null) => {\n    if (currentStream) {\n      currentStream.getTracks().forEach((track) => {\n        track.stop()\n      })\n      currentStream = null\n    }\n  }\n\n  const registerWavEncoder = async (): Promise<void> => {\n    if (isEncoderRegistered) {\n      return\n    }\n\n    try {\n      await register(await connect())\n      isEncoderRegistered = true\n    } catch (err) {\n      if (\n        err instanceof Error &&\n        err.message.includes('already an encoder stored')\n      ) {\n        isEncoderRegistered = true\n      } else {\n        handleError('encoder', 'Failed to register WAV encoder', err)\n      }\n    }\n  }\n\n  const convertBlobToFileAndSubmit = async (blob: Blob): Promise<string> => {\n    const name = `recording-${Date.now()}.wav`\n    const file = new File([blob], name, { type: blob.type || 'audio/wav' })\n\n    const body = new FormData()\n    body.append('image', file)\n    body.append('subfolder', 'audio')\n    body.append('type', 'temp')\n\n    const resp = await api.fetchApi('/upload/image', {\n      method: 'POST',\n      body\n    })\n\n    if (resp.status !== 200) {\n      const err = `Error uploading temp file: ${resp.status} - ${resp.statusText}`\n      useToastStore().addAlert(err)\n      throw new Error(err)\n    }\n\n    const tempAudio = await resp.json()\n\n    return `audio/${tempAudio.name} [temp]`\n  }\n\n  return {\n    // Methods\n    convertBlobToFileAndSubmit,\n    registerWavEncoder,\n    stopAllTracks\n  }\n}\n"],"mappings":"8NAAyB,IACD,IAEM,IACV,CAQhB,EAA+B,GAEtB,oBAAwB,CACnC,IAAM,aACJ,EACA,EACA,IACG,CACH,QAAQ,MAAM,wBAAwB,EAAK,IAAK,EAAS,EAAc,EAGnE,cAAiB,GAAsC,CAC3D,AAIE,KAHA,EAAc,WAAW,CAAC,QAAS,GAAU,CAC3C,EAAM,MAAM,EACZ,CACc,OAId,mBAAqB,SAA2B,CAChD,MAIJ,GAAI,CACF,MAAM,EAAS,MAAM,GAAS,CAAC,CAC/B,EAAsB,SACf,EAAK,CAEV,aAAe,OACf,EAAI,QAAQ,SAAS,4BAA4B,CAEjD,EAAsB,GAEtB,YAAY,UAAW,iCAAkC,EAAI,GAK7D,2BAA6B,KAAO,IAAgC,CACxE,IAAM,EAAO,aAAa,KAAK,KAAK,CAAC,MAC/B,EAAO,IAAI,KAAK,CAAC,EAAK,CAAE,EAAM,CAAE,KAAM,EAAK,MAAQ,YAAa,CAAC,CAEjE,EAAO,IAAI,SACjB,EAAK,OAAO,QAAS,EAAK,CAC1B,EAAK,OAAO,YAAa,QAAQ,CACjC,EAAK,OAAO,OAAQ,OAAO,CAE3B,IAAM,EAAO,MAAM,EAAI,SAAS,gBAAiB,CAC/C,OAAQ,OACR,OACD,CAAC,CAEF,GAAI,EAAK,SAAW,IAAK,CACvB,IAAM,EAAM,8BAA8B,EAAK,OAAO,KAAK,EAAK,aAEhE,MADA,GAAe,CAAC,SAAS,EAAI,CACnB,MAAM,EAAI,CAKtB,MAAO,UAFW,MAAM,EAAK,MAAM,EAET,KAAK,UAGjC,MAAO,CAEL,2BACA,mBACA,cACD"}