{"version":3,"file":"auth-XjMxGrok.js","names":[],"sources":["../../src/platform/cloud/onboarding/auth.ts"],"sourcesContent":["import * as Sentry from '@sentry/vue'\nimport { isEmpty } from 'es-toolkit/compat'\n\nimport { api } from '@/scripts/api'\n\ninterface UserCloudStatus {\n  status: 'active'\n}\n\nconst ONBOARDING_SURVEY_KEY = 'onboarding_survey'\n\n/**\n * Helper function to capture API errors with Sentry\n */\nfunction captureApiError(\n  error: Error,\n  endpoint: string,\n  errorType: 'http_error' | 'network_error',\n  httpStatus?: number,\n  operation?: string,\n  extraContext?: Record<string, any>\n) {\n  const tags: Record<string, any> = {\n    api_endpoint: endpoint,\n    error_type: errorType\n  }\n\n  if (httpStatus !== undefined) {\n    tags.http_status = httpStatus\n  }\n\n  if (operation) {\n    tags.operation = operation\n  }\n\n  const sentryOptions: any = {\n    tags,\n    extra: extraContext ? { ...extraContext } : undefined\n  }\n\n  Sentry.captureException(error, sentryOptions)\n}\n\n/**\n * Helper function to check if error is already handled HTTP error\n */\nfunction isHttpError(error: unknown, errorMessagePrefix: string): boolean {\n  return error instanceof Error && error.message.startsWith(errorMessagePrefix)\n}\n\nexport async function getUserCloudStatus(): Promise<UserCloudStatus> {\n  try {\n    const response = await api.fetchApi('/user', {\n      method: 'GET',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    })\n    if (!response.ok) {\n      const error = new Error(`Failed to get user: ${response.statusText}`)\n      captureApiError(\n        error,\n        '/user',\n        'http_error',\n        response.status,\n        undefined,\n        {\n          api: {\n            method: 'GET',\n            endpoint: '/user',\n            status_code: response.status,\n            status_text: response.statusText\n          }\n        }\n      )\n      throw error\n    }\n\n    return response.json()\n  } catch (error) {\n    // Only capture network errors (not HTTP errors we already captured)\n    if (!isHttpError(error, 'Failed to get user:')) {\n      captureApiError(error as Error, '/user', 'network_error')\n    }\n    throw error\n  }\n}\n\nexport async function getSurveyCompletedStatus(): Promise<boolean> {\n  try {\n    const response = await api.fetchApi(`/settings/${ONBOARDING_SURVEY_KEY}`, {\n      method: 'GET',\n      headers: {\n        'Content-Type': 'application/json'\n      }\n    })\n    if (!response.ok) {\n      // Not an error case - survey not completed is a valid state\n      Sentry.addBreadcrumb({\n        category: 'auth',\n        message: 'Survey status check returned non-ok response',\n        level: 'info',\n        data: {\n          status: response.status,\n          endpoint: `/settings/${ONBOARDING_SURVEY_KEY}`\n        }\n      })\n      return false\n    }\n    const data = await response.json()\n    // Check if data exists and is not empty\n    return !isEmpty(data.value)\n  } catch (error) {\n    // Network error - still capture it as it's not thrown from above\n    Sentry.captureException(error, {\n      tags: {\n        api_endpoint: '/settings/{key}',\n        error_type: 'network_error'\n      },\n      extra: {\n        route_template: '/settings/{key}',\n        route_actual: `/settings/${ONBOARDING_SURVEY_KEY}`\n      },\n      level: 'warning'\n    })\n    return false\n  }\n}\n\nexport async function submitSurvey(\n  survey: Record<string, unknown>\n): Promise<void> {\n  try {\n    Sentry.addBreadcrumb({\n      category: 'auth',\n      message: 'Submitting survey',\n      level: 'info',\n      data: {\n        survey_fields: Object.keys(survey)\n      }\n    })\n\n    const response = await api.fetchApi('/settings', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify({ [ONBOARDING_SURVEY_KEY]: survey })\n    })\n\n    if (!response.ok) {\n      const error = new Error(`Failed to submit survey: ${response.statusText}`)\n      captureApiError(\n        error,\n        '/settings',\n        'http_error',\n        response.status,\n        'submit_survey',\n        {\n          survey: {\n            field_count: Object.keys(survey).length,\n            field_names: Object.keys(survey)\n          }\n        }\n      )\n      throw error\n    }\n\n    // Log successful survey submission\n    Sentry.addBreadcrumb({\n      category: 'auth',\n      message: 'Survey submitted successfully',\n      level: 'info'\n    })\n  } catch (error) {\n    // Only capture network errors (not HTTP errors we already captured)\n    if (!isHttpError(error, 'Failed to submit survey:')) {\n      captureApiError(\n        error as Error,\n        '/settings',\n        'network_error',\n        undefined,\n        'submit_survey'\n      )\n    }\n    throw error\n  }\n}\n"],"mappings":"uLAcA,SAAS,gBACP,EACA,EACA,EACA,EACA,EACA,EACA,CACA,IAAM,EAA4B,CAChC,aAAc,EACd,WAAY,EACb,CAEG,IAAe,IAAA,KACjB,EAAK,YAAc,GAGjB,IACF,EAAK,UAAY,GAQnB,EAAwB,EALG,CACzB,OACA,MAAO,EAAe,CAAE,GAAG,EAAc,CAAG,IAAA,GAC7C,CAE4C,CAM/C,SAAS,YAAY,EAAgB,EAAqC,CACxE,OAAO,aAAiB,OAAS,EAAM,QAAQ,WAAW,EAAmB,CAG/E,eAAsB,oBAA+C,CACnE,GAAI,CACF,IAAM,EAAW,MAAM,EAAI,SAAS,QAAS,CAC3C,OAAQ,MACR,QAAS,CACP,eAAgB,mBACjB,CACF,CAAC,CACF,GAAI,CAAC,EAAS,GAAI,CAChB,IAAM,EAAY,MAAM,uBAAuB,EAAS,aAAa,CAgBrE,MAfA,gBACE,EACA,QACA,aACA,EAAS,OACT,IAAA,GACA,CACE,IAAK,CACH,OAAQ,MACR,SAAU,QACV,YAAa,EAAS,OACtB,YAAa,EAAS,WACvB,CACF,CACF,CACK,EAGR,OAAO,EAAS,MAAM,OACf,EAAO,CAKd,MAHK,YAAY,EAAO,sBAAsB,EAC5C,gBAAgB,EAAgB,QAAS,gBAAgB,CAErD,GAIV,eAAsB,0BAA6C,CACjE,GAAI,CACF,IAAM,EAAW,MAAM,EAAI,SAAS,aAAa,IAAyB,CACxE,OAAQ,MACR,QAAS,CACP,eAAgB,mBACjB,CACF,CAAC,CAgBF,OAfK,EAAS,GAeP,CAAC,GAFK,MAAM,EAAS,MAAM,EAEb,MAAM,EAbzB,EAAqB,CACnB,SAAU,OACV,QAAS,+CACT,MAAO,OACP,KAAM,CACJ,OAAQ,EAAS,OACjB,SAAU,aAAa,IACxB,CACF,CAAC,CACK,UAKF,EAAO,CAad,OAXA,EAAwB,EAAO,CAC7B,KAAM,CACJ,aAAc,kBACd,WAAY,gBACb,CACD,MAAO,CACL,eAAgB,kBAChB,aAAc,aAAa,IAC5B,CACD,MAAO,UACR,CAAC,CACK,IAIX,eAAsB,aACpB,EACe,CACf,GAAI,CACF,EAAqB,CACnB,SAAU,OACV,QAAS,oBACT,MAAO,OACP,KAAM,CACJ,cAAe,OAAO,KAAK,EAAO,CACnC,CACF,CAAC,CAEF,IAAM,EAAW,MAAM,EAAI,SAAS,YAAa,CAC/C,OAAQ,OACR,QAAS,CACP,eAAgB,mBACjB,CACD,KAAM,KAAK,UAAU,EAAG,GAAwB,EAAQ,CAAC,CAC1D,CAAC,CAEF,GAAI,CAAC,EAAS,GAAI,CAChB,IAAM,EAAY,MAAM,4BAA4B,EAAS,aAAa,CAc1E,MAbA,gBACE,EACA,YACA,aACA,EAAS,OACT,gBACA,CACE,OAAQ,CACN,YAAa,OAAO,KAAK,EAAO,CAAC,OACjC,YAAa,OAAO,KAAK,EAAO,CACjC,CACF,CACF,CACK,EAIR,EAAqB,CACnB,SAAU,OACV,QAAS,gCACT,MAAO,OACR,CAAC,OACK,EAAO,CAWd,MATK,YAAY,EAAO,2BAA2B,EACjD,gBACE,EACA,YACA,gBACA,IAAA,GACA,gBACD,CAEG,sBAzLc,IACA,IAEJ,CAMd,EAAwB"}