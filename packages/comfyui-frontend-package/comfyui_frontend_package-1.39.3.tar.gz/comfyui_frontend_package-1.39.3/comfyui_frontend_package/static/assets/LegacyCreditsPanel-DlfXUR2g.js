import{i as e,n as t}from"./rolldown-runtime-BKYq3fBv.js";import{$n as n,C as r,Cr as i,Fr as a,Gt as o,Kt as s,Nn as c,Or as l,Qn as u,Rr as d,Ut as f,Wt as p,Xn as m,Xr as h,Zn as g,_n as _,_t as v,ai as y,ar as b,er as x,g as S,gn as C,h as w,hn as T,ir as E,lt as D,nn as ee,si as O,sr as k,tn as te,ui as A,ut as j,vn as ne,vt as M,w as re,zr as ie}from"./vendor-primevue-Cg-HmKZY.js";import{nn as N,ot as P,st as F,tn as ae}from"./vendor-other-CoxDvJ0a.js";import{dt as oe,ut as se}from"./api-CJ30itpV.js";import{n as I,t as L}from"./Button-YQy7RkKq.js";import{N as ce,P as le,u as ue,y as de}from"./PanelTemplate-hGipIJT8.js";import{Ao as fe,Eo as pe,Ho as R,Mo as me,To as he,Uo as z,Vo as B,Wo as ge,an as V,in as H,jo as _e,ko as ve,n as ye,nr as be,t as xe,tr as U}from"./dialogService-DvYmp2_F.js";var W,G,K,q,J=t((()=>{c(),T(),w(),P(),be(),B(),W={key:0,class:`flex items-center gap-1`},G={class:`flex items-center gap-2`},K={key:1,class:`flex items-center gap-1`},q=k({__name:`UserCredit`,props:{textClass:{},showCreditsOnly:{type:Boolean}},setup(e){let t=R(),r=m(()=>t.isFetchingBalance),{t:a,locale:o}=F(),s=m(()=>`${U({cents:t.balance?.effective_balance_micros??t.balance?.amount_micros??0,locale:o.value})} ${a(`credits.credits`)}`),c=m(()=>U({cents:t.balance?.effective_balance_micros??t.balance?.amount_micros??0,locale:o.value,numberOptions:{minimumFractionDigits:0,maximumFractionDigits:0}}));return(e,t)=>r.value?(i(),x(`div`,W,[g(`div`,G,[b(y(C),{shape:`circle`,width:`1.5rem`,height:`1.5rem`})]),t[0]||=g(`div`,{class:`flex-1`},null,-1),b(y(C),{width:`8rem`,height:`2rem`})])):(i(),x(`div`,K,[e.showCreditsOnly?n(``,!0):(i(),u(y(S),{key:0,severity:`secondary`,rounded:``,class:`p-1 text-amber-400`},{icon:d(()=>t[1]||=[g(`i`,{class:`icon-[lucide--component]`},null,-1)]),_:1})),g(`div`,{class:O(e.textClass)},A(e.showCreditsOnly?c.value:s.value),3)]))}})})),Y,Se=t((()=>{J(),J(),Y=q})),X,Z,useCustomerEventsService,Ce=t((()=>{ae(),c(),P(),ge(),B(),se(),X=function(e){return e.CREDIT_ADDED=`credit_added`,e.ACCOUNT_CREATED=`account_created`,e.API_USAGE_STARTED=`api_usage_started`,e.API_USAGE_COMPLETED=`api_usage_completed`,e}({}),Z=N.create({baseURL:z(),headers:{"Content-Type":`application/json`}}),useCustomerEventsService=()=>{let e=h(!1),t=h(null),{d:n}=F();a(()=>z(),e=>{Z.defaults.baseURL=e});let handleRequestError=(e,n,r)=>{if(oe(e))return;let i;if(!N.isAxiosError(e))i=`${n} failed: ${e instanceof Error?e.message:String(e)}`;else{let t=e,a=t.response?.status;i=a&&r?.[a]?r[a]:t.response?.data?.message??`${n} failed with status ${a}`}t.value=i},executeRequest=async(n,r)=>{let{errorContext:i,routeSpecificErrors:a}=r;e.value=!0,t.value=null;try{return(await n()).data}catch(e){return handleRequestError(e,i,a),null}finally{e.value=!1}};function formatEventType(e){switch(e){case`credit_added`:return`Credits Added`;case`account_created`:return`Account Created`;case`api_usage_completed`:return`API Usage`;default:return e}}function formatDate(e){return n(new Date(e),{month:`short`,day:`numeric`,hour:`2-digit`,minute:`2-digit`})}function formatJsonKey(e){return e.split(`_`).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(` `)}function formatJsonValue(e){return typeof e==`number`?e.toLocaleString():typeof e==`string`&&e.match(/^\d{4}-\d{2}-\d{2}/)?new Date(e).toLocaleString():e}function getEventSeverity(e){switch(e){case`credit_added`:return`success`;case`account_created`:return`info`;case`api_usage_completed`:return`warning`;default:return`info`}}function hasAdditionalInfo(e){let{amount:t,api_name:n,model:r,...i}=e.params||{};return Object.keys(i).length>0}function getTooltipContent(e){let{...t}=e.params||{};return Object.entries(t).map(([e,t])=>`<strong>${formatJsonKey(e)}:</strong> ${formatJsonValue(t)}`).join(`<br>`)}function formatAmount(e){return e?(e/100).toFixed(2):`0.00`}async function getMyEvents({page:e=1,limit:n=10}={}){let r={400:`Invalid input, object invalid`,404:`Not found`},i=await R().getAuthHeader();return i?await executeRequest(()=>Z.get(`/customers/events`,{params:{page:e,limit:n},headers:i}),{errorContext:`Fetching customer events`,routeSpecificErrors:r}):(t.value=`Authentication header is missing`,null)}return{isLoading:e,error:t,getMyEvents,formatEventType,getEventSeverity,formatAmount,hasAdditionalInfo,formatDate,formatJsonKey,formatJsonValue,getTooltipContent}}})),Q,we,Te,Ee,De,Oe,ke,Ae,je,Me=t((()=>{c(),te(),v(),D(),_(),o(),I(),H(),Ce(),Q={key:0,class:`flex items-center justify-center p-8`},we={key:1,class:`p-4`},Te={class:`event-details`},Ee={key:0,class:`font-semibold text-green-500`},De={key:1},Oe={key:2,class:`flex flex-col gap-1`},ke={class:`font-semibold`},Ae={class:`text-sm text-smoke-400`},je=k({__name:`UsageLogsTable`,setup(e,{expose:t}){let r=h([]),a=h(!0),o=h(null),c=useCustomerEventsService(),f=h({page:1,limit:7,total:0,totalPages:0}),p=m(()=>(f.value.page-1)*f.value.limit),_=m(()=>{let e=new Map;return r.value.forEach(t=>{c.hasAdditionalInfo(t)&&t.event_id&&e.set(t.event_id,c.getTooltipContent(t))}),e}),loadEvents=async()=>{a.value=!0,o.value=null;try{let e=await c.getMyEvents({page:f.value.page,limit:f.value.limit});e?(e.events&&(r.value=e.events),e.page&&(f.value.page=e.page),e.limit&&(f.value.limit=e.limit),e.total&&(f.value.total=e.total),e.totalPages&&(f.value.totalPages=e.totalPages),V()?.checkForCompletedTopup(e.events)):o.value=c.error.value||`Failed to load events`}catch(e){o.value=e instanceof Error?e.message:`Unknown error`,console.error(`Error loading events:`,e)}finally{a.value=!1}},onPageChange=e=>{f.value.page=e.page+1,loadEvents().catch(e=>{console.error(`Error loading events:`,e)})},refresh=async()=>{f.value.page=1,await loadEvents()};return t({refresh}),(e,t)=>{let m=l(`tooltip`);return i(),x(`div`,null,[a.value?(i(),x(`div`,Q,[b(y(s))])):o.value?(i(),x(`div`,we,[b(y(ne),{severity:`error`,closable:!1},{default:d(()=>[E(A(o.value),1)]),_:1})])):(i(),u(y(j),{key:2,value:r.value,paginator:!0,rows:f.value.limit,"total-records":f.value.total,first:p.value,lazy:!0,class:`p-datatable-sm custom-datatable`,onPage:onPageChange},{default:d(()=>[b(y(M),{field:`event_type`,header:e.$t(`credits.eventType`)},{body:d(({data:e})=>[b(y(ee),{value:y(c).formatEventType(e.event_type),severity:y(c).getEventSeverity(e.event_type)},null,8,[`value`,`severity`])]),_:1},8,[`header`]),b(y(M),{field:`details`,header:e.$t(`credits.details`)},{body:d(({data:t})=>[g(`div`,Te,[t.event_type===y(X).CREDIT_ADDED?(i(),x(`div`,Ee,A(e.$t(`credits.added`))+` $`+A(y(c).formatAmount(t.params?.amount)),1)):t.event_type===y(X).ACCOUNT_CREATED?(i(),x(`div`,De,A(e.$t(`credits.accountInitialized`)),1)):t.event_type===y(X).API_USAGE_COMPLETED?(i(),x(`div`,Oe,[g(`div`,ke,A(t.params?.api_name||`API`),1),g(`div`,Ae,A(e.$t(`credits.model`))+`: `+A(t.params?.model||`-`),1)])):n(``,!0)])]),_:1},8,[`header`]),b(y(M),{field:`createdAt`,header:e.$t(`credits.time`)},{body:d(({data:e})=>[E(A(y(c).formatDate(e.createdAt)),1)]),_:1},8,[`header`]),b(y(M),{field:`params`,header:e.$t(`credits.additionalInfo`)},{body:d(({data:r})=>[y(c).hasAdditionalInfo(r)?ie((i(),u(L,{key:0,variant:`textonly`,size:`icon-sm`,"aria-label":e.$t(`credits.additionalInfo`)},{default:d(()=>t[0]||=[g(`i`,{class:`pi pi-info-circle`},null,-1)]),_:2},1032,[`aria-label`])),[[m,{escape:!1,value:_.value.get(r.event_id)||``,pt:{text:{style:{width:`max-content !important`}}}},void 0,{top:!0}]]):n(``,!0)]),_:1},8,[`header`])]),_:1},8,[`value`,`rows`,`total-records`,`first`]))])}}})})),Ne,Pe=t((()=>{Me(),Me(),Ne=je})),$,Fe,Ie,Le,Re,ze,Be,Ve,He,Ue,We,Ge,Ke,qe=t((()=>{c(),v(),D(),f(),T(),r(),Se(),Pe(),I(),ve(),ce(),_e(),H(),xe(),he(),B(),de(),$={class:`flex h-full flex-col`},Fe={class:`mb-2 text-2xl font-bold`},Ie={class:`flex flex-col gap-2`},Le={class:`text-sm font-medium text-muted`},Re={class:`flex items-center justify-between`},ze={class:`flex flex-row items-center`},Be={key:1,class:`text-xs text-muted`},Ve={class:`flex items-center justify-between`},He={key:0,class:`grow`},Ue={class:`text-sm font-medium`},We={class:`text-xs text-muted`},Ge={class:`flex flex-row gap-2`},Ke=k({__name:`LegacyCreditsPanel`,setup(e){let{buildDocsUrl:t,docsPaths:r}=le(),o=ye(),s=R(),c=fe(),l=pe(),f=V(),{isActiveSubscription:_}=me(),v=m(()=>s.loading),S=m(()=>s.isFetchingBalance),w=h(null),T=m(()=>s.lastBalanceUpdateTime?s.lastBalanceUpdateTime.toLocaleString():``);a(()=>s.lastBalanceUpdateTime,(e,t)=>{e&&e!==t&&w.value&&w.value.refresh()});let handlePurchaseCreditsClick=()=>{V()?.trackAddApiCreditButtonClicked(),o.showTopUpCreditsDialog()},handleCreditsHistoryClick=async()=>{await c.accessBillingPortal()},handleMessageSupport=async()=>{f?.trackHelpResourceClicked({resource_type:`help_feedback`,is_external:!0,source:`credits_panel`}),await l.execute(`Comfy.ContactSupport`)},handleFaqClick=()=>{window.open(t(`/tutorials/api-nodes/faq`,{includeLocale:!0}),`_blank`)},handleOpenPartnerNodesInfo=()=>{window.open(t(r.partnerNodesPricing,{includeLocale:!0}),`_blank`)},D=h([]);return(e,t)=>(i(),u(y(re),{value:`Credits`,class:`credits-container h-full`},{default:d(()=>[g(`div`,$,[g(`h2`,Fe,A(e.$t(`credits.credits`)),1),b(y(p)),g(`div`,Ie,[g(`h3`,Le,A(e.$t(`credits.yourCreditBalance`)),1),g(`div`,Re,[b(Y,{"text-class":`text-3xl font-bold`}),v.value?(i(),u(y(C),{key:0,width:`2rem`,height:`2rem`})):y(_)?(i(),u(L,{key:1,loading:v.value,onClick:handlePurchaseCreditsClick},{default:d(()=>[E(A(e.$t(`credits.purchaseCredits`)),1)]),_:1},8,[`loading`])):n(``,!0)]),g(`div`,ze,[S.value?(i(),u(y(C),{key:0,width:`12rem`,height:`1rem`,class:`text-xs`})):T.value?(i(),x(`div`,Be,A(e.$t(`credits.lastUpdated`))+`: `+A(T.value),1)):n(``,!0),b(L,{variant:`muted-textonly`,size:`icon-sm`,"aria-label":e.$t(`g.refresh`),onClick:t[0]||=()=>y(c).fetchBalance()},{default:d(()=>t[1]||=[g(`i`,{class:`pi pi-refresh`},null,-1)]),_:1},8,[`aria-label`])])]),g(`div`,Ve,[g(`h3`,null,A(e.$t(`credits.activity`)),1),b(L,{variant:`muted-textonly`,loading:v.value,onClick:handleCreditsHistoryClick},{default:d(()=>[t[2]||=g(`i`,{class:`pi pi-arrow-up-right`},null,-1),E(` `+A(e.$t(`credits.invoiceHistory`)),1)]),_:1},8,[`loading`])]),D.value.length>0?(i(),x(`div`,He,[b(y(j),{value:D.value,"show-headers":!1},{default:d(()=>[b(y(M),{field:`title`,header:e.$t(`g.name`)},{body:d(({data:e})=>[g(`div`,Ue,A(e.title),1),g(`div`,We,A(e.timestamp),1)]),_:1},8,[`header`]),b(y(M),{field:`amount`,header:e.$t(`g.amount`)},{body:d(({data:e})=>[g(`div`,{class:O([`text-center text-base font-medium`,e.isPositive?`text-sky-500`:`text-red-400`])},A(e.isPositive?`+`:`-`)+`$`+A(y(ue)(e.amount,`usd`)),3)]),_:1},8,[`header`])]),_:1},8,[`value`])])):n(``,!0),b(y(p)),b(Ne,{ref_key:`usageLogsTableRef`,ref:w},null,512),g(`div`,Ge,[b(L,{variant:`muted-textonly`,onClick:handleFaqClick},{default:d(()=>[t[3]||=g(`i`,{class:`pi pi-question-circle`},null,-1),E(` `+A(e.$t(`credits.faqs`)),1)]),_:1}),b(L,{variant:`muted-textonly`,onClick:handleOpenPartnerNodesInfo},{default:d(()=>[t[4]||=g(`i`,{class:`pi pi-question-circle`},null,-1),E(` `+A(e.$t(`subscription.partnerNodesCredits`)),1)]),_:1}),b(L,{variant:`muted-textonly`,onClick:handleMessageSupport},{default:d(()=>[t[5]||=g(`i`,{class:`pi pi-comments`},null,-1),E(` `+A(e.$t(`credits.messageSupport`)),1)]),_:1})])])]),_:1}))}})})),Je;t((()=>{qe(),qe(),Je=Ke}))();export{Je as default};
//# sourceMappingURL=LegacyCreditsPanel-DlfXUR2g.js.map