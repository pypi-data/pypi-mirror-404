{"version":3,"file":"cloudSessionCookie-BX0BTRc5.js","names":[],"sources":["../../src/platform/auth/session/useSessionCookie.ts","../../src/extensions/core/cloudSessionCookie.ts"],"sourcesContent":["import { useFeatureFlags } from '@/composables/useFeatureFlags'\nimport { isCloud } from '@/platform/distribution/types'\nimport { api } from '@/scripts/api'\nimport { useFirebaseAuthStore } from '@/stores/firebaseAuthStore'\n\n/**\n * Session cookie management for cloud authentication.\n * Creates and deletes session cookies on the ComfyUI server.\n */\nexport const useSessionCookie = () => {\n  /**\n   * Creates or refreshes the session cookie.\n   * Called after login and on token refresh.\n   *\n   * When team_workspaces_enabled is true, uses Firebase token directly\n   * (since getAuthHeader() returns workspace token which shouldn't be used for session creation).\n   * When disabled, uses getAuthHeader() for backward compatibility.\n   */\n  const createSession = async (): Promise<void> => {\n    if (!isCloud) return\n\n    const { flags } = useFeatureFlags()\n    try {\n      const authStore = useFirebaseAuthStore()\n\n      let authHeader: Record<string, string>\n\n      if (flags.teamWorkspacesEnabled) {\n        const firebaseToken = await authStore.getIdToken()\n        if (!firebaseToken) {\n          console.warn(\n            'Failed to create session cookie:',\n            'No Firebase token available for session creation'\n          )\n          return\n        }\n        authHeader = { Authorization: `Bearer ${firebaseToken}` }\n      } else {\n        const header = await authStore.getAuthHeader()\n        if (!header) {\n          console.warn(\n            'Failed to create session cookie:',\n            'No auth header available for session creation'\n          )\n          return\n        }\n        authHeader = header\n      }\n\n      const response = await fetch(api.apiURL('/auth/session'), {\n        method: 'POST',\n        credentials: 'include',\n        headers: {\n          ...authHeader,\n          'Content-Type': 'application/json'\n        }\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        console.warn(\n          'Failed to create session cookie:',\n          errorData.message || response.statusText\n        )\n      }\n    } catch (error) {\n      console.warn('Failed to create session cookie:', error)\n    }\n  }\n\n  /**\n   * Deletes the session cookie.\n   * Called on logout.\n   */\n  const deleteSession = async (): Promise<void> => {\n    if (!isCloud) return\n\n    try {\n      const response = await fetch(api.apiURL('/auth/session'), {\n        method: 'DELETE',\n        credentials: 'include'\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        console.warn(\n          'Failed to delete session cookie:',\n          errorData.message || response.statusText\n        )\n      }\n    } catch (error) {\n      console.warn('Failed to delete session cookie:', error)\n    }\n  }\n\n  return {\n    createSession,\n    deleteSession\n  }\n}\n","import { useSessionCookie } from '@/platform/auth/session/useSessionCookie'\nimport { useExtensionService } from '@/services/extensionService'\n\n/**\n * Cloud-only extension that manages session cookies for authentication.\n * Creates session cookie on login, refreshes it when token refreshes, and deletes on logout.\n */\nuseExtensionService().registerExtension({\n  name: 'Comfy.Cloud.SessionCookie',\n\n  onAuthUserResolved: async () => {\n    const { createSession } = useSessionCookie()\n    await createSession()\n  },\n\n  onAuthTokenRefreshed: async () => {\n    const { createSession } = useSessionCookie()\n    await createSession()\n  },\n\n  onAuthUserLogout: async () => {\n    const { deleteSession } = useSessionCookie()\n    await deleteSession()\n  }\n})\n"],"mappings":"4RAAgC,IACR,IACJ,IACiB,CAMxB,qBAAyB,CASpC,IAAM,cAAgB,SAA2B,CAC/C,GAAI,CAAC,EAAS,OAEd,GAAM,CAAE,SAAU,GAAiB,CACnC,GAAI,CACF,IAAM,EAAY,GAAsB,CAEpC,EAEJ,GAAI,EAAM,sBAAuB,CAC/B,IAAM,EAAgB,MAAM,EAAU,YAAY,CAClD,GAAI,CAAC,EAAe,CAClB,QAAQ,KACN,mCACA,mDACD,CACD,OAEF,EAAa,CAAE,cAAe,UAAU,IAAiB,KACpD,CACL,IAAM,EAAS,MAAM,EAAU,eAAe,CAC9C,GAAI,CAAC,EAAQ,CACX,QAAQ,KACN,mCACA,gDACD,CACD,OAEF,EAAa,EAGf,IAAM,EAAW,MAAM,MAAM,EAAI,OAAO,gBAAgB,CAAE,CACxD,OAAQ,OACR,YAAa,UACb,QAAS,CACP,GAAG,EACH,eAAgB,mBACjB,CACF,CAAC,CAEF,GAAI,CAAC,EAAS,GAAI,CAChB,IAAM,EAAY,MAAM,EAAS,MAAM,CAAC,WAAa,EAAE,EAAE,CACzD,QAAQ,KACN,mCACA,EAAU,SAAW,EAAS,WAC/B,QAEI,EAAO,CACd,QAAQ,KAAK,mCAAoC,EAAM,GAQrD,cAAgB,SAA2B,CAC1C,KAEL,GAAI,CACF,IAAM,EAAW,MAAM,MAAM,EAAI,OAAO,gBAAgB,CAAE,CACxD,OAAQ,SACR,YAAa,UACd,CAAC,CAEF,GAAI,CAAC,EAAS,GAAI,CAChB,IAAM,EAAY,MAAM,EAAS,MAAM,CAAC,WAAa,EAAE,EAAE,CACzD,QAAQ,KACN,mCACA,EAAU,SAAW,EAAS,WAC/B,QAEI,EAAO,CACd,QAAQ,KAAK,mCAAoC,EAAM,GAI3D,MAAO,CACL,cACA,cACD,gBClG8B,IACG,CAMpC,GAAqB,CAAC,kBAAkB,CACtC,KAAM,4BAEN,mBAAoB,SAAY,CAC9B,GAAM,CAAE,iBAAkB,kBAAkB,CAC5C,MAAM,GAAe,EAGvB,qBAAsB,SAAY,CAChC,GAAM,CAAE,iBAAkB,kBAAkB,CAC5C,MAAM,GAAe,EAGvB,iBAAkB,SAAY,CAC5B,GAAM,CAAE,iBAAkB,kBAAkB,CAC5C,MAAM,GAAe,EAExB,CAAC"}