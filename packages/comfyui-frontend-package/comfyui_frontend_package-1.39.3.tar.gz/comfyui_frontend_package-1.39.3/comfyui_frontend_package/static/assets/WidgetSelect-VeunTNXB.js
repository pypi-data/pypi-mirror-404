import{i as e,n as t}from"./rolldown-runtime-BKYq3fBv.js";import{$n as n,$t as r,Cr as i,Er as a,Fr as o,Gn as s,Mr as c,Nn as l,Or as u,Pr as d,Qn as f,Qt as p,Rr as m,Tr as h,Xn as g,Xr as _,Zn as v,Zt as y,ai as b,ar as x,en as S,er as C,fr as w,hr as T,ir as E,mr as D,ri as O,si as k,sr as A,ti as ee,ui as j,wr as te,zr as ne}from"./vendor-primevue-Cg-HmKZY.js";import{Dt as re,vt as ie}from"./vendor-other-CoxDvJ0a.js";import{an as ae,i as oe,in as se,on as ce,r as le,rn as M}from"./api-CJ30itpV.js";import{r as N,s as P}from"./i18n-gOSvTADh.js";import{n as F,t as I}from"./tailwindUtil-F1kyO01s.js";import{n as ue,t as de}from"./Button-YQy7RkKq.js";import{Aa as fe,Gi as pe,Ki as L,Wi as me,aa as he,di as ge,fo as _e,ia as ve,ja as ye,mi as be,oa as xe,po as Se,qi as R,sa as Ce}from"./dialogService-DvYmp2_F.js";import{i as z,o as B,s as V}from"./widgetPropFilter-BN2p2qia.js";import{n as H,t as U}from"./layout-76mT7BZg.js";import{n as W,t as G}from"./WidgetLayoutField-Cnd0sCOy.js";import{n as we,t as Te}from"./WidgetWithControl-BUzdEyX7.js";import{c as Ee,n as De,s as Oe,t as ke}from"./LazyImage-BcC2lrC2.js";var K,q,Ae=t((()=>{r(),K={name:`SelectPlus`,extends:S,emits:[`hide`],methods:{onOverlayLeave(){this.unbindOutsideClickListener(),this.unbindScrollListener(),this.unbindResizeListener(),this.$emit(`hide`),this.overlay=null}}},q=K}));function useTransformCompatOverlayProps(e={}){return g(()=>({appendTo:`self`,...e}))}var je=t((()=>{l()})),Me,Ne,Pe=t((()=>{l(),Ae(),je(),I(),V(),H(),W(),Me={class:`absolute top-5 right-8 h-4 w-7 -translate-y-4/5 flex`},Ne=A({__name:`WidgetSelectDefault`,props:D({widget:{}},{modelValue:{default(e){return e.widget.options?.values?.[0]||``}},modelModifiers:{}}),emits:[`update:modelValue`],setup(e){let t=e,n=c(e,`modelValue`),r=useTransformCompatOverlayProps(),o=g(()=>{let e=t.widget.options;return e?.values&&Array.isArray(e.values)?e.values:[]}),s=g(()=>!!n.value&&!o.value.includes(n.value)),l=g(()=>({...B(t.widget.options,z),...r.value,...s.value?{placeholder:`${n.value}`}:{}}));return(e,t)=>(i(),f(G,{widget:e.widget},{default:m(()=>[x(q,T({modelValue:n.value,"onUpdate:modelValue":t[0]||=e=>n.value=e,invalid:s.value,filter:o.value.length>4,"auto-filter-focus":``,options:o.value},l.value,{class:b(F)(b(U),`w-full text-xs`),"aria-label":e.widget.name,size:`small`,pt:{option:`text-xs`,dropdown:`w-8`,label:b(F)(`truncate min-w-[4ch]`,e.$slots.default&&`mr-5`),overlay:`w-fit min-w-full`},"data-capture-wheel":`true`}),null,16,[`modelValue`,`invalid`,`filter`,`options`,`class`,`aria-label`,`pt`]),v(`div`,Me,[a(e.$slots,`default`)])]),_:3},8,[`widget`]))}})})),J,Fe=t((()=>{Pe(),Pe(),J=Ne})),Ie,Le,Re,ze,Be,Ve=t((()=>{l(),I(),H(),Ie={class:`min-w-0 flex-1 px-1 py-2 text-left truncate`},Le={key:0},Re={key:1},ze=[`multiple`,`disabled`,`accept`],Be=A({__name:`FormDropdownInput`,props:{isOpen:{type:Boolean,default:!1},placeholder:{default:`Select...`},items:{},selected:{},maxSelectable:{},uploadable:{type:Boolean},disabled:{type:Boolean},accept:{}},emits:[`select-click`,`file-change`],setup(e,{emit:t}){let r=e,a=t,o=g(()=>r.items.filter(e=>r.selected.has(e.id))),s=g(()=>F(`border-0 bg-component-node-widget-background outline-none text-text-secondary`,r.disabled?`cursor-not-allowed`:`hover:bg-component-node-widget-background-hovered cursor-pointer`,o.value.length>0&&`text-text-primary`));return(e,t)=>(i(),C(`div`,{class:k(b(F)(b(U),`flex text-base leading-none`,{"opacity-50 cursor-not-allowed !outline-zinc-300/10":e.disabled}))},[v(`button`,{class:k(b(F)(s.value,`flex justify-between items-center flex-1 min-w-0 h-8`,{"rounded-l-lg":e.uploadable,"rounded-lg":!e.uploadable})),onClick:t[0]||=e=>a(`select-click`,e)},[v(`span`,Ie,[o.value.length?(i(),C(`span`,Re,j(o.value.map(e=>e.label??e.name).join(`, `)),1)):(i(),C(`span`,Le,j(e.placeholder),1))]),v(`i`,{class:k([`icon-[lucide--chevron-down]`,b(F)(`mr-2 size-4 transition-transform duration-200 flex-shrink-0 text-component-node-foreground-secondary`,e.isOpen&&`rotate-180`)])},null,2)],2),e.uploadable?(i(),C(`label`,{key:0,class:k(b(F)(s.value,`relative`,`size-8 flex justify-center items-center border-l rounded-r-lg border-zinc-300/10`))},[t[2]||=v(`i`,{class:`icon-[lucide--folder-search] size-4`},null,-1),v(`input`,{type:`file`,class:`absolute inset-0 -z-1 opacity-0`,multiple:e.maxSelectable>1,disabled:e.disabled,accept:e.accept,onChange:t[1]||=e=>a(`file-change`,e)},null,40,ze)],2)):n(``,!0)],2))}})})),He,Ue=t((()=>{Ve(),Ve(),He=Be})),We,Ge,Ke,qe,Y,X,Je,Ye=t((()=>{l(),y(),I(),Ee(),We={class:`text-secondary flex gap-2 px-4`},Ge={key:0,class:`absolute top-[-2px] left-[-2px] size-2 rounded-full bg-component-node-widget-background-highlighted`},Ke=[`onClick`],qe={key:0,class:`icon-[lucide--check] size-4`},Y=`bg-transparent border-0 outline-0 ring-0 text-left`,X=`size-6 flex justify-center items-center rounded-sm cursor-pointer transition-all duration-150 hover:scale-108 hover:text-base-foreground active:scale-95`,Je=A({__name:`FormDropdownMenuActions`,props:D({searcher:{type:Function},sortOptions:{},updateKey:{}},{layoutMode:{},layoutModeModifiers:{},searchQuery:{},searchQueryModifiers:{},sortSelected:{},sortSelectedModifiers:{}}),emits:[`update:layoutMode`,`update:searchQuery`,`update:sortSelected`],setup(e){let t=c(e,`layoutMode`),r=c(e,`searchQuery`),a=c(e,`sortSelected`),o=F(`h-8 bg-zinc-500/20 rounded-lg outline outline-1 outline-offset-[-1px] outline-node-component-border transition-all duration-150`),l=d(`sortPopoverRef`),u=d(`sortTriggerRef`),f=_(!1);function toggleSortPopover(e){!l.value||!u.value||(f.value=!f.value,l.value.toggle(e,u.value))}function closeSortPopover(){f.value=!1,l.value?.hide()}function handleSortSelected(e){a.value=e.id,closeSortPopover()}return(e,c)=>(i(),C(`div`,We,[x(Oe,{modelValue:r.value,"onUpdate:modelValue":c[0]||=e=>r.value=e,searcher:e.searcher,"update-key":e.updateKey,class:k(b(F)(b(o),`hover:outline-component-node-widget-background-highlighted/80`,`focus-within:outline-component-node-widget-background-highlighted/80 focus-within:ring-0`))},null,8,[`modelValue`,`searcher`,`update-key`,`class`]),v(`button`,{ref_key:`sortTriggerRef`,ref:u,class:k(b(F)(Y,b(o),`relative w-8 flex justify-center items-center cursor-pointer`,`hover:outline-component-node-widget-background-highlighted`,`active:!scale-95`)),onClick:toggleSortPopover},[a.value===`default`?n(``,!0):(i(),C(`div`,Ge)),c[4]||=v(`i`,{class:`icon-[lucide--arrow-up-down] size-4`},null,-1)],2),x(b(p),{ref_key:`sortPopoverRef`,ref:l,dismissable:!0,"close-on-escape":!0,unstyled:``,pt:{root:{class:`absolute z-50`},content:{class:[`bg-transparent border-none p-0 pt-2 rounded-lg shadow-lg`]}},onHide:c[1]||=e=>f.value=!1},{default:m(()=>[v(`div`,{class:k(b(F)(`flex flex-col gap-2 p-2 min-w-32`,`bg-component-node-background`,`rounded-lg outline outline-offset-[-1px] outline-component-node-border`))},[(i(!0),C(s,null,h(e.sortOptions,e=>(i(),C(`button`,{key:e.name,class:k(b(F)(Y,`flex justify-between items-center h-6 cursor-pointer`,`hover:!text-blue-500`)),onClick:t=>handleSortSelected(e)},[v(`span`,null,j(e.name),1),a.value===e.id?(i(),C(`i`,qe)):n(``,!0)],10,Ke))),128))],2)]),_:1},512),v(`div`,{class:k(b(F)(b(o),`flex justify-center items-center p-1 gap-1 hover:outline-component-node-widget-background-highlighted`))},[v(`button`,{class:k(b(F)(Y,X,t.value===`list`?`bg-neutral-500/50 text-base-foreground`:``)),onClick:c[2]||=e=>t.value=`list`},c[5]||=[v(`i`,{class:`icon-[lucide--list] size-4`},null,-1)],2),v(`button`,{class:k(b(F)(Y,X,t.value===`grid`?`bg-neutral-500/50 text-base-foreground`:``)),onClick:c[3]||=e=>t.value=`grid`},c[6]||=[v(`i`,{class:`icon-[lucide--layout-grid] size-4`},null,-1)],2)],2)]))}})})),Xe,Ze=t((()=>{Ye(),Ye(),Xe=Je})),Qe,$e,et,tt=t((()=>{l(),ue(),me(),I(),Qe={class:`text-secondary mb-4 flex gap-1 px-4 justify-start`},$e=[`disabled`,`onClick`],et=A({__name:`FormDropdownMenuFilter`,props:D({filterOptions:{}},{filterSelected:{},filterSelectedModifiers:{}}),emits:[`update:filterSelected`],setup(e){let t=c(e,`filterSelected`),{isUploadButtonEnabled:r,showUploadDialog:a}=pe(),o=g(()=>e.filterOptions.length===1);return(e,c)=>(i(),C(`div`,Qe,[(i(!0),C(s,null,h(e.filterOptions,e=>(i(),C(`button`,{key:e.id,type:`button`,disabled:o.value,class:k(b(F)(`px-4 py-2 rounded-md inline-flex justify-center items-center select-none appearance-none border-0 text-base-foreground`,!o.value&&`transition-all duration-150 hover:text-base-foreground hover:bg-interface-menu-component-surface-hovered cursor-pointer active:scale-95`,!o.value&&t.value===e.id?`!bg-interface-menu-component-surface-selected text-base-foreground`:`bg-transparent`)),onClick:n=>t.value=e.id},j(e.name),11,$e))),128)),b(r)&&o.value?(i(),f(de,{key:0,class:`ml-auto`,size:`md`,variant:`textonly`,onClick:b(a)},{default:m(()=>[c[0]||=v(`i`,{class:`icon-[lucide--folder-input]`},null,-1),v(`span`,null,j(e.$t(`g.import`)),1)]),_:1},8,[`onClick`])):n(``,!0)]))}})})),nt,rt=t((()=>{tt(),tt(),nt=et})),Z,it=t((()=>{Z=Symbol(`assetKind`)})),at,ot,st,ct,lt,ut=t((()=>{l(),De(),I(),it(),at={key:0,class:`absolute top-1 left-1 size-4 rounded-full border-1 border-base-foreground bg-primary-background`},ot=[`src`],st={key:3,class:`size-full bg-gradient-to-tr from-blue-400 via-teal-500 to-green-400`},ct={class:`text-secondary block text-xs`},lt=A({__name:`FormDropdownMenuItem`,props:{index:{},selected:{type:Boolean},mediaSrc:{},name:{},label:{},metadata:{},layout:{}},emits:[`click`,`mediaLoad`],setup(e,{emit:t}){let r=e,a=t,o=_(null),s=w(Z),c=g(()=>s?.value===`video`);function handleClick(){a(`click`,r.index)}function handleImageLoad(e){if(a(`mediaLoad`,e),!e.target||!(e.target instanceof HTMLImageElement))return;let t=e.target;t.naturalWidth&&t.naturalHeight&&(o.value=`${t.naturalWidth} x ${t.naturalHeight}`)}function handleVideoLoad(e){if(a(`mediaLoad`,e),!e.target||!(e.target instanceof HTMLVideoElement))return;let t=e.target;t.videoWidth&&t.videoHeight&&(o.value=`${t.videoWidth} x ${t.videoHeight}`)}return(e,t)=>{let r=u(`tooltip`);return i(),C(`div`,{class:k(b(F)(`flex gap-1 select-none group/item cursor-pointer bg-component-node-widget-background`,`transition-all duration-150`,{"flex-col text-center":e.layout===`grid`,"flex-row text-left max-h-16 rounded-lg hover:scale-102 active:scale-98":e.layout===`list`,"flex-row text-left hover:bg-component-node-widget-background-hovered rounded-lg":e.layout===`list-small`,"ring-2 ring-component-node-widget-background-highlighted":e.layout===`list`&&e.selected})),onClick:handleClick},[e.layout===`list-small`?n(``,!0):(i(),C(`div`,{key:0,class:k(b(F)(`relative`,`w-full aspect-square overflow-hidden outline-1 outline-offset-[-1px] outline-interface-stroke`,`transition-all duration-150`,{"min-w-16 max-w-16 rounded-l-lg":e.layout===`list`,"rounded-sm group-hover/item:scale-108 group-active/item:scale-95":e.layout===`grid`,"ring-2 ring-component-node-widget-background-highlighted":e.layout===`grid`&&e.selected}))},[e.selected?(i(),C(`div`,at,t[0]||=[v(`i`,{class:`icon-[lucide--check] size-3 translate-y-[-0.5px] text-base-foreground bold`},null,-1)])):n(``,!0),e.mediaSrc&&c.value?(i(),C(`video`,{key:1,src:e.mediaSrc,class:`size-full object-cover`,preload:`metadata`,muted:``,onLoadeddata:handleVideoLoad},null,40,ot)):e.mediaSrc?(i(),f(ke,{key:2,src:e.mediaSrc,alt:e.name,"image-class":`size-full object-cover`,onLoad:handleImageLoad},null,8,[`src`,`alt`])):(i(),C(`div`,st))],2)),v(`div`,{class:k(b(F)(`flex gap-1`,{"flex-col":e.layout===`grid`,"flex-col px-4 py-1 w-full justify-center min-w-0":e.layout===`list`,"flex-row p-2 items-center justify-between w-full":e.layout===`list-small`}))},[ne((i(),C(`span`,{class:k(b(F)(`block text-xs line-clamp-2 break-words overflow-hidden`,`transition-colors duration-150`,!!e.selected&&`text-base-foreground`))},[E(j(e.label??e.name),1)],2)),[[r,e.layout===`grid`?e.label??e.name:void 0]]),v(`span`,ct,j(e.metadata||o.value),1)],2)],2)}}})})),dt,ft=t((()=>{ut(),ut(),dt=lt})),Q,pt,mt,ht,gt,_t=t((()=>{l(),I(),Ze(),rt(),ft(),Q={class:`flex max-h-[640px] w-103 flex-col rounded-lg bg-component-node-background pt-4 outline outline-offset-[-1px] outline-node-component-border`},pt={class:`relative flex h-full mt-2 overflow-y-scroll`},mt={key:0,class:`h-50 col-span-full flex items-center justify-center`},ht=[`title`,`aria-label`],gt=A({__name:`FormDropdownMenu`,props:D({items:{},isSelected:{type:Function},filterOptions:{},sortOptions:{},searcher:{type:Function},updateKey:{}},{filterSelected:{},filterSelectedModifiers:{},layoutMode:{},layoutModeModifiers:{},sortSelected:{},sortSelectedModifiers:{},searchQuery:{},searchQueryModifiers:{}}),emits:D([`item-click`],[`update:filterSelected`,`update:layoutMode`,`update:sortSelected`,`update:searchQuery`]),setup(e,{emit:t}){let r=t,a=c(e,`filterSelected`),o=c(e,`layoutMode`),l=c(e,`sortSelected`),u=c(e,`searchQuery`);return(e,t)=>(i(),C(`div`,Q,[e.filterOptions.length>0?(i(),f(nt,{key:0,"filter-selected":a.value,"onUpdate:filterSelected":t[0]||=e=>a.value=e,"filter-options":e.filterOptions},null,8,[`filter-selected`,`filter-options`])):n(``,!0),x(Xe,{"layout-mode":o.value,"onUpdate:layoutMode":t[1]||=e=>o.value=e,"sort-selected":l.value,"onUpdate:sortSelected":t[2]||=e=>l.value=e,"search-query":u.value,"onUpdate:searchQuery":t[3]||=e=>u.value=e,"sort-options":e.sortOptions,searcher:e.searcher,"update-key":e.updateKey},null,8,[`layout-mode`,`sort-selected`,`search-query`,`sort-options`,`searcher`,`update-key`]),v(`div`,pt,[v(`div`,{class:k(b(F)(`h-full max-h-full grid gap-x-2 gap-y-4 overflow-y-auto px-4 pt-4 pb-4 w-full`,{"grid-cols-4":o.value===`grid`,"grid-cols-1 gap-y-2":o.value===`list`,"grid-cols-1 gap-y-1":o.value===`list-small`}))},[t[4]||=v(`div`,{class:`pointer-events-none absolute inset-x-3 top-0 z-10 h-5`},null,-1),e.items.length===0?(i(),C(`div`,mt,[v(`i`,{title:e.$t(`g.noItems`),"aria-label":e.$t(`g.noItems`),class:`icon-[lucide--circle-off] size-30 text-zinc-500/20`},null,8,ht)])):n(``,!0),(i(!0),C(s,null,h(e.items,(t,n)=>(i(),f(dt,{key:t.id,index:n,selected:e.isSelected(t,n),"media-src":t.mediaSrc,name:t.name,label:t.label,metadata:t.metadata,layout:o.value,onClick:e=>r(`item-click`,t,n)},null,8,[`index`,`selected`,`media-src`,`name`,`label`,`metadata`,`layout`,`onClick`]))),128))],2)])]))}})})),vt,yt=t((()=>{_t(),_t(),vt=gt}));async function defaultSearcher(e,t){if(e.trim()===``)return t;let n=e.trim().toLowerCase().split(` `);return t.filter(e=>{let t=e.name.toLowerCase();return n.every(e=>t.includes(e))})}function getDefaultSortOptions(){return[{name:`Default`,id:`default`,sorter:({items:e})=>e.slice()},{name:`A-Z`,id:`a-z`,sorter:({items:e})=>e.slice().sort((e,t)=>{let n=e.label??e.name,r=t.label??t.name;return n.localeCompare(r,void 0,{numeric:!0,sensitivity:`base`})})}]}var bt=t((()=>{})),xt,St=t((()=>{l(),y(),N(),M(),Ue(),yt(),bt(),xt=A({__name:`FormDropdown`,props:D({items:{},placeholder:{default:P(`widgets.uploadSelect.placeholder`)},multiple:{type:[Boolean,Number],default:!1},uploadable:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},accept:{},filterOptions:{default:()=>[]},sortOptions:{default:()=>getDefaultSortOptions()},isSelected:{type:Function,default:(e,t,n)=>e.has(t.id)},searcher:{type:Function,default:defaultSearcher}},{selected:{default:new Set},selectedModifiers:{},filterSelected:{default:``},filterSelectedModifiers:{},sortSelected:{default:`default`},sortSelectedModifiers:{},layoutMode:{default:`grid`},layoutModeModifiers:{},files:{default:[]},filesModifiers:{},searchQuery:{default:``},searchQueryModifiers:{}}),emits:[`update:selected`,`update:filterSelected`,`update:sortSelected`,`update:layoutMode`,`update:files`,`update:searchQuery`],setup(e){let t=e,n=c(e,`selected`),r=c(e,`filterSelected`),a=c(e,`sortSelected`),o=c(e,`layoutMode`),s=c(e,`files`),l=c(e,`searchQuery`),u=se(),f=_(),h=d(`triggerRef`),v=_(!1),y=g(()=>t.multiple===!0?1/0:typeof t.multiple==`number`?t.multiple:1),S=g(()=>t.items.map(e=>e.id).join(`|`)),w=_([]),T=g(()=>t.sortOptions.find(e=>e.id===`default`)?.sorter||(({items:e})=>e.slice())),E=g(()=>a.value===`default`?T.value:t.sortOptions.find(e=>e.id===a.value)?.sorter||T.value),D=g(()=>E.value({items:w.value})||[]);function internalIsSelected(e,r){return t.isSelected?.(n.value,e,r)??!1}let toggleDropdown=e=>{t.disabled||f.value&&h.value&&(f.value.toggle(e,h.value),v.value=!v.value)},closeDropdown=()=>{f.value&&(f.value.hide(),v.value=!1)};function handleFileChange(e){if(t.disabled)return;let n=e.target;n.files&&(s.value=Array.from(n.files)),n.value=``}function handleSelection(e,r){if(t.disabled)return;let i=n.value;if(internalIsSelected(e,r))i.delete(e.id);else if(i.size<y.value)i.add(e.id);else if(y.value===1)i.clear(),i.add(e.id);else{u.addAlert(`Maximum selection limit reached`);return}n.value=new Set(i),y.value===1&&closeDropdown()}async function customSearcher(e,n){let r=!1,i;n(()=>{r=!0,i?.()}),await t.searcher(e,t.items,e=>i=e).then(e=>{r||(w.value=e)})}return(e,t)=>(i(),C(`div`,{ref_key:`triggerRef`,ref:h},[x(He,{files:s.value,"is-open":v.value,placeholder:e.placeholder,items:e.items,"max-selectable":y.value,selected:n.value,uploadable:e.uploadable,disabled:e.disabled,accept:e.accept,onSelectClick:toggleDropdown,onFileChange:handleFileChange},null,8,[`files`,`is-open`,`placeholder`,`items`,`max-selectable`,`selected`,`uploadable`,`disabled`,`accept`]),x(b(p),{ref_key:`popoverRef`,ref:f,dismissable:!0,"close-on-escape":!0,unstyled:``,pt:{root:{class:`absolute z-50`},content:{class:[`bg-transparent border-none p-0 pt-2 rounded-lg shadow-lg`]}},onHide:t[4]||=e=>v.value=!1},{default:m(()=>[x(vt,{"filter-selected":r.value,"onUpdate:filterSelected":t[0]||=e=>r.value=e,"layout-mode":o.value,"onUpdate:layoutMode":t[1]||=e=>o.value=e,"sort-selected":a.value,"onUpdate:sortSelected":t[2]||=e=>a.value=e,"search-query":l.value,"onUpdate:searchQuery":t[3]||=e=>l.value=e,"filter-options":e.filterOptions,"sort-options":e.sortOptions,disabled:e.disabled,searcher:customSearcher,items:D.value,"is-selected":internalIsSelected,"max-selectable":y.value,"update-key":S.value,onClose:closeDropdown,onItemClick:handleSelection},null,8,[`filter-selected`,`layout-mode`,`sort-selected`,`search-query`,`filter-options`,`sort-options`,`disabled`,`items`,`max-selectable`,`update-key`])]),_:1},512)],512))}})})),Ct,wt=t((()=>{St(),St(),Ct=xt}));function useAssetWidgetData(e){if(ce){let t=R(),n=Ce(),r=g(()=>{let t=O(e);return t?n.getCategoryForNodeType(t):void 0}),i=g(()=>{let n=O(e);return n?t.getAssets(n)??[]:[]}),a=g(()=>{let n=O(e);return n?t.isModelLoading(n):!1}),s=g(()=>{let n=O(e);return n?t.getError(n)??null:null}),c=g(()=>(i.value??[]).map(e=>({id:e.id,name:e.user_metadata?.filename??e.name,label:e.name,mediaSrc:e.preview_url??``,metadata:``})));return o(()=>O(e),async e=>{if(!e)return;let n=t.isModelLoading(e),r=t.hasAssetKey(e);!n&&!r&&await t.updateModelsForNodeType(e)},{immediate:!0}),{category:r,assets:i,dropdownItems:c,isLoading:a,error:s}}return{category:g(()=>void 0),assets:g(()=>[]),dropdownItems:g(()=>[]),isLoading:g(()=>!1),error:g(()=>null)}}var Tt=t((()=>{l(),ae(),L(),xe()})),Et,Dt=t((()=>{l(),ie(),je(),N(),M(),wt(),it(),W(),Tt(),oe(),L(),ge(),V(),Et=A({__name:`WidgetSelectDropdown`,props:D({widget:{},nodeType:{},assetKind:{},allowUpload:{type:Boolean},uploadFolder:{},isAssetMode:{type:Boolean},defaultLayoutMode:{}},{modelValue:{default(e){return e.widget.options?.values?.[0]||``}},modelModifiers:{}}),emits:[`update:modelValue`],setup(e){let t=e;te(Z,g(()=>t.assetKind));let n=c(e,`modelValue`),r=se(),a=be(),s=useTransformCompatOverlayProps(),l=g(()=>({...B(t.widget.options,z),...s.value})),getAssetData=()=>{let e=t.widget.options?.nodeType??t.nodeType;return t.isAssetMode&&e?useAssetWidgetData(ee(e)):null},u=getAssetData(),d=_(`all`),p=g(()=>t.isAssetMode?[{id:`all`,name:re(u?.category.value??`All`)}]:[{id:`all`,name:`All`},{id:`inputs`,name:`Inputs`},{id:`outputs`,name:`Outputs`}]),h=_(new Set);function getDisplayLabel(e){let n=t.widget.options?.getOptionLabel;if(!n)return e;try{return n(e)||e}catch(t){return console.error(`Failed to map value:`,t),e}}let v=g(()=>{let e=t.widget.options?.values||[];return Array.isArray(e)?e.map((e,t)=>({id:`input-${t}`,mediaSrc:getMediaUrl(e,`input`),name:e,label:getDisplayLabel(e),metadata:``})):[]}),y=g(()=>{if(![`image`,`video`].includes(t.assetKind??``))return[];let e=new Set;return a.historyTasks.forEach(n=>{n.flatOutputs.forEach(n=>{let r=t.assetKind===`image`&&n.mediaType===`images`||t.assetKind===`video`&&n.mediaType===`video`;if(n.type===`output`&&r){let t=`${n.subfolder?`${n.subfolder}/${n.filename}`:n.filename} [output]`;e.add(t)}})}),Array.from(e).map(e=>({id:`output-${e}`,mediaSrc:getMediaUrl(e.replace(` [output]`,``),`output`),name:e,label:getDisplayLabel(e),metadata:``}))}),b=g(()=>{let e=n.value;if(!e)return;if(t.isAssetMode&&u)return u.dropdownItems.value.some(t=>t.name===e)?void 0:{id:`missing-${e}`,mediaSrc:``,name:e,label:getDisplayLabel(e),metadata:``};let r=v.value.some(t=>t.name===e),i=y.value.some(t=>t.name===e);if(r||i)return;let a=e.endsWith(` [output]`),o=a?e.replace(` [output]`,``):e;return{id:`missing-${e}`,mediaSrc:getMediaUrl(o,a?`output`:`input`),name:e,label:getDisplayLabel(e),metadata:``}}),S=g(()=>{if(t.isAssetMode&&u){let e=u.dropdownItems.value;return b.value?[b.value,...e]:e}return[...b.value?[b.value]:[],...v.value,...y.value]}),C=g(()=>{if(t.isAssetMode)return S.value;switch(d.value){case`inputs`:return v.value;case`outputs`:return y.value;case`all`:default:return S.value}}),w=g(()=>{let e=t.widget.options;if(e?.placeholder)return e.placeholder;switch(t.assetKind){case`image`:return P(`widgets.uploadSelect.placeholderImage`);case`video`:return P(`widgets.uploadSelect.placeholderVideo`);case`audio`:return P(`widgets.uploadSelect.placeholderAudio`);case`model`:return P(`widgets.uploadSelect.placeholderModel`);case`unknown`:return P(`widgets.uploadSelect.placeholderUnknown`)}return P(`widgets.uploadSelect.placeholder`)}),E=g(()=>t.isAssetMode?!1:t.allowUpload===!0),D=g(()=>{switch(t.assetKind){case`image`:return`image/*`;case`video`:return`video/*`;case`audio`:return`audio/*`;default:return}}),O=_(t.defaultLayoutMode??`grid`);o([n,C],([e,t])=>{if(e===void 0){h.value.clear();return}let n=C.value.find(t=>t.name===e);n&&(h.value.clear(),h.value.add(n.id))},{immediate:!0});function updateSelectedItems(e){let t;if(e.size>0&&(t=e.values().next().value),t==null){n.value=void 0;return}let r=C.value.find(e=>e.id===t)?.name;if(!r){n.value=void 0;return}n.value=r}let uploadFile=async(e,t=!1,n={})=>{let i=new FormData;i.append(`image`,e),t&&i.append(`subfolder`,`pasted`),n.type&&i.append(`type`,n.type);let a=await le.fetchApi(`/upload/image`,{method:`POST`,body:i});if(a.status!==200)return r.addAlert(a.status+` - `+a.statusText),null;let o=await a.json();return(n.type===`input`||!n.type&&!t)&&await R().updateInputs(),o.subfolder?`${o.subfolder}/${o.name}`:o.name},uploadFiles=async e=>{let n=t.uploadFolder??`input`,r=e.map(e=>uploadFile(e,!1,{type:n}));return(await Promise.all(r)).filter(e=>e!==null)};async function handleFilesUpdate(e){if(!(!e||e.length===0))try{let i=await uploadFiles(e);if(i.length===0){r.addAlert(`File upload failed`);return}t.widget.options?.values&&i.forEach(e=>{let n=t.widget.options.values;n.includes(e)||n.push(e)}),n.value=i[0],t.widget.callback&&t.widget.callback(i[0])}catch(e){console.error(`Upload error:`,e),r.addAlert(`Upload failed: ${e}`)}}function getMediaUrl(e,n=`input`){return[`image`,`video`].includes(t.assetKind??``)?`/api/view?filename=${encodeURIComponent(e)}&type=${n}`:``}return(e,t)=>(i(),f(G,{widget:e.widget},{default:m(()=>[x(Ct,T({selected:h.value,"onUpdate:selected":t[0]||=e=>h.value=e,"filter-selected":d.value,"onUpdate:filterSelected":t[1]||=e=>d.value=e,"layout-mode":O.value,"onUpdate:layoutMode":t[2]||=e=>O.value=e,items:C.value,placeholder:w.value,multiple:!1,uploadable:E.value,accept:D.value,"filter-options":p.value},l.value,{class:`w-full`,"onUpdate:selected":updateSelectedItems,"onUpdate:files":handleFilesUpdate}),null,16,[`selected`,`filter-selected`,`layout-mode`,`items`,`placeholder`,`uploadable`,`accept`,`filter-options`])]),_:1},8,[`widget`]))}})})),Ot,kt=t((()=>{Dt(),Dt(),Ot=Et})),At,jt=t((()=>{l(),he(),ae(),_e(),Fe(),kt(),we(),fe(),At=A({__name:`WidgetSelect`,props:D({widget:{},nodeType:{}},{modelValue:{},modelModifiers:{}}),emits:[`update:modelValue`],setup(e){let t=e,n=c(e,`modelValue`),r=g(()=>{if(t.widget.spec&&ye(t.widget.spec))return t.widget.spec}),a=g(()=>{let e=r.value;if(!e)return{kind:`unknown`,allowUpload:!1,folder:void 0};let{image_upload:t,animated_image_upload:n,video_upload:i,image_folder:a,audio_upload:o}=e,s=`unknown`;return i?s=`video`:t||n?s=`image`:o&&(s=`audio`),{kind:s,allowUpload:t===!0||n===!0||i===!0||o===!0,folder:a}}),o=g(()=>{if(ce){let e=Se().get(`Comfy.Assets.UseAssetAPI`),n=ve.isAssetBrowserEligible(t.nodeType,t.widget.name)||t.widget.type===`asset`;return e&&n}return!1}),s=g(()=>a.value.kind),l=g(()=>o.value||s.value!==`unknown`),u=g(()=>a.value.allowUpload),d=g(()=>a.value.folder??`input`),p=g(()=>o.value?`list`:`grid`);return(e,t)=>l.value?(i(),f(Ot,{key:0,modelValue:n.value,"onUpdate:modelValue":t[0]||=e=>n.value=e,widget:e.widget,"node-type":e.widget.nodeType??e.nodeType,"asset-kind":s.value,"allow-upload":u.value,"upload-folder":d.value,"is-asset-mode":o.value,"default-layout-mode":p.value},null,8,[`modelValue`,`widget`,`node-type`,`asset-kind`,`allow-upload`,`upload-folder`,`is-asset-mode`,`default-layout-mode`])):e.widget.controlWidget?(i(),f(Te,{key:1,modelValue:n.value,"onUpdate:modelValue":t[1]||=e=>n.value=e,component:J,widget:e.widget},null,8,[`modelValue`,`widget`])):(i(),f(J,{key:2,modelValue:n.value,"onUpdate:modelValue":t[2]||=e=>n.value=e,widget:e.widget},null,8,[`modelValue`,`widget`]))}})})),$;t((()=>{jt(),jt(),$=At}))();export{$ as default};
//# sourceMappingURL=WidgetSelect-VeunTNXB.js.map