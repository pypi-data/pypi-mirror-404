{"version":3,"file":"userStore-Dm97A6Ww.js","names":[],"sources":["../../src/stores/userStore.ts"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { computed, ref, watchEffect } from 'vue'\n\nimport type { User as UserConfig } from '@/schemas/apiSchema'\nimport { api } from '@/scripts/api'\n\nexport interface User {\n  userId: string\n  username: string\n}\n\nexport const useUserStore = defineStore('user', () => {\n  /**\n   * The user config. null if not loaded.\n   */\n  const userConfig = ref<UserConfig | null>(null)\n  /**\n   * The current user id. null if not logged in or in single user mode.\n   */\n  const currentUserId = ref<string | null>(null)\n  const isMultiUserServer = computed(\n    () => userConfig.value && 'users' in userConfig.value\n  )\n  const needsLogin = computed(\n    () => !currentUserId.value && isMultiUserServer.value\n  )\n  const users = computed<User[]>(() =>\n    Object.entries(userConfig.value?.users ?? {}).map(([userId, username]) => ({\n      userId,\n      username\n    }))\n  )\n  const currentUser = computed<User | null>(\n    () =>\n      users.value.find((user) => user.userId === currentUserId.value) ?? null\n  )\n  const initialized = computed(() => userConfig.value !== null)\n\n  /**\n   * Initialize the user store.\n   */\n  async function initialize() {\n    userConfig.value = await api.getUserConfig()\n    currentUserId.value = localStorage['Comfy.userId']\n  }\n\n  /**\n   * Create a new user.\n   *\n   * @param username - The username.\n   * @returns The new user.\n   */\n  async function createUser(username: string): Promise<User> {\n    const resp = await api.createUser(username)\n    const data = await resp.json()\n    if (resp.status >= 300) {\n      throw new Error(\n        data.error ??\n          'Error creating user: ' + resp.status + ' ' + resp.statusText\n      )\n    }\n    return {\n      userId: data,\n      username\n    }\n  }\n\n  /**\n   * Login the current user.\n   *\n   * @param user - The user.\n   */\n  async function login({\n    userId,\n    username\n  }: {\n    userId: string\n    username: string\n  }) {\n    currentUserId.value = userId\n    localStorage['Comfy.userId'] = userId\n    localStorage['Comfy.userName'] = username\n  }\n\n  watchEffect(() => {\n    if (isMultiUserServer.value && currentUserId.value) {\n      api.user = currentUserId.value\n    }\n  })\n\n  /**\n   * Logout the current user.\n   */\n  async function logout() {\n    delete localStorage['Comfy.userId']\n    delete localStorage['Comfy.userName']\n  }\n\n  return {\n    users,\n    currentUser,\n    isMultiUserServer,\n    needsLogin,\n    initialized,\n    initialize,\n    createUser,\n    login,\n    logout\n  }\n})\n"],"mappings":"yPAA4B,IACe,IAGvB,CAOP,EAAe,EAAY,WAAc,CAIpD,IAAM,EAAa,EAAuB,KAAK,CAIzC,EAAgB,EAAmB,KAAK,CACxC,EAAoB,MAClB,EAAW,OAAS,UAAW,EAAW,MACjD,CACK,EAAa,MACX,CAAC,EAAc,OAAS,EAAkB,MACjD,CACK,EAAQ,MACZ,OAAO,QAAQ,EAAW,OAAO,OAAS,EAAE,CAAC,CAAC,KAAK,CAAC,EAAQ,MAAe,CACzE,SACA,WACD,EAAE,CACJ,CACK,EAAc,MAEhB,EAAM,MAAM,KAAM,GAAS,EAAK,SAAW,EAAc,MAAM,EAAI,KACtE,CACK,EAAc,MAAe,EAAW,QAAU,KAAK,CAK7D,eAAe,YAAa,CAC1B,EAAW,MAAQ,MAAM,EAAI,eAAe,CAC5C,EAAc,MAAQ,aAAa,gBASrC,eAAe,WAAW,EAAiC,CACzD,IAAM,EAAO,MAAM,EAAI,WAAW,EAAS,CACrC,EAAO,MAAM,EAAK,MAAM,CAC9B,GAAI,EAAK,QAAU,IACjB,MAAU,MACR,EAAK,OACH,wBAA0B,EAAK,OAAS,IAAM,EAAK,WACtD,CAEH,MAAO,CACL,OAAQ,EACR,WACD,CAQH,eAAe,MAAM,CACnB,SACA,YAIC,CACD,EAAc,MAAQ,EACtB,aAAa,gBAAkB,EAC/B,aAAa,kBAAoB,EAGnC,MAAkB,CACZ,EAAkB,OAAS,EAAc,QAC3C,EAAI,KAAO,EAAc,QAE3B,CAKF,eAAe,QAAS,CACtB,OAAO,aAAa,gBACpB,OAAO,aAAa,kBAGtB,MAAO,CACL,QACA,cACA,oBACA,aACA,cACA,WACA,WACA,MACA,OACD,EACD"}