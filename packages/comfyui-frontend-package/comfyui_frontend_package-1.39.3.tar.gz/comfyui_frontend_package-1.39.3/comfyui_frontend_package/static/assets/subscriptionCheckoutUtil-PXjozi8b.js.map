{"version":3,"file":"subscriptionCheckoutUtil-PXjozi8b.js","names":[],"sources":["../../src/platform/cloud/subscription/utils/subscriptionCheckoutUtil.ts"],"sourcesContent":["import { getComfyApiBaseUrl } from '@/config/comfyApi'\nimport { t } from '@/i18n'\nimport { isCloud } from '@/platform/distribution/types'\nimport {\n  FirebaseAuthStoreError,\n  useFirebaseAuthStore\n} from '@/stores/firebaseAuthStore'\nimport type { TierKey } from '@/platform/cloud/subscription/constants/tierPricing'\nimport type { BillingCycle } from './subscriptionTierRank'\n\ntype CheckoutTier = TierKey | `${TierKey}-yearly`\n\nconst getCheckoutTier = (\n  tierKey: TierKey,\n  billingCycle: BillingCycle\n): CheckoutTier => (billingCycle === 'yearly' ? `${tierKey}-yearly` : tierKey)\n\n/**\n * Core subscription checkout logic shared between PricingTable and\n * SubscriptionRedirectView. Handles:\n * - Ensuring the user is authenticated\n * - Calling the backend checkout endpoint\n * - Normalizing error responses\n * - Opening the checkout URL in a new tab when available\n *\n * Callers are responsible for:\n * - Guarding on cloud-only behavior (isCloud)\n * - Managing loading state\n * - Wrapping with error handling (e.g. useErrorHandling)\n */\nexport async function performSubscriptionCheckout(\n  tierKey: TierKey,\n  currentBillingCycle: BillingCycle,\n  openInNewTab: boolean = true\n): Promise<void> {\n  if (!isCloud) return\n\n  const { getFirebaseAuthHeader } = useFirebaseAuthStore()\n  const authHeader = await getFirebaseAuthHeader()\n\n  if (!authHeader) {\n    throw new FirebaseAuthStoreError(t('toastMessages.userNotAuthenticated'))\n  }\n\n  const checkoutTier = getCheckoutTier(tierKey, currentBillingCycle)\n\n  const response = await fetch(\n    `${getComfyApiBaseUrl()}/customers/cloud-subscription-checkout/${checkoutTier}`,\n    {\n      method: 'POST',\n      headers: { ...authHeader, 'Content-Type': 'application/json' }\n    }\n  )\n\n  if (!response.ok) {\n    let errorMessage = 'Failed to initiate checkout'\n    try {\n      const errorData = await response.json()\n      errorMessage = errorData.message || errorMessage\n    } catch {\n      // If JSON parsing fails, try to get text response or use HTTP status\n      try {\n        const errorText = await response.text()\n        errorMessage =\n          errorText || `HTTP ${response.status} ${response.statusText}`\n      } catch {\n        errorMessage = `HTTP ${response.status} ${response.statusText}`\n      }\n    }\n\n    throw new FirebaseAuthStoreError(\n      t('toastMessages.failedToInitiateSubscription', {\n        error: errorMessage\n      })\n    )\n  }\n\n  const data = await response.json()\n\n  if (data.checkout_url) {\n    if (openInNewTab) {\n      window.open(data.checkout_url, '_blank')\n    } else {\n      globalThis.location.href = data.checkout_url\n    }\n  }\n}\n"],"mappings":"wOA8BA,eAAsB,4BACpB,EACA,EACA,EAAwB,GACT,CACf,GAAI,CAAC,EAAS,OAEd,GAAM,CAAE,yBAA0B,GAAsB,CAClD,EAAa,MAAM,GAAuB,CAEhD,GAAI,CAAC,EACH,MAAM,IAAI,EAAuB,EAAE,qCAAqC,CAAC,CAG3E,IAAM,EAAe,gBAAgB,EAAS,EAAoB,CAE5D,EAAW,MAAM,MACrB,GAAG,GAAoB,CAAC,yCAAyC,IACjE,CACE,OAAQ,OACR,QAAS,CAAE,GAAG,EAAY,eAAgB,mBAAoB,CAC/D,CACF,CAED,GAAI,CAAC,EAAS,GAAI,CAChB,IAAI,EAAe,8BACnB,GAAI,CAEF,GADkB,MAAM,EAAS,MAAM,EACd,SAAW,OAC9B,CAEN,GAAI,CAEF,EADkB,MAAM,EAAS,MAAM,EAExB,QAAQ,EAAS,OAAO,GAAG,EAAS,kBAC7C,CACN,EAAe,QAAQ,EAAS,OAAO,GAAG,EAAS,cAIvD,MAAM,IAAI,EACR,EAAE,6CAA8C,CAC9C,MAAO,EACR,CAAC,CACH,CAGH,IAAM,EAAO,MAAM,EAAS,MAAM,CAE9B,EAAK,eACH,EACF,OAAO,KAAK,EAAK,aAAc,SAAS,CAExC,WAAW,SAAS,KAAO,EAAK,+CAnFH,IACjB,IACM,IAIjB,CAMD,iBACJ,EACA,IACkB,IAAiB,SAAW,GAAG,EAAQ,SAAW"}