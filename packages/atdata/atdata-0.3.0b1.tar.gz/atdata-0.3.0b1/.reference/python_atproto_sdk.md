# Python ATProto SDK Reference

> **Source**: [MarshalX/atproto](https://github.com/MarshalX/atproto) | [Documentation](https://atproto.blue/) | [PyPI](https://pypi.org/project/atproto/)

## Overview

The `atproto` package is the community Python SDK for AT Protocol (Bluesky). It provides:

- Autogenerated models from lexicons with full type hints
- Synchronous and asynchronous XRPC clients
- Firehose data streaming
- Identity resolution (DID/Handle)
- Cryptographic utilities
- **Code generator for custom lexicon schemes**

**Version**: 0.0.65 (Dec 2025)
**Python**: 3.9 - 3.14
**License**: MIT

> Note: Until 1.0.0, compatibility between versions is not guaranteed.

## Installation

```bash
pip install atproto
```

## Package Structure

| Package | Purpose |
|---------|---------|
| `atproto_client` | XRPC client, data models, utilities |
| `atproto_core` | NSID, AT URIs, CID, CAR files, DID documents |
| `atproto_crypto` | Multibase, signature verification, DID keys |
| `atproto_firehose` | Real-time data streaming |
| `atproto_identity` | DID and handle resolution |
| `atproto_lexicon` | Lexicon parsing (parser, models) |
| `atproto_codegen` | Code generator for models/clients from lexicons |
| `atproto_cli` | CLI tool for code generation |
| `atproto_server` | Server-side JWT utilities |

## Authentication

### Basic Login

```python
from atproto import Client

# Synchronous
client = Client()
client.login('handle.bsky.social', 'app-password')

# Asynchronous
from atproto import AsyncClient
client = AsyncClient()
await client.login('handle.bsky.social', 'app-password')
```

### Session Persistence

Sessions can be exported/imported to avoid repeated authentication:

```python
# Export session
session_string = client.export_session_string()

# Import session later
client = Client()
client.login(session_string=session_string)
```

### Custom PDS

```python
client = Client(base_url='https://my-pds.example.com')
```

## Namespaced API Access

The SDK mirrors AT Protocol's NSID structure:

```python
# Core atproto methods
client.com.atproto.server.create_session(...)
client.com.atproto.repo.create_record(...)
client.com.atproto.repo.put_record(...)
client.com.atproto.repo.get_record(...)
client.com.atproto.repo.delete_record(...)

# Bluesky app methods
client.app.bsky.feed.get_timeline(...)
client.app.bsky.actor.get_profile(...)

# Chat methods
client.chat.bsky.convo.send_message(...)
```

## Creating Custom Records

This is the key functionality for atdata's ATProto integration.

### Using com.atproto.repo.createRecord

```python
from atproto import Client

client = Client()
client.login('handle', 'password')

# Create a record with a custom collection
response = client.com.atproto.repo.create_record(
    data={
        'repo': client.me.did,                    # Your DID
        'collection': 'ac.foundation.dataset.sampleSchema',  # Custom NSID
        'record': {
            '$type': 'ac.foundation.dataset.sampleSchema',
            # ... your record fields
        },
        'validate': False  # Skip lexicon validation for custom schemas
    }
)

# Response contains:
# - uri: AT URI for the record (at://did:plc:.../ac.foundation.dataset.sampleSchema/...)
# - cid: Content hash of the record
```

### Using com.atproto.repo.putRecord (Create or Update)

```python
response = client.com.atproto.repo.put_record(
    data={
        'repo': client.me.did,
        'collection': 'ac.foundation.dataset.sampleSchema',
        'rkey': 'my-schema-key',  # Explicit record key
        'record': {
            '$type': 'ac.foundation.dataset.sampleSchema',
            # ... fields
        },
        'validate': False
    }
)
```

### Getting a Record

```python
response = client.com.atproto.repo.get_record(
    params={
        'repo': 'did:plc:...',
        'collection': 'ac.foundation.dataset.sampleSchema',
        'rkey': 'my-schema-key'
    }
)
# response.value contains the record data
```

### Listing Records in a Collection

```python
response = client.com.atproto.repo.list_records(
    params={
        'repo': 'did:plc:...',
        'collection': 'ac.foundation.dataset.sampleSchema',
        'limit': 100
    }
)
# response.records is a list of records
```

### Deleting a Record

```python
client.com.atproto.repo.delete_record(
    data={
        'repo': client.me.did,
        'collection': 'ac.foundation.dataset.sampleSchema',
        'rkey': 'my-schema-key'
    }
)
```

## Key Insight: PDS is Lexicon-Agnostic

From [GitHub Discussion #3116](https://github.com/bluesky-social/atproto/discussions/3116):

> "You don't need the lexicon to parse a record, only to validate the schema. Validation can be disabled."

The PDS stores any JSON data in any collection without requiring prior knowledge of the schema. This means:

1. We can publish `ac.foundation.dataset.*` records immediately
2. Set `validate: False` to bypass lexicon validation
3. Rate limits and account bans prevent abuse, not schema enforcement

## AT URIs

Records are addressed using AT URIs:

```
at://did:plc:abcd1234/ac.foundation.dataset.sampleSchema/record-key
└──────────────────────┘ └──────────────────────────────────┘ └────────┘
       authority                    collection                   rkey
```

### Parsing AT URIs

```python
from atproto_core import AtUri

uri = AtUri.from_str('at://did:plc:abc/com.example.record/key123')
print(uri.hostname)    # did:plc:abc
print(uri.collection)  # com.example.record
print(uri.rkey)        # key123
```

## Core Utilities (atproto_core)

### NSID (Namespaced Identifier)

```python
from atproto_core import NSID

nsid = NSID.from_str('ac.foundation.dataset.sampleSchema')
print(nsid.authority)  # ac.foundation.dataset
print(nsid.name)       # sampleSchema
```

### CID (Content Identifier)

```python
from atproto_core import CID

cid = CID.decode('bafyrei...')
print(cid.version)
print(cid.codec)
```

### DID Document

```python
from atproto_core import DidDocument

doc = DidDocument(...)
pds_endpoint = doc.get_pds_endpoint()
handle = doc.get_handle()
```

## Identity Resolution

```python
from atproto_identity import IdentityResolver

resolver = IdentityResolver()

# Resolve handle to DID
did = await resolver.resolve_handle('handle.bsky.social')

# Resolve DID to DID document
doc = await resolver.resolve_did('did:plc:...')
```

## Firehose Streaming

```python
from atproto import FirehoseSubscribeReposClient, parse_subscribe_repos_message

client = FirehoseSubscribeReposClient()

def on_message(message):
    commit = parse_subscribe_repos_message(message)
    # Process commits...

client.start(on_message)
```

## Blob Upload

```python
# Upload binary data
with open('image.jpg', 'rb') as f:
    upload = client.upload_blob(f.read())

# upload.blob can be used in record fields
```

## Error Handling

```python
from atproto import exceptions

try:
    client.com.atproto.repo.get_record(...)
except exceptions.AtProtocolError as e:
    print(f"AT Protocol error: {e}")
except exceptions.NetworkError as e:
    print(f"Network error: {e}")
```

## Code Generation for Custom Lexicons

The SDK supports generating Python models from custom lexicon schemas:

```bash
# Install CLI
pip install atproto[cli]

# Generate code from lexicons (exact CLI usage TBD)
atproto codegen --lexicons ./my-lexicons --output ./generated
```

The `atproto_codegen` package can generate:
- Data models for records
- Client namespaces for queries/procedures
- Validation functions

## Relevant API Endpoints for atdata

| Endpoint | Purpose |
|----------|---------|
| `com.atproto.repo.createRecord` | Publish new schema/dataset/lens record |
| `com.atproto.repo.putRecord` | Create or update by explicit rkey |
| `com.atproto.repo.getRecord` | Fetch a specific record |
| `com.atproto.repo.listRecords` | List all records in a collection |
| `com.atproto.repo.deleteRecord` | Remove a record |
| `com.atproto.sync.getRepo` | Download full repository (CAR file) |
| `com.atproto.identity.resolveHandle` | Resolve handle to DID |

## Resources

- **Documentation**: https://atproto.blue/
- **GitHub**: https://github.com/MarshalX/atproto
- **Examples**: https://github.com/MarshalX/atproto/tree/main/examples
- **PyPI**: https://pypi.org/project/atproto/
- **Discord**: https://discord.gg/PCyVJXU9jN

## AT Protocol Specification

- **Lexicon Guide**: https://atproto.com/guides/lexicon
- **Application Guide**: https://atproto.com/guides/applications
- **SDK List**: https://atproto.com/sdks
- **API Reference**: https://docs.bsky.app/docs/api/

## Version History

- 0.0.65 (Dec 8, 2025) - Latest
- 0.0.64 (Dec 1, 2025)
- 0.0.63 (Oct 22, 2025)
