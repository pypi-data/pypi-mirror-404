"""LaTeX template generation matching the exact styling of the custom exam."""

from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime
from jinja2 import Template


@dataclass
class Problem:
    number: int
    title: str
    points: int
    content: str  # LaTeX content for the problem
    parts: list[dict] | None = None  # Optional multi-part structure
    tikz_graph: str | None = None  # Optional TikZ code for graphs


@dataclass
class Section:
    title: str
    subtitle: str | None
    points: int
    problems: list[Problem]


LATEX_TEMPLATE = r"""
\documentclass[11pt]{article}
\usepackage[margin=0.9in]{geometry}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{enumitem}
\usepackage{fancyhdr}
\usepackage{array}
\usepackage{booktabs}
\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.17}
\usepackage{xcolor}
\usepackage{tcolorbox}
\usepackage{lastpage}
\usepackage{multicol}

% Page setup
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textbf{BC Calculus Practice}}
\fancyhead[R]{<< topics_header >>}
\fancyfoot[C]{Page \thepage\ of \pageref{LastPage}}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0.5pt}

% Custom commands
\newcommand{\workspace}[1]{\vspace{#1}}
\newcommand{\integral}[1]{\displaystyle\int #1}
\newcommand{\defint}[3]{\displaystyle\int_{#1}^{#2} #3}

% Colors
\definecolor{sectionblue}{RGB}{0, 51, 102}
\definecolor{problemgray}{RGB}{245, 245, 250}

\begin{document}

% ============================================================================
% TITLE PAGE
% ============================================================================
\begin{center}
{\Huge \textbf{BC Calculus}}\\[0.2cm]
{\LARGE Practice Problems}\\[0.1cm]
{\large << topics_subtitle >>}\\[0.6cm]
\rule{\textwidth}{1pt}
\end{center}

\vspace{0.3cm}

\noindent\begin{tabular}{@{}p{0.55\textwidth}p{0.22\textwidth}p{0.18\textwidth}@{}}
\textbf{Name:} \hrulefill & \textbf{Date:} \hrulefill & \textbf{Period:} \hrulefill
\end{tabular}

\vspace{0.4cm}

\begin{tcolorbox}[colback=sectionblue!5, colframe=sectionblue, title=\textbf{Instructions}]
\begin{itemize}[leftmargin=*, itemsep=0.1cm]
\item This practice set contains \textbf{<< total_problems >> problems} (<< total_points >> points total).
\item \textbf{No calculator} unless a problem is marked \fbox{Calculator OK}.
\item Show all work. Unsupported answers receive no credit.
\item Simplify answers where possible. Exact values required unless stated otherwise.
\item You may leave answers in terms of $\pi$, $e$, $\ln$, etc.
\end{itemize}
\end{tcolorbox}

\vspace{0.3cm}

\begin{center}
\renewcommand{\arraystretch}{1.4}
\begin{tabular}{|l|c|c|}
\hline
\textbf{Section} & \textbf{Points} & \textbf{Score} \\
\hline
<<# sections >>
<< title >> & << points >> & \hspace{2cm} \\
\hline
<</ sections >>
\textbf{TOTAL} & \textbf{<< total_points >>} & \hspace{2cm} \\
\hline
\end{tabular}
\end{center}

\vspace{0.8cm}

<<# sections >>
% ============================================================================
% << title | upper >>
% ============================================================================
\begin{center}
\colorbox{sectionblue!15}{\parbox{0.95\textwidth}{\centering\Large\textbf{<< title >>} \normalsize{(<< points >> points)}}}
\end{center}

\vspace{0.5cm}

<<# problems >>
\begin{tcolorbox}[colback=problemgray, colframe=sectionblue, title=\textbf{Problem << number >>} \hfill \normalfont{[<< points >> points]}]
<< content >>
\end{tcolorbox}

<<# parts >>
\noindent\textbf{(<< label >>)} << content >> \hfill \textbf{[<< points >> pts]}

\workspace{<< workspace >>}

<</ parts >>
<<^ parts >>
\workspace{6cm}
<</ parts >>

<</ problems >>
\newpage

<</ sections >>

\vfill

\begin{center}
\rule{0.6\textwidth}{1pt}\\[0.4cm]
{\Large \textbf{END OF PRACTICE SET}}\\[0.3cm]
\textit{Review your work. Make sure all answers are simplified.}\\[0.2cm]
\textit{Generated by bcpractice}
\end{center}

\end{document}
"""


def escape_latex(text: str) -> str:
    """Escape special LaTeX characters in text (but preserve math mode)."""
    # Don't escape if it looks like LaTeX math
    if "$" in text or "\\" in text:
        return text

    replacements = {
        "&": r"\&",
        "%": r"\%",
        "#": r"\#",
        "_": r"\_",
    }
    for old, new in replacements.items():
        text = text.replace(old, new)
    return text


def sanitize_latex_content(text: str) -> str:
    """Convert problematic Unicode characters to LaTeX equivalents.

    This function is math-mode aware - it won't wrap characters in $$
    if they're already inside math mode.
    """
    # Simple replacements that don't need math mode detection
    simple_replacements = {
        "′": r"'",
        "″": r"''",
        "…": r"...",
        "—": r"---",
        "–": r"--",
        "'": r"'",
        "'": r"'",
        """: r"``",
        """: r"''",
    }

    for old, new in simple_replacements.items():
        text = text.replace(old, new)

    # Math symbols - these need the raw LaTeX command (no $$ wrapper)
    # because they might already be in math mode
    math_replacements = {
        "°": r"^\circ",
        "±": r"\pm",
        "≤": r"\leq",
        "≥": r"\geq",
        "≠": r"\neq",
        "∞": r"\infty",
        "→": r"\to",
        "←": r"\leftarrow",
        "∈": r"\in",
        "∉": r"\notin",
        "⊂": r"\subset",
        "⊃": r"\supset",
        "∪": r"\cup",
        "∩": r"\cap",
        "√": r"\sqrt{}",
        "∑": r"\sum",
        "∏": r"\prod",
        "∂": r"\partial",
        "∇": r"\nabla",
        "α": r"\alpha",
        "β": r"\beta",
        "γ": r"\gamma",
        "δ": r"\delta",
        "ε": r"\varepsilon",
        "θ": r"\theta",
        "λ": r"\lambda",
        "μ": r"\mu",
        "π": r"\pi",
        "σ": r"\sigma",
        "τ": r"\tau",
        "φ": r"\phi",
        "ω": r"\omega",
        "Δ": r"\Delta",
        "Σ": r"\Sigma",
        "Π": r"\Pi",
        "Ω": r"\Omega",
    }

    # Process text character by character, tracking math mode
    result = []
    i = 0
    in_math = False

    while i < len(text):
        char = text[i]

        # Track math mode (simple $ delimiters)
        if char == '$':
            in_math = not in_math
            result.append(char)
            i += 1
            continue

        # Check if this character needs replacement
        if char in math_replacements:
            replacement = math_replacements[char]
            if in_math:
                # Already in math mode, just use the command
                result.append(replacement)
            else:
                # Not in math mode, wrap in $$
                result.append(f"${replacement}$")
            i += 1
            continue

        result.append(char)
        i += 1

    return ''.join(result)


def render_latex(
    sections: list[Section],
    topics_header: str,
    topics_subtitle: str,
) -> str:
    """Render the LaTeX document from sections and problems."""

    total_problems = sum(len(s.problems) for s in sections)
    total_points = sum(s.points for s in sections)

    # Build context for template
    context = {
        "topics_header": escape_latex(topics_header),
        "topics_subtitle": escape_latex(topics_subtitle),
        "total_problems": total_problems,
        "total_points": total_points,
        "sections": [],
    }

    for section in sections:
        section_data = {
            "title": section.title,
            "subtitle": section.subtitle,
            "points": section.points,
            "problems": [],
        }

        for problem in section.problems:
            problem_data = {
                "number": problem.number,
                "title": problem.title,
                "points": problem.points,
                "content": problem.content,
                "parts": problem.parts or [],
            }
            section_data["problems"].append(problem_data)

        context["sections"].append(section_data)

    # Use custom delimiters to avoid conflicts with LaTeX
    template = Template(
        LATEX_TEMPLATE,
        variable_start_string="<<",
        variable_end_string=">>",
        block_start_string="<<#",
        block_end_string=">>",
        comment_start_string="<<--",
        comment_end_string="-->>",
    )

    # Manual rendering since Jinja2 doesn't have mustache-style sections
    # We'll do simple string replacement for this template
    return render_template_manual(LATEX_TEMPLATE, context)


def render_template_manual(template: str, context: dict) -> str:
    """Manually render the template with the context."""

    # Sanitize all text content first (but NOT tikz_graph - it's raw LaTeX)
    for section in context.get("sections", []):
        section["title"] = sanitize_latex_content(section.get("title", ""))
        for problem in section.get("problems", []):
            problem["content"] = sanitize_latex_content(problem.get("content", ""))
            problem["title"] = sanitize_latex_content(problem.get("title", ""))
            # Don't sanitize tikz_graph - it's already valid LaTeX
            for part in problem.get("parts", []):
                part["content"] = sanitize_latex_content(part.get("content", ""))

    # Build sections table rows - use short names for the table
    sections_table = ""
    for i, section in enumerate(context["sections"]):
        # Extract just the topic name, removing "Section X:" prefix if present
        display_title = section['title']
        if ": " in display_title:
            # Keep "Section A" part but shorten the description
            parts = display_title.split(": ", 1)
            if len(parts) == 2:
                letter = parts[0]  # "Section A"
                topic = parts[1]   # "Riemann Sums & Approximations"
                # Truncate topic if too long
                if len(topic) > 30:
                    topic = topic[:27] + "..."
                display_title = f"{letter}: {topic}"
        sections_table += f"{display_title} & {section['points']} & \\hspace{{1.5cm}} \\\\\n\\hline\n"

    # Build sections content
    sections_content = ""
    for section in context["sections"]:
        sections_content += f"""
% ============================================================================
% {section['title'].upper()}
% ============================================================================
\\begin{{center}}
\\colorbox{{sectionblue!15}}{{\\parbox{{0.95\\textwidth}}{{\\centering\\Large\\textbf{{{section['title']}}} \\normalsize{{({section['points']} points)}}}}}}
\\end{{center}}

\\vspace{{0.5cm}}

"""
        for problem in section["problems"]:
            # Build problem box content
            problem_content = problem['content']

            # Add TikZ graph if present
            tikz_graph = problem.get('tikz_graph', '')
            if tikz_graph:
                # Ensure proper centering of the graph
                graph_section = f"""

\\begin{{center}}
{tikz_graph}
\\end{{center}}
"""
                problem_content += graph_section

            # Calculate minimum space needed (problem box + workspace)
            num_parts = len(problem.get("parts", []))
            if num_parts > 0:
                min_space = "10cm"  # Problem box + first part
            else:
                min_space = "9cm"  # Problem box + workspace

            sections_content += f"""\\needspace{{{min_space}}}
\\begin{{tcolorbox}}[colback=problemgray, colframe=sectionblue, title=\\textbf{{Problem {problem['number']}}} \\hfill \\normalfont{{[{problem['points']} points]}}]
{problem_content}
\\end{{tcolorbox}}
\\nopagebreak

"""
            if problem.get("parts"):
                for idx, part in enumerate(problem["parts"]):
                    workspace = part.get("workspace", "5cm")
                    # Add needspace before each part to keep it with some workspace
                    sections_content += f"""\\needspace{{4cm}}
\\noindent\\textbf{{({part['label']})}} {part['content']} \\hfill \\textbf{{[{part['points']} pts]}}

\\workspace{{{workspace}}}

"""
            else:
                sections_content += "\\workspace{6cm}\n\n"

        sections_content += "\\newpage\n\n"

    # Build the final document
    final = f"""
\\documentclass[11pt]{{article}}
\\usepackage[margin=0.9in]{{geometry}}
\\usepackage{{amsmath, amssymb, amsthm}}
\\usepackage{{enumitem}}
\\usepackage{{fancyhdr}}
\\usepackage{{array}}
\\usepackage{{booktabs}}
\\usepackage{{tikz}}
\\usepackage{{pgfplots}}
\\pgfplotsset{{compat=1.17}}
\\usepackage{{xcolor}}
\\usepackage{{tcolorbox}}
\\usepackage{{lastpage}}
\\usepackage{{multicol}}
\\usepackage{{needspace}}

% Page setup
\\pagestyle{{fancy}}
\\fancyhf{{}}
\\fancyhead[L]{{\\textbf{{BC Calculus Practice}}}}
\\fancyhead[R]{{{context["topics_header"]}}}
\\fancyfoot[C]{{Page \\thepage\\ of \\pageref{{LastPage}}}}
\\renewcommand{{\\headrulewidth}}{{0.5pt}}
\\renewcommand{{\\footrulewidth}}{{0.5pt}}

% Custom commands
\\newcommand{{\\workspace}}[1]{{\\vspace{{#1}}}}
\\newcommand{{\\integral}}[1]{{\\displaystyle\\int #1}}
\\newcommand{{\\defint}}[3]{{\\displaystyle\\int_{{#1}}^{{#2}} #3}}

% Colors
\\definecolor{{sectionblue}}{{RGB}}{{0, 51, 102}}
\\definecolor{{problemgray}}{{RGB}}{{245, 245, 250}}

\\begin{{document}}

% ============================================================================
% TITLE PAGE
% ============================================================================
\\begin{{center}}
{{\\Huge \\textbf{{BC Calculus}}}}\\\\[0.2cm]
{{\\LARGE Practice Problems}}\\\\[0.1cm]
{{\\large {context["topics_subtitle"]}}}\\\\[0.6cm]
\\rule{{\\textwidth}}{{1pt}}
\\end{{center}}

\\vspace{{0.3cm}}

\\noindent\\begin{{tabular}}{{@{{}}p{{0.55\\textwidth}}p{{0.22\\textwidth}}p{{0.18\\textwidth}}@{{}}}}
\\textbf{{Name:}} \\hrulefill & \\textbf{{Date:}} \\hrulefill & \\textbf{{Period:}} \\hrulefill
\\end{{tabular}}

\\vspace{{0.4cm}}

\\begin{{tcolorbox}}[colback=sectionblue!5, colframe=sectionblue, title=\\textbf{{Instructions}}]
\\begin{{itemize}}[leftmargin=*, itemsep=0.1cm]
\\item This practice set contains \\textbf{{{context["total_problems"]} problems}} ({context["total_points"]} points total).
\\item \\textbf{{No calculator}} unless a problem is marked \\fbox{{Calculator OK}}.
\\item Show all work. Unsupported answers receive no credit.
\\item Simplify answers where possible. Exact values required unless stated otherwise.
\\item You may leave answers in terms of $\\pi$, $e$, $\\ln$, etc.
\\end{{itemize}}
\\end{{tcolorbox}}

\\vspace{{0.3cm}}

\\begin{{center}}
\\renewcommand{{\\arraystretch}}{{1.3}}
\\begin{{tabular}}{{|p{{7cm}}|c|c|}}
\\hline
\\textbf{{Section}} & \\textbf{{Points}} & \\textbf{{Score}} \\\\
\\hline
{sections_table}\\textbf{{TOTAL}} & \\textbf{{{context["total_points"]}}} & \\hspace{{1.5cm}} \\\\
\\hline
\\end{{tabular}}
\\end{{center}}

\\vspace{{0.8cm}}

{sections_content}

\\vfill

\\begin{{center}}
\\rule{{0.6\\textwidth}}{{1pt}}\\\\[0.4cm]
{{\\Large \\textbf{{END OF PRACTICE SET}}}}\\\\[0.3cm]
\\textit{{Review your work. Make sure all answers are simplified.}}\\\\[0.2cm]
\\textit{{Generated by bcpractice}}
\\end{{center}}

\\end{{document}}
"""
    return final
