<!DOCTYPE html>
<html lang="en" data-theme="hashed">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="user-id" content="{{ session.username|default('anonymous', true) }}">
    <title>{% block title %}Deep Research System{% endblock %}</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">

    <!-- FOUC Prevention: Apply theme before any rendering -->
    <!-- Theme list is auto-detected from themes.css by ThemeHelper -->
    <script>
        (function() {
            // Auto-detected from CSS - no need to manually update this list
            var validThemes = {{ get_themes_json()|safe }};
            // Store theme metadata for JavaScript (used by theme.js)
            window.LDR_THEME_METADATA = {{ get_theme_metadata()|safe }};

            var userId = {{ session.username|default("anonymous", true)|tojson }};
            var storageKey = 'ldr-theme-' + userId;
            var theme = localStorage.getItem(storageKey) || 'system';
            // Validate theme
            if (validThemes.indexOf(theme) === -1) {
                theme = 'hashed';
            }
            var effectiveTheme = theme;
            if (theme === 'system') {
                effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'hashed' : 'sepia';
            }
            document.documentElement.setAttribute('data-theme', effectiveTheme);
        })();
    </script>

    <!-- Vite HMR for development -->
    {{ vite_hmr() }}

    <!-- Load all vendor dependencies and styles through Vite -->
    {{ vite_asset('js/app.js') }}

    <!-- Keep local styles that aren't in npm packages -->
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/help-system.css">
    <link rel="stylesheet" href="/static/css/mobile-navigation.css">
    <link rel="stylesheet" href="/static/css/mobile-responsive.css">

    <!-- Theme overrides must load AFTER base styles to take precedence -->
    <link rel="stylesheet" href="/static/css/themes.css">

    <!-- Force hide sidebar on mobile with inline CSS for highest priority -->
    <style>
        @media (max-width: 767px) {
            /* Absolutely hide the desktop sidebar on mobile */
            .ldr-sidebar:not(.active),
            aside.ldr-sidebar:not(.active),
            .ldr-app-container > aside {
                display: none !important;
                visibility: hidden !important;
                width: 0 !important;
                height: 0 !important;
                position: absolute !important;
                left: -9999px !important;
            }

            /* Ensure app container doesn't use flex on mobile */
            .ldr-app-container {
                display: block !important;
            }

            /* Main content takes full width */
            .ldr-main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body>
    <div class="ldr-app-container">
        <!-- Sidebar -->
        {% include 'components/sidebar.html' %}

        <!-- Main Content -->
        <main class="ldr-main-content">
            {% if session.username %}
            <div class="ldr-top-bar">
                <div class="ldr-top-bar-left">
                    <!-- Theme dropdown selector -->
                    <div class="ldr-theme-selector">
                        <i class="fas fa-palette ldr-theme-icon"></i>
                        <select id="theme-dropdown" class="ldr-theme-dropdown"
                                title="Select theme" aria-label="Select color theme">
                            <!-- Options populated by theme.js -->
                        </select>
                    </div>
                </div>
                <div class="ldr-top-bar-right">
                    <div class="ldr-user-menu">
                        <span class="ldr-user-info">
                            <i class="fas fa-user"></i> {{ session.username }}
                        </span>
                        <form action="{{ url_for('auth.logout') }}" method="POST" class="ldr-logout-form" id="logout-form" style="display: inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <a href="#" class="ldr-logout-btn" onclick="event.preventDefault(); document.getElementById('logout-form').submit(); return false;">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            {% block content %}{% endblock %}

            <!-- Collapsible Log Panel is included in specific pages -->
        </main>
    </div>

    <!-- Mobile Tab Bar -->
    {# Mobile navigation now handled dynamically by mobile-navigation.js #}
    {# {% include 'components/mobile_nav.html' %} #}

    <!-- Common Templates -->
    {% block templates %}{% endblock %}

    <!-- Scripts -->

    <!-- URL Configuration (must load first) -->
    <script src="/static/js/config/urls.js"></script>

    <!-- Logo click handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const logoLink = document.getElementById('logo-link');
            if (logoLink) {
                logoLink.addEventListener('click', function() {
                    window.location.href = '/';
                });
            }
        });
    </script>

    <!-- All vendor libraries are now loaded through Vite in the <head> section -->

    <!-- Core JS -->
    <script src="/static/js/services/theme.js"></script>
    <script src="/static/js/services/formatting.js"></script>
    <script src="/static/js/services/ui.js"></script>
    <script src="/static/js/services/api.js"></script>
    <script src="/static/js/services/socket.js"></script>
    <script src="/static/js/services/keyboard.js"></script>
    <script src="/static/js/services/help.js"></script>

    <!-- Security Utilities -->
    <script src="/static/js/security/xss-protection.js"></script>
    <script src="/static/js/security/safe-logger.js"></script>

    <!-- Shared Components -->
    <script src="/static/js/components/logpanel.js"></script>

    <!-- Page-specific Components -->
    {% block component_scripts %}{% endblock %}

    <!-- Page-specific JS -->
    {% block page_scripts %}{% endblock %}

    <script>
        // Configure marked to not use eval
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                headerIds: false,
                mangle: false,
                smartypants: false
            });
        }

        // Configure html2canvas to avoid using eval if possible
        if (typeof html2canvas !== 'undefined') {
            window.html2canvas_noSandbox = true;
        }
    </script>

    <script src="/static/js/components/settings_sync.js"></script>

    <!-- Mobile Navigation -->
    <script src="/static/js/security/url-validator.js"></script>
    <script src="/static/js/mobile-navigation.js"></script>
</body>
</html>
