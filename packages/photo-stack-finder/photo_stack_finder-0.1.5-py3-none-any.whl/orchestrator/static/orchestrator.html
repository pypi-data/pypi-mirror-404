<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Dedup Orchestrator</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/orchestrator.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∏ Photo Deduplication Orchestrator</h1>
            <p>Automated pipeline for finding and reviewing duplicate photos</p>
        </header>

        <main>
            <!-- Getting Started Section (Collapsible) -->
            <section class="info-section">
                <details>
                    <summary>‚ÑπÔ∏è <strong>First Time Here? Read This First</strong></summary>
                    <div class="info-content">
                        <h3>What This Tool Does</h3>
                        <p>
                            Photo Dedup finds photos that originate from the <strong>same source image</strong>:
                            byte-identical files, different resolutions (low-res vs. high-res), edited versions vs. originals,
                            rotation variants, format conversions (JPEG vs. HEIC), and cloud sync duplicates like
                            <code>IMG_1234.jpg</code> and <code>IMG_1234(1).jpg</code>.
                        </p>
                        <p>
                            <strong>Note:</strong> This tool does <em>not</em> find burst shots or similar photos from different moments
                            (those are separate images, not duplicates).
                        </p>

                        <h3>Before You Start: Prepare Your Photos</h3>
                        <ol>
                            <li><strong>Export from cloud service</strong> (if needed):
                                <ul>
                                    <li><strong>Google Photos:</strong> Use <a href="https://takeout.google.com/" target="_blank" rel="noopener">Google Takeout</a> ‚Üí Download all archives ‚Üí Extract to a folder</li>
                                    <li><strong>iCloud:</strong> Download via iCloud.com or iCloud for Windows</li>
                                    <li><strong>OneDrive/Dropbox:</strong> Ensure fully synced to your computer</li>
                                </ul>
                            </li>
                            <li><strong>Locate your photo directory</strong> - Where your photos are stored (can include subdirectories)</li>
                            <li><strong>Verify disk space</strong> - Need ~5-10% of photo collection size for analysis cache</li>
                            <li><strong>Backup (recommended)</strong> - Ensure you have a backup before deleting duplicates</li>
                        </ol>

                        <h3>Quick Start Checklist</h3>
                        <ul class="checklist">
                            <li>‚úÖ Photos exported from cloud service (or already on computer)</li>
                            <li>‚úÖ Know the path to your photo directory</li>
                            <li>‚úÖ Have sufficient disk space (~5-10% of photo collection)</li>
                            <li>‚úÖ Have a backup (recommended)</li>
                        </ul>

                        <h3>What To Expect</h3>
                        <ul>
                            <li><strong>Processing time:</strong> ~30-60 minutes for 10,000 photos (depends on collection size and CPU)</li>
                            <li><strong>Review time:</strong> ~30-60 minutes to review duplicate groups</li>
                            <li><strong>Storage savings:</strong> Often 10-50% reduction depending on duplicate rate</li>
                        </ul>

                        <p>
                            <strong>üìñ Detailed Guide:</strong> See
                            <a href="https://github.com/gbarrett28/photo_dedup/blob/master/GETTING_STARTED.md" target="_blank" rel="noopener">
                                GETTING_STARTED.md
                            </a>
                            for step-by-step instructions including Google Takeout export.
                        </p>
                    </div>
                </details>
            </section>

            <section class="config-section">
                <h2>Configuration</h2>

                <form id="config-form">
                    <!-- Essential Parameters -->
                    <div class="form-group">
                        <label for="source-dir">Source Directory *</label>
                        <div class="input-with-button">
                            <input type="text" id="source-dir" name="source_dir" required
                                   placeholder="/path/to/your/photos">
                            <button type="button" id="browse-source" class="btn-browse">üìÅ Browse</button>
                        </div>
                        <small>Directory containing your photos to deduplicate</small>
                    </div>

                    <div class="form-group">
                        <label for="work-dir">Work Directory</label>
                        <div class="input-with-button">
                            <input type="text" id="work-dir" name="work_dir"
                                   placeholder="Auto-filled from source directory">
                            <button type="button" id="browse-work" class="btn-browse">üìÅ Browse</button>
                        </div>
                        <small>Where to store analysis results (defaults to sibling of source dir)</small>
                    </div>

                    <!-- Advanced Options (Collapsible) -->
                    <details class="advanced-options">
                        <summary>‚öôÔ∏è Advanced Options</summary>

                        <div class="options-grid">
                            <div class="option-group">
                                <h3>Processing</h3>
                                <div class="form-group">
                                    <label for="max-workers">Max Workers</label>
                                    <input type="number" id="max-workers" name="max_workers" min="1" max="64">
                                    <small>Parallel processing workers (default: CPU count)</small>
                                </div>
                                <div class="form-group">
                                    <label for="batch-size">Batch Size</label>
                                    <input type="number" id="batch-size" name="batch_size" min="1">
                                    <small>Files per batch (default: 256)</small>
                                </div>
                                <div class="form-group">
                                    <label for="debug-mode">
                                        <input type="checkbox" id="debug-mode" name="debug_mode">
                                        Debug Mode (sequential processing)
                                    </label>
                                </div>
                            </div>

                            <div class="option-group">
                                <h3>Comparison</h3>
                                <div class="form-group">
                                    <label for="comparison-method">Comparison Method</label>
                                    <select id="comparison-method" name="comparison_method">
                                        <option value="SSIM">SSIM (Structural Similarity)</option>
                                        <option value="dHash">dHash (Perceptual Hash)</option>
                                        <option value="aHash">aHash (Average Hash)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="ssim-threshold">SSIM Threshold</label>
                                    <input type="number" id="ssim-threshold" name="ssim_threshold"
                                           min="0" max="1" step="0.01" value="0.95">
                                    <small>Minimum similarity (0-1, default: 0.95)</small>
                                </div>
                                <div class="form-group">
                                    <label for="aspect-ratio-threshold">Aspect Ratio Threshold</label>
                                    <input type="number" id="aspect-ratio-threshold" name="aspect_ratio_threshold"
                                           min="0" max="1" step="0.01" value="0.85">
                                    <small>Minimum aspect ratio similarity (default: 0.85)</small>
                                </div>
                            </div>

                            <div class="option-group">
                                <h3>Benchmarks</h3>
                                <div class="form-group">
                                    <label for="enable-benchmarks">
                                        <input type="checkbox" id="enable-benchmarks" name="enable_benchmarks">
                                        Enable Benchmarks Stage
                                    </label>
                                    <small>Run comparison method benchmarks (off by default)</small>
                                </div>
                                <div class="form-group">
                                    <label for="target-fpr">Target False Positive Rate</label>
                                    <input type="number" id="target-fpr" name="target_fpr"
                                           min="0" max="1" step="any" value="0.00075">
                                    <small>Desired FPR for threshold optimization (default: 0.00075)</small>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Action Buttons -->
                    <div class="actions">
                        <button type="submit" class="btn-primary" id="start-pipeline">‚ñ∂Ô∏è Start Pipeline</button>
                        <button type="button" id="stop-pipeline" class="btn-danger" style="display: none;">‚èπÔ∏è Stop Pipeline</button>
                        <button type="button" id="load-defaults" class="btn-secondary">üîÑ Load Defaults</button>
                        <button type="button" id="quit-server" class="btn-danger">üö™ Quit Server</button>
                    </div>
                </form>
            </section>

            <!-- Progress Dashboard (hidden initially) -->
            <section id="progress-section" class="progress-section" style="display: none;">
                <h2>Pipeline Progress</h2>

                <!-- Error Display (hidden initially) -->
                <div id="error-container" class="error-container" style="display: none;">
                    <div class="error-header">
                        <strong>‚ö†Ô∏è Pipeline Error</strong>
                        <button id="copy-error" class="btn-copy">üìã Copy</button>
                    </div>
                    <pre id="error-text" class="error-text"></pre>
                </div>

                <div class="stage-list" id="stage-list">
                    <!-- Stages will be dynamically loaded from /api/stages -->
                </div>
            </section>
        </main>
    </div>

    <!-- Review Modal -->
    <div id="review-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 95vw; height: 95vh;">
            <div class="modal-header">
                <h3 id="review-modal-title">üìä Review Stage Results</h3>
                <button class="modal-close" id="close-review-modal">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0; overflow: hidden; height: calc(95vh - 60px);">
                <iframe
                    id="review-iframe"
                    style="width: 100%; height: 100%; border: none;"
                    src="about:blank">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Directory Browser Modal -->
    <div id="dir-browser-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÅ Select Directory</h3>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="breadcrumb" id="breadcrumb"></div>
                <div class="directory-list" id="directory-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="select-current" class="btn-primary">Select Current Directory</button>
                <button type="button" id="cancel-browse" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/static/orchestrator.js?v=8"></script>
</body>
</html>
