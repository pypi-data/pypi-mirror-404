<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identical Photos Review</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; border-radius: 10px; padding: 12px 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .header h1 { color: #2d3748; margin-bottom: 5px; font-size: 1.3rem; }
        .nav-buttons {
            display: block !important;
            margin: 20px 0 !important;
            width: 100% !important;
            clear: both !important;
        }
        .nav-buttons .btn {
            display: inline-block !important;
            padding: 12px 24px !important;
            font-size: 14px !important;
            margin-right: 10px !important;
            margin-bottom: 10px !important;
        }
        .stats { display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap; }
        .stat { background: #f7fafc; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #667eea; min-width: 90px; }
        .stat-value { font-size: 1.3rem; font-weight: 600; color: #2d3748; }
        .stat-label { font-size: 0.75rem; color: #718096; margin-top: 2px; }
        .progress-bar { width: 100%; height: 18px; background: #e9ecef; border-radius: 9px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem; }
        .controls-fixed { position: sticky; top: 10px; z-index: 100; background: white; border-radius: 10px; padding: 15px 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .current-group-display { text-align: center; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 2px solid #e2e8f0; }
        .group-counter { font-size: 1.4rem; font-weight: 600; color: #2d3748; margin-bottom: 8px; }
        .group-status { font-size: 1rem; color: #718096; }
        .group-status.confirmed { color: #38a169; font-weight: 600; }
        .group-status.rejected { color: #e53e3e; font-weight: 600; }
        .controls-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; }
        .main-actions { display: flex; gap: 15px; justify-content: center; }
        .nav-actions { display: flex; gap: 10px; justify-content: flex-start; }
        .utility-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn-large { font-size: 16px; padding: 16px 32px; }
        .btn-success { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .btn-danger { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%); }
        .btn-warning { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        .btn-secondary { background: linear-gradient(135deg, #718096 0%, #4a5568 100%); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .groups-display { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .current-group { border: 3px solid #667eea; border-radius: 15px; padding: 25px; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); margin-bottom: 20px; }
        .current-group.confirmed { border-color: #48bb78; background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); }
        .current-group.rejected { border-color: #e53e3e; background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%); }
        .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid rgba(0,0,0,0.1); }
        .group-title { font-size: 1.3rem; font-weight: 600; color: #2d3748; }
        .confidence-badge { padding: 8px 16px; border-radius: 20px; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; }
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .photo-item { border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; transition: all 0.2s; cursor: pointer; background: white; position: relative; }
        .photo-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); border-color: #667eea; }
        .photo-item.exemplar { border: 3px solid #48bb78; }
        .photo-item img { width: 100%; height: 180px; object-fit: cover; display: block; }
        .photo-info { padding: 12px; }
        .photo-filename { font-weight: 600; color: #2d3748; margin-bottom: 6px; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .photo-details { font-size: 0.75rem; color: #718096; margin-bottom: 4px; }
        .decision-overlay { position: absolute; top: 10px; right: 10px; padding: 6px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .decision-confirmed { background: #48bb78; }
        .decision-rejected { background: #e53e3e; }
        .context-groups { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .context-group { border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; background: #f8fafc; opacity: 0.7; transition: all 0.2s; }
        .context-group:hover { opacity: 1; transform: translateY(-2px); cursor: pointer; }
        .context-group.confirmed { border-color: #48bb78; background: #f0fff4; }
        .context-group.rejected { border-color: #e53e3e; background: #fed7d7; }
        .context-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .context-title { font-weight: 600; color: #4a5568; font-size: 0.9rem; }
        .context-photos { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .context-photo { aspect-ratio: 1; border-radius: 6px; overflow: hidden; border: 1px solid #e2e8f0; }
        .context-photo img { width: 100%; height: 100%; object-fit: cover; }
        #alert-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .alert { padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        .alert-success { background: #d4edda; color: #155724; border: 2px solid #48bb78; }
        .alert-info { background: #e6fffa; color: #2c7a7b; border: 2px solid #38b2ac; }
        .alert-warning { background: #fffaf0; color: #7c2d12; border: 2px solid #ed8936; }
        .alert-error { background: #fed7d7; color: #721c24; border: 2px solid #e53e3e; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; color: #718096; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .controls-grid { grid-template-columns: 1fr; gap: 15px; }
            .nav-actions, .utility-actions { justify-content: center; }
            .photo-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .stats { justify-content: center; }
        }
        .nav-buttons {
            display: flex !important;
            gap: 10px !important;
            margin-top: 15px !important;
            margin-bottom: 15px !important;
        }

        .nav-buttons .btn {
            padding: 8px 16px !important;
            font-size: 14px !important;
            display: inline-block !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Identical Photos Review</h1>
            <p style="color: #718096; margin-top: 5px;">Review and confirm groups of byte-for-byte identical photos</p>
            <div class="stats">
                <div class="stat"><div class="stat-value" id="total-groups">0</div><div class="stat-label">Total Groups</div></div>
                <div class="stat"><div class="stat-value" id="confirmed-count">0</div><div class="stat-label">Confirmed</div></div>
                <div class="stat"><div class="stat-value" id="rejected-count">0</div><div class="stat-label">Rejected</div></div>
                <div class="stat"><div class="stat-value" id="remaining-count">0</div><div class="stat-label">Remaining</div></div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%">0% Complete</div></div>
        </div>
        <div class="controls-fixed hidden" id="controls-panel">
            <div class="current-group-display">
                <div class="group-counter" id="group-counter">Loading...</div>
                <div class="group-status" id="group-status">Please wait while we load your photo groups</div>
            </div>
            <div class="controls-grid">
                <div class="nav-actions">
                    <button class="btn btn-secondary" onclick="previousGroup()" id="prev-btn">‚Üê Previous</button>
                    <button class="btn btn-secondary" onclick="nextGroup()" id="next-btn">Next ‚Üí</button>
                    <button class="btn btn-secondary" onclick="jumpToGroup()" id="jump-btn">üéØ Jump to...</button>
                </div>
                <div class="main-actions">
                    <button class="btn btn-success btn-large" onclick="confirmGroup()" id="confirm-btn">‚úì Confirm Duplicates</button>
                    <button class="btn btn-danger btn-large" onclick="rejectGroup()" id="reject-btn">‚úó Keep All Copies</button>
                </div>
                <div class="utility-actions">
                    <button class="btn btn-warning" onclick="bulkConfirmAll()" id="bulk-btn">‚úì Confirm All</button>
                    <button class="btn" onclick="saveProgress()" id="save-btn">üíæ Save</button>
                </div>
            </div>
        </div>
        <div class="groups-display">
            <div id="loading-state" class="loading">Loading photo groups</div>
            <div id="groups-content" class="hidden">
                <div class="current-group" id="current-group"></div>
                <div class="context-groups" id="context-groups"></div>
            </div>
        </div>
    </div>
    <div id="alert-container"></div>
<script src="/review_common.js"></script>
<script>
        // Read stage_id from URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const stageId = urlParams.get('stage_id');

        let groupsData = [];
        let currentGroupIndex = 0;
        let decisions = {};
        let useServerImages = false;

        // === Interface functions required by review_common.js ===
        function getTotalGroups() {
            return groupsData.length;
        }

        function getDecisions() {
            return decisions;
        }

        async function saveProgressImpl() {
            try {
                if (useServerImages) {
                    const response = await fetch('/api/review/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ identical: decisions })
                    });
                    const result = await response.json();
                    if (response.ok && result.status === 'saved') {
                        showAlert(`‚úì Saved ${result.saved_count} decisions to server`, 'success');
                    } else {
                        showAlert('Failed to save decisions: ' + (result.message || 'Unknown error'), 'error');
                    }
                } else {
                    // Local save via download
                    const dataStr = JSON.stringify({
                        type: 'identical_review_decisions',
                        timestamp: new Date().toISOString(),
                        total_groups: groupsData.length,
                        decisions: decisions
                    }, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `identical_decisions_${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showAlert(`‚úì Downloaded decisions file`, 'success');
                }
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Error saving progress: ' + error.message, 'error');
            }
        }
        // === End interface functions ===

        async function initializeApp() {
            try {
                showAlert('Loading photo groups...', 'info');
                useServerImages = await checkServerAvailable();
                await loadGroupsData();
                setupUI();
                displayCurrentGroup();
                updateStats();
                showAlert(`‚úì Loaded ${groupsData.length} photo groups`, 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                // Force persistent error with explicit persist=true
                showAlert('Failed to load photo groups: ' + error.message, 'error', true);
                // Also show in page body as fallback
                const loadingState = document.getElementById('loading-state');
                if (loadingState) {
                    loadingState.innerHTML = `
                        <div style="color: red; padding: 20px; background: #fed7d7; border: 2px solid #e53e3e; border-radius: 8px; margin: 20px;">
                            <h3>‚ùå Error Loading Photo Groups</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p><strong>Stack:</strong> <pre style="white-space: pre-wrap;">${error.stack || 'N/A'}</pre></p>
                            <p>Check browser console (F12) for more details.</p>
                        </div>
                    `;
                }
            }
        }

        async function checkServerAvailable() {
            try {
                const response = await fetch('/api/review/status');
                return response.ok;
            } catch {
                return false;
            }
        }

        async function loadGroupsData() {
            try {
                // Build URL with optional stage_id parameter
                let url = '/api/review/identical/groups?page=0&page_size=200';
                if (stageId) {
                    url += `&stage_id=${stageId}`;
                }

                // Load first page immediately for fast startup
                const initialResponse = await fetch(url);
                if (!initialResponse.ok) {
                    const text = await initialResponse.text();
                    throw new Error(`HTTP ${initialResponse.status}: ${text.substring(0, 200)}`);
                }
                const initialData = await initialResponse.json();
                console.log('Loaded initial page:', initialData);
                if (!initialData.groups || initialData.groups.length === 0) {
                    throw new Error(`No identical photo groups found. Data: ${JSON.stringify(initialData).substring(0, 200)}`);
                }
                groupsData = initialData.groups;

                // Load remaining pages in background if there are more
                if (initialData.has_more) {
                    loadRemainingGroupsInBackground(initialData.total_groups, initialData.page_size);
                }
            } catch (error) {
                console.error('loadGroupsData error:', error);
                if (error.message === 'Failed to fetch') {
                    throw new Error('Failed to fetch /api/review/identical/groups - Is the server running? Check console for CORS/network errors.');
                }
                throw error;
            }
        }

        async function loadRemainingGroupsInBackground(totalGroups, pageSize) {
            const totalPages = Math.ceil(totalGroups / pageSize);
            console.log(`Loading remaining pages in background (${totalPages - 1} pages)...`);

            // Load pages 1+ in background
            for (let page = 1; page < totalPages; page++) {
                try {
                    // Build URL with optional stage_id parameter
                    let url = `/api/review/identical/groups?page=${page}&page_size=${pageSize}`;
                    if (stageId) {
                        url += `&stage_id=${stageId}`;
                    }

                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        groupsData.push(...data.groups);
                        console.log(`Loaded page ${page + 1}/${totalPages}: ${groupsData.length}/${totalGroups} groups`);
                        // Update stats after each batch loads
                        updateStats();
                    }
                } catch (error) {
                    console.error(`Failed to load page ${page}:`, error);
                    // Continue loading other pages even if one fails
                }
            }
            console.log(`Background loading complete: ${groupsData.length} groups total`);
        }

        function setupUI() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('groups-content').classList.remove('hidden');
            document.getElementById('controls-panel').classList.remove('hidden');
        }

        function updateStats() {
            const total = groupsData.length;
            const confirmed = Object.values(decisions).filter(d => d === 'confirmed').length;
            const rejected = Object.values(decisions).filter(d => d === 'rejected').length;
            const reviewed = confirmed + rejected;
            const remaining = total - reviewed;
            const progress = total > 0 ? (reviewed / total * 100) : 0;
            document.getElementById('total-groups').textContent = total;
            document.getElementById('confirmed-count').textContent = confirmed;
            document.getElementById('rejected-count').textContent = rejected;
            document.getElementById('remaining-count').textContent = remaining;
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = progress + '%';
            progressFill.textContent = Math.round(progress) + '% Complete';
            const counter = document.getElementById('group-counter');
            counter.textContent = `Group ${currentGroupIndex + 1} of ${total}`;
            const status = document.getElementById('group-status');
            const decision = decisions[currentGroupIndex];
            if (decision === 'confirmed') {
                status.textContent = '‚úì Confirmed as duplicates';
                status.className = 'group-status confirmed';
            } else if (decision === 'rejected') {
                status.textContent = '‚úó Keeping all copies';
                status.className = 'group-status rejected';
            } else {
                const group = groupsData[currentGroupIndex];
                status.textContent = `${group.photos.length} photos ‚Ä¢ ${group.is_identical ? 'Byte-identical' : 'Visually similar'}`;
                status.className = 'group-status';
            }
        }

        function displayCurrentGroup() {
            if (currentGroupIndex >= groupsData.length) return;
            const group = groupsData[currentGroupIndex];
            const decision = decisions[currentGroupIndex];
            const currentGroupDiv = document.getElementById('current-group');
            currentGroupDiv.className = 'current-group';
            if (decision === 'confirmed') currentGroupDiv.classList.add('confirmed');
            else if (decision === 'rejected') currentGroupDiv.classList.add('rejected');
            currentGroupDiv.innerHTML = createGroupHTML(group, currentGroupIndex, true);
            displayContextGroups();
            document.getElementById('prev-btn').disabled = currentGroupIndex === 0;
            document.getElementById('next-btn').disabled = currentGroupIndex >= groupsData.length - 1;
            updateStats();
        }

        function displayContextGroups() {
            const contextContainer = document.getElementById('context-groups');
            contextContainer.innerHTML = '';
            const start = Math.max(0, currentGroupIndex - 2);
            const end = Math.min(groupsData.length, currentGroupIndex + 3);
            for (let i = start; i < end; i++) {
                if (i === currentGroupIndex) continue;
                const group = groupsData[i];
                const decision = decisions[i];
                const contextDiv = document.createElement('div');
                contextDiv.className = 'context-group';
                contextDiv.onclick = () => jumpToGroupIndex(i);
                if (decision === 'confirmed') contextDiv.classList.add('confirmed');
                else if (decision === 'rejected') contextDiv.classList.add('rejected');
                contextDiv.innerHTML = createContextGroupHTML(group, i);
                contextContainer.appendChild(contextDiv);
            }
        }

        function formatPhotoMetadata(photo) {
            // Format metadata from photo object (no API call needed)
            // All photos have width/height - if image can't be loaded, PhotoFile creation fails
            const sizeMB = (photo.file_size / (1024 * 1024)).toFixed(1);
            return `${sizeMB} MB ‚Ä¢ ${photo.width}√ó${photo.height}`;
        }

        function createGroupHTML(group, groupIndex, isCurrent = false) {
            const decision = decisions[groupIndex];
            let decisionOverlay = '';
            if (decision === 'confirmed') decisionOverlay = '<div class="decision-overlay decision-confirmed">‚úì CONFIRMED</div>';
            else if (decision === 'rejected') decisionOverlay = '<div class="decision-overlay decision-rejected">‚úó REJECTED</div>';
            const header = `<div class="group-header"><div class="group-title">Group #${groupIndex + 1}</div><div class="confidence-badge confidence-${group.confidence}">${group.is_identical ? '‚úì Byte-Identical Files' : group.confidence + ' Confidence'}</div></div>`;
            const photosHTML = group.photos.map((photo, idx) => {
                const photoItemId = `photo-${groupIndex}-${idx}`;
                const detailsId = `details-${groupIndex}-${idx}`;
                let imgSrc, imgOnError = '';
                if (useServerImages) {
                    imgSrc = `/api/review/thumbnail/${photo.id}?size=300`;
                    imgOnError = `onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'220\\' height=\\'180\\'%3E%3Crect width=\\'220\\' height=\\'180\\' fill=\\'%23fca5a5\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' font-family=\\'Arial\\' font-size=\\'12\\' fill=\\'%23991b1b\\'%3EImage not found%3C/text%3E%3C/svg%3E';"`;
                } else {
                    const filename = encodeURIComponent(photo.filename).replace(/'/g, '%27');
                    imgSrc = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='180'%3E%3Crect width='220' height='180' fill='%23f7fafc'/%3E%3Ctext x='50%25' y='25%25' text-anchor='middle' font-family='Arial' font-size='11' fill='%23718096'%3E${filename}%3C/text%3E%3C/svg%3E`;
                }
                const photoDetails = formatPhotoMetadata(photo);
                const imgOnClick = useServerImages ? `onclick="showFullImage(${photo.id}, '${photo.filename.replace(/'/g, "\\'")}')"` : '';
                const exemplarClass = photo.is_exemplar ? ' exemplar' : '';
                return `<div class="photo-item${exemplarClass}" id="${photoItemId}" style="position: relative;" title="${photo.path}">${isCurrent ? decisionOverlay : ''}<img src="${imgSrc}" alt="${photo.filename}" ${imgOnError} ${imgOnClick} style="cursor: pointer;"><div class="photo-info"><div class="photo-filename">${photo.filename}</div><div class="photo-details" id="${detailsId}">${photoDetails}</div></div></div>`;
            }).join('');
            return header + `<div class="photo-grid">${photosHTML}</div>`;
        }

        function createContextGroupHTML(group, groupIndex) {
            const decision = decisions[groupIndex];
            let statusBadge = '';
            if (decision === 'confirmed') statusBadge = '<span style="color: #38a169; font-weight: 600;">‚úì</span>';
            else if (decision === 'rejected') statusBadge = '<span style="color: #e53e3e; font-weight: 600;">‚úó</span>';
            const header = `<div class="context-header"><div class="context-title">Group #${groupIndex + 1} ${statusBadge}</div><div style="font-size: 0.75rem; color: #a0aec0;">${group.photos.length} photos</div></div>`;
            const photosToShow = group.photos.slice(0, 4);
            const photosHTML = photosToShow.map(photo => {
                let imgSrc = useServerImages ? `/api/review/thumbnail/${photo.id}?size=100` : `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' fill='%23e2e8f0'/%3E%3C/svg%3E`;
                return `<div class="context-photo"><img src="${imgSrc}" alt="${photo.filename}"></div>`;
            }).join('');
            return header + `<div class="context-photos">${photosHTML}</div>`;
        }

        function confirmGroup() {
            decisions[currentGroupIndex] = 'confirmed';
            showAlert(`Group ${currentGroupIndex + 1} confirmed as duplicates`, 'success');
            displayCurrentGroup();
            advanceToNext();
        }

        function rejectGroup() {
            decisions[currentGroupIndex] = 'rejected';
            showAlert(`Group ${currentGroupIndex + 1} - keeping all copies`, 'info');
            displayCurrentGroup();
            advanceToNext();
        }

        function advanceToNext() {
            for (let i = currentGroupIndex + 1; i < groupsData.length; i++) {
                if (!(i in decisions)) {
                    currentGroupIndex = i;
                    displayCurrentGroup();
                    return;
                }
            }
            if (currentGroupIndex < groupsData.length - 1) {
                currentGroupIndex++;
                displayCurrentGroup();
            }
        }

        // previousGroup, nextGroup, jumpToGroup, saveProgress, quitReview, showAlert, showFullImage
        // are provided by review_common.js

        function jumpToGroupIndex(index) {
            if (index >= 0 && index < groupsData.length) {
                currentGroupIndex = index;
                displayCurrentGroup();
            }
        }

        function bulkConfirmAll() {
            const unreviewed = [];
            for (let i = 0; i < groupsData.length; i++) {
                if (!(i in decisions)) unreviewed.push(i);
            }
            if (unreviewed.length === 0) {
                showAlert('All groups already reviewed', 'info');
                return;
            }
            if (confirm(`Confirm ${unreviewed.length} remaining groups as duplicates?`)) {
                unreviewed.forEach(i => { decisions[i] = 'confirmed'; });
                showAlert(`‚úì Confirmed ${unreviewed.length} groups as duplicates`, 'success');
                displayCurrentGroup();
            }
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.addEventListener('keydown', (e) => {
            if (groupsData.length === 0) return;
            switch (e.key.toLowerCase()) {
                case 'c':
                    e.preventDefault();
                    confirmGroup();
                    break;
                case 'r':
                    e.preventDefault();
                    rejectGroup();
                    break;
                case 'arrowleft':
                    e.preventDefault();
                    previousGroup();
                    break;
                case 'arrowright':
                    e.preventDefault();
                    nextGroup();
                    break;
                case 's':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        saveProgress();
                    }
                    break;
            }
        });

        window.addEventListener('load', () => {
            initializeApp();
            setTimeout(() => {
                showAlert('üí° Shortcuts: C=confirm, R=reject, ‚Üê‚Üí=navigate, Ctrl+S=save', 'info');
            }, 2000);
        });
    </script>
</body>
</html>
