name: Quality (Ruff + Secrets via UV)

on:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/quality.yml'
      - '.trufflehog*'
  push:
    branches: [main, review, master]  # Quality checks only on stable branches
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/quality.yml'
      - '.trufflehog*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code (full history for base/head refs)
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up UV
        uses: astral-sh/setup-uv@f0ec1fc3b38f5e7cd731bb6ce540c5af426746bb  # v5.2.2

      # Ruff: verify formatting & lint (read-only; no --fix)
      # Why: Use 'uv run' instead of 'uvx' to read project's pyproject.toml config
      - name: Ruff format (check only)
        run: uv run ruff format --check .
      - name: Ruff lint (no autofix)
        run: uv run ruff check .

      # TruffleHog: scan full repository history (fail on verified+unknown secrets)
      # NOTE: The action automatically adds --fail, --no-update, --github-actions flags
      - name: Secrets scan (verified+unknown)
        uses: trufflesecurity/trufflehog@a450544f0b7c12e99bd78b4f02fe67d5c5e56711  # main
        with:
          path: ./
          extra_args: >
            --results=verified,unknown
            --exclude-paths=.trufflehog-exclude-paths.txt
