name: Build and publish Python distributions to PyPI

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:


env:
  PYTHON_VERSION: "3.13"

jobs:
  prepare:
    name: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ —Ä–µ–ª–∏–∑–∞
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG_NAME="${{ github.ref_name }}"
            echo "–ó–∞–ø—É—Å–∫ –ø–æ —Ç–µ–≥—É: $TAG_NAME"
          else
            echo "–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫, –ø–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ–≥–∞..."
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [[ -z "$TAG_NAME" ]]; then
              echo "–¢–µ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"
              exit 1
            fi
            echo "–ù–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥: $TAG_NAME"
          fi
          
          CLEAN_VERSION=${TAG_NAME#v}
          
          echo "–í–µ—Ä—Å–∏—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: $CLEAN_VERSION"
          echo "version=$CLEAN_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+([a-zA-Z0-9._-]*)?$ ]]; then
            echo "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏: $VERSION"
            echo "   –û–∂–∏–¥–∞–µ—Ç—Å—è: MAJOR.MINOR.PATCH[.suffix]"
            exit 1
          fi
          echo "–§–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: $VERSION"
  build:
    name: üî® –°–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞
    needs: [prepare]
    runs-on: ubuntu-latest
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –≤ pyproject.toml
        run: |
          EXPECTED_VERSION="${{ needs.prepare.outputs.version }}"
          
          if [[ -f "pyproject.toml" ]]; then
            TOML_VERSION=$(grep -E '^version\s*=' pyproject.toml | head -1 | sed 's/.*=\s*["\x27]\(.*\)["\x27].*/\1/')
            
            if [[ -z "$TOML_VERSION" ]]; then
              echo "–í–µ—Ä—Å–∏—è –≤ pyproject.toml –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è)"
            elif [[ "$TOML_VERSION" != "$EXPECTED_VERSION" ]]; then
              echo "–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–µ—Ä—Å–∏–π!"
              echo "   –¢–µ–≥: $EXPECTED_VERSION"
              echo "   pyproject.toml: $TOML_VERSION"
              echo ""
              echo "–û–±–Ω–æ–≤–∏—Ç–µ –≤–µ—Ä—Å–∏—é –≤ pyproject.toml –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–µ–≥–∞"
              exit 1
            else
              echo "–í–µ—Ä—Å–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç: $EXPECTED_VERSION"
            fi
          fi

      - name: –°–±–æ—Ä–∫–∞ sdist –∏ wheel
        run: |
          echo "–°–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞ –≤–µ—Ä—Å–∏–∏ ${{ needs.prepare.outputs.version }}..."
          uv build --sdist --wheel
          echo ""
          echo "–°–æ–±—Ä–∞–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:"
          ls -la dist/

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–∞ (twine check)
        run: |
          uv pip install --system twine
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–∞..."
          twine check dist/*
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞"

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          if-no-files-found: error
          retention-days: 5

  publish-to-pypi:
    name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ PyPI
    needs: [prepare, build]
    if: |
      always() && 
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/${{ github.event.repository.name }}/${{ needs.prepare.outputs.version }}/
    permissions:
      id-token: write  # –î–ª—è Trusted Publishing (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    steps:
      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        run: |
          echo "–ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤–µ—Ä—Å–∏–∏: ${{ needs.prepare.outputs.version }}"
          echo ""
          echo "–§–∞–π–ª—ã:"
          ls -la dist/

      - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          # –û–ø—Ü–∏–∏:
          # print-hash: true        # –í—ã–≤–µ—Å—Ç–∏ —Ö—ç—à–∏ —Ñ–∞–π–ª–æ–≤
          # verbose: true           # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
          # skip-existing: true     # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
