{{ define "_dpps_gcert_server_name_request"  }}
---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: gcert-request-{{ .server_name }}
spec:
  kind: server
  secretNames:
    - {{ .Release.Name }}-{{ .server_name }}-certkey
    - {{ .Release.Name }}-{{ .server_name }}-hostkey
    - {{ .Release.Name }}-{{ .server_name }}-x509up
  cns:
    # - {{ .server_name }}
    - {{ .Release.Name }}-{{ .server_name }}
    - {{ .Release.Name }}-{{ .server_name }}.{{ .Release.Namespace }}.svc.cluster.local
    - {{ .Release.Name }}-{{ .server_name }}.{{ .Release.Namespace }}.svc
      #certKey: {{ .certKey | default "host.pem" }}
      #  keyKey: {{ .keyKey | default "host.key.pem" }}
  certKey: {{ .certKey | default "hostcert.pem" }}
  keyKey: {{ .keyKey | default "hostkey.pem" }}
  certkeyKey: host.certkey.pem
  proxyKey: x509up
{{ end }}

{{ define "_dpps_gcert_dirac_server_name_request"  }}
---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: gcert-request-{{ .server_name }}
spec:
  kind: server
  secretNames:
    - {{ .Release.Name }}-dirac-{{ .server_name }}-certkey
    - {{ .Release.Name }}-dirac-{{ .server_name }}-hostkey
    - {{ .Release.Name }}-dirac-{{ .server_name }}-x509up
  cns:
    - dirac-{{ .server_name }}
    - {{ .Release.Name }}-wms-dirac-{{ .server_name }}
  certKey: {{ .certKey | default "hostcert.pem" }}
  keyKey: {{ .keyKey | default "hostkey.pem" }}
  certkeyKey: host.certkey.pem
  proxyKey: x509up
{{ end }}

    # - {{ .Release.Name }}-dirac-{{ .server_name }}-certkey

# these should be included already in bdms and wms charts, based

{{ include "_dpps_gcert_server_name_request" (dict "server_name" "iam.test.example" "Release" .Release ) }}

---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: gcert-request-fts
spec:
  certKey: hostcert.pem
  certkeyKey: host.certkey.pem
  cns:
  - dpps-fts
  - {{ .Release.Name }}-fts
  - {{ .Release.Name }}-fts.default.svc.cluster.local
  - {{ .Release.Name }}-fts.default.svc
  keyKey: hostkey.pem
  kind: server
  proxyKey: x509up
  secretNames:
  - {{ .Release.Name }}-fts-certkey
  - {{ .Release.Name }}-fts-hostkey
  - {{ .Release.Name }}-fts-x509up



# todo
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "master-cs" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "ce" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "web-app" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "client" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "proxy-manager" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "bundle-delivery" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "system-admin" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "component-monitoring" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "job-manager" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "job-monitoring" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "job-state-update" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "wms-admin" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "matcher" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "pilot-manager" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "pilot-status" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "optimization-mind" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "sandbox-store" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "file-catalog" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "storage-element" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "req-proxy" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "resource-status" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "resource-management" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "publisher" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "req-executing" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "req-manager" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "clean-req-db" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "site-director" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "pilot-sync" "Release" .Release) }}
{{ include "_dpps_gcert_dirac_server_name_request" (dict "server_name" "optimizers" "Release" .Release) }}


# used by rucio-storage at least
---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: {{ .Release.Name }}-gcert-request-ca-v2
spec:
  kind: ca
  secretNames:
  - {{ .Release.Name }}-server-cafile
  - bdms-server-cafile # TODO: check why it needs explicit BDMS reference
  certKey: ca.pem
  # crlKey: dpps-ca.crl
  crlKey: dpps_test_ca.crl.r0

# for dirac CLI
---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: {{ .Release.Name }}-gcert-request-ca-rootcert
spec:
  kind: ca
  secretNames:
  - root-secret
  certKey: tls.crt
  crlKey: dpps-ca.crl

{{ $releaseName := .Release.Name }}
{{ range $i := tuple 1 2 3 }}
---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  annotations:
  name: {{ $releaseName }}-gcert-request-rucio-storage-{{ $i }}
spec:
  certkeyKey: host.certkey.pem
  cns:
  - rucio-storage-{{ $i }}.default.svc.cluster.local
  - rucio-storage-{{ $i }}
  - {{ $releaseName }}-rucio-storage-{{ $i }}.default.svc.cluster.local
  - {{ $releaseName }}-rucio-storage-{{ $i }}
  - {{ $releaseName }}-rucio-storage-{{ $i }}.default.svc
  keyKey: hostkey.pem
  certKey: hostcert.pem
  kind: server
  proxyKey: x509up
  secretNames:
  - {{ $releaseName }}-rucio-storage-{{ $i }}-certkey
  - {{ $releaseName }}-rucio-storage-{{ $i }}-hostkey
  - {{ $releaseName }}-rucio-storage-{{ $i }}-x509up

{{ end }}

---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: {{ include "dpps.fullname" . }}-gcert-request-voms.test.example
spec:
  certKey: hostcert.pem
  certkeyKey: host.certkey.pem
  cns:
  - voms.test.example
  - voms.test.example.default.svc.cluster.local
  - voms.test.example.default.svc
  keyKey: hostkey.pem
  kind: server
  proxyKey: x509up
  secretNames:
  - {{ include "dpps.fullname" . }}-voms.test.example-certkey
  - {{ include "dpps.fullname" . }}-voms.test.example-hostkey

---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: gcert-request-rucio-server
spec:
  kind: server
  secretNames:
    - {{ .Release.Name }}-rucio-x509up
    - {{ .Release.Name }}-server-hostcert
    - {{ .Release.Name }}-server-hostkey
  cns:
    - {{ .Release.Name }}-rucio-server
    - {{ .Release.Name }}-rucio-server.default.svc
    - {{ .Release.Name }}-rucio-server.default.svc.cluster.local
  certKey: hostcert.pem
  keyKey: hostkey.pem
  certkeyKey: host.certkey.pem
  proxyKey: x509up

---
# default DPPS user
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: gcert-request-dppsuser
spec:
  kind: user
  secretNames:
  - {{ .Release.Name }}-user-certkey
  - {{ .Release.Name }}-dppsuser-certkey
  cns:
  - "DPPS User"
  certKey: dppsuser.pem
  keyKey: dppsuser.key.pem
  certkeyKey: dppsuser.certkey.pem
  proxyKey: x509up
  acceptedCAs: []

---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: gcert-request-opensearch-cluster-master
spec:
  certKey: hostcert.pem
  keyKey: hostkey.pem
  certkeyKey: host.certkey.pem
  cns:
  - opensearch-cluster-master
  - {{ .Release.Name }}-opensearch-cluster-master
  - {{ .Release.Name }}-opensearch-cluster-master.default.svc.cluster.local
  - {{ .Release.Name }}-opensearch-cluster-master.default.svc
  kind: server
  proxyKey: x509up
  secretNames:
  - {{ .Release.Name }}-opensearch-cluster-master-certkey
  - {{ .Release.Name }}-opensearch-cluster-master-hostkey
  - {{ .Release.Name }}-opensearch-cluster-master-x509up


---
apiVersion: dpps.ctao.org/v1beta1
kind: GCertRequest
metadata:
  name: gcert-request-ssh-for-diracuser
spec:
  kind: ssh
  secretNames:
  - {{ .Release.Name }}-diracuser-sshkey
  # certKey: ssh.pem
  # keyKey: ssh.key.pem
  certKey: ssh-diracuser_sshkey.pub
  keyKey: ssh-diracuser_sshkey
