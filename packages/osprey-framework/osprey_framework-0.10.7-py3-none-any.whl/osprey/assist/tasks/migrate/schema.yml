# OSPREY Migration Document Schema
# Version: 1.0.0
#
# This schema defines the structure for machine-readable migration documents
# that enable automated/assisted upgrades of downstream facility implementations.

schema_version: "1.0.0"

# =============================================================================
# SCHEMA DEFINITION (for reference - actual migrations follow this structure)
# =============================================================================

_schema:
  # Top-level required fields
  required_fields:
    - version          # Target version (e.g., "0.9.6")
    - release_date     # ISO date (e.g., "2024-12-15")
    - summary          # One-line description of release theme
    - migrates_from    # Minimum version that can migrate directly
    - changes          # List of change objects

  # Optional top-level fields
  optional_fields:
    - breaking         # Boolean: true if any change is breaking
    - deprecations     # List of deprecated items (not yet removed)
    - affected_file_patterns  # Glob patterns for files typically needing updates
    - validation       # Commands to verify successful migration
    - notes            # Free-form migration notes

  # Change object types and their required/optional fields
  change_types:

    method_rename:
      description: "A method or function was renamed"
      required: [old, new, search_pattern, risk, automatable]
      optional: [scope, class, module, example, migration_notes]

    signature_change:
      description: "A method's parameters changed"
      required: [method, old_signature, new_signature, search_pattern, risk, automatable]
      optional: [class, module, parameter_mapping, example, manual_review_reason]

    import_change:
      description: "Import path changed"
      required: [old_import, new_import, search_pattern, risk, automatable]
      optional: [scope]

    class_rename:
      description: "A class was renamed"
      required: [old, new, search_pattern, risk, automatable]
      optional: [requires_imports, example]

    config_change:
      description: "Configuration file schema changed"
      required: [description, file_pattern, risk, automatable]
      optional: [old_schema, new_schema, transformation]

    behavior_change:
      description: "Same API but different behavior"
      required: [description, risk, automatable]
      optional: [affected_method, search_pattern, manual_review_reason]

    removal:
      description: "A function/class/method was removed"
      required: [removed, risk, automatable]
      optional: [replacement, search_pattern, migration_notes]

    addition:
      description: "New functionality added (non-breaking, informational)"
      required: [description]
      optional: [new_imports, example]

  # Risk levels
  risk_levels:
    high: "Breaking change - code won't run without fix"
    medium: "May cause runtime errors in some cases"
    low: "Deprecation warning or cosmetic change"

  # Automatability
  automatable_values:
    true: "Simple find-replace with regex, no context needed"
    partial: "Pattern exists but some cases need manual review"
    false: "Requires human judgment for each occurrence"

# =============================================================================
# EXAMPLE STRUCTURE (copy this for new migration files)
# =============================================================================

_example:
  version: "0.9.X"
  release_date: "YYYY-MM-DD"
  summary: "Brief description of what this release changes"
  migrates_from: "0.9.X-1"
  breaking: true

  changes:
    - type: method_rename
      risk: high
      scope: connector
      old:
        method: "old_method_name"
        class: "ClassName"
        module: "osprey.module.path"
      new:
        method: "new_method_name"
        class: "ClassName"
        module: "osprey.module.path"
      search_pattern: '\.old_method_name\s*\('
      automatable: true
      example:
        before: |
          result = await obj.old_method_name(arg)
        after: |
          result = await obj.new_method_name(arg)

  affected_file_patterns:
    - "**/*capability*.py"
    - "**/registry.py"
    - "config.yml"

  validation:
    - command: "python -c 'from osprey import __version__; print(__version__)'"
      expected: "0.9.X"
    - command: "pytest --collect-only"
      description: "Verify imports resolve"
