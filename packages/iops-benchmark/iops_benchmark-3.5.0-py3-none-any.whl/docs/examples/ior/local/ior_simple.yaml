# IOPS Benchmark Configuration - Simple Local Example
#
# This example demonstrates running IOR benchmarks locally with MPI.
#
# Features Demonstrated:
# - Budget tracking: max_core_hours and cores_expr for resource management
# - Cache exclusion: cache_exclude_vars to exclude path-based variables from cache keys
# - Metadata saving: Automatic run_metadata.json for report generation
# - Analysis reports: Use --analyze to generate HTML reports with plots
#
# Usage:
#   Normal run:  python -m iops.main example_simple.yaml
#   Dry-run:     python -m iops.main example_simple.yaml --dry-run --estimated-time "60,120,300"
#   Analysis:    python -m iops.main --analyze /path/to/workdir/run_XXX
#

benchmark:
  name: "IOR Benchmark"
  description: "A benchmark to measure I/O performance using the IOR tool."
  workdir: "/home/luan/workdir/"
  cache_file: "/home/luan/iops.db"
  repetitions: 3 # global repetitions for each test case. It is ignored when rounds has its own value
  search_method: "exhaustive" # used to define the policy for test execution selection
  executor : "local" # specify the executor to use : local | slurm
  random_seed: 43  # seed for any random operations in the benchmark
  cache_exclude_vars: ["summary_file"]  # Exclude path-based derived vars
  # Budget configuration (optional)
  max_core_hours: 100  # Maximum CPU core-hours budget (can be overridden by --max-core-hours CLI argument)
  cores_expr: "{{ processes_per_node }}"  # Jinja expression to compute cores (defaults to 1 if not specified)
  report_vars: ["processes_per_node", "volume_size_gb"]  # Variables to use in analysis reports (excludes string 'summary_file')

vars:
  # Swept variables (global definition) 
  processes_per_node:
    type: int
    sweep:
      mode: range
      start: 1
      end: 8
      step: 1

  volume_size_gb:
    type: int
    sweep:
      mode: list
      values: [1, 4, 8]

  block_size_mb:
    type: int
    expr: "(volume_size_gb * 1024) / (processes_per_node) "

    
  summary_file:
    type: str
    expr: "{{ execution_dir }}/summary_{{ execution_id }}_{{ repetition }}.json"  
    
command:
  template: >    
    ior -w -b {{ block_size_mb }}mb -t 1mb
    -O summaryFile={{summary_file}} -O summaryFormat=JSON
    -o /home/luan/filesystem/output.ior 

  labels:
    operation: "write"
    io_engine: "MPI-IO"
    access_pattern: "contiguous"

scripts:
  - name: "ior" 
    script_template: |
      #!/bin/bash     
      
      set -euo pipefail # exit on error, undefined var, or failed pipe

      mpirun --oversubscribe  -np {{processes_per_node}} {{ command.template }}      
     
      echo "repetition {{ repetition }} completed."

    post:
      script: |
        #!/bin/bash
        echo "Job completed. Summary file located at {{ summary_file }}"

    parser:
      file: "{{ summary_file }}"
      metrics:
        - name: bwMiB
      parser_script: ../scripts/ior_parser.py

        

output:
  sink:
    type: csv          # parquet | csv | sqlite
    path: "{{ workdir }}/results.csv"
    exclude: ["benchmark.name", "benchmark.description"]            # optional, exclude fields from output
    table: results         # only for sqlite

