"""Global credentials management for MoAI-ADK.

Stores API keys:
- GLM API key: ~/.moai/.env.glm (dotenv format)
- Anthropic API key: ~/.moai/credentials.yaml (YAML format)
"""

import os
import stat
from pathlib import Path

import yaml


def get_credentials_path() -> Path:
    """Get the global credentials file path.

    Returns:
        Path to ~/.moai/credentials.yaml
    """
    return Path.home() / ".moai" / "credentials.yaml"


def get_env_glm_path() -> Path:
    """Get the GLM API key file path.

    Returns:
        Path to ~/.moai/.env.glm
    """
    return Path.home() / ".moai" / ".env.glm"


def glm_env_exists() -> bool:
    """Check if GLM API key file exists.

    Returns:
        True if ~/.moai/.env.glm exists
    """
    return get_env_glm_path().exists()


def load_glm_key_from_env() -> str | None:
    """Load GLM API key from ~/.moai/.env.glm.

    The file format is dotenv style: GLM_API_KEY=xxx

    Returns:
        GLM API key or None if not found
    """
    env_path = get_env_glm_path()

    if not env_path.exists():
        return None

    try:
        content = env_path.read_text(encoding="utf-8", errors="replace").strip()
        for line in content.splitlines():
            line = line.strip()
            if line.startswith("#") or not line:
                continue
            if line.startswith("GLM_API_KEY="):
                # Remove quotes if present
                value = line.split("=", 1)[1].strip()
                if value.startswith('"') and value.endswith('"'):
                    value = _unescape_dotenv_value(value[1:-1])
                elif value.startswith("'") and value.endswith("'"):
                    value = value[1:-1]
                return value if value else None
        return None
    except OSError:
        return None


def _set_owner_only_permissions(path: Path) -> None:
    """Set file permissions to owner-only (chmod 600).

    On Windows, os.chmod only controls the read-only flag and does not
    support Unix-style permissions. Errors are silently ignored on Windows.

    Args:
        path: File path to set permissions on
    """
    try:
        os.chmod(path, stat.S_IRUSR | stat.S_IWUSR)
    except OSError:
        # Windows or unsupported filesystem - skip permission setting
        pass


def _escape_dotenv_value(value: str) -> str:
    """Escape special characters for dotenv double-quoted value.

    Handles backslashes, double quotes, and dollar signs that could
    break the dotenv format or trigger unintended variable expansion.

    Args:
        value: Raw value to escape

    Returns:
        Escaped value safe for dotenv double-quoted format
    """
    value = value.replace("\\", "\\\\")
    value = value.replace('"', '\\"')
    value = value.replace("$", "\\$")
    return value


def _unescape_dotenv_value(value: str) -> str:
    """Unescape dotenv double-quoted value.

    Reverses the escaping applied by _escape_dotenv_value().

    Args:
        value: Escaped dotenv value

    Returns:
        Original unescaped value
    """
    value = value.replace("\\$", "$")
    value = value.replace('\\"', '"')
    value = value.replace("\\\\", "\\")
    return value


def save_glm_key_to_env(key: str) -> None:
    """Save GLM API key to ~/.moai/.env.glm.

    Args:
        key: GLM API key to save
    """
    env_path = get_env_glm_path()

    # Ensure directory exists
    env_path.parent.mkdir(parents=True, exist_ok=True)

    # Escape special characters for dotenv format
    escaped_key = _escape_dotenv_value(key)

    # Write in dotenv format
    content = f'# GLM API Key for MoAI-ADK\n# Generated by moai-adk\nGLM_API_KEY="{escaped_key}"\n'
    env_path.write_text(content, encoding="utf-8", errors="replace")

    # Set file permissions to owner-only (chmod 600)
    _set_owner_only_permissions(env_path)


def load_credentials() -> dict[str, str | None]:
    """Load credentials from ~/.moai/credentials.yaml.

    Returns:
        Dict with api keys (values may be None if not set)
    """
    creds_path = get_credentials_path()

    if not creds_path.exists():
        return {"anthropic_api_key": None, "glm_api_key": None}

    try:
        data = yaml.safe_load(creds_path.read_text(encoding="utf-8", errors="replace")) or {}
        return {
            "anthropic_api_key": data.get("anthropic_api_key"),
            "glm_api_key": data.get("glm_api_key"),
        }
    except (yaml.YAMLError, OSError):
        return {"anthropic_api_key": None, "glm_api_key": None}


def save_credentials(
    anthropic_api_key: str | None = None,
    glm_api_key: str | None = None,
    *,
    merge: bool = True,
) -> None:
    """Save credentials to ~/.moai/credentials.yaml.

    Args:
        anthropic_api_key: Anthropic API key (None to skip)
        glm_api_key: GLM API key (None to skip)
        merge: If True, merge with existing credentials. If False, overwrite.
    """
    creds_path = get_credentials_path()

    # Ensure directory exists
    creds_path.parent.mkdir(parents=True, exist_ok=True)

    # Load existing if merge mode
    if merge:
        existing = load_credentials()
    else:
        existing = {"anthropic_api_key": None, "glm_api_key": None}

    # Build final data with new values taking precedence
    data_to_save: dict[str, str] = {}

    # Add anthropic key
    final_anthropic = anthropic_api_key if anthropic_api_key is not None else existing.get("anthropic_api_key")
    if final_anthropic:
        data_to_save["anthropic_api_key"] = final_anthropic

    # Add GLM key
    final_glm = glm_api_key if glm_api_key is not None else existing.get("glm_api_key")
    if final_glm:
        data_to_save["glm_api_key"] = final_glm

    # Write with secure permissions
    yaml_content = yaml.safe_dump(data_to_save, default_flow_style=False, allow_unicode=True)
    creds_path.write_text(yaml_content, encoding="utf-8", errors="replace")

    # Set file permissions to owner-only (chmod 600)
    _set_owner_only_permissions(creds_path)


def get_glm_api_key() -> str | None:
    """Get GLM API key from multiple sources.

    Priority:
    1. ~/.moai/.env.glm (explicit user config takes precedence)
    2. ~/.moai/credentials.yaml (legacy, for backward compatibility)
    3. Environment variable GLM_API_KEY (fallback for CI/CD or shell export)

    Note: .env.glm file is prioritized over environment variable because
    users explicitly save keys there via 'moai glm' command. Environment
    variables may contain stale values from previous sessions.

    Returns:
        GLM API key or None if not found
    """
    # Check .env.glm file first (user's explicit choice)
    env_glm_key = load_glm_key_from_env()
    if env_glm_key:
        return env_glm_key

    # Fall back to credentials.yaml (legacy)
    creds = load_credentials()
    creds_key = creds.get("glm_api_key")
    if creds_key:
        return creds_key

    # Finally check environment variable (for CI/CD or manual export)
    env_key = os.environ.get("GLM_API_KEY")
    if env_key:
        return env_key

    return None


def get_anthropic_api_key() -> str | None:
    """Get Anthropic API key from credentials or environment.

    Priority:
    1. Environment variable ANTHROPIC_API_KEY
    2. ~/.moai/credentials.yaml

    Returns:
        Anthropic API key or None if not found
    """
    # Check environment first
    env_key = os.environ.get("ANTHROPIC_API_KEY")
    if env_key:
        return env_key

    # Fall back to credentials file
    creds = load_credentials()
    return creds.get("anthropic_api_key")


def remove_glm_key_from_shell_config() -> dict[str, bool]:
    """Remove GLM_API_KEY export from shell config files.

    Removes lines matching 'export GLM_API_KEY=' from ~/.zshrc and ~/.bashrc.
    Creates a backup before modifying.

    Returns:
        Dict with shell config names as keys and True if modified, False otherwise.
        Example: {"zshrc": True, "bashrc": False}
    """
    import re
    import shutil

    results: dict[str, bool] = {}
    shell_configs = [
        (Path.home() / ".zshrc", "zshrc"),
        (Path.home() / ".bashrc", "bashrc"),
    ]

    # Pattern to match: export GLM_API_KEY=... (with optional quotes)
    pattern = re.compile(r"^\s*export\s+GLM_API_KEY\s*=.*$", re.MULTILINE)

    for config_path, config_name in shell_configs:
        if not config_path.exists():
            results[config_name] = False
            continue

        try:
            original_content = config_path.read_text(encoding="utf-8", errors="replace")

            # Check if pattern exists
            if not pattern.search(original_content):
                results[config_name] = False
                continue

            # Create backup before modifying
            backup_path = config_path.with_suffix(f"{config_path.suffix}.moai-backup")
            shutil.copy2(config_path, backup_path)

            # Remove the export line(s)
            new_content = pattern.sub("", original_content)

            # Clean up multiple consecutive empty lines
            new_content = re.sub(r"\n{3,}", "\n\n", new_content)

            # Write back
            config_path.write_text(new_content, encoding="utf-8", errors="replace")
            results[config_name] = True

        except OSError:
            results[config_name] = False

    return results
