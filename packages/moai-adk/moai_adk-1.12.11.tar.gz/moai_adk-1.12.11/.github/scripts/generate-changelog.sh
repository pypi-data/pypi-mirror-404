#!/bin/bash

# Changelog ìƒì„± ìŠ¤í¬ë¦½íŠ¸
# Git íˆìŠ¤í† ë¦¬ë¡œë¶€í„° ìë™ìœ¼ë¡œ changelog entryë¥¼ ìƒì„±í•©ë‹ˆë‹¤

set -e

if [ -z "$1" ]; then
  echo "âŒ Usage: generate-changelog.sh <VERSION>"
  echo "   Example: generate-changelog.sh 0.31.0"
  exit 1
fi

VERSION="$1"
PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

echo "ğŸ“ Generating Changelog for $VERSION"
echo "   Previous tag: ${PREVIOUS_TAG:-'<initial release>'}"
echo ""

# Get commits since last tag
if [ -z "$PREVIOUS_TAG" ]; then
  COMMITS=$(git log --format="%h %s" --reverse)
else
  COMMITS=$(git log $PREVIOUS_TAG...HEAD --format="%h %s" --reverse)
fi

# Categorize commits
FEATURES=""
FIXES=""
DOCS=""
REFACTOR=""
OTHER=""

while IFS= read -r COMMIT; do
  if [[ $COMMIT == *"feat:"* ]]; then
    FEATURES+="- $(echo "$COMMIT" | sed 's/^[a-f0-9]* //')\n"
  elif [[ $COMMIT == *"fix:"* ]]; then
    FIXES+="- $(echo "$COMMIT" | sed 's/^[a-f0-9]* //')\n"
  elif [[ $COMMIT == *"docs:"* ]]; then
    DOCS+="- $(echo "$COMMIT" | sed 's/^[a-f0-9]* //')\n"
  elif [[ $COMMIT == *"refactor:"* ]]; then
    REFACTOR+="- $(echo "$COMMIT" | sed 's/^[a-f0-9]* //')\n"
  else
    OTHER+="- $(echo "$COMMIT" | sed 's/^[a-f0-9]* //')\n"
  fi
done <<< "$COMMITS"

# Create changelog entry
RELEASE_DATE=$(date +"%Y-%m-%d")

cat > CHANGELOG.entry.md << EOF
## [$VERSION] - $RELEASE_DATE

### ğŸ‡°ğŸ‡· í•œêµ­ì–´

#### âœ¨ ì£¼ìš” ê¸°ëŠ¥
EOF

if [ -n "$FEATURES" ]; then
  echo -e "$FEATURES" >> CHANGELOG.entry.md
else
  echo "- ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤" >> CHANGELOG.entry.md
fi

cat >> CHANGELOG.entry.md << EOF

#### ğŸ› ë²„ê·¸ ìˆ˜ì •
EOF

if [ -n "$FIXES" ]; then
  echo -e "$FIXES" >> CHANGELOG.entry.md
else
  echo "- ë²„ê·¸ ìˆ˜ì •ì´ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤" >> CHANGELOG.entry.md
fi

cat >> CHANGELOG.entry.md << EOF

#### ğŸ“š ë¬¸ì„œ
EOF

if [ -n "$DOCS" ]; then
  echo -e "$DOCS" >> CHANGELOG.entry.md
else
  echo "- ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤" >> CHANGELOG.entry.md
fi

cat >> CHANGELOG.entry.md << EOF

#### ğŸ”§ ê¸°íƒ€
- ë¦¬íŒ©í† ë§ ë° ê°œì„ ì‚¬í•­ì´ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤

#### ì„¤ì¹˜ ë°©ë²•
\`\`\`bash
# UV Tool ì‚¬ìš© (ê¶Œì¥)
uv tool install moai-adk
\`\`\`

---

### ğŸ‡ºğŸ‡¸ English

#### âœ¨ Features
EOF

if [ -n "$FEATURES" ]; then
  echo -e "$FEATURES" >> CHANGELOG.entry.md
else
  echo "- New features have been added" >> CHANGELOG.entry.md
fi

cat >> CHANGELOG.entry.md << EOF

#### ğŸ› Bug Fixes
EOF

if [ -n "$FIXES" ]; then
  echo -e "$FIXES" >> CHANGELOG.entry.md
else
  echo "- Bug fixes have been included" >> CHANGELOG.entry.md
fi

cat >> CHANGELOG.entry.md << EOF

#### ğŸ“š Documentation
EOF

if [ -n "$DOCS" ]; then
  echo -e "$DOCS" >> CHANGELOG.entry.md
else
  echo "- Documentation has been updated" >> CHANGELOG.entry.md
fi

cat >> CHANGELOG.entry.md << EOF

#### ğŸ”§ Other Changes
- Refactoring and improvements have been made

#### Installation
\`\`\`bash
# UV Tool (Recommended)
uv tool install moai-adk
\`\`\`

---

ğŸ¤– Generated by [Claude Code](https://claude.com/claude-code) - Automated Release Pipeline

EOF

echo "âœ… Changelog entry generated: CHANGELOG.entry.md"
echo ""
echo "ğŸ“‹ Entry preview:"
head -20 CHANGELOG.entry.md

exit 0
