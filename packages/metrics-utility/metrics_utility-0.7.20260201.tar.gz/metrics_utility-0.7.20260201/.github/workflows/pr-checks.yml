name: "PR checks"

on:
  pull_request:

jobs:
  pr-checks:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout metrics-utility (${{ github.ref }})"
        uses: actions/checkout@v6

      - name: "Install uv"
        uses: astral-sh/setup-uv@v7

      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: "pyproject.toml"

      - name: "Check for changes in uv.lock"
        run: |
          uv sync
          if ! git diff --quiet uv.lock; then
            echo "uv.lock has changed. Run 'uv sync' locally and commit the updated lock file."
            git diff uv.lock
            exit 1  # Fail the job
          fi

      - name: "Run ruff check"
        run: |
          uvx ruff check --output-format=github .

      - name: "Check ruff format"
        run: |
          uvx ruff format --check

      - name: "One logger to rule them all"
        run: |
          if rgrep "logging.getLogger(" metrics_utility | cut -d: -f1 | grep -v logger.py | grep . ; then
            echo "^ Please use logger imported from metrics_utility.logger instead of creating a new one" 1>&2
            false
          else
            true
          fi
