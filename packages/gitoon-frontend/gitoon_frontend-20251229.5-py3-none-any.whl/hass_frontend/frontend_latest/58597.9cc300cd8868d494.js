export const __rspack_esm_id="58597";export const __rspack_esm_ids=["58597"];export const __webpack_modules__={31396(e,a,t){t.a(e,async function(e,r){try{t.r(a);t(44114),t(18111),t(7588);var o=t(62826),s=t(96196),i=t(44457),l=t(94333),n=(t(76776),t(67094),t(38114)),u=t(23528),c=t(54706),d=t(3609),h=t(90433),_=t(20058),g=t(28455),p=t(48949),y=e([d,n,_]);[d,n,_]=y.then?(await y)():y;const v={group_by_floor:!0,group_by_area:!0};class f extends((0,c.E)((0,p.Q)(s.WF))){setConfig(e){this._config={...v,...e}}hassSubscribe(){return[(0,n.tb)(this.hass,{key:this._config?.collection_key}).subscribe(e=>{this._data=e})]}getCardSize(){return 5}getGridOptions(){return{columns:12,min_columns:6,rows:6,min_rows:2}}shouldUpdate(e){return e.has("_config")||e.has("_data")||e.has("_isMobileSize")}render(){if(!this._config)return s.s6;if(!this._data)return s.qy`${this.hass.localize("ui.panel.lovelace.cards.energy.loading")}`;const e=this._data.prefs,a=(0,n.E$)(e),{summedData:t,compareSummedData:r}=(0,n.gv)(this._data),{consumption:o,compareConsumption:i}=(0,n.DR)(t,void 0),c=getComputedStyle(this),d=[],_=[],g={id:"home",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.home"),value:Math.max(0,o.total.used_total),color:c.getPropertyValue("--primary-color").trim(),index:1};if(d.push(g),a.battery){const e=t.total.from_battery??0,a=t.total.to_battery??0;d.push({id:"battery",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:e,color:c.getPropertyValue("--energy-battery-out-color").trim(),index:0}),_.push({source:"battery",target:"home",value:o.total.used_battery}),d.push({id:"battery_in",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:a,color:c.getPropertyValue("--energy-battery-in-color").trim(),index:1}),o.total.grid_to_battery>0&&_.push({source:"grid",target:"battery_in",value:o.total.grid_to_battery}),o.total.solar_to_battery>0&&_.push({source:"solar",target:"battery_in",value:o.total.solar_to_battery})}if(a.grid){const e=t.total.from_grid??0;d.push({id:"grid",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:e,color:c.getPropertyValue("--energy-grid-consumption-color").trim(),index:0}),_.push({source:"grid",target:"home",value:o.total.used_grid})}if(a.solar){const e=t.total.solar??0;d.push({id:"solar",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.solar"),value:e,color:c.getPropertyValue("--energy-solar-color").trim(),index:0}),_.push({source:"solar",target:"home",value:o.total.used_solar})}if(a.grid&&a.grid[0].flow_to){const e=t.total.to_grid??0;d.push({id:"grid_return",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:e,color:c.getPropertyValue("--energy-grid-return-color").trim(),index:1}),o.total.battery_to_grid>0&&_.push({source:"battery",target:"grid_return",value:o.total.battery_to_grid}),o.total.solar_to_grid>0&&_.push({source:"solar",target:"grid_return",value:o.total.solar_to_grid})}let p=g.value;const y=[],v={};e.device_consumption.forEach((e,a)=>{const t=e.stat_consumption in this._data.stats&&(0,u.$j)(this._data.stats[e.stat_consumption])||0;if(t<.01)return;const r={id:e.stat_consumption,label:e.name||(0,u.$O)(this.hass,e.stat_consumption,this._data.statsMetadata[e.stat_consumption]),value:t,color:(0,h.fI)(a,c),index:4,parent:e.included_in_stat};r.parent?(v[r.id]=r.parent,_.push({source:r.parent,target:r.id})):p-=t,y.push(r)});const f=y.filter(e=>!v[e.id]),{group_by_area:m,group_by_floor:b}=this._config;if(m||b){const{areas:e,floors:a}=this._groupByFloorAndArea(f);Object.keys(a).sort((e,a)=>(this.hass.floors[a]?.level??-1/0)-(this.hass.floors[e]?.level??-1/0)).forEach(t=>{let r=`floor_${t}`;"no_floor"!==t&&b?(d.push({id:r,label:this.hass.floors[t].name,value:a[t].value,index:2,color:c.getPropertyValue("--primary-color").trim()}),_.push({source:"home",target:r})):r="home",a[t].areas.forEach(a=>{let t;if("no_area"!==a&&m){const o=`area_${a}`;d.push({id:o,label:this.hass.areas[a].name,value:e[a].value,index:3,color:c.getPropertyValue("--primary-color").trim()}),_.push({source:r,target:o,value:e[a].value}),t=o}else t=r;e[a].devices.forEach(e=>{_.push({source:t,target:e.id,value:e.value})})})})}else f.forEach(e=>{_.push({source:"home",target:e.id,value:e.value})});const x=this._getDeviceSections(v,y);x.forEach((e,a)=>{e.forEach(e=>{d.push({...e,index:4+a})})}),p>0&&(d.push({id:"untracked",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),value:p,color:c.getPropertyValue("--state-unavailable-color").trim(),index:3+x.length}),_.push({source:"home",target:"untracked",value:p}));const k=d.some(e=>e.value>0),$="vertical"===this._config.layout||"horizontal"!==this._config.layout&&this._isMobileSize;return s.qy` <ha-card .header="${this._config.title}" class="${(0,l.H)({"is-grid":"grid"===this.layout,"is-panel":"panel"===this.layout,"is-vertical":$})}"> <div class="card-content"> ${k?s.qy`<ha-sankey-chart .data="${{nodes:d,links:_}}" .vertical="${$}" .valueFormatter="${this._valueFormatter}"></ha-sankey-chart>`:s.qy`${this.hass.localize("ui.panel.lovelace.cards.energy.no_data_period")}`} </div> </ha-card> `}_groupByFloorAndArea(e){const a={no_area:{value:0,devices:[]}},t={no_floor:{value:0,areas:["no_area"]}};return e.forEach(e=>{const r=this.hass.states[e.id],{area:o,floor:s}=r?(0,g.l)(r,this.hass.entities,this.hass.devices,this.hass.areas,this.hass.floors):{area:null,floor:null};o?(o.area_id in a?(a[o.area_id].value+=e.value,a[o.area_id].devices.push(e)):a[o.area_id]={value:e.value,devices:[e]},s?s.floor_id in t?(t[s.floor_id].value+=e.value,t[s.floor_id].areas.includes(o.area_id)||t[s.floor_id].areas.push(o.area_id)):t[s.floor_id]={value:e.value,areas:[o.area_id]}:(t.no_floor.value+=e.value,t.no_floor.areas.includes(o.area_id)||t.no_floor.areas.unshift(o.area_id))):(a.no_area.value+=e.value,a.no_area.devices.push(e))}),{areas:a,floors:t}}_getDeviceSections(e,a){const t=[],r=[],o=Object.values(e),s={};return a.forEach(a=>{const s=a.id in e;o.includes(a.id)&&!s?t.push(a):r.push(a)}),Object.entries(e).forEach(([e,a])=>{t.some(e=>e.id===a)||(s[e]=a)}),t.length>0?[t,...this._getDeviceSections(s,r)]:[a]}constructor(...e){super(...e),this.hassSubscribeRequiredHostProps=["_config"],this._valueFormatter=e=>`<div style="direction:ltr; display: inline;">\n      ${(0,_.ZV)(e,this.hass.locale,e<.1?{maximumFractionDigits:3}:void 0)}\n      kWh</div>`}}f.styles=s.AH`ha-card{height:400px;display:flex;flex-direction:column;--chart-max-height:none}ha-card.is-vertical{height:500px}ha-card.is-grid,ha-card.is-panel{height:100%}.card-content{flex:1;display:flex}`,(0,o.Cg)([(0,i.MZ)({attribute:!1})],f.prototype,"hass",void 0),(0,o.Cg)([(0,i.MZ)({attribute:!1})],f.prototype,"layout",void 0),(0,o.Cg)([(0,i.wk)()],f.prototype,"_config",void 0),(0,o.Cg)([(0,i.wk)()],f.prototype,"_data",void 0),f=(0,o.Cg)([(0,i.EM)("hui-energy-sankey-card")],f),r()}catch(e){r(e)}})}};
//# sourceMappingURL=58597.9cc300cd8868d494.js.map