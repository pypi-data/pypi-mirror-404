export const __rspack_esm_id="77183";export const __rspack_esm_ids=["77183"];export const __webpack_modules__={91069(t,e,o){o.a(t,async function(t,r){try{o.d(e,{EO:()=>v,Yq:()=>D,_U:()=>M,eE:()=>W,fU:()=>T,ol:()=>b,xo:()=>w});var s=o(78016),a=o(31810),n=o(49134),i=o(81977),c=o(36307),l=o(35932),_=o(73983),u=o(6946),g=o(92913),f=o(83339),y=o(77972),m=o(31886),d=o(46927),p=t([m]);m=(p.then?(await p)():p)[0];const h=(t,e,o,r)=>{const s=o(new m.BB(t,e),r);return s instanceof Date?new Date(s.getTime()):s},b=(t,e,o,r,s)=>o.time_zone===d.Wj.server?h(t,r.time_zone,e,s):e(t,s),w=(t,e,o,r,s)=>o.time_zone===d.Wj.server?h(t,r.time_zone,e,s):e(t,s),v=(t,e,o,r,s)=>w(t,o,r,s,r.time_zone===d.Wj.server?new m.BB(e,s.time_zone):e),W=(t,e,o,r,m)=>{let d,p;if(w(t,s.e,r,m)&&w(e,a.c,r,m)){const s=(v(e,t,n.W,r,m)+1)*(o?1:-1);d=b(t,i.P,r,m,s),p=b(b(e,i.P,r,m,s),c.p,r,m)}else if(w(t,t=>(0,l.o)(t).getMilliseconds()===t.getMilliseconds(),r,m)&&w(e,t=>(0,_.D)(t).getMilliseconds()===t.getMilliseconds(),r,m)){const s=(v(e,t,u.c,r,m)+1)*(o?1:-1);d=b(t,g.f,r,m,s),p=b(e,g.f,r,m,s)}else{const s=v(e,t,f.b,r,m)*(o?1:-1);d=b(t,y.A,r,m,s),p=b(e,y.A,r,m,s)}return{start:d,end:p}},M=(t,e)=>{const o=new m.BB(t,e);return new Date(o.getTime())},D=(t,e)=>new m.BB(t,e).toISOString().split("T")[0],T=(t,e)=>new m.BB(t,e).toISOString().split("T")[1].split(".")[0];r()}catch(t){r(t)}})},46223(t,e,o){o.a(t,async function(t,r){try{o.d(e,{b:()=>v});var s=o(35932),a=o(73983),n=o(92913),i=o(52640),c=o(69137),l=o(35660),_=o(36307),u=o(11650),g=o(15797),f=o(33977),y=o(69748),m=o(55144),d=o(21828),p=o(66708),h=o(91069),b=o(380),w=t([h]);h=(w.then?(await w)():w)[0];const v=(t,e)=>{const o=new Date,r=(0,b.P)(t.locale);switch(e){case"today":return[(0,h.ol)(o,s.o,t.locale,t.config,{weekStartsOn:r}),(0,h.ol)(o,a.D,t.locale,t.config,{weekStartsOn:r})];case"yesterday":return[(0,h.ol)((0,n.f)(o,-1),s.o,t.locale,t.config,{weekStartsOn:r}),(0,h.ol)((0,n.f)(o,-1),a.D,t.locale,t.config,{weekStartsOn:r})];case"this_week":return[(0,h.ol)(o,i.k,t.locale,t.config,{weekStartsOn:r}),(0,h.ol)(o,c.$,t.locale,t.config,{weekStartsOn:r})];case"this_month":return[(0,h.ol)(o,l.w,t.locale,t.config),(0,h.ol)(o,_.p,t.locale,t.config)];case"this_quarter":return[(0,h.ol)(o,u.a,t.locale,t.config),(0,h.ol)(o,g.j,t.locale,t.config)];case"this_year":return[(0,h.ol)(o,f.D,t.locale,t.config),(0,h.ol)(o,y.Q,t.locale,t.config)];case"now-7d":return[(0,h.ol)(o,m.e,t.locale,t.config,7),(0,h.ol)(o,m.e,t.locale,t.config,0)];case"now-30d":return[(0,h.ol)(o,m.e,t.locale,t.config,30),(0,h.ol)(o,m.e,t.locale,t.config,0)];case"now-12m":return[(0,h.ol)((0,d.a)(o,12),l.w,t.locale,t.config),(0,h.ol)((0,d.a)(o,1),_.p,t.locale,t.config)];case"now-1h":return[(0,h.ol)(o,p.O,t.locale,t.config,1),(0,h.ol)(o,p.O,t.locale,t.config,0)];case"now-12h":return[(0,h.ol)(o,p.O,t.locale,t.config,12),(0,h.ol)(o,p.O,t.locale,t.config,0)];case"now-24h":return[(0,h.ol)(o,p.O,t.locale,t.config,24),(0,h.ol)(o,p.O,t.locale,t.config,0)]}return[o,o]};r()}catch(t){r(t)}})},5911(t,e,o){o.d(e,{$:()=>r});o(44114);const r=(t,e)=>{const o={};for(const r of t){const t=e(r);t in o?o[t].push(r):o[t]=[r]}return o}},38114(t,e,o){o.a(t,async function(t,r){try{o.d(e,{AN:()=>U,B2:()=>C,BV:()=>z,DR:()=>K,E$:()=>N,GW:()=>P,Q4:()=>E,RB:()=>S,WN:()=>j,X4:()=>Q,_d:()=>Y,al:()=>L,bs:()=>I,c:()=>B,gv:()=>X,h4:()=>st,lh:()=>D,m7:()=>k,n3:()=>ot,oU:()=>x,pe:()=>rt,t5:()=>at,tb:()=>F,uh:()=>O});o(44114),o(18111),o(81148),o(22489),o(7588),o(61701),o(17642),o(58004),o(33853),o(45876),o(32475),o(15024),o(31698);var s=o(6946),a=o(78016),n=o(31810),i=o(81977),c=o(49134),l=o(92913),_=o(77972),u=o(56434),g=o(35932),f=o(73983),y=o(57279),m=o(35518),d=o(22786),p=o(91069),h=o(30162),b=o(5911),w=o(23528),v=o(46223),W=o(20058),M=t([h,v,p,W]);[h,v,p,W]=M.then?(await M)():M;const T=[],k=()=>({stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),S=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_price:null,number_energy_price:null}),O=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),E=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),x=()=>({type:"battery",stat_energy_from:"",stat_energy_to:""}),B=()=>({type:"gas",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),P=()=>({type:"water",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),z=t=>t.callWS({type:"energy/info"}),C=async t=>(await t.loadBackendTranslation("issues","energy"),t.callWS({type:"energy/validate"})),I=t=>t.callWS({type:"energy/get_prefs"}),j=async(t,e)=>{const o=t.callWS({type:"energy/save_prefs",...e});return V(t),o},A=async(t,e,o,r,s,a="hour")=>t.callWS({type:"energy/fossil_energy_consumption",start_time:e.toISOString(),end_time:s?.toISOString(),energy_statistic_ids:o,co2_statistic_id:r,period:a}),N=t=>(0,b.$)(t.energy_sources,t=>t.type),U=(t,e,o)=>{const r=[];for(const s of t.energy_sources)if(!o||o.includes(s.type))if("solar"!==s.type){if("gas"===s.type||"water"===s.type){r.push(s.stat_energy_from),s.stat_cost&&r.push(s.stat_cost);const t=e.cost_sensors[s.stat_energy_from];t&&r.push(t);continue}if("battery"!==s.type){for(const t of s.flow_from){r.push(t.stat_energy_from),t.stat_cost&&r.push(t.stat_cost);const o=e.cost_sensors[t.stat_energy_from];o&&r.push(o)}for(const t of s.flow_to){r.push(t.stat_energy_to),t.stat_compensation&&r.push(t.stat_compensation);const o=e.cost_sensors[t.stat_energy_to];o&&r.push(o)}}else r.push(s.stat_energy_from),r.push(s.stat_energy_to)}else r.push(s.stat_energy_from);return o&&!o.includes("device")||r.push(...t.device_consumption.map(t=>t.stat_consumption)),o&&!o.includes("water")||r.push(...t.device_consumption_water.map(t=>t.stat_consumption)),r},$=t=>{const e=[];for(const o of t.energy_sources)"gas"!==o.type&&"water"!==o.type&&("solar"!==o.type&&"battery"!==o.type?o.power&&e.push(...o.power.map(t=>t.stat_rate)):e.push(o.stat_rate));return e.push(...t.device_consumption.map(t=>t.stat_rate)),e.filter(Boolean)};var D=function(t){return t.NONE="",t.PREVIOUS="previous",t.YOY="yoy",t}({});const G=async(t,e,o,r,g)=>{const f=await z(t);let y;for(const e of Object.values(t.entities)){if("co2signal"!==e.platform)continue;const o=t.states[e.entity_id];if(o&&"%"===o.attributes.unit_of_measurement){y=o.entity_id;break}}const m=[];for(const t of e.energy_sources)if("grid"===t.type)for(const e of t.flow_from)m.push(e.stat_energy_from);const d=U(e,f,["grid","solar","battery","gas","device"]),h=$(e),b=U(e,f,["water"]),v=[...d,...b,...h],W=(0,s.c)(r||new Date,o),M=(0,a.e)(o)&&(!r||(0,n.c)(r))&&W>35?"month":W>2?"day":"hour",D=W>64?"day":W>8?"hour":"5minute",T={},k=v.length?await(0,w.Wr)(t,v):[];v.length&&k.forEach(t=>{T[t.statistic_id]=t});const S=H(t,e,T),O={energy:"kWh",volume:w.r_.includes(S)?S:void 0},E=J(t,e,T),x={volume:E},B=d.length?(0,w.sz)(t,o,r,d,M,O,["change"]):{},P=h.length?(0,w.sz)(t,o,r,h,D,{power:"kW"},["mean"]):{},C=b.length?(0,w.sz)(t,o,r,b,M,x,["change"]):{};let I,j,N,G,V,q={},F={};g&&("previous"===g?(j=(0,p.xo)(o,a.e,t.locale,t.config)&&(0,p.xo)(r||new Date,n.c,t.locale,t.config)?(0,p.ol)(o,i.P,t.locale,t.config,-(0,p.EO)(r||new Date,o,c.W,t.locale,t.config)-1):(0,p.ol)(o,l.f,t.locale,t.config,-1*(W+1)),N=(0,_.A)(o,-1)):"yoy"===g&&(j=(0,p.ol)(o,u.e,t.locale,t.config,-1),N=(0,p.ol)(r,u.e,t.locale,t.config,-1)),d.length&&(q=(0,w.sz)(t,j,N,d,M,O,["change"])),b.length&&(F=(0,w.sz)(t,j,N,b,M,x,["change"]))),void 0!==y&&(G=A(t,o,m,y,r,W>35?"month":W>2?"day":"hour"),g&&(V=A(t,j,m,y,N,W>35?"month":W>2?"day":"hour")));const[L,R,Y,Q,X,Z,K]=await Promise.all([B,P,C,q,F,G,V]);g&&(I={...Q,...X});return{start:o,end:r,startCompare:j,endCompare:N,compareMode:g,info:f,prefs:e,stats:{...L,...Y,...R},statsMetadata:T,statsCompare:I,co2SignalEntity:y,fossilEnergyConsumption:Z,fossilEnergyConsumptionCompare:K,waterUnit:E,gasUnit:S}},V=t=>{T.forEach(e=>{const o=F(t,{key:e});o.clearPrefs(),o._active&&o.refresh()})},q=t=>{if(t._refreshTimeout&&clearTimeout(t._refreshTimeout),t._active&&(!t.end||t.end>new Date)){const e=new Date;e.getMinutes()>=20&&e.setHours(e.getHours()+1),e.setMinutes(20,0,0),t._refreshTimeout=window.setTimeout(()=>t.refresh(),e.getTime()-Date.now())}},F=(t,e={})=>{let o="_energy";if(e.key){if(!e.key.startsWith("energy_"))throw new Error("Key need to start with energy_");o=`_${e.key}`}if(t.connection[o])return t.connection[o];T.push(e.key);const r=(0,m.X)(t.connection,o,async()=>(r.prefs||(r.prefs=await I(t)),q(r),G(t,r.prefs,r.start,r.end,r.compare))),s=r.subscribe;r.subscribe=t=>{const e=s(t);return r._active++,void 0===r._refreshTimeout&&q(r),()=>{r._active--,r._active<1&&(clearTimeout(r._refreshTimeout),r._refreshTimeout=void 0),e()}},r._active=0,r.prefs=e.prefs;const a=new Date,n=(0,h.LW)(a,t.locale,t.config).split(":")[0],i=localStorage.getItem(`energy-default-period-${o}`)||"today",c="today"===i&&"0"===n?"yesterday":i,[l,_]=(0,v.b)(t,c);r.start=(0,p.ol)(l,g.o,t.locale,t.config),r.end=(0,p.ol)(_,f.D,t.locale,t.config);const u=()=>{r._updatePeriodTimeout=window.setTimeout(()=>{r.start=(0,p.ol)(new Date,g.o,t.locale,t.config),r.end=(0,p.ol)(new Date,f.D,t.locale,t.config),r.refresh(),u()},(0,y.L)((0,p.ol)(new Date,f.D,t.locale,t.config),1).getTime()-Date.now())};return u(),r.clearPrefs=()=>{r.prefs=void 0},r.setPeriod=(e,o)=>{r._updatePeriodTimeout&&(clearTimeout(r._updatePeriodTimeout),r._updatePeriodTimeout=void 0),r.start=e,r.end=o,r.start.getTime()===(0,p.ol)(new Date,g.o,t.locale,t.config).getTime()&&r.end?.getTime()===(0,p.ol)(new Date,f.D,t.locale,t.config).getTime()&&u()},r.setCompare=t=>{r.compare=t},r},L=t=>t.callWS({type:"energy/solar_forecast"}),R=["volume","energy"],Y=(t,e,o={})=>{for(const r of t.energy_sources){if("gas"!==r.type)continue;if(e&&e===r.stat_energy_from)continue;const t=o[r.stat_energy_from];if(R.includes(t?.unit_class))return t.unit_class}},H=(t,e,o={})=>{if("energy"===Y(e,void 0,o))return"kWh";const r=e.energy_sources.filter(t=>"gas"===t.type).map(e=>(0,w.JE)(t,e.stat_energy_from,o[e.stat_energy_from]));if(r.length){const t=r[0];if(w.r_.includes(t)&&r.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"m³":"ft³"},J=(t,e,o)=>{const r=e.energy_sources.filter(t=>"water"===t.type).map(e=>(0,w.JE)(t,e.stat_energy_from,o[e.stat_energy_from]));if(r.length){const t=r[0];if(w.r_.includes(t)&&r.every(e=>e===t))return t}return"km"===t.config.unit_system.length?"L":"gal"},Q="/docs/energy/faq/#troubleshooting-missing-entities",X=(0,d.A)(t=>({summedData:Z(t),compareSummedData:t.statsCompare?Z(t,!0):void 0})),Z=(t,e)=>{const o={};for(const e of t.prefs.energy_sources)if("solar"!==e.type)if("battery"!==e.type){if("grid"===e.type){for(const t of e.flow_from)o.from_grid?o.from_grid.push(t.stat_energy_from):o.from_grid=[t.stat_energy_from];for(const t of e.flow_to)o.to_grid?o.to_grid.push(t.stat_energy_to):o.to_grid=[t.stat_energy_to]}}else o.to_battery?(o.to_battery.push(e.stat_energy_to),o.from_battery.push(e.stat_energy_from)):(o.to_battery=[e.stat_energy_to],o.from_battery=[e.stat_energy_from]);else o.solar?o.solar.push(e.stat_energy_from):o.solar=[e.stat_energy_from];const r={total:{},timestamps:[]},s=new Set;return Object.entries(o).forEach(([o,a])=>{const n={},i={};let c=0;a.forEach(o=>{const r=e?t.statsCompare[o]:t.stats[o];if(!r)return;r.forEach(t=>{if(null===t.change||void 0===t.change)return;const e=t.change;c+=e,n[t.start]=t.start in n?n[t.start]+e:e,s.add(t.start)}),i[o]={}}),r[o]=n,r.total[o]=c}),r.timestamps=Array.from(s).sort(),r},K=(0,d.A)((t,e)=>({consumption:tt(t),compareConsumption:e?tt(e):void 0})),tt=t=>{const e={used_total:{},grid_to_battery:{},battery_to_grid:{},solar_to_battery:{},solar_to_grid:{},used_solar:{},used_grid:{},used_battery:{},total:{used_total:0,grid_to_battery:0,battery_to_grid:0,solar_to_battery:0,solar_to_grid:0,used_solar:0,used_grid:0,used_battery:0}};return t.timestamps.forEach(o=>{const{grid_to_battery:r,battery_to_grid:s,used_solar:a,used_grid:n,used_battery:i,used_total:c,solar_to_battery:l,solar_to_grid:_}=et({from_grid:t.from_grid&&(t.from_grid[o]??0),to_grid:t.to_grid&&(t.to_grid[o]??0),solar:t.solar&&(t.solar[o]??0),to_battery:t.to_battery&&(t.to_battery[o]??0),from_battery:t.from_battery&&(t.from_battery[o]??0)});e.used_total[o]=c,e.total.used_total+=c,e.grid_to_battery[o]=r,e.total.grid_to_battery+=r,e.battery_to_grid[o]=s,e.total.battery_to_grid+=s,e.used_battery[o]=i,e.total.used_battery+=i,e.used_grid[o]=n,e.total.used_grid+=n,e.used_solar[o]=a,e.total.used_solar+=a,e.solar_to_battery[o]=l,e.total.solar_to_battery+=l,e.solar_to_grid[o]=_,e.total.solar_to_grid+=_}),e},et=t=>{let e=Math.max(t.to_grid||0,0),o=Math.max(t.to_battery||0,0),r=Math.max(t.solar||0,0),s=Math.max(t.from_grid||0,0),a=Math.max(t.from_battery||0,0);const n=(s||0)+(r||0)+(a||0)-(e||0)-(o||0);let i=0,c=0,l=0,_=0,u=0,g=0,f=0,y=Math.max(n,0);const m=Math.max(0,Math.min(o,s-y));c+=m,o-=m,s-=m,_=Math.min(r,o),o-=_,r-=_,u=Math.min(r,e),e-=u,r-=u,l=Math.min(a,e),a-=l,e-=l;const d=Math.min(s,o);return c+=d,s-=d,o-=d,i=Math.min(y,r),y-=i,r-=i,g=Math.min(a,y),a-=g,y-=g,f=Math.min(y,s),s-=f,y-=s,{used_solar:i,used_grid:f,used_battery:g,used_total:n,grid_to_battery:c,battery_to_grid:l,solar_to_battery:_,solar_to_grid:u}},ot=(t,e,o,r)=>{const s=["Wh","kWh","MWh","GWh","TWh"];let a=o,n=e||0,i=-1;r&&(i=s.findIndex(t=>t===r));let c=s.findIndex(t=>t===o);if(c>=0){for(;i>-1?i<c:Math.abs(n)<1&&c>0;)n*=1e3,c--;for(;i>-1?i>c:Math.abs(n)>=1e3&&c<s.length-1;)n/=1e3,c++;a=s[c]}return(0,W.ZV)(n,t.locale,{maximumFractionDigits:Math.abs(n)<10?2:Math.abs(n)<100?1:0})+" "+a},rt=(t,e)=>{if(!e.total.solar)return;const{consumption:o,compareConsumption:r}=K(e,void 0);if(!t){const t=e.total.solar;return o.total.used_solar/t*100}let s=0,a=0;const n=[];e.timestamps.forEach(t=>{s+=o.used_solar[t]??0,a+=o.solar_to_grid[t]??0,o.grid_to_battery[t]&&n.push({type:"grid",value:o.grid_to_battery[t]}),o.solar_to_battery[t]&&n.push({type:"solar",value:o.solar_to_battery[t]});let e=o.battery_to_grid[t]??0,r=o.used_battery[t]??0;const i=function(t){const e=n[n.length-1],o=e.type;if(t>=e.value){const t=e.value;return n.pop(),{energy:t,type:o}}return e.value-=t,{energy:t,type:o}};for(;r>0&&n.length;){const{energy:t,type:e}=i(r);"solar"===e&&(s+=t),r-=t}for(;e>0&&n.length;){const{energy:t,type:o}=i(e);"solar"===o&&(a+=t),e-=t}});const i=s+a;return!!i?s/i*100:void 0},st=t=>{if(!t)return;const e=parseFloat(t.state);if(isNaN(e))return;switch(t.attributes.unit_of_measurement){case"W":default:return e;case"kW":return 1e3*e;case"mW":return e/1e3;case"MW":return 1e6*e;case"GW":return 1e9*e;case"TW":return 1e12*e}},at=(t,e)=>{const o=["W","kW","MW","GW","TW"];let r=0,s=e;for(;Math.abs(s)>=1e3&&r<o.length-1;)s/=1e3,r++;return(0,W.ZV)(s,t.locale,{maximumFractionDigits:"W"===o[r]?0:3})+" "+o[r]};r()}catch(t){r(t)}})}};
//# sourceMappingURL=77183.351ffb7898fe534f.js.map