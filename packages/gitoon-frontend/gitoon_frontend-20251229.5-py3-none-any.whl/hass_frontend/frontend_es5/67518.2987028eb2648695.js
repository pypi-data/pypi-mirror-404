"use strict";(self.webpackChunkgitoon_frontend=self.webpackChunkgitoon_frontend||[]).push([["67518"],{59277:function(e,t,a){a.a(e,async function(e,r){try{a.r(t);var i,o,s,n,l,u=a(7739),c=a(78261),d=a(72153),h=a(31432),_=a(44734),v=a(43080),f=a(69683),g=a(6454),y=(a(28706),a(2008),a(74423),a(23792),a(44114),a(26910),a(13609),a(18111),a(22489),a(7588),a(36033),a(69085),a(5506),a(79432),a(26099),a(16034),a(31415),a(17642),a(58004),a(33853),a(45876),a(32475),a(15024),a(31698),a(21699),a(47764),a(42762),a(23500),a(62953),a(40445)),p=a(96196),b=a(77845),m=a(94333),k=(a(76776),a(67094),a(38114)),w=a(54706),x=a(3609),E=a(90433),M=a(28455),A=a(48949),P=e([x,k]);[x,k]=P.then?(await P)():P;var C={group_by_floor:!0,group_by_area:!0},z=function(e){function t(){var e;(0,_.A)(this,t);for(var a=arguments.length,r=new Array(a),i=0;i<a;i++)r[i]=arguments[i];return(e=(0,f.A)(this,t,[].concat(r)))._entities=new Set,e.hassSubscribeRequiredHostProps=["_config"],e._valueFormatter=function(t){return'<div style="direction:ltr; display: inline;">\n      '.concat((0,k.t5)(e.hass,t),"\n    </div>")},e}return(0,g.A)(t,e),(0,v.A)(t,[{key:"setConfig",value:function(e){this._config=Object.assign(Object.assign({},C),e)}},{key:"hassSubscribe",value:function(){var e,t=this;return[(0,k.tb)(this.hass,{key:null===(e=this._config)||void 0===e?void 0:e.collection_key}).subscribe(function(e){t._data=e})]}},{key:"getCardSize",value:function(){return 5}},{key:"getGridOptions",value:function(){return{columns:12,min_columns:6,rows:6,min_rows:2}}},{key:"shouldUpdate",value:function(e){if(e.has("_config")||e.has("_data")||e.has("_isMobileSize"))return!0;if(e.has("hass")){var t=e.get("hass");if(!t||!this._entities.size)return!0;var a,r=(0,h.A)(this._entities);try{for(r.s();!(a=r.n()).done;){var i=a.value;if(t.states[i]!==this.hass.states[i])return!0}}catch(o){r.e(o)}finally{r.f()}}return!1}},{key:"render",value:function(){var e=this;if(!this._config)return p.s6;if(!this._data)return(0,p.qy)(i||(i=(0,d.A)(["",""])),this.hass.localize("ui.panel.lovelace.cards.energy.loading"));var t=this._data.prefs,a=this._computePowerData(t),r=getComputedStyle(this),l=[],u=[],c={id:"home",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.home"),value:Math.max(0,a.used_total),color:r.getPropertyValue("--primary-color").trim(),index:1};l.push(c),a.from_battery>0&&(l.push({id:"battery",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:a.from_battery,color:r.getPropertyValue("--energy-battery-out-color").trim(),index:0}),u.push({source:"battery",target:"home"})),a.to_battery>0&&(l.push({id:"battery_in",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:a.to_battery,color:r.getPropertyValue("--energy-battery-in-color").trim(),index:1}),a.grid_to_battery>0&&u.push({source:"grid",target:"battery_in"}),a.solar_to_battery>0&&u.push({source:"solar",target:"battery_in"})),a.from_grid>0&&(l.push({id:"grid",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:a.from_grid,color:r.getPropertyValue("--energy-grid-consumption-color").trim(),index:0}),u.push({source:"grid",target:"home"})),a.solar>0&&(l.push({id:"solar",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.solar"),value:a.solar,color:r.getPropertyValue("--energy-solar-color").trim(),index:0}),u.push({source:"solar",target:"home"})),a.to_grid>0&&(l.push({id:"grid_return",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:a.to_grid,color:r.getPropertyValue("--energy-grid-return-color").trim(),index:1}),a.battery_to_grid>0&&u.push({source:"battery",target:"grid_return"}),a.solar_to_grid>0&&u.push({source:"solar",target:"grid_return"}));var h=c.value,_=[],v={},f=new Map;t.device_consumption.forEach(function(e){f.set(e.stat_consumption,{stat_rate:e.stat_rate,included_in_stat:e.included_in_stat})});var g=new Set;t.device_consumption.forEach(function(t){t.stat_rate&&(e._getCurrentPower(t.stat_rate)>=10&&g.add(t.stat_rate))});t.device_consumption.forEach(function(t,a){if(t.stat_rate){var i=e._getCurrentPower(t.stat_rate);if(!(i<10)){var o=function(e){for(var t=e;t;){var a=f.get(t);if(!a)return;if(a.stat_rate&&g.has(a.stat_rate))return a.stat_rate;t=a.included_in_stat}}(t.included_in_stat),s={id:t.stat_rate,label:t.name||e._getEntityLabel(t.stat_rate),value:i,color:(0,E.fI)(a,r),index:4,parent:o};s.parent?(v[s.id]=s.parent,u.push({source:s.parent,target:s.id})):h-=i,_.push(s)}}});var y=_.filter(function(e){return!v[e.id]}),b=this._config,k=b.group_by_area,w=b.group_by_floor;if(k||w){var x=this._groupByFloorAndArea(y),M=x.areas,A=x.floors;Object.keys(A).sort(function(t,a){var r,i,o,s;return(null!==(r=null===(i=e.hass.floors[a])||void 0===i?void 0:i.level)&&void 0!==r?r:-1/0)-(null!==(o=null===(s=e.hass.floors[t])||void 0===s?void 0:s.level)&&void 0!==o?o:-1/0)}).forEach(function(t){var a="floor_".concat(t);"no_floor"!==t&&w?(l.push({id:a,label:e.hass.floors[t].name,value:A[t].value,index:2,color:r.getPropertyValue("--primary-color").trim()}),u.push({source:"home",target:a})):a="home",A[t].areas.forEach(function(t){var i;if("no_area"!==t&&k){var o,s="area_".concat(t);l.push({id:s,label:(null===(o=e.hass.areas[t])||void 0===o?void 0:o.name)||t,value:M[t].value,index:3,color:r.getPropertyValue("--primary-color").trim()}),u.push({source:a,target:s,value:M[t].value}),i=s}else i=a;M[t].devices.forEach(function(e){u.push({source:i,target:e.id,value:e.value})})})})}else y.forEach(function(e){u.push({source:"home",target:e.id,value:e.value})});var P=this._getDeviceSections(v,_);P.forEach(function(e,t){e.forEach(function(e){l.push(Object.assign(Object.assign({},e),{},{index:4+t}))})}),h>0&&(l.push({id:"untracked",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),value:h,color:r.getPropertyValue("--state-unavailable-color").trim(),index:3+P.length}),u.push({source:"home",target:"untracked",value:h}));var C=l.some(function(e){return e.value>0}),z="vertical"===this._config.layout||"horizontal"!==this._config.layout&&this._isMobileSize;return(0,p.qy)(o||(o=(0,d.A)([' <ha-card .header="','" class="','"> <div class="card-content"> '," </div> </ha-card> "])),this._config.title,(0,m.H)({"is-grid":"grid"===this.layout,"is-panel":"panel"===this.layout,"is-vertical":z}),C?(0,p.qy)(s||(s=(0,d.A)(['<ha-sankey-chart .data="','" .vertical="','" .valueFormatter="','"></ha-sankey-chart>'])),{nodes:l,links:u},z,this._valueFormatter):(0,p.qy)(n||(n=(0,d.A)(["",""])),this.hass.localize("ui.panel.lovelace.cards.energy.no_data")))}},{key:"_computePowerData",value:function(e){var t=this;this._entities.clear();var a=0,r=0,i=0,o=0,s=0;e.energy_sources.filter(function(e){return"solar"===e.type}).forEach(function(e){if("solar"===e.type&&e.stat_rate){var r=t._getCurrentPower(e.stat_rate);r>0&&(a+=r)}}),e.energy_sources.filter(function(e){return"grid"===e.type&&e.power}).forEach(function(e){"grid"===e.type&&e.power&&e.power.forEach(function(e){var a=t._getCurrentPower(e.stat_rate);a>0?r+=a:a<0&&(i+=Math.abs(a))})}),e.energy_sources.filter(function(e){return"battery"===e.type}).forEach(function(e){if("battery"===e.type&&e.stat_rate){var a=t._getCurrentPower(e.stat_rate);a>0?o+=a:a<0&&(s+=Math.abs(a))}});var n,l,u,c,d,h,_=r+a+o-i-s,v=a,f=r,g=o,y=s,p=i,b=Math.max(_,0),m=0,k=Math.max(0,Math.min(y,f-b));m+=k,y-=k,f-=k,y-=l=Math.min(v,y),v-=l,p-=u=Math.min(v,p),v-=u,g-=n=Math.min(g,p),p-=n;var w=Math.min(f,y);return m+=w,f-=w,y-=w,b-=c=Math.min(b,v),v-=c,g-=d=Math.min(g,b),b-=d,f-=h=Math.min(b,f),b-=h,{solar:a,from_grid:r,to_grid:i,from_battery:o,to_battery:s,grid_to_battery:m,battery_to_grid:n,solar_to_battery:l,solar_to_grid:u,used_solar:c,used_grid:h,used_battery:d,used_total:Math.max(0,_)}}},{key:"_groupByFloorAndArea",value:function(e){var t=this,a={no_area:{value:0,devices:[]}},r={no_floor:{value:0,areas:["no_area"]}};return e.forEach(function(e){var i=t.hass.states[e.id],o=i?(0,M.l)(i,t.hass.entities,t.hass.devices,t.hass.areas,t.hass.floors):{area:null,floor:null},s=o.area,n=o.floor;s?(s.area_id in a?(a[s.area_id].value+=e.value,a[s.area_id].devices.push(e)):a[s.area_id]={value:e.value,devices:[e]},n?n.floor_id in r?(r[n.floor_id].value+=e.value,r[n.floor_id].areas.includes(s.area_id)||r[n.floor_id].areas.push(s.area_id)):r[n.floor_id]={value:e.value,areas:[s.area_id]}:(r.no_floor.value+=e.value,r.no_floor.areas.includes(s.area_id)||r.no_floor.areas.unshift(s.area_id))):(a.no_area.value+=e.value,a.no_area.devices.push(e))}),{areas:a,floors:r}}},{key:"_getDeviceSections",value:function(e,t){var a=[],r=[],i=Object.values(e),o={};return t.forEach(function(t){var o=t.id in e;i.includes(t.id)&&!o?a.push(t):r.push(t)}),Object.entries(e).forEach(function(e){var t=(0,c.A)(e,2),r=t[0],i=t[1];a.some(function(e){return e.id===i})||(o[r]=i)}),a.length>0?[a].concat((0,u.A)(this._getDeviceSections(o,r))):[t]}},{key:"_getCurrentPower",value:function(e){var t;return this._entities.add(e),null!==(t=(0,k.h4)(this.hass.states[e]))&&void 0!==t?t:0}},{key:"_getEntityLabel",value:function(e){var t=this.hass.states[e];return t&&t.attributes.friendly_name||e}}])}((0,w.E)((0,A.Q)(p.WF)));z.styles=(0,p.AH)(l||(l=(0,d.A)(["ha-card{height:400px;display:flex;flex-direction:column;--chart-max-height:none}ha-card.is-vertical{height:500px}ha-card.is-grid,ha-card.is-panel{height:100%}.card-content{flex:1;display:flex}"]))),(0,y.Cg)([(0,b.MZ)({attribute:!1})],z.prototype,"hass",void 0),(0,y.Cg)([(0,b.MZ)({attribute:!1})],z.prototype,"layout",void 0),(0,y.Cg)([(0,b.wk)()],z.prototype,"_config",void 0),(0,y.Cg)([(0,b.wk)()],z.prototype,"_data",void 0),z=(0,y.Cg)([(0,b.EM)("hui-power-sankey-card")],z),r()}catch(S){r(S)}})}}]);
//# sourceMappingURL=67518.2987028eb2648695.js.map