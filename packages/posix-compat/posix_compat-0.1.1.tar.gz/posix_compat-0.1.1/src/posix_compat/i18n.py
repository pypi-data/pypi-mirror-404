import locale
import sys
import os

# Dictionary containing all translations
TRANSLATIONS = {
    "en": {
        "lang_name": "English",
        "err_no_file": "No such file or directory",
        "err_not_dir": "Not a directory",
        "err_perm": "Permission denied",
        "err_is_dir": "Is a directory",
        "err_cmd_not_found": "Command not found",
        "err_missing_arg": "missing argument",
        "err_missing_operand": "missing operand",
        "err_binary": "Binary file (not displayed)",
        "msg_changed_dir": "Changed directory to {}",
        "msg_created_dir": "Created directory: {}",
        "msg_touched": "Touched {}",
        "msg_removed_dir": "Removed directory {}",
        "msg_removed_file": "Removed file {}",
        "msg_copied_dir": "Copied directory {} to {}",
        "msg_copied_file": "Copied file {} to {}",
        "msg_moved": "Moved {} to {}",
        "help_ls": "List directory contents",
        "help_cd": "Change directory",
        "help_pwd": "Print working directory",
        "help_mkdir": "Create directory",
        "help_touch": "Create file or update timestamp",
        "help_rm": "Remove file or directory",
        "help_cp": "Copy file or directory",
        "help_mv": "Move file or directory",
        "help_cat": "Concatenate and display file content",
        "help_uname": "Print system information",
        "help_find": "Search for files",
        "help_grep": "Print lines matching a pattern",
        "help_head": "Output the first part of files",
        "help_tail": "Output the last part of files",
        "help_wc": "Print newline, word, and byte counts",
        "help_echo": "Display a line of text",
        "help_sort": "Sort lines of text files",
        "help_uniq": "Report or omit repeated lines",
        "help_whoami": "Print effective userid",
        "help_date": "Print or set the system date and time",
        "help_env": "Print environment variables",
        "help_du": "Estimate file space usage",
        "help_uptime": "Tell how long the system has been running",
        "help_chmod": "Change file mode bits",
        "help_tar": "Store, list or extract files in an archive",
        "help_zip": "Package and compress (archive) files",
        "help_lscpu": "Display information about the CPU architecture",
        "help_lspci": "List all PCI devices",
        "help_lsusb": "List USB devices",
        "help_free": "Display amount of free and used memory",
        "help_df": "Report file system disk space usage",
        "help_hostname": "Show or set the system's host name",
        "help_ps": "Report a snapshot of the current processes",
        "help_kill": "Send a signal to a process",
        "help_who": "Show who is logged on",
        "help_clear": "Clear output",
        "help_exit": "Exit application",
        "repl_start": "Starting POSIX Compatibility Shell. Type 'exit' to quit.",
        "gui_title": "POSIX Compatibility Layer GUI",
        "gui_ready": "Ready",
        "gui_curr_dir": "Current Directory: {}",
        "gui_btn_ls": "ls",
        "gui_btn_pwd": "pwd",
        "gui_btn_uname": "uname",
        "gui_btn_clear": "Clear",
        "gui_btn_help": "Help",
        "gui_lbl_model": "Model",
        "gui_btn_refresh": "Refresh",
        "gui_btn_ask_ai": "Ask AI",
        "gui_btn_ai_suggest": "Suggest Cmd",
        "err_ollama_not_found": "Ollama not reachable",
        "msg_ai_thinking": "AI is thinking...",
        "menu_lang": "Language",
    },
    "zh": {
        "lang_name": "中文",
        "err_no_file": "没有那个文件或目录",
        "err_not_dir": "不是目录",
        "err_perm": "权限不够",
        "err_is_dir": "是一个目录",
        "err_cmd_not_found": "未找到命令",
        "err_missing_arg": "缺少参数",
        "err_missing_operand": "缺少操作数",
        "err_binary": "二进制文件（不显示）",
        "msg_changed_dir": "已切换目录至 {}",
        "msg_created_dir": "已创建目录: {}",
        "msg_touched": "已更新 {}",
        "msg_removed_dir": "已删除目录 {}",
        "msg_removed_file": "已删除文件 {}",
        "msg_copied_dir": "已复制目录 {} 到 {}",
        "msg_copied_file": "已复制文件 {} 到 {}",
        "msg_moved": "已移动 {} 到 {}",
        "help_ls": "列出目录内容",
        "help_cd": "切换目录",
        "help_pwd": "打印工作目录",
        "help_mkdir": "创建目录",
        "help_touch": "创建文件或更新时间戳",
        "help_rm": "删除文件或目录",
        "help_cp": "复制文件或目录",
        "help_mv": "移动文件或目录",
        "help_cat": "连接并显示文件内容",
        "help_uname": "打印系统信息",
        "help_find": "搜索文件",
        "help_grep": "打印匹配模式的行",
        "help_head": "输出文件的开头部分",
        "help_tail": "输出文件的结尾部分",
        "help_wc": "打印行数、单词数和字节数",
        "help_echo": "显示一行文本",
        "help_sort": "对文本文件的行进行排序",
        "help_uniq": "报告或省略重复行",
        "help_whoami": "打印当前用户名",
        "help_date": "打印或设置系统日期和时间",
        "help_env": "打印环境变量",
        "help_du": "估算文件空间使用量",
        "help_uptime": "显示系统运行了多长时间",
        "help_chmod": "更改文件模式位",
        "help_tar": "存储、列出或提取归档文件",
        "help_zip": "打包和压缩文件",
        "help_lscpu": "显示CPU架构信息",
        "help_lspci": "列出所有PCI设备",
        "help_lsusb": "列出USB设备",
        "help_free": "显示空闲和已用的内存量",
        "help_df": "报告文件系统磁盘空间使用情况",
        "help_hostname": "显示或设置系统的主机名",
        "help_ps": "报告当前进程的快照",
        "help_kill": "向进程发送信号",
        "help_who": "显示谁登录了",
        "help_clear": "清空输出",
        "help_exit": "退出程序",
        "repl_start": "正在启动 POSIX 兼容 Shell。输入 'exit' 退出。",
        "gui_title": "POSIX 兼容层图形界面",
        "gui_ready": "就绪",
        "gui_curr_dir": "当前目录: {}",
        "gui_btn_ls": "列出(ls)",
        "gui_btn_pwd": "路径(pwd)",
        "gui_btn_uname": "系统(uname)",
        "gui_btn_clear": "清空",
        "gui_btn_help": "帮助",
        "gui_lbl_model": "模型",
        "gui_btn_refresh": "刷新",
        "gui_btn_ask_ai": "询问AI",
        "gui_btn_ai_suggest": "建议命令",
        "err_ollama_not_found": "无法连接Ollama",
        "msg_ai_thinking": "AI思考中...",
        "menu_lang": "语言",
    },
    "ja": {
        "lang_name": "日本語",
        "err_no_file": "そのようなファイルやディレクトリはありません",
        "err_not_dir": "ディレクトリではありません",
        "err_perm": "許可がありません",
        "err_is_dir": "ディレクトリです",
        "err_cmd_not_found": "コマンドが見つかりません",
        "err_missing_arg": "引数が不足しています",
        "err_missing_operand": "オペランドが不足しています",
        "err_binary": "バイナリファイル（表示されません）",
        "msg_changed_dir": "ディレクトリを {} に変更しました",
        "msg_created_dir": "ディレクトリを作成しました: {}",
        "msg_touched": "{} を更新しました",
        "msg_removed_dir": "ディレクトリ {} を削除しました",
        "msg_removed_file": "ファイル {} を削除しました",
        "msg_copied_dir": "ディレクトリ {} を {} にコピーしました",
        "msg_copied_file": "ファイル {} を {} にコピーしました",
        "msg_moved": "{} を {} に移動しました",
        "help_ls": "ディレクトリの内容を一覧表示",
        "help_cd": "ディレクトリを変更",
        "help_pwd": "作業ディレクトリを表示",
        "help_mkdir": "ディレクトリを作成",
        "help_touch": "ファイルを作成またはタイムスタンプを更新",
        "help_rm": "ファイルまたはディレクトリを削除",
        "help_cp": "ファイルまたはディレクトリをコピー",
        "help_mv": "ファイルまたはディレクトリを移動",
        "help_cat": "ファイルの内容を表示",
        "help_uname": "システム情報を表示",
        "help_find": "ファイルを検索",
        "help_clear": "出力をクリア",
        "help_exit": "終了",
        "repl_start": "POSIX 互換シェルを起動しています。'exit' で終了します。",
        "gui_title": "POSIX 互換レイヤー GUI",
        "gui_ready": "準備完了",
        "gui_curr_dir": "現在のディレクトリ: {}",
        "gui_btn_ls": "一覧(ls)",
        "gui_btn_pwd": "パス(pwd)",
        "gui_btn_uname": "情報(uname)",
        "gui_btn_clear": "クリア",
        "gui_btn_help": "ヘルプ",
        "menu_lang": "言語",
    },
    "fr": {
        "lang_name": "Français",
        "err_no_file": "Aucun fichier ou dossier de ce type",
        "err_not_dir": "Pas un dossier",
        "err_perm": "Permission refusée",
        "err_is_dir": "Est un dossier",
        "err_cmd_not_found": "Commande introuvable",
        "err_missing_arg": "argument manquant",
        "err_missing_operand": "opérande manquant",
        "err_binary": "Fichier binaire (non affiché)",
        "msg_changed_dir": "Répertoire changé pour {}",
        "msg_created_dir": "Répertoire créé : {}",
        "msg_touched": "Mis à jour {}",
        "msg_removed_dir": "Répertoire supprimé {}",
        "msg_removed_file": "Fichier supprimé {}",
        "msg_copied_dir": "Répertoire copié de {} vers {}",
        "msg_copied_file": "Fichier copié de {} vers {}",
        "msg_moved": "Déplacé {} vers {}",
        "help_ls": "Lister le contenu du répertoire",
        "help_cd": "Changer de répertoire",
        "help_pwd": "Afficher le répertoire courant",
        "help_mkdir": "Créer un répertoire",
        "help_touch": "Créer un fichier ou mettre à jour l'horodatage",
        "help_rm": "Supprimer un fichier ou un répertoire",
        "help_cp": "Copier un fichier ou un répertoire",
        "help_mv": "Déplacer un fichier ou un répertoire",
        "help_cat": "Concaténer et afficher le contenu du fichier",
        "help_uname": "Afficher les informations système",
        "help_find": "Rechercher des fichiers",
        "help_clear": "Effacer la sortie",
        "help_exit": "Quitter",
        "repl_start": "Démarrage du Shell compatible POSIX. Tapez 'exit' pour quitter.",
        "gui_title": "Interface Graphique Couche de Compatibilité POSIX",
        "gui_ready": "Prêt",
        "gui_curr_dir": "Répertoire actuel : {}",
        "gui_btn_ls": "Liste(ls)",
        "gui_btn_pwd": "Chemin(pwd)",
        "gui_btn_uname": "Système(uname)",
        "gui_btn_clear": "Effacer",
        "gui_btn_help": "Aide",
        "menu_lang": "Langue",
    },
    "ru": {
        "lang_name": "Русский",
        "err_no_file": "Нет такого файла или каталога",
        "err_not_dir": "Не является каталогом",
        "err_perm": "Доступ запрещен",
        "err_is_dir": "Это каталог",
        "err_cmd_not_found": "Команда не найдена",
        "err_missing_arg": "отсутствует аргумент",
        "err_missing_operand": "отсутствует операнд",
        "err_binary": "Бинарный файл (не отображается)",
        "msg_changed_dir": "Каталог изменен на {}",
        "msg_created_dir": "Создан каталог: {}",
        "msg_touched": "Обновлен {}",
        "msg_removed_dir": "Удален каталог {}",
        "msg_removed_file": "Удален файл {}",
        "msg_copied_dir": "Каталог скопирован из {} в {}",
        "msg_copied_file": "Файл скопирован из {} в {}",
        "msg_moved": "Перемещен {} в {}",
        "help_ls": "Список содержимого каталога",
        "help_cd": "Сменить каталог",
        "help_pwd": "Показать рабочий каталог",
        "help_mkdir": "Создать каталог",
        "help_touch": "Создать файл или обновить метку времени",
        "help_rm": "Удалить файл или каталог",
        "help_cp": "Копировать файл или каталог",
        "help_mv": "Переместить файл или каталог",
        "help_cat": "Показать содержимое файла",
        "help_uname": "Показать информацию о системе",
        "help_find": "Поиск файлов",
        "help_clear": "Очистить вывод",
        "help_exit": "Выход",
        "repl_start": "Запуск POSIX-совместимой оболочки. Введите 'exit' для выхода.",
        "gui_title": "GUI слоя совместимости POSIX",
        "gui_ready": "Готов",
        "gui_curr_dir": "Текущий каталог: {}",
        "gui_btn_ls": "Список(ls)",
        "gui_btn_pwd": "Путь(pwd)",
        "gui_btn_uname": "Система(uname)",
        "gui_btn_clear": "Очистить",
        "gui_btn_help": "Помощь",
        "menu_lang": "Язык",
    },
    "de": {
        "lang_name": "Deutsch",
        "err_no_file": "Datei oder Verzeichnis nicht gefunden",
        "err_not_dir": "Kein Verzeichnis",
        "err_perm": "Zugriff verweigert",
        "err_is_dir": "Ist ein Verzeichnis",
        "err_cmd_not_found": "Befehl nicht gefunden",
        "err_missing_arg": "Argument fehlt",
        "err_missing_operand": "Operand fehlt",
        "err_binary": "Binärdatei (nicht angezeigt)",
        "msg_changed_dir": "Verzeichnis gewechselt zu {}",
        "msg_created_dir": "Verzeichnis erstellt: {}",
        "msg_touched": "Aktualisiert {}",
        "msg_removed_dir": "Verzeichnis entfernt {}",
        "msg_removed_file": "Datei entfernt {}",
        "msg_copied_dir": "Verzeichnis kopiert von {} nach {}",
        "msg_copied_file": "Datei kopiert von {} nach {}",
        "msg_moved": "Verschoben {} nach {}",
        "help_ls": "Verzeichnisinhalt auflisten",
        "help_cd": "Verzeichnis wechseln",
        "help_pwd": "Arbeitsverzeichnis drucken",
        "help_mkdir": "Verzeichnis erstellen",
        "help_touch": "Datei erstellen oder Zeitstempel aktualisieren",
        "help_rm": "Datei oder Verzeichnis entfernen",
        "help_cp": "Datei oder Verzeichnis kopieren",
        "help_mv": "Datei oder Verzeichnis verschieben",
        "help_cat": "Dateiinhalt anzeigen",
        "help_uname": "Systeminformationen anzeigen",
        "help_find": "Nach Dateien suchen",
        "help_clear": "Ausgabe löschen",
        "help_exit": "Beenden",
        "repl_start": "Starte POSIX-Kompatibilitäts-Shell. Tippen Sie 'exit' zum Beenden.",
        "gui_title": "POSIX Kompatibilitätsschicht GUI",
        "gui_ready": "Bereit",
        "gui_curr_dir": "Aktuelles Verzeichnis: {}",
        "gui_btn_ls": "Liste(ls)",
        "gui_btn_pwd": "Pfad(pwd)",
        "gui_btn_uname": "System(uname)",
        "gui_btn_clear": "Löschen",
        "gui_btn_help": "Hilfe",
        "menu_lang": "Sprache",
    },
    "it": {
        "lang_name": "Italiano",
        "err_no_file": "Nessun file o directory",
        "err_not_dir": "Non è una directory",
        "err_perm": "Permesso negato",
        "err_is_dir": "È una directory",
        "err_cmd_not_found": "Comando non trovato",
        "err_missing_arg": "argomento mancante",
        "err_missing_operand": "operando mancante",
        "err_binary": "File binario (non visualizzato)",
        "msg_changed_dir": "Directory cambiata in {}",
        "msg_created_dir": "Directory creata: {}",
        "msg_touched": "Aggiornato {}",
        "msg_removed_dir": "Directory rimossa {}",
        "msg_removed_file": "File rimosso {}",
        "msg_copied_dir": "Directory copiata da {} a {}",
        "msg_copied_file": "File copiato da {} a {}",
        "msg_moved": "Spostato {} a {}",
        "help_ls": "Elenca contenuto directory",
        "help_cd": "Cambia directory",
        "help_pwd": "Stampa directory di lavoro",
        "help_mkdir": "Crea directory",
        "help_touch": "Crea file o aggiorna timestamp",
        "help_rm": "Rimuovi file o directory",
        "help_cp": "Copia file o directory",
        "help_mv": "Sposta file o directory",
        "help_cat": "Visualizza contenuto file",
        "help_uname": "Stampa informazioni sistema",
        "help_find": "Cerca file",
        "help_clear": "Pulisci output",
        "help_exit": "Esci",
        "repl_start": "Avvio Shell Compatibilità POSIX. Digita 'exit' per uscire.",
        "gui_title": "GUI Livello Compatibilità POSIX",
        "gui_ready": "Pronto",
        "gui_curr_dir": "Directory Corrente: {}",
        "gui_btn_ls": "Lista(ls)",
        "gui_btn_pwd": "Percorso(pwd)",
        "gui_btn_uname": "Sistema(uname)",
        "gui_btn_clear": "Pulisci",
        "gui_btn_help": "Aiuto",
        "menu_lang": "Lingua",
    },
    "es": {
        "lang_name": "Español",
        "err_no_file": "No existe el archivo o directorio",
        "err_not_dir": "No es un directorio",
        "err_perm": "Permiso denegado",
        "err_is_dir": "Es un directorio",
        "err_cmd_not_found": "Comando no encontrado",
        "err_missing_arg": "falta argumento",
        "err_missing_operand": "falta operando",
        "err_binary": "Archivo binario (no mostrado)",
        "msg_changed_dir": "Directorio cambiado a {}",
        "msg_created_dir": "Directorio creado: {}",
        "msg_touched": "Actualizado {}",
        "msg_removed_dir": "Directorio eliminado {}",
        "msg_removed_file": "Archivo eliminado {}",
        "msg_copied_dir": "Directorio copiado de {} a {}",
        "msg_copied_file": "Archivo copiado de {} a {}",
        "msg_moved": "Movido {} a {}",
        "help_ls": "Listar contenido del directorio",
        "help_cd": "Cambiar directorio",
        "help_pwd": "Imprimir directorio de trabajo",
        "help_mkdir": "Crear directorio",
        "help_touch": "Crear archivo o actualizar marca de tiempo",
        "help_rm": "Eliminar archivo o directorio",
        "help_cp": "Copiar archivo o directorio",
        "help_mv": "Mover archivo o directorio",
        "help_cat": "Mostrar contenido del archivo",
        "help_uname": "Imprimir información del sistema",
        "help_find": "Buscar archivos",
        "help_clear": "Limpiar salida",
        "help_exit": "Salir",
        "repl_start": "Iniciando Shell de Compatibilidad POSIX. Escriba 'exit' para salir.",
        "gui_title": "GUI Capa de Compatibilidad POSIX",
        "gui_ready": "Listo",
        "gui_curr_dir": "Directorio Actual: {}",
        "gui_btn_ls": "Listar(ls)",
        "gui_btn_pwd": "Ruta(pwd)",
        "gui_btn_uname": "Sistema(uname)",
        "gui_btn_clear": "Limpiar",
        "gui_btn_help": "Ayuda",
        "menu_lang": "Idioma",
    },
    "pt": {
        "lang_name": "Português",
        "err_no_file": "Nenhum arquivo ou diretório",
        "err_not_dir": "Não é um diretório",
        "err_perm": "Permissão negada",
        "err_is_dir": "É um diretório",
        "err_cmd_not_found": "Comando não encontrado",
        "err_missing_arg": "argumento faltando",
        "err_missing_operand": "operando faltando",
        "err_binary": "Arquivo binário (não exibido)",
        "msg_changed_dir": "Diretório alterado para {}",
        "msg_created_dir": "Diretório criado: {}",
        "msg_touched": "Atualizado {}",
        "msg_removed_dir": "Diretório removido {}",
        "msg_removed_file": "Arquivo removido {}",
        "msg_copied_dir": "Diretório copiado de {} para {}",
        "msg_copied_file": "Arquivo copiado de {} para {}",
        "msg_moved": "Movido {} para {}",
        "help_ls": "Listar conteúdo do diretório",
        "help_cd": "Mudar diretório",
        "help_pwd": "Imprimir diretório de trabalho",
        "help_mkdir": "Criar diretório",
        "help_touch": "Criar arquivo ou atualizar timestamp",
        "help_rm": "Remover arquivo ou diretório",
        "help_cp": "Copiar arquivo ou diretório",
        "help_mv": "Mover arquivo ou diretório",
        "help_cat": "Mostrar conteúdo do arquivo",
        "help_uname": "Imprimir informações do sistema",
        "help_find": "Procurar arquivos",
        "help_clear": "Limpar saída",
        "help_exit": "Sair",
        "repl_start": "Iniciando Shell de Compatibilidade POSIX. Digite 'exit' para sair.",
        "gui_title": "GUI Camada de Compatibilidade POSIX",
        "gui_ready": "Pronto",
        "gui_curr_dir": "Diretório Atual: {}",
        "gui_btn_ls": "Listar(ls)",
        "gui_btn_pwd": "Rota(pwd)",
        "gui_btn_uname": "Sistema(uname)",
        "gui_btn_clear": "Limpar",
        "gui_btn_help": "Ajuda",
        "menu_lang": "Idioma",
    },
    "ko": {
        "lang_name": "한국어",
        "err_no_file": "그런 파일이나 디렉터리가 없습니다",
        "err_not_dir": "디렉터리가 아닙니다",
        "err_perm": "허가 거부됨",
        "err_is_dir": "디렉터리입니다",
        "err_cmd_not_found": "명령을 찾을 수 없습니다",
        "err_missing_arg": "인수가 누락되었습니다",
        "err_missing_operand": "피연산자가 누락되었습니다",
        "err_binary": "바이너리 파일 (표시되지 않음)",
        "msg_changed_dir": "디렉터리가 {}로 변경되었습니다",
        "msg_created_dir": "디렉터리 생성됨: {}",
        "msg_touched": "{} 업데이트됨",
        "msg_removed_dir": "디렉터리 {} 삭제됨",
        "msg_removed_file": "파일 {} 삭제됨",
        "msg_copied_dir": "디렉터리 {}를 {}로 복사함",
        "msg_copied_file": "파일 {}를 {}로 복사함",
        "msg_moved": "{}를 {}로 이동함",
        "help_ls": "디렉터리 내용 나열",
        "help_cd": "디렉터리 변경",
        "help_pwd": "작업 디렉터리 출력",
        "help_mkdir": "디렉터리 생성",
        "help_touch": "파일 생성 또는 타임스탬프 업데이트",
        "help_rm": "파일 또는 디렉터리 삭제",
        "help_cp": "파일 또는 디렉터리 복사",
        "help_mv": "파일 또는 디렉터리 이동",
        "help_cat": "파일 내용 표시",
        "help_uname": "시스템 정보 출력",
        "help_find": "파일 검색",
        "help_clear": "출력 지우기",
        "help_exit": "종료",
        "repl_start": "POSIX 호환 셸을 시작합니다. 종료하려면 'exit'를 입력하세요.",
        "gui_title": "POSIX 호환 레이어 GUI",
        "gui_ready": "준비",
        "gui_curr_dir": "현재 디렉터리: {}",
        "gui_btn_ls": "목록(ls)",
        "gui_btn_pwd": "경로(pwd)",
        "gui_btn_uname": "시스템(uname)",
        "gui_btn_clear": "지우기",
        "gui_btn_help": "도움말",
        "menu_lang": "언어",
    },
}

def get_system_language():
    """Detect system language and return our internal language code."""
    try:
        # Use getlocale instead of getdefaultlocale which is deprecated
        # but getdefaultlocale is often more robust on Windows for OS setting
        # Let's try to handle different scenarios
        loc = locale.getdefaultlocale()
        if not loc or not loc[0]:
            return 'en'
        
        lang_code = loc[0].split('_')[0].lower()
        
        if lang_code in TRANSLATIONS:
            return lang_code
        return 'en'
    except:
        return 'en'

# Global current language
CURRENT_LANG = get_system_language()

def set_language(lang_code):
    """Manually set language."""
    global CURRENT_LANG
    if lang_code in TRANSLATIONS:
        CURRENT_LANG = lang_code

def get_available_languages():
    """Return list of (code, name) tuples."""
    return [(code, data.get("lang_name", code)) for code, data in TRANSLATIONS.items()]

def _(key, *args):
    """Translate key to current language."""
    lang_dict = TRANSLATIONS.get(CURRENT_LANG, TRANSLATIONS['en'])
    msg = lang_dict.get(key, TRANSLATIONS['en'].get(key, key))
    if args:
        try:
            return msg.format(*args)
        except:
            return msg
    return msg
