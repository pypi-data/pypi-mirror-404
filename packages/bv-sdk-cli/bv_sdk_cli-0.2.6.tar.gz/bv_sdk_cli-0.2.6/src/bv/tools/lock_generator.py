from __future__ import annotations

import shutil
import subprocess
import sys
from pathlib import Path
from typing import List, Dict


class RequirementsLockGenerator:
    """Generate requirements.lock with pinned versions in an isolated temp venv."""

    def generate(self, project_path: str, dependencies: List[str]) -> Dict:
        project_root = Path(project_path)
        lock_file = project_root / "requirements.lock"
        temp_venv = project_root / ".bv_tmp_venv"

        self._create_temp_venv(temp_venv)
        try:
            installed = self._install_and_resolve(temp_venv, dependencies)
            self._write_lock_file(lock_file, installed)
            return {
                "status": "success",
                "lock_file": str(lock_file),
                "dependencies_resolved": installed,
            }
        finally:
            shutil.rmtree(temp_venv, ignore_errors=True)

    def _create_temp_venv(self, venv_path: Path) -> None:
        subprocess.run(
            [sys.executable, "-m", "venv", str(venv_path)],
            check=True,
            capture_output=True,
        )

    def _install_and_resolve(self, venv_path: Path, dependencies: List[str]) -> List[str]:
        pip_path = venv_path / ("Scripts" if sys.platform == "win32" else "bin") / "pip"
        if dependencies:
            subprocess.run([str(pip_path), "install"] + dependencies, check=True, capture_output=True)

        result = subprocess.run([str(pip_path), "freeze"], capture_output=True, text=True, check=True)
        return [line.strip() for line in result.stdout.splitlines() if line.strip()]

    def _write_lock_file(self, lock_file: Path, dependencies: List[str]) -> None:
        lock_file.write_text(
            "# This file is automatically generated by 'bv build'\n"
            "# Do not edit manually\n\n"
            + "\n".join(dependencies)
            + "\n",
            encoding="utf-8",
        )

