"""
High-level API interface for NFL Data Python extraction.

Provides clean, consistent access to all nfl_data_py functions with
error handling, logging, and data validation.
"""

import pandas as pd
from typing import List, Optional, Union

from commonv2 import get_logger
from .api_core import (
    validate_years,
    validate_stat_type,
    handle_data_cleaning,
    add_metadata_columns,
    # NFL Data Python wrapper functions
    _import_pbp_data,
    _import_weekly_data,
    _import_seasonal_data,
    _import_seasonal_rosters,
    _import_weekly_rosters,
    _import_team_desc,
    _import_win_totals,
    _import_sc_lines,
    _import_schedules,
    _import_officials,
    _import_draft_picks,
    _import_draft_values,
    _import_combine_data,
    _import_ids,
    _import_ngs_data,
    _import_depth_charts,
    _import_injuries,
    _import_qbr,
    _import_snap_counts,
    _import_seasonal_pfr,
    _import_weekly_pfr,
    _import_ftn_data,
    _see_pbp_cols,
    _see_weekly_cols,
    _cache_pbp
)

logger = get_logger('nfl_data_py.api')

__all__ = [
    # Play-by-Play & Weekly Data
    'import_pbp_data',
    'import_weekly_data', 
    'import_seasonal_data',
    
    # Roster & Team Data
    'import_seasonal_rosters',
    'import_weekly_rosters',
    'import_team_desc',
    
    # Betting & Lines
    'import_win_totals',
    'import_sc_lines',
    
    # Schedule & Games
    'import_schedules',
    'import_officials',
    
    # Draft Data
    'import_draft_picks',
    'import_draft_values',
    'import_combine_data',
    
    # Advanced Stats
    'import_ids',
    'import_ngs_data',
    'import_depth_charts',
    'import_injuries',
    'import_qbr',
    'import_snap_counts',
    
    # Pro Football Reference
    'import_seasonal_pfr',
    'import_weekly_pfr',
    
    # Third Party
    'import_ftn_data',
    
    # Utilities
    'see_pbp_cols',
    'see_weekly_cols',
    'cache_pbp',
    'clean_nfl_data'
]

# ============================================================================
# Play-by-Play & Weekly Data
# ============================================================================

def import_pbp_data(years: Union[int, List[int]], columns: Optional[List[str]] = None, 
                   downcast: bool = True, cache: bool = False, alt_path: Optional[str] = None) -> pd.DataFrame:
    """
    Import play-by-play data for specified years.
    
    Args:
        years: Year or list of years to pull data for (earliest available is 1999)
        columns: Optional list of columns to pull data for
        downcast: Convert float64 columns to float32, reducing memory usage by ~30%
        cache: Pull pbp data from local cache generated by cache_pbp()
        alt_path: Alternate path to cache if cache_pbp() was called with custom path
        
    Returns:
        pd.DataFrame: Play-by-play data
    """
    validated_years = validate_years(years)
    if not validated_years:
        return pd.DataFrame()
    
    result = _import_pbp_data(
        validated_years,
        columns=columns,
        downcast=downcast,
        cache=cache,
        alt_path=alt_path
    )
    
    return add_metadata_columns(result, 'import_pbp_data')

def import_weekly_data(years: Union[int, List[int]], columns: Optional[List[str]] = None, 
                      downcast: bool = True) -> pd.DataFrame:
    """
    Import weekly data for specified years.
    
    Args:
        years: Year or list of years to pull data for (earliest available is 1999)
        columns: Optional list of columns to pull data for
        downcast: Convert float64 columns to float32, reducing memory usage by ~30%
        
    Returns:
        pd.DataFrame: Weekly data
    """
    validated_years = validate_years(years)
    if not validated_years:
        return pd.DataFrame()
    
    result = _import_weekly_data(
        validated_years,
        columns=columns,
        downcast=downcast
    )
    
    return add_metadata_columns(result, 'import_weekly_data')

def import_seasonal_data(years: Union[int, List[int]], s_type: str = 'REG') -> pd.DataFrame:
    """
    Import seasonal data including calculated market share stats.
    
    Args:
        years: Year or list of years to pull data for (earliest available is 1999)
        s_type: Season type to include ('ALL', 'REG', 'POST')
        
    Returns:
        pd.DataFrame: Seasonal data with market share stats
    """
    validated_years = validate_years(years)
    if not validated_years:
        return pd.DataFrame()
    
    s_type = validate_stat_type(s_type, ['ALL', 'REG', 'POST'])
    
    result = _import_seasonal_data(
        validated_years,
        s_type=s_type
    )
    
    return add_metadata_columns(result, 'import_seasonal_data')

# ============================================================================
# Roster & Team Data
# ============================================================================

def import_seasonal_rosters(years: Union[int, List[int]], columns: Optional[List[str]] = None) -> pd.DataFrame:
    """
    Import yearly roster information.
    
    Args:
        years: Year or list of years to pull data for (earliest available is 1999)
        columns: Optional list of columns to pull data for
        
    Returns:
        pd.DataFrame: Seasonal roster data
    """
    validated_years = validate_years(years)
    if not validated_years:
        return pd.DataFrame()
    
    result = _import_seasonal_rosters(
        validated_years,
        columns=columns
    )
    
    return add_metadata_columns(result, 'import_seasonal_rosters')

def import_weekly_rosters(years: Union[int, List[int]], columns: Optional[List[str]] = None) -> pd.DataFrame:
    """
    Import per-game roster information.
    
    Args:
        years: Year or list of years to pull data for (earliest available is 1999)
        columns: Optional list of columns to pull data for
        
    Returns:
        pd.DataFrame: Weekly roster data
    """
    validated_years = validate_years(years)
    if not validated_years:
        return pd.DataFrame()
    
    result = _import_weekly_rosters(
        validated_years,
        columns=columns
    )
    
    return add_metadata_columns(result, 'import_weekly_rosters')

def import_team_desc() -> pd.DataFrame:
    """
    Import team descriptive information (colors, logos, etc.).
    
    Returns:
        pd.DataFrame: Team descriptive data
    """
    result = _import_team_desc()
    return add_metadata_columns(result, 'import_team_desc')

# ============================================================================
# Betting & Lines
# ============================================================================

def import_win_totals(years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import win total lines.
    
    Args:
        years: Optional year or list of years to pull
        
    Returns:
        pd.DataFrame: Win total lines
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_win_totals(validated_years)
    else:
        result = _import_win_totals()
    
    return add_metadata_columns(result, 'import_win_totals')

def import_sc_lines(years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import scoring lines.
    
    Args:
        years: Optional year or list of years to pull
        
    Returns:
        pd.DataFrame: Scoring lines
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_sc_lines(validated_years)
    else:
        result = _import_sc_lines()
    
    return add_metadata_columns(result, 'import_sc_lines')

# ============================================================================
# Schedule & Games
# ============================================================================

def import_schedules(years: Union[int, List[int]]) -> pd.DataFrame:
    """
    Import schedule information for specified years.
    
    Args:
        years: Year or list of years to pull data for (earliest available is 1999)
        
    Returns:
        pd.DataFrame: Schedule data
    """
    validated_years = validate_years(years)
    if not validated_years:
        return pd.DataFrame()
    
    result = _import_schedules(validated_years)
    return add_metadata_columns(result, 'import_schedules')

def import_officials(years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import official information by game.
    
    Args:
        years: Optional year or list of years to pull
        
    Returns:
        pd.DataFrame: Officials data
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_officials(validated_years)
    else:
        result = _import_officials()
    
    return add_metadata_columns(result, 'import_officials')

# ============================================================================
# Draft Data
# ============================================================================

def import_draft_picks(years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import draft picks for specified years.
    
    Args:
        years: Optional year or list of years to pull
        
    Returns:
        pd.DataFrame: Draft picks data
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_draft_picks(validated_years)
    else:
        result = _import_draft_picks()
    
    return add_metadata_columns(result, 'import_draft_picks')

def import_draft_values() -> pd.DataFrame:
    """
    Import relative values by generic draft pick according to various valuation methods.
    
    Returns:
        pd.DataFrame: Draft pick values
    """
    result = _import_draft_values()
    return add_metadata_columns(result, 'import_draft_values')

def import_combine_data(years: Optional[Union[int, List[int]]] = None, 
                       positions: Optional[List[str]] = None) -> pd.DataFrame:
    """
    Import NFL Combine results.
    
    Args:
        years: Optional year or list of years to pull data from
        positions: Optional list of positions to pull (WR/QB/RB/etc.)
        
    Returns:
        pd.DataFrame: Combine data
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_combine_data(validated_years, positions=positions)
    else:
        result = _import_combine_data(positions=positions)
    
    return add_metadata_columns(result, 'import_combine_data')

# ============================================================================
# Advanced Stats
# ============================================================================

def import_ids(columns: Optional[List[str]] = None, ids: Optional[List[str]] = None) -> pd.DataFrame:
    """
    Import mapped IDs for all players across major NFL and fantasy platforms.
    
    Args:
        columns: Optional list of columns to return
        ids: Optional list of IDs to return
        
    Returns:
        pd.DataFrame: Player ID mappings
    """
    result = _import_ids(columns=columns, ids=ids)
    return add_metadata_columns(result, 'import_ids')

def import_ngs_data(stat_type: str, years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import Next Gen Stats data.
    
    Args:
        stat_type: Type of stats to pull ('passing', 'rushing', 'receiving')
        years: Optional year or list of years to return data for
        
    Returns:
        pd.DataFrame: NGS data
    """
    stat_type = validate_stat_type(stat_type, ['passing', 'rushing', 'receiving'])
    
    if years is not None:
        validated_years = validate_years(years)
        result = _import_ngs_data(stat_type, validated_years)
    else:
        result = _import_ngs_data(stat_type)
    
    return add_metadata_columns(result, 'import_ngs_data')

def import_depth_charts(years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import depth chart data.
    
    Args:
        years: Optional year or list of years to return data for
        
    Returns:
        pd.DataFrame: Depth chart data
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_depth_charts(validated_years)
    else:
        result = _import_depth_charts()
    
    return add_metadata_columns(result, 'import_depth_charts')

def import_injuries(years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import injury reports.
    
    Args:
        years: Optional year or list of years to return data for
        
    Returns:
        pd.DataFrame: Injury data
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_injuries(validated_years)
    else:
        result = _import_injuries()
    
    return add_metadata_columns(result, 'import_injuries')

def import_qbr(years: Optional[Union[int, List[int]]] = None, level: str = 'nfl', 
               frequency: str = 'season') -> pd.DataFrame:
    """
    Import QBR data.
    
    Args:
        years: Optional years to return data for
        level: Competition level ('nfl' or 'college')
        frequency: Frequency ('weekly' or 'season')
        
    Returns:
        pd.DataFrame: QBR data
    """
    level = validate_stat_type(level, ['nfl', 'college'])
    frequency = validate_stat_type(frequency, ['weekly', 'season'])
    
    if years is not None:
        validated_years = validate_years(years)
        result = _import_qbr(validated_years, level=level, frequency=frequency)
    else:
        result = _import_qbr(level=level, frequency=frequency)
    
    return add_metadata_columns(result, 'import_qbr')

def import_snap_counts(years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import snap count records.
    
    Args:
        years: Optional year or list of years to return data for
        
    Returns:
        pd.DataFrame: Snap count data
    """
    if years is not None:
        validated_years = validate_years(years)
        result = _import_snap_counts(validated_years)
    else:
        result = _import_snap_counts()
    
    return add_metadata_columns(result, 'import_snap_counts')

# ============================================================================
# Pro Football Reference
# ============================================================================

def import_seasonal_pfr(s_type: str, years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import season-aggregated data from Pro Football Reference.
    
    Args:
        s_type: Type of stat data ('pass', 'rec', or 'rush')
        years: Optional years to return data for
        
    Returns:
        pd.DataFrame: PFR seasonal data
    """
    s_type = validate_stat_type(s_type, ['pass', 'rec', 'rush'])
    
    if years is not None:
        validated_years = validate_years(years)
        result = _import_seasonal_pfr(s_type, validated_years)
    else:
        result = _import_seasonal_pfr(s_type)
    
    return add_metadata_columns(result, 'import_seasonal_pfr')

def import_weekly_pfr(s_type: str, years: Optional[Union[int, List[int]]] = None) -> pd.DataFrame:
    """
    Import per-game data from Pro Football Reference.
    
    Args:
        s_type: Type of stat data ('pass', 'rec', or 'rush')
        years: Optional years to return data for
        
    Returns:
        pd.DataFrame: PFR weekly data
    """
    s_type = validate_stat_type(s_type, ['pass', 'rec', 'rush'])
    
    if years is not None:
        validated_years = validate_years(years)
        result = _import_weekly_pfr(s_type, validated_years)
    else:
        result = _import_weekly_pfr(s_type)
    
    return add_metadata_columns(result, 'import_weekly_pfr')

# ============================================================================
# Third Party
# ============================================================================

def import_ftn_data(years: Union[int, List[int]], columns: Optional[List[str]] = None, 
                   downcast: bool = True, thread_requests: bool = False) -> pd.DataFrame:
    """
    Import FTN charting data.
    
    Args:
        years: Years to get data for (2022 season onwards)
        columns: Optional list of columns to return
        downcast: Convert float64 to float32
        thread_requests: Use thread pool to read files
        
    Returns:
        pd.DataFrame: FTN charting data
    """
    validated_years = validate_years(years)
    if not validated_years:
        return pd.DataFrame()
    
    result = _import_ftn_data(
        validated_years,
        columns=columns,
        downcast=downcast,
        thread_requests=thread_requests
    )
    
    return add_metadata_columns(result, 'import_ftn_data')

# ============================================================================
# Utilities
# ============================================================================

def see_pbp_cols() -> List[str]:
    """
    Get list of columns available in play-by-play dataset.
    
    Returns:
        List[str]: Available PBP columns
    """
    return _see_pbp_cols()

def see_weekly_cols() -> List[str]:
    """
    Get list of columns available in weekly dataset.
    
    Returns:
        List[str]: Available weekly columns
    """
    return _see_weekly_cols()

def cache_pbp(years: Union[int, List[int]], downcast: bool = True, alt_path: Optional[str] = None) -> None:
    """
    Cache play-by-play data locally to speed up download time.
    
    Args:
        years: Year or list of years to cache
        downcast: Convert float64 columns to float32
        alt_path: Alternate path to store cache
    """
    validated_years = validate_years(years)
    if not validated_years:
        return
    
    _cache_pbp(validated_years, downcast=downcast, alt_path=alt_path)

def clean_nfl_data(df: pd.DataFrame) -> pd.DataFrame:
    """
    Run descriptive data through various cleaning processes.
    
    Args:
        df: DataFrame to be cleaned
        
    Returns:
        pd.DataFrame: Cleaned DataFrame
    """
    return handle_data_cleaning(df, clean_data=True)
