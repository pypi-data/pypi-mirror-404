-- cmd_proto.lua
-- Generated by Oscura on 2026-01-27T16:58:11.359218+00:00
--
-- Protocol: Command and response protocol with conditional fields
-- Version: 1.0
-- Endianness: big


-- Protocol declaration
local cmd_proto_proto = Proto("cmd_proto", "Command and response protocol with conditional fields")

-- Field declarations

local f_header = ProtoField.uint8(
    "cmd_proto.header",
    "Frame header",
    base.HEX
)

local f_cmd_code = ProtoField.uint8(
    "cmd_proto.cmd_code",
    "Command code",
    base.HEX, {[1] = "READ_STATUS", [2] = "WRITE_CONFIG", [3] = "RESET", [4] = "GET_VERSION", [5] = "SET_MODE"}
)

local f_param_count = ProtoField.uint8(
    "cmd_proto.param_count",
    "Number of parameters",
    base.HEX
)

local f_params = ProtoField.bytes(
    "cmd_proto.params",
    "Command parameters",
    base.NONE
)

local f_checksum = ProtoField.uint8(
    "cmd_proto.checksum",
    "Frame checksum",
    base.HEX
)


-- Register fields
cmd_proto_proto.fields = { f_header, f_cmd_code, f_param_count, f_params, f_checksum }

-- Dissector function
function cmd_proto_proto.dissector(buffer, pinfo, tree)
    local pktlen = buffer:len()

    -- Check minimum length
    if pktlen < 4 then
        return 0  -- Not enough data
    end

    -- Set protocol column
    pinfo.cols.protocol = cmd_proto_proto.name

    -- Create protocol subtree
    local subtree = tree:add(cmd_proto_proto, buffer(), "Command and response protocol with conditional fields")
    local offset = 0

    -- Decode fields



    -- Fixed-length field: header (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated header")
        return pktlen
    end
    subtree:add(f_header, buffer(offset, 1))
    offset = offset + 1





    -- Fixed-length field: cmd_code (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated cmd_code")
        return pktlen
    end
    subtree:add(f_cmd_code, buffer(offset, 1))
    offset = offset + 1





    -- Fixed-length field: param_count (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated param_count")
        return pktlen
    end
    subtree:add(f_param_count, buffer(offset, 1))
    offset = offset + 1





    -- Variable-length field: params

    local params_len = buffer(2, 1):uint()
    if offset + params_len > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated params")
        return pktlen
    end
    subtree:add(f_params, buffer(offset, params_len))
    offset = offset + params_len






    -- Fixed-length field: checksum (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated checksum")
        return pktlen
    end
    subtree:add(f_checksum, buffer(offset, 1))
    offset = offset + 1



    return offset
end

-- Protocol registration

-- Register on UDP port 8000
local udp_table = DissectorTable.get("udp.port")
udp_table:add(8000, cmd_proto_proto)
