-- cmd_proto.lua
-- Generated by Oscura on 2026-01-27T22:14:12.144569+00:00
--
-- Protocol: Command and response protocol
-- Version: 1.0
-- Endianness: big


-- Protocol declaration
local cmd_proto_proto = Proto("cmd_proto", "Command and response protocol")

-- Field declarations

local f_sync = ProtoField.bytes(
    "cmd_proto.sync",
    "Sync pattern",
    base.NONE
)

local f_cmd_code = ProtoField.uint8(
    "cmd_proto.cmd_code",
    "Command code",
    base.HEX, {[1] = "READ_STATUS", [2] = "WRITE_CONFIG", [3] = "RESET", [4] = "GET_VERSION"}
)

local f_sequence = ProtoField.uint16(
    "cmd_proto.sequence",
    "Sequence number",
    base.HEX
)

local f_param_count = ProtoField.uint8(
    "cmd_proto.param_count",
    "Number of parameters",
    base.HEX
)

local f_params = ProtoField.bytes(
    "cmd_proto.params",
    "Parameters",
    base.NONE
)

local f_crc16 = ProtoField.uint16(
    "cmd_proto.crc16",
    "CRC-16 checksum",
    base.HEX
)


-- Register fields
cmd_proto_proto.fields = { f_sync, f_cmd_code, f_sequence, f_param_count, f_params, f_crc16 }

-- Dissector function
function cmd_proto_proto.dissector(buffer, pinfo, tree)
    local pktlen = buffer:len()

    -- Check minimum length
    if pktlen < 8 then
        return 0  -- Not enough data
    end

    -- Set protocol column
    pinfo.cols.protocol = cmd_proto_proto.name

    -- Create protocol subtree
    local subtree = tree:add(cmd_proto_proto, buffer(), "Command and response protocol")
    local offset = 0

    -- Decode fields



    -- Fixed-length field: sync (2 bytes)
    if offset + 2 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated sync")
        return pktlen
    end
    subtree:add(f_sync, buffer(offset, 2))
    offset = offset + 2





    -- Fixed-length field: cmd_code (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated cmd_code")
        return pktlen
    end
    subtree:add(f_cmd_code, buffer(offset, 1))
    offset = offset + 1





    -- Fixed-length field: sequence (2 bytes)
    if offset + 2 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated sequence")
        return pktlen
    end
    subtree:add(f_sequence, buffer(offset, 2))
    offset = offset + 2





    -- Fixed-length field: param_count (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated param_count")
        return pktlen
    end
    subtree:add(f_param_count, buffer(offset, 1))
    offset = offset + 1





    -- Variable-length field: params

    local params_len = buffer(5, 1):uint()
    if offset + params_len > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated params")
        return pktlen
    end
    subtree:add(f_params, buffer(offset, params_len))
    offset = offset + params_len






    -- Fixed-length field: crc16 (2 bytes)
    if offset + 2 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated crc16")
        return pktlen
    end
    subtree:add(f_crc16, buffer(offset, 2))
    offset = offset + 2



    return offset
end

-- Protocol registration

-- Register on TCP port 8000
local tcp_table = DissectorTable.get("tcp.port")
tcp_table:add(8000, cmd_proto_proto)
