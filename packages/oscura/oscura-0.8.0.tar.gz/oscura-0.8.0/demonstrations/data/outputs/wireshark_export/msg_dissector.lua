-- msg_proto.lua
-- Generated by Oscura on 2026-01-27T22:14:12.144974+00:00
--
-- Protocol: Variable-length message protocol
-- Version: 1.0
-- Endianness: little


-- Protocol declaration
local msg_proto_proto = Proto("msg_proto", "Variable-length message protocol")

-- Field declarations

local f_header = ProtoField.uint8(
    "msg_proto.header",
    "Frame header",
    base.HEX
)

local f_msg_type = ProtoField.uint8(
    "msg_proto.msg_type",
    "Message type",
    base.HEX, {[0] = "Heartbeat", [1] = "Request", [2] = "Response", [255] = "Error"}
)

local f_payload_length = ProtoField.uint16(
    "msg_proto.payload_length",
    "Payload length",
    base.HEX
)

local f_payload = ProtoField.bytes(
    "msg_proto.payload",
    "Message payload",
    base.NONE
)

local f_crc8 = ProtoField.uint8(
    "msg_proto.crc8",
    "CRC-8 checksum",
    base.HEX
)


-- Register fields
msg_proto_proto.fields = { f_header, f_msg_type, f_payload_length, f_payload, f_crc8 }

-- Dissector function
function msg_proto_proto.dissector(buffer, pinfo, tree)
    local pktlen = buffer:len()

    -- Check minimum length
    if pktlen < 5 then
        return 0  -- Not enough data
    end

    -- Set protocol column
    pinfo.cols.protocol = msg_proto_proto.name

    -- Create protocol subtree
    local subtree = tree:add(msg_proto_proto, buffer(), "Variable-length message protocol")
    local offset = 0

    -- Decode fields



    -- Fixed-length field: header (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated header")
        return pktlen
    end
    subtree:add(f_header, buffer(offset, 1))
    offset = offset + 1





    -- Fixed-length field: msg_type (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated msg_type")
        return pktlen
    end
    subtree:add(f_msg_type, buffer(offset, 1))
    offset = offset + 1





    -- Fixed-length field: payload_length (2 bytes)
    if offset + 2 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated payload_length")
        return pktlen
    end
    subtree:add(f_payload_length, buffer(offset, 2))
    offset = offset + 2





    -- Variable-length field: payload

    local payload_len = buffer(2, 2):uint16()
    if offset + payload_len > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated payload")
        return pktlen
    end
    subtree:add(f_payload, buffer(offset, payload_len))
    offset = offset + payload_len






    -- Fixed-length field: crc8 (1 bytes)
    if offset + 1 > pktlen then
        subtree:add_expert_info(PI_MALFORMED, PI_ERROR, "Truncated crc8")
        return pktlen
    end
    subtree:add(f_crc8, buffer(offset, 1))
    offset = offset + 1



    return offset
end

-- Protocol registration

-- Register on UDP port 9999
local udp_table = DissectorTable.get("udp.port")
udp_table:add(9999, msg_proto_proto)
