#:schema https://json.schemastore.org/any.json

# =============================================================================
# pyproject.toml - Oscura Project Configuration
# =============================================================================

[project]
name = "oscura"
version = "0.8.0"
description = "Unified hardware reverse engineering framework. Extract all information from any system through signals and data. Unknown protocol discovery, state machine extraction, CRC recovery, security analysis. 16+ protocols, IEEE-compliant measurements."
readme = "README.md"
requires-python = ">=3.12"
license = "MIT"
keywords = [
    "hardware-reverse-engineering",
    "reverse-engineering",
    "security-research",
    "protocol-analysis",
    "protocol-inference",
    "state-machine-learning",
    "crc-recovery",
    "vulnerability-analysis",
    "right-to-repair",
    "hardware-security",
    "signal-analysis",
    "protocol-decoder",
    "unknown-protocol",
    "device-replication",
    "exploitation",
    "oscilloscope",
    "logic-analyzer",
    "waveform-analysis",
    "uart",
    "spi",
    "i2c",
    "can-bus",
    "automotive-protocols",
    "obd-ii",
    "embedded-systems",
    "ieee-compliance",
    "spectral-analysis",
]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Intended Audience :: Developers",
    "Intended Audience :: Information Technology",
    "Intended Audience :: Science/Research",
    "Intended Audience :: Telecommunications Industry",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Security",
    "Topic :: Scientific/Engineering",
    "Topic :: Scientific/Engineering :: Information Analysis",
    "Topic :: System :: Hardware",
    "Topic :: System :: Hardware :: Hardware Drivers",
    "Typing :: Typed",
]

# =============================================================================
# CORE DEPENDENCIES - Minimal required for basic functionality
# =============================================================================
# Only includes absolutely essential dependencies for:
# - Protocol decoding and analysis
# - Signal processing (FFT, filtering, statistics)
# - File format parsing
# - CLI interface
#
# Heavy optional features (visualization, ML, hardware) are in extras
# =============================================================================
dependencies = [
    # Scientific computing - ESSENTIAL for signal processing
    "numpy>=1.24.0,<3.0.0",      # Array operations, fundamental to all signal work
    "scipy>=1.10.0,<2.0.0",       # Signal processing (FFT, filters, stats) - 93 imports throughout codebase

    # CLI and configuration
    "click>=8.1.0,<9.0.0",        # Command-line interface framework
    "pyyaml>=6.0,<7.0.0",         # YAML configuration parsing
    "tqdm>=4.65.0,<5.0.0",        # Progress bars for workflows

    # File format support
    "tm-data-types>=0.3.0,<1.0.0",  # Tektronix WFM file support
    "dpkt>=1.9.0,<2.0.0",            # PCAP/PCAPNG protocol parsing
]

[project.optional-dependencies]
# =============================================================================
# VISUALIZATION - Plotting and waveform display
# =============================================================================
visualization = [
    "matplotlib>=3.7.0,<4.0.0",   # Plotting and visualization (107 imports)
]

# =============================================================================
# DATAFRAMES - Data manipulation and export
# =============================================================================
dataframes = [
    "pandas>=2.0.0,<3.0.0",       # Data structures, only 7 imports (not core)
    "openpyxl>=3.0.0,<4.0.0",     # Excel file reading/writing
]

# =============================================================================
# REPORTING - Report generation and templates
# =============================================================================
reporting = [
    "jinja2>=3.1,<4.0.0",         # Template engine for reports
    "matplotlib>=3.7.0,<4.0.0",   # Plot generation in reports
    "reportlab>=4.4.7,<6.0.0",    # PDF report generation
    "python-pptx>=0.6.21,<1.0.0", # PowerPoint presentation export
]

# =============================================================================
# SYSTEM - System utilities and monitoring
# =============================================================================
system = [
    "psutil>=5.9.0,<7.0.0",       # System and process utilities
]

# =============================================================================
# STANDARD - Recommended installation for most users
# =============================================================================
# Includes: core + visualization + dataframes + reporting + system
# This is what most users should install
standard = [
    "oscura[visualization,dataframes,reporting,system]",
]

# =============================================================================
# ANALYSIS - Advanced analysis and machine learning
# =============================================================================
analysis = [
    "networkx>=3.0,<4.0.0",        # Graph analysis for state machines
    "pywavelets>=1.0.0,<2.0.0",    # Wavelet analysis
    "scikit-learn>=1.3.0,<2.0.0",  # Machine learning and clustering
]

# =============================================================================
# HDF5 - HDF5 file format support
# =============================================================================
hdf5 = [
    "h5py>=3.0.0,<4.0.0",          # HDF5 file reading/writing
]

# =============================================================================
# JUPYTER - Jupyter notebook integration
# =============================================================================
# SEC-005: nbconvert CVE-2025-53000 affects <=7.16.6 (Windows-only code execution
# via uncontrolled search path during PDF conversion with SVG to PDF). Latest
# version (7.16.6) is vulnerable; waiting for 7.17.0 release. Mitigation: Avoid
# PDF export with SVG content on Windows, or use Linux/macOS (not affected).
# TRACKED: https://github.com/jupyter/nbconvert/security/advisories
jupyter = [
    "ipython>=8.0.0,<9.0.0",             # Enhanced Python shell
    "jupyter>=1.0.0,<2.0.0",             # Jupyter notebook support
    "nbconvert>=7.0.0,!=7.16.6,<8.0.0",  # CVE-2025-53000: Exclude vulnerable 7.16.6
]

# =============================================================================
# AUTOMOTIVE - Automotive protocol analysis (CAN, J1939, OBD-II, UDS)
# =============================================================================
automotive = [
    "cantools>=39.4.0,<40.0.0",          # DBC parsing and CAN message encoding/decoding
    "asammdf>=8.0.0,<9.0.0",             # MDF4/MF4 automotive data logging files
    "python-can>=4.4.0,<5.0.0",          # CAN interface and file formats (BLF, ASC)
    "scapy>=2.5.0,<3.0.0",               # PCAP parsing for SocketCAN frames
]

# =============================================================================
# OSCILLOSCOPES - Additional oscilloscope and data format support
# =============================================================================
oscilloscopes = [
    "rigolwfm>=1.0.0,<2.0.0",            # Rigol oscilloscope WFM file format
    "npTDMS>=1.7.0,<2.0.0",              # National Instruments TDMS file format
]

# =============================================================================
# HARDWARE - Hardware acquisition sources
# =============================================================================
hardware = [
    "pyvisa>=1.13.0,<2.0.0",             # VISA instrument control (oscilloscopes, etc.)
    "pyvisa-py>=0.7.0,<1.0.0",           # Pure Python VISA backend
    "pyserial>=3.5,<4.0.0",              # Serial port communication
]

# =============================================================================
# IOT - IoT protocol support (LoRaWAN, Zigbee, BLE, etc.)
# =============================================================================
# SEC-005 fix: Updated cryptography to >=44.0.1 to address CVE-2024-12797
# (OpenSSL vulnerability in static binary, MEDIUM severity)
iot = [
    "cryptography>=44.0.1,<47.0.0",      # Modern cryptography for LoRaWAN
]

# =============================================================================
# FUZZY - Fuzzy string matching (for Claude orchestration routing)
# =============================================================================
fuzzy = [
    "rapidfuzz>=3.0.0,<4.0.0",           # Fuzzy keyword matching for routing
]

# =============================================================================
# DEV - Development and testing tools
# =============================================================================
# SEC-005 note: "py" package (CVE-2022-42969) is a transitive dependency from
# older pytest versions. Modern pytest (>=8.0) no longer requires it. The CVE
# relates to ReDoS in SVN info parsing which Oscura doesn't use. Package will
# be automatically removed when all dependencies update to pytest 8.x.
dev = [
    "pytest>=8.0,<10.0.0",              # Testing framework
    "pytest-cov>=6.0,<8.0.0",           # Coverage reporting
    "pytest-timeout>=2.3.0,<3.0.0",     # Test timeout enforcement
    "pytest-benchmark>=4.0.0,<6.0.0",   # Performance benchmarking
    "pytest-xdist>=3.0,<4.0.0",         # Parallel test execution
    "pytest-randomly>=3.0,<4.0.0",      # Randomize test order
    "pytest-rerunfailures>=16.0,<17.0", # Retry flaky tests
    "pytest-asyncio>=0.23.0,<1.0.0",    # Async test support
    "pytest-split>=0.10.0,<1.0.0",      # Split tests for CI
    "hypothesis>=6.0.0,<7.0.0",         # Property-based testing
    "coverage[toml]>=7.0,<8.0.0",       # Coverage measurement
    "types-PyYAML>=6.0,<7.0.0",         # Type stubs for mypy
    "mypy>=1.0,<2.0.0",                 # Static type checking
    "ruff>=0.8.0,<1.0.0",               # Fast linting and formatting
    "yamllint>=1.35,<2.0.0",            # YAML linting
    "check-jsonschema>=0.29.0,<1.0.0",  # JSON schema validation
    "interrogate>=1.7.0,<2.0.0",        # Docstring coverage
    "pre-commit>=4.0.0,<5.0.0",         # Git hooks framework
]

# =============================================================================
# ALL - Install all optional dependencies (for development/CI)
# =============================================================================
all = [
    "oscura[standard,analysis,automotive,hardware,oscilloscopes,jupyter,hdf5,iot,fuzzy,dev]",
]

[project.scripts]
oscura = "oscura.cli.main:main"

[project.urls]
Homepage = "https://github.com/oscura-re/oscura"
Documentation = "https://github.com/oscura-re/oscura/tree/main/docs"
Repository = "https://github.com/oscura-re/oscura"
Changelog = "https://github.com/oscura-re/oscura/blob/main/CHANGELOG.md"
"Issue Tracker" = "https://github.com/oscura-re/oscura/issues"
Discussions = "https://github.com/oscura-re/oscura/discussions"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["src/oscura"]


[tool.hatch.build.targets.sdist]
exclude = [
    "/.github",
    "/.claude",
    "/tests",
    "/test_data",
    "/demos",
    "/examples",
    "/docs",
    "/scripts",
    "/.pytest_cache",
    "/.mypy_cache",
    "/.ruff_cache",
    "/dist",
    "/build",
    "*.pyc",
    "__pycache__",
]

# =============================================================================
# pytest - Testing Framework
# =============================================================================

[tool.pytest.ini_options]
testpaths = ["tests"]
pythonpath = ["src"]
addopts = [
    "--import-mode=importlib",
    "-ra",                         # Show summary of all test outcomes
    "--strict-markers",            # Enforce marker registration
    "--strict-config",             # Strict configuration validation
    "--tb=line",                   # Line traceback (faster than short)
    "--capture=sys",               # System capture (faster than default)
    "--ff",                        # Failed-first (run failures first)
    "--nf",                        # New-first (run new tests first)
    # Disable unnecessary plugins for maximum speed
    "-p", "no:deadfixtures",
    "-p", "no:memray",
    "-p", "no:split",
]
filterwarnings = [
    "error",
    "ignore::DeprecationWarning",
    # Coverage sysmon warning - Python 3.12 doesn't support branch coverage with sysmon
    "ignore:Can't use core=sysmon.*:coverage.exceptions.CoverageWarning",
    # Matplotlib tight_layout warning in protocol visualization tests
    "ignore:This figure includes Axes that are not compatible with tight_layout:UserWarning",
    # NOTE: pytest-benchmark warning filter removed - causes ModuleNotFoundError
    # when pytest-benchmark is not installed (e.g., in release smoke tests)
    # "ignore::pytest_benchmark.logger.PytestBenchmarkWarning",
    #
    # NOTE: All parallelized tests use -p no:benchmark to completely disable
    # the pytest-benchmark plugin when running with xdist (see test.sh, pre-push.sh,
    # and CI workflows). This prevents PytestBenchmarkWarning from being raised.
    #
    # NOTE: matplotlib warning - only needed if matplotlib is in system Python
    # "ignore::matplotlib._api.MatplotlibDeprecationWarning",
    "ignore:More than.*figures.*have been opened:RuntimeWarning",
    "ignore::ResourceWarning",     # RigolWFM library - known kaitaistruct limitation
    "ignore::pytest.PytestUnraisableExceptionWarning",
]
markers = [
    # Test Level Markers
    "unit: Unit tests (fast, isolated, no I/O)",
    "integration: Integration tests (slower, multiple components)",
    "stress: Stress tests (high load, memory intensive)",
    "performance: Performance benchmark tests",
    "benchmark: Performance benchmark tests (alias for performance)",
    "compliance: Standards compliance tests (IEEE, JEDEC)",
    "validation: Ground truth validation tests",
    "regression: Regression tests for fixed bugs",

    # Domain Markers - Top Level
    "analyzer: Analyzer module tests",
    "loader: Loader module tests",
    "inference: Protocol inference tests",
    "exporter: Exporter module tests",
    "core: Core functionality tests",
    "cli: CLI/command-line interface tests",
    "visualization: Visualization tests",
    "workflow: Workflow-specific tests",
    "automotive: Automotive/CAN bus tests",

    # Subdomain Markers - Analyzers
    "digital: Digital signal analysis tests",
    "spectral: Spectral analysis tests",
    "statistical: Statistical analysis tests",
    "protocol: Protocol analysis tests",
    "pattern: Pattern recognition/detection tests",
    "power: Power analysis tests",
    "jitter: Jitter measurement and analysis tests",
    "eye: Eye diagram generation and analysis tests",
    "packet: Packet analysis tests",

    # Subdomain Markers - Other
    "search: Search module tests",
    "optimization: Optimization and search tests",
    "comparison: Comparison module tests",
    "quality: Signal quality assessment tests",
    "exploratory: Exploratory analysis tests",
    "streaming: Streaming and real-time processing tests",

    # Speed/Resource Markers
    "slow: Tests taking >1 second to run",
    "memory_intensive: Tests requiring significant memory (>100MB)",
    "scalability: Scalability tests",

    # Dependency Markers
    "requires_data: Tests requiring test_data directory",
    "requires_optional: Tests requiring optional dependencies",

    # Special Test Types
    "hypothesis: Property-based tests using Hypothesis",
    "fuzz: Tests that use random input generation",
    "edge_cases: Edge case tests",

    # Requirements Traceability
    "requirement: Links test to specific requirement ID",
]
# Timeout configuration (requires pytest-timeout plugin, installed via dev dependencies)
timeout = 300
timeout_method = "thread"
timeout_func_only = false
console_output_style = "progress"

python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
norecursedirs = [".*", "build", "dist", "*.egg", "node_modules", "__pycache__", ".venv", "venv"]

# =============================================================================
# Hypothesis - Property-Based Testing
# =============================================================================
# NOTE: Hypothesis profiles are registered programmatically in tests/conftest.py
# using the pytest_configure hook. Available profiles: default, fast, ci, debug
# See tests/conftest.py for definitions.

# =============================================================================
# coverage - Test Coverage
# =============================================================================

[tool.coverage.run]
source = ["oscura"]
branch = true
parallel = true
concurrency = ["thread", "multiprocessing"]
data_file = ".coverage"
relative_files = true
omit = [
    "*/tests/*",
    "*/test_*.py",
    "*/__pycache__/*",
]

[tool.coverage.report]
fail_under = 80  # Minimum coverage threshold enforced in CI and locally
precision = 1
show_missing = true
skip_empty = true
exclude_also = [
    "pragma: no cover",
    "def __repr__",
    "if TYPE_CHECKING:",
    "raise NotImplementedError",
    "raise AssertionError",
    "@abstractmethod",
    "@overload",
    "if __name__ == .__main__.:",
    "class .*\\bProtocol\\):",
    "except ImportError:",
]

[tool.coverage.html]
directory = "htmlcov"

# =============================================================================
# Ruff - Linting and Formatting
# =============================================================================

[tool.ruff]
line-length = 100
target-version = "py312"
exclude = [
    ".git",
    ".venv",
    "__pycache__",
    "build",
    "dist",
    "*.egg-info",
    "*.ipynb",
    "analysis_archives",
    "archive",
    ".coordination",
    ".claude",
]

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "I",      # isort
    "UP",     # pyupgrade
    "B",      # flake8-bugbear
    "SIM",    # flake8-simplify
    "C4",     # flake8-comprehensions
    "PTH",    # flake8-use-pathlib
    "RUF",    # Ruff-specific rules
    "PERF",   # Perflint (performance)
    "PLC",    # Pylint convention
    "PLE",    # Pylint error
    "PLW",    # Pylint warning
    "TCH",    # flake8-type-checking
    "ARG",    # flake8-unused-arguments
    "S",      # flake8-bandit (security)
    "A",      # flake8-builtins
    "T10",    # flake8-debugger
    "PIE",    # flake8-pie
]
ignore = [
    "E501",   # Line too long (handled by formatter)
    # Intentional style choices
    "PLC0415", # import-outside-top-level: Lazy imports for optional dependencies
    "SIM102",  # collapsible-if: Explicit nesting improves readability
    "SIM105",  # suppressible-exception: try/except is often clearer
    "SIM108",  # if-else-block-instead-of-if-exp: Explicit blocks for clarity
    "SIM116",  # if-else-block-instead-of-dict-lookup: Dict not always clearer
    "SIM117",  # multiple-with-statements: Separate statements can be clearer
    "PTH110",  # os-path-exists: os.path is acceptable
    "PTH123",  # builtin-open: Standard open() is fine
    "PERF401", # manual-list-comprehension: Conditional appends clearer as loops
    "PERF402", # manual-list-copy: Explicit list() call is fine
    "PERF403", # manual-dict-comprehension: Explicit dict building is fine
    "ARG001",  # unused-function-argument: API compatibility requires extra args
    "ARG002",  # unused-method-argument: API compatibility requires extra args
    "TC002",   # typing-only-third-party-import: Low priority
    "UP040",   # non-pep695-type-alias: Using TypeAlias for mypy compatibility
    "UP046",   # generic-class-type-param: Using Generic[T] for mypy compatibility
    "UP047",   # generic-function-type-param: Using TypeVar for mypy compatibility
    "TC003",   # typing-only-standard-library-import: Low priority
    "TC004",   # runtime-import-in-type-checking-block: Can be tricky to refactor
    "TC010",   # runtime-string-union: Low priority typing improvement
    "PLW0603", # global-statement: Sometimes necessary for module-level state
    "PLW2901", # redefined-loop-name: Often intentional in nested loops
    "PLW3301", # nested-min-max: Readability preference
    "RUF005",  # collection-literal-concatenation: Style choice
    "RUF043",  # implicit-optional: Regex patterns with metacharacters
    "RUF046",  # unnecessary-cast-to-int: Often needed for mypy
    "RUF059",  # unpacked-variable-never-used: Common in tests
    "UP040",   # type-alias: Using TypeAlias for mypy compatibility
    "UP046",   # generic-class: Using Generic[T] for mypy compatibility
    "UP047",   # generic-function: Using TypeVar for mypy compatibility
    "UP007",   # non-pep604-annotation-union: May need Union for compatibility
    # Security rules - reviewed and documented
    "S101",    # assert - acceptable for library invariants
    "S102",    # exec - used only in Jupyter magic
    "S104",    # bind-all-interfaces - debug server config
    "S105",    # hardcoded-password - false positive (Unicode chars)
    "S110",    # try-except-pass - intentional graceful degradation
    "S112",    # try-except-continue - intentional robust parsing
    "S301",    # pickle - documented with security warnings
    "S310",    # suspicious-url-open - internal help system only
    "S311",    # suspicious-non-cryptographic-random - non-cryptographic use
    "S324",    # hashlib-insecure-hash - MD5 for cache keys only
    "S403",    # import-pickle - documented with security warnings
    "S404",    # import-subprocess - Wireshark validation
    "S603",    # subprocess-without-shell-equals-true - no untrusted input
    "S607",    # start-process-with-partial-path - standard tools
    "S608",    # hardcoded-sql-expression - false positive in non-SQL contexts
    # Builtins shadowing - intentional in domain contexts
    "A001",    # builtin-variable-shadowing (e.g., id, type, format)
    "A002",    # builtin-argument-shadowing (e.g., format, filter, type)
    "A003",    # builtin-attribute-shadowing (e.g., domain models)
    # PIE rules - stylistic preferences
    "PIE796",  # non-unique-enums - intentional duplicate values
    "PIE810",  # multiple-starts-ends-with - readability preference
]
fixable = ["ALL"]
unfixable = []

[tool.ruff.lint.per-file-ignores]
"**/__init__.py" = [
    "E402",     # Module level import not at top (organized imports intentional),
]
"demonstrations/**/*.py" = [
    "I001",     # Import ordering flexibility in demos,
]
"demos/**/*.py" = [
    "ARG001",   # Unused function argument,
    "F841",     # Local variable assigned but never used,
    "S108",     # Hardcoded /tmp paths acceptable in demos,
]
"find_untested.py" = [
    "ARG003",   # Callback signature from library,
    "ARG004",   # Callback signature from library,
]
"scripts/**/*.py" = [
    "PERF401",
]
"src/oscura/analyzers/jitter/*.py" = [
    "RUF003",   # Greek symbols in mathematical comments (sigma, etc.),
]
"src/oscura/analyzers/packet/stream.py" = [
    "SIM115",   # File handles managed by caller,
    "SIM113",   # Counter semantics clearer without enumerate,
]
"src/oscura/analyzers/power/*.py" = [
    "E741",     # Ambiguous variable name 'l' for limits (domain-specific),
]
"src/oscura/analyzers/protocols/*.py" = [
    "RUF012",   # ClassVar annotations for protocol decoder metadata,
]
"src/oscura/analyzers/spectral/chunked_fft.py" = [
    "SIM113",   # Segment counter semantics clearer without enumerate,
]
"src/oscura/analyzers/waveform/spectral.py" = [
    "B904",     # Exception re-raising for validation errors,
]
"src/oscura/api/dsl.py" = [
    "RUF012",   # ClassVar annotations for DSL metadata,
]
"src/oscura/api/dsl/__init__.py" = [
    "E402",     # Import ordering for conditional imports,
    "B904",     # Exception re-raising for operation errors,
    "ARG005",   # Kwargs reserved for future use,
    "RUF022",   # __all__ order matches logical grouping,
    "F401",     # Numpy import for TYPE_CHECKING,
]
"src/oscura/api/dsl/commands.py" = [
    "E402",     # Import ordering for conditional imports,
    "PLW0602",  # Global usage for command registry,
    "B904",     # Exception re-raising for command errors,
    "PTH207",   # String paths acceptable for DSL commands,
]
"src/oscura/api/dsl/interpreter.py" = [
    "E402",     # Import ordering for conditional imports,
    "B904",     # Exception re-raising for DSL operations,
    "PTH207",   # String glob acceptable for DSL,
]
"src/oscura/api/dsl/parser.py" = [
    "RUF012",   # ClassVar annotations for parser metadata,
]
"src/oscura/api/integrations/llm.py" = [
    "E402",     # Import ordering for conditional imports,
    "B904",     # Exception re-raising for integration errors,
    "B024",     # Abstract methods defined in subclasses,
    "B027",     # Empty methods are intentional stubs,
    "PTH207",   # String paths acceptable for API compatibility,
]
"src/oscura/api/operators.py" = [
    "RUF012",   # ClassVar annotations for operator metadata,
]
"src/oscura/automotive/dbc/generator.py" = [
    "ARG004",   # Reserved for future implementation,
]
"src/oscura/automotive/flexray/fibex.py" = [
    "S314",     # FIBEX XML parsing from trusted sources,
]
"src/oscura/cli/batch.py" = [
    "PTH207",   # String glob acceptable for batch processing,
]
"src/oscura/cli/main.py" = [
    "E402",     # Import ordering for CLI setup,
    "B027",     # Abstract base methods,
    "PLW0602",  # Global state for CLI,
    "PTH104",   # Path operations acceptable in CLI,
    "PTH202",   # Path operations acceptable in CLI,
]
"src/oscura/core/cancellation.py" = [
    "B904",     # Exception handling in cancellation logic,
]
"src/oscura/core/config/loader.py" = [
    "B904",     # Exception handling in config loading,
]
"src/oscura/core/config/memory.py" = [
    "S314",     # XML parsing with defusedxml,
    "S305",     # ElementTree usage controlled,
    "PLW0602",  # Global config state management,
]
"src/oscura/core/config/pipeline.py" = [
    "B007",     # Loop variable for depth tracking,
]
"src/oscura/core/config/protocol.py" = [
    "RUF012",   # ClassVar annotations for protocol config,
    "PTH204",   # os.path acceptable for protocol config,
]
"src/oscura/core/extensibility/plugins.py" = [
    "RUF012",   # ClassVar annotations for plugin metadata,
]
"src/oscura/core/logging.py" = [
    "E402",     # Import ordering for logging setup,
    "PLW0602",  # Global logging state management,
    "ARG003",   # Reserved for future implementation,
]
"src/oscura/core/logging_advanced.py" = [
    "E402",     # Import ordering for logging setup,
    "B027",     # Abstract base methods,
    "PTH204",   # String paths acceptable for logging,
    "B904",     # Exception handling in logging infrastructure,
    "SIM115",   # File handle management by caller,
    "PTH202",   # os.path acceptable for log rotation,
    "PTH104",   # os.rename acceptable for log rotation,
]
"src/oscura/core/plugins/base.py" = [
    "B024",     # Abstract base class design,
    "B027",     # Abstract base methods,
    "PLW1508",  # Invalid environment defaults are caught,
    "RUF012",   # ClassVar annotations for plugin metadata,
]
"src/oscura/dsl/interpreter.py" = [
    "F401",     # Dynamic loading requires import presence,
]
"src/oscura/exploratory/*.py" = [
    "RUF002",   # Mathematical symbols in docstrings,
]
"src/oscura/exporters/*.py" = [
    "F401",     # Imports used in generated code/templates,
]
"src/oscura/integrations/llm.py" = [
    "PLC0415",  # Conditional imports for optional dependencies,
    "F401",     # Imports checked dynamically,
]
"src/oscura/iot/lorawan/crypto.py" = [
    "S305",     # ECB mode documented limitation for LoRaWAN spec,
]
"src/oscura/jupyter/ui/formatters.py" = [
    "RUF001",   # Unicode information symbol intentional,
]
"src/oscura/loaders/pcap.py" = [
    "B904",     # Exception handling in packet parsing,
]
"src/oscura/reporting/export.py" = [
    "B904",     # Exception handling in export operations,
]
"src/oscura/utils/memory_advanced.py" = [
    "RUF012",   # ClassVar annotations for memory tracking,
]
"src/oscura/utils/comparison/*.py" = [
    "B007",     # Loop variable intentional for comparison logic,
]
"src/oscura/utils/memory.py" = [
    "B904",     # Exception handling in memory monitoring,
    "PLW0602",  # Global memory state management,
]
"src/oscura/utils/memory_extensions.py" = [
    "B027",     # Abstract base methods,
    "PERF102",  # Dict iteration intentional for validation,
    "TC001",    # Type checking imports,
    "ARG005",   # Lambda signature compatibility,
    "PLW1508",  # Environment variable handling,
    "B904",     # Exception re-raising for import errors,
]
"src/oscura/validation/compliance/*.py" = [
    "B904",     # Exception re-raising for validation errors,
]
"src/oscura/validation/compliance/advanced.py" = [
    "RUF012",   # ClassVar annotations for compliance metadata,
]
"src/oscura/validation/compliance/reporting.py" = [
    "E741",     # Variable 'l' for level acceptable in compliance,
]
"src/oscura/visualization/*.py" = [
    "RUF002",   # Mathematical symbols in docstrings,
    "E741",     # Variable 'l' for lightness acceptable in graphics,
    "PTH104",   # String paths acceptable in visualization,
]
"src/oscura/visualization/colors.py" = [
    "E741",     # Variable 'l' for lightness (HSL color model standard),
    "RUF001",   # Unicode in color definitions,
]
"src/oscura/visualization/palettes.py" = [
    "B904",     # Exception handling in color palette loading,
]
"src/oscura/visualization/render.py" = [
    "B904",     # Exception handling in rendering,
]
"src/oscura/visualization/specialized.py" = [
    "B007",     # Loop variable for iteration control,
]
"src/oscura/workflows/multi_trace.py" = [
    "B904",     # Exception re-raising for workflow errors,
    "RUF012",   # ClassVar annotations for workflow metadata,
    "PTH207",   # String glob acceptable for pattern matching,
]
"src/oscura/workflows/signal_integrity.py" = [
    "F401",     # Import used in conditional code path,
]
"test_data/**/*.py" = [
    "E741",     # Ambiguous variable name (data generation scripts),
]
"tests/**/*.py" = [
    "ARG001", "ARG002", "ARG004", "ARG005",
    "B007", "B017",
    "E402", "E721", "E741",
    "F841",
    "PLC0415",
    "PLR2004",
    "PLW0127",
    "PTH109",
    "RUF001", "RUF003", "RUF012",
    "S108",
    "SIM113",
    "PERF401",
]
"tests/integration/test_export_roundtrips.py" = [
    "ARG005",   # Kwargs for test fixtures,
]
"tests/unit/automotive/can/test_checksum.py" = [
    "F401",     # Import for optional dependency testing,
]
"tests/unit/core/test_cross_domain.py" = [
    "PERF102",  # Dict iteration intentional for validation,
]
"tests/unit/loaders/test_csv.py" = [
    "F403",     # Star import for API testing,
]
"tests/unit/performance/test_optimizations.py" = [
    "B007",     # Loop variable intentional for benchmarking,
]
"tests/unit/test___main__.py" = [
    "PERF102",  # Dict iteration intentional for testing,
    "SIM118",   # Testing dict.keys() explicitly,
]
"tests/unit/test_exceptions.py" = [
    "B007",     # Loop variable intentional for testing,
]
"tests/unit/visualization/test_jitter.py" = [
    "RUF002",   # Greek symbols in mathematical docstrings,
]
"tests/unit/visualization/test_optimization.py" = [
    "RUF002",   # Mathematical symbols in docstrings,
]
[tool.ruff.format]
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "auto"

# =============================================================================
# mypy - Static Type Checking
# =============================================================================

[tool.mypy]
python_version = "3.12"
strict = true
show_error_codes = true
warn_unreachable = true
warn_return_any = true
warn_unused_configs = true
warn_unused_ignores = false
enable_error_code = ["ignore-without-code", "redundant-cast", "truthy-bool"]
exclude = [
    "^tests/",
    "^demos/",
    "^scripts/",
    "^test_data/",
    "^\\.venv/",
    "^build/",
    "^tmp/",
    "^analysis_archives/",
    "^archive/",
]

[[tool.mypy.overrides]]
module = ["tests.*"]
disallow_untyped_defs = false
disallow_incomplete_defs = false

# Third-party libraries without type stubs
[[tool.mypy.overrides]]
module = [
    "numpy", "numpy.*",
    "scipy", "scipy.*",
    "matplotlib", "matplotlib.*",
    "pandas", "pandas.*",
    "pywt", "pywt.*",
    "click", "click.*",
    "psutil", "psutil.*",
    "yaml", "yaml.*",
    "jinja2", "jinja2.*",
    "jsonschema", "jsonschema.*",
    "reportlab", "reportlab.*",
    "pptx", "pptx.*",
    "h5py", "h5py.*",
    "nptdms", "nptdms.*",
    "weasyprint", "weasyprint.*",
    "docx", "docx.*",
    "IPython", "IPython.*",
    "jupyter", "jupyter.*",
    "PIL", "PIL.*",
    "plotly", "plotly.*",
    "bokeh", "bokeh.*",
    "scapy", "scapy.*",
    "can", "can.*",
    "cantools", "cantools.*",
    "asammdf", "asammdf.*",
    "Crypto", "Crypto.*",
    "tqdm", "tqdm.*",
]
ignore_missing_imports = true

# Internal modules that may not exist
[[tool.mypy.overrides]]
module = [
    "oscura.loaders.binary",
    "oscura.loaders.csv",
    "oscura.loaders.hdf5",
]
ignore_missing_imports = true

# DSL commands with dynamic imports
[[tool.mypy.overrides]]
module = ["oscura.dsl.commands"]
disable_error_code = ["attr-defined"]

# Visualization modules - matplotlib attribute access
[[tool.mypy.overrides]]
module = [
    "oscura.visualization.reverse_engineering",
    "oscura.automotive.visualization",
]
disable_error_code = ["attr-defined"]

# CLI modules - click decorators don't have complete type stubs
[[tool.mypy.overrides]]
module = ["oscura.cli.*"]
disable_error_code = ["untyped-decorator"]

# Modules with optional dependencies
[[tool.mypy.overrides]]
module = ["numba", "numba.*", "dpkt", "dpkt.*", "pyvisa", "pyvisa.*", "saleae", "saleae.*", "sklearn", "sklearn.*", "networkx", "networkx.*"]
ignore_missing_imports = true

# Hardware acquisition modules - optional dependencies
[[tool.mypy.overrides]]
module = [
    "oscura.acquisition.socketcan",
    "oscura.acquisition.saleae",
    "oscura.acquisition.visa",
]
disable_error_code = ["attr-defined", "unreachable"]

# =============================================================================
# Bandit - Security Linting
# =============================================================================

[tool.bandit]
exclude_dirs = ["tests", "demos", "scripts", ".venv", "build", "dist"]
skips = [
    "B101",  # assert_used: Assertions acceptable in library code
    "B311",  # random: Non-cryptographic random fine for signal processing
]

# =============================================================================
# interrogate - Docstring Coverage
# =============================================================================

[tool.interrogate]
ignore-init-method = true
ignore-init-module = true
ignore-magic = false
ignore-semiprivate = false
ignore-private = false
ignore-property-decorators = false
ignore-module = false
ignore-nested-functions = false
ignore-nested-classes = true
fail-under = 95
exclude = ["tests", "demos", "scripts"]
verbose = 2
quiet = false
color = true
generate-badge = "docs/badges/"
badge-format = "svg"

# =============================================================================
# vulture - Dead Code Detection
# =============================================================================

[tool.vulture]
exclude = ["tests/", "demos/", "scripts/", ".venv/"]
ignore_decorators = ["@pytest.fixture", "@pytest.mark.*", "@click.command"]
ignore_names = ["visit_*", "setUp", "tearDown", "test_*"]
min_confidence = 80
paths = ["src/oscura"]
sort_by_size = true

# =============================================================================
# pydocstyle - Docstring Style Checking
# =============================================================================

[tool.pydocstyle]
convention = "google"
add-ignore = ["D100", "D104"]
match = "(?!test_).*\\.py"
match-dir = "^(?!tests|demos|scripts|\\.venv|build|dist).*"

# =============================================================================
# Development Dependencies (uv-managed)
# =============================================================================
# This section is managed by uv and supersedes [project.optional-dependencies]
# for development workflows. Use: uv sync --group dev

[dependency-groups]
dev = [
    "bandit>=1.9.2",
    "darglint>=1.8.1",
    "diff-cover>=10.2.0",
    "fastapi[all]>=0.128.0",
    "h5py>=3.15.1",
    "hypothesis>=6.148.8",
    "import-linter>=2.9",
    "interrogate>=1.7.0",
    "jsonschema>=4.25.1",
    "linkchecker>=10.6.0",
    "mike>=2.1.3",
    "mkdocs>=1.6.1",
    "mkdocs-glightbox>=0.5.2",
    "mkdocs-material>=9.7.1",
    "mkdocstrings>=1.0.0",
    "mkdocstrings-python>=2.0.1",
    "mypy>=1.13.0",
    "pre-commit>=4.5.1",
    "pydeps>=3.0.2",
    "pydocstyle>=6.3.0",
    "pylint>=4.0.4",
    "pytest>=8.0,<10.0.0",
    "pytest-asyncio>=0.23.0",
    "pytest-benchmark>=5.2.3",
    "pytest-cov>=7.0.0",
    "pytest-deadfixtures>=3.0.0",
    "pytest-memray>=1.8.0",
    "pytest-randomly>=3.0,<4.0.0",
    "pytest-rerunfailures>=16.1",
    "pytest-split>=0.2.0",
    "pytest-testmon>=2.2.0",
    "pytest-timeout>=2.4.0",
    "pytest-xdist>=3.8.0",
    "pywavelets>=1.9.0",
    "radon>=6.0.1",
    "ruff>=0.14.0",
    "safety>=3.7.0",
    "uvicorn>=0.40.0",
    "vulture>=2.14",
    "wily>=1.12.2",
]
