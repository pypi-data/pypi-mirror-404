Metadata-Version: 2.4
Name: isagellm-kv-cache
Version: 0.4.0.6
Summary: KV Cache Management Module for sageLLM
Author-email: IntelliStream Team <shuhao_zhang@hust.edu.cn>
License: Private
Project-URL: Homepage, https://github.com/intellistream/sagellm-kv-cache
Project-URL: Repository, https://github.com/intellistream/sagellm-kv-cache
Project-URL: Issues, https://github.com/intellistream/sagellm-kv-cache/issues
Keywords: llm,inference,kv-cache,domestic-hardware
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Requires-Python: ==3.11.*
Description-Content-Type: text/markdown
Requires-Dist: pydantic>=2.0.0
Requires-Dist: isagellm-protocol<0.5.0,>=0.4.0.0
Requires-Dist: isagellm-backend<0.5.0,>=0.4.0.0
Requires-Dist: isagellm-comm<0.5.0,>=0.4.0.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"
Requires-Dist: ruff>=0.1.0; extra == "dev"
Requires-Dist: isage-pypi-publisher>=0.2.0; extra == "dev"

# sagellm-kv-cache

## Protocol Compliance (Mandatory)

- MUST follow Protocol v0.1: https://github.com/intellistream/sagellm-docs/blob/main/docs/specs/protocol_v0.1.md
- Any globally shared definitions (fields, error codes, metrics, IDs, schemas) MUST be added to Protocol first.

[![CI](https://github.com/intellistream/sagellm-kv-cache/actions/workflows/ci.yml/badge.svg)](https://github.com/intellistream/sagellm-kv-cache/actions/workflows/ci.yml)
[![codecov](https://codecov.io/gh/intellistream/sagellm-kv-cache/branch/main/graph/badge.svg)](https://codecov.io/gh/intellistream/sagellm-kv-cache)
[![PyPI version](https://badge.fury.io/py/isagellm-kv-cache.svg)](https://badge.fury.io/py/isagellm-kv-cache)
[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)

**KV Cache Management + KV Transfer** for sageLLM inference engine.

## Overview

This package provides efficient KV cache management and transfer for LLM inference:

| åŠŸèƒ½ | ä»»åŠ¡ | è¯´æ˜ |
|------|------|------|
| **Prefix Cache** | Task2.1 | å‰ç¼€æ„ŸçŸ¥çš„ KV ç¼“å­˜å¤ç”¨ |
| **KV Memory Pool** | Task2.2 | å—å¼ KV å†…å­˜æ± ç®¡ç† |
| **Eviction Policies** | Task2.3 | LRU/LFU/Lifetime-aware é©±é€ç­–ç•¥ |
| **KV Transfer** | Task1.3 | KV å—çš„è·¨èŠ‚ç‚¹ä¼ è¾“åŸè¯­ |

### ğŸ“¦ èŒè´£è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    sagellm-control-plane                            â”‚
â”‚              (è°ƒåº¦å†³ç­–ï¼šå“ªäº› KV éœ€è¦åˆ†é…/é©±é€/è¿ç§»)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ KVCacheInterface
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      sagellm-kv-cache (æœ¬ä»“åº“)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PrefixCache â”‚  â”‚  KV Pool    â”‚  â”‚  Eviction   â”‚  â”‚ KV Transfer â”‚ â”‚
â”‚  â”‚  (Task2.1)  â”‚  â”‚  (Task2.2)  â”‚  â”‚  (Task2.3)  â”‚  â”‚  (Task1.3)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ä½¿ç”¨ CommBackend è¿›è¡Œå®é™…ç½‘ç»œä¼ è¾“
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         sagellm-comm                                 â”‚
â”‚              (ç½‘ç»œå±‚ï¼šæ‹“æ‰‘å‘ç°ã€é›†åˆæ“ä½œã€äº’è”é€‚é…)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ” Research Context

**sagellm-kv-cache** is conceptually similar to the **Store** component in [Mooncake](https://github.com/kvcache-ai/Mooncake) (KVCache.AI):

| Aspect | Mooncake Store | sagellm-kv-cache |
|--------|---------------|------------------|
| **Core Function** | KV cache storage & management | KV cache storage + transfer |
| **Scope** | Distributed KV store layer | KV pool + prefix cache + eviction + transfer |
| **Focus** | Multi-tier storage (GPU/CPU/NVMe) | Unified memory pool with compression |
| **Target** | Cross-node disaggregated KV cache | Inference engine integration |

Both systems aim to solve the **KV cache memory bottleneck** in LLM inference, but sagellm-kv-cache focuses on **deep integration with sageLLM's scheduling and compression layers** (Task2.1-2.3, Task1.3).

**Key innovations**:
- Unified `KVHandle` abstraction for seamless integration with scheduler (Task2.4) and network layer (sagellm-comm)
- Native compression support (coordinated with sagellm-compression)
- Lifecycle-aware eviction policies (Task2.3)
- **KV Transfer (Task1.3)** integrated for data-aware transfer optimization

## Installation

```bash
# ä» PyPI å®‰è£…ï¼ˆè‡ªåŠ¨å®‰è£…ä¾èµ–ï¼‰
pip install isagellm-kv-cache
```

## ğŸš€ å¼€å‘è€…å¿«é€Ÿå¼€å§‹

```bash
git clone git@github.com:intellistream/sagellm-kv-cache.git
cd sagellm-kv-cache
./quickstart.sh   # ä¸€é”®å®‰è£…å¼€å‘ç¯å¢ƒï¼ˆå«ä¾èµ–ï¼‰

# æˆ–æ‰‹åŠ¨å®‰è£…
pip install -e ".[dev]"
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
pytest tests/ -v
```

> ğŸ’¡ `isagellm-protocol` å’Œ `isagellm-backend` ä¼šè‡ªåŠ¨ä» PyPI å®‰è£…ã€‚

## Quick Start

```python
from sagellm_kv_cache import KVCacheManager, EvictionPolicy

# Create KV cache manager
cache = KVCacheManager(
    max_memory_mb=16384,
    eviction_policy=EvictionPolicy.LRU
)

# Allocate KV blocks
block = cache.allocate(num_tokens=128)
```

## Dependencies

- `isagellm-protocol>=0.1.0` - Protocol definitions
- `isagellm-backend>=0.1.0` - Backend abstraction

## Development

### Setup Development Environment

```bash
# Install dev dependencies
pip install -e ".[dev]"

# Install pre-commit hooks
pip install pre-commit
pre-commit install
```

### Pre-commit Hooks

This project uses [pre-commit](https://pre-commit.com/) to ensure code quality:

- **Ruff**: Fast Python linter and formatter (replaces flake8, isort, black)
- **MyPy**: Static type checking
- **File checks**: Trailing whitespace, EOF, YAML/TOML validation

```bash
# Run on all files
pre-commit run --all-files

# Run on specific files
pre-commit run --files src/sagellm_kv_cache/*.py

# Skip hooks temporarily (not recommended)
git commit --no-verify
```

Pre-commit hooks run automatically on `git commit`. If hooks modify files, stage the changes and commit again.

### Testing

```bash
# Run all tests
pytest tests/ -v

# Run with coverage
pytest --cov=sagellm_kv_cache --cov-report=html

# Run specific test file
pytest tests/test_basic.py -v
```

### Code Quality

```bash
# Format & lint (or use pre-commit)
ruff format .
ruff check .
mypy src/
```

## ğŸ”„ è´¡çŒ®æŒ‡å—

è¯·éµå¾ªä»¥ä¸‹å·¥ä½œæµç¨‹ï¼š

1. **åˆ›å»º Issue** - æè¿°é—®é¢˜/éœ€æ±‚
   ```bash
   gh issue create --title "[Bug] æè¿°" --label "bug,sagellm-kv-cache"
   ```

2. **å¼€å‘ä¿®å¤** - åœ¨æœ¬åœ° `fix/#123-xxx` åˆ†æ”¯è§£å†³
   ```bash
   git checkout -b fix/#123-xxx origin/main-dev
   # å¼€å‘ã€æµ‹è¯•...
   pytest -v
   ruff format . && ruff check . --fix
   ```

3. **å‘èµ· PR** - æäº¤åˆ° `main-dev` åˆ†æ”¯
   ```bash
   gh pr create --base main-dev --title "Fix: æè¿°" --body "Closes #123"
   ```

4. **åˆå¹¶** - å®¡æ‰¹ååˆå¹¶åˆ° `main-dev`

æ›´å¤šè¯¦æƒ…è§ [.github/copilot-instructions.md](.github/copilot-instructions.md)

## License

Private - IntelliStream Research Project
