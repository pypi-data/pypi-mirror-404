name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  prepare_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check and Update Version
        id: version_check
        run: |
          VERSION="${{ inputs.version }}"
          # Remove 'v' prefix for pyproject.toml
          VERSION_NO_V="${VERSION#v}"

          # Get current version from pyproject.toml
          # Assumes version = "x.y.z" format
          CURRENT_VERSION=$(grep -m1 '^version = ' pyproject.toml | cut -d'"' -f2)

          echo "Current version: ${CURRENT_VERSION}"
          echo "Requested version: ${VERSION_NO_V}"

          if [ "${CURRENT_VERSION}" = "${VERSION_NO_V}" ]; then
            echo "Version is already correct in pyproject.toml"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "Updating pyproject.toml from ${CURRENT_VERSION} to ${VERSION_NO_V}"
            sed -i "s/^version = \"${CURRENT_VERSION}\"/version = \"${VERSION_NO_V}\"/" pyproject.toml
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Version Update
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          git add pyproject.toml
          git commit -m "Bump version to ${{ inputs.version }}"
          git push origin main

      - name: Create and Push Tag
        run: |
          # Check if tag already exists locally
          if git rev-parse "${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Tag ${{ inputs.version }} already exists locally, skipping creation"
          else
            git tag ${{ inputs.version }}
            echo "Created tag ${{ inputs.version }}"
          fi

          # Push tag
          git push origin ${{ inputs.version }} || {
            echo "Failed to push tag, it might already exist remotely"
            exit 1
          }

      - name: Create Release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = '${{ inputs.version }}';

            // Check if release already exists
            try {
              const { data: existingRelease } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });
              console.log(`Release ${tagName} already exists: ${existingRelease.html_url}`);
              return;
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
            }

            // Create the release
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: tagName,
              draft: false,
              prerelease: false,
              generate_release_notes: true
            });
            console.log(`Created release ${release.html_url}`);

  trigger_publish:
    needs: prepare_release
    uses: ./.github/workflows/release.yml
    with:
      tag_name: ${{ inputs.version }}
    secrets: inherit
