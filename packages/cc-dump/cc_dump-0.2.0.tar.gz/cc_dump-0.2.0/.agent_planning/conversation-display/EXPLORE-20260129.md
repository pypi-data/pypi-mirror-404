# Explore Output: Composable Conversation Rendering System
Timestamp: 2026-01-29

## Current Implementation (As-Is)

### ConversationView (widget_factory.py:21-101)
- Extends `RichLog` (append-only log widget)
- `append_block(block, filters)` renders individual blocks via `render_block()`, writes to RichLog
- TextDeltaBlocks are accumulated in `_text_delta_buffer` and flushed as combined Text
- `finish_turn()` flushes buffer, saves current blocks to `_turn_blocks` list
- `rerender(filters)` calls `self.clear()` then re-renders ALL stored turns from scratch
- `get_state()` / `restore_state()` transfers turn_blocks, current_turn_blocks, text_delta_buffer

### How Rerender is Triggered (app.py:450-482)
- `_rerender_if_mounted()` called by all filter watchers (show_headers, show_tools, show_system, show_expand, show_metadata)
- Calls `self._get_conv().rerender(self.active_filters)` which does clear + full rebuild
- Also called during hot-reload: `_check_hot_reload()` -> `_get_conv().rerender()`

### Event Flow (event_handlers.py)
- `handle_request()`: formats blocks, calls `conv.append_block()` for each, then `conv.finish_turn()`
- `handle_response_event()`: formats streaming blocks, calls `conv.append_block()` for each
- `handle_response_done()`: calls `conv.finish_turn()`, conditionally `conv.rerender(filters)` if expand mode
- `handle_error()` / `handle_proxy_error()`: single block + finish_turn
- `finish_turn()` is called with NO arguments (4 call sites)

### Rendering (rendering.py)
- `render_block(block, filters)` dispatches to type-specific renderer via `BLOCK_RENDERERS` dict
- Each renderer returns `Text | None` (None = filtered out)
- `render_blocks(blocks, filters)` batch version
- No `BLOCK_FILTER_KEY` dict exists yet (proposed in plan)

### FormattedBlock IR (formatting.py)
- ~18 dataclass types, all extend `FormattedBlock`
- Pure data, no rendering logic
- `TextDeltaBlock` is special: accumulated for streaming

### styles.css
- `ConversationView { height: 1fr; border: solid $primary; }` -- simple, no scroll-specific styles
- No TurnWidget or StreamingTurnWidget styles exist

### Existing Tests
- PTY-based integration tests (test_tui_integration.py) -- ~30+ tests
- Tests only assert `proc.is_alive()` after operations, some check content presence
- No unit tests for ConversationView internals
- No tests for scroll behavior, widget lifecycle, or filter precision

### Textual Version
- textual>=0.80.0 required, installed: 7.3.0
- ScrollableContainer API verified: has scroll_end, scroll_to_widget, is_vertical_scroll_end, mount, query, query_one
- Static.update() accepts Rich Text (VisualType)

### ConversationView Public API Call Sites
- `conv.append_block(block, filters)` -- event_handlers.py (4 sites)
- `conv.finish_turn()` -- event_handlers.py (4 sites, no filters arg)
- `conv.rerender(filters)` -- app.py (2 sites), event_handlers.py (1 site)
- `conv.get_state()` / `conv.restore_state()` -- app.py hot-reload
