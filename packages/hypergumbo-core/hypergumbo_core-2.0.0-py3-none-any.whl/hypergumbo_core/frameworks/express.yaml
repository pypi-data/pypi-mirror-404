# Express.js framework patterns (ADR-0003 v1.0.x + v1.1.x)
#
# Matches Express.js routing and middleware patterns.
# Symbols matching these patterns get enriched with concept metadata.
#
# Definition-based patterns (v1.0.x): Match decorator-style metadata
# Usage-based patterns (v1.1.x): Match call-based routing via UsageContext

id: express
language: javascript

patterns:
  # ==================== USAGE-BASED PATTERNS (v1.1.x) ====================
  # These match against UsageContext records for call-based routing

  # Express route handlers - app.get('/path', handler)
  - concept: route
    usage:
      kind: "^call$"
      name: "^(app|router|express|server|fastify|koa)\\.(get|post|put|delete|patch|options|head|all)$"
      position: "^args\\[last\\]$"
    extract:
      path: "metadata.route_path"
      method: "metadata.http_method"

  # ==================== DEFINITION-BASED PATTERNS (v1.0.x) ====================
  # Express route handlers - app.get(), app.post(), etc.
  - concept: route
    decorator: "^(app|router|express)\\.(get|post|put|delete|patch|options|head|all)$"
    extract_path: "args[0]"
    extract_method: "decorator_suffix"

  # Express Router - router.route('/path').get().post()
  - concept: route
    decorator: "^(app|router)\\.route$"
    extract_path: "args[0]"

  # Express middleware - app.use()
  - concept: middleware
    decorator: "^(app|router)\\.use$"

  # Express param middleware - app.param('id', callback)
  - concept: middleware
    decorator: "^(app|router)\\.param$"

  # Express error handler (4-argument function)
  # Note: This pattern would need special handling in the analyzer
  # to detect 4-parameter functions as error handlers

  # Passport.js authentication strategies
  - concept: auth_strategy
    base_class: "^(Strategy|LocalStrategy|JwtStrategy|OAuth2Strategy|GoogleStrategy|FacebookStrategy|GitHubStrategy)$"

  # Express session middleware
  - concept: middleware
    decorator: "^session$"

  # Morgan logger middleware
  - concept: middleware
    decorator: "^morgan$"

  # Helmet security middleware
  - concept: middleware
    decorator: "^helmet$"

  # CORS middleware
  - concept: middleware
    decorator: "^cors$"

  # Body-parser middleware
  - concept: middleware
    decorator: "^(bodyParser|json|urlencoded)$"

  # Multer file upload
  - concept: middleware
    decorator: "^multer$"

  # Express validator
  - concept: middleware
    decorator: "^(body|query|param|check|validationResult)$"

  # Socket.io event handlers
  - concept: websocket_handler
    decorator: "^(socket|io)\\.on$"

  # Socket.io emit (for connection patterns)
  - concept: websocket_emitter
    decorator: "^(socket|io)\\.(emit|broadcast)$"

  # Socket.io namespace
  - concept: websocket_namespace
    decorator: "^io\\.of$"

  # ==================== HTTP CLIENT PATTERNS ====================
  # These detect frontend API calls that could link to backend routes

  # Fetch API - fetch('/api/users')
  - concept: http_client
    usage:
      kind: "^call$"
      name: "^fetch$"
      position: "^args\\[0\\]$"

  # Axios - axios.get('/api/users'), axios.post('/api/users')
  - concept: http_client
    usage:
      kind: "^call$"
      name: "^axios\\.(get|post|put|delete|patch|head|options|request)$"
      position: "^args\\[0\\]$"

  # Axios instance - api.get('/users'), client.post('/data')
  - concept: http_client
    decorator: "^(axios|api|client|http)\\.(get|post|put|delete|patch|head|options|request)$"

  # Ky HTTP client - ky.get('/api/users')
  - concept: http_client
    decorator: "^ky\\.(get|post|put|delete|patch|head|extend)$"

  # Got HTTP client - got.get('/api/users')
  - concept: http_client
    decorator: "^got\\.(get|post|put|delete|patch|head|stream)$"

  # Superagent - request.get('/api/users')
  - concept: http_client
    decorator: "^(request|superagent)\\.(get|post|put|delete|patch|head)$"

linkers:
  - http
  - websocket
