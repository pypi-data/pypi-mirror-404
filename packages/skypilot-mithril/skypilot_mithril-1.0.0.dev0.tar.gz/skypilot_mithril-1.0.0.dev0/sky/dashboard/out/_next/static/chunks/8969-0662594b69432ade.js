"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8969],{68969:function(e,t,r){r.d(t,{Ce:function(){return m},NJ:function(){return p},UA:function(){return f},aT:function(){return u},getManagedJobs:function(){return i},jh:function(){return b},vs:function(){return d}});var o=r(67294),a=r(15821),n=r(93225),s=r(6378),l=r(47145);let c=["job_id","_job_id","job_name","user_name","user_hash","workspace","submitted_at","job_duration","status","resources","cloud","region","accelerators","cluster_resources","cluster_resources_full","recovery_count","pool","pool_hash","details","failure_reason","links"];async function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{var t;let{allUsers:r=!0,skipFinished:o=!1,allFields:a=!1,nameMatch:s,userMatch:i,workspaceMatch:u,poolMatch:d,page:f,limit:p,statuses:m,fields:b,jobIDs:h}=e,_={all_users:r,verbose:!0,skip_finished:o};void 0!==s&&(_.name_match=s),void 0!==i&&(_.user_match=i),void 0!==u&&(_.workspace_match=u),void 0!==d&&(_.pool_match=d),void 0!==f&&(_.page=f),void 0!==p&&(_.limit=p),void 0!==m&&m.length>0&&(_.statuses=m),void 0!==h&&h.length>0&&(_.job_ids=h),a||(b&&b.length>0?_.fields=b:_.fields=c);let g=await l.x.post("/jobs/queue/v2",_);if(!g.ok){let e="Failed to get managed jobs with status ".concat(g.status);throw Error(e)}let w=g.headers.get("X-Skypilot-Request-ID");if(!w)throw Error("No request ID received from server for managed jobs");let y=await l.x.get("/api/get?request_id=".concat(w)),j=y.statusText;if(500===y.status)try{let e=await y.json();if(e.detail&&e.detail.error)try{let t=JSON.parse(e.detail.error);if(t.type&&t.type===n.iW)return{jobs:[],total:0,controllerStopped:!0};j=t.message||String(e.detail.error)}catch(t){console.error("Error parsing JSON from data.detail.error:",t),j=String(e.detail.error)}}catch(e){console.error("Error parsing response JSON:",e),j=String(e)}if(!y.ok){let e="API request to get managed jobs result failed with status ".concat(y.status,", error: ").concat(j);throw Error(e)}let v=await y.json(),E=v.return_value?JSON.parse(v.return_value):[],S=Array.isArray(E)?E:(null==E?void 0:E.jobs)||[],C=Array.isArray(E)?S.length:null!==(t=null==E?void 0:E.total)&&void 0!==t?t:S.length,k=(null==E?void 0:E.total_no_filter)||C,x=(null==E?void 0:E.status_counts)||{};return{jobs:S.map(e=>{var t;let r=0;e.end_at&&e.submitted_at?r=e.end_at-e.submitted_at:e.submitted_at&&(r=Date.now()/1e3-e.submitted_at);let o=[];e.submitted_at&&o.push({type:"PENDING",timestamp:e.submitted_at}),e.start_at&&o.push({type:"RUNNING",timestamp:e.start_at}),e.end_at&&o.push({type:e.status,timestamp:e.end_at});let a="",n="",s="",l="",c="";try{if(a=e.cloud||"",s=e.cluster_resources,n=e.region||"","-"===n&&(n=""),a&&(l=a,n&&(l+=" (".concat(n,")"))),c=l,e.accelerators){let t=Object.entries(e.accelerators).map(e=>{let[t,r]=e;return"".concat(r,"x").concat(t)}).join(", ");t&&(c+=" (".concat(t,")"))}}catch(t){s=e.cluster_resources}return{id:e.job_id,task_job_id:e._job_id,task:e.task_name,name:e.job_name,job_duration:e.job_duration,total_duration:r,workspace:e.workspace,status:e.status,requested_resources:e.resources,resources_str:s,resources_str_full:e.cluster_resources_full||s,cloud:a,region:e.region,infra:l,full_infra:c,recoveries:e.recovery_count,details:e.details||e.failure_reason,user:e.user_name,user_hash:e.user_hash,submitted_at:e.submitted_at?new Date(1e3*e.submitted_at):null,events:o,dag_yaml:e.user_yaml,entrypoint:e.entrypoint,git_commit:(null===(t=e.metadata)||void 0===t?void 0:t.git_commit)||"-",links:e.links||{},pool:e.pool,pool_hash:e.pool_hash,current_cluster_name:e.current_cluster_name,job_id_on_pool_cluster:e.job_id_on_pool_cluster,accelerators:e.accelerators,labels:e.labels||{}}}),total:C,totalNoFilter:k,controllerStopped:!1,statusCounts:x}}catch(e){throw console.error("Error fetching managed job data:",e),e}}async function u(e){let{allUsers:t=!0,nameMatch:r,userMatch:o,workspaceMatch:a,poolMatch:n,page:s=1,limit:l=10,jobIDs:c,fields:u,allFields:d=!1,useClientPagination:f=!0}=e||{};try{if(!f)return await i(e);let p=await i({allUsers:t,nameMatch:r,userMatch:o,workspaceMatch:a,poolMatch:n,jobIDs:c,fields:u,allFields:d});if(p.controllerStopped||!p.jobs)return p;let m=p.jobs,b=m.length,h=(s-1)*l;return{jobs:m.slice(h,h+l),total:b,controllerStopped:!1}}catch(e){throw console.error("Error fetching managed job data with client pagination:",e),e}}async function d(){try{let e=await l.x.post("/jobs/pool_status",{pool_names:null});if(!e.ok){let t="Initial API request to get pool status failed with status ".concat(e.status);throw Error(t)}let t=e.headers.get("X-Skypilot-Request-ID");if(!t)throw Error("No request ID received from server for getting pool status");let r=await l.x.get("/api/get?request_id=".concat(t)),o=r.statusText;if(500===r.status)try{let e=await r.json();if(e.detail&&e.detail.error)try{let t=JSON.parse(e.detail.error);if(t.type&&t.type===n.iW)return{pools:[],controllerStopped:!0};o=t.message||String(e.detail.error)}catch(t){console.error("Error parsing JSON from data.detail.error:",t),o=String(e.detail.error)}}catch(e){console.error("Error parsing response JSON:",e),o=String(e)}if(!r.ok){let e="API request to get pool status result failed with status ".concat(r.status,", error: ").concat(o);throw Error(e)}let a=await r.json(),c=a.return_value?JSON.parse(a.return_value):[],u={jobs:[]};try{let e=await s.ZP.get(i,[{allUsers:!0,skipFinished:!0,fields:["pool","status"]}]);e.controllerStopped||(u=e)}catch(e){console.warn("Failed to fetch jobs for pool job counts:",e)}let d={},f=["SUCCEEDED","FAILED","FAILED_SETUP","FAILED_PRECHECKS","FAILED_NO_RESOURCE","FAILED_CONTROLLER","CANCELLED"];return u.jobs&&Array.isArray(u.jobs)&&u.jobs.forEach(e=>{let t=e.pool,r=e.status;t&&!f.includes(r)&&(d[t]||(d[t]={}),d[t][r]=(d[t][r]||0)+1)}),{pools:c.map(e=>({...e,jobCounts:d[e.name]||{}})),controllerStopped:!1}}catch(e){throw console.error("Error fetching pools:",e),e}}function f(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,[r,a]=(0,o.useState)(null),[n,l]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{(async function(){if(e)try{var t;l(!0);let r=await s.ZP.get(i,[{allUsers:!0,allFields:!0,jobIDs:[e]}]),o=null==r?void 0:null===(t=r.jobs)||void 0===t?void 0:t.find(t=>String(t.id)===String(e));o?a({jobs:[o],controllerStopped:r.controllerStopped||!1}):a({jobs:[],controllerStopped:r.controllerStopped||!1})}catch(e){console.error("Error fetching single managed job data:",e),a({jobs:[],controllerStopped:!1})}finally{l(!1)}})()},[e,t]),{jobData:r,loading:n}}async function p(e){let t,{jobId:r,controller:o=!1,signal:n,onNewLog:s}=e,c=Date.now(),i=new Promise(e=>{let r=()=>{let o=Date.now()-c;o>=3e4?e({timeout:!0}):t=setTimeout(r,3e4-o)};t=setTimeout(r,3e4)}),u=(async()=>{try{let e=(await l.x.fetchImmediate("/jobs/logs",{controller:o,follow:!1,job_id:r,tail:5e3},"POST",{signal:n})).body.getReader();try{for(;;){let{done:t,value:r}=await e.read();if(t)break;c=Date.now();let o=new TextDecoder().decode(r);s(o)}}finally{if(!n||!n.aborted)try{e.cancel()}catch(e){"AbortError"!==e.name&&console.warn("Error canceling reader:",e)}t&&clearTimeout(t)}return{timeout:!1}}catch(e){if(t&&clearTimeout(t),"AbortError"===e.name)return{timeout:!1};throw e}})(),d=await Promise.race([u,i]);if(t&&clearTimeout(t),d.timeout){(0,a.C)("Log request for job ".concat(r," timed out after ").concat(30,"s of inactivity"),"warning");return}}async function m(e,t,r){let o="",s="",c="",i={};if("restartcontroller"===e)o="Restarting",s="restarted",c="jobs/queue/v2",i={all_users:!0,refresh:!0,skip_finished:!0,fields:["status"]},t="controller";else throw Error("Invalid action: ".concat(e));(0,a.C)("".concat(o," job ").concat(t,"..."),"info");try{try{let e=await l.x.fetchImmediate("/".concat(c),i);if(!e.ok){console.error("Initial API request ".concat(c," failed with status ").concat(e.status)),(0,a.C)("".concat(o," job ").concat(t," failed with status ").concat(e.status,"."),"error");return}let u=e.headers.get("X-Skypilot-Request-ID");if(!u){console.error("No request ID received from server for ".concat(c)),(0,a.C)("".concat(o," job ").concat(t," failed with no request ID."),"error");return}let d=await l.x.fetchImmediate("/api/get?request_id=".concat(u),void 0,"GET");if(200===d.status)(0,a.C)("Job ".concat(t," ").concat(s," successfully."),"success");else if(500===d.status)try{let e=await d.json();if(e.detail&&e.detail.error)try{let s=JSON.parse(e.detail.error);s.type&&s.type===n.Bo?(0,a.C)("".concat(o," job ").concat(t," is not supported!"),"error",1e4):s.type&&s.type===n.mF?(0,a.C)("Cluster ".concat(r," does not exist."),"error"):s.type&&s.type===n.iW?(0,a.C)("Cluster ".concat(r," is not up."),"error"):(0,a.C)("".concat(o," job ").concat(t," failed: ").concat(s.type),"error")}catch(r){(0,a.C)("".concat(o," job ").concat(t," failed: ").concat(e.detail.error),"error")}else(0,a.C)("".concat(o," job ").concat(t," failed with no details."),"error")}catch(e){(0,a.C)("".concat(o," job ").concat(t," failed with parse error."),"error")}else(0,a.C)("".concat(o," job ").concat(t," failed with status ").concat(d.status,"."),"error")}catch(e){console.error("Fetch error:",e),(0,a.C)("Network error ".concat(o," job ").concat(t,": ").concat(e.message),"error")}}catch(e){console.error("Error in handleStop:",e),(0,a.C)("Critical error ".concat(o," job ").concat(t,": ").concat(e.message),"error")}}async function b(e){let{jobId:t=null,name:r=null,controller:o=!1}=e;try{let e=await l.x.fetch("/jobs/download_logs",{job_id:t,name:r,controller:o,refresh:!1}),n=Object.values(e||{});if(!n.length){(0,a.C)("No logs found to download.","warning");return}let s=await l.x.fetchImmediate("/download?relative=items",{folder_paths:n});if(!s.ok){let e=await s.text();throw Error("Download failed: ".concat(s.status," ").concat(e))}let c=await s.blob(),i=window.URL.createObjectURL(c),u=document.createElement("a"),d=new Date().toISOString().replace(/[:.]/g,"-"),f=t?"job-".concat(t):r?"job-".concat(r):"job";u.href=i,u.download="managed-".concat(f,"-").concat(o?"controller-logs":"logs","-").concat(d,".zip"),document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(i)}catch(e){console.error("Error downloading managed job logs:",e),(0,a.C)("Error downloading managed job logs: ".concat(e.message),"error")}}},15821:function(e,t,r){r.d(t,{C:function(){return o}});function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3,o=document.getElementById("toast-container");o||((o=document.createElement("div")).id="toast-container",o.className="fixed top-0 right-0 p-4 z-[9999] flex flex-col items-end space-y-2",document.body.appendChild(o));let a=document.createElement("div");switch(a.className="rounded-md border-l-4 p-4 shadow-md flex items-center justify-between max-w-md w-full mb-2 pointer-events-auto",t){case"success":a.className+=" bg-green-100 border-green-500 text-green-800";break;case"error":a.className+=" bg-red-100 border-red-500 text-red-800";break;case"warning":a.className+=" bg-yellow-100 border-yellow-500 text-yellow-800";break;default:a.className+=" bg-blue-100 border-blue-500 text-blue-800"}return a.innerHTML='\n      <div class="flex-1 mr-2">\n        <p class="text-sm font-medium">'.concat(e,'</p>\n      </div>\n      <button class="text-gray-500 hover:text-gray-700 focus:outline-none" aria-label="Close toast">\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <line x1="18" y1="6" x2="6" y2="18"></line>\n          <line x1="6" y1="6" x2="18" y2="18"></line>\n        </svg>\n      </button>\n    '),o.appendChild(a),a.querySelector("button").addEventListener("click",()=>{o.removeChild(a)}),setTimeout(()=>{o.contains(a)&&o.removeChild(a)},r),a}}}]);