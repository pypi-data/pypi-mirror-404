<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindColors Pro v3.0</title>
    <script>
        (function () {
            // 立即检测系统主题
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = isDark ? 'dark' : 'light';

            // 在页面还没渲染 Body 之前，就给 html 加上主题属性
            document.documentElement.setAttribute('data-bs-theme', theme);

            // 预设背景色，防止内容加载延迟时的白底
            document.documentElement.style.backgroundColor = isDark ? '#212529' : '#ffffff';
        })();
    </script>
    <link href="../libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../libs/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --editor-bg: #1e1e1e;
            --panel-bg: #252526;
            --border-color: #333;
            --accent-color: #007acc;
            --input-bg: #3c3c3c;
            --text-main: #cccccc;
            --header-height: 34px;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 2px;
        }

        body,
        html {
            height: 100vh;
            margin: 0;
            font-size: 13px;
            overflow: hidden;
            background: var(--editor-bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .main-layout {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* 左右 50/50 比例 */
        .interaction-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            background: var(--panel-bg);
        }

        .code-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
        }

        .module-header {
            height: var(--header-height);
            padding: 0 12px;
            background: #2d2d2d;
            color: #888;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        /* 模块布局比例控制 */
        .color-list {
            flex: 0 0 auto;
            max-height: 38%;
            overflow-y: auto;
            padding: 6px;
            background: var(--editor-bg);
        }

        .config-area {
            flex: 0 0 auto;
            padding: 10px 12px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .results-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .results-list {
            flex: 1;
            overflow-y: auto;
            background: #1a1a1a;
        }

        /* 取色槽位条目优化 */
        .color-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            margin-bottom: 3px;
            border-radius: 4px;
        }

        .color-row.active {
            border-left: 3px solid var(--accent-color);
            background: #37373d;
        }

        .c-index {
            width: 12px;
            font-size: 11px;
            color: #569cd6;
            font-weight: bold;
        }

        .c-preview {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            flex-shrink: 0;
            border: 1px solid #555;
        }

        .c-hex {
            font-family: 'Consolas';
            font-size: 12px;
            color: #ce9178;
        }

        .c-pos {
            color: #858585;
            font-size: 11px;
        }

        /* 删除按钮：移至右侧并加大 */
        .btn-del-row {
            margin-left: auto;
            cursor: pointer;
            color: #666;
            font-size: 16px;
            /* 增大图标 */
            transition: color 0.2s;
            display: flex;
            align-items: center;
        }

        .btn-del-row:hover {
            color: #f44336;
        }

        /* 配置项强制单行对齐 */
        .config-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .config-label {
            flex: 0 0 70px;
            color: #bbb;
            font-size: 12px;
            white-space: nowrap;
        }

        .config-control-wrap {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .input-group-custom {
            display: flex !important;
            flex-wrap: nowrap !important;
            width: 100%;
        }

        .form-control-vs {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid #454545;
            color: #eee;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 3px;
        }

        /* 结果与代码显示 */
        .res-item {
            padding: 5px 12px;
            border-bottom: 1px solid #222;
            font-family: 'Consolas';
            font-size: 11px;
            color: #9cdcfe;
        }

        .code-display {
            flex: 1;
            padding: 15px;
            font-family: 'Consolas', monospace;
            color: #d4d4d4;
            font-size: 13px;
            line-height: 1.5;
            overflow-y: auto;
            white-space: pre-wrap !important;
            word-break: break-all !important;
        }

        .btn-del-mini {
            cursor: pointer;
            color: #555;
        }

        .btn-del-mini:hover {
            color: #f44336;
        }

        /* 列表项基础样式 */
        .res-item {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        /* 鼠标覆盖时的样式：变亮并有左侧边框提示 */
        .res-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid #0d6efd;
            /* 蓝色条 */
            padding-left: 9px;
            /* 抵消边框宽度，防止文字跳动 */
        }

        /* 序号样式 */
        .res-item .label-tag {
            background: rgba(13, 110, 253, 0.2);
            color: #0d6efd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            min-width: 35px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="main-layout">
        <div class="interaction-panel">
            <div class="module-header">
                <span>取色数据槽位 (1-0)</span>
                <i class="bi bi-trash-fill btn-del-mini" onclick="clearAllSlots()" title="清空全部"></i>
            </div>
            <div class="color-list" id="slot-container"></div>

            <div class="module-header">配置参数</div>
            <div class="config-area">
                <div class="config-item">
                    <span class="config-label">搜索范围</span>
                    <div class="config-control-wrap">
                        <div class="input-group-custom">
                            <input type="text" id="input-rect" class="form-control-vs" readonly placeholder="全屏模式"
                                style="border-top-right-radius:0; border-bottom-right-radius:0;">
                            <button class="btn btn-dark btn-sm border-secondary"
                                style="border-top-left-radius:0; border-bottom-left-radius:0;" onclick="clearRect()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="config-item">
                    <span class="config-label">相似阈值</span>
                    <div class="config-control-wrap">
                        <input type="number" id="threshold" class="form-control-vs" value="0.95" step="0.05">
                    </div>
                </div>

                <div class="config-item">
                    <span class="config-label">排它间隔</span>
                    <div class="config-control-wrap">
                        <input type="number" id="exclusion_radius" class="form-control-vs" value="5" step="1">
                    </div>
                </div>

                <div class="config-item">
                    <span class="config-label">查找方向</span>
                    <div class="config-control-wrap">
                        <select id="select-ori" class="form-control-vs">
                            <option value="2">左上 → 右下 (垂直优先)</option>
                            <option value="1">左上 → 右下 (水平优先)</option>
                            <option value="3">右上 → 左下 (水平优先)</option>
                            <option value="4">右上 → 左下 (垂直优先)</option>
                            <option value="5">左下 → 右上 (垂直优先)</option>
                            <option value="6">左下 → 右上 (水平优先)</option>
                            <option value="7">右下 → 左上 (水平优先)</option>
                            <option value="8">右下 → 左上 (垂直优先)</option>
                        </select>
                    </div>
                </div>

                <div class="config-item">
                    <span class="config-label">查找多个</span>
                    <div class="ms-auto">
                        <div class="form-check form-switch m-0 p-0">
                            <input class="form-check-input" type="checkbox" id="check-multi" checked
                                style="cursor: pointer;">
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary btn-sm w-100 mt-1 py-2" id="btn-test" onclick="runTest()">
                    <span id="btn-content"><i class="bi bi-play-fill me-1"></i> 执行测试找色</span>
                </button>
            </div>

            <div class="results-panel">
                <div class="module-header">
                    <div>找色结果 <span class="badge bg-dark ms-1" id="res-count">0</span></div>
                    <i class="bi bi-trash-fill btn-del-mini" onclick="clearResults()" title="清空结果"></i>
                </div>
                <div class="results-list" id="res-list">
                    <div class="text-center opacity-25 mt-4 small">等待运行测试...</div>
                </div>
            </div>
        </div>

        <div class="code-panel">
            <div class="module-header">
                <span>PYTHON 脚本预览</span>
                <button id="copy_code" class="btn btn-dark btn-sm border-secondary text-secondary py-0"
                    style="font-size: 10px;" onclick="copyCode()">
                    <i class="bi bi-clipboard me-1"></i> COPY
                </button>
            </div>
            <div class="code-display" id="code-box"></div>
        </div>
    </div>

    <script src="../libs/jquery/jquery.min.js"></script>
    <script>
        let colorPoints = {};
        let currentRect = null;

        function initSlots() {
            const container = $('#slot-container');
            for (let i = 1; i <= 10; i++) {
                let k = i === 10 ? "0" : i.toString();
                container.append(`
                <div class="color-row" id="row-${k}">
                    <span class="c-index">${k}</span>
                    <div class="c-preview" id="pre-${k}"></div>
                    <span class="c-hex" id="hex-${k}">--</span>
                    <span class="c-pos" id="pos-${k}">--</span>
                    <i class="bi bi-x btn-del-row" onclick="clearSlot('${k}')" title="移除此项"></i>
                </div>`);
            }
        }

        async function runTest() {

            const keys = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"];
            let colorStrings = [];
            keys.forEach(k => { if (colorPoints[k]) colorStrings.push(`${colorPoints[k].x},${colorPoints[k].y},${colorPoints[k].hex}`); });
            if (colorStrings.length < 3) {
                window.parent.gp.info.error("取色数量不足3个", "请保证至少3个点位的取色 (推荐5个以上)，以提高找色准确度！");
                return;
            }

            const btn = $('#btn-test');
            const content = $('#btn-content');
            const resList = $('#res-list');
            const resCount = $('#res-count');

            // 1. 进入加载状态
            btn.prop('disabled', true);
            content.html('<span class="spinner-border spinner-border-sm me-2"></span>执行中...');

            const startTime = Date.now();

            try {
                // 2. 调用找色接口获取二维数组结果
                // 假设返回格式为: [[x1, y1], [x2, y2], ...]
                resList.empty();
                window.parent.gp.marks.clear()
                const res = await genTest();
                console.log("找色结果:", res);

                // 3. 计算耗时，确保动画平滑（至少展示 300ms）
                const elapsedTime = Date.now() - startTime;
                const delay = Math.max(0, 200 - elapsedTime);

                setTimeout(() => {
                    // 4. 清空旧结果并恢复按钮

                    btn.prop('disabled', false);
                    content.html('<i class="bi bi-play-fill me-1"></i> 执行测试找色');

                    // 5. 处理结果数组
                    if (res && res.length > 0) {
                        resCount.text(res.length); // 更新计数

                        // 遍历二维数组渲染条目
                        // 遍历二维数组渲染条目
                        res.forEach((point, index) => {
                            const x = point[0];
                            const y = point[1];
                            const mark_label = `#${index}`;

                            // 添加标记到地图
                            window.parent.gp.marks.add_point(mark_label, x, y);

                            // 生成更干净的列表项
                            const itemHtml = `
        <div class="res-item" 
             onmouseenter="window.parent.gp.marks.high_light('${mark_label}')" 
             onmouseleave="window.parent.gp.marks.high_light_clear()">
            <span class="label-tag me-2">${mark_label}</span>
            <div class="flex-grow-1">
                <span class="text-white-50 small">X:</span> <strong>${x}</strong>
                <span class="text-white-50 small ms-2">Y:</span> <strong>${y}</strong>
            </div>
            <i class="bi bi-chevron-right opacity-25"></i>
        </div>
    `;
                            resList.append(itemHtml);
                        });
                    } else {
                        // 无结果显示
                        resCount.text('0');
                        resList.append('<div class="text-center opacity-25 mt-4 small">未找到匹配颜色</div>');
                    }
                }, delay);

            } catch (error) {
                // 错误处理
                console.error("测试运行失败:", error);
                btn.prop('disabled', false);
                content.html('<i class="bi bi-exclamation-triangle me-1"></i> 运行出错');
                resList.html('<div class="text-center text-danger mt-4 small">接口调用异常</div>');
            }
        }

        function genCode() {
            const keys = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"];
            let colorStrings = [];
            keys.forEach(k => { if (colorPoints[k]) colorStrings.push(`${colorPoints[k].x},${colorPoints[k].y},${colorPoints[k].hex}`); });
            if (colorStrings.length < 3) { $('#code-box').html("<span style='color:#6a9955'># 请至少取3个点的颜色...</span>"); return; }

            let config = getConfigValues();
            let rect_line = "";
            let threshold = "";
            let ori_line = config.ori == 2 ? "" : `, ori=${config.ori}`;
            let exclusion_radius_line = config.exclusion_radius != 5 ? `, exclusion_radius=${config.exclusion_radius}` : "";
            if (!config.isFullScreen) {
                rect_line = `,rect=${config.rect}`;
            }

            if (config.threshold != 0.95) {
                threshold = `,threshold=${config.threshold}`;
            }

            const pythonCode = `from ascript.windows.screen import FindColors
FindColors.${$('#check-multi').is(':checked') ? "find_all" : "find"}("${colorStrings.join('|')}"${rect_line}${threshold}${ori_line}${exclusion_radius_line})
            `;
            // const codeText = `from ascript.windows.screen import FindColors\n\nresults = FindColors.${$('#check-multi').is(':checked') ? "find_all" : "find"}(\n    colors="${colorStrings.join('|')}",\n    rect=${currentRect ? `[${currentRect.l}, ${currentRect.t}, ${currentRect.r}, ${currentRect.b}]` : "None"},\n    threshold=${$('#threshold').val()},\n    ori=${$('#select-ori').val()}\n)`;
            $('#code-box').text(pythonCode);
        }

        async function genTest() {
            const keys = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"];
            let colorStrings = [];
            keys.forEach(k => { if (colorPoints[k]) colorStrings.push(`${colorPoints[k].x},${colorPoints[k].y},${colorPoints[k].hex}`); });
            if (colorStrings.length === 0) { $('#code-box').html("<span style='color:#6a9955'># 请先取色...</span>"); return; }

            let config = getConfigValues();
            let rect_line = "";
            let threshold = "";
            let ori_line = config.ori == 2 ? "" : `, ori=${config.ori}`;
            let exclusion_radius_line = config.exclusion_radius != 5 ? `, exclusion_radius=${config.exclusion_radius}` : "";
            let im_source_line = `, im_source=r"${window.parent.gp.image.path}"`;
            let max_res_line = $('#check-multi').is(':checked') ? "" : ",max_res=1";
            if (!config.isFullScreen) {
                rect_line = `,rect=${config.rect}`;
            }

            if (config.threshold != 0.95) {
                threshold = `,threshold=${config.threshold}`;
            }

            const pythonCode = `from ascript.windows.screen import FindColors
_result =FindColors.find_all("${colorStrings.join('|')}"${rect_line}${threshold}${ori_line}${im_source_line}${exclusion_radius_line}${max_res_line})`;
            return await window.parent.gp.call_python(pythonCode);
        }

        function updateSlotUI(key) {
            const d = colorPoints[key];
            const row = $(`#row-${key}`);
            if (d) {
                row.addClass('active');
                $(`#pre-${key}`).css('background', d.hex);
                $(`#hex-${key}`).text(d.hex.toUpperCase());
                $(`#pos-${key}`).text(`${d.x},${d.y}`);
            } else {
                row.removeClass('active');
                $(`#pre-${key}`).css('background', 'transparent');
                $(`#hex-${key}`).text('--');
                $(`#pos-${key}`).text('--');
            }
        }

        /**
 * 获取当前界面的所有配置参数
 * @returns {Object} 包含所有参数的对象
 */
        function getConfigValues() {
            // 1. 判断是全屏还是范围
            // 获取输入框的值
            const rectValue = $('#input-rect').val().trim();

            let finalRect = null;
            if (rectValue && rectValue !== "" && rectValue !== "全屏模式") {
                // 如果有值，说明用户选择了范围
                // 假设 input-rect 的值格式是 "100,200,500,600"
                // 转换成 Python 数组格式 [l, t, r, b]
                finalRect = `[${rectValue}]`;
            } else {
                // 如果值为空，则是全屏模式
                finalRect = "None";
            }

            // 2. 获取其他基础参数
            const config = {
                isFullScreen: finalRect === "None", // 布尔值判断：是否为全屏
                rect: finalRect,                    // 字符串：用于生成代码的 rect 参数
                threshold: parseFloat($('#threshold').val()) || 0.9, // 匹配阈值
                exclusion_radius: parseInt($('#exclusion_radius').val()) || 5, // 排他间隔
                ori: parseInt($('#select-ori').val()),              // 找色方向
                isMulti: $('#check-multi').is(':checked'),          // 是否查找多个
            };

            return config;
        }

        window.on_color_picked = (d) => { colorPoints[d.key] = { x: d.pos[0], y: d.pos[1], hex: d.color }; updateSlotUI(d.key); genCode(); };
        window.on_area_selected = (d) => { if (d && (d.l + d.r !== 0)) { currentRect = d; $('#input-rect').val(`${d.l},${d.t},${d.r},${d.b}`); } else { currentRect = null; $('#input-rect').val(''); } genCode(); };
        function clearSlot(key) { delete colorPoints[key]; updateSlotUI(key); genCode(); }
        function clearAllSlots() { colorPoints = {};["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"].forEach(updateSlotUI); genCode(); }
        function clearRect() { currentRect = null; $('#input-rect').val(''); genCode(); }
        function clearResults() {
            $('#res-list').empty().append('<div class="text-center opacity-25 mt-4 small">已清空</div>'); $('#res-count').text('0');
            window.parent.gp.marks.clear();
        }
        function copyCode() {
            navigator.clipboard.writeText($('#code-box').text());
            const $btn = $("#copy_code");
            $btn.html('<i class="bi bi-check text-success"></i> Copied');
            setTimeout(() => $btn.html('<i class="bi bi-files me-1"></i>Copy'), 1500);
            window.parent.gp.info.noti("代码已复制到剪贴板");
        }

        $(document).ready(() => {
            initSlots(); genCode(); $('input, select, .form-check-input').on('change input', genCode);
            window.parent.gp.iframe.on_rect();
        });

        // 在 iframe 内部的代码中添加
        $(document).on('keydown', (e) => {
            // --- 新增：判定是否正在输入 ---
            const target = e.target;
            const isInput = target.tagName === 'INPUT' ||
                target.tagName === 'TEXTAREA' ||
                target.isContentEditable;

            // 如果正在输入，直接返回，不执行转发逻辑
            if (isInput) return;

            // --- 原有转发逻辑 ---
            if (e.key >= '0' && e.key <= '9') {
                if (window.parent && typeof window.parent.dispatchEvent === 'function') {
                    const clonedEvent = new KeyboardEvent('keydown', {
                        key: e.key,
                        code: e.code,
                        ctrlKey: e.ctrlKey,   // 建议加上，确保 Ctrl+数字 也能正确识别
                        shiftKey: e.shiftKey,
                        altKey: e.altKey,
                        bubbles: true
                    });
                    window.parent.dispatchEvent(clonedEvent);
                }
            }
        });
    </script>
</body>

</html>