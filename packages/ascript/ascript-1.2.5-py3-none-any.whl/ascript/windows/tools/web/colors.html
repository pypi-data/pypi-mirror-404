<!doctype html>
<html lang="zh-CN" data-bs-theme="auto">

<head>
  <!-- 必须的 meta 标签 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="description" content="">
  <meta name="author" content="Webpixels">

  <link rel="icon" href="./img/ico/paintpalette.png" type="image/png"><!-- Font Awesome -->

  <!-- Bootstrap 的 CSS 文件 -->
  <link rel="stylesheet" href="./libs/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/screen.css" crossorigin="anonymous">
  <link rel="stylesheet" href="./libs/bootstrap-icons/font/bootstrap-icons.css">

  <script src="./libs/jquery/jquery.js"></script>
  <script src="./libs/bootstrap/js/bootstrap.bundle.min.js"></script>
  <link href="./libs/jquery-menu/jquery.contextMenu.min.css" rel="stylesheet" type="text/css">

  <title>图形处理 AScript</title>
  <script>
    (function () {
      // 立即检测系统主题
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = isDark ? 'dark' : 'light';

      // 在页面还没渲染 Body 之前，就给 html 加上主题属性
      document.documentElement.setAttribute('data-bs-theme', theme);

      // 预设背景色，防止内容加载延迟时的白底
      document.documentElement.style.backgroundColor = isDark ? '#212529' : '#ffffff';
    })();
  </script>
</head>

<body class="mycontainer" style="padding: 0px; margin: 0px; overflow: hidden;">

  <canvas id="preview_img_canvas" crossOrigin="anonymous" style="display: none"></canvas>
  <input type="file" id="fileupload" accept-charset="utf-8" name="avatar" hidden>

  <div id="dropdownBackdrop" class="dropdown-backdrop-custom"></div>



  <!-- 模板 -->

  <template id="image_list_item_template">
    <div class="col-6 col-md-4 col-lg-3 screen-img-item-wrapper">
      <div class="img-card shadow-sm">
        <img class="img-content" loading="lazy"
          src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        <div class="img-name text-truncate"></div>
        <button class="btn-del btn btn-danger btn-sm" title="删除图片">
          <i class="bi bi-trash3"></i>
        </button>
      </div>
    </div>
  </template>

  <!-- 调试工具模态框 -->
  <div class="modal fade" id="addDebugModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title fs-6"><i class="bi bi-tools me-2"></i>添加本地调试工具</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label small text-secondary">调试工具名称</label>
            <input type="text" id="dbg_name" class="form-control form-control-sm bg-secondary text-white border-0"
              placeholder="例如：图片查看器">
          </div>
          <div class="mb-3">
            <label class="form-label small text-secondary">资源根目录 (物理绝对路径)</label>
            <div class="input-group input-group-sm">
              <input type="text" id="dbg_root" class="form-control bg-secondary text-white border-0"
                placeholder="请选择或输入路径...">
              <button class="btn btn-primary" type="button" onclick="handleSelectFolder()">
                <i class="bi bi-folder2-open"></i> 浏览
              </button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label small text-secondary">调试文件相对路径</label>
            <input type="text" id="dbg_file" class="form-control form-control-sm bg-secondary text-white border-0"
              placeholder="index.html">
            <div class="form-text x-small text-muted">基于根目录的 HTML 入口文件</div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-sm btn-primary" onclick="handleSaveDebugPlug()">确定添加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 错误模态框 -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body p-0">
          <div class="code-window shadow-lg">
            <div class="code-header d-flex align-items-center px-3 justify-content-between">
              <div class="d-flex align-items-center">
                <div class="code-dots d-flex gap-1 me-3">
                  <span class="dot red" data-bs-dismiss="modal" style="cursor:pointer;"></span>
                  <!-- <span class="dot yellow"></span> -->
                  <!-- <span class="dot green"></span> -->
                </div>
                <div id="codeWindowTitle" class="text-secondary font-monospace"
                  style="font-size: 0.75rem; letter-spacing: 0.5px;">
                  TERMINAL — ERROR
                </div>
              </div>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                style="font-size: 0.6rem; opacity: 0.5;"></button>
            </div>
            <div class="code-content">
              <pre id="errorModalMsg"></pre>
            </div>
            <div class="code-footer d-flex justify-content-end px-3 py-2">
              <button class="btn btn-link btn-sm text-secondary text-decoration-none p-0" onclick="copyTraceback()"
                style="font-size: 0.7rem;">COPY</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div id="mouse_hud" class="mouse-hud" style="display: none;">
    <span class="hud-coords" id="hud_coords">0, 0</span>
    <span class="hud-divider"></span>
    <div id="hud_color_swatch" class="hud-swatch"></div>
    <span class="hud-hex font-monospace" id="hud_hex">#FFFFFF</span>
  </div>

  <!-- d-none -->
  <div id="imageGallery" class="gallery-fullscreen-panel shadow-lg border-start d-none">
    <div class="gallery-header d-flex align-items-center justify-content-between p-2 bg-body-tertiary border-bottom">
      <div class="d-flex align-items-center overflow-hidden">
        <button
          class="btn btn-sm btn-outline-secondary d-flex align-items-center p-1 me-3 border-0 shadow-none hover-close-btn"
          onclick="closeGallery()" title="关闭 (Esc)">
          <div class="d-flex align-items-center bg-body-secondary rounded px-1 me-1"
            style="font-size: 9px; height: 16px; border: 1px solid var(--bs-border-color);">
            ESC
          </div>
          <i class="bi bi-x-lg" style="font-size: 14px;"></i>
        </button>
        <nav aria-label="breadcrumb" class="text-truncate">
          <ol class="breadcrumb mb-0" style="font-size: 0.8rem;">
            <li class="breadcrumb-item"><a href="#" id="cache_imgs_path">Cache</a></li>
          </ol>
        </nav>
      </div>
      <div class="d-flex gap-2">
        <span class="imglist_size badge rounded-pill border text-body-secondary fw-normal">-</span>
        <button id="toolbar_img_delall" class="btn btn-outline-danger btn-sm px-2 py-0 d-flex align-items-center"
          style="font-size: 11px; height: 24px;">
          <span id="delall_text">清空</span>

          <div id="delall_spinner" class="spinner-border spinner-border-sm ms-1" role="status"
            style="display: none; width: 10px; height: 10px; border-width: 2px;">
            <span class="visually-hidden">Loading...</span>
          </div>
        </button>
      </div>
    </div>

    <div class="screen-img-list row g-2 m-0 p-2 overflow-y-auto align-content-start">
    </div>
  </div>

  <div class="row screen-container">

    <div class="screen-img-bar">

      <span id="toolbar" class="" data-toggle="tooltip" data-placement="right" title="窗口">
        <i class="bi bi-window"></i>
      </span>


      <span class="screen-img-bar-item col-auto d-flex" style="position: relative;" onclick="capture_window_image()"
        data-toggle="tooltip" data-placement="right" title="截图[shift+s]">
        <i id="capture_icon" class="bi bi-camera"></i>

        <span id="imagelist_loading" class="d-none"
          style="padding: 0; margin: 0px; position: absolute; width: 100%; height: 100%; left: 0; top: 0; background-color: rgba(239, 239, 239, 0.8); display: flex; align-items: center; justify-content: center;"
          role="status">
          <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
        </span>
      </span>

      <span id="toolbar_img_upload" class="screen-img-bar-item col-auto" data-toggle="tooltip" data-placement="right"
        title="上传图片">
        <i class="bi bi-upload"></i>
      </span>

      <span id="toolbar_zoom_reset" class="screen-img-bar-item col-auto" onclick="window.resetViewToFit(10)"
        data-toggle="tooltip" data-placement="right" title="重置">
        <i class="bi bi-arrow-repeat"></i>
      </span>

      <span class="screen-img-bar-item col-auto" data-toggle="tooltip" data-placement="right"
        onclick="window.gp.marks.clear()" title="清空标注">
        <i class="bi bi-slash-square"></i>
      </span>

    </div>
    <div class="screen-img-container" style="width: 35vw; position: relative;">
      <div class="screen-img-statue w-100 d-flex align-items-center justify-content-between py-1" style="height: 38px;">

        <div class="d-flex align-items-center position-relative" style="left: -40px;">
          <div class="dropdown">
            <button id="windowSelector"
              class="btn btn-outline-secondary btn-sm dropdown-toggle d-flex align-items-center" type="button"
              data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 0.85rem; border: 1px solid #dee2e6;">
              <i class="bi bi-window me-2"></i> <span id="windowSelector_content">全屏截图</span>
            </button>
            <ul id="windowList" class="dropdown-menu shadow">
              <li>
                <a class="dropdown-item active window-item-link" href="javascript:void(0)" data-hwnd="null"
                  data-display="全屏截图" onclick="selectWindow('全屏截图', null, null)">
                  <span class="win-title-text">全屏截图</span>
                  <span class="win-hwnd-num">Default</span>
                </a>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
            </ul>
          </div>
          <span id="header_pixels" class="text-body-secondary ms-3" style="font-size: 0.75rem;">0 x 0</span>
        </div>

        <div class="d-flex align-items-center">
          <button class="btn btn-sm p-0 border-0 shadow-none text-body-secondary history-btn" onclick="openGallery()"
            title="查看历史图片" data-bs-toggle="tooltip" data-bs-placement="bottom">
            <i class="bi bi-images" style="font-size: 1.1rem;"></i>
          </button>
        </div>

      </div>


      <div class="screen-img-con">
        <div id="container_img" class="screen-img-shower col-12"
          style="position: relative; overflow: hidden; cursor: crosshair;">
          <div id="transform_container" style="position: absolute; transform-origin: 0 0; will-change: transform;">

            <img id="img_preview" crossorigin="anonymous"
              style="image-rendering: pixelated; display: block; user-select: none; -webkit-user-drag: none;">

            <svg id="svg_layer"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: visible;">
              <g id="mark_points_layer"></g>
              <g id="mark_rects_layer"></g>

              <g id="selection_group" style="visibility: hidden;">
                <rect id="selection_rect" fill="rgba(var(--bs-primary-rgb), 0.1)" stroke="var(--bs-primary)"
                  stroke-width="2" style="cursor: move;"></rect>
                <circle class="handle" id="h_nw" style="cursor: nwse-resize;"></circle>
                <circle class="handle" id="h_n" style="cursor: ns-resize;"></circle>
                <circle class="handle" id="h_ne" style="cursor: nesw-resize;"></circle>
                <circle class="handle" id="h_e" style="cursor: ew-resize;"></circle>
                <circle class="handle" id="h_se" style="cursor: nwse-resize;"></circle>
                <circle class="handle" id="h_s" style="cursor: ns-resize;"></circle>
                <circle class="handle" id="h_sw" style="cursor: nesw-resize;"></circle>
                <circle class="handle" id="h_w" style="cursor: ew-resize;"></circle>
              </g>
            </svg>
          </div>

          <div class="info-group">
            <div id="info_selection_box" class="info-panel mb-2" style="display: none;">
              <div class="info-header mb-1">
                <i class="bi bi-selection-all me-1"></i>选区范围
              </div>
              <div class="info-row">
                <span class="info-label">位置</span>
                <span class="info-value" id="sel_start">0, 0</span>
              </div>
              <div class="info-row">
                <span class="info-label">尺寸</span>
                <span class="info-value text-primary" id="sel_size">0 × 0</span>
              </div>
            </div>

            <!-- <div class="info-panel">
              <div class="info-row">
                <span class="info-label"><i class="bi bi-cursor-fill me-1"></i>坐标</span>
                <span class="info-value" id="live_coords">0, 0</span>
              </div>
              <div class="info-row">
                <span class="info-label"><i class="bi bi-droplet-fill me-1"></i>颜色</span>
                <div class="d-flex align-items-center gap-2">
                  <div id="live_color_swatch" class="color-swatch"></div>
                  <span class="info-value text-uppercase font-monospace" id="live_hex">#FFFFFF</span>
                </div>
              </div>
            </div> -->
          </div>



          <div class="interaction-hints d-flex gap-3 px-3 py-2">
            <div class="hint-item">
              <i class="bi bi-mouse2"></i> <span>滚轮缩放</span>
            </div>
            <div class="hint-item">
              <i class="bi bi-mouse3-fill"></i> <span>右键平移</span>
            </div>
            <div class="hint-item">
              <kbd>0-9</kbd> <span>快速取色</span>
            </div>
          </div>

          <canvas id="color_picker_canvas" style="display:none;"></canvas>
        </div>


        <div class="touch_slide"></div>
      </div>
    </div>

    <div class="col-2 border-end bg-body-tertiary" style="height: 100%; padding: 0px; margin: 0px;">
      <div class="plug-list-con d-flex flex-column h-100">

        <div class="p-2 d-flex align-items-center justify-content-between border-bottom border-secondary-subtle mb-2">
          <span class="d-flex align-items-center">
            <i class="bi bi-ui-checks-grid me-2 text-primary" style="font-size: 14px;"></i>
            <span class="fw-bold text-secondary-emphasis"
              style="font-size: 12px; letter-spacing: 0.5px; text-transform: uppercase;">插件中心</span>
            <div id="plug-loading" class="spinner-border spinner-border-sm text-primary ms-2"
              style="display:none; --bs-spinner-width: 0.75rem; --bs-spinner-height: 0.75rem;">
            </div>
          </span>

          <div class="d-flex align-items-center">
            <button class="btn btn-icon-vscode" onclick="promptAddDebugPlug()" title="添加本地调试插件">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>

        <div class="flex-grow-1 overflow-y-auto px-2">

          <div>
            <div class="flex-grow-1 overflow-y-auto">
              <div id="debug_group_wrapper" style="display: none;" class="mb-2">
                <div class="d-flex align-items-center justify-content-between p-2 rounded-2 text-secondary hover-bg"
                  style="cursor: pointer; font-size: 12px; letter-spacing: 1px;" data-bs-toggle="collapse"
                  data-bs-target="#debug-collapse">
                  <div>
                    <span class="fw-bold">调试工具</span>
                    <i class="bi bi-plus-circle-fill ms-2 text-primary opacity-75" title="添加调试地址"
                      onclick="event.stopPropagation(); promptAddDebugPlug();"></i>
                  </div>
                  <i class="bi bi-chevron-down opacity-50"></i>
                </div>
                <div class="collapse show" id="debug-collapse">
                  <ul id="group_plug_debug" class="list-unstyled mt-1">
                  </ul>
                </div>
              </div>

              <div class="mb-2">
              </div>

            </div>
          </div>

          <div class="mb-2">
            <div class="d-flex align-items-center justify-content-between p-2 rounded-2 text-secondary hover-bg"
              style="cursor: pointer; font-size: 12px; letter-spacing: 1px;" data-bs-toggle="collapse"
              data-bs-target="#sys-collapse">
              <span class="fw-bold">系统工具</span>
              <i class="bi bi-chevron-down opacity-50"></i>
            </div>
            <div class="collapse show" id="sys-collapse">
              <ul id="group_plug_system" class="list-unstyled mt-1">
              </ul>
            </div>
          </div>

          <div style="display: none;">
            <div class="d-flex align-items-center justify-content-between p-2 rounded-2 text-secondary hover-bg"
              style="cursor: pointer; font-size: 12px; letter-spacing: 1px;" data-bs-toggle="collapse"
              data-bs-target="#cloud-collapse">
              <span class="fw-bold">云端插件</span>
              <i class="bi bi-chevron-down opacity-50"></i>
            </div>
            <div class="collapse show" id="cloud-collapse">
              <ul id="cloud-group" class="list-unstyled mt-1">
              </ul>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="col control-borad d-flex flex-column" style="height: 100vh;">
      <iframe id="gpiframe" style="width: 100%; height: 100%; border: none;" scrolling="auto"> </iframe>
    </div>

    <div id="as_toast" class="position-fixed bottom-0 right-0 p-3" style="z-index: 5; right: 0; bottom: 0;">
      <div id="liveToast" class="toast hide" style="min-width: 20vw;" role="alert" aria-live="assertive"
        aria-atomic="true" data-delay="2000">
        <div class="toast-header">
          <img src="../assets/img/mipmap/ico_tip.png" style="width: 20px;" class="rounded mr-2" alt="...">
          <strong class="mr-auto">消息提示</strong>
          <small></small>
          <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div id="as_toast_msg" class="toast-body text-success" style="background-color: #FAfAfA;">

        </div>
      </div>
    </div>


    <!-- 这里是 所有条目的 模版 -->


    <div id="hidden_con" style="display: none;">

      <li id="gp_line_list_item" class="gp_line_list_item row col-12 mt-1 pt-2"
        style="padding: 0px; margin: 0px; background-color: white;">
        <div class="row col-12" style=" margin: 0px;">
          <span class="col-3 text-primary gp_id" style="font-size: large;">id:1.1.1</span>
          <span class="col-3 "><i class="bi bi-person"></i><span class="gp_author text-black-50"></span></span>
          <span class="col-3 mr-auto"><i class="bi bi-fire text-danger"></i><span
              class="text-black-50 gp_hot"></span></span>
          <span class="col-auto gp_load">
            <div class="btn-group" role="group" aria-label="Basic example">
              <button type="button" class="btn btn-secondary gp_info">详情</button>
              <button type="button" class="btn btn-success gp_add">加载</button>
            </div>
          </span>
        </div>
        <div class="gp_line_childs" style="margin: 0px; width: 100%;">

        </div>
      </li>

      <div id="gp_line_list_item_child" class="gp_line_list_item_child"><span class="gp_line_id text-info">123</span>
        <span class="gp_line_des ml-2 text-secondary">123</span>
      </div>

      <img id="image_list_item" class="screen-img-list-item ml-2" data-toggle="tooltip" data-placement="top" title="">

      <div id="mark-point-item" class="mark-point-item shadow" style="">
        <span class="mark-point badge badge-danger shadow" style="border-radius: 20px;">·</span>
        <span class="badge mark-point-des"><span class="mark-points-number badge badge-pill badge-warning">2</span><span
            class="mark-points-xy ml-1">23,400</span></span>
      </div>

      <div id="mark-rect-item" class="mark-rect-item shadow-lg">
        <span class="badge badge-danger mark-rect-number">1</span>
      </div>

      <li id="coder-board-body-item" class="row col-12 coder-board-body-item">
        <span class="row col-4 d-flex align-items-center coder-board-body-item-left">
          <span class="ml-1 coder-board-body-item-left-ico d-flex align-items-center"><i
              class="bi bi-arrow-down"></i></span>
          <span class="ml-3 mr-auto item-name">图片裁剪</span>
          <span class="mr-3 d-flex align-items-center" style="padding: 0px; margin: 0px;">
            <span id="coder-board-body-item_fix" class="mr-3 item_action"><i class="bi bi-wrench"></i></span>
            <span id="coder-board-body-item_delect" class="item_action mr-3"><i class="bi bi-x-circle-fill"></i></span>
          </span>
        </span>
        <span class="row col-8 d-flex align-items-center coder-board-body-item-right">
          <span class="ml-2 item-code">action.add(<code>GPCrop(1,1,100,100)</code>)</span>
        </span>
      </li>
    </div>

  </div>

  <div
    class="container_bottombar d-flex align-items-center justify-content-between px-2 bg-body-tertiary border-top text-body-secondary"
    style="height: 26px; font-size: 11px; cursor: default;">

    <div class="d-flex align-items-center overflow-hidden" style="max-width: 70%;">
      <i class="bi-file-earmark-image me-1"></i>
      <span id="status_file_path" class="text-truncate">未加载文件</span>
    </div>

    <div class="d-flex align-items-center ps-3 border-start border-secondary-subtle">
      <i id="status_dot" class="bi bi-dot text-primary" style="font-size: 20px; display: none; line-height: 0;"></i>
      <span id="status_notification" class="text-nowrap text-body-secondary">就绪</span>
    </div>
  </div>

  <div class="zoomContainer"
    style="-webkit-transform: translateZ(0);position:absolute; display: none; pointer-events: none; ">
    <div class="zoomWindowContainer" style="height: 180px;">
      <div
        style="overflow: hidden; background-position: 200px 200px; text-align: center; background-color:   rgb(255, 255, 255); width: 160px; height: 160px; float: left;  z-index: 100;  background-repeat: no-repeat; position: absolute; margin-top: 30px;"
        class="zoomWindow shadow-lg">
        <div class="zoomWindow_lines">
          <div class="shadow-info-sm" style="background-color: red; width: 100%;height: 1px;"></div>
          <div class="shadow-info-sm" style="background-color: red; position: absolute; height: 100%;width: 1px;">
          </div>
          <span
            style="width: 3px; height: 3px;position: absolute; background-color: transparent; border-radius: 20px; border: white solid 1px;"></span>
        </div>
      </div>
      <div style="margin-top: -10px;">
        <span class=" shadow-lg small"
          style="border-radius: 5px; background-color: rgba(255, 255, 255, 0.5); padding:1px">
          <i class="bi bi-mouse toolbar_img_delall-mousecolor mr-1"></i>
          <span id="header_cur_rgb">#efefef</span>
          <span id="header_cur_xy" class="ml-1"></span>

        </span>
      </div>
    </div>
  </div>


  <script src="/eel.js" type="text/javascript"></script>
  <script src="./libs/jquery-menu/jquery.contextMenu.js"></script>
  <script src="./js/screen/gp_plug.js"></script>
  <script src="./js/screen/plug.js"></script>
  <script src="./js/screen/screen.js"></script>
  <script src="./js/screen/image_mouse.js"></script>
  <script src="./js/screen/screen_maker.js"></script>
  <!-- <script src="./js/screen/screen_api.js"></script> -->
  <!-- <script src="./js/screen/gp_plug.js"></script> -->
  <script src="./js/screen/colors.js"></script>
  <script src="./js/screen/img_view.js"></script>


</body>

</html>