<!DOCTYPE html>
<html>
<head>
    <style>
        * { box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #1a1a1a;
            display: flex; flex-direction: column; user-select: none;
        }
        .full-bar {
            width: 100%; height: 76px; min-height: 76px;
            display: flex; align-items: center;
            padding: 0 12px; border: none;
            cursor: move; flex-shrink: 0; z-index: 10;
            background-color: #1a1a1a;
        }
        .full-bar.expanded-mode { border-bottom: 1px solid #333; }
        .disk-box { width: 42px; height: 42px; flex-shrink: 0; position: relative; border-radius: 50%; overflow: hidden; border: 1px solid #444; }

        #disk {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.2, 0, 0.2, 1.5);
        }

        .disk-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s; cursor: pointer; -webkit-app-region: no-drag;
        }
        .full-bar:hover .disk-overlay { opacity: 1; }

        /* 处理中状态：禁止点击 */
        .disk-overlay.processing {
            cursor: not-allowed !important;
            opacity: 0.5 !important;
        }

        .btn-icon { width: 22px; height: 22px; fill: white; }
        .center-info { display: flex; flex-direction: column; justify-content: center; margin-left: 12px; flex-grow: 1; overflow: hidden; }
        .ui-title { color: #eeeeee; font-size: 13px; font-family: "微软雅黑"; font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .control-row { margin-top: 4px; font-size: 11px; font-family: 'Consolas', '微软雅黑'; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; -webkit-app-region: no-drag; cursor: pointer; }
        #latest-log-preview { color: #00ff88; opacity: 0.8; display: block; }
        #collapse-btn { color: #888; display: none; font-weight: bold; }
        #collapse-btn:hover { color: #00ff88; }
        .hide-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #666; cursor: pointer; transition: all 0.2s; -webkit-app-region: no-drag; opacity: 0; }
        .full-bar:hover .hide-btn { opacity: 1; }
        .hide-btn:hover { background: #444; color: white; }
        .led { width: 4px; height: 24px; background: #333; margin-left: 10px; transition: all 0.3s; }
        .is-active .led { background: #00ff88; box-shadow: -2px 0 8px rgba(0, 255, 136, 0.4); }

        #log-window { width: 100%; flex-grow: 1; background: #121212; display: none; flex-direction: column; border: none; overflow: hidden; }
        #log-container { flex: 1; width: 100%; padding: 10px; color: #00ff88; font-family: 'Consolas', monospace; font-size: 12px; overflow-y: auto; }

        #log-container::-webkit-scrollbar { width: 6px; }
        #log-container::-webkit-scrollbar-track { background: #1a1a1a; }
        #log-container::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        #log-container::-webkit-scrollbar-thumb:hover { background: #444; }

        .log-line { border-bottom: 1px solid #1a1a1a; padding: 4px 0; word-break: break-all; color: #00ff88; }
        .log-line.latest { color: #ffffff !important; font-weight: bold; }
    </style>
</head>
<body>
    <div class="full-bar" id="mainBar" onmousedown="handleMouseDown(event)">
        <div class="disk-box">
            <img id="disk" src="">
            <div id="overlay" class="disk-overlay" onclick="toggleStatus(event)">
                <svg id="playIcon" class="btn-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg id="stopIcon" class="btn-icon" viewBox="0 0 24 24" style="display:none;"><path d="M6 6h12v12H6z"/></svg>
            </div>
        </div>
        <div class="center-info">
            <div class="ui-title" id="ui-title">Loading...</div>
            <div class="control-row">
                <div id="latest-log-preview" onclick="setExpand(true)">Waiting...</div>
                <div id="collapse-btn" onclick="setExpand(false)">CLOSE PANEL ▴</div>
            </div>
        </div>
        <div class="hide-btn" onclick="callPython('hide_window')">
            <svg style="width:18px; height:18px; fill:currentColor" viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
        </div>
        <div class="led" id="ledIndicator"></div>
    </div>
    <div id="log-window"><div id="log-container"></div></div>

    <script>
        let running = false; let currentAngle = 0; let animationId = null;
        let isProcessing = false; // 状态锁：点击无效化的核心

        const disk = document.getElementById('disk'); const mainBar = document.getElementById('mainBar');
        const logWindow = document.getElementById('log-window'); const logContainer = document.getElementById('log-container');
        const logPreview = document.getElementById('latest-log-preview'); const collapseBtn = document.getElementById('collapse-btn');
        const overlay = document.getElementById('overlay');

        window.addEventListener('onPythonReady', async () => {
            const info = await callPython('get_init_data');
            document.getElementById('ui-title').innerText = info.title;
            disk.src = "data:image/png;base64," + info.icon_b64;
        });

        window.addLog = function(msg) {
            logPreview.innerText = msg;
            const line = document.createElement('div'); line.className = 'log-line latest'; line.innerText = msg;
            const oldLatest = logContainer.querySelector('.log-line.latest');
            if (oldLatest) oldLatest.classList.remove('latest');
            logContainer.appendChild(line);
            logContainer.scrollTop = logContainer.scrollHeight;
            if (logContainer.childNodes.length > 100) logContainer.removeChild(logContainer.firstChild);
        };

        function setExpand(expand) {
            if (expand) { logWindow.style.display = 'flex'; mainBar.classList.add('expanded-mode'); logPreview.style.display = 'none'; collapseBtn.style.display = 'block'; }
            else { logWindow.style.display = 'none'; mainBar.classList.remove('expanded-mode'); logPreview.style.display = 'block'; collapseBtn.style.display = 'none'; }
            callPython('resize_ui', expand);
        }

        function rotateStep() {
            if (!running) return;
            currentAngle = (currentAngle + 4) % 360;
            disk.style.transition = 'none';
            disk.style.transform = `rotate(${currentAngle}deg)`;
            animationId = requestAnimationFrame(rotateStep);
        }

        async function toggleStatus(e) {
            e.stopPropagation();
            if (isProcessing) return; // 如果正在清理或启动中，点击无效

            isProcessing = true;
            overlay.classList.add('processing'); // 增加视觉反馈

            running = !running;
            if (running) {
                mainBar.classList.add('is-active');
                document.getElementById('playIcon').style.display = 'none';
                document.getElementById('stopIcon').style.display = 'block';
                rotateStep();
            }
            else {
                mainBar.classList.remove('is-active');
                document.getElementById('playIcon').style.display = 'block';
                document.getElementById('stopIcon').style.display = 'none';
                cancelAnimationFrame(animationId);
                disk.style.transition = 'transform 0.6s cubic-bezier(0.2, 0, 0.2, 1.5)';
                disk.style.transform = 'rotate(0deg)';
                currentAngle = 0;
            }

            // 调用 Python 并等待处理完成（善后 3s 也会在这里等待）
            await callPython('on_toggle_click', running);

            isProcessing = false;
            overlay.classList.remove('processing'); // 解锁
        }

        function handleMouseDown(e) {
            if (['ui-title', 'mainBar', 'center-info'].some(c => e.target.classList.contains(c) || e.target.id === c)) {
                callPython('drag_window');
            }
        }

        async function callPython(method, ...args) {
            if (window.pywebview && window.pywebview.api) {
                return await window.pywebview.api[method](...args);
            }
        }

        // 在你的 HTML script 标签内增加此方法
        window.syncStatus = function(isActive) {
            if (isActive === running) return;

            // 复用 toggleStatus 的逻辑但不触发 callPython (因为是 Python 发起的)
            running = isActive;
            if (running) {
                mainBar.classList.add('is-active');
                document.getElementById('playIcon').style.display = 'none';
                document.getElementById('stopIcon').style.display = 'block';
                rotateStep();
            } else {
                mainBar.classList.remove('is-active');
                document.getElementById('playIcon').style.display = 'block';
                document.getElementById('stopIcon').style.display = 'none';
                cancelAnimationFrame(animationId);
                disk.style.transition = 'transform 0.6s cubic-bezier(0.2, 0, 0.2, 1.5)';
                disk.style.transform = 'rotate(0deg)';
                currentAngle = 0;
            }
        };


    </script>
</body>
</html>