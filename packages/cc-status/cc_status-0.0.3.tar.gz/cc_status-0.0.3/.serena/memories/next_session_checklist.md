# cc-statusline 下次会话优先事项

**更新日期**: 2026-01-29

---

## 🎯 高优先级任务

### 1. 监控状态文件累积
**问题**: 每个进程创建独立的 session_time_{pid}.json 文件
**风险**: 可能导致大量临时文件累积
**建议**: 
- 实现定期清理机制
- 考虑使用 /tmp 目录而非 ~/.claude
- 添加自动清理脚本

### 2. 观察MCP命令执行时间
**问题**: 超时从5秒增加到10秒，可能还不够
**建议**:
- 在生产环境统计实际执行时间
- 考虑使用异步执行
- 添加更智能的超时策略

### 3. 验证多窗口隔离
**建议**:
- 打开10+个窗口测试
- 验证每个窗口的时间独立增长
- 确认关闭窗口后文件被清理

---

## 🔧 代码优化建议

### 1. 添加输出缓存
```python
# terminal_renderer.py
if output != self._last_output:
    print(f"\r{output}", end="", flush=True)
    self._last_output = output
```

### 2. 实现配置文件级别的会话隔离
**当前**: 基于进程ID
**改进**: 基于用户会话或窗口ID
**优势**: 更符合用户预期，易于管理

### 3. 添加MCP检测的fallback机制
```python
# 命令失败时，尝试从配置文件读取
if not servers:
    servers = self._get_from_config()
```

---

## 📚 文档更新

### 需要更新的文档
1. **README.md**
   - 添加多窗口时间隔离说明
   - 更新故障排查部分

2. **CLAUDE.md**
   - 记录延迟初始化的设计决策
   - 添加进程隔离的最佳实践

3. **CHANGELOG.md**
   - 记录三项问题修复
   - 说明破坏性变更（如果有）

---

## 🧪 测试增强

### 新增测试用例
1. **多进程并发测试**
   ```python
   def test_concurrent_session_time():
       # 同时创建多个进程
       # 验证时间独立统计
   ```

2. **MCP格式变化测试**
   ```python
   def test_mcp_format_compatibility():
       # 测试多种输出格式
       # 验证向后兼容性
   ```

3. **超时处理测试**
   ```python
   def test_mcp_timeout_handling():
       # Mock超时场景
       # 验证优雅降级
   ```

---

## 🚀 发布检查清单

### 发布前
- [ ] 所有测试通过
- [ ] 手动验证三个问题已解决
- [ ] 检查文件权限和路径
- [ ] 验证多窗口场景
- [ ] 更新版本号
- [ ] 更新 CHANGELOG

### 发布后
- [ ] 监控用户反馈
- [ ] 观察性能指标
- [ ] 收集新的bug报告
- [ ] 准备下一个版本的规划

---

## 🔄 持续改进

### 性能监控
- 添加性能日志
- 统计MCP命令执行时间
- 监控状态文件大小和数量

### 用户体验
- 收集用户反馈
- 分析使用模式
- 优化常用场景

### 代码质量
- 定期代码审查
- 重构复杂逻辑
- 提高测试覆盖率

---

**下次会话从这里开始！**
