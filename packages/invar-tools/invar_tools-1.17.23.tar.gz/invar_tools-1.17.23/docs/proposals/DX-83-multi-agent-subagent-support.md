# DX-83: å¤š Agent ç¯å¢ƒä¸‹çš„ Subagent æ”¯æŒä¸é™çº§ç­–ç•¥

**Status**: Draft
**Created**: 2026-01-04
**Priority**: High
**Type**: Enhancement
**Related**: DX-81 (Multi-Agent Init)

---

## Problem

### å½“å‰çŠ¶æ€

#### Subagent ä¾èµ–åœºæ™¯

å¤šä¸ª Invar skills ä¾èµ– **isolated subagent** å®ç°æ ¸å¿ƒä»·å€¼ï¼š

| Skill | Subagent ç”¨é€” | ç¡¬ç¼–ç  Model | å¿…è¦æ€§ |
|-------|---------------|--------------|--------|
| `/review` | æ¯è½® review (fresh eyes) | `model=opus` | **MANDATORY** |
| `/develop` (VALIDATE) | éå¹³å‡¡å®ç°éªŒè¯ (>3 å‡½æ•°æˆ– >200 è¡Œ) | `model=opus` | **MANDATORY** |
| `/acceptance --deep` | æ·±åº¦éªŒè¯ (default) | æœªæŒ‡å®š | Optional |
| `/security --deep` | å®‰å…¨å®¡è®¡ (default) | æœªæŒ‡å®š | Optional |

**æ ¸å¿ƒé—®é¢˜ï¼š**
```markdown
# .claude/skills/review/SKILL.md:14
1. **EVERY round MUST spawn isolated subagent** (Task tool with model=opus)
```

#### Agent èƒ½åŠ›å·®å¼‚

DX-81 å®ç°å¤š agent æ”¯æŒåï¼Œä¸åŒ agent çš„èƒ½åŠ›å·®å¼‚æš´éœ²ï¼š

| Agent | Task Tool | Subagent Support | Model Access |
|-------|-----------|------------------|--------------|
| **Claude Code** | âœ… | âœ… | sonnet, opus, haiku |
| **Windsurf** | âœ… | âœ… | sonnet, opus, haiku |
| **Pi** | âŒ | âŒ | sonnet (via API) |
| **Cursor** | âŒ | âŒ | å„ç§æ¨¡å‹ (via API) |

---

### é—®é¢˜ 1: Skill æ–‡æ¡£ç¡¬ç¼–ç  Model

**ç°çŠ¶ï¼š**
```markdown
# review/SKILL.md
1. **EVERY round MUST spawn isolated subagent** (Task tool with model=opus)

# develop/SKILL.md
2. Spawn Isolated VALIDATOR (Task tool, model=opus):
```

**é—®é¢˜ï¼š**
1. **è¿åé…ç½®åˆ†ç¦»åŸåˆ™** - model é€‰æ‹©åº”è¯¥æ˜¯é…ç½®ï¼Œä¸æ˜¯ç¡¬ç¼–ç 
2. **æ— æ³•å°Šé‡ç”¨æˆ·åå¥½** - ç”¨æˆ·å¯èƒ½æƒ³ç”¨ sonnet èŠ‚çœæˆæœ¬
3. **æ— æ³•é€‚é… agent ç¯å¢ƒ** - Pi é€šè¿‡ API è°ƒç”¨ï¼Œæ—  opus è®¿é—®æƒé™

**å½±å“ï¼š**
- ç”¨æˆ·æ— æ³•è‡ªå®šä¹‰ model åå¥½
- ä¸å…¨å±€ model è®¾ç½®å†²çªï¼ˆå¦‚ `/model sonnet`ï¼‰
- è·¨ agent ç¯å¢ƒæ—¶è¡Œä¸ºä¸ä¸€è‡´

---

### é—®é¢˜ 2: å…±äº« Skill æ— æ³•é€‚é…åŒç¯å¢ƒ

**ç°çŠ¶ï¼š**
DX-81 åï¼Œ`.claude/skills/` è¢« Claude Code å’Œ Pi å…±äº«ï¼š

```
.claude/skills/
â”œâ”€â”€ review/SKILL.md     â† åŒä¸€ä»½æ–‡æ¡£
â”œâ”€â”€ develop/SKILL.md    â† åŒä¸€ä»½æ–‡æ¡£
â””â”€â”€ ...
```

ä½† skill æ–‡æ¡£åªæè¿°äº†ä¸€ç§æ‰§è¡Œè·¯å¾„ï¼ˆTask tool requiredï¼‰ï¼Œå¯¼è‡´ï¼š

**åœ¨ Pi ç¯å¢ƒä¸­ï¼š**
```bash
$ pi /review
[Pi reads review/SKILL.md]
"MUST spawn isolated subagent (Task tool)"
â†’ Pi å°è¯•è°ƒç”¨ Task tool
â†’ âŒ Tool not available
â†’ ğŸ’¥ Skill execution fails
```

**é—®é¢˜ï¼š**
- Skill æ–‡æ¡£å‡è®¾ Task tool æ€»æ˜¯å¯ç”¨
- æ²¡æœ‰ fallback ç­–ç•¥
- Pi ç”¨æˆ·æ— æ³•ä½¿ç”¨éœ€è¦ subagent çš„ skills

---

### é—®é¢˜ 3: æ— èƒ½åŠ›æ£€æµ‹æœºåˆ¶

**ç°çŠ¶ï¼š**
Skills æ²¡æœ‰æ£€æµ‹ agent èƒ½åŠ›çš„æ–¹æ³•ï¼š

```markdown
# review/SKILL.md (ä¼ªä»£ç )
1. Spawn subagent with Task tool
   â†’ ä½†å¦‚æœ Task tool ä¸å¯ç”¨ï¼Ÿ
   â†’ æ²¡æœ‰æ£€æµ‹é€»è¾‘
   â†’ æ²¡æœ‰ fallback è¯´æ˜
```

**ç¼ºå¤±åŠŸèƒ½ï¼š**
1. **è¿è¡Œæ—¶æ£€æµ‹** - æ— æ³•åœ¨ skill æ‰§è¡Œæ—¶æ£€æµ‹ Task tool æ˜¯å¦å¯ç”¨
2. **ç¯å¢ƒæ ‡è®°** - `invar init` ä¸è®°å½• agent èƒ½åŠ›ä¿¡æ¯
3. **é…ç½®è¦†ç›–** - ç”¨æˆ·æ— æ³•å¼ºåˆ¶ä½¿ç”¨/ç¦ç”¨ subagent

**å½±å“ï¼š**
- Skill æ— æ³•ä¼˜é›…é™çº§
- é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆsilent failure æˆ– hard crashï¼‰

---

### é—®é¢˜ 4: Review é™çº§çš„ä»·å€¼äº‰è®®

**æ ¸å¿ƒçŸ›ç›¾ï¼š**
`/review` skill çš„è®¾è®¡å“²å­¦æ˜¯ **adversarial review with context isolation**ï¼š

```markdown
# review/SKILL.md
Code is GUILTY until proven INNOCENT.
Every round spawns isolated subagent reviewing FULL scope.

**Why isolation?**
- Main agent has context contamination from fixing
- "Fresh eyes" impossible in same context
- Round 2+ drifts to "verify my fixes" not "find problems"
```

**å“²å­¦é—®é¢˜ï¼š**
æ²¡æœ‰ isolation çš„ review æ˜¯å¦è¿˜æœ‰æ„ä¹‰ï¼Ÿ

**é€‰é¡¹ A: Hard Fail**
```
âŒ /review requires isolated subagent support
ğŸ’¡ Use Claude Code or manual code review
```
- âœ… ä¿è¯è´¨é‡
- âŒ Pi ç”¨æˆ·æ— æ³•ä½¿ç”¨

**é€‰é¡¹ B: Degraded Mode**
```
âš ï¸  Running review without isolation (bias risk)
âœ… Applying checklist with persona switch
```
- âœ… Pi ç”¨æˆ·å¯ä»¥ä½¿ç”¨
- âŒ è´¨é‡å¤§å¹…é™ä½ï¼ˆâ­â­ vs â­â­â­ï¼‰
- âŒ å¯èƒ½ç»™ç”¨æˆ·è™šå‡å®‰å…¨æ„Ÿ

---

## Analysis

### èƒ½åŠ›æ£€æµ‹ç­–ç•¥

#### æ–¹æ¡ˆ A: ç¯å¢ƒæ ‡è®°ï¼ˆé™æ€æ£€æµ‹ï¼‰

**å®ç°ï¼š**
```markdown
# .invar/context.md (auto-generated by `invar init`)
## Agent Environment

Primary Agent: Claude Code
- Task Tool: âœ… Available
- Model Access: sonnet, opus, haiku
- Subagent Support: âœ… Full

Fallback Agent: Pi
- Task Tool: âŒ Not Available
- Model Access: sonnet (API)
- Subagent Support: âŒ None
```

**Skill æ£€æµ‹é€»è¾‘ï¼š**
```python
# Pseudo-code in skill
def detect_subagent_support() -> bool:
    context = read(".invar/context.md")
    return "Task Tool: âœ…" in context
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ˜ç¡®ï¼Œæ— æ­§ä¹‰
- âœ… åœ¨ init æ—¶ç¡®å®šï¼Œä¸ä¾èµ–è¿è¡Œæ—¶
- âœ… ç”¨æˆ·å¯è§ï¼Œå¯æ‰‹åŠ¨ç¼–è¾‘

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦ç»´æŠ¤ context.md åŒæ­¥
- âŒ ç”¨æˆ·å¯èƒ½è¯¯ç¼–è¾‘
- âŒ æ— æ³•å¤„ç†åŠ¨æ€ç¯å¢ƒå˜åŒ–

---

#### æ–¹æ¡ˆ B: é…ç½®æ–‡ä»¶ï¼ˆç”¨æˆ·æ§åˆ¶ï¼‰

**å®ç°ï¼š**
```toml
# .invar/config.toml (new file)
[agent]
type = "claude-code"  # claude-code | pi | windsurf | cursor
task_tool_available = true

[skills]
# Global subagent model preference
subagent_model = "inherit"  # inherit | sonnet | opus | haiku

[skills.review]
execution_mode = "auto"  # auto | isolated | degraded | disabled
subagent_model = "inherit"
skip_degraded_warning = false

[skills.develop]
subagent_model = "inherit"
validate_isolation_threshold = 200  # lines of code
```

**Skill æ£€æµ‹é€»è¾‘ï¼š**
```python
# Pseudo-code in skill
def get_execution_mode() -> str:
    config = read_toml(".invar/config.toml")

    # User explicit override
    mode = config["skills"]["review"]["execution_mode"]
    if mode != "auto":
        return mode

    # Auto-detect
    if config["agent"]["task_tool_available"]:
        return "isolated"
    else:
        return "degraded"
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç”¨æˆ·å¯å®Œå…¨æ§åˆ¶
- âœ… æ”¯æŒæ˜¾å¼è¦†ç›–ï¼ˆ`--no-subagent` flagï¼‰
- âœ… é…ç½®å³æ–‡æ¡£

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦æ–°çš„é…ç½®åŸºç¡€è®¾æ–½
- âŒ é…ç½®å¯èƒ½ä¸å®é™…ç¯å¢ƒä¸ä¸€è‡´

---

#### æ–¹æ¡ˆ C: è¿è¡Œæ—¶æ£€æµ‹ï¼ˆåŠ¨æ€æ¢æµ‹ï¼‰

**å®ç°ï¼š**
```python
# Pseudo-code in skill entry
def detect_task_tool() -> bool:
    try:
        # Attempt no-op Task call
        Task(
            subagent_type="general-purpose",
            prompt="echo test",
            description="capability probe",
            model="haiku"  # cheap model for probe
        )
        return True
    except ToolNotAvailableError:
        return False
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ€»æ˜¯åæ˜ å®é™…èƒ½åŠ›
- âœ… æ— éœ€ç»´æŠ¤é…ç½®
- âœ… åŠ¨æ€é€‚åº”ç¯å¢ƒå˜åŒ–

**ç¼ºç‚¹ï¼š**
- âŒ æ¯æ¬¡ skill è°ƒç”¨éƒ½éœ€è¦æ¢æµ‹ï¼ˆæ€§èƒ½å¼€é”€ï¼‰
- âŒ ä¾èµ– agent çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âŒ å¯èƒ½äº§ç”Ÿ API è´¹ç”¨ï¼ˆhaiku probeï¼‰

---

#### æ¨èï¼šæ··åˆæ–¹æ¡ˆï¼ˆB + Cï¼‰

1. **é…ç½®ä¼˜å…ˆï¼ˆæ–¹æ¡ˆ Bï¼‰**
   - `invar init` æ—¶æ£€æµ‹å¹¶å†™å…¥ `.invar/config.toml`
   - ç”¨æˆ·å¯æ‰‹åŠ¨ç¼–è¾‘é…ç½®

2. **è¿è¡Œæ—¶éªŒè¯ï¼ˆæ–¹æ¡ˆ C ç®€åŒ–ç‰ˆï¼‰**
   - Skill å…¥å£å¤„æ£€æŸ¥ Task tool æ˜¯å¦åœ¨ available tools list
   - ä¸æ‰§è¡Œå®é™…è°ƒç”¨ï¼Œåªæ£€æŸ¥å·¥å…·åˆ—è¡¨

3. **ç”¨æˆ·è¦†ç›–**
   - æ”¯æŒ `--no-subagent` flag å¼ºåˆ¶é™çº§
   - æ”¯æŒç¯å¢ƒå˜é‡ `INVAR_FORCE_DEGRADED=1`

---

### Model é…ç½®å±‚çº§

**é—®é¢˜æ ¹æºï¼š**
```markdown
# Current (hardcoded in SKILL.md)
spawn isolated subagent (Task tool with model=opus)
```

**è®¾è®¡åŸåˆ™ï¼š**
1. **é…ç½®åˆ†ç¦»** - Model é€‰æ‹©æ˜¯é…ç½®ï¼Œä¸æ˜¯æ–‡æ¡£
2. **å±‚çº§è¦†ç›–** - Global â†’ Skill â†’ User flag
3. **é»˜è®¤åˆç†** - `inherit` (ä½¿ç”¨å½“å‰ agent çš„ model)

**é…ç½®å±‚çº§ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š**

```toml
# Level 1: User runtime flag (highest priority)
$ /review --model sonnet

# Level 2: Skill-specific config
[skills.review]
subagent_model = "opus"  # Override for this skill

# Level 3: Global skills config
[skills]
subagent_model = "sonnet"  # All skills default

# Level 4: System default (lowest priority)
# Default: "inherit" (use parent agent's current model)
```

**SKILL.md æ”¹é€ ï¼š**
```markdown
# Before (hardcoded)
1. Spawn isolated subagent (Task tool with model=opus)

# After (config-driven)
1. Spawn isolated subagent (Task tool)
   - Model: Follows config `[skills.review].subagent_model`
   - Default: `inherit` (uses current agent model)
   - Override: `--model <name>` flag
```

---

### Degraded Mode è®¾è®¡

#### æ ¸å¿ƒé—®é¢˜ï¼šè´¨é‡ vs å¯ç”¨æ€§

**Isolated Mode (â­â­â­)**
- âœ… Context isolation â†’ fresh eyes
- âœ… Adversarial mindset â†’ finds more issues
- âœ… No bias from implementation history

**Degraded Mode (â­â­)**
- âŒ Same context â†’ contamination risk
- âŒ Persona switch only â†’ limited objectivity
- âš ï¸  Checklist applied â†’ better than nothing

**Trade-offï¼š**
- **Hard fail**: ä¿è¯è´¨é‡ï¼Œä½† Pi ç”¨æˆ·æ— æ³•ä½¿ç”¨
- **Degraded mode**: å¯ç”¨æ€§ä¼˜å…ˆï¼Œä½†è´¨é‡é™ä½

---

#### æ¨èç­–ç•¥ï¼šåˆ†çº§é™çº§

| Skill | Without Subagent | Rationale |
|-------|------------------|-----------|
| **review** | **Warn + Degrade** | é™çº§æœ‰é™ä»·å€¼ï¼Œä½†æ€»æ¯”æ²¡æœ‰å¥½ |
| **develop VALIDATE** | **Warn + Degrade** | Guard æä¾›åŸºç¡€ä¿éšœï¼Œé™çº§éªŒè¯å¯æ¥å— |
| **acceptance --deep** | **Silent Downgrade** â†’ `--standard` | ç”¨æˆ·ä¸éœ€è¦æ„ŸçŸ¥ |
| **security --deep** | **Silent Downgrade** â†’ `--standard` | ç”¨æˆ·ä¸éœ€è¦æ„ŸçŸ¥ |

**Review Degraded Workflowï¼š**

```markdown
## Mode B: DEGRADED (Fallback)

**When:** Task tool not available OR `--no-subagent` flag

### Entry Warning

âš ï¸  REVIEW DEGRADED MODE

Agent doesn't support Task tool. Running best-effort review:

  âœ… Full checklist verification
  âœ… Multi-round fix loop
  âŒ NO context isolation
  âŒ NO fresh-eyes objectivity

Bias Risk: Agent may have implementation history in context.
Quality: â­â­ (vs â­â­â­ with isolation)

Recommendation:
  â€¢ For production: Use Claude Code (`invar init --claude`)
  â€¢ For quick checks: Proceed with degraded mode

Proceed? [Y/n]

### Degraded Execution

1. **Persona Switch** (instead of isolation)
   ```
   ğŸ”„ Switching to Reviewer Persona

   I am now a CRITICAL code reviewer.
   Acknowledging limitations:
   - I may have seen this code before
   - Context contamination risk exists
   - This is DEGRADED vs isolated review
   ```

2. **Same Checklist, Extra Vigilance**
   - Apply full checklist (A-G)
   - Explicitly note bias risk in each finding
   - Be conservative (flag more issues when uncertain)

3. **Report Tagging**
   ```
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ğŸ“‹ REVIEW COMPLETE [DEGRADED MODE]
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   âš ï¸  Reviewed without context isolation
   âš ï¸  Bias risk: Agent may have seen code before
   âœ… Checklist applied, objectivity limited

   Recommendation: Re-review with isolated agent before production.
   ```
```

---

## Proposal

### Solution Overview

**3-Tier Architecture:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tier 1: Configuration Layer                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .invar/config.toml                                 â”‚
â”‚ - Agent capabilities                               â”‚
â”‚ - Model preferences (global + per-skill)           â”‚
â”‚ - Execution mode overrides                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tier 2: Skill Documentation (Dual-Path)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .claude/skills/*/SKILL.md                          â”‚
â”‚ - Mode A: ISOLATED (Task tool available)          â”‚
â”‚ - Mode B: DEGRADED (fallback)                     â”‚
â”‚ - Detection logic                                  â”‚
â”‚ - User warnings                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tier 3: Runtime Execution                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Agent detects capabilities â†’ Chooses path         â”‚
â”‚ - Check config override                            â”‚
â”‚ - Detect Task tool                                 â”‚
â”‚ - Show warnings if degraded                        â”‚
â”‚ - Execute with appropriate mode                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Phase A: Configuration Infrastructure

**Goal:** åˆ›å»ºé…ç½®åŸºç¡€è®¾æ–½ï¼Œæ”¯æŒ model åå¥½å’Œèƒ½åŠ›æ ‡è®°

#### A1: åˆ›å»ºé…ç½®æ¨¡æ¿

**File:** `src/invar/templates/config.toml` (new)

```toml
# Invar Configuration
# Generated by: invar init
# Version: 5.0

[agent]
# Primary agent type (auto-detected during init)
type = "claude-code"  # claude-code | pi | windsurf | cursor | other

# Task tool availability (auto-detected)
# Set to false to force degraded mode for all skills
task_tool_available = true

[skills]
# ==========================================
# Global Skill Settings
# ==========================================

# Model preference for subagents (when Task tool available)
# Options:
#   "inherit" - Use current agent's active model (default)
#   "sonnet"  - Always use Claude Sonnet 4.5
#   "opus"    - Always use Claude Opus 4.5
#   "haiku"   - Always use Claude Haiku 4
subagent_model = "inherit"

# ==========================================
# Skill-Specific Overrides
# ==========================================

[skills.review]
# Execution mode
# Options:
#   "auto"     - Auto-detect (isolated if available, else degraded)
#   "isolated" - Require Task tool (fail if not available)
#   "degraded" - Force degraded mode even if Task tool available
#   "disabled" - Disable this skill entirely
execution_mode = "auto"

# Model for review subagents (overrides global)
subagent_model = "inherit"

# Skip degraded mode warning
skip_degraded_warning = false

[skills.develop]
# Model for validation subagents
subagent_model = "inherit"

# Threshold for requiring isolated validation (lines of code)
# Below this threshold, degraded mode is acceptable
validate_isolation_threshold = 200

[skills.acceptance]
# Default mode (--quick | --standard | --deep)
default_mode = "deep"

[skills.security]
# Default mode (--quick | --standard | --deep)
default_mode = "deep"
```

**Exit Criteria:**
- âœ… Template file created
- âœ… Schema documented in comments
- âœ… Defaults match current behavior

---

#### A2: é…ç½®è¯»å–å‡½æ•°

**File:** `src/invar/shell/config.py` (extend)

```python
from pathlib import Path
from returns import Result, Success, Failure
import tomllib

@pre(lambda project_root: isinstance(project_root, Path))
def get_skill_config(
    project_root: Path,
    skill_name: str
) -> Result[dict[str, Any], str]:
    """
    Read skill-specific configuration.

    Merges global and skill-specific settings with proper precedence.

    Examples:
        >>> config = get_skill_config(Path("."), "review")
        >>> config.unwrap()["execution_mode"]
        'auto'
    """
    config_path = project_root / ".invar" / "config.toml"

    if not config_path.exists():
        # Return defaults if no config
        return Success(get_default_skill_config(skill_name))

    result = _read_toml(config_path)
    if isinstance(result, Failure):
        return result

    data = result.unwrap()

    # Merge global + skill-specific
    global_skills = data.get("skills", {})
    skill_specific = global_skills.get(skill_name, {})

    # Global defaults
    merged = {
        "subagent_model": global_skills.get("subagent_model", "inherit"),
    }

    # Skill-specific overrides
    merged.update(skill_specific)

    return Success(merged)


def get_default_skill_config(skill_name: str) -> dict[str, Any]:
    """Get hardcoded defaults for a skill."""
    defaults = {
        "review": {
            "execution_mode": "auto",
            "subagent_model": "inherit",
            "skip_degraded_warning": False,
        },
        "develop": {
            "subagent_model": "inherit",
            "validate_isolation_threshold": 200,
        },
        "acceptance": {
            "default_mode": "deep",
        },
        "security": {
            "default_mode": "deep",
        },
    }
    return defaults.get(skill_name, {})


@pre(lambda project_root: isinstance(project_root, Path))
def detect_agent_capabilities(project_root: Path) -> dict[str, Any]:
    """
    Detect current agent's capabilities.

    Called during `invar init` to populate config.toml.

    Returns:
        {
            "type": "claude-code" | "pi" | "windsurf" | "cursor" | "other",
            "task_tool_available": bool,
        }
    """
    # Detection heuristics:
    # 1. Check for Claude Code indicators (.claude/ exists and was created by us)
    # 2. Check for Pi indicators (.pi/ exists and was created by us)
    # 3. Check environment variables (INVAR_AGENT_TYPE)
    # 4. Default to "other" with task_tool_available=false

    if (project_root / ".claude").exists():
        return {"type": "claude-code", "task_tool_available": True}
    elif (project_root / ".pi").exists():
        return {"type": "pi", "task_tool_available": False}
    else:
        # Conservative default
        return {"type": "other", "task_tool_available": False}
```

**Exit Criteria:**
- âœ… `get_skill_config()` with tests
- âœ… `detect_agent_capabilities()` with heuristics
- âœ… Proper merging logic (global â†’ skill-specific)

---

#### A3: åœ¨ init æ—¶ç”Ÿæˆé…ç½®

**File:** `src/invar/shell/commands/init.py` (extend)

```python
def _generate_config_file(project_root: Path, agents: list[str]) -> Result[None, str]:
    """
    Generate .invar/config.toml with auto-detected capabilities.

    Args:
        agents: List of enabled agents (["claude", "pi"])
    """
    capabilities = detect_agent_capabilities(project_root)

    # Load template
    template_path = get_template_path("config.toml")
    template = template_path.read_text(encoding="utf-8")

    # Substitute detected values
    config_content = template.replace(
        'type = "claude-code"',
        f'type = "{capabilities["type"]}"'
    ).replace(
        'task_tool_available = true',
        f'task_tool_available = {str(capabilities["task_tool_available"]).lower()}'
    )

    # Write config
    config_path = project_root / ".invar" / "config.toml"
    config_path.write_text(config_content, encoding="utf-8")

    return Success(None)


# In init_command():
# After creating .invar/ directory:
result = _generate_config_file(project_root, enabled_agents)
if isinstance(result, Failure):
    console.print(f"[yellow]Warning:[/yellow] {result.failure()}")
```

**Exit Criteria:**
- âœ… `invar init` ç”Ÿæˆ `.invar/config.toml`
- âœ… è‡ªåŠ¨æ£€æµ‹ agent ç±»å‹å’Œèƒ½åŠ›
- âœ… æ”¯æŒå¤š agent åœºæ™¯ï¼ˆå¦‚ `--claude --pi` é€‰ä¸» agentï¼‰

---

### Phase B: Skill Documentation (Dual-Path)

**Goal:** æ”¹é€  skill æ–‡æ¡£ï¼Œæ”¯æŒåŒæ‰§è¡Œè·¯å¾„ï¼ˆisolated + degradedï¼‰

#### B1: Review Skill æ”¹é€ 

**File:** `.claude/skills/review/SKILL.md`

**Changes:**

1. **Frontmatter æ›´æ–°**
   ```yaml
   ---
   name: review
   description: Adversarial code review with context isolation when available
   _invar:
     version: "8.0"  # DX-83: Multi-agent support
     managed: skill
     capabilities:
       recommended: ["task_tool"]  # Not required, but recommended
   ---
   ```

2. **æ·»åŠ  "Execution Modes" ç« èŠ‚**
   ```markdown
   ## Execution Modes (DX-83)

   This skill adapts to agent capabilities:

   | Mode | Requirements | Quality |
   |------|--------------|---------|
   | **ISOLATED** | Task tool available | â­â­â­ Full adversarial review |
   | **DEGRADED** | Task tool NOT available | â­â­ Best-effort review |

   **Default:** Auto-detect and use best available mode.
   **Override:** Use `--no-subagent` flag to force degraded mode.
   ```

3. **é‡æ„ä¸ºä¸¤ä¸ªè·¯å¾„**
   - **Mode A: ISOLATED** - ç°æœ‰çš„å®Œæ•´ workflow
   - **Mode B: DEGRADED** - æ–°å¢çš„é™çº§ workflow

4. **æ·»åŠ æ£€æµ‹é€»è¾‘è¯´æ˜**
   ```markdown
   ## Agent Instructions

   **At skill entry, detect execution mode:**

   ```python
   # Step 1: Check user override
   if "--no-subagent" in args:
       mode = "degraded"

   # Step 2: Check config
   config = read_config(".invar/config.toml")
   if config["skills"]["review"]["execution_mode"] != "auto":
       mode = config["skills"]["review"]["execution_mode"]

   # Step 3: Auto-detect
   elif task_tool_available():
       mode = "isolated"
   else:
       mode = "degraded"

   # Execute
   if mode == "isolated":
       execute_isolated_review()
   else:
       show_degraded_warning()
       if user_confirms():
           execute_degraded_review()
   ```

**Full degraded mode workflow:**
```markdown
## Mode B: DEGRADED (Fallback)

**When:** Task tool not available OR `--no-subagent` flag

### Entry Warning

âš ï¸  REVIEW DEGRADED MODE

Agent doesn't support Task tool. Running best-effort review:

  âœ… Full checklist verification
  âœ… Multi-round fix loop
  âŒ NO context isolation
  âŒ NO fresh-eyes objectivity

Bias Risk: Agent may have seen this code before.
Quality: â­â­ (vs â­â­â­ with isolation)

Recommendation:
  â€¢ For production: Use Claude Code (`invar init --claude`)
  â€¢ For quick checks: Proceed with degraded mode

Proceed? [Y/n]

### Workflow

1. **Persona Switch** (instead of isolation)

   Display:
   ```
   ğŸ”„ Switching to Reviewer Persona [DEGRADED]

   I am now a CRITICAL code reviewer.
   Acknowledging limitations:
   - May have implementation context
   - Context contamination risk
   - Degraded vs isolated review

   Applying extra vigilance to compensate.
   ```

2. **Review Execution**

   - Apply same scope classification (SMALL/MEDIUM/LARGE)
   - Use same checklist (A-G)
   - Same fix loop (max 5 rounds)
   - **Difference:** No subagent spawn, persona switch only

3. **Report Tagging**

   All output must include degraded mode indicator:

   ```
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ğŸ“‹ REVIEW COMPLETE [DEGRADED MODE]
   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   âš ï¸  Reviewed without context isolation
   âš ï¸  Objectivity limited by context contamination
   âœ… Checklist applied with extra vigilance

   **Rounds:** N / 5
   **Issues Found:** X critical, Y major, Z minor

   ğŸ’¡ Recommendation: Re-review with isolated agent before production.
      Run: `invar init --claude` then `/review`
   ```

### Configuration

Skip warning with:
```toml
[skills.review]
skip_degraded_warning = true
```
```

**Exit Criteria:**
- âœ… Dual-path æ–‡æ¡£å®Œæ•´
- âœ… Degraded mode æ˜ç¡®æ ‡æ³¨
- âœ… æ£€æµ‹é€»è¾‘æ¸…æ™°æè¿°

---

#### B2: Develop Skill æ”¹é€ 

**File:** `.claude/skills/develop/SKILL.md`

**Changes:**

1. **VALIDATE ç« èŠ‚æ”¹é€ **

   ```markdown
   ### 4. VALIDATE

   - Run `invar_guard()` (full verification)
   - All TodoWrite items complete
   - Integration works (if applicable)

   #### Isolation Requirement (DX-83 Update)

   **For non-trivial implementations, VALIDATE has two modes:**

   | Mode | When | Quality |
   |------|------|---------|
   | **ISOLATED** | Task tool + threshold exceeded | â­â­â­ Objective |
   | **DEGRADED** | No Task tool OR below threshold | â­â­ Self-check |

   **Threshold:** Lines of code in changed files (default: 200)
   - Configure: `[skills.develop].validate_isolation_threshold`

   ---

   **Mode A: ISOLATED (>200 lines OR >3 functions)**

   [Existing isolated validator workflow]

   ---

   **Mode B: DEGRADED (<200 lines OR no Task tool)**

   ```
   ğŸ“ VALIDATE â€” Degraded mode (no isolation)

   âš ï¸  Context contamination risk (you built this code)

   Fallback: Extended self-verification
   â€¢ Running invar_guard (full) âœ…
   â€¢ Manual checklist walk-through âœ…
   â€¢ Explicit bias acknowledgment âš ï¸

   ğŸ’¡ For isolated validation: Use Claude Code
   ```

   **Degraded Checklist:**
   1. Run `invar_guard()` - must pass
   2. Re-read contracts - do they match implementation?
   3. Re-read tests - do they cover edge cases?
   4. Imagine you're the reviewer - what would you question?
   5. Acknowledge: "I built this, bias exists, extra care applied"

   **Report:**
   ```
   âœ“ Final: guard PASS | 0 errors, 2 warnings [SELF-VERIFIED]

   âš ï¸  Validated without isolation (builder bias risk)
   âœ… Guard passed, manual checklist applied
   ğŸ’¡ Recommend: Have isolated review before merge
   ```
   ```

**Exit Criteria:**
- âœ… VALIDATE åŒè·¯å¾„æ–‡æ¡£
- âœ… é˜ˆå€¼é…ç½®åŒ–
- âœ… Degraded mode æ˜ç¡®å±€é™æ€§

---

#### B3: Acceptance & Security ç®€åŒ–

**Files:**
- `.claude/skills/acceptance/SKILL.md`
- `.claude/skills/security/SKILL.md`

**Changes:**

1. **ç®€åŒ–é™çº§è¯´æ˜**
   ```markdown
   ## Execution Modes

   | Mode | Isolation | Default |
   |------|-----------|---------|
   | `--deep` | Isolated subagent | âœ… (auto-downgrade to `--standard` if no Task tool) |
   | `--standard` | Same context | |
   | `--quick` | Same context | |

   **Auto-downgrade behavior:**
   - If `--deep` requested but Task tool not available
   - Silent downgrade to `--standard`
   - Note in output: `[AUTO: deepâ†’standard (no isolation)]`
   ```

2. **æ— éœ€ç”¨æˆ·ç¡®è®¤**
   - Acceptance å’Œ Security çš„é™çº§æ˜¯å¯æ¥å—çš„
   - é™é»˜æ‰§è¡Œï¼Œåªåœ¨è¾“å‡ºä¸­æ ‡æ³¨

**Exit Criteria:**
- âœ… ç®€åŒ–çš„é™çº§é€»è¾‘
- âœ… é™é»˜é™çº§ï¼Œè¾“å‡ºæ ‡æ³¨

---

### Phase C: Documentation Updates

**Goal:** æ›´æ–°é¡¹ç›®æ–‡æ¡£ï¼Œè¯´æ˜ agent èƒ½åŠ›å·®å¼‚

#### C1: CLAUDE.md æ·»åŠ èƒ½åŠ›çŸ©é˜µ

**File:** `CLAUDE.md`

**Section:** åœ¨ "Multi-Agent Support" åæ·»åŠ 

```markdown
## Agent Capability Matrix (DX-83)

| Feature | Claude Code | Pi | Windsurf | Cursor |
|---------|-------------|-----|----------|--------|
| **Task Tool** | âœ… | âŒ | âœ… | âŒ |
| **Subagent Support** | âœ… Full | âŒ None | âœ… Full | âŒ None |
| **Model Access** | sonnet, opus, haiku | sonnet (API) | sonnet, opus | Various (API) |

### Skill Execution Quality

| Skill | With Subagent | Without Subagent |
|-------|---------------|------------------|
| `/review` | â­â­â­ Isolated, adversarial | â­â­ Degraded, persona switch |
| `/develop` VALIDATE | â­â­â­ Isolated validator | â­â­ Self-verification |
| `/acceptance` | â­â­â­ Deep mode | â­â­ Standard mode (auto) |
| `/security` | â­â­â­ Deep mode | â­â­ Standard mode (auto) |

### Recommendations

**For production code:**
- Use agents with Task tool support (Claude Code, Windsurf)
- Skills will use isolated subagents for maximum objectivity

**For development/quick checks:**
- Pi and Cursor work with degraded mode
- Quality reduced but still valuable for iteration

**Configuration:**
- Edit `.invar/config.toml` to customize behavior
- Force degraded mode: `execution_mode = "degraded"`
- Change model preference: `subagent_model = "sonnet"`
```

**Exit Criteria:**
- âœ… èƒ½åŠ›çŸ©é˜µæ¸…æ™°å±•ç¤º
- âœ… è´¨é‡å¯¹æ¯”æ˜ç¡®
- âœ… ä½¿ç”¨å»ºè®®å®ç”¨

---

#### C2: Skill CONFIG.md æ›´æ–°

**æ¯ä¸ª skill çš„ CONFIG.md æ·»åŠ :**

```markdown
## Agent Requirements (DX-83)

**Recommended Capabilities:**
- Task Tool: âœ… For isolated execution
- Model Access: Any (follows config)

**Degraded Mode:**
- Available when Task tool not supported
- Quality: â­â­ (vs â­â­â­ with isolation)
- See SKILL.md â†’ "Mode B: DEGRADED" for details

**Configuration:**
```toml
[skills.review]
execution_mode = "auto"  # auto | isolated | degraded
subagent_model = "inherit"  # inherit | sonnet | opus | haiku
```
```

**Exit Criteria:**
- âœ… æ‰€æœ‰ subagent-dependent skills æ–‡æ¡£æ›´æ–°
- âœ… é…ç½®ç¤ºä¾‹å‡†ç¡®

---

## Implementation Plan

### Phase A: Configuration Infrastructure (1-2 days)
- [ ] A1: åˆ›å»º `config.toml` æ¨¡æ¿
- [ ] A2: å®ç°é…ç½®è¯»å–å‡½æ•°
- [ ] A3: åœ¨ `init` æ—¶ç”Ÿæˆé…ç½®

**Validation:**
```bash
invar init --claude
cat .invar/config.toml  # Should show task_tool_available=true

invar init --pi
cat .invar/config.toml  # Should show task_tool_available=false
```

---

### Phase B: Skill Documentation (2-3 days)
- [ ] B1: Review skill åŒè·¯å¾„æ”¹é€ 
- [ ] B2: Develop skill VALIDATE æ”¹é€ 
- [ ] B3: Acceptance & Security ç®€åŒ–

**Validation:**
```bash
# Claude Code (isolated)
claude /review
# â†’ Should use isolated subagents

# Pi (degraded)
pi /review
# â†’ Should show degraded warning
# â†’ Should use persona switch instead of subagent
```

---

### Phase C: Documentation (1 day)
- [ ] C1: CLAUDE.md èƒ½åŠ›çŸ©é˜µ
- [ ] C2: Skill CONFIG.md æ›´æ–°

**Validation:**
- [ ] æ–‡æ¡£æ¸…æ™°è¯´æ˜å·®å¼‚
- [ ] ç”¨æˆ·èƒ½ç†è§£ä½•æ—¶ç”¨å“ªä¸ª agent

---

### Total Effort: ~5 days

---

## Success Criteria

### Functional

1. **Multi-Agent Compatibility**
   - âœ… åŒä¸€ä»½ skill åœ¨ Claude Code å’Œ Pi éƒ½èƒ½è¿è¡Œ
   - âœ… Claude Code ä½¿ç”¨ isolated mode
   - âœ… Pi ä½¿ç”¨ degraded mode

2. **Configuration**
   - âœ… `invar init` è‡ªåŠ¨æ£€æµ‹å¹¶ç”Ÿæˆé…ç½®
   - âœ… ç”¨æˆ·å¯æ‰‹åŠ¨ç¼–è¾‘é…ç½®è¦†ç›–
   - âœ… Model é€‰æ‹©æ”¯æŒ inherit/sonnet/opus/haiku

3. **Quality Transparency**
   - âœ… Degraded mode æ˜ç¡®æ ‡æ³¨ `[DEGRADED MODE]`
   - âœ… è´¨é‡å·®å¼‚åœ¨æ–‡æ¡£ä¸­è¯´æ˜
   - âœ… ç”¨æˆ·æœ‰æ˜ç¡®é¢„æœŸ

### User Experience

1. **Claude Code ç”¨æˆ·**
   - âœ… æ— æ„ŸçŸ¥ï¼Œè‡ªåŠ¨ä½¿ç”¨æœ€ä½³æ¨¡å¼
   - âœ… å¯è‡ªå®šä¹‰ model åå¥½

2. **Pi ç”¨æˆ·**
   - âœ… å¯ä½¿ç”¨æ‰€æœ‰ skillsï¼ˆé™çº§ï¼‰
   - âœ… æ¸…æ¥šäº†è§£è´¨é‡é™åˆ¶
   - âœ… æ”¶åˆ° Claude Code æ¨èï¼ˆä½†ä¸å¼ºåˆ¶ï¼‰

3. **é…ç½®çµæ´»æ€§**
   - âœ… å¯å¼ºåˆ¶é™çº§ï¼ˆæµ‹è¯•ã€æˆæœ¬æ§åˆ¶ï¼‰
   - âœ… å¯è¦†ç›– model é€‰æ‹©
   - âœ… å¯è·³è¿‡é™çº§è­¦å‘Šï¼ˆCI åœºæ™¯ï¼‰

---

## Risks & Mitigations

### Risk 1: é™çº§è´¨é‡ä¸å¯æ¥å—

**Risk:**
Degraded mode å¯èƒ½ç»™ç”¨æˆ·è™šå‡å®‰å…¨æ„Ÿï¼Œå®é™…è´¨é‡ä¸è¶³ã€‚

**Mitigation:**
1. æ˜ç¡®æ ‡æ³¨ `[DEGRADED MODE]` åœ¨æ‰€æœ‰è¾“å‡º
2. è´¨é‡è¯„çº§ â­â­ vs â­â­â­ åœ¨æ–‡æ¡£ä¸­æ˜¾è‘—å±•ç¤º
3. æ¯æ¬¡é™çº§éƒ½æ¨èåˆ‡æ¢åˆ° Claude Code
4. æŠ¥å‘Šä¸­åŒ…å« "Re-review with isolated agent" å»ºè®®

---

### Risk 2: é…ç½®ç»´æŠ¤è´Ÿæ‹…

**Risk:**
æ–°å¢é…ç½®æ–‡ä»¶å¢åŠ ç”¨æˆ·å­¦ä¹ æˆæœ¬ã€‚

**Mitigation:**
1. é…ç½®æ–‡ä»¶æœ‰è¯¦ç»†æ³¨é‡Š
2. `invar init` è‡ªåŠ¨ç”Ÿæˆï¼Œå¤§å¤šæ•°ç”¨æˆ·ä¸éœ€è¦æ‰‹åŠ¨ç¼–è¾‘
3. é»˜è®¤å€¼ (`inherit`, `auto`) é€‚ç”¨ 90% åœºæ™¯
4. æ–‡æ¡£æä¾›å¸¸è§é…ç½®ç¤ºä¾‹

---

### Risk 3: æ£€æµ‹é€»è¾‘å¤±æ•ˆ

**Risk:**
Agent èƒ½åŠ›æ£€æµ‹å¯èƒ½ä¸å‡†ç¡®ï¼ˆå¦‚ç¯å¢ƒå˜åŒ–ï¼‰ã€‚

**Mitigation:**
1. ç”¨æˆ·å¯æ‰‹åŠ¨è¦†ç›–é…ç½®
2. Skill å…¥å£å¤„äºŒæ¬¡æ£€æŸ¥ï¼ˆå°è¯•åˆ—å‡º available toolsï¼‰
3. å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œé»˜è®¤é™çº§ï¼ˆä¿å®ˆç­–ç•¥ï¼‰
4. ç¯å¢ƒå˜é‡æ”¯æŒï¼š`INVAR_FORCE_DEGRADED=1`

---

## Future Work

### DX-84: Runtime Capability Probing

å½“å‰æ£€æµ‹ä¾èµ–é™æ€é…ç½®å’Œå¯å‘å¼ï¼Œæœªæ¥å¯å®ç°è¿è¡Œæ—¶æ¢æµ‹ï¼š

```python
def probe_task_tool() -> bool:
    """Runtime probe for Task tool availability."""
    # Check if Task in available_tools list
    # Or attempt no-op call with error handling
```

### DX-85: Cross-Agent Quality Benchmarking

æ”¶é›†æ•°æ®å¯¹æ¯” isolated vs degraded çš„å®é™…è´¨é‡å·®å¼‚ï¼š
- Issues found ratio
- False positive rate
- User satisfaction

### DX-86: Partial Isolation Strategies

æ¢ç´¢ä¸­é—´æ–¹æ¡ˆï¼š
- Conversation forking (if agent supports)
- External review service (API call to isolated environment)
- Hybrid: automated checks degraded, manual review isolated

---

## References

- DX-81: Multi-Agent Init Support
- DX-75: Attention-Aware Review Framework (scope classification)
- Claude Code Task Tool Documentation
- Pi Custom Tools API Documentation

---

## Discussion Points

1. **Review é™çº§çš„æœ€å°å¯è¡Œè´¨é‡** - â­â­ æ˜¯å¦è¶³å¤Ÿï¼Ÿè¿˜æ˜¯åº”è¯¥ hard failï¼Ÿ
2. **Model é…ç½®é»˜è®¤å€¼** - `inherit` vs `sonnet` vs skill-specificï¼Ÿ
3. **æ£€æµ‹æ—¶æœº** - Init-time é…ç½® vs Runtime æ¢æµ‹çš„æƒè¡¡ï¼Ÿ
4. **ç”¨æˆ·æ•™è‚²** - å¦‚ä½•è®©ç”¨æˆ·ç†è§£ isolated vs degraded çš„å·®å¼‚ï¼Ÿ

---

**Next Steps:**
1. Review proposal with team
2. Decide on degraded mode quality threshold
3. Prioritize implementation phases
4. Create implementation tasks in backlog
