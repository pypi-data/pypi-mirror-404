# DX-22: æ™ºèƒ½éªŒè¯ç­–ç•¥

> **"æ­£ç¡®çš„å·¥å…·ç”¨äºæ­£ç¡®çš„ä»£ç ï¼Œå¼ºåˆ¶æ‰§è¡Œè€Œéå»ºè®®"**

## çŠ¶æ€

- **ID**: DX-22
- **çŠ¶æ€**: Implemented (100%)
- **ä¾èµ–**: DX-12 (Hypothesis fallback), DX-13 (Incremental prove)
- **å…³è”**: DX-23 (Entry point detection)

### å®ç°è¿›åº¦

| Part | æè¿° | çŠ¶æ€ | å®ç° |
|------|------|------|------|
| Part 1 | æ™ºèƒ½éªŒè¯åˆ†æµ | âœ… | `verification_routing.py` |
| Part 2 | Shell æ¶æ„è§„åˆ™ | âœ… | `shell_architecture.py`, `rule_meta.py` |
| Part 3 | Fix-or-Explain å¼ºåˆ¶ | âœ… | `@shell_complexity`, `@invar:allow` markers |
| Part 4 | å»é‡ç»Ÿè®¡ | âœ… | `crosshair_proven`, `hypothesis_tested` in output |
| Part 5 | é…ç½®ç®€åŒ– | âœ… | `auto_detect_module_type()` in `config.py` |

## é—®é¢˜é™ˆè¿°

å½“å‰éªŒè¯ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **é‡å¤éªŒè¯**: CrossHair å’Œ Hypothesis éƒ½è¿è¡Œåœ¨ç›¸åŒä»£ç ä¸Šï¼Œæµªè´¹æ—¶é—´
2. **é”™è¯¯åˆ†ç±»**: C æ‰©å±•ä»£ç å°è¯• CrossHair åå¤±è´¥ï¼Œæ²¡æœ‰æ™ºèƒ½ fallback
3. **Shell æ— è¦†ç›–**: Shell æ¨¡å—å®Œå…¨æ²¡æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæ¶æ„é—®é¢˜æ— äººæ£€æµ‹
4. **ç»Ÿè®¡è¯¯å¯¼**: è¦†ç›–ç‡é‡å¤è®¡ç®—ï¼Œä¸åŒºåˆ†"è¯æ˜"å’Œ"æµ‹è¯•"
5. **è­¦å‘Šè¢«å¿½ç•¥**: INFO/WARNING çº§åˆ«çš„å»ºè®® Agent å¯ä»¥ç›´æ¥è·³è¿‡

## è®¾è®¡åŸåˆ™

### Agent-Native

```
è‡ªåŠ¨ > æ‰‹åŠ¨
é»˜è®¤æ­£ç¡® > éœ€è¦é…ç½®
é›¶å†³ç­– > å¤šé€‰é¡¹
å¼ºåˆ¶æ‰§è¡Œ > å»ºè®®å¿½ç•¥
```

### é…ç½®æç®€

```
âŒ ä¸è¦: æš´éœ²æ¯ä¸ªå†…éƒ¨å‚æ•°
âœ… è¦: åªä¿ç•™äººç±»çœŸæ­£éœ€è¦è°ƒæ•´çš„é€‰é¡¹
```

### Fix-or-Explain

```
âŒ ä¸è¦: è­¦å‘Šå¯ä»¥æ— é™å¿½ç•¥
âœ… è¦: å¿…é¡»ä¿®å¤ OR æ˜¾å¼è¯´æ˜ç†ç”±
```

---

## è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DX-22 æ ¸å¿ƒæ”¹è¿›                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. æ™ºèƒ½éªŒè¯åˆ†æµ                                                    â”‚
â”‚     Core + çº¯ Python  â†’ CrossHair (è¯æ˜)                            â”‚
â”‚     Core + C æ‰©å±•     â†’ Hypothesis (æµ‹è¯•)  â† è‡ªåŠ¨æ£€æµ‹               â”‚
â”‚     Shell             â†’ Doctests + æ¶æ„è§„åˆ™                         â”‚
â”‚                                                                     â”‚
â”‚  2. Shell æ¶æ„è§„åˆ™ (è¯¦è§ DX-23)                                     â”‚
â”‚     shell_pure_logic  â†’ ERROR (å¿…é¡»ç§»åˆ° Core)                       â”‚
â”‚     shell_too_complex â†’ INFO + æ¨¡å¼æ£€æµ‹ + é‡æ„å»ºè®®                  â”‚
â”‚     entry_point       â†’ æ¡†æ¶å›è°ƒè±å… Resultï¼Œä½†éœ€ä¿æŒç²¾ç®€           â”‚
â”‚                                                                     â”‚
â”‚  3. Fix-or-Explain å¼ºåˆ¶                                             â”‚
â”‚     å•ä¸ªè­¦å‘Š â†’ æ˜¾ç¤ºå»ºè®®                                             â”‚
â”‚     ç´¯ç§¯ 5+ â†’ ERROR é˜»æ­¢                                            â”‚
â”‚     @shell_complexity æ ‡è®° â†’ è§£é™¤è­¦å‘Š                               â”‚
â”‚                                                                     â”‚
â”‚  4. å»é‡ç»Ÿè®¡                                                        â”‚
â”‚     CrossHair è¯æ˜çš„ â†’ ä¸é‡å¤è®¡å…¥ Hypothesis                        â”‚
â”‚     åˆ†ç±»æ˜¾ç¤ºè¯æ˜/æµ‹è¯•è¦†ç›–ç‡                                         â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 1: æ™ºèƒ½éªŒè¯åˆ†æµ

### 1.1 ä»£ç è‡ªåŠ¨åˆ†ç±»

```
æ–‡ä»¶è‡ªåŠ¨åˆ†ç±»ï¼ˆæ— éœ€é…ç½®ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥: Python æ–‡ä»¶                                           â”‚
â”‚                                                             â”‚
â”‚ åˆ†æ:                                                       â”‚
â”‚   1. æ£€æµ‹ import è¯­å¥ â†’ æ˜¯å¦æœ‰ C æ‰©å±•åº“                     â”‚
â”‚   2. æ£€æµ‹ @pre/@post å¥‘çº¦ â†’ æ˜¯å¦å¯éªŒè¯                      â”‚
â”‚   3. æ£€æµ‹ Core/Shell åˆ†ç±» â†’ é€‚ç”¨ä»€ä¹ˆè§„åˆ™                    â”‚
â”‚                                                             â”‚
â”‚ è¾“å‡º:                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ç±»å‹        â”‚ éªŒè¯ç­–ç•¥      â”‚ ç¤ºä¾‹                   â”‚  â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚   â”‚ Core+çº¯Py   â”‚ CrossHair    â”‚ parser.py, rules.py    â”‚  â”‚
â”‚   â”‚ Core+Cæ‰©å±•  â”‚ Hypothesis   â”‚ (å¦‚æœ‰ numpy ä¾èµ–)      â”‚  â”‚
â”‚   â”‚ Shell       â”‚ Doctests     â”‚ cli.py, fs.py          â”‚  â”‚
â”‚   â”‚ æ— å¥‘çº¦      â”‚ è·³è¿‡         â”‚ __init__.py            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 éªŒè¯æµç¨‹

```python
def smart_verify(file: Path) -> VerificationResult:
    """æ™ºèƒ½é€‰æ‹©éªŒè¯ç­–ç•¥ - Agent-Native: é›¶å†³ç­–"""

    source = file.read_text()
    has_contracts = detect_contracts(source)
    is_pure_python = not has_incompatible_imports(source)
    is_core = file_info.is_core

    if not has_contracts:
        return Skip("no_contracts")

    if is_core and is_pure_python:
        # Core + çº¯ Python: CrossHair ä¼˜å…ˆ
        result = run_crosshair(file)
        if result.proven:
            return Proven(tool="crosshair")  # æ— éœ€ Hypothesis
        if result.error or result.timeout:
            return run_hypothesis(file)      # Fallback
        return result

    if is_core and not is_pure_python:
        # Core + Cæ‰©å±•: ç›´æ¥ Hypothesisï¼ˆä¸æµªè´¹æ—¶é—´å°è¯• CrossHairï¼‰
        return run_hypothesis(file)

    # Shell: ä»… Doctests + æ¶æ„è§„åˆ™
    return Skip("shell_doctest_only")
```

### 1.3 ä¸å…¼å®¹åº“æ£€æµ‹ï¼ˆå†…ç½®ï¼‰

```python
# å†…ç½®é»‘åå• - ä¸æš´éœ²ä¸ºé…ç½®é¡¹
CROSSHAIR_INCOMPATIBLE = frozenset([
    # C æ‰©å±• (æ— æ³•ç¬¦å·åŒ–)
    "numpy", "pandas", "scipy", "sklearn",
    "torch", "tensorflow", "cv2", "PIL",
    # ç½‘ç»œ I/O (éç¡®å®šæ€§)
    "requests", "aiohttp", "httpx",
    # ç³»ç»Ÿè°ƒç”¨ (å‰¯ä½œç”¨)
    "subprocess", "multiprocessing",
])

def has_incompatible_imports(source: str) -> bool:
    """æ£€æµ‹æ˜¯å¦åŒ…å« CrossHair ä¸å…¼å®¹çš„åº“"""
    for lib in CROSSHAIR_INCOMPATIBLE:
        if f"import {lib}" in source or f"from {lib}" in source:
            return True
    return False
```

### 1.4 å»é‡ç»Ÿè®¡æŠ¥å‘Š

```
æ”¹è¿›å‰ (é‡å¤è®¡ç®—ï¼Œè¯¯å¯¼):
  CrossHair: 149/149 âœ“
  Hypothesis: 149/149 âœ“     â† é‡å¤ï¼
  Doctests: 149/149 âœ“

æ”¹è¿›å (å»é‡ + åˆ†ç±»):
  Core éªŒè¯:
    âœ“ è¯æ˜ (CrossHair): 130 å‡½æ•°    â† æ•°å­¦ä¿è¯
    âœ“ æµ‹è¯• (Hypothesis): 19 å‡½æ•°    â† Cæ‰©å±•è‡ªåŠ¨æ£€æµ‹
  Shell éªŒè¯:
    âœ“ æ–‡æ¡£ç¤ºä¾‹: 88 å‡½æ•°

  æ€»è®¡: 237/237 å‡½æ•°å·²éªŒè¯
  è¯æ˜çº§è¦†ç›–: 130/149 Core (87%)    â† æ–°æŒ‡æ ‡
```

---

## Part 2: Shell æ¶æ„è§„åˆ™

### 2.1 è§„åˆ™å®šä¹‰

| è§„åˆ™ | çº§åˆ« | è§¦å‘æ¡ä»¶ | åŸå›  |
|------|------|----------|------|
| `shell_pure_logic` | **ERROR** | Shell å‡½æ•°æ—  I/O æ“ä½œ | æ¶æ„è¿è§„ï¼Œçº¯é€»è¾‘å¿…é¡»åœ¨ Core |
| `shell_too_complex` | **INFO** | Shell å‡½æ•°åˆ†æ”¯ > é˜ˆå€¼ | å¯èƒ½åˆç†ï¼Œéœ€å®¡æŸ¥æˆ–è¯´æ˜ |
| `entry_point_too_thick` | **WARNING** | Entry point > 15 è¡Œ | åº”ç²¾ç®€ï¼Œå§”æ‰˜ç»™ Shell å‡½æ•° |

> **æ³¨:** `shell_result` è§„åˆ™å’Œ `entry_point_too_thick` è§„åˆ™çš„è¯¦ç»†è®¾è®¡è§ [DX-23](./DX-23-entry-point-detection.md)ã€‚
> Entry point æ˜¯ Shell çš„å­ç±»å‹ï¼Œç”¨äºå¤„ç†æ¡†æ¶å›è°ƒ (Flask routes, Typer commands ç­‰)ã€‚

### 2.2 shell_pure_logic (ERROR)

**ä¸ºä»€ä¹ˆæ˜¯ ERRORï¼š**
- Shell çš„å®šä¹‰å°±æ˜¯ "I/O å±‚"
- çº¯é€»è¾‘åœ¨ Shell = æ— æ³•ç”¨å¥‘çº¦æµ‹è¯• = æ— æ³•ç”¨ CrossHair éªŒè¯
- è¿™æ˜¯æ¶æ„é”™è¯¯ï¼Œä¸æ˜¯é£æ ¼é—®é¢˜
- **æ€»æœ‰è§£å†³æ–¹æ¡ˆï¼šç§»åˆ° Core**

```python
# æ£€æµ‹é€»è¾‘
IO_INDICATORS = [
    ".read(", ".write(", ".read_text(", ".write_text(",
    "open(", "Path(",
    "subprocess.", "os.system(",
    "requests.", "aiohttp.",
    "print(", "console.", "typer.",
    "Success(", "Failure(",  # Result åŒ…è£…æ˜¯ Shell ç‰¹å¾
]

def has_io_operations(source: str) -> bool:
    return any(indicator in source for indicator in IO_INDICATORS)

# è§„åˆ™
if not has_io and sym.lines > 5:  # æ’é™¤ç®€å• wrapper
    return Violation(
        rule="shell_pure_logic",
        severity=Severity.ERROR,  # é˜»æ­¢ï¼
        message=f"'{sym.name}' has no I/O - pure logic belongs in Core",
        suggestion="Move to src/invar/core/ and add @pre/@post contracts",
    )
```

### 2.3 shell_too_complex (INFO + æ™ºèƒ½å»ºè®®)

**ä¸ºä»€ä¹ˆæ˜¯ INFOï¼š**
- æœ‰æ—¶å¤æ‚åº¦æ˜¯åˆç†çš„ï¼ˆCLI å‚æ•°ã€å¤šæºé…ç½®ã€é”™è¯¯å¤„ç†ï¼‰
- ä¸åº”é˜»æ­¢ï¼Œä½†åº”å¼•å¯¼ Agent å°è¯•è§£å†³

**æ™ºèƒ½æ¨¡å¼æ£€æµ‹ï¼š**

```python
class BranchPattern(Enum):
    TYPE_DISPATCH = "type_dispatch"      # if type == "a" elif type == "b"
    ERROR_HANDLING = "error_handling"    # except A: ... except B: ...
    CONFIG_CASCADE = "config_cascade"    # if exists(a) elif exists(b)
    NESTED_CONDITIONS = "nested"         # if: if: if:
    VALIDATION_CHAIN = "validation"      # if not x: return; if not y: return
    UNKNOWN = "unknown"
```

**é’ˆå¯¹æ€§é‡æ„å»ºè®®ï¼š**

```python
REFACTORING_TEMPLATES = {
    BranchPattern.TYPE_DISPATCH: """
# 1. Core: è¡¨é©±åŠ¨åˆ†å‘ (å¯æµ‹è¯•)
HANDLERS = {"a": handle_a, "b": handle_b, ...}

@pre(lambda key: key in HANDLERS)
def get_handler(key: str) -> Callable:
    return HANDLERS[key]

# 2. Shell: å•è¡Œè°ƒç”¨
def process(key, *args):
    return get_handler(key)(*args)
""",

    BranchPattern.CONFIG_CASCADE: """
# 1. Core: å®šä¹‰ä¼˜å…ˆçº§ (å¯æµ‹è¯•)
CONFIG_SOURCES = [
    ("pyproject.toml", ["tool", "invar", "guard"]),
    ("invar.toml", ["guard"]),
]

# 2. Shell: ç®€å•è¿­ä»£
def load_config(root):
    for filename, keys in CONFIG_SOURCES:
        if (root / filename).exists():
            return extract_nested(load_toml(root / filename), keys)
    return {}
""",
    # ... å…¶ä»–æ¨¡å¼
}
```

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
INFO shell_too_complex at src/invar/shell/config.py:42

  Function 'load_config' has 5 branches (config_cascade pattern)

  **Recommended Refactoring**:
  ```python
  # 1. Core: å®šä¹‰ä¼˜å…ˆçº§ (å¯æµ‹è¯•)
  CONFIG_SOURCES = [...]

  # 2. Shell: ç®€å•è¿­ä»£
  def load_config(root):
      for filename, keys in CONFIG_SOURCES:
          ...
  ```

  **If complexity is necessary**, add marker:
  ```python
  # @shell_complexity: Multi-source config with fallback logic
  def load_config(...):
  ```
```

---

## Part 3: Fix-or-Explain å¼ºåˆ¶æœºåˆ¶

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦å¼ºåˆ¶

```
é—®é¢˜: INFO çº§åˆ«è­¦å‘Š Agent ä¼šç›´æ¥å¿½ç•¥
è§£å†³: ç´¯ç§¯é˜ˆå€¼ + æ˜¾å¼æ ‡è®°æœºåˆ¶
```

### 3.2 @shell_complexity æ ‡è®°

```python
# æ–¹å¼ 1: ä¿®å¤é—®é¢˜
def simple_function():  # âœ“ é€šè¿‡
    ...

# æ–¹å¼ 2: æ˜¾å¼è¯´æ˜ç†ç”±
# @shell_complexity: CLI å‚æ•°è§£æï¼Œtyper å›è°ƒå¿…éœ€
def complex_but_justified():  # âœ“ é€šè¿‡ï¼ˆå·²è¯´æ˜ï¼‰
    ...

# æ— æ•ˆ: å¿½ç•¥è­¦å‘Š
def ignored():  # âœ— ç´¯ç§¯åé˜»æ­¢
    ...
```

### 3.3 ç´¯ç§¯é˜ˆå€¼

```python
def check_complexity_debt(project_violations: list[Violation]) -> list[Violation]:
    """é¡¹ç›®çº§å¤æ‚åº¦å€ºåŠ¡æ£€æŸ¥"""

    unaddressed = [v for v in project_violations
                   if v.rule == "shell_too_complex"]

    if len(unaddressed) >= 5:  # ç´¯ç§¯é˜ˆå€¼
        return [Violation(
            rule="shell_complexity_debt",
            severity=Severity.ERROR,  # é˜»æ­¢ï¼
            message=f"Project has {len(unaddressed)} unaddressed complexity warnings",
            suggestion=(
                "You must address these before proceeding:\n"
                "1. Refactor following suggestions, OR\n"
                "2. Add @shell_complexity: markers with justification"
            ),
        )]
    return []
```

### 3.4 å¼ºåˆ¶æ€§ä¿è¯é“¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼ºåˆ¶æ€§é“¾æ¡ï¼ˆä¸å¯ç»•è¿‡ï¼‰                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å±‚çº§ 1: å•å‡½æ•°                                                 â”‚
â”‚    shell_pure_logic     â†’ ERROR ç«‹å³é˜»æ­¢                        â”‚
â”‚    shell_too_complex    â†’ INFO æ˜¾ç¤ºå»ºè®®                         â”‚
â”‚                                                                 â”‚
â”‚  å±‚çº§ 2: é¡¹ç›®ç´¯ç§¯                                               â”‚
â”‚    æœªå¤„ç† too_complex >= 5 â†’ ERROR é˜»æ­¢                         â”‚
â”‚                                                                 â”‚
â”‚  å±‚çº§ 3: Pre-commit                                             â”‚
â”‚    --strict æ¨¡å¼ â†’ æ‰€æœ‰ WARNING ä¹Ÿé˜»æ­¢                          â”‚
â”‚                                                                 â”‚
â”‚  è§£é™¤æ–¹å¼ï¼ˆä»…ä¸¤ç§ï¼‰:                                            â”‚
â”‚    âœ“ é‡æ„ä»£ç                                                    â”‚
â”‚    âœ“ æ·»åŠ  @shell_complexity: æ ‡è®°è¯´æ˜ç†ç”±                       â”‚
â”‚                                                                 â”‚
â”‚  æ— æ•ˆæ–¹å¼:                                                      â”‚
â”‚    âœ— å¿½ç•¥ï¼ˆç´¯ç§¯åé˜»æ­¢ï¼‰                                         â”‚
â”‚    âœ— å…³é—­è§„åˆ™ï¼ˆä¸æä¾›æ­¤é…ç½®ï¼‰                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part 4: é…ç½®ï¼ˆæç®€ï¼‰

```toml
# pyproject.toml - ä»… 2 ä¸ªæ–°é€‰é¡¹

[tool.invar.guard]
# ç°æœ‰é…ç½®ä¿æŒä¸å˜
max_file_lines = 500
max_function_lines = 50
require_contracts = true
require_doctests = true

# DX-22 æ–°å¢
shell_max_branches = 3              # Shell å‡½æ•°åˆ†æ”¯é˜ˆå€¼
shell_complexity_debt_limit = 5     # ç´¯ç§¯è­¦å‘Šé˜ˆå€¼ï¼ˆå¯é€‰ï¼‰
entry_max_lines = 15                # Entry point æœ€å¤§è¡Œæ•° (DX-23)
```

**é…ç½®å†³ç­–ï¼š**

| æ½œåœ¨é…ç½® | å†³å®š | åŸå›  |
|---------|------|------|
| `crosshair_timeout` | âŒ ä¸æš´éœ² | å†…éƒ¨è‡ªé€‚åº” |
| `hypothesis_examples` | âŒ ä¸æš´éœ² | 100 æ˜¯åˆç†é»˜è®¤ |
| `incompatible_libs` | âŒ ä¸æš´éœ² | å†…ç½®é»‘åå•è¶³å¤Ÿ |
| `shell_max_branches` | âœ… æš´éœ² | é¡¹ç›®é£æ ¼å·®å¼‚ |
| `shell_complexity_debt_limit` | âœ… æš´éœ² | ä¸¥æ ¼é¡¹ç›®å¯è°ƒä½ |
| `entry_max_lines` | âœ… æš´éœ² | Entry point å¤§å°é™åˆ¶ (DX-23) |
| `entry_point_patterns` | âŒ ä¸æš´éœ² | å†…ç½®å¸¸è§æ¡†æ¶ï¼ŒAgent-Native (DX-23) |
| `disable_shell_rules` | âŒ ä¸æä¾› | ä¸å…è®¸å…³é—­æ¶æ„æ£€æŸ¥ |

---

## Part 5: ç°æœ‰é…ç½®ç®€åŒ–

### 5.1 ç°çŠ¶åˆ†æ

å½“å‰ `pyproject.toml` æœ‰ **16+ é…ç½®é¡¹**ï¼š

```toml
[tool.invar.guard]
core_paths = [...]              # 1. ç›®å½•åˆ†ç±»
shell_paths = [...]             # 2. ç›®å½•åˆ†ç±»
max_file_lines = 500            # 3. å¤§å°é™åˆ¶
max_function_lines = 50         # 4. å¤§å°é™åˆ¶
require_contracts = true        # 5. Core è¦æ±‚
require_doctests = true         # 6. Core è¦æ±‚
forbidden_imports = [...]       # 7. ç¦æ­¢å¯¼å…¥åˆ—è¡¨
exclude_paths = [...]           # 8. æ’é™¤è·¯å¾„
strict_pure = true              # 9. çº¯åº¦æ£€æŸ¥
use_code_lines = false          # 10. è¡Œæ•°è®¡ç®—æ–¹å¼
exclude_doctest_lines = true    # 11. è¡Œæ•°è®¡ç®—æ–¹å¼

[tool.invar.guard.severity_overrides]
partial_contract = "off"        # 12. ä¸¥é‡åº¦è¦†ç›–

[[tool.invar.guard.rule_exclusions]]
pattern = "..."                 # 13-16. è§„åˆ™æ’é™¤ï¼ˆå¤šä¸ªï¼‰
rules = [...]

[tool.invar]
protocol_version = "..."        # 17. åè®®ç‰ˆæœ¬
protocol_evolution = "..."      # 18. åè®®æ¼”è¿›
test_style = "..."              # 19. æµ‹è¯•é£æ ¼
```

### 5.2 ç®€åŒ–æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é…ç½®ç®€åŒ–: 16+ â†’ 6 é¡¹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âœ… ä¿ç•™ (äººç±»çœŸæ­£éœ€è¦)                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  exclude_paths          é¡¹ç›®ç»“æ„å·®å¼‚å¤§ï¼Œå¿…é¡»æ‰‹åŠ¨æŒ‡å®š                         â”‚
â”‚  max_file_lines         é£æ ¼åå¥½ï¼Œä½†æœ‰åˆç†é»˜è®¤ (500)                         â”‚
â”‚  max_function_lines     é£æ ¼åå¥½ï¼Œä½†æœ‰åˆç†é»˜è®¤ (50)                          â”‚
â”‚  shell_max_branches     DX-22 æ–°å¢ï¼ŒShell åˆ†æ”¯é˜ˆå€¼                          â”‚
â”‚  shell_complexity_debt  DX-22 æ–°å¢ï¼Œç´¯ç§¯è­¦å‘Šé˜ˆå€¼                            â”‚
â”‚  entry_max_lines        DX-23 æ–°å¢ï¼ŒEntry point å¤§å°é™åˆ¶                    â”‚
â”‚                                                                             â”‚
â”‚  ğŸ”„ è‡ªåŠ¨æ£€æµ‹ (Agent-Native)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  core_paths             â†’ æ£€æµ‹ */core/** æˆ–åŒ…å«å¥‘çº¦çš„æ¨¡å—                    â”‚
â”‚  shell_paths            â†’ æ£€æµ‹ */shell/** æˆ–åŒ…å« Result çš„æ¨¡å—              â”‚
â”‚  require_contracts      â†’ Core è‡ªåŠ¨è¦æ±‚ï¼ŒShell è‡ªåŠ¨è±å…                     â”‚
â”‚  require_doctests       â†’ Core è‡ªåŠ¨è¦æ±‚ï¼ŒShell è‡ªåŠ¨è±å…                     â”‚
â”‚                                                                             â”‚
â”‚  ğŸ”’ ç¡¬ç¼–ç  (åˆç†é»˜è®¤)                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  forbidden_imports      æ ‡å‡† I/O åº“åˆ—è¡¨ï¼Œæ— éœ€è‡ªå®šä¹‰                          â”‚
â”‚  strict_pure            å§‹ç»ˆ ONï¼Œçº¯åº¦æ£€æŸ¥æ˜¯æ ¸å¿ƒåŠŸèƒ½                          â”‚
â”‚  protocol_version       å†…éƒ¨ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯¹ç”¨æˆ·æ— æ„ä¹‰                           â”‚
â”‚  protocol_evolution     å†…éƒ¨ï¼Œç”±é¡¹ç›®ç»´æŠ¤è€…å†³å®š                               â”‚
â”‚                                                                             â”‚
â”‚  âŒ ç§»é™¤/ç®€åŒ–                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  use_code_lines         â†’ åˆå¹¶ä¸ºå•ä¸€é»˜è®¤è¡Œä¸º                                 â”‚
â”‚  exclude_doctest_lines  â†’ åˆå¹¶ä¸ºå•ä¸€é»˜è®¤è¡Œä¸º                                 â”‚
â”‚  severity_overrides     â†’ å¦‚æœé»˜è®¤æ­£ç¡®åˆ™ä¸éœ€è¦                               â”‚
â”‚  rule_exclusions        â†’ æ”¹ç”¨ä»£ç å†…æ ‡è®° (è§ 5.3)                            â”‚
â”‚  test_style             â†’ è‡ªåŠ¨æ£€æµ‹ (æœ‰ tests/ åˆ™ separate)                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 é…ç½® vs ä»£ç å†…æ ‡è®°

**é—®é¢˜:** `rule_exclusions` é…ç½®å¤æ‚ä¸”è¿œç¦»ä»£ç 

```toml
# å½“å‰: é…ç½®æ–‡ä»¶ä¸­ï¼ˆè¿œç¦»ä»£ç ï¼‰
[[tool.invar.guard.rule_exclusions]]
pattern = "**/hypothesis_strategies.py"
rules = ["internal_import"]
```

**æ”¹è¿›:** ä»£ç å†…æ ‡è®°ï¼ˆå°±è¿‘åŸåˆ™ï¼‰

```python
# æ”¹è¿›: ä»£ç æ–‡ä»¶ä¸­ï¼ˆå°±åœ¨éœ€è¦çš„åœ°æ–¹ï¼‰
# @invar:allow internal_import - Lazy imports for optional hypothesis/numpy
from invar.core.timeout_inference import infer_timeout
```

**ä¼˜åŠ¿:**
- ç†ç”±å°±åœ¨ä»£ç æ—è¾¹ï¼ŒAgent å¯ä»¥ç†è§£
- ä¸éœ€è¦ç»´æŠ¤é…ç½®æ–‡ä»¶
- æ›´ç²¾ç¡®ï¼ˆå‡½æ•°çº§åˆ« vs æ–‡ä»¶çº§åˆ«ï¼‰

### 5.4 ç®€åŒ–åçš„é…ç½®

```toml
# pyproject.toml - ç®€åŒ–å (6 é¡¹)

[tool.invar.guard]
# è·¯å¾„æ’é™¤ (é¡¹ç›®å·®å¼‚)
exclude_paths = ["tests", "scripts", ".venv"]

# å¤§å°é™åˆ¶ (é£æ ¼åå¥½ï¼Œå¯é€‰)
# max_file_lines = 500       # é»˜è®¤ 500ï¼Œé€šå¸¸ä¸éœ€è¦æ”¹
# max_function_lines = 50    # é»˜è®¤ 50ï¼Œé€šå¸¸ä¸éœ€è¦æ”¹

# Shell å¤æ‚åº¦ (DX-22ï¼Œå¯é€‰)
# shell_max_branches = 3     # é»˜è®¤ 3ï¼Œé€šå¸¸ä¸éœ€è¦æ”¹
# shell_complexity_debt = 5  # é»˜è®¤ 5ï¼Œé€šå¸¸ä¸éœ€è¦æ”¹

# Entry point (DX-23ï¼Œå¯é€‰)
# entry_max_lines = 15       # é»˜è®¤ 15ï¼Œé€šå¸¸ä¸éœ€è¦æ”¹
```

**å¯¹æ¯”:**

| æŒ‡æ ‡ | ç®€åŒ–å‰ | ç®€åŒ–å |
|------|--------|--------|
| é…ç½®é¡¹æ•°é‡ | 16+ | 6 (5 å¯é€‰) |
| å¿…é¡»é…ç½® | å¤šé¡¹ | ä»… exclude_paths |
| å†³ç­–ç‚¹ | å¤š | æå°‘ |
| é…ç½®æ–‡ä»¶è¡Œæ•° | ~50 | ~12 |

### 5.5 è‡ªåŠ¨æ£€æµ‹é€»è¾‘

```python
def auto_detect_module_type(file_path: Path, source: str) -> ModuleType:
    """è‡ªåŠ¨æ£€æµ‹æ¨¡å—ç±»å‹ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½® core_paths/shell_paths"""

    # 1. è·¯å¾„çº¦å®š
    if "/core/" in str(file_path) or file_path.parent.name == "core":
        return ModuleType.CORE
    if "/shell/" in str(file_path) or file_path.parent.name == "shell":
        return ModuleType.SHELL

    # 2. ç‰¹å¾æ£€æµ‹
    has_contracts = "@pre(" in source or "@post(" in source
    has_result = "Result[" in source or "Success(" in source or "Failure(" in source
    has_io = any(ind in source for ind in IO_INDICATORS)

    if has_contracts and not has_io:
        return ModuleType.CORE
    if has_result or has_io:
        return ModuleType.SHELL

    # 3. é»˜è®¤: æ™®é€šæ¨¡å—
    return ModuleType.UNKNOWN
```

### 5.6 è¿ç§»è·¯å¾„

```
é˜¶æ®µ A: æ”¯æŒä¸¤ç§æ–¹å¼ (å‘åå…¼å®¹)
  - æ—§é…ç½®ç»§ç»­å·¥ä½œ
  - æ–°è‡ªåŠ¨æ£€æµ‹åŒæ—¶ç”Ÿæ•ˆ
  - æ˜¾å¼é…ç½®è¦†ç›–è‡ªåŠ¨æ£€æµ‹

é˜¶æ®µ B: å¼ƒç”¨è­¦å‘Š
  - æ£€æµ‹åˆ°æ—§é…ç½®é¡¹æ—¶æ˜¾ç¤ºè­¦å‘Š
  - æç¤ºä½¿ç”¨ä»£ç å†…æ ‡è®°æ›¿ä»£

é˜¶æ®µ C: ç§»é™¤æ—§é…ç½® (ä¸‹ä¸€å¤§ç‰ˆæœ¬)
  - ç§»é™¤ core_paths, shell_paths ç­‰
  - ä»…ä¿ç•™ç®€åŒ–åçš„ 5 é¡¹
```

---

## å®ç°è®¡åˆ’

### é˜¶æ®µ 1: æ™ºèƒ½åˆ†ç±» (ä½é£é™©)

```
æ–‡ä»¶: src/invar/shell/prove.py
æ”¹åŠ¨:
  1. æ·»åŠ  has_incompatible_imports() æ£€æµ‹
  2. ä¿®æ”¹éªŒè¯æµç¨‹è·³è¿‡ä¸å…¼å®¹æ–‡ä»¶
  3. è‡ªåŠ¨ fallback åˆ° Hypothesis
```

### é˜¶æ®µ 2: å»é‡ç»Ÿè®¡ (ä½é£é™©)

```
æ–‡ä»¶: src/invar/shell/guard_output.py
æ”¹åŠ¨:
  1. åˆ†ç±»æ˜¾ç¤ºç»“æœ
  2. æ·»åŠ "è¯æ˜çº§è¦†ç›–"æŒ‡æ ‡
```

### é˜¶æ®µ 3: Shell è§„åˆ™ (ä¸­é£é™©)

```
æ–‡ä»¶: src/invar/core/rules.py, src/invar/core/rule_meta.py
æ”¹åŠ¨:
  1. æ·»åŠ  check_shell_architecture() è§„åˆ™
  2. æ·»åŠ  I/O æ£€æµ‹å’Œåˆ†æ”¯è®¡æ•°
  3. æ·»åŠ æ¨¡å¼æ£€æµ‹å’Œå»ºè®®ç”Ÿæˆ

ä¾èµ–: DX-23 Entry Point æ£€æµ‹
  - shell_result è§„åˆ™ä¿®æ”¹ (è·³è¿‡ entry points)
  - entry_point_too_thick æ–°è§„åˆ™
  - è¯¦è§ DX-23 å®ç°è®¡åˆ’
```

### é˜¶æ®µ 4: Fix-or-Explain (ä¸­é£é™©)

```
æ–‡ä»¶: src/invar/core/rules.py
æ”¹åŠ¨:
  1. æ·»åŠ  @shell_complexity æ ‡è®°æ£€æµ‹
  2. æ·»åŠ  check_complexity_debt() é¡¹ç›®çº§æ£€æŸ¥
```

### é˜¶æ®µ 5: Pre-commit æ›´æ–° (ä½é£é™©)

```
æ–‡ä»¶: src/invar/templates/pre-commit-config.yaml.template
æ”¹åŠ¨:
  1. ç¡®ä¿ --strict æ¨¡å¼å¯ç”¨
```

### é˜¶æ®µ 6: æ–‡æ¡£ (ä½é£é™©)

```
æ–‡ä»¶: docs/VERIFICATION.md (æ–°å»º)
å†…å®¹:
  1. Verification Strategy Overview (English)
  2. Code Classification (Core pure/C-ext, Shell)
  3. Tool Selection (CrossHair vs Hypothesis)
  4. Shell Architecture Rules
  5. Fix-or-Explain Mechanism
  6. Configuration Reference
  7. Examples and Best Practices
```

**æ–‡æ¡£ç›®çš„:**
- ä¸ºç”¨æˆ·æä¾›å®Œæ•´çš„éªŒè¯ç­–ç•¥æŒ‡å—
- è‹±æ–‡ç¼–å†™ï¼Œä¸ä»£ç åº“æ–‡æ¡£é£æ ¼ä¸€è‡´
- åŒ…å«å¯æ‰§è¡Œç¤ºä¾‹ï¼ŒAgent å¯ç›´æ¥å¼•ç”¨

### é˜¶æ®µ 7: é…ç½®ç®€åŒ– (ä¸­é£é™©)

```
æ–‡ä»¶: src/invar/shell/config.py, src/invar/core/models.py
æ”¹åŠ¨:
  1. æ·»åŠ  auto_detect_module_type() è‡ªåŠ¨æ£€æµ‹
  2. å¼ƒç”¨ core_paths, shell_paths é…ç½®
  3. æ·»åŠ  @invar:allow ä»£ç å†…æ ‡è®°è§£æ
  4. ç§»é™¤ use_code_lines, exclude_doctest_lines (åˆå¹¶ä¸ºé»˜è®¤è¡Œä¸º)
  5. å¼ƒç”¨ severity_overrides (æ”¹å–„é»˜è®¤å€¼)
```

**è¿ç§»ç­–ç•¥:**
- é˜¶æ®µ A: æ–°æ—§å¹¶å­˜ï¼Œæ˜¾å¼é…ç½®ä¼˜å…ˆ
- é˜¶æ®µ B: å¼ƒç”¨è­¦å‘Š
- é˜¶æ®µ C: ç§»é™¤æ—§é…ç½® (v2.0)

---

## æµ‹è¯•ç­–ç•¥æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Invar æµ‹è¯•ç­–ç•¥                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ä»£ç ç±»å‹          â”‚ ä¸»è¦éªŒè¯      â”‚ æ¶æ„è§„åˆ™      â”‚ å¼ºåˆ¶æ€§         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Core (çº¯ Python) â”‚ CrossHair    â”‚ å¥‘çº¦+Doctest â”‚ ERROR é˜»æ­¢      â”‚
â”‚  Core (C æ‰©å±•)    â”‚ Hypothesis   â”‚ å¥‘çº¦+Doctest â”‚ ERROR é˜»æ­¢      â”‚
â”‚  Shell            â”‚ Doctests     â”‚ æ¶æ„è§„åˆ™     â”‚ ç´¯ç§¯å ERROR    â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Shell æ¶æ„è§„åˆ™                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚  è§„åˆ™                  â”‚ çº§åˆ«    â”‚ å¯è§£é™¤æ–¹å¼                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  shell_pure_logic     â”‚ ERROR  â”‚ ç§»åŠ¨åˆ° Core                      â”‚
â”‚  shell_too_complex    â”‚ INFO   â”‚ é‡æ„ OR @shell_complexity æ ‡è®°   â”‚
â”‚  entry_point_too_thickâ”‚ WARNINGâ”‚ ç²¾ç®€ï¼Œå§”æ‰˜ç»™ Shell å‡½æ•° (DX-23)  â”‚
â”‚  complexity_debt      â”‚ ERROR  â”‚ å¤„ç†ç´¯ç§¯çš„ too_complex è­¦å‘Š      â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Agent-Native åŸåˆ™                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚  âœ“ é›¶å†³ç­–: `invar guard` è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥                           â”‚
â”‚  âœ“ è‡ªåŠ¨åˆ†ç±»: æ£€æµ‹ import åˆ¤æ–­ CrossHair/Hypothesis                  â”‚
â”‚  âœ“ å¯æ‰§è¡Œå»ºè®®: æ¨¡å¼æ£€æµ‹ + é‡æ„æ¨¡æ¿ï¼ŒAgent å¯ç›´æ¥åº”ç”¨                â”‚
â”‚  âœ“ å¼ºåˆ¶æ‰§è¡Œ: Fix-or-Explainï¼Œä¸èƒ½æ— é™å¿½ç•¥                           â”‚
â”‚  âœ“ å»é‡ç»Ÿè®¡: è¯æ˜/æµ‹è¯• åˆ†å¼€è®¡ç®—                                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å†³ç­–è®°å½•

| å†³ç­– | é€‰æ‹© | åŸå›  |
|------|------|------|
| shell_pure_logic çº§åˆ« | ERROR | æ¶æ„è¿è§„ï¼Œæ€»æœ‰è§£å†³æ–¹æ¡ˆ |
| shell_too_complex çº§åˆ« | INFO | å¯èƒ½åˆç†ï¼Œéœ€äººå·¥åˆ¤æ–­ |
| entry_point_too_thick çº§åˆ« | WARNING | å¼•å¯¼ä½†ä¸é˜»æ­¢ (DX-23) |
| ç´¯ç§¯é˜ˆå€¼ | 5 | å¹³è¡¡çµæ´»æ€§å’Œå¼ºåˆ¶æ€§ |
| é…ç½®é¡¹æ•°é‡ | 3 (DX-22) + 1 (DX-23) | Agent-Native: æç®€ |
| è§„åˆ™å…³é—­é€‰é¡¹ | ä¸æä¾› | æ¶æ„æ£€æŸ¥ä¸å¯ç»•è¿‡ |
| æ¨¡å¼æ£€æµ‹ | 5 ç§ + unknown | è¦†ç›–å¸¸è§åœºæ™¯ |
| Entry point æ£€æµ‹ | ç‹¬ç«‹ DX-23 | é—®é¢˜ç‹¬ç«‹ï¼Œå¯ç‹¬ç«‹æ’æœŸ |
| Entry point å±‚çº§ | Shell å­ç±»å‹ | ä¿æŒä¸¤å±‚æ¶æ„ (DX-23) |

---

## å‚è€ƒ

- DX-12: Hypothesis as CrossHair fallback
- DX-13: Incremental CrossHair verification
- DX-19: Simplified verification levels
- [DX-23](./DX-23-entry-point-detection.md): Entry point detection and monad runner pattern
- INVAR.md: Agent-Native principles
