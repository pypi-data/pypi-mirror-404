"""Exporting a notebook to a library"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/api/04_export.ipynb.

# %% auto #0
__all__ = ['ExportModuleProc', 'nb_export']

# %% ../nbs/api/04_export.ipynb #3b932371
from .config import *
from .maker import *
from .imports import *
from .process import *

from fastcore.script import *
from fastcore.basics import *
from fastcore.imports import *
from fastcore.meta import *

from collections import defaultdict

# %% ../nbs/api/04_export.ipynb #a62f3967
class ExportModuleProc:
    "A processor which exports code to a module"
    def begin(self): self.modules,self.in_all = defaultdict(L),defaultdict(L)
    def _default_exp_(self, cell, exp_to): self.default_exp = exp_to
    def _exporti_(self, cell, exp_to=None): self.modules[ifnone(exp_to, '#')].append(cell)
    def _export_(self, cell, exp_to=None):
        self._exporti_(cell, exp_to)
        self.in_all[ifnone(exp_to, '#')].append(cell)
    def __call__(self, cell):
        src = cell.source
        if not src: return
        if cell.cell_type=='markdown' and src.startswith('# '): self.modules['#'].append(cell)
    _exports_=_export_

# %% ../nbs/api/04_export.ipynb #76717e36
def nb_export(nbname:str,        # Filename of notebook 
              lib_path:str=None, # Path to destination library.  If not in a nbdev project, defaults to current directory.
              procs=None,        # Processors to use
              name:str=None,     # Name of python script {name}.py to create.
              mod_maker=ModuleMaker,
              debug:bool=False,  # Debug mode
              solo_nb:bool=False # Export single notebook outside of an nbdev project.
             ):
    "Create module(s) from notebook"
    if lib_path is None: lib_path = get_config().lib_path if is_nbdev() else '.'
    exp = ExportModuleProc()
    nb = NBProcessor(nbname, [exp]+L(procs), debug=debug)
    nb.process()
    for mod,cells in exp.modules.items():
        if first(1 for o in cells if o.cell_type=='code'):
            all_cells = exp.in_all[mod]
            nm = ifnone(name, getattr(exp, 'default_exp', None) if mod=='#' else mod)
            if not nm:
                warn(f"Notebook '{nbname}' uses `#| export` without `#| default_exp` cell.\n"
                     "Note nbdev2 no longer supports nbdev1 syntax. Run `nbdev_migrate` to upgrade.\n"
                     "See https://nbdev.fast.ai/getting_started.html for more information.")
                return
            mm = mod_maker(dest=lib_path, name=nm, nb_path=nbname, is_new=bool(name) or mod=='#', solo_nb=solo_nb)
            mm.make(cells, all_cells, lib_path=lib_path)
