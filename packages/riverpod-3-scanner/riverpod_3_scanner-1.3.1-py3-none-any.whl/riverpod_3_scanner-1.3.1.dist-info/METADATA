Metadata-Version: 2.4
Name: riverpod-3-scanner
Version: 1.3.1
Summary: Comprehensive static analysis tool for detecting Riverpod 3.0 async safety violations in Flutter/Dart projects
Home-page: https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner
Author: Steven Day
Author-email: Steven Day <support@daylightcreative.tech>
Maintainer-email: Steven Day <support@daylightcreative.tech>
License: MIT License
        
        Copyright (c) 2025 DayLight Creative Technologies
        Author: Steven Day
        
        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:
        
        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.
        
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
        
Project-URL: Homepage, https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner
Project-URL: Documentation, https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner/blob/main/docs/GUIDE.md
Project-URL: Repository, https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner
Project-URL: Issues, https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner/issues
Project-URL: Changelog, https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner/blob/main/CHANGELOG.md
Keywords: riverpod,flutter,dart,static-analysis,linter,code-quality,async-safety,riverpod-3,safety-checker
Classifier: Development Status :: 5 - Production/Stable
Classifier: Intended Audience :: Developers
Classifier: Topic :: Software Development :: Quality Assurance
Classifier: Topic :: Software Development :: Testing
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Operating System :: OS Independent
Classifier: Environment :: Console
Requires-Python: >=3.7
Description-Content-Type: text/markdown
License-File: LICENSE
License-File: AUTHORS
Dynamic: author
Dynamic: home-page
Dynamic: license-file
Dynamic: requires-python

# Riverpod 3.0 Safety Scanner

**Comprehensive static analysis tool for detecting Riverpod 3.0 async safety violations in Flutter/Dart projects.**

[![PyPI version](https://img.shields.io/pypi/v/riverpod-3-scanner.svg)](https://pypi.org/project/riverpod-3-scanner/)
[![Python versions](https://img.shields.io/pypi/pyversions/riverpod-3-scanner.svg)](https://pypi.org/project/riverpod-3-scanner/)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)
[![Riverpod](https://img.shields.io/badge/Riverpod-3.0+-green.svg)](https://riverpod.dev)
[![Flutter](https://img.shields.io/badge/Flutter-3.0+-blue.svg)](https://flutter.dev)

---

## üéØ What It Does

Riverpod 3.0 introduced `ref.mounted` to safely handle provider disposal during async operations. This scanner detects **14 types of violations** that can cause production crashes, including:

- ‚ùå Field caching patterns (pre-Riverpod 3.0 workarounds)
- ‚ùå Lazy getters in async classes
- ‚ùå Missing `ref.mounted` checks before/after async operations
- ‚ùå `ref` operations inside lifecycle callbacks
- ‚ùå Sync methods without mounted checks (called from async contexts)

**Features**:
- ‚úÖ **Zero false positives** via sophisticated call-graph analysis
- ‚úÖ **Cross-file violation detection** (indirect method calls)
- ‚úÖ **Variable resolution** (traces `basketballNotifier` ‚Üí `BasketballNotifier`)
- ‚úÖ **Comment stripping** (prevents false positives from commented code)
- ‚úÖ **Detailed fix instructions** for each violation
- ‚úÖ **CI/CD ready** (exit codes, verbose mode, pattern filtering)

---

## üöÄ Quick Start

### Installation

#### Via PyPI (Recommended)

```bash
pip install riverpod-3-scanner
```

Then run directly:
```bash
riverpod-3-scanner lib
```

#### Via Direct Download

```bash
# Download scanner
curl -O https://raw.githubusercontent.com/DayLight-Creative-Technologies/riverpod_3_scanner/main/riverpod_3_scanner.py

# Make executable (optional)
chmod +x riverpod_3_scanner.py
```

### Basic Usage

#### If installed via PyPI:

```bash
# Scan entire project
riverpod-3-scanner lib

# Scan specific file
riverpod-3-scanner lib/features/game/notifiers/game_notifier.dart

# Verbose output
riverpod-3-scanner lib --verbose
```

#### If using direct download:

```bash
# Scan entire project
python3 riverpod_3_scanner.py lib

# Scan specific file
python3 riverpod_3_scanner.py lib/features/game/notifiers/game_notifier.dart

# Verbose output
python3 riverpod_3_scanner.py lib --verbose
```

### Example Output

```
üîç RIVERPOD 3.0 COMPLIANCE SCAN COMPLETE
üìÅ Scanned: lib
üö® Total violations: 3

VIOLATIONS BY TYPE:
üî¥ LAZY GETTER: 2
üî¥ MISSING MOUNTED AFTER AWAIT: 1

üìÑ lib/features/game/notifiers/game_notifier.dart (3 violation(s))
   ‚Ä¢ Line 45: lazy_getter
   ‚Ä¢ Line 120: missing_mounted_after_await
   ‚Ä¢ Line 145: lazy_getter
```

---

## üìä Violation Types

### CRITICAL (Will crash in production)

| Type | Description | Production Impact |
|------|-------------|-------------------|
| **Field caching** | Nullable fields with getters in async classes | Crash on widget unmount |
| **Lazy getters** | `get x => ref.read()` in async classes | Crash on widget unmount |
| **ref.read() before mounted** | Missing mounted check before ref operations | Crash after disposal |
| **Missing mounted after await** | No mounted check after async gap | Crash after disposal |
| **ref in lifecycle callbacks** | `ref.read()` in `ref.onDispose`/`ref.listen` | AssertionError crash |
| **Sync methods without mounted** | Sync methods with `ref.read()` called from async | Crash from callbacks |

### WARNINGS (High crash risk)

- Widget lifecycle methods with unsafe ref usage
- Timer/Future.delayed deferred callbacks without mounted checks

### DEFENSIVE (Type safety & best practices)

- Untyped var lazy getters (loses type information)
- mounted vs ref.mounted confusion (educational)

See [GUIDE.md](GUIDE.md) for complete violation reference and fix patterns.

---

## üõ°Ô∏è How It Works

### Multi-Pass Call-Graph Analysis

The scanner uses a **4-pass architecture** to achieve zero false positives:

**Pass 1**: Build cross-file reference database
- Index all classes, methods, provider mappings
- Map `XxxNotifier` ‚Üí `xxxProvider` (Riverpod codegen)
- Store class ‚Üí file path mapping

**Pass 1.5**: Build complete method database
- Index ALL methods with metadata (has_ref_read, has_mounted_check, is_async)
- Detect framework lifecycle methods
- Store method bodies for analysis

**Pass 2**: Build async callback call-graph
- Trace methods called after `await` statements
- Detect callback parameters (`onCompletion:`, `builder:`, etc.)
- Find `stream.listen()` callbacks
- Detect `Timer`/`Future.delayed`/`addPostFrameCallback` calls
- Resolve variables to classes (`basketballNotifier` ‚Üí `BasketballNotifier`)

**Pass 2.5**: Propagate async context transitively
- If method A calls method B, and B is in async context ‚Üí A is too
- Fixed-point iteration until no new methods added
- Handles transitive call chains

**Pass 3**: Detect violations with full call-graph context
- Strip comments to prevent false positives
- Check lifecycle callbacks (direct and indirect violations)
- Flag sync methods with `ref.read()` called from async contexts
- Verify with call-graph data (zero false positives)

### Key Innovations

**Variable Resolution**:
```dart
final basketballNotifier = ref.read(basketballProvider(gameId).notifier);

onCompletion: () {
  basketballNotifier.completeGame();
  //  ‚Üì Scanner resolves ‚Üì
  // BasketballNotifier.completeGame()
}
```

**Comment Stripping**:
```dart
// Scanner ignores this:
// Cleanup handled by ref.onDispose() in build()

// Only flags real code:
ref.onDispose(() {
  ref.read(myProvider);  // ‚Üê VIOLATION DETECTED
});
```

---

## üîß Advanced Usage

### Pattern Filtering

```bash
# Scan only notifiers
python3 riverpod_3_scanner.py lib --pattern "**/*_notifier.dart"

# Scan only widgets
python3 riverpod_3_scanner.py lib --pattern "**/widgets/**/*.dart"

# Scan only services
python3 riverpod_3_scanner.py lib --pattern "**/services/**/*.dart"
```

### Exit Codes

- `0` - No violations (clean)
- `1` - Violations found (must be fixed)
- `2` - Error (invalid path, etc.)

Use in CI/CD pipelines:
```bash
python3 riverpod_3_scanner.py lib || exit 1
```

---

## üöÄ CI/CD Integration

### GitHub Actions

```yaml
name: Riverpod 3.0 Safety Check
on: [push, pull_request]

jobs:
  riverpod-safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2

      - name: Download Scanner
        run: curl -O https://raw.githubusercontent.com/DayLight-Creative-Technologies/riverpod_3_scanner/main/riverpod_3_scanner.py

      - name: Run Scanner
        run: python3 riverpod_3_scanner.py lib

      - name: Dart Analyze
        run: dart analyze lib/
```

### Pre-commit Hook

```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "Running Riverpod 3.0 compliance check..."
python3 riverpod_3_scanner.py lib || exit 1
dart analyze lib/ || exit 1
echo "‚úÖ All checks passed!"
```

Make executable:
```bash
chmod +x .git/hooks/pre-commit
```

---

## üìö Documentation

- **[GUIDE.md](GUIDE.md)** - Complete guide with all violation types, fix patterns, decision trees
- **[EXAMPLES.md](EXAMPLES.md)** - Real-world examples and production crash case studies
- **[CHANGELOG.md](CHANGELOG.md)** - Version history and updates

---

## üéì The Riverpod 3.0 Pattern

### ‚ùå Before (Crashes)

```dart
class MyNotifier extends _$MyNotifier {
  MyLogger? _logger;
  MyLogger get logger {
    final l = _logger;
    if (l == null) throw StateError('Disposed');
    return l;
  }

  @override
  build() {
    _logger = ref.read(myLoggerProvider);
    ref.onDispose(() => _logger = null);
    return State.initial();
  }

  Future<void> doWork() async {
    await operation();
    logger.logInfo('Done');  // CRASH: _logger = null during await
  }
}
```

### ‚úÖ After (Safe)

```dart
class MyNotifier extends _$MyNotifier {
  @override
  State build() => State.initial();

  Future<void> doWork() async {
    // Check BEFORE ref.read()
    if (!ref.mounted) return;

    final logger = ref.read(myLoggerProvider);

    await operation();

    // Check AFTER await
    if (!ref.mounted) return;

    logger.logInfo('Done');
  }
}
```

**Key Differences**:
- ‚ùå Removed nullable field `_logger`
- ‚ùå Removed enhanced getter with StateError
- ‚ùå Removed field initialization in build()
- ‚ùå Removed `ref.onDispose()` cleanup
- ‚úÖ Added `ref.mounted` checks
- ‚úÖ Added just-in-time `ref.read()`

---

## üîç Requirements

- **Python**: 3.7+
- **Dart/Flutter**: Any version using Riverpod 3.0+
- **Riverpod**: 3.0+ (for `ref.mounted` feature)

No external dependencies required - scanner uses only Python standard library.

---

## üìä Scanner Statistics

From production deployment (140+ violations fixed):

**Most Common Violations**:
1. Lazy getters (26%) - `get logger => ref.read(...)`
2. Field caching (29%) - Pre-Riverpod 3.0 workaround
3. Missing mounted after await (27%)
4. ref.read before mounted (28%)

**Crash Prevention**:
- **Before**: 12+ production crashes/week from unmounted ref
- **After**: Zero crashes for 30+ days

**False Positive Rate**: 0% (with call-graph analysis)

---

## ü§ù Contributing

Contributions welcome! Please:

1. **Report Issues**: https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner/issues
2. **Submit PRs**: Fork ‚Üí Branch ‚Üí PR
3. **Add Tests**: Include test cases for new violation types
4. **Update Docs**: Keep GUIDE.md synchronized with code changes

---

## üìù License

MIT License - see [LICENSE](LICENSE) file for details.

---

## üôè Credits

**Created by**: Steven Day, DayLight Creative Technologies

**Acknowledgments**:
- **Riverpod Team** - For `ref.mounted` feature and official pattern
- **Andrea Bizzotto** - For educational content on AsyncNotifier safety
- **Flutter Community** - For feedback and real-world crash reports

---

## üìû Support

- **Issues**: https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner/issues
- **Discussions**: https://github.com/DayLight-Creative-Technologies/riverpod_3_scanner/discussions
- **Author**: Steven Day (support@daylightcreative.tech)
- **Company**: DayLight Creative Technologies
- **Riverpod Discord**: https://discord.gg/riverpod

---

## üîó Related Resources

- [Riverpod 3.0 Documentation](https://riverpod.dev/docs/whats_new#refmounted)
- [Riverpod 3.0 Migration Guide](https://riverpod.dev/docs/3.0_migration)
- [Andrea Bizzotto: AsyncNotifier Mounted](https://codewithandrea.com/articles/async-notifier-mounted-riverpod/)

---

**Prevent production crashes. Enforce Riverpod 3.0 async safety. Use `riverpod_3_scanner`.**
