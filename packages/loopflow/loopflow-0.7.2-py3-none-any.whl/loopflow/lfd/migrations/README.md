# Database Migrations

All schema changes go through migrations. The baseline contains the current schema; incremental migrations accumulate until the next consolidation.

**IMPORTANT: Never edit `baseline.py` directly.** It is auto-generated by `scripts/collapse_migrations.py`. To add schema changes, create a new migration file.

## Adding a Migration

1. Create `m_YYYY_MM_DD_description.py`
2. Define `VERSION` (ISO timestamp), `DESCRIPTION`, and `apply(conn)`
3. Make it idempotent—check before modifying

```python
VERSION = "2025-01-23T00:00:00"
DESCRIPTION = "add foo column to bars"

def apply(conn):
    cols = {r["name"] for r in conn.execute("PRAGMA table_info(bars)")}
    if "foo" not in cols:
        conn.execute("ALTER TABLE bars ADD COLUMN foo TEXT")
```

## Consolidating Migrations

When incremental migrations accumulate, fold them into the baseline:

```bash
./scripts/collapse_migrations.py --clean   # removes m_*.py, sets placeholder version
git add -A && git commit -m "consolidate migrations"
./scripts/collapse_migrations.py --finalize  # stamps with commit SHA
git commit --amend --no-edit
```

The version uses **git commit timestamp + SHA** (`2026-01-23T16:39:43Z_abc1234`):
- Ordered (ISO timestamps sort correctly)
- Reproducible (from git, not local time)
- Handles parallel development (no version collisions between branches)

## Rules

- **All schema changes go through migrations.** Never ALTER tables in runtime code.
- **Make migrations idempotent.** Check if the change is needed before applying.
- **One migration per change.** Don't modify existing migration files.
- **Migrations are one-way.** No rollback support—branch switching may require `rm ~/.lf/lfd.db`.
