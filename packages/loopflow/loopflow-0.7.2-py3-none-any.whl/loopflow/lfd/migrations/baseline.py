"""Baseline schema - compressed from all prior migrations.

DO NOT EDIT THIS FILE DIRECTLY.

This file is auto-generated by running: scripts/collapse_migrations.py
To add schema changes, create a new migration file in this directory.
"""

import sqlite3

SCHEMA_VERSION = "2026-01-25T23:59:59Z_baseline"
DESCRIPTION = "baseline schema with step_index for tick-based flow execution"


def apply(conn: sqlite3.Connection) -> None:
    conn.executescript(
        """
        -- Waves: orchestrated work units with loop/watch/cron modes
        CREATE TABLE IF NOT EXISTS waves (
            id TEXT PRIMARY KEY,
            name TEXT NOT NULL,   -- unique name, used for worktree/branch naming
            repo TEXT NOT NULL,
            flow TEXT NOT NULL DEFAULT 'design',
            direction TEXT,            -- JSON array (optional, validated at run-time)
            area TEXT,            -- JSON array (optional, validated at run-time)

            stimulus_kind TEXT NOT NULL DEFAULT 'loop',  -- loop, watch, cron
            stimulus_cron TEXT,
            paused INTEGER NOT NULL DEFAULT 0,
            status TEXT NOT NULL DEFAULT 'idle',
            iteration INTEGER NOT NULL DEFAULT 0,

            worktree TEXT,        -- persistent worktree path
            branch TEXT,          -- current branch name
            pr_limit INTEGER NOT NULL DEFAULT 5,
            merge_mode TEXT NOT NULL DEFAULT 'pr',

            pid INTEGER,
            created_at TEXT NOT NULL,

            last_main_sha TEXT,   -- last seen SHA on main (watch mode)

            -- Resilience
            consecutive_failures INTEGER NOT NULL DEFAULT 0,
            pending_activations INTEGER NOT NULL DEFAULT 0
        );

        CREATE INDEX IF NOT EXISTS idx_waves_repo ON waves(repo);
        CREATE INDEX IF NOT EXISTS idx_waves_status ON waves(status);

        -- Runs: flow execution instances
        CREATE TABLE IF NOT EXISTS runs (
            id TEXT PRIMARY KEY,
            wave TEXT,  -- wave ID (nullable for one-off runs)

            flow TEXT NOT NULL,
            direction TEXT,            -- JSON array (nullable)
            area TEXT,            -- JSON array (nullable)
            repo TEXT NOT NULL,

            status TEXT NOT NULL DEFAULT 'pending',
            iteration INTEGER NOT NULL DEFAULT 0,
            step_index INTEGER NOT NULL DEFAULT 0,  -- position in flow.steps

            worktree TEXT,
            branch TEXT,
            current_step TEXT,
            error TEXT,
            pr_url TEXT,

            started_at TEXT,
            ended_at TEXT,
            created_at TEXT NOT NULL
        );

        CREATE INDEX IF NOT EXISTS idx_runs_wave ON runs(wave);
        CREATE INDEX IF NOT EXISTS idx_runs_status ON runs(status);
        CREATE INDEX IF NOT EXISTS idx_runs_repo ON runs(repo);

        -- Step runs: individual step executions
        CREATE TABLE IF NOT EXISTS step_runs (
            id TEXT PRIMARY KEY,
            step TEXT NOT NULL,
            repo TEXT NOT NULL,
            worktree TEXT NOT NULL,

            flow_run_id TEXT,  -- parent run (nullable for standalone)
            wave_id TEXT,     -- parent wave (nullable for standalone)

            status TEXT NOT NULL DEFAULT 'running',
            started_at TEXT NOT NULL,
            ended_at TEXT,

            pid INTEGER,
            model TEXT NOT NULL DEFAULT 'claude-code',
            run_mode TEXT NOT NULL DEFAULT 'auto'
        );

        CREATE INDEX IF NOT EXISTS idx_step_runs_status ON step_runs(status);
        CREATE INDEX IF NOT EXISTS idx_step_runs_flow_run ON step_runs(flow_run_id);

        -- Summaries: cached codebase summaries
        CREATE TABLE IF NOT EXISTS summaries (
            id TEXT PRIMARY KEY,
            repo TEXT NOT NULL,
            path TEXT NOT NULL,
            token_budget INTEGER NOT NULL,
            source_hash TEXT NOT NULL,
            content TEXT NOT NULL,
            model TEXT NOT NULL,
            created_at TEXT NOT NULL
        );

        CREATE INDEX IF NOT EXISTS idx_summaries_repo_path ON summaries(repo, path);
        """
    )
