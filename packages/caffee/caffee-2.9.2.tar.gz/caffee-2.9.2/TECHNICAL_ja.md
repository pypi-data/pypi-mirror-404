# CAFFEE 技術仕様書 (TECHNICAL_ja.md)

このドキュメントでは、CAFFEE ターミナルテキストエディタの内部アーキテクチャ、設計思想、および各システムの詳細な実装について解説します。

---

## 1. 開発方針と設計思想

CAFFEEは以下の3つの柱を開発の基本方針としています。

- **Lightweight (軽量)**: Pythonの標準ライブラリと`curses`のみを基盤とし、外部依存を最小限に抑えています。低リソース環境でも高速に動作することを目指しています。
- **Modern (モダン)**: TUI（Terminal User Interface）でありながら、マルチタブ、ブレッドクラムバー、予測補完、Git連携、統合ターミナルなど、現代的なIDEに近い操作感を提供します。
- **Extensible (拡張性)**: 強力なプラグインシステムと独自のCAFFEINEマクロ言語により、ユーザーが自分好みに機能を拡張・自動化できる柔軟性を備えています。

---

## 2. システムアーキテクチャ

CAFFEEは大きく分けて、エディタ本体の制御、バッファ管理、UIレンダリング、そして拡張機能マネージャーの4つの層で構成されています。

### 2.1 核心クラス: `Editor`
`Editor`クラスはアプリケーションの「脳」であり、以下の責務を担います。
- **イベントループの管理**: キー入力の待機、各コンポーネントへのディスパッチ、再描画のトリガー。
- **モード管理**: エディタモード、エクスプローラーモード、コマンドモード、ターミナルモードなどの状態遷移。
- **リソース共有**: カラーペア、設定情報、共通のUIマネージャーへのアクセス提供。

### 2.2 タブとバッファ管理: `EditorTab` と `Buffer`
CAFFEEはマルチタブ編集をサポートするため、各ファイルの状態を`EditorTab`オブジェクトにカプセル化しています。
- **`EditorTab`**: `Buffer`オブジェクト、カーソル位置（y, x）、スクロールオフセット、履歴（Undo用）、シンタックスルールを保持します。
- **`Buffer`**: 行（文字列）のリストを保持するシンプルなデータ構造です。

### 2.3 UI レンダリングパイプライン
レンダリングは、`curses`の描画関数を抽象化した階層的なアプローチを取っています。
1. **`draw_ui`**: 背景、境界線、ステータスバー、ブレッドクラムバー、タブバーなどの共通UI要素を描画します。
2. **`draw_content`**: アクティブなタブのバッファ内容を、シンタックスハイライトを適用しながら描画します。
3. **`_draw_suggestions`**: 入力中に補完候補が表示されている場合、それをオーバーレイとして描画します。

---

## 3. 主要システムの詳細

### 3.1 シンタックスハイライト
シンタックスハイライトは、各行の描画時にリアルタイムで正規表現マッチングを行うことで実現されています。
- `DEFAULT_SYNTAX_RULES`に定義されたルール（キーワード、文字列、コメント、数値）に基づき、各トークンに`curses`の属性（カラーペア）を付与します。
- 高速化のため、行単位でのマッチングを行い、画面外の行については処理をスキップします。

### 3.2 Undo/Redo システム
CAFFEEは「スタックベースの全状態保存」モデルを採用しています（設定による制限あり）。
- 各編集操作の前に、現在のバッファのスナップショットとカーソル位置を`history`スタックに保存します。
- メモリ消費を抑えるため、`history_limit`（デフォルト50）により保存回数を制限しています。

### 3.3 クリップボード同期
クロスプラットフォームなコピー＆ペーストを実現するため、CAFFEEは以下の外部コマンドを検知して利用します。
- **macOS**: `pbcopy`, `pbpaste`
- **Linux (Wayland)**: `wl-copy`, `wl-paste`
- **Linux (X11)**: `xclip`, `xsel`
- **Windows**: `PowerShell.exe` (Set-Clipboard, Get-Clipboard)
- **WSL**: ホスト側の`powershell.exe`または`clip.exe`へのフォールバック

### 3.4 入力処理とブラケットペースト
`curses`の`get_wch()`を使用してUnicode入力を受け取ります。また、エスケープシーケンスを解析して特殊キー（矢印キー、Ctrl等）を判別します。
特に、大量のテキストを貼り付けた際に自動インデントが暴走するのを防ぐため、**Bracketed Paste Mode**（`\x1b[?200h`）をサポートしており、貼り付けられたテキストを一つのまとまりとして高速に処理します。

---

## 4. CAFFEINE マクロ言語

CAFFEINEは、CAFFEE内部に実装された軽量なスタック/レジスタレス命令セット言語です。

### 4.1 実行メカニズム
`MacroManager`がインタープリタの役割を果たします。
1. **プリスキャン**: マクロファイルを読み込み、`IF`/`ELSE`/`ENDIF`および`LOOP`/`ENDLOOP`の対応関係を「ジャンプテーブル」として事前に構築します。
2. **プログラムカウンタ (PC)**: 現在実行中の行番号を管理し、制御フローに応じてPCをジャンプさせます。
3. **変数の代入と展開**: `SET`コマンドで変数（グローバル）を定義し、実行時に`{var}`形式で値を文字列に埋め込みます。

### 4.2 数式評価
`SET`コマンドにおける数値計算には、Pythonの`eval()`を限定的に使用します。セキュリティを確保するため、正規表現によって許可された文字（数値、基本的な演算子、括弧）のみが含まれているか厳格にチェックします。

---

## 5. ターミナル統合
`TerminalManager`（実装されている場合）は、`pty`（疑似端末）を使用してバックグラウンドでシェルを走らせます。
- 出力は定期的、または再描画時にバッファとして読み取られ、エディタの下部パネルに描画されます。
- 入力は`curses`から読み取られ、`pty`のマスター側に書き込まれます。

---

## 6. ビルドと配布

CAFFEEは純粋なPythonスクリプトですが、配布と実行を容易にするため以下の工夫をしています。
- **Entry Points**: `pyproject.toml`で`caffee = "caffee:start_app"`と定義することで、インストール後にコマンドとして即座に利用可能です。
- **Nuitka サポート**: 起動速度を極限まで高めるため、NuitkaによるC言語へのコンパイルとスタンドアロンバイナリ化が考慮された設計になっています（`os.environ`の遅延評価など）。
