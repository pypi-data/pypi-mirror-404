{% extends "django_agent_studio/base.html" %}

{% block title %}Collaborators - {{ object_name }} - Agent Studio{% endblock %}

{% block breadcrumbs %}
<nav class="flex items-center space-x-2 ml-4 text-sm">
    <span class="text-gray-400">/</span>
    {% if object_type == 'agent' %}
    <a href="{% url 'agent_studio:agent_list' %}" class="text-gray-500 hover:text-gray-700">My Agents</a>
    <span class="text-gray-400">/</span>
    <a href="{% url 'agent_studio:agent_edit' object.id %}" class="text-gray-500 hover:text-gray-700">{{ object_name }}</a>
    {% else %}
    <a href="{% url 'agent_studio:system_list' %}" class="text-gray-500 hover:text-gray-700">My Systems</a>
    <span class="text-gray-400">/</span>
    <a href="{% url 'agent_studio:system_test' object.id %}" class="text-gray-500 hover:text-gray-700">{{ object_name }}</a>
    {% endif %}
    <span class="text-gray-400">/</span>
    <span class="text-gray-600">Collaborators</span>
</nav>
{% endblock %}

{% block content %}
<div class="h-full p-6 overflow-auto">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">ðŸ‘¥ Collaborators</h1>
                <p class="text-gray-500 mt-1">Manage who can access {{ object_name }}</p>
            </div>
        </div>

        {% if object_type == 'system' and member_agents %}
        <!-- System: Show included agents -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-blue-800 mb-2">
                <i class="pi pi-info-circle mr-2"></i>Included Agents
            </h3>
            <p class="text-sm text-blue-700 mb-3">
                Collaborators on this system automatically get access to all agents below:
            </p>
            <div class="flex flex-wrap gap-2">
                {% for agent in member_agents %}
                <a href="{% url 'agent_studio:agent_collaborators' agent.id %}"
                   class="inline-flex items-center px-3 py-1.5 bg-white border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100 transition-colors">
                    <i class="pi pi-android mr-1.5"></i>
                    {{ agent.name }}
                    <span class="ml-1.5 text-xs text-blue-500">({{ agent.role }})</span>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if object_type == 'agent' and parent_systems %}
        <!-- Agent: Show parent systems -->
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-amber-800 mb-2">
                <i class="pi pi-info-circle mr-2"></i>Inherited Access
            </h3>
            <p class="text-sm text-amber-700 mb-3">
                This agent is part of the following system(s). Users with system access can also access this agent:
            </p>
            <div class="flex flex-wrap gap-2">
                {% for system in parent_systems %}
                <a href="{% url 'agent_studio:system_collaborators' system.id %}"
                   class="inline-flex items-center px-3 py-1.5 bg-white border border-amber-200 rounded-lg text-sm text-amber-700 hover:bg-amber-100 transition-colors">
                    <i class="pi pi-sitemap mr-1.5"></i>
                    {{ system.name }}
                    <i class="pi pi-external-link ml-1.5 text-xs"></i>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Owner Info -->
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                        <span class="text-primary-600 font-semibold">{{ owner_initial }}</span>
                    </div>
                    <div>
                        <p class="font-medium text-gray-800">{{ owner_email }}</p>
                        <p class="text-sm text-gray-500">Owner</p>
                    </div>
                </div>
                <span class="bg-primary-100 text-primary-700 px-3 py-1 rounded-full text-sm font-medium">Owner</span>
            </div>
        </div>

        <!-- Add Collaborator Form -->
        {% if can_admin %}
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-gray-800 mb-4">Add Collaborator</h3>
            <form @submit.prevent="addCollaborator" class="flex items-end space-x-4">
                <div class="flex-1 relative">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search User</label>
                    <input type="text" v-model="searchQuery" @input="searchUsers" @focus="showResults = true"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="Type to search by name or email..."
                           autocomplete="off">
                    <!-- Search Results Dropdown -->
                    <div v-if="showResults && (searchResults.length > 0 || searchQuery.length >= 2)"
                         class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto">
                        <div v-if="searching" class="p-3 text-center text-gray-500">
                            <i class="pi pi-spin pi-spinner mr-2"></i>Searching...
                        </div>
                        <div v-else-if="searchResults.length === 0 && searchQuery.length >= 2" class="p-3 text-center text-gray-500">
                            No users found
                        </div>
                        <div v-else>
                            <button v-for="user in searchResults" :key="user.id" type="button"
                                    @click="selectUser(user)"
                                    class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center space-x-3 border-b border-gray-100 last:border-0">
                                <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <span class="text-primary-600 font-semibold text-sm">[[ user.name.charAt(0).toUpperCase() ]]</span>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="font-medium text-gray-800 truncate">[[ user.name ]]</p>
                                    <p class="text-sm text-gray-500 truncate">[[ user.email ]]</p>
                                </div>
                            </button>
                        </div>
                    </div>
                    <!-- Selected User Display -->
                    <div v-if="selectedUser" class="mt-2 flex items-center space-x-2 bg-primary-50 border border-primary-200 rounded-lg px-3 py-2">
                        <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center">
                            <span class="text-primary-600 font-semibold text-xs">[[ selectedUser.name.charAt(0).toUpperCase() ]]</span>
                        </div>
                        <span class="text-sm text-primary-800 flex-1">[[ selectedUser.display ]]</span>
                        <button type="button" @click="clearSelection" class="text-primary-600 hover:text-primary-800">
                            <i class="pi pi-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="w-40">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select v-model="newRole"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="viewer">Viewer</option>
                        <option value="editor">Editor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" :disabled="adding || !selectedUser"
                        class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors disabled:opacity-50">
                    <i class="pi pi-plus"></i>
                    <span>[[ adding ? 'Adding...' : 'Add' ]]</span>
                </button>
            </form>
            <p v-if="addError" class="mt-2 text-sm text-red-600">[[ addError ]]</p>
        </div>
        {% endif %}

        <!-- Collaborators List -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50">
                <h3 class="font-semibold text-gray-800">Collaborators ([[ collaborators.length ]])</h3>
            </div>
            
            <div v-if="loading" class="p-8 text-center text-gray-500">
                <i class="pi pi-spin pi-spinner text-2xl"></i>
                <p class="mt-2">Loading collaborators...</p>
            </div>
            
            <div v-else-if="collaborators.length === 0" class="p-8 text-center text-gray-500">
                <i class="pi pi-users text-4xl mb-2"></i>
                <p>No collaborators yet</p>
                <p class="text-sm">Add collaborators to share access to this {{ object_type }}</p>
            </div>
            
            <div v-else class="divide-y divide-gray-100">
                <div v-for="collab in collaborators" :key="collab.id" 
                     class="p-4 flex items-center justify-between hover:bg-gray-50">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="text-gray-600 font-semibold">[[ getInitial(collab.user_email) ]]</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">[[ collab.user_name || collab.user_email ]]</p>
                            <p class="text-sm text-gray-500">[[ collab.user_email ]]</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        {% if can_admin %}
                        <select v-model="collab.role" @change="updateRole(collab)"
                                class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500">
                            <option value="viewer">Viewer</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button @click="removeCollaborator(collab)" 
                                class="text-red-600 hover:text-red-700 p-1.5 hover:bg-red-50 rounded"
                                title="Remove collaborator">
                            <i class="pi pi-trash"></i>
                        </button>
                        {% else %}
                        <span class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm">[[ collab.role_display ]]</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Descriptions -->
        <div class="mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
            <h4 class="font-medium text-gray-800 mb-3">Role Permissions</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                    <p class="font-medium text-gray-700">Viewer</p>
                    <p class="text-gray-500">Can view and test the {{ object_type }}</p>
                </div>
                <div>
                    <p class="font-medium text-gray-700">Editor</p>
                    <p class="text-gray-500">Can view, test, and edit the {{ object_type }}</p>
                </div>
                <div>
                    <p class="font-medium text-gray-700">Admin</p>
                    <p class="text-gray-500">Can view, test, edit, and manage collaborators</p>
                </div>
            </div>
            {% if object_type == 'system' %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <p class="text-sm text-gray-600">
                    <i class="pi pi-info-circle mr-1"></i>
                    <strong>Note:</strong> System collaborators automatically get the same access level to all agents in this system.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const { createApp } = Vue;

const objectType = "{{ object_type }}";
const objectId = "{{ object.id }}";
const apiUrl = objectType === 'agent'
    ? `/studio/api/agents/${objectId}/collaborators/`
    : `/studio/api/systems/${objectId}/collaborators/`;

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            collaborators: [],
            loading: true,
            // Search state
            searchQuery: '',
            searchResults: [],
            selectedUser: null,
            showResults: false,
            searching: false,
            searchTimeout: null,
            // Form state
            newRole: 'viewer',
            adding: false,
            addError: null,
        }
    },
    methods: {
        async loadCollaborators() {
            this.loading = true;
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                });
                if (response.ok) {
                    const data = await response.json();
                    // Handle both paginated and non-paginated responses
                    this.collaborators = data.results !== undefined ? data.results : data;
                }
            } catch (error) {
                console.error('Failed to load collaborators:', error);
            } finally {
                this.loading = false;
            }
        },
        searchUsers() {
            // Debounce search
            clearTimeout(this.searchTimeout);
            this.showResults = true;

            if (this.searchQuery.length < 2) {
                this.searchResults = [];
                return;
            }

            this.searchTimeout = setTimeout(async () => {
                this.searching = true;
                try {
                    const response = await fetch(`/studio/api/users/search/?q=${encodeURIComponent(this.searchQuery)}`, {
                        credentials: 'same-origin',
                    });
                    if (response.ok) {
                        this.searchResults = await response.json();
                    }
                } catch (error) {
                    console.error('Search failed:', error);
                } finally {
                    this.searching = false;
                }
            }, 300);
        },
        selectUser(user) {
            this.selectedUser = user;
            this.searchQuery = '';
            this.searchResults = [];
            this.showResults = false;
        },
        clearSelection() {
            this.selectedUser = null;
            this.searchQuery = '';
        },
        async addCollaborator() {
            if (!this.selectedUser) return;

            this.adding = true;
            this.addError = null;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        email: this.selectedUser.email,
                        role: this.newRole,
                    }),
                });
                const data = await response.json();
                if (response.ok) {
                    this.collaborators.push(data);
                    this.selectedUser = null;
                    this.searchQuery = '';
                    this.newRole = 'viewer';
                } else {
                    this.addError = data.error || 'Failed to add collaborator';
                }
            } catch (error) {
                this.addError = 'Network error. Please try again.';
            } finally {
                this.adding = false;
            }
        },
        async updateRole(collab) {
            try {
                const response = await fetch(`${apiUrl}${collab.id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ role: collab.role }),
                });
                if (!response.ok) {
                    // Revert on error
                    await this.loadCollaborators();
                }
            } catch (error) {
                console.error('Failed to update role:', error);
                await this.loadCollaborators();
            }
        },
        async removeCollaborator(collab) {
            if (!confirm(`Remove ${collab.user_email} as a collaborator?`)) return;
            try {
                const response = await fetch(`${apiUrl}${collab.id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                    credentials: 'same-origin',
                });
                if (response.ok) {
                    this.collaborators = this.collaborators.filter(c => c.id !== collab.id);
                }
            } catch (error) {
                console.error('Failed to remove collaborator:', error);
            }
        },
        getInitial(email) {
            return email ? email.charAt(0).toUpperCase() : '?';
        },
        getCsrfToken() {
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) return value;
            }
            return '';
        },
    },
    mounted() {
        this.loadCollaborators();
        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                this.showResults = false;
            }
        });
    }
}).use(primevue.config.default).mount('#app');
</script>
{% endblock %}

