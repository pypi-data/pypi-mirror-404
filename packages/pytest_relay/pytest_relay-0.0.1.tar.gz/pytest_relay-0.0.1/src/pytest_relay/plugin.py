"""
Main plugin entry point for pytest-relay.
"""

import pytest
from _pytest.config import Config, Parser

from pytest_relay.plugger import RelayPlugin


def pytest_addoption(parser: Parser) -> None:
    """
    Add relay plugin related options.
    """
    group = parser.getgroup("relay", "pytest-relay plugin")
    group.addoption(
        "--session-id",
        type=str,
        required=False,
        dest="session_id",
        help="injects a session ID for the published data. "
        "if not provided a UUID is generated by the plugin during the configuration phase",
    )
    group.addoption(
        "--strip-paths",
        action="store_true",
        dest="strip_paths",
        help="strips the sys.prefix, sys.base_prefix, and the pytest rootpath from records",
    )


@pytest.hookimpl(tryfirst=True)
def pytest_configure(config: Config) -> None:
    """
    Hook: Allow plugins and conftest files to perform initial configuration.
    """
    if config.pluginmanager.get_plugin("pytest_relay") is None:
        p = RelayPlugin(config)
        config.pluginmanager.register(plugin=p, name="pytest_relay")
        # consider using config.add_cleanup ...


@pytest.hookimpl(trylast=True)
def pytest_unconfigure(config: Config) -> None:
    """
    Hook: Called before test process is exited.
    It uses `trylast` in order to attempt all other hooks being called before this one.
    """
    config.pluginmanager.unregister(name="pytest_relay")
