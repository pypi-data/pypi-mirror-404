"""Docker generator for Geronimo.

Generates optimized Dockerfiles for ML model serving.
"""

from pathlib import Path

from geronimo.config.schema import GeronimoConfig, MLFramework
from geronimo.generators.base import BaseGenerator


class DockerGenerator(BaseGenerator):
    """Generates optimized Dockerfiles for ML deployments."""

    TEMPLATE_DIR = "docker"

    def __init__(
        self,
        config: GeronimoConfig,
        output_path: str = "Dockerfile",
    ) -> None:
        """Initialize the Docker generator.

        Args:
            config: Geronimo configuration.
            output_path: Path to write the Dockerfile.
        """
        super().__init__()
        self.config = config
        self.output_path = Path(output_path)

    def _get_base_image(self) -> str:
        """Get the appropriate base image for the framework."""
        python_version = self.config.runtime.python_version

        # Use slim images for smaller size
        base_images = {
            MLFramework.PYTORCH: f"python:{python_version}-slim",
            MLFramework.TENSORFLOW: f"python:{python_version}-slim",
            MLFramework.SKLEARN: f"python:{python_version}-slim",
            MLFramework.XGBOOST: f"python:{python_version}-slim",
            MLFramework.CUSTOM: f"python:{python_version}-slim",
        }

        return base_images.get(self.config.model.framework, f"python:{python_version}-slim")

    def generate(self) -> str:
        """Generate the Dockerfile.

        Returns:
            Path to the generated Dockerfile.
        """
        project_name_snake = self.config.project.name.replace("-", "_")

        # Build Dockerfile content
        content = f'''# Dockerfile for {self.config.project.name}
# Generated by Geronimo
# Multi-stage build for optimized image size

# ============================================================================
# Build stage - install dependencies
# ============================================================================
FROM {self._get_base_image()} AS builder

# Install uv for fast dependency management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Set up uv environment
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy

WORKDIR /app

# Copy dependency files first for better caching
COPY pyproject.toml .
COPY uv.lock* .

# Install dependencies
RUN --mount=type=cache,target=/root/.cache/uv \\
    uv sync --frozen --no-dev --no-install-project

# Copy source code
COPY src/ src/

# Install the project
RUN --mount=type=cache,target=/root/.cache/uv \\
    uv sync --frozen --no-dev

# ============================================================================
# Runtime stage - minimal image
# ============================================================================
FROM {self._get_base_image()} AS runtime

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \\
    curl \\
    && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN groupadd --gid 1000 appuser \\
    && useradd --uid 1000 --gid 1000 -m appuser

WORKDIR /app

# Copy virtual environment from builder
COPY --from=builder --chown=appuser:appuser /app/.venv /app/.venv

# Copy source code and models
COPY --chown=appuser:appuser src/ src/
COPY --chown=appuser:appuser models/ models/

# Set environment variables
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Switch to non-root user
USER appuser

# Expose the application port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \\
    CMD curl -f http://localhost:8000/health || exit 1

# Run the application with proper signal handling
CMD ["uvicorn", "{project_name_snake}.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
'''

        self.write_file(self.output_path, content)

        # Also generate .dockerignore
        self._generate_dockerignore()

        return str(self.output_path)

    def _generate_dockerignore(self) -> None:
        """Generate .dockerignore file."""
        dockerignore_path = self.output_path.parent / ".dockerignore"

        content = '''# Dockerfile ignore patterns
# Generated by Geronimo

# Git
.git
.gitignore

# Python
__pycache__
*.py[cod]
*$py.class
.venv
venv
.env

# IDE
.idea
.vscode
*.swp

# Testing
.coverage
htmlcov
.pytest_cache

# Build artifacts
dist
build
*.egg-info

# Terraform
infrastructure
.terraform
*.tfstate*

# Documentation
docs
*.md
!README.md

# CI/CD
.github
azure-pipelines.yaml

# Geronimo config (not needed at runtime)
geronimo.yaml
'''

        self.write_file(dockerignore_path, content)
