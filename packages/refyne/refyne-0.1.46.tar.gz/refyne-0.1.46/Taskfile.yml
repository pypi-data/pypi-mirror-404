version: '3'

vars:
  OPENAPI_SPEC_URL: '{{.OPENAPI_SPEC_URL | default "http://localhost:8080/openapi.json"}}'
  OPENAPI_PROD_URL: https://api.refyne.uk/openapi.json

tasks:
  # ============================================
  # Dependencies
  # ============================================
  deps:
    desc: Install dependencies with uv
    cmds:
      - uv sync

  deps:update:
    desc: Update dependencies within constraints
    cmds:
      - uv lock --upgrade
      - uv sync

  deps:upgrade:
    desc: Upgrade dependencies to latest versions
    cmds:
      - uv lock --upgrade
      - uv sync

  # ============================================
  # Code generation
  # ============================================
  generate:
    desc: Generate types from OpenAPI spec (local server by default)
    cmds:
      - echo "Generating types from {{.OPENAPI_SPEC_URL}}..."
      - uv run python scripts/generate_types.py {{.OPENAPI_SPEC_URL}}
      - echo "Done."

  generate:prod:
    desc: Generate types from production API
    cmds:
      - echo "Generating types from {{.OPENAPI_PROD_URL}}..."
      - uv run python scripts/generate_types.py {{.OPENAPI_PROD_URL}}
      - echo "Done."

  # ============================================
  # Testing
  # ============================================
  test:
    desc: Run tests
    cmds:
      - uv run pytest

  test:verbose:
    desc: Run tests with verbose output
    cmds:
      - uv run pytest -v

  test:coverage:
    desc: Run tests with coverage report
    cmds:
      - uv run pytest --cov=src --cov-report=html
      - echo "Coverage report: htmlcov/index.html"

  # ============================================
  # Linting & Formatting
  # ============================================
  lint:
    desc: Run linter (ruff)
    cmds:
      - uv run ruff check .

  lint:fix:
    desc: Run linter with auto-fix
    cmds:
      - uv run ruff check --fix .

  fmt:
    desc: Format code (ruff)
    cmds:
      - uv run ruff format .

  typecheck:
    desc: Run type checker (mypy)
    cmds:
      - uv run mypy src

  # ============================================
  # Build & Publish
  # ============================================
  build:
    desc: Build package
    cmds:
      - uv build

  publish:
    desc: Publish to PyPI (requires PYPI_TOKEN)
    cmds:
      - uv publish

  publish:test:
    desc: Publish to TestPyPI
    cmds:
      - uv publish --index-url https://test.pypi.org/simple/

  # ============================================
  # Combined tasks
  # ============================================
  check:
    desc: Run all checks (fmt, lint, typecheck, test)
    cmds:
      - task: fmt
      - task: lint
      - task: typecheck
      - task: test

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf dist/
      - rm -rf htmlcov/
      - rm -rf .pytest_cache/
      - rm -rf .mypy_cache/
      - rm -rf .ruff_cache/
      - find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
