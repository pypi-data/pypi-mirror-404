"""Auto-generated tools from GL Connectors.

Authors:
    Saul Sayers (saul.sayers@gdplabs.id)
"""

from bosa_connectors import BosaConnector, BOSAConnectorToolGenerator
from langchain_core.tools import BaseTool

from aip_agents.tools.constants import (
    GL_CONNECTORS_API_KEY,
    GL_CONNECTORS_BASE_URL,
    GL_CONNECTORS_FETCH_MAX_RETRIES,
    ToolType,
)
from aip_agents.utils.logger import get_logger

logger = get_logger(__name__)


def get_gl_connector_modules_with_retry() -> list[str]:
    """Try to get available modules with retries.

    Returns:
        List of available modules.
    """
    if not GL_CONNECTORS_BASE_URL or not GL_CONNECTORS_API_KEY:
        logger.warning("GL Connectors credentials missing (base_url or api_key); returning empty modules list")
        return []

    connector = BosaConnector(api_base_url=GL_CONNECTORS_BASE_URL, api_key=GL_CONNECTORS_API_KEY)
    modules = []
    for attempt in range(GL_CONNECTORS_FETCH_MAX_RETRIES):
        try:
            modules = list(connector.get_available_modules())
            if modules:
                return modules
            logger.warning(
                f"Failed to get GL Connectors available modules, retrying... (attempt {attempt + 1} / {GL_CONNECTORS_FETCH_MAX_RETRIES})"
            )
        except Exception as e:
            logger.exception(
                f"Exception when getting GL Connectors available modules (attempt {attempt + 1} / {GL_CONNECTORS_FETCH_MAX_RETRIES}): {e}"
            )
    logger.error("Failed to get GL Connectors available modules after maximum retries")
    return modules


class LazyGLConnectorToolsDict(dict):
    """Lazy dictionary for GL Connectors."""

    def __missing__(self, app):
        """When a key is missing, create the tools and store them in the dictionary.

        Args:
            app: Name of the GL Connectors.

        Returns:
            List of tools generated by the GL Connectors tool generator.
        """
        if app not in get_gl_connector_modules():
            return []
        tools = []
        for attempt in range(GL_CONNECTORS_FETCH_MAX_RETRIES):
            try:
                tools = BOSAConnectorToolGenerator(
                    api_base_url=GL_CONNECTORS_BASE_URL,
                    api_key=GL_CONNECTORS_API_KEY,
                    app_name=app,
                ).generate_tools(tool_type=ToolType.LANGCHAIN)
                if tools:
                    self[app] = tools
                    return tools
                logger.warning(
                    f"Failed to create GL Connectors, retrying... (attempt {attempt + 1} / {GL_CONNECTORS_FETCH_MAX_RETRIES})"
                )
            except Exception as e:
                logger.exception(
                    f"Exception when creating GL Connectors for app '{app}' "
                    f"(attempt {attempt + 1} / {GL_CONNECTORS_FETCH_MAX_RETRIES}): {e}"
                )
        logger.error("Failed to create GL Connectors after maximum retries")
        return tools


# Supported modules (dynamic)
def get_gl_connector_modules() -> list[str]:
    """Lazily fetch and cache GL Connectors modules.

    Returns:
        List of GL Connectors modules.
    """
    if not hasattr(get_gl_connector_modules, "_cache"):
        get_gl_connector_modules._cache = get_gl_connector_modules_with_retry()
    return get_gl_connector_modules._cache


# FOR BACKWARDS COMPATIBILITY
def get_bosa_modules() -> list[str]:
    """Backward-compatible alias for get_gl_connector_modules."""
    return get_gl_connector_modules()


GL_CONNECTORS_MODULES = [
    "github",
    "twitter",
    "google",
    "google_drive",
    "google_mail",
    "google_docs",
]

# FOR BACKWARDS COMPATIBILITY
BOSA_MODULES = GL_CONNECTORS_MODULES

GL_CONNECTORS_AUTOMATED_TOOLS: dict[str, list[BaseTool]] = LazyGLConnectorToolsDict()

# FOR BACKWARDS COMPATIBILITY
BOSA_AUTOMATED_TOOLS = GL_CONNECTORS_AUTOMATED_TOOLS
