name: Release Detection

# Triggers releases automatically when version files change on main
# Only runs AFTER CI passes successfully
#
# Detection strategy: Compare current version against existing release tags.
# This is more robust than checking HEAD~1 because it works regardless of
# how many commits are pushed together, squash merges, rebases, etc.

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  actions: write  # Required for workflow_dispatch API

jobs:
  detect-changes:
    # Only run if CI passed and it was a push (not PR)
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'
    runs-on: ubuntu-latest
    outputs:
      sdk_changed: ${{ steps.changes.outputs.sdk }}
      mcp_changed: ${{ steps.changes.outputs.mcp }}
      sdk_version: ${{ steps.versions.outputs.sdk }}
      mcp_version: ${{ steps.versions.outputs.mcp }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0  # Full history needed to check tags

      - name: Extract versions
        id: versions
        run: |
          set -euo pipefail
          SDK_VERSION=$(grep '^version = ' pyproject.toml | head -1 | cut -d'"' -f2)
          MCP_VERSION=$(cat mcp/VERSION | tr -d '[:space:]')
          echo "sdk=$SDK_VERSION" >> $GITHUB_OUTPUT
          echo "mcp=$MCP_VERSION" >> $GITHUB_OUTPUT
          echo "SDK version in pyproject.toml: $SDK_VERSION"
          echo "MCP version in mcp/VERSION: $MCP_VERSION"

      - name: Detect unreleased versions
        id: changes
        run: |
          set -euo pipefail

          SDK_VERSION="${{ steps.versions.outputs.sdk }}"
          MCP_VERSION="${{ steps.versions.outputs.mcp }}"

          echo "Checking if releases exist for current versions..."

          # Check if SDK version has a release tag
          SDK_TAG="v${SDK_VERSION}"
          if git tag -l "$SDK_TAG" | grep -q "^${SDK_TAG}$"; then
            echo "SDK tag $SDK_TAG already exists - no release needed"
          else
            echo "SDK tag $SDK_TAG does not exist - release needed"
            echo "sdk=true" >> $GITHUB_OUTPUT
          fi

          # Check if MCP version has a release tag
          MCP_TAG="mcp-v${MCP_VERSION}"
          if git tag -l "$MCP_TAG" | grep -q "^${MCP_TAG}$"; then
            echo "MCP tag $MCP_TAG already exists - no release needed"
          else
            echo "MCP tag $MCP_TAG does not exist - release needed"
            echo "mcp=true" >> $GITHUB_OUTPUT
          fi

  trigger-sdk-release:
    needs: detect-changes
    if: needs.detect-changes.outputs.sdk_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger SDK release workflow
        uses: actions/github-script@v8
        with:
          script: |
            // Use toJSON for safe string interpolation
            const version = ${{ toJSON(needs.detect-changes.outputs.sdk_version) }};
            console.log(`Triggering SDK release workflow for version ${version}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'release.yml',
                ref: 'main',
                inputs: {
                  version: version,
                  triggered_by: 'release-detect'
                }
              });
              console.log(`✅ SDK release workflow triggered successfully for v${version}`);
            } catch (error) {
              console.error(`❌ Failed to trigger SDK release: ${error.message}`);
              core.setFailed(`Failed to trigger SDK release workflow: ${error.message}`);
            }

  trigger-mcp-release:
    needs: detect-changes
    if: needs.detect-changes.outputs.mcp_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger MCP plugin release workflow
        uses: actions/github-script@v8
        with:
          script: |
            // Use toJSON for safe string interpolation
            const version = ${{ toJSON(needs.detect-changes.outputs.mcp_version) }};
            console.log(`Triggering MCP plugin release workflow for version ${version}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'plugin-release.yml',
                ref: 'main',
                inputs: {
                  version: version,
                  triggered_by: 'release-detect'
                }
              });
              console.log(`✅ MCP release workflow triggered successfully for v${version}`);
            } catch (error) {
              console.error(`❌ Failed to trigger MCP release: ${error.message}`);
              core.setFailed(`Failed to trigger MCP release workflow: ${error.message}`);
            }
