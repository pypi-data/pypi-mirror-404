name: Build MCP Plugin

on:
  push:
    branches: [main]
    paths:
      - 'mcp/**'
      - '!mcp/dist/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Install mcp-bash framework
        run: |
          # Source version and commit from lockfile (single source of truth)
          source mcp/mcp-bash.lock
          echo "Installing mcp-bash v${MCPBASH_VERSION} (${MCPBASH_COMMIT})"
          curl -fsSL https://raw.githubusercontent.com/yaniv-golan/mcp-bash-framework/main/install.sh | \
            bash -s -- --version "v${MCPBASH_VERSION}" --yes
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Verify installed commit matches lockfile
          INSTALLED_COMMIT=$(git -C "${XDG_DATA_HOME:-$HOME/.local/share}/mcp-bash" rev-parse HEAD)
          if [[ "$INSTALLED_COMMIT" != "$MCPBASH_COMMIT" ]]; then
            echo "::error::mcp-bash commit mismatch: expected $MCPBASH_COMMIT, got $INSTALLED_COMMIT"
            exit 1
          fi

      - name: Verify mcp-bash installation
        run: |
          mcp-bash --version
          echo "mcp-bash installed successfully"

      - name: Build MCP plugin ZIP
        run: make -C mcp plugin

      - name: Verify plugin structure
        run: |
          make -C mcp verify
          test -f mcp/.claude-plugin/xaffinity-mcp.sh
          test -f mcp/.claude-plugin/plugin.json
          test -f mcp/.claude-plugin/xaffinity-mcp-plugin.zip
          test -f mcp/.claude-plugin/VERSION
          echo "Plugin structure validated"

      - name: Test extraction
        run: |
          cd mcp/.claude-plugin
          mkdir -p .mcp-extracted
          unzip -q xaffinity-mcp-plugin.zip -d .mcp-extracted
          test -x .mcp-extracted/xaffinity-mcp.sh
          test -f .mcp-extracted/VERSION
          rm -rf .mcp-extracted
          echo "Extraction test passed"

      - name: Validate MCPB configuration
        run: |
          cd mcp
          mcp-bash bundle --validate
          echo "MCPB configuration validated"

      - name: Build MCPB bundle
        run: |
          cd mcp
          mcp-bash bundle --output dist --verbose
          ls -la dist/*.mcpb
          echo "MCPB bundle created"

      - name: Validate MCPB bundle structure
        run: |
          cd mcp
          MCPB_FILE=$(ls dist/*.mcpb | head -1)
          unzip -t "$MCPB_FILE"
          unzip -p "$MCPB_FILE" manifest.json | jq .
          echo "MCPB bundle structure validated"

      - name: Test MCPB bundle health check
        run: |
          cd mcp
          MCPB_FILE=$(ls dist/*.mcpb | head -1)
          EXTRACT_DIR=$(mktemp -d)
          unzip -q "$MCPB_FILE" -d "$EXTRACT_DIR"
          # Test the wrapper script health check
          "$EXTRACT_DIR/server/run-server.sh" --health || echo "Health check not available (expected if CLI not configured)"
          rm -rf "$EXTRACT_DIR"
          echo "MCPB bundle test completed"

      - name: Upload plugin artifacts
        uses: actions/upload-artifact@v6
        with:
          name: mcp-plugin
          path: |
            mcp/.claude-plugin/xaffinity-mcp-plugin.zip
            mcp/dist/*.mcpb
          retention-days: 30
