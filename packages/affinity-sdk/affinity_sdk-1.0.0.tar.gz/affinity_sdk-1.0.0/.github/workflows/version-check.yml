name: Version Consistency Check

on:
  pull_request:  # Run on ALL PRs - the check is fast and catches edge cases
  push:
    branches: [main]  # Ensure main is always validated

jobs:
  check-versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Extract SDK version
        id: sdk
        run: |
          SDK_VERSION=$(grep '^version = ' pyproject.toml | head -1 | cut -d'"' -f2)
          echo "version=$SDK_VERSION" >> $GITHUB_OUTPUT

      - name: Check SDK plugin version matches
        run: |
          PLUGIN_VERSION=$(jq -r '.version' plugins/affinity-sdk/.claude-plugin/plugin.json)
          if [ "$PLUGIN_VERSION" != "${{ steps.sdk.outputs.version }}" ]; then
            echo "::error::SDK plugin version ($PLUGIN_VERSION) != SDK version (${{ steps.sdk.outputs.version }})"
            exit 1
          fi

      - name: Check CLI plugin version matches
        run: |
          PLUGIN_VERSION=$(jq -r '.version' plugins/xaffinity-cli/.claude-plugin/plugin.json)
          if [ "$PLUGIN_VERSION" != "${{ steps.sdk.outputs.version }}" ]; then
            echo "::error::CLI plugin version ($PLUGIN_VERSION) != SDK version (${{ steps.sdk.outputs.version }})"
            exit 1
          fi

      - name: Check MCP CLI compatibility
        shell: bash
        run: |
          source mcp/COMPATIBILITY
          SDK_MINOR=$(echo "${{ steps.sdk.outputs.version }}" | cut -d. -f1-2)
          MIN_MINOR=$(echo "$CLI_MIN_VERSION" | cut -d. -f1-2)
          # SDK minor version should be >= CLI_MIN_VERSION minor
          if [ "$(printf '%s\n%s' "$MIN_MINOR" "$SDK_MINOR" | sort -V | head -1)" != "$MIN_MINOR" ]; then
            echo "::error::SDK version ${{ steps.sdk.outputs.version }} is below MCP minimum ($CLI_MIN_VERSION)"
            exit 1
          fi

      - name: Check MCP plugin version matches VERSION
        run: |
          MCP_VERSION=$(cat mcp/VERSION | tr -d '[:space:]')
          PLUGIN_VERSION=$(jq -r '.version' mcp/.claude-plugin/plugin.json)
          if [ "$PLUGIN_VERSION" != "$MCP_VERSION" ]; then
            echo "::error::MCP plugin.json version ($PLUGIN_VERSION) != VERSION file ($MCP_VERSION)"
            exit 1
          fi
          echo "MCP plugin version: $MCP_VERSION"

      - name: Check mcp-bash lockfile
        run: |
          # Verify lockfile exists
          if [ ! -f mcp/mcp-bash.lock ]; then
            echo "::error::mcp/mcp-bash.lock not found"
            exit 1
          fi

          # Source and validate lockfile
          source mcp/mcp-bash.lock

          # Validate version format
          if ! [[ "$MCPBASH_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid MCPBASH_VERSION format: $MCPBASH_VERSION"
            exit 1
          fi
          echo "Framework version: $MCPBASH_VERSION"

          # Validate commit hash format
          if ! [[ "$MCPBASH_COMMIT" =~ ^[0-9a-f]{40}$ ]]; then
            echo "::error::Invalid MCPBASH_COMMIT format: $MCPBASH_COMMIT"
            exit 1
          fi
          echo "Framework commit: $MCPBASH_COMMIT"

          # Verify the hash matches the remote tag (use ^{} to get commit hash, not tag object)
          REMOTE_HASH=$(git ls-remote https://github.com/yaniv-golan/mcp-bash-framework.git "v${MCPBASH_VERSION}^{}" | cut -f1)
          if [ -z "$REMOTE_HASH" ]; then
            echo "::warning::Could not verify remote hash for v${MCPBASH_VERSION} (tag may not exist yet)"
          elif [ "$MCPBASH_COMMIT" != "$REMOTE_HASH" ]; then
            echo "::error::MCPBASH_COMMIT ($MCPBASH_COMMIT) does not match remote v${MCPBASH_VERSION} commit ($REMOTE_HASH)"
            exit 1
          else
            echo "Commit hash verified against remote tag"
          fi
