"""
${Entity} model (SQLAlchemy ORM).

Auto-generated by fin-infra scaffold. Customize as needed.
"""
from datetime import datetime, timezone
from decimal import Decimal
from typing import Any, Dict, Optional
from uuid import uuid4

from sqlalchemy import DateTime, Index, Integer, Numeric, String, Text, text
from sqlalchemy.dialects.postgresql import JSON
from sqlalchemy.ext.mutable import MutableDict
from sqlalchemy.orm import Mapped, mapped_column

from svc_infra.db.sql.base import ModelBase
from svc_infra.db.sql.types import GUID
from svc_infra.db.sql.uniq import make_unique_sql_indexes


class ${Entity}(ModelBase):
    """Financial goal tracking model.
    
    Tracks user financial goals with progress monitoring, milestones, and status.
    Used for personal finance goal tracking, retirement planning, and savings targets.
    
    Attributes:
        id: Unique goal identifier (UUID)
        user_id: User who owns this goal
        name: Goal name (e.g., "Emergency Fund", "House Down Payment")
        description: Optional detailed description
        target_amount: Financial goal amount (e.g., $10,000.00)
        current_amount: Current progress toward goal (default: $0.00)
        target_date: Goal deadline (timezone-aware datetime)
        status: Goal status (active, achieved, abandoned, paused)
        priority: Goal importance ranking (1=highest)
        category: Goal category (emergency_fund, retirement, vacation, etc.)
        extra: Additional metadata (JSON)
        milestones: Progress milestones (JSON) - e.g., [{"amount": 5000, "label": "Halfway"}]
        created_at: When goal was created
        updated_at: When goal was last modified${tenant_doc}${soft_delete_field}
    """
    __tablename__ = "${table_name}"

    # Primary key
    id: Mapped[str] = mapped_column(
        GUID(),
        primary_key=True,
        default=uuid4,
        doc="Unique goal identifier"
    )

    # Core fields (user_id nullable for simple testing, set to False in production)
    user_id: Mapped[Optional[str]] = mapped_column(
        String(64),
        nullable=True,
        index=True,
        doc="User who owns this goal"
    )
    
    name: Mapped[str] = mapped_column(
        String(128),
        nullable=False,
        doc="Goal name (e.g., 'Emergency Fund')"
    )
    
    description: Mapped[Optional[str]] = mapped_column(
        Text,
        nullable=True,
        doc="Optional detailed description"
    )
    
    # Financial amounts
    target_amount: Mapped[Decimal] = mapped_column(
        Numeric(15, 2),
        nullable=False,
        doc="Financial goal amount (e.g., 10000.00)"
    )
    
    current_amount: Mapped[Decimal] = mapped_column(
        Numeric(15, 2),
        nullable=False,
        default=Decimal("0.00"),
        server_default=text("0.00"),
        doc="Current progress toward goal"
    )
    
    # Timeline
    target_date: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        doc="Goal deadline (timezone-aware)"
    )
    
    # Status and priority
    status: Mapped[str] = mapped_column(
        String(32),
        nullable=False,
        default="active",
        server_default=text("'active'"),
        doc="Goal status (active, achieved, abandoned, paused)"
    )
    
    priority: Mapped[int] = mapped_column(
        Integer,
        nullable=False,
        default=1,
        server_default=text("1"),
        doc="Goal importance ranking (1=highest)"
    )
    
    category: Mapped[Optional[str]] = mapped_column(
        String(64),
        nullable=True,
        doc="Goal category (emergency_fund, retirement, vacation, etc.)"
    )
    
    # JSON fields
    extra: Mapped[Optional[Dict[str, Any]]] = mapped_column(
        MutableDict.as_mutable(JSON),
        nullable=True,
        doc="Additional metadata (JSON)"
    )
    
    milestones: Mapped[Optional[Dict[str, Any]]] = mapped_column(
        JSON,
        nullable=True,
        doc="Progress milestones (JSON) - e.g., [{'amount': 5000, 'label': 'Halfway'}]"
    )
${tenant_field}
    # Timestamps
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=text("CURRENT_TIMESTAMP"),
        nullable=False
    )
    
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=text("CURRENT_TIMESTAMP"),
        onupdate=text("CURRENT_TIMESTAMP"),
        nullable=False
    )

    def __repr__(self) -> str:
        return f"<${Entity} id={self.id} name={self.name!r} user_id={self.user_id!r}>"
    
    @property
    def percent_complete(self) -> Decimal:
        """Calculate goal completion percentage."""
        if self.target_amount == 0:
            return Decimal("0.00")
        return (self.current_amount / self.target_amount * 100).quantize(Decimal("0.01"))

# --- Uniqueness policy --------------------------------------------------------
# Goals are unique by (user_id, name) or (tenant_id, user_id, name) if multi-tenant
for _ix in make_unique_sql_indexes(
    ${Entity},
    unique_ci=["user_id", "name"]${tenant_arg_unique_index}
):
    pass

# ----------------------- Service factory ---------------------------------------

def make_goal_service(session):
    """Create a goal service instance.
    
    Usage:
        from sqlalchemy.ext.asyncio import AsyncSession
        
        async with AsyncSession(engine) as session:
            service = make_goal_service(session)
            goal = await service.create_goal(user_id="u123", name="Emergency Fund", target_amount=10000)
    """
    from .${entity}_repository import ${Entity}Repository
    return ${Entity}Repository(session)
