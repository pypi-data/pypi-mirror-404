syntax = "proto3";

package basilica.billing.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";

// Billing service for credit management, rental tracking, and telemetry ingestion
service BillingService {
    // Credit management
    rpc ApplyCredits(ApplyCreditsRequest) returns (ApplyCreditsResponse);
    rpc GetBalance(GetBalanceRequest) returns (GetBalanceResponse);

    // Rental tracking
    rpc TrackRental(TrackRentalRequest) returns (TrackRentalResponse);
    rpc UpdateRentalStatus(UpdateRentalStatusRequest) returns (UpdateRentalStatusResponse);
    rpc GetActiveRentals(GetActiveRentalsRequest) returns (GetActiveRentalsResponse);
    rpc FinalizeRental(FinalizeRentalRequest) returns (FinalizeRentalResponse);

    // Telemetry ingestion
    rpc IngestTelemetry(stream TelemetryData) returns (IngestResponse);
    rpc GetUsageReport(UsageReportRequest) returns (UsageReportResponse);

    // Miner revenue reconciliation
    rpc RefreshMinerRevenueSummary(RefreshMinerRevenueSummaryRequest) returns (RefreshMinerRevenueSummaryResponse);
    rpc GetMinerRevenueSummary(GetMinerRevenueSummaryRequest) returns (GetMinerRevenueSummaryResponse);

    // Miner payment operations
    rpc GetUnpaidMinerRevenueSummary(GetUnpaidMinerRevenueSummaryRequest) returns (GetUnpaidMinerRevenueSummaryResponse);
    rpc MarkMinerRevenuePaid(MarkMinerRevenuePaidRequest) returns (MarkMinerRevenuePaidResponse);

    // Rental status lookup (for credit exhaustion monitoring)
    rpc GetRentalStatus(GetRentalStatusRequest) returns (GetRentalStatusResponse);
}

// Credit Management Messages

message ApplyCreditsRequest {
    string user_id = 1;
    string amount = 2; // Decimal string for precision
    string transaction_id = 3;
    string payment_method = 4;
    map<string, string> metadata = 5;
}

message ApplyCreditsResponse {
    bool success = 1;
    string new_balance = 2; // Decimal string
    string credit_id = 3;
    google.protobuf.Timestamp applied_at = 4;
}

message GetBalanceRequest {
    string user_id = 1;
}

message GetBalanceResponse {
    string available_balance = 1; // Decimal string
    string total_balance = 2; // Decimal string
    google.protobuf.Timestamp last_updated = 3;
}

// Rental Tracking Messages

message TrackRentalRequest {
    string rental_id = 1;
    string user_id = 2;
    ResourceSpec resource_spec = 5;
    reserved 6; // Previously hourly_rate (DEPRECATED: removed in favor of marketplace pricing fields)
    google.protobuf.Timestamp start_time = 7;
    map<string, string> metadata = 8;

    // Cloud type specific data
    oneof cloud_type {
        CommunityCloudData community = 20;
        SecureCloudData secure = 21;
        OrchestratorCloudData orchestrator = 22;
        StorageCloudData storage = 23;
    }
}

// Community cloud rental data (validator-based)
message CommunityCloudData {
    string node_id = 1;           // Miner node ID
    string validator_id = 2;      // Validator hotkey
    double base_price_per_gpu = 3; // Final price per GPU per hour (already includes markup)
    uint32 gpu_count = 4;          // Number of GPUs in this rental
    uint32 miner_uid = 5;          // Bittensor miner UID for payment reconciliation
    string miner_hotkey = 6;       // Bittensor miner hotkey for payment reconciliation
}

// Secure cloud rental data (direct provider API)
// Uses additive pricing: total_cost = hours × (gpu_cost + cpu_cost + ram_cost + storage_cost)
message SecureCloudData {
    string provider_instance_id = 1; // Provider's instance ID
    string provider = 2;              // Provider name (e.g., "datacrunch", "hyperstack")
    string offering_id = 3;           // Original offering ID from aggregator
    double base_price_per_gpu = 4;    // Price per GPU per hour (0 for CPU-only rentals)
    uint32 gpu_count = 5;             // Number of GPUs in this rental (0 for CPU-only rentals)
    double base_price_per_cpu = 6;    // Price per vCPU per hour (0 for GPU rentals)
    uint32 cpu_count = 7;             // Number of vCPUs in this rental
    double base_price_per_ram = 8;    // Price per GB RAM per hour (0 for GPU rentals)
    uint32 ram_gb = 9;                // Amount of RAM in GB
    double base_price_per_storage = 10; // Price per GB storage per hour (0 for GPU rentals)
    uint32 storage_gb = 11;             // Amount of storage in GB
}

// Orchestrator cloud rental data (K3s UserDeployment billing)
// Uses additive pricing: total_cost = hours × (gpu_cost + cpu_cost + ram_cost + storage_cost)
message OrchestratorCloudData {
    string namespace = 1;             // User namespace (e.g., "u-github-12345")
    string instance_name = 2;         // UserDeployment instance name
    string user_id = 3;               // User identifier
    uint32 replicas = 4;              // Number of replicas
    bool storage_enabled = 5;         // FUSE storage enabled
    bool public = 6;                  // Publicly accessible
    double base_price_per_gpu = 7;    // Price per GPU per hour (0 for CPU-only)
    uint32 gpu_count = 8;             // Number of GPUs (0 for CPU-only)
    double base_price_per_cpu = 9;    // Price per vCPU per hour
    uint32 cpu_count = 10;            // Number of vCPUs
    double base_price_per_ram = 11;   // Price per GB RAM per hour
    uint32 ram_gb = 12;               // Amount of RAM in GB
    double base_price_per_storage = 13; // Price per GB storage per hour
    uint32 storage_gb = 14;             // Amount of storage in GB
}

// Storage cloud rental data (block storage volumes)
// Uses additive pricing: total_cost = hours × (storage_cost)
message StorageCloudData {
    string provider = 1;                // Provider name (e.g., "hyperstack")
    string provider_volume_id = 2;      // Provider's volume ID
    string volume_type = 3;             // Volume type (e.g., "Cloud-SSD")
    string region = 4;                  // Region where volume exists
    uint32 size_gb = 5;                 // Volume size in GB
    double base_price_per_storage = 6;  // Price per GB per hour (already includes markup)
    string attached_rental_id = 7;      // Optional: rental ID when attached
}

message ResourceSpec {
    uint32 cpu_cores = 1;
    uint64 memory_mb = 2;
    repeated GpuSpec gpus = 3;
    uint64 disk_gb = 4;
    uint64 network_bandwidth_mbps = 5;
}

message GpuSpec {
    string model = 1;
    uint64 memory_mb = 2;
    uint32 count = 3;
}

message TrackRentalResponse {
    bool success = 1;
    string tracking_id = 2;
}

message UpdateRentalStatusRequest {
    string rental_id = 1;
    RentalStatus status = 2;
    google.protobuf.Timestamp timestamp = 3;
    string reason = 4;
}

enum RentalStatus {
    RENTAL_STATUS_UNSPECIFIED = 0;
    RENTAL_STATUS_PENDING = 1;
    RENTAL_STATUS_ACTIVE = 2;
    RENTAL_STATUS_STOPPING = 3;
    RENTAL_STATUS_STOPPED = 4;
    RENTAL_STATUS_FAILED = 5;
    RENTAL_STATUS_FAILED_INSUFFICIENT_CREDITS = 6;
}

message UpdateRentalStatusResponse {
    bool success = 1;
    string current_cost = 2; // Decimal string
    google.protobuf.Timestamp updated_at = 3;
}

message GetRentalStatusRequest {
    string rental_id = 1;
}

message GetRentalStatusResponse {
    string rental_id = 1;
    RentalStatus status = 2;
    string user_id = 3;
}

message GetActiveRentalsRequest {
    string user_id = 1;
    reserved 2, 3; // Previously validator_id, node_id (removed - never used in production)
    uint32 limit = 4;
    uint32 offset = 5;
    repeated RentalStatus status_filter = 6; // Filter by status; empty = all statuses
}

message GetActiveRentalsResponse {
    repeated ActiveRental rentals = 1;
    uint64 total_count = 2;
}

message ActiveRental {
    string rental_id = 1;
    string user_id = 2;
    RentalStatus status = 5;
    ResourceSpec resource_spec = 6;
    reserved 7; // Previously hourly_rate (DEPRECATED: removed in favor of marketplace pricing fields)
    string current_cost = 8; // Decimal string
    google.protobuf.Timestamp start_time = 9;
    google.protobuf.Timestamp last_updated = 10;
    map<string, string> metadata = 11;

    // Cloud type specific data
    oneof cloud_type {
        CommunityCloudData community = 20;
        SecureCloudData secure = 21;
        OrchestratorCloudData orchestrator = 22;
        StorageCloudData storage = 23;
    }
}

message FinalizeRentalRequest {
    string rental_id = 1;
    google.protobuf.Timestamp end_time = 2;
    reserved 3;
    reserved "final_cost";
    string termination_reason = 4;
    // Desired final rental state. Defaults to STOPPED if not specified.
    RentalStatus target_status = 5;
}

message FinalizeRentalResponse {
    bool success = 1;
    string total_cost = 2; // Decimal string
    google.protobuf.Duration duration = 3;
    string charged_amount = 4; // Decimal string
    string refunded_amount = 5; // Decimal string
}

// Telemetry Messages

message TelemetryData {
    string rental_id = 1;
    string node_id = 2;
    google.protobuf.Timestamp timestamp = 3;
    ResourceUsage resource_usage = 4;
    map<string, double> custom_metrics = 5;
}

message ResourceUsage {
    double cpu_percent = 1;
    uint64 memory_mb = 2;
    uint64 network_rx_bytes = 3;
    uint64 network_tx_bytes = 4;
    uint64 disk_read_bytes = 5;
    uint64 disk_write_bytes = 6;
    repeated GpuUsage gpu_usage = 7;
}

message GpuUsage {
    uint32 index = 1;
    double utilization_percent = 2;
    uint64 memory_used_mb = 3;
    double temperature_celsius = 4;
    uint64 power_watts = 5;
}

message IngestResponse {
    uint64 events_received = 1;
    uint64 events_processed = 2;
    uint64 events_failed = 3;
    google.protobuf.Timestamp last_processed = 4;
}

message UsageReportRequest {
    string rental_id = 1;
    google.protobuf.Timestamp start_time = 2;
    google.protobuf.Timestamp end_time = 3;
    UsageAggregation aggregation = 4;
}

enum UsageAggregation {
    USAGE_AGGREGATION_UNSPECIFIED = 0;
    USAGE_AGGREGATION_MINUTE = 1;
    USAGE_AGGREGATION_HOUR = 2;
    USAGE_AGGREGATION_DAY = 3;
}

message UsageReportResponse {
    string rental_id = 1;
    repeated UsageDataPoint data_points = 2;
    UsageSummary summary = 3;
    string total_cost = 4; // Decimal string
}

message UsageDataPoint {
    google.protobuf.Timestamp timestamp = 1;
    ResourceUsage usage = 2;
    string cost = 3; // Decimal string for this period
}

message UsageSummary {
    double avg_cpu_percent = 1;
    uint64 avg_memory_mb = 2;
    uint64 total_network_bytes = 3;
    uint64 total_disk_bytes = 4;
    double avg_gpu_utilization = 5;
    google.protobuf.Duration duration = 6;
}

// Error details for better error handling
message ErrorDetail {
    string code = 1;
    string message = 2;
    map<string, string> metadata = 3;
}

// Miner Revenue Reconciliation Messages

message RefreshMinerRevenueSummaryRequest {
    string period_start = 1; // Start date in YYYY-MM-DD format (inclusive)
    string period_end = 2;   // End date in YYYY-MM-DD format (inclusive, must be before today)
    uint32 computation_version = 3; // Version of computation logic (default: 1)
}

message RefreshMinerRevenueSummaryResponse {
    bool success = 1;
    uint32 summaries_created = 2; // Number of summary rows created
    google.protobuf.Timestamp computed_at = 3;
    string error_message = 4;
}

message GetMinerRevenueSummaryRequest {
    // Filter criteria (all optional)
    repeated string node_ids = 1; // Filter by specific node IDs
    repeated string validator_ids = 2; // Filter by specific validator IDs
    string period_start = 3; // Filter by period start (YYYY-MM-DD format)
    string period_end = 4;   // Filter by period end (YYYY-MM-DD format)
    google.protobuf.Timestamp computed_at = 5; // Get snapshot from specific computation time
    bool latest_only = 6; // Only return most recent computation for each (node, validator, period)

    // Pagination
    uint32 limit = 7;
    uint32 offset = 8;

    // Filter by miner UIDs
    repeated uint32 miner_uids = 9; // Filter by specific Bittensor miner UIDs

    // Filter by miner hotkeys
    repeated string miner_hotkeys = 10; // Filter by specific Bittensor miner hotkeys
}

message GetMinerRevenueSummaryResponse {
    repeated MinerRevenueSummary summaries = 1;
    uint64 total_count = 2;
}

message MinerRevenueSummary {
    string id = 1; // UUID
    string node_id = 2;
    string validator_id = 3; // Nullable
    uint32 miner_uid = 16; // Bittensor miner UID (part of grouping key with miner_hotkey)
    string miner_hotkey = 17; // Bittensor miner hotkey (part of grouping key with miner_uid)

    // Time period
    google.protobuf.Timestamp period_start = 4;
    google.protobuf.Timestamp period_end = 5;

    // Aggregated metrics
    uint32 total_rentals = 6;
    uint32 completed_rentals = 7;
    uint32 failed_rentals = 8;
    string total_revenue = 9; // Decimal string (USD)
    string total_hours = 10; // Decimal string

    // Computed metrics
    string avg_hourly_rate = 11; // Decimal string (nullable)
    string avg_rental_duration_hours = 12; // Decimal string (nullable)

    // Audit fields
    google.protobuf.Timestamp computed_at = 13;
    uint32 computation_version = 14;
    google.protobuf.Timestamp created_at = 15;

    // Payment tracking
    bool paid = 18;
    string tx_hash = 19; // Blockchain transaction hash (nullable)
}

// Miner Payment Messages

message GetUnpaidMinerRevenueSummaryRequest {
    string period_start = 1; // Start date in YYYY-MM-DD format (inclusive)
    string period_end = 2;   // End date in YYYY-MM-DD format (inclusive)
    uint32 limit = 3;
    uint32 offset = 4;
}

message GetUnpaidMinerRevenueSummaryResponse {
    repeated MinerRevenueSummary summaries = 1;
    uint64 total_count = 2;
}

message MarkMinerRevenuePaidRequest {
    string id = 1;      // UUID of the miner_revenue_summary record
    string tx_hash = 2; // Blockchain transaction hash for this payment
}

message MarkMinerRevenuePaidResponse {
    bool success = 1;
    string error_message = 2;
}
