name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv pip install --system -e ".[dev]"

    - name: Lint with ruff (non-blocking)
      continue-on-error: true
      run: |
        uv pip install --system ruff
        ruff check praisonaiwp/ tests/ || true

    - name: Run unit tests
      run: |
        pytest tests/ -v --ignore=tests/test_cli_integration.py --ignore=tests/ai/ --ignore=tests/cli/test_ai_commands.py --ignore=tests/test_e2e_ai.py

    - name: Run integration tests
      run: |
        pytest tests/test_cli_integration.py -v

    - name: Test CLI imports
      run: |
        python -c "from praisonaiwp.cli.main import cli; print('✅ CLI imports successful')"
        python -c "from praisonaiwp.cli.commands.create import create_command; print('✅ Create command imports successful')"
        python -c "from praisonaiwp.cli.commands.update import update_command; print('✅ Update command imports successful')"

    - name: Test CLI help commands
      run: |
        python -m praisonaiwp.cli.main --help
        python -m praisonaiwp.cli.main create --help
        python -m praisonaiwp.cli.main update --help
        python -m praisonaiwp.cli.main list --help
        python -m praisonaiwp.cli.main find --help

    - name: Test package version
      run: |
        python -c "from praisonaiwp.__version__ import __version__; print(f'Version: {__version__}')"

    - name: Build package
      run: |
        uv build

    - name: Test package installation
      run: |
        pip install dist/*.whl
        python -c "import praisonaiwp; print('✅ Package installed successfully')"
        python -m praisonaiwp.cli.main --help

    - name: Upload coverage
      if: matrix.python-version == '3.12'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  integration-check:
    runs-on: ubuntu-latest
    needs: [test]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install package
      run: |
        pip install -e .

    - name: Critical import regression tests
      run: |
        # Test that v1.0.17 bug doesn't happen again
        python -c "from praisonaiwp.editors.content_editor import ContentEditor; print('✅ ContentEditor in correct location')"
        python -c "from praisonaiwp.utils.block_converter import convert_to_blocks; print('✅ Block converter accessible')"
        
        # Test that wrong imports fail
        python -c "
        try:
            from praisonaiwp.core.content_editor import ContentEditor
            print('❌ FAIL: ContentEditor should NOT be in core/')
            exit(1)
        except ModuleNotFoundError:
            print('✅ PASS: ContentEditor correctly not in core/')
        "

    - name: Test all CLI commands work
      run: |
        python -m praisonaiwp.cli.main --help
        python -m praisonaiwp.cli.main create --help | grep -q "convert-to-blocks"
        python -m praisonaiwp.cli.main update --help | grep -q "convert-to-blocks"
        echo "✅ All CLI commands working"

    - name: Summary
      run: |
        echo "✅ All integration checks passed"
        echo "✅ No import errors detected"
        echo "✅ CLI commands functional"
        echo "✅ New features accessible"
