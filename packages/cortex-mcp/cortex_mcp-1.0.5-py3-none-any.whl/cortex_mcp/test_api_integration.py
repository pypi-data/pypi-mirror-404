"""
Cortex Web API 통합 테스트
실제 데이터 전송 및 Admin/유저 대시보드 확인
"""

import requests
import time
import sys
from pathlib import Path

# 테스트 서버 URL
BASE_URL = "http://localhost:8000"

# 테스트용 라이센스 키 (실제로는 DB에 있어야 함)
# 먼저 웹 UI에서 사용자 승인 후 라이센스 키를 여기에 입력
LICENSE_KEY = "CORTEX-A464-EC40-E5AE-E6EF"  # Auto-generated by setup_test_user.py


def test_telemetry_api():
    """텔레메트리 API 테스트"""
    print("\n[TEST 1] POST /api/telemetry - 사용 지표 전송")
    print("=" * 60)

    data = {
        "license_key": LICENSE_KEY,
        "module_name": "memory_manager",
        "total_calls": 100,
        "success_count": 95,
        "error_count": 5,
        "total_latency_ms": 1234.5,
    }

    response = requests.post(f"{BASE_URL}/api/telemetry", json=data)
    print(f"Status Code: {response.status_code}")
    print(f"Response: {response.json()}")

    if response.status_code == 200:
        print("✅ 텔레메트리 전송 성공")
        return True
    else:
        print("❌ 텔레메트리 전송 실패")
        return False


def test_errors_api():
    """에러 로그 API 테스트"""
    print("\n[TEST 2] POST /api/errors - 에러 로그 전송")
    print("=" * 60)

    data = {
        "license_key": LICENSE_KEY,
        "error_type": "mcp_tool_error",
        "tool_name": "update_memory",
        "error_message": "Failed to update memory: Connection timeout",
        "stack_trace": "Traceback: ...",
        "context": '{"project_id": "test_project"}',
        "severity": "error",
    }

    response = requests.post(f"{BASE_URL}/api/errors", json=data)
    print(f"Status Code: {response.status_code}")
    print(f"Response: {response.json()}")

    if response.status_code == 200:
        print("✅ 에러 로그 전송 성공")
        return True
    else:
        print("❌ 에러 로그 전송 실패")
        return False


def test_research_metrics_api():
    """연구 메트릭 API 테스트 (논문 데이터)"""
    print("\n[TEST 3] POST /api/research_metrics - 논문 데이터 전송")
    print("=" * 60)

    data = {
        "license_key": LICENSE_KEY,
        "beta_phase": "closed_beta",
        "context_stability_score": 0.95,
        "recovery_time_ms": 123.4,
        "intervention_precision": 0.88,
        "user_acceptance_count": 10,
        "user_rejection_count": 2,
        "session_id": "session_test_123",
    }

    response = requests.post(f"{BASE_URL}/api/research_metrics", json=data)
    print(f"Status Code: {response.status_code}")
    print(f"Response: {response.json()}")

    if response.status_code == 200:
        print("✅ 논문 데이터 전송 성공")
        return True
    else:
        print("❌ 논문 데이터 전송 실패")
        return False


def test_license_verify_api():
    """라이센스 검증 API 테스트"""
    print("\n[TEST 4] POST /api/license/verify - 라이센스 검증")
    print("=" * 60)

    data = {"license_key": LICENSE_KEY}

    response = requests.post(f"{BASE_URL}/api/license/verify", json=data)
    print(f"Status Code: {response.status_code}")
    print(f"Response: {response.json()}")

    if response.status_code == 200:
        result = response.json()
        if result.get("valid"):
            print(f"✅ 라이센스 유효: {result.get('tier')} / {result.get('github_login')}")
            return True
        else:
            print("❌ 라이센스 무효")
            return False
    else:
        print("❌ 라이센스 검증 실패")
        return False


def test_multiple_telemetry():
    """다양한 모듈의 텔레메트리 전송 (Admin 통계 확인용)"""
    print("\n[TEST 5] 다양한 모듈 텔레메트리 전송")
    print("=" * 60)

    modules = [
        {"module_name": "rag_engine", "total_calls": 50, "success_count": 48, "error_count": 2},
        {"module_name": "backup_manager", "total_calls": 20, "success_count": 20, "error_count": 0},
        {"module_name": "git_sync", "total_calls": 15, "success_count": 14, "error_count": 1},
        {"module_name": "context_manager", "total_calls": 80, "success_count": 75, "error_count": 5},
    ]

    for module_data in modules:
        data = {
            "license_key": LICENSE_KEY,
            "total_latency_ms": 500.0,
            **module_data,
        }

        response = requests.post(f"{BASE_URL}/api/telemetry", json=data)
        print(f"  - {module_data['module_name']}: {response.status_code}")
        time.sleep(0.1)  # 짧은 딜레이

    print("✅ 다중 모듈 텔레메트리 전송 완료")
    return True


def check_admin_dashboard():
    """Admin 대시보드 접근 가능 여부 확인"""
    print("\n[TEST 6] Admin 대시보드 확인")
    print("=" * 60)

    # Admin 로그인 필요 (세션 쿠키)
    print(f"Admin 대시보드 URL: {BASE_URL}/admin")
    print("브라우저에서 확인하세요:")
    print(f"  1. {BASE_URL}/admin/login")
    print(f"  2. Admin 로그인 (기본: admin / cortex_admin_2025)")
    print(f"  3. {BASE_URL}/admin/stats - 일반 통계")
    print(f"  4. {BASE_URL}/admin/errors - 에러 로그")
    print(f"  5. {BASE_URL}/admin/insights - 논문 데이터")

    return True


def check_user_dashboard():
    """유저 대시보드 확인"""
    print("\n[TEST 7] 유저 대시보드 확인")
    print("=" * 60)

    print(f"유저 대시보드 URL: {BASE_URL}/dashboard")
    print("브라우저에서 확인하세요:")
    print(f"  1. {BASE_URL}/login")
    print(f"  2. GitHub OAuth 로그인")
    print(f"  3. {BASE_URL}/dashboard - 개인 통계 확인")

    return True


def main():
    """메인 테스트 실행"""
    print("\n" + "=" * 60)
    print("Cortex Web API 통합 테스트")
    print("=" * 60)

    print("\n⚠️  테스트 전 확인 사항:")
    print("1. 웹 서버가 실행 중인가요? (python web/app.py)")
    print("2. 테스트 사용자가 승인되었나요?")
    print("3. LICENSE_KEY 변수에 실제 라이센스 키를 입력했나요?")
    print()

    # 자동 실행 모드 (환경변수 AUTO_RUN=1 설정 시 입력 건너뛰기)
    import os
    if os.getenv("AUTO_RUN") != "1":
        input("준비되었으면 Enter를 누르세요...")

    # 서버 연결 확인
    try:
        response = requests.get(BASE_URL, timeout=5)
        print(f"\n✅ 서버 연결 성공: {BASE_URL}")
    except requests.exceptions.RequestException as e:
        print(f"\n❌ 서버 연결 실패: {str(e)}")
        print("웹 서버를 먼저 실행하세요: python web/app.py")
        sys.exit(1)

    # 테스트 실행
    results = []

    results.append(test_license_verify_api())
    time.sleep(0.5)

    results.append(test_telemetry_api())
    time.sleep(0.5)

    results.append(test_errors_api())
    time.sleep(0.5)

    results.append(test_research_metrics_api())
    time.sleep(0.5)

    results.append(test_multiple_telemetry())
    time.sleep(0.5)

    results.append(check_admin_dashboard())
    results.append(check_user_dashboard())

    # 결과 요약
    print("\n" + "=" * 60)
    print("테스트 결과 요약")
    print("=" * 60)
    print(f"총 테스트: {len(results)}개")
    print(f"성공: {sum(results)}개")
    print(f"실패: {len(results) - sum(results)}개")

    if all(results):
        print("\n✅ 모든 테스트 통과!")
        print("\n다음 단계:")
        print("1. 브라우저에서 Admin 대시보드 확인")
        print("2. 유저 대시보드에서 개인 통계 확인")
        print("3. 실제 Cortex MCP 클라이언트에 API 호출 코드 추가")
    else:
        print("\n❌ 일부 테스트 실패")
        print("라이센스 키를 확인하거나 사용자를 먼저 승인하세요.")


if __name__ == "__main__":
    main()
