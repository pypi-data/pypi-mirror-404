"""
테스트용 사용자 생성 스크립트
웹 서버 API 테스트를 위한 테스트 유저 및 라이센스 생성
"""

import sys
from pathlib import Path

# web 모듈 경로 추가
web_path = Path(__file__).parent / "web"
sys.path.insert(0, str(web_path))

from models import get_db

def setup_test_user():
    """테스트 사용자 생성 및 승인"""
    db = get_db()

    # 테스트 사용자 생성
    print("\n[1/3] 테스트 사용자 생성 중...")
    result = db.create_user(
        github_id=999999,
        github_login="test_user",
        email="test@cortex-mcp.com",
        avatar_url=None
    )

    if result.get("success"):
        user_id = result["user_id"]
        print(f"테스트 사용자 생성 완료: user_id={user_id}")
    elif "already exists" in result.get("error", ""):
        # 이미 존재하면 기존 사용자 조회
        print("테스트 사용자 이미 존재")
        users = db.list_all_users()
        test_user = next((u for u in users if u["github_login"] == "test_user"), None)
        if not test_user:
            print("에러: 테스트 사용자를 찾을 수 없습니다")
            return
        user_id = test_user["id"]
        print(f"기존 사용자 사용: user_id={user_id}")
    else:
        print(f"에러: {result.get('error')}")
        return

    # 사용자 승인 (라이센스 발급)
    print("\n[2/3] 사용자 승인 및 라이센스 발급 중...")
    approval_result = db.approve_user(user_id, license_type="closed_beta")

    if approval_result.get("success"):
        license_key = approval_result["license_key"]
        print(f"승인 완료! 라이센스 키: {license_key}")
    elif "already approved" in approval_result.get("error", ""):
        # 이미 승인된 경우 기존 라이센스 키 조회
        print("사용자 이미 승인됨")
        users = db.list_all_users()
        test_user = next((u for u in users if u["id"] == user_id), None)
        if not test_user or not test_user.get("license_key"):
            print("에러: 라이센스 키를 찾을 수 없습니다")
            return
        license_key = test_user["license_key"]
        print(f"기존 라이센스 키 사용: {license_key}")
    else:
        print(f"에러: {approval_result.get('error')}")
        return

    # test_api_integration.py 파일 업데이트
    print("\n[3/3] test_api_integration.py 파일에 라이센스 키 업데이트 중...")
    test_file = Path(__file__).parent / "test_api_integration.py"

    if test_file.exists():
        content = test_file.read_text(encoding="utf-8")
        # LICENSE_KEY 라인 찾아서 교체
        lines = content.split("\n")
        for i, line in enumerate(lines):
            if line.strip().startswith("LICENSE_KEY = "):
                lines[i] = f'LICENSE_KEY = "{license_key}"  # Auto-generated by setup_test_user.py'
                break

        test_file.write_text("\n".join(lines), encoding="utf-8")
        print(f"test_api_integration.py 업데이트 완료")

    print("\n" + "="*60)
    print("테스트 사용자 설정 완료!")
    print("="*60)
    print(f"\n사용자 정보:")
    print(f"  - user_id: {user_id}")
    print(f"  - github_login: test_user")
    print(f"  - license_key: {license_key}")
    print(f"\n다음 단계:")
    print(f"  1. 웹 서버 실행: python web/app.py")
    print(f"  2. 테스트 실행: python test_api_integration.py")
    print()

if __name__ == "__main__":
    setup_test_user()
