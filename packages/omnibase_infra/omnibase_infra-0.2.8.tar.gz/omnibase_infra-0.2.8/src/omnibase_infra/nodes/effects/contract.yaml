# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract
# Node: NodeRegistryEffect
#
# This contract defines the interface for the Registry Effect node,
# which handles dual-backend node registration against Consul and PostgreSQL.
# Contract identifiers
name: "registry_effect"
contract_name: "registry_effect"
node_name: "registry_effect"
contract_version:
  major: 1
  minor: 0
  patch: 0
node_version:
  major: 1
  minor: 0
  patch: 0
# Node type
node_type: "EFFECT_GENERIC"
# Description
description: >
  Effect node for dual-backend node registration. Executes registration operations against both Consul (service discovery) and PostgreSQL (registration record persistence), with support for partial failure handling and targeted retries.

# Strongly typed I/O models
input_model:
  name: "ModelRegistryRequest"
  module: "omnibase_infra.nodes.effects.models"
output_model:
  name: "ModelRegistryResponse"
  module: "omnibase_infra.nodes.effects.models"
# IO operations (EFFECT node specific)
io_operations:
  - operation: "register_node"
    description: "Register a node with both Consul and PostgreSQL backends"
    input_fields:
      - node_id
      - service_name
      - health_endpoint
      - metadata
    output_fields:
      - consul_registered
      - postgres_registered
      - registration_id
  - operation: "deregister_node"
    description: "Deregister a node from both backends"
    input_fields:
      - node_id
      - service_name
    output_fields:
      - consul_deregistered
      - postgres_deregistered
  - operation: "retry_partial_failure"
    description: "Retry registration for a specific backend after partial failure"
    input_fields:
      - node_id
      - target_backend
      - idempotency_key
    output_fields:
      - success
      - backend_status
# Dependencies (protocols this node requires)
dependencies:
  - name: "protocol_consul_client"
    type: "protocol"
    class_name: "ProtocolConsulClient"
    module: "omnibase_spi.protocols.consul"
    description: "Consul service discovery operations"
  - name: "protocol_postgres_adapter"
    type: "protocol"
    class_name: "ProtocolPostgresAdapter"
    module: "omnibase_spi.protocols.postgres"
    description: "PostgreSQL registration persistence"
  - name: "protocol_effect_idempotency_store"
    type: "protocol"
    class_name: "ProtocolEffectIdempotencyStore"
    module: "omnibase_spi.protocols.idempotency"
    description: "Idempotency tracking for retry safety"
# Capabilities provided by this node
capabilities:
  - name: "dual_backend_registration"
    description: "Register nodes with both Consul and PostgreSQL simultaneously"
  - name: "partial_failure_handling"
    description: "Handle and recover from partial registration failures"
  - name: "targeted_retry"
    description: "Retry specific backend operations independently"
  - name: "idempotent_operations"
    description: "Ensure operations are idempotent via idempotency store"
# Model definitions
definitions:
  ModelRegistryRequest:
    type: object
    description: "Input model for registry effect operations"
    properties:
      operation:
        type: string
        description: "Operation to perform (register_node, deregister_node, retry_partial_failure)"
      node_id:
        type: string
        description: "Unique identifier for the node"
      service_name:
        type: string
        description: "Service name for registration"
      health_endpoint:
        type: string
        description: "Health check endpoint URL"
      metadata:
        type: object
        description: "Additional metadata for registration"
      target_backend:
        type: string
        description: "Target backend for retry operations (consul, postgres)"
      idempotency_key:
        type: string
        description: "Idempotency key for operation deduplication"
      correlation_id:
        type: string
        description: "Request correlation ID for tracing"
    required:
      - operation
      - node_id
      - correlation_id
  ModelRegistryResponse:
    type: object
    description: "Output model for registry effect operations"
    properties:
      success:
        type: boolean
        description: "Whether the operation succeeded"
      consul_registered:
        type: boolean
        description: "Whether Consul registration succeeded"
      postgres_registered:
        type: boolean
        description: "Whether PostgreSQL registration succeeded"
      registration_id:
        type: string
        description: "Registration record ID"
      partial_failure:
        type: boolean
        description: "Whether a partial failure occurred"
      failed_backend:
        type: string
        description: "Which backend failed (if partial failure)"
      error_message:
        type: string
        description: "Error message if operation failed"
      correlation_id:
        type: string
        description: "Request correlation ID for tracing"
    required:
      - success
      - correlation_id
# Metadata
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2025-01-01"
  tags:
    - effect
    - registration
    - consul
    - postgresql
    - dual-backend
    - idempotency
