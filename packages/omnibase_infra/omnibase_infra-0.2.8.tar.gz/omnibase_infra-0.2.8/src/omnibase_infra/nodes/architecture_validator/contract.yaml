# SPDX-License-Identifier: MIT
# Copyright (c) 2025 OmniNode Team
#
# ONEX Node Contract - Architecture Validator (COMPUTE)
#
# This contract defines the interface for the Architecture Validator node,
# which validates ONEX architecture patterns and conventions.
#
# =============================================================================
# ARCHITECTURE RULES VALIDATED
# =============================================================================
# This COMPUTE node validates three critical architecture rules:
#
#   ARCH-001: No Direct Handler Dispatch
#     Handlers MUST NOT be invoked directly bypassing the RuntimeHost.
#     All event routing MUST go through the MessageDispatchEngine.
#
#   ARCH-002: No Handler Publishing Events
#     Handlers MUST NOT have direct event bus access. Only orchestrators
#     may publish events. Handlers return events; orchestrators publish.
#
#   ARCH-003: No Workflow FSM in Orchestrators
#     Orchestrators MUST NOT duplicate reducer FSM transitions in workflow
#     steps. Reducers own FSM; orchestrators coordinate workflow execution.
#
# =============================================================================
# Contract identifiers
name: "architecture_validator"
contract_name: "architecture_validator"
node_name: "architecture_validator"
# Version (semantic versioning)
contract_version:
  major: 1
  minor: 0
  patch: 0
node_version: "0.1.0"
# Node type - COMPUTE for pure validation logic
node_type: "COMPUTE_GENERIC"
# Description
description: >
  COMPUTE node for validating ONEX architecture patterns. Analyzes Python source code and module structures to detect architecture violations. Validates three core rules: ARCH-001 (no direct handler dispatch), ARCH-002 (no handler publishing events), and ARCH-003 (no workflow FSM in orchestrators duplicating reducer transitions). Returns a structured validation result with violations grouped by rule and severity.

# Strongly typed I/O models
input_model:
  name: "ModelArchitectureValidationRequest"
  module: "omnibase_infra.nodes.architecture_validator.models"
  description: >
    Input containing paths to validate, optional rule filters, and validation configuration (strict mode, ignore patterns, etc.).

output_model:
  name: "ModelArchitectureValidationResult"
  module: "omnibase_infra.nodes.architecture_validator.models"
  description: >
    Output containing validation results: overall pass/fail status, violations grouped by rule (ARCH-001, ARCH-002, ARCH-003), severity levels, and suggested fixes for each violation.

# =============================================================================
# SEVERITY RATIONALE
# =============================================================================
# The severity levels align with EnumValidationSeverity enum values:
#   - ERROR: Blocks validation, serious architectural violation
#   - WARNING: Non-blocking, flags potential issues for review
#   - INFO: Informational only
#
# ARCH-001 uses WARNING because AST-based pattern detection may produce
# false positives for legitimate patterns (test mocks, debugging code).
# Non-blocking validation still flags issues while allowing review.
#
# ARCH-002 and ARCH-003 use ERROR because they represent serious
# architectural violations that should block validation:
#   - Handlers publishing events breaks the orchestrator ownership model
#   - Orchestrators with FSM duplicates reducer responsibilities
# =============================================================================

# Validation rules with detection strategies
validation_rules:
  - rule_id: "ARCH-001"
    name: "No Direct Handler Dispatch"
    description: >
      Handlers MUST NOT be invoked directly bypassing the RuntimeHost. All event routing MUST go through the MessageDispatchEngine.

    # WARNING severity: AST pattern matching may produce false positives for
    # legitimate patterns like test mocks or debugging code. Using WARNING
    # allows non-blocking validation while still flagging potential issues.
    severity: "WARNING"
    detection_strategy:
      type: "ast_pattern"
      patterns:
        - "direct_handler_call"
        - "handler_instance_invoke"
      excluded_contexts:
        - "test_files"
        - "unit_test_mocks"
    suggested_fix: >
      Route events through RuntimeHost.process_event() or MessageDispatchEngine.dispatch() instead of calling handlers directly.

  - rule_id: "ARCH-002"
    name: "No Handler Publishing Events"
    description: >
      Handlers MUST NOT have direct event bus access. Only orchestrators may publish events. Handlers return events; orchestrators publish.

    # ERROR severity: Serious architectural violation. Handlers with bus access
    # breaks the orchestrator ownership model and event lifecycle management.
    severity: "ERROR"
    detection_strategy:
      type: "signature_analysis"
      checks:
        - no_bus_in_init_params
        - no_bus_instance_attributes
        - no_publish_method_calls
      target_classes:
        - "Handler*"
        - "*Handler"
    suggested_fix: >
      Remove event bus injection from handler. Return events from handle() method; let the orchestrator publish them.

  - rule_id: "ARCH-003"
    name: "No Workflow FSM in Orchestrators"
    description: >
      Orchestrators MUST NOT duplicate reducer FSM transitions in workflow steps. Reducers own FSM; orchestrators coordinate workflow execution.

    # ERROR severity: Serious architectural violation. Orchestrators with FSM
    # duplicates reducer responsibilities and violates separation of concerns.
    severity: "ERROR"
    detection_strategy:
      type: "contract_analysis"
      checks:
        - no_state_transitions_in_workflow
        - no_fsm_definitions_in_orchestrator
      target_files:
        - "contract.yaml"
        - "node.py"
    suggested_fix: >
      Remove state transition logic from orchestrator. State transitions belong exclusively to reducer nodes. Orchestrators should call reducers for FSM decisions.

# Dependencies (protocols this node requires)
dependencies:
  - name: "protocol_ast_analyzer"
    type: "protocol"
    description: "Python AST analysis for pattern detection"
    optional: true
  - name: "protocol_contract_parser"
    type: "protocol"
    description: "YAML contract parsing and validation"
    optional: true
# Capabilities provided by this node
capabilities:
  - name: "architecture_validation"
    description: "Validate architecture patterns across codebase"
  - name: "violation_detection"
    description: "Detect and report architecture violations"
  - name: "rule_based_analysis"
    description: "Extensible rule-based code analysis"
  - name: "fix_suggestions"
    description: "Provide actionable fix suggestions for violations"
# Model definitions (schema reference)
definitions:
  ModelArchitectureValidationRequest:
    type: object
    description: "Input model for architecture validation"
    properties:
      paths:
        type: array
        items:
          type: string
        description: "Paths to validate (files or directories)"
      rules:
        type: array
        items:
          type: string
        description: "Specific rules to check (ARCH-001, ARCH-002, ARCH-003). Empty = all rules."
      strict_mode:
        type: boolean
        default: false
        description: "If true, treat WARNING as ERROR (all violations block validation)"
      ignore_patterns:
        type: array
        items:
          type: string
        description: "Glob patterns to ignore (e.g., '**/tests/**')"
      correlation_id:
        type: string
        description: "Request correlation ID for tracing"
    required:
      - paths
      - correlation_id
  ModelArchitectureValidationResult:
    type: object
    description: "Output model for architecture validation"
    properties:
      passed:
        type: boolean
        description: "True if no ERROR-level violations found"
      total_violations:
        type: integer
        description: "Total number of violations found"
      violations_by_rule:
        type: object
        description: "Violations grouped by rule ID"
        additionalProperties:
          type: array
          items:
            $ref: "#/definitions/ModelArchitectureViolation"
      summary:
        type: string
        description: "Human-readable summary of validation results"
      correlation_id:
        type: string
        description: "Request correlation ID for tracing"
    required:
      - passed
      - total_violations
      - correlation_id
  ModelArchitectureViolation:
    type: object
    description: "Single architecture violation"
    properties:
      rule_id:
        type: string
        description: "Rule that was violated (ARCH-001, ARCH-002, ARCH-003)"
      severity:
        type: string
        enum: ["ERROR", "WARNING", "INFO"]
        description: "Violation severity (ERROR blocks validation, WARNING non-blocking)"
      file_path:
        type: string
        description: "Path to file containing violation"
      line_number:
        type: integer
        description: "Line number of violation (if applicable)"
      description:
        type: string
        description: "Description of the violation"
      suggested_fix:
        type: string
        description: "Suggested fix for the violation"
    required:
      - rule_id
      - severity
      - file_path
      - description
# Metadata
metadata:
  author: "OmniNode Team"
  license: "MIT"
  created: "2025-01-07"
  ticket: "OMN-1099"
  tags:
    - compute
    - validation
    - architecture
    - linting
    - onex-compliance
