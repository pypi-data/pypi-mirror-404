(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&e(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();class g{async init(){const t=await fetch("/api/init");if(!t.ok)throw new Error(`Failed to initialize: ${t.statusText}`);return await t.json()}async getTransaction(t){const n=await fetch(`/api/transaction/${t}`);if(!n.ok)throw new Error(`Failed to load transaction: ${n.statusText}`);return await n.json()}async commitTransaction(t,n){const e=await fetch(`/api/transaction/${t}/commit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const i=await e.json().catch(()=>null),o=(i==null?void 0:i.error)??e.statusText;throw new Error(o)}return await e.json()}}class y{constructor(t,n,e){this.visible=!1,this.selectedIndex=-1,this.items=[],this.currentInput=null,this.availableItems=[],this.availableItems=t,this.onSelect=n,this.filterFn=e,this.dropdown=document.createElement("div"),this.dropdown.className="autocomplete-dropdown",this.dropdown.style.display="none",document.body.appendChild(this.dropdown),document.addEventListener("click",i=>{!this.dropdown.contains(i.target)&&i.target!==this.currentInput&&this.hide()})}setAvailableItems(t){this.availableItems=t}show(t){var h;const n=((h=t.textContent)==null?void 0:h.trim())||"";if(this.items=this.filterFn(n,this.availableItems),this.items.length===0){this.hide();return}this.currentInput=t,this.selectedIndex=-1,this.dropdown.innerHTML="",this.items.forEach((u,f)=>{const c=document.createElement("div");c.className="autocomplete-item",c.textContent=u,c.onclick=()=>this.selectItem(u),c.onmouseenter=()=>{this.selectedIndex=f,this.updateHighlight()},this.dropdown.appendChild(c)});const e=t.getBoundingClientRect(),i=Math.max(300,e.width),o=e.top,s=window.innerHeight-e.bottom,a=s>o;this.dropdown.style.minWidth=`${i}px`;const l=window.innerWidth-i-10,m=Math.min(e.left,l);this.dropdown.style.left=`${Math.max(0,m)}px`,a?(this.dropdown.style.top=`${e.bottom+5}px`,this.dropdown.style.bottom="auto",this.dropdown.style.maxHeight=`${s-10}px`):(this.dropdown.style.bottom=`${window.innerHeight-e.top+5}px`,this.dropdown.style.top="auto",this.dropdown.style.maxHeight=`${o-10}px`),this.dropdown.style.display="block",this.visible=!0}hide(){this.dropdown.style.display="none",this.visible=!1,this.selectedIndex=-1,this.currentInput=null}isVisible(){return this.visible}updateSelection(t){!this.visible||this.items.length===0||(t==="down"?this.selectedIndex=(this.selectedIndex+1)%this.items.length:this.selectedIndex=this.selectedIndex<=0?this.items.length-1:this.selectedIndex-1,this.updateHighlight())}selectCurrent(){const t=this.selectedIndex>=0?this.selectedIndex:0;if(this.items[t])this.selectItem(this.items[t]);else{const n=this.currentInput;this.hide(),n==null||n.blur()}}selectItem(t){var e;if(!this.currentInput)return;const n=this.currentInput;n.textContent=t,n.dispatchEvent(new Event("input")),(e=window.getSelection())==null||e.removeAllRanges(),this.hide(),n.blur(),this.onSelect(t)}updateHighlight(){this.dropdown.querySelectorAll(".autocomplete-item").forEach((n,e)=>{e===this.selectedIndex?(n.classList.add("selected"),n.scrollIntoView({block:"nearest"})):n.classList.remove("selected")})}}const d={payee:"p",narration:"n",account:"a"};class w{constructor(t,n,e,i){this.container=t,this.onInput=n,this.autocomplete=new y(e,()=>{},i),document.addEventListener("keydown",o=>this.handleFocusShortcuts(o))}setAvailableAccounts(t){this.autocomplete.setAvailableItems(t)}render(t,n){if(this.container.innerHTML="",this.container.appendChild(this.createColored(t.date,"date")),this.container.appendChild(document.createTextNode(" "+t.flag)),t.payee!==null){this.container.appendChild(document.createTextNode(' "'));const s=(n==null?void 0:n.payee)??t.payee;this.container.appendChild(this.createTextField(s,d.payee,"payee")),this.container.appendChild(document.createTextNode('"'))}if(t.narration!==null){this.container.appendChild(document.createTextNode(' "'));const s=(n==null?void 0:n.narration)??t.narration;this.container.appendChild(this.createTextField(s,d.narration,"narration")),this.container.appendChild(document.createTextNode('"'))}this.container.appendChild(document.createTextNode(`
`)),t.tags.length>0&&this.container.appendChild(document.createTextNode("    "+t.tags.map(s=>"#"+s).join(" ")+`
`)),t.links.length>0&&this.container.appendChild(document.createTextNode("    "+t.links.map(s=>"^"+s).join(" ")+`
`));const e=t.postings.length>=2&&t.postings.every(s=>s.amount!==null)&&this.isTransactionBalanced(t),i=t.postings.find(s=>!s.amount);let o=!1;for(const s of t.postings){if(this.container.appendChild(document.createTextNode("    ")),s===i){const a=(n==null?void 0:n.account)??s.account;this.container.appendChild(this.createAccountField(a,d.account)),o=!0}else this.container.appendChild(document.createTextNode(s.account));s.amount&&(this.container.appendChild(document.createTextNode("  ")),this.container.appendChild(this.createColored(s.amount.value,"amount")),this.container.appendChild(document.createTextNode(" ")),this.container.appendChild(this.createColored(s.amount.currency,"currency"))),s.cost&&this.container.appendChild(document.createTextNode(" "+s.cost)),s.price&&this.container.appendChild(document.createTextNode(" @ "+s.price)),this.container.appendChild(document.createTextNode(`
`))}if(!e&&!o){this.container.appendChild(document.createTextNode("    "));const s=(n==null?void 0:n.account)??"";this.container.appendChild(this.createAccountField(s,d.account)),this.container.appendChild(document.createTextNode(`
`))}}createTextField(t,n,e){const i=document.createElement("span");return i.contentEditable="plaintext-only",i.spellcheck=!1,i.textContent=t,i.className="editable",i.setAttribute("data-key",n),i.addEventListener("focus",()=>this.selectAll(i)),i.addEventListener("keydown",o=>{var s;o.stopPropagation(),(o.key==="Escape"||o.key==="Enter")&&(o.preventDefault(),i.blur(),(s=window.getSelection())==null||s.removeAllRanges())}),i.addEventListener("input",()=>{var s;const o=((s=i.textContent)==null?void 0:s.trim())||"";this.onInput(e,o)}),i}createAccountField(t,n){const e=document.createElement("span");return e.contentEditable="plaintext-only",e.spellcheck=!1,e.textContent=t,e.className="editable",e.setAttribute("data-key",n),e.addEventListener("focus",()=>{this.selectAll(e),this.autocomplete.show(e)}),e.addEventListener("input",()=>{var o;const i=((o=e.textContent)==null?void 0:o.trim())||"";this.onInput("account",i),this.autocomplete.show(e)}),e.addEventListener("keydown",i=>{var o,s;if(i.stopPropagation(),this.autocomplete.isVisible())if(i.key==="ArrowDown"){i.preventDefault(),this.autocomplete.updateSelection("down");return}else if(i.key==="ArrowUp"){i.preventDefault(),this.autocomplete.updateSelection("up");return}else if(i.key==="Enter"||i.key=="Tab"){i.preventDefault(),this.autocomplete.selectCurrent(),(o=window.getSelection())==null||o.removeAllRanges();return}else i.key==="Escape"&&(i.preventDefault(),this.autocomplete.hide());(i.key==="Escape"||i.key==="Enter")&&(i.preventDefault(),e.blur(),(s=window.getSelection())==null||s.removeAllRanges())}),e.addEventListener("blur",()=>{setTimeout(()=>this.autocomplete.hide(),200)}),e}createColored(t,n){const e=document.createElement("span");return e.className=n,e.textContent=t,e}selectAll(t){const n=document.createRange();n.selectNodeContents(t);const e=window.getSelection();e&&(e.removeAllRanges(),e.addRange(n))}renderBalance(t){this.container.innerHTML="",this.container.appendChild(this.createColored(t.date,"date")),this.container.appendChild(document.createTextNode(" balance ")),this.container.appendChild(document.createTextNode(t.account)),this.container.appendChild(document.createTextNode("  ")),this.container.appendChild(this.createColored(t.amount.value,"amount")),this.container.appendChild(document.createTextNode(" ")),this.container.appendChild(this.createColored(t.amount.currency,"currency")),t.tolerance&&(this.container.appendChild(document.createTextNode(" ~ ")),this.container.appendChild(document.createTextNode(t.tolerance))),this.container.appendChild(document.createTextNode(`
`))}handleFocusShortcuts(t){if(Object.values(d).includes(t.key)){const n=this.container.querySelector(`[data-key="${t.key}"]`);n instanceof HTMLElement&&(n.focus(),t.preventDefault())}}isTransactionBalanced(t){const n=new Map;for(const e of t.postings){if(!e.amount)return!1;const i=e.amount.currency,o=parseFloat(e.amount.value),s=n.get(i)??0;n.set(i,s+o)}for(const e of n.values())if(Math.abs(e)>.005)return!1;return!0}}function v(r,t){if(!r)return t;const n=r.toLowerCase().split(":").filter(e=>e.length>0);return t.filter(e=>{const i=e.toLowerCase().split(":");return n.every(o=>i.some(s=>s.startsWith(o)))}).sort((e,i)=>{const o=e.toLowerCase(),s=i.toLowerCase(),a=p(n,o.split(":")),l=p(n,s.split(":"));return a&&!l?-1:!a&&l?1:e.localeCompare(i)})}function p(r,t){var e;let n=0;for(const i of r){for(;n<t.length;){if(t[n].startsWith(i)){n++;break}n++}if(n===t.length&&!((e=t[t.length-1])!=null&&e.startsWith(i)))return!1}return!0}class x{constructor(){this.api=new g,this.directives=[],this.currentIndex=0,this.editStates=new Map,this.transactionEl=document.getElementById("transaction"),this.counterEl=document.getElementById("counter"),this.commitBtn=document.getElementById("commit"),this.messageEl=document.getElementById("message"),this.prevBtn=document.getElementById("prev"),this.nextBtn=document.getElementById("next"),this.renderer=new w(this.transactionEl,(t,n)=>{const e=this.directives[this.currentIndex];if(e){const i=this.editStates.get(e.id)??{account:""};this.editStates.set(e.id,{...i,[t]:n}),this.updateCommitButton()}},[],v),this.prevBtn.onclick=()=>this.prev(),this.nextBtn.onclick=()=>this.next(),this.commitBtn.onclick=()=>this.commit(),document.addEventListener("keydown",t=>this.handleKeyboardShortcuts(t)),this.setupFileChangeListener()}handleKeyboardShortcuts(t){const n={prev:["ArrowLeft","h"],next:["ArrowRight","l"],commit:"Enter"};n.prev.includes(t.key)?this.prev():n.next.includes(t.key)?this.next():t.key===n.commit&&(this.commitBtn.disabled||this.commit())}setupFileChangeListener(){const t=new EventSource("/api/file-changes");t.onmessage=async()=>{console.log("File change detected, reloading data..."),await this.reloadData()},t.onerror=n=>{console.error("SSE connection error:",n)}}async reloadData(){try{const t=await this.api.init();if(this.directives=t.items,this.renderer.setAvailableAccounts(t.available_accounts),this.directives.length===0){this.showSuccess("No transactions to review!"),this.transactionEl.textContent="All done!",this.counterEl.textContent="0/0",this.commitBtn.disabled=!0,this.prevBtn.disabled=!0,this.nextBtn.disabled=!0;return}this.currentIndex>=this.directives.length&&(this.currentIndex=this.directives.length-1),await this.loadTransaction()}catch(t){this.showError(`Failed to reload data: ${String(t)}`)}}async loadTransaction(){try{const t=this.directives[this.currentIndex];if(!t)return;const n=await this.api.getTransaction(t.id),e=this.isTransactionBalanced(n.transaction);if(!this.editStates.has(t.id))if(e)this.editStates.set(t.id,{});else{let o=n.predicted_account??"Expenses:";if(n.transaction.type==="transaction"){const s=n.transaction.postings.find(a=>!a.amount);s&&(o=s.account)}this.editStates.set(t.id,{account:o})}const i=this.editStates.get(t.id);n.transaction.type==="transaction"?(this.renderer.render(n.transaction,i),this.counterEl.textContent=`Transaction ${this.currentIndex+1}/${this.directives.length}`):n.transaction.type==="balance"&&(this.renderer.renderBalance(n.transaction),this.counterEl.textContent=`Balance ${this.currentIndex+1}/${this.directives.length}`),this.clearMessage(),this.updateCommitButton()}catch(t){this.showError(`Failed to load transaction: ${String(t)}`)}}async commit(){const t=this.directives[this.currentIndex];if(!t)return;const n=this.isTransactionBalanced(t),e=this.editStates.get(t.id);if(!n&&(!(e!=null&&e.account)||!e.account.trim())){this.showError("Please enter an expense account");return}try{const i={};if(e!=null&&e.payee&&(i.payee=e.payee),e!=null&&e.narration&&(i.narration=e.narration),!n&&(e!=null&&e.account)&&(i.account=e.account),(await this.api.commitTransaction(t.id,i)).remaining_count===0){this.showSuccess("All transactions committed!"),this.transactionEl.textContent="All done!",this.counterEl.textContent="0/0",this.commitBtn.disabled=!0,this.prevBtn.disabled=!0,this.nextBtn.disabled=!0,this.directives=[];return}this.editStates.delete(t.id),this.directives.splice(this.currentIndex,1),this.currentIndex>=this.directives.length&&(this.currentIndex=this.directives.length-1),await this.loadTransaction()}catch(i){this.showError(`Failed to commit transaction: ${String(i)}`)}}async next(){this.directives.length!==0&&(this.currentIndex=(this.currentIndex+1)%this.directives.length,await this.loadTransaction())}async prev(){this.directives.length!==0&&(this.currentIndex=this.currentIndex===0?this.directives.length-1:this.currentIndex-1,await this.loadTransaction())}updateCommitButton(){const t=this.directives[this.currentIndex];if(!t){this.commitBtn.disabled=!0;return}if(this.isTransactionBalanced(t)){this.commitBtn.disabled=!1;return}const n=this.editStates.get(t.id),e=(n==null?void 0:n.account)&&n.account.trim()!=="";this.commitBtn.disabled=!e}showError(t){this.messageEl.className="error",this.messageEl.textContent=t}showSuccess(t){this.messageEl.className="success",this.messageEl.textContent=t}clearMessage(){this.messageEl.className="",this.messageEl.textContent=""}isTransactionBalanced(t){if(t.type!=="transaction"||!t.postings.every(e=>e.amount!==null))return!1;const n=new Map;for(const e of t.postings){if(!e.amount)return!1;const i=e.amount.currency,o=parseFloat(e.amount.value),s=n.get(i)??0;n.set(i,s+o)}for(const e of n.values())if(Math.abs(e)>.005)return!1;return!0}}const C=new x;C.reloadData();
