"""{{ config.title or package_name }} simulator helpers.

Auto-generated by plato sims publish. Do not edit.
{% if config.description %}

{{ config.description }}
{% endif %}
"""

from __future__ import annotations

import importlib.resources
import os
from typing import Any

import yaml

# Load instructions config using importlib.resources
_config_text = importlib.resources.files(__package__).joinpath("instructions.yaml").read_text()
_CONFIG: dict[str, Any] = yaml.safe_load(_config_text)

ENV_PREFIX: str = _CONFIG.get("env_prefix", "")
SERVICES: dict[str, dict[str, Any]] = _CONFIG.get("services", {})
CONNECT_URL_TEMPLATE: str = "https://{job_id}--{port}.connect.plato.so"


def get_service_port(service_name: str) -> int:
    """Get the port for a named service.

    Args:
        service_name: Name of the service (e.g., {% for name in config.services.keys() %}"{{ name }}"{% if not loop.last %}, {% endif %}{% endfor %})

    Returns:
        Port number for the service

    Raises:
        ValueError: If service not found
    """
    if service_name not in SERVICES:
        available = list(SERVICES.keys())
        raise ValueError(f"Service '{service_name}' not found. Available: {available}")
    return int(SERVICES[service_name]["port"])


def get_service_url(job_id: str, service_name: str) -> str:
    """Get the connect URL for a specific service.

    Args:
        job_id: The job ID from the Plato session
        service_name: Name of the service

    Returns:
        Connect URL for the service (e.g., https://jobid--4566.connect.plato.so)
    """
    port = get_service_port(service_name)
    return CONNECT_URL_TEMPLATE.format(job_id=job_id, port=port)


def get_service_urls(job_id: str) -> dict[str, str]:
    """Get connect URLs for all services.

    Args:
        job_id: The job ID from the Plato session

    Returns:
        Dict mapping service name to connect URL
    """
    return {name: get_service_url(job_id, name) for name in SERVICES}


def get_env_vars(service_urls: dict[str, str]) -> dict[str, str]:
    """Get environment variables with resolved service URLs.

    Args:
        service_urls: Dict mapping service name to its connect URL
                     (e.g., {"main": "https://abc--4566.connect.plato.so"})

    Returns:
        Dict of env var name -> value
    """
    env_vars: dict[str, str] = {}
    for name, var_config in _CONFIG.get("env_vars", {}).items():
        if "template" in var_config:
            template = var_config["template"]
            # Replace {service:NAME} with actual URL
            for svc_name, svc_url in service_urls.items():
                template = template.replace("{" + f"service:{svc_name}" + "}", svc_url)
            env_vars[name] = template
        elif "default" in var_config:
            env_vars[name] = str(var_config["default"])
        elif "env_key" in var_config:
            env_vars[name] = os.environ.get(var_config["env_key"], "")
    return env_vars


def get_env_vars_from_job(job_id: str) -> dict[str, str]:
    """Get environment variables for a job ID.

    Args:
        job_id: The job ID from the Plato session

    Returns:
        Dict of env var name -> value
    """
    service_urls = get_service_urls(job_id)
    return get_env_vars(service_urls)


def setup_env(service_urls: dict[str, str]) -> None:
    """Set up environment variables for using this sim.

    Note: This sets env vars in the current process. For setting env vars
    in a runtime container, use get_env_vars() and pass them to the runtime.

    Args:
        service_urls: Dict mapping service name to its connect URL
    """
    for name, value in get_env_vars(service_urls).items():
        os.environ[name] = value


def setup_env_from_job(job_id: str) -> None:
    """Set up environment variables from a job ID.

    Note: This sets env vars in the current process. For setting env vars
    in a runtime container, use get_env_vars_from_job() and pass them to the runtime.

    Args:
        job_id: The job ID from the Plato session
    """
    service_urls = get_service_urls(job_id)
    setup_env(service_urls)


def get_instructions(service_urls: dict[str, str]) -> str:
    """Get formatted instructions with resolved service URLs.

    Args:
        service_urls: Dict mapping service name to its connect URL

    Returns:
        Markdown-formatted instructions
    """
    template = _CONFIG.get("instructions", "")
    # Replace {service:NAME} with actual URL
    for svc_name, svc_url in service_urls.items():
        template = template.replace("{" + f"service:{svc_name}" + "}", svc_url)
    return template


def get_instructions_from_job(job_id: str) -> str:
    """Get formatted instructions for a job ID.

    Args:
        job_id: The job ID from the Plato session

    Returns:
        Markdown-formatted instructions
    """
    service_urls = get_service_urls(job_id)
    return get_instructions(service_urls)
