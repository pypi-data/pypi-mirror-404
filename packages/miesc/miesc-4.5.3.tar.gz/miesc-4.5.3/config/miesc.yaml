# =============================================================================
# MIESC v4.7.0 - Configuración Centralizada
# Multi-layer Intelligent Evaluation for Smart Contracts
#
# v4.7.0 Changes:
# - Slither cross-validation with solc-select support
# - Selective confidence penalties by vulnerability type
# - ML-based false positive classifier (rule-based weights)
# - Mythril symbolic execution integration
#
# v4.6.0 Changes:
# - Enhanced false positive filtering with detector-specific rates
# - Cross-validation enforcement for critical patterns
# - Semantic context analysis for guards and CEI pattern
# - Call graph and taint analysis integration
# =============================================================================

version: "4.7.0"

# =============================================================================
# Configuración Global
# =============================================================================
global:
  log_level: INFO
  max_workers: 4
  cache_enabled: true
  cache_ttl_seconds: 3600
  temp_dir: /tmp/miesc
  reports_dir: ./reports

# =============================================================================
# Multi-Chain Support (v4.1.0+)
# =============================================================================
chains:
  # Default chain for analysis
  default: ethereum

  # Supported EVM-compatible chains
  ethereum:
    name: Ethereum
    evm_version: shanghai
    solc_version: "0.8.19"
    chain_id: 1
    enabled: true

  polygon:
    name: Polygon
    evm_version: shanghai
    solc_version: "0.8.19"
    chain_id: 137
    enabled: true

  arbitrum:
    name: Arbitrum One
    evm_version: shanghai
    solc_version: "0.8.19"
    chain_id: 42161
    enabled: true

  optimism:
    name: Optimism
    evm_version: shanghai
    solc_version: "0.8.19"
    chain_id: 10
    enabled: true

  bsc:
    name: BNB Smart Chain
    evm_version: shanghai
    solc_version: "0.8.19"
    chain_id: 56
    enabled: true

  avalanche:
    name: Avalanche C-Chain
    evm_version: shanghai
    solc_version: "0.8.19"
    chain_id: 43114
    enabled: true

  base:
    name: Base
    evm_version: shanghai
    solc_version: "0.8.19"
    chain_id: 8453
    enabled: true

# =============================================================================
# Capas de Análisis - 7 Layers Defense
# =============================================================================
layers:
  # Layer 1: Static Analysis
  static_analysis:
    enabled: true
    priority: 1
    tools:
      - slither
      - aderyn
      - solhint

  # Layer 2: Dynamic Testing (Fuzzing)
  dynamic_testing:
    enabled: true
    priority: 2
    tools:
      - echidna
      - foundry
      - medusa
      - dogefuzz

  # Layer 3: Symbolic Execution
  symbolic_execution:
    enabled: true
    priority: 3
    tools:
      - mythril
      - manticore
      - halmos

  # Layer 4: Formal Verification
  formal_verification:
    enabled: true
    priority: 4
    tools:
      - smtchecker
      - certora
      - wake

  # Layer 5: Property Testing
  property_testing:
    enabled: true
    priority: 5
    tools:
      - propertygpt

  # Layer 6: AI/LLM Analysis
  ai_analysis:
    enabled: true
    priority: 6
    tools:
      - smartllm
      - gptscan
      - llmsmartaudit

  # Layer 7: Specialized Analysis
  specialized:
    enabled: true
    priority: 7
    tools:
      - gas_analyzer
      - mev_detector
      - threat_model
      - smartbugs_ml
      - dagnn
      - contract_clone_detector

# =============================================================================
# Configuración de Adaptadores
# =============================================================================
adapters:
  # ---------------------------------------------------------------------------
  # CAPA 1: Static Analysis
  # ---------------------------------------------------------------------------
  slither:
    enabled: true
    layer: static_analysis
    timeout: 60
    detectors: all
    exclude_detectors: []
    solc_remaps: []
    fail_on_error: false
    options:
      json_output: true
      disable_color: true

  aderyn:
    enabled: true
    layer: static_analysis
    timeout: 30
    options:
      output_format: json

  solhint:
    enabled: true
    layer: static_analysis
    timeout: 30
    config_file: .solhint.json
    rules:
      max-line-length: 120
      no-unused-vars: warn

  # ---------------------------------------------------------------------------
  # CAPA 2: Dynamic Testing (Fuzzing)
  # ---------------------------------------------------------------------------
  echidna:
    enabled: true
    layer: dynamic_testing
    timeout: 300
    test_limit: 50000
    seq_len: 100
    corpus_dir: ~/.miesc/echidna_corpus
    options:
      format: json
      shrink_limit: 5000

  foundry:
    enabled: true
    layer: dynamic_testing
    timeout: 300
    fuzz_runs: 256
    fuzz_seed: null
    options:
      verbosity: 3
      gas_report: true

  medusa:
    enabled: true
    layer: dynamic_testing
    timeout: 300
    docker_image: "ghcr.io/chainsecurity/medusa:latest"
    options:
      workers: 4

  dogefuzz:
    enabled: true
    layer: dynamic_testing
    timeout: 300
    seed_limit: 5000
    coverage_target: 0.85

  # ---------------------------------------------------------------------------
  # CAPA 3: Symbolic Execution
  # ---------------------------------------------------------------------------
  mythril:
    enabled: true
    layer: symbolic_execution
    timeout: 120
    execution_timeout: 90
    max_depth: 22
    solver_timeout: 30000
    options:
      output_format: json
      enable_physics: false

  manticore:
    enabled: true
    layer: symbolic_execution
    timeout: 600
    workspace: /tmp/manticore
    options:
      thorough_mode: false

  halmos:
    enabled: true
    layer: symbolic_execution
    timeout: 300
    options:
      solver: z3

  # ---------------------------------------------------------------------------
  # CAPA 4: Formal Verification
  # ---------------------------------------------------------------------------
  smtchecker:
    enabled: true
    layer: formal_verification
    timeout: 120
    engine: chc  # chc, bmc, all
    targets:
      - underflow
      - overflow
      - divByZero
      - constantCondition
      - popEmptyArray
      - outOfBounds
      - assert

  certora:
    enabled: false  # Requiere API key
    layer: formal_verification
    timeout: 900
    api_key_env: CERTORAKEY
    options:
      rule: null  # Ejecutar todas las reglas
      msg: "MIESC Automated Verification"

  wake:
    enabled: true
    layer: formal_verification
    timeout: 300

  # ---------------------------------------------------------------------------
  # CAPA 5: Property Testing
  # ---------------------------------------------------------------------------
  propertygpt:
    enabled: true
    layer: property_testing
    timeout: 60
    llm_model: deepseek-coder
    options:
      generate_invariants: true
      verify_properties: true

  # ---------------------------------------------------------------------------
  # CAPA 6: AI/LLM Analysis
  # ---------------------------------------------------------------------------
  smartllm:
    enabled: true
    layer: ai_analysis
    timeout: 120
    model: deepseek-coder
    ollama_host: http://localhost:11434
    roles:
      - auditor
      - verificator
    options:
      temperature: 0.1
      max_tokens: 4096

  gptscan:
    enabled: true
    layer: ai_analysis
    timeout: 90
    model: codellama

  llmsmartaudit:
    enabled: true
    layer: ai_analysis
    timeout: 90
    model: deepseek-coder

  # ---------------------------------------------------------------------------
  # CAPA 7: Specialized Analysis
  # ---------------------------------------------------------------------------
  gas_analyzer:
    enabled: true
    layer: specialized
    timeout: 30
    patterns:
      - storage_optimization
      - loop_optimization
      - memory_vs_calldata
      - packed_structs

  mev_detector:
    enabled: true
    layer: specialized
    timeout: 30
    detection_types:
      - front_running
      - sandwich_attack
      - flashloan_attack
      - oracle_manipulation

  threat_model:
    enabled: true
    layer: specialized
    timeout: 30
    frameworks:
      - STRIDE
      - DREAD
    output_format: json

  smartbugs_ml:
    enabled: true
    layer: specialized
    timeout: 60
    model_path: ~/.miesc/models/smartbugs

  dagnn:
    enabled: true
    layer: specialized
    timeout: 90
    model_path: ~/.miesc/models/dagnn
    options:
      attention_heads: 8
      hidden_dim: 256

  contract_clone_detector:
    enabled: true
    layer: specialized
    timeout: 30
    detection_types:
      - type1  # Exact clones
      - type2  # Renamed identifiers
      - type3  # Modified statements
      - type4  # Semantic clones

# =============================================================================
# Configuración de LLM Local (Ollama) - Centralizada v4.2.3
# =============================================================================
llm:
  provider: ollama
  host: http://localhost:11434

  # Modelo por defecto para todas las tareas
  default_model: deepseek-coder:6.7b

  # Modelos específicos por caso de uso (para optimizar calidad/velocidad)
  # El sistema intentará usar el modelo específico, si no está disponible usa default
  models:
    # Análisis de código y detección de vulnerabilidades
    code_analysis: deepseek-coder:6.7b

    # Generación de propiedades y invariantes (formal verification)
    property_generation: deepseek-coder:6.7b

    # Verificación y validación de hallazgos
    verification: deepseek-coder:6.7b

    # Correlación y síntesis de resultados
    correlation: deepseek-coder:6.7b

    # Generación de remediaciones y fixes
    remediation: deepseek-coder:6.7b

  # Modelos de fallback (en orden de preferencia)
  fallback_models:
    - codellama:13b
    - codellama:7b
    - llama3:8b

  # Configuración de reintentos
  retry_attempts: 3
  retry_delay: 5

  # Parámetros de generación por defecto
  options:
    temperature: 0.1
    top_p: 0.95
    num_ctx: 8192
    num_predict: 4096

  # Configuración por rol (SmartLLM Generator/Verificator)
  roles:
    generator:
      temperature: 0.2
      system_prompt: "You are an expert smart contract security auditor."
    verificator:
      temperature: 0.1
      system_prompt: "You are a critical reviewer verifying security findings."

  # Cache de respuestas LLM
  cache:
    enabled: true
    ttl_seconds: 3600
    max_entries: 1000

# =============================================================================
# Report Generation Configuration (v4.3.6+)
# =============================================================================
reports:
  # Default template for report generation
  default_template: professional

  # Available templates
  templates:
    - professional
    - executive
    - technical
    - github-pr
    - simple
    - profesional  # New: Trail of Bits / OpenZeppelin style profesional reports

  # LLM Interpretation settings
  llm_interpretation:
    enabled: false  # Set to true to enable by default (or use --llm-interpret flag)
    model: mistral:latest  # Best results for report interpretation
    ollama_host: http://localhost:11434  # Override via OLLAMA_HOST env var

    # Generation parameters for report interpretation
    temperature: 0.2  # Slightly creative for summaries
    max_tokens: 2000
    timeout: 180  # 3 minutes per LLM call

    # Features to include when LLM interpretation is enabled
    features:
      executive_summary: true      # AI-generated executive summary
      risk_narrative: true         # AI-generated risk narrative
      critical_interpretations: true  # Detailed interpretation of critical findings
      remediation_priority: true   # AI-suggested remediation order

    # Limits
    max_findings_to_interpret: 5   # Max critical findings to interpret in detail
    max_findings_to_prioritize: 10 # Max findings for prioritization

  # Premium Report Configuration (v4.3.7+)
  # Used when --template profesional is specified
  profesional:
    enabled: true

    # CVSS-like scoring
    cvss_scoring:
      enabled: true
      # Adjust base score weights
      impact_weight: 0.6
      exploitability_weight: 0.4

    # Risk matrix configuration
    risk_matrix:
      enabled: true
      # Labels for matrix cells
      impact_levels: ["Low", "Medium", "High"]
      likelihood_levels: ["Low", "Medium", "High"]

    # Deployment recommendation thresholds
    deployment_recommendation:
      # NO-GO conditions
      no_go_critical_threshold: 1  # Any critical = NO-GO
      no_go_high_threshold: 2      # 2+ high = NO-GO
      # CONDITIONAL conditions
      conditional_high_threshold: 1
      conditional_medium_threshold: 3

    # Premium LLM features (requires --llm-interpret)
    llm_features:
      attack_scenarios: true       # Generate step-by-step attack scenarios
      code_remediation: true       # Generate code fix suggestions with diffs
      deployment_justification: true  # LLM-based deployment recommendation

    # Limits for profesional LLM generation
    max_attack_scenarios: 3        # Max critical/high findings for attack scenarios
    max_code_remediations: 5       # Max findings for code remediation suggestions

    # Report metadata defaults
    defaults:
      classification: "CONFIDENTIAL"
      engagement_type: "Security Audit"
      target_network: "Ethereum Mainnet"
      report_version: "1.0"

# =============================================================================
# Configuración de Resultados
# =============================================================================
results:
  # Deduplicación de hallazgos
  deduplication:
    enabled: true
    similarity_threshold: 0.85

  # Agregación de severidades
  severity_mapping:
    critical: 10
    high: 8
    medium: 5
    low: 2
    informational: 1

  # Correlación cruzada entre herramientas
  cross_validation:
    enabled: true
    min_confirmations: 2  # Mínimo de herramientas que deben confirmar
    confidence_boost: 0.15  # Boost de confianza por confirmación adicional

  # Filtro de falsos positivos ML
  false_positive_filter:
    enabled: true
    fp_threshold: 0.50  # Probabilidad FP >= este valor se filtra (ajustar para precision)
    require_cross_validation_for_critical: true  # Reentrancy, delegatecall, etc.
    filter_informational: true  # Filtrar severidad informational
    filter_test_files: true  # Filtrar hallazgos en archivos de test

    # v4.6.0: Enhanced FP filtering with detector-specific rates
    use_detector_fp_rates: true  # Use SLITHER_DETECTOR_FP_RATES
    semantic_context_analysis: true  # Use SemanticContextAnalyzer

  # v4.6.0: Cross-validation enforcement
  cross_validation_v2:
    enabled: true
    # Patterns requiring 2+ tools for confirmation
    require_multi_tool:
      - reentrancy
      - reentrancy-eth
      - reentrancy-no-eth
      - arbitrary-send
      - arbitrary-send-eth
      - controlled-delegatecall
      - suicidal
      - unprotected-upgrade
    # Maximum confidence for single-tool critical findings
    single_tool_max_confidence: 0.60
    # Confidence boost per additional tool
    multi_tool_confidence_boost: 0.08

  # Formatos de exportación
  export_formats:
    - json
    - markdown
    - html
    - pdf
    - sarif

# =============================================================================
# Configuración Optimizada de Análisis (v4.2.0+)
# =============================================================================
# Configuración mejorada para reducir FPs y aumentar detección de vulnerabilidades reales
analysis:
  # Herramientas a ejecutar por defecto (en orden de prioridad)
  tools:
    quick:
      - slither      # Siempre, alta precisión
      - aderyn       # Si disponible, complementa Slither
      - solhint      # Linting básico
    full:
      - slither
      - aderyn
      - mythril      # Para contratos < 500 líneas
      - echidna      # Si hay tests
      - semgrep

  # Umbrales de confianza para reportes
  confidence:
    min_report: 0.6          # Mínimo para incluir en reporte (default)
    min_report_strict: 0.75  # Modo estricto (menos FPs pero puede perder algunos)
    min_critical: 0.8        # Mínimo para marcar como CRITICAL
    min_high: 0.7            # Mínimo para marcar como HIGH

  # Filtrado avanzado
  filtering:
    exclude_info: false           # Incluir INFO por defecto
    exclude_gas: true             # Excluir optimizaciones de gas
    openzeppelin_safe: true       # Confiar en código de OpenZeppelin
    solmate_safe: true            # Confiar en Solmate
    solady_safe: true             # Confiar en Solady
    exclude_test_files: true      # Excluir archivos de test
    exclude_mocks: true           # Excluir contratos mock

  # Pesos de herramientas para scoring (higher = más confiable)
  tool_weights:
    slither: 0.85
    aderyn: 0.80
    echidna: 0.88
    foundry: 0.85
    mythril: 0.70
    semgrep: 0.75
    solhint: 0.70
    smtchecker: 0.90

  # Configuración de deduplicación semántica
  deduplication:
    enabled: true
    line_bucket_size: 5          # Agrupar líneas en buckets de 5
    confidence_boost_per_tool: 0.12  # Boost por cada herramienta adicional
    max_confidence_boost: 0.35   # Boost máximo por múltiples herramientas

# =============================================================================
# v4.3.0+ Nuevas Capas de Inteligencia (2025-2026)
# =============================================================================
intelligence:
  # LLM Ensemble Detector - Multi-model voting
  ensemble_detection:
    enabled: true
    models:
      - deepseek-coder:6.7b
      - codellama:7b
      - llama3.1:8b
    voting_strategy: threshold  # majority, unanimous, threshold, weighted
    consensus_threshold: 2      # Mínimo 2 modelos deben coincidir
    timeout: 120

  # Autonomous Auditor Agent
  auditor_agent:
    enabled: true
    model: deepseek-coder:6.7b
    checkpoint_dir: ~/.miesc/checkpoints
    verbose: true
    steps:
      understand_contract: true
      identify_entry_points: true
      trace_value_flows: true
      check_access_control: true
      analyze_state_changes: true
      detect_vulnerabilities: true
      validate_findings: true
      generate_recommendations: true

  # Vulnerability RAG - Retrieval-Augmented Generation
  vulnerability_rag:
    enabled: true
    model: deepseek-coder:6.7b
    top_k_similar: 3
    swc_registry: true
    exploit_examples: true

  # DeFi Pattern Detection
  defi_patterns:
    enabled: true
    min_confidence: 0.3
    patterns:
      - flash_loan_attack
      - sandwich_attack
      - governance_attack
      - bridge_vulnerability
      - oracle_manipulation
      - liquidity_drain
      - reward_manipulation
      - donation_attack
      - inflation_attack

  # ML Severity Classifier
  severity_classifier:
    enabled: true
    use_llm_analysis: false  # Set true for deeper analysis
    factors:
      financial_impact_weight: 0.50
      exploitability_weight: 0.30
      scope_weight: 0.20

  # Remediation Generator
  remediation_generation:
    enabled: true
    model: deepseek-coder:6.7b
    generate_code_fixes: true
    generate_tests: true
    parallel: true
    max_concurrent: 3

  # LLM Analysis Cache
  cache:
    enabled: true
    cache_dir: ~/.miesc/llm_cache
    ttl_seconds: 86400  # 24 hours
    max_entries: 1000
    auto_cleanup: true

# =============================================================================
# Validación LLM de Hallazgos (v4.2.0+)
# =============================================================================
# Usa LLM local para validar hallazgos antes de reportarlos
llm_validation:
  enabled: true                  # Activar validación LLM
  provider: ollama
  model: deepseek-coder:6.7b     # Modelo para validación
  ollama_host: http://localhost:11434

  # Configuración de validación
  validate_severity: medium      # Validar >= MEDIUM
  batch_size: 5                  # Procesar en lotes de 5
  timeout_seconds: 60            # Timeout por validación

  # Parámetros de generación
  temperature: 0.1               # Baja temperatura para consistencia
  max_tokens: 1024

  # Acciones basadas en resultado
  actions:
    filter_confirmed_fp: true    # Filtrar FPs confirmados por LLM
    adjust_confidence: true      # Ajustar confianza basado en validación
    log_uncertain: true          # Loguear hallazgos inciertos

# =============================================================================
# Compliance Mapping
# =============================================================================
compliance:
  enabled: true
  frameworks:
    - ISO27001
    - NIST
    - OWASP
    - CWE
    - SWC

# =============================================================================
# Métricas y Observabilidad
# =============================================================================
observability:
  metrics:
    enabled: true
    export_format: prometheus
    port: 9090

  health_checks:
    enabled: true
    interval: 60
    endpoint: /health

  logging:
    level: INFO
    format: json
    output: stdout
    file: ~/.miesc/logs/miesc.log

# =============================================================================
# Planes de Licencia (referencia)
# =============================================================================
license_plans:
  FREE:
    max_audits_month: 5
    allowed_tools:
      - slither
      - solhint
    ai_enabled: false
    max_contract_size_kb: 100

  STARTER:
    max_audits_month: 50
    allowed_tools:
      - slither
      - solhint
      - mythril
      - aderyn
    ai_enabled: false
    max_contract_size_kb: 500

  PRO:
    max_audits_month: 500
    allowed_tools: all
    ai_enabled: true
    max_contract_size_kb: 2048

  ENTERPRISE:
    max_audits_month: -1  # Unlimited
    allowed_tools: all
    ai_enabled: true
    max_contract_size_kb: -1  # Unlimited
    priority_support: true
