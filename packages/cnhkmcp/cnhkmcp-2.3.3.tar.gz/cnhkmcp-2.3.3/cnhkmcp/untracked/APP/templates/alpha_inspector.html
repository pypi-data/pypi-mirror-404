<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRAIN Alpha è·¨ç•Œè¿é” - ç¼˜åˆ†ä¸€é“æ¡¥</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .inspector-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .login-section, .filter-section, .results-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .alpha-item {
            border: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 4px;
            overflow: hidden;
        }
        .alpha-header {
            background: #f8f9fa;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alpha-header:hover {
            background: #e9ecef;
        }
        .alpha-details {
            padding: 15px;
            display: none;
            border-top: 1px solid #eee;
        }
        .alpha-details.active {
            display: block;
        }
        .variant-btn {
            margin: 5px;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #007bff;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .variant-btn:hover {
            background: #007bff;
            color: white;
        }
        .variant-btn.simulating {
            background: #ffc107;
            border-color: #ffc107;
            color: #000;
            cursor: wait;
        }
        .variant-btn.success {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        .variant-btn.sharpe-low {
            background: #ffc107;
            border-color: #ffc107;
            color: #000;
        }
        .variant-btn.sharpe-high {
            background: #6f42c1;
            border-color: #6f42c1;
            color: white;
        }
        .variant-btn.error {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: 1px solid #ffc107;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }
        .btn-warning:disabled {
            background-color: #ffeeba;
            border-color: #ffeeba;
            cursor: not-allowed;
            opacity: 0.65;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="inspector-container">
        <header style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h1>ğŸŒ‰ ç¼˜åˆ†ä¸€é“æ¡¥ (Alpha è·¨åŒºè¿é”)</h1>
            <a href="/" class="btn btn-secondary">è¿”å›ä¸»é¡µ</a>
        </header>

        <div class="instructions-section" style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0;">ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <ol style="padding-left: 20px; margin-bottom: 0; line-height: 1.6;">
                <li>è·å–ä¸€æ®µæ—¶é—´å†…çš„Alphaåˆ—è¡¨</li>
                <li>åˆ†ææ¯ä¸ªAlphaé‡Œçš„æ•°æ®å­—æ®µå¹¶è¿›è¡Œå¼ºæ›¿æ¢ï¼ŒæŸ¥çœ‹æ˜¯å¦åœ¨å…¶ä»–Region/Universe/Delayæœ‰åŒæ ·å­—æ®µ</li>
                <li>ç”Ÿæˆæ–°çš„Alpha</li>
                <li>æœ¬é¡µé¢çš„å›æµ‹æ–¹å¼ä¸ºæ’é˜Ÿå›æµ‹ï¼Œä¸€ä¸ªå®Œæˆåæ‰ä¼šå‘é€å¦ä¸€ä¸ªï¼Œå› æ­¤ä¸­é€”é€€å‡ºé¡µé¢ä¼šä¸­æ–­å›æµ‹</li>
                <li>è¿‡é•¿çš„å›æµ‹é˜Ÿåˆ—æœ‰æ—¶ä¼šå› ä¸ºè´¦å·è¶…æ—¶ç™»å‡ºè€Œå‡ºç°è¿ç»­å¤±è´¥ï¼Œå› æ­¤ä¸å»ºè®®é€‰æ‹©è¿‡é•¿æ—¶é—´è·¨åº¦</li>
                <li>å¦‚æƒ³æ‰¹é‡å›æµ‹ï¼Œè¯·ä¸‹è½½æ‰€æœ‰å¾…å›æµ‹çš„Alphaå¹¶é€‰æ‹©é¦–é¡µå›æµ‹å™¨è¿›è¡Œå›æµ‹</li>
                <li>å¦‚æœä½ æƒ³ï¼Œä½ å¯ä»¥è¾“å…¥ä¸ªå¾ˆå¤§çš„æ—¶é—´èŒƒå›´ï¼Œä¸‹è½½æ‰€æœ‰è¡¨è¾¾å¼ï¼Œæ…¢æ…¢è¿›è¡Œæ‰¹é‡å›æµ‹ã€‚</li>
                <li>å‡ºç°â€˜Field 'maxPercent' has no availability or not found. Intersection is emptyâ€™è¿™ç±»æŠ¥é”™æ— éœ€æ‹…å¿ƒ</li>
                <li>å¦‚æœæ‚¨ä¸€ä¸ªéƒ½æ¡¥ä¸å‡ºæ¥ï¼Œè¯´æ˜æ‚¨ä½¿ç”¨äº†å¤ªå¤šmodel data</li>
                <li>å…³äºä½¿ç”¨AIä»¥è·¨åŒºæ­æ¡¥ï¼Œæˆ‘ä»¬å·²åœ¨72å˜é‡Œæ›´æ–°ï¼Œè·¨åŒºå˜æ¢ï¼Œæœ€å¥½è¿˜æ˜¯ä½¿ç”¨72å˜åŠŸèƒ½</li>
                <li>å¯¹äº†ï¼Œæˆ‘ä»¬è¿˜æœ‰Alpha IDæ¨¡å¼ï¼Œæ‚¨æŠŠå·®ç‚¹å¯ä»¥æäº¤çš„AlphaIDæ”¾è¿›æ¥ï¼Œè¯´ä¸å®šä¼šåœ¨å…¶ä»–åœ°æ–¹æ‰¾åˆ°ç¼˜åˆ†</li>
            </ol>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>ç™»å½• BRAIN</h2>
            <div class="form-group">
                <label>ç”¨æˆ·å (é‚®ç®±)</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†ç ">
            </div>
            <button onclick="handleLogin()" class="btn btn-primary">ç™»å½•</button>
            <div id="loginStatus" style="margin-top: 10px;"></div>
        </div>

        <!-- Main Content (Hidden until login) -->
        <div id="mainContent" class="hidden">
            <!-- Filter Section -->
            <div class="filter-section">
                <h2>é€‰æ‹©æ¨¡å¼</h2>
                <div style="margin-bottom: 15px;">
                    <label><input type="radio" name="fetchMode" value="date" checked onclick="toggleMode()"> æŒ‰æ—¥æœŸèŒƒå›´</label>
                    <label style="margin-left: 20px;"><input type="radio" name="fetchMode" value="id" onclick="toggleMode()"> æŒ‡å®š Alpha ID</label>
                </div>

                <div id="dateModeInputs">
                    <h3>é€‰æ‹©Alphaæäº¤çš„æ—¥æœŸèŒƒå›´(ä¸å»ºè®®è¶…è¿‡30å¤©ï¼‰</h3>
                    <div style="display: flex; gap: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="endDate">
                        </div>
                    </div>
                </div>

                <div id="idModeInputs" class="hidden">
                    <h3>è¾“å…¥ Alpha ID (ç”¨é€—å·ã€ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”)</h3>
                    <div class="form-group">
                        <textarea id="alphaIds" rows="5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="ä¾‹å¦‚: QPdZrdQG, abc12345"></textarea>
                    </div>
                </div>

                <button onclick="fetchAlphas()" class="btn btn-primary">è·å– Alpha å¹¶åˆ†æ</button>
                <button onclick="downloadResults()" class="btn btn-secondary" id="downloadBtn" disabled>ä¸‹è½½æ‰€æœ‰å¾…å›æµ‹Alpha</button>
                <button onclick="queueAllSimulations()" class="btn btn-warning" id="queueBtn" disabled>ä¸€é”®å…¨éƒ¨æ’é˜Ÿå›æµ‹</button>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h2>Alpha åˆ—è¡¨ <span id="alphaCount"></span></h2>
                <div id="loadingIndicator" class="loading">
                    æ­£åœ¨åˆ†æ Alpha... è¯·è€å¿ƒç­‰å¾…...
                </div>
                <div id="alphasList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let analyzedAlphas = [];

        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('loginStatus');

            statusDiv.textContent = 'æ­£åœ¨ç™»å½•...';
            
            try {
                const response = await fetch('/api/yuanfen/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.textContent = 'ç™»å½•æˆåŠŸï¼';
                    statusDiv.style.color = 'green';
                    currentSessionId = data.session_id;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                } else {
                    statusDiv.textContent = 'ç™»å½•å¤±è´¥ï¼š' + data.message;
                    statusDiv.style.color = 'red';
                }
            } catch (e) {
                statusDiv.textContent = 'é”™è¯¯ï¼š' + e.message;
                statusDiv.style.color = 'red';
            }
        }

        function toggleMode() {
            const mode = document.querySelector('input[name="fetchMode"]:checked').value;
            if (mode === 'date') {
                document.getElementById('dateModeInputs').classList.remove('hidden');
                document.getElementById('idModeInputs').classList.add('hidden');
            } else {
                document.getElementById('dateModeInputs').classList.add('hidden');
                document.getElementById('idModeInputs').classList.remove('hidden');
            }
        }

        async function fetchAlphas() {
            const mode = document.querySelector('input[name="fetchMode"]:checked').value;
            let payload = {
                session_id: currentSessionId,
                mode: mode === 'date' ? 'date_range' : 'ids'
            };

            if (mode === 'date') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (!startDate || !endDate) {
                    alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                    return;
                }
                payload.start_date = startDate;
                payload.end_date = endDate;
            } else {
                const alphaIds = document.getElementById('alphaIds').value;
                if (!alphaIds.trim()) {
                    alert('è¯·è¾“å…¥ Alpha ID');
                    return;
                }
                payload.alpha_ids = alphaIds;
            }

            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            loadingIndicator.textContent = 'æ­£åœ¨åˆå§‹åŒ–è¯·æ±‚...';
            document.getElementById('alphasList').innerHTML = '';
            
            try {
                const response = await fetch('/api/yuanfen/fetch_alphas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep the last incomplete line

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const msg = JSON.parse(line);
                            if (msg.type === 'progress') {
                                loadingIndicator.textContent = msg.message;
                            } else if (msg.type === 'result') {
                                if (msg.success) {
                                    analyzedAlphas = msg.alphas;
                                    document.getElementById('alphaCount').textContent = `(${analyzedAlphas.length})`;
                                    document.getElementById('downloadBtn').disabled = false;
                                    document.getElementById('queueBtn').disabled = false;
                                    renderAlphas(analyzedAlphas);
                                } else {
                                    throw new Error(msg.message || 'Unknown error');
                                }
                            } else if (msg.type === 'error') {
                                throw new Error(msg.message);
                            }
                        } catch (e) {
                            console.error("Error parsing stream:", e);
                        }
                    }
                }
            } catch (e) {
                alert('è·å– Alpha å¤±è´¥ï¼š' + e.message);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderAlphas(alphas) {
            const container = document.getElementById('alphasList');
            container.innerHTML = '';

            alphas.forEach((alpha, index) => {
                const div = document.createElement('div');
                div.className = 'alpha-item';
                
                const variantsHtml = alpha.variants.map(v => {
                    const s = v.diff_settings;
                    const label = `${s.region}/${s.universe}/delay_${s.delay}`;
                    // Encode payload to pass to simulate function
                    const payloadEncoded = encodeURIComponent(JSON.stringify(v.simulation_payload));
                    return `<button class="variant-btn" onclick="simulateVariant(this, '${payloadEncoded}')">${label}</button>`;
                }).join('');

                div.innerHTML = `
                    <div class="alpha-header" onclick="toggleDetails(${index})">
                        <span>${alpha.id}${alpha.dateSubmitted ? ' - ' + alpha.dateSubmitted : ''}</span>
                        <span>${alpha.variants.length} ä¸ªå¯ç”¨å˜ä½“</span>
                    </div>
                    <div class="alpha-details" id="details-${index}">
                        <p><strong>è¡¨è¾¾å¼:</strong> <code>${alpha.expression}</code></p>
                        <div class="variants-list">
                            ${variantsHtml || 'æœªæ‰¾åˆ°æœ‰æ•ˆå˜ä½“ã€‚'}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleDetails(index) {
            const details = document.getElementById(`details-${index}`);
            details.classList.toggle('active');
        }

        async function simulateVariant(btn, payloadEncoded) {
            // Allow retry if it was error, but prevent double click if simulating
            if (btn.classList.contains('simulating')) return;
            
            // Reset state for retry
            btn.classList.remove('error');
            btn.classList.remove('success');
            btn.classList.remove('sharpe-low');
            btn.classList.remove('sharpe-high');
            const originalText = btn.textContent; // Keep original label if needed, but we overwrite it
            
            const payload = JSON.parse(decodeURIComponent(payloadEncoded));
            
            btn.textContent = 'å›æµ‹ä¸­...';
            btn.classList.add('simulating');
            
            try {
                const response = await fetch('/api/yuanfen/simulate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        payload: payload
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    btn.classList.remove('simulating');
                    
                    const res = data.result.is;
                    const sharpe = res.sharpe;
                    
                    if (sharpe > 1.5) {
                        btn.classList.add('sharpe-high');
                    } else if (sharpe > 1.0) {
                        btn.classList.add('success');
                    } else {
                        btn.classList.add('sharpe-low');
                    }

                    const alphaId = data.result.id;
                    const alphaUrl = `https://platform.worldquantbrain.com/alpha/${alphaId}`;
                    
                    // Determine text color for link based on background
                    const linkColor = (sharpe <= 1.0) ? 'black' : 'white';
                    
                    btn.innerHTML = `å¤æ™®: ${res.sharpe.toFixed(2)} | æ”¶ç›Š: ${(res.returns * 100).toFixed(1)}% | <a href="${alphaUrl}" target="_blank" style="color: ${linkColor}; text-decoration: underline;" onclick="event.stopPropagation()">${alphaId}</a>`;
                    btn.title = `ID: ${alphaId}\næ¢æ‰‹ç‡: ${res.turnover}`;
                    
                    // Remove onclick to prevent re-simulation
                    btn.removeAttribute('onclick');
                    btn.style.cursor = 'default';
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                btn.classList.remove('simulating');
                btn.classList.add('error');
                btn.textContent = 'é”™è¯¯';
                btn.title = e.message;
                console.error("Simulation Error Details:", e);
                alert('å›æµ‹å¤±è´¥: ' + e.message);
            }
        }

        function downloadResults() {
            // Flatten the list to get all simulatable payloads
            const allPayloads = [];
            analyzedAlphas.forEach(alpha => {
                alpha.variants.forEach(v => {
                    // Add some metadata to the payload if useful, or just keep it clean
                    const p = JSON.parse(JSON.stringify(v.simulation_payload));
                    // p._origin_alpha_id = alpha.id; // Removed as requested
                    allPayloads.push(p);
                });
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allPayloads, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "simulatable_alphas.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        async function queueAllSimulations() {
            const buttons = document.querySelectorAll('.variant-btn');
            const queueBtn = document.getElementById('queueBtn');
            
            if (buttons.length === 0) {
                alert('æ²¡æœ‰å¯å›æµ‹çš„å˜ä½“');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å¼€å§‹ ${buttons.length} ä¸ªå˜ä½“çš„æ’é˜Ÿå›æµ‹å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)) {
                return;
            }

            queueBtn.disabled = true;
            const originalText = queueBtn.textContent;
            queueBtn.textContent = 'æ­£åœ¨æ’é˜Ÿä¸­... (è¯·å‹¿å…³é—­é¡µé¢)';

            let count = 0;
            for (const btn of buttons) {
                // Skip if already running or done
                if (btn.classList.contains('simulating') || btn.classList.contains('success')) {
                    continue;
                }
                
                // Trigger click to start simulation
                btn.click();
                count++;
                
                // Update button text to show progress
                queueBtn.textContent = `æ­£åœ¨æ’é˜Ÿ... (${count}/${buttons.length})`;

                // Wait 500ms between requests to avoid rate limiting
                await new Promise(r => setTimeout(r, 500)); 
            }
            
            queueBtn.textContent = 'æ’é˜Ÿå®Œæˆ';
            setTimeout(() => {
                queueBtn.disabled = false;
                queueBtn.textContent = originalText;
            }, 2000);
        }
    </script>
    <script src="{{ url_for('static', filename='usage_widget.js') }}"></script>
</body>
</html>
