# Implementation Plan: Complete Root pnpm Migration

**Branch**: `014-root-pnpm-migration` | **Date**: 2026-01-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/014-root-pnpm-migration/spec.md`

## Summary

Complete the npm-to-pnpm migration at the repository root by: (1) deleting `package-lock.json` and generating `pnpm-lock.yaml`, (2) updating `release.yml` to use pnpm with strict lockfile verification, (3) extending CI lockfile guards to check the entire workspace, (4) adding defense-in-depth npm blocking (preinstall script + engines field + engine-strict .npmrc), and (5) adding CI jobs to verify no npm commands in workflows, package.json scripts, or helper scripts.

## Technical Context

**Language/Version**: YAML (GitHub Actions), JSON (package.json, .npmrc), Bash (scripts)
**Primary Dependencies**: pnpm@9.15.0 (declared in packageManager field), semantic-release@25.0.0
**Storage**: N/A (configuration changes only)
**Testing**: GitHub Actions workflow execution, manual verification
**Target Platform**: GitHub Actions runners (ubuntu-latest)
**Project Type**: Hybrid (Python backend + TypeScript extension) - configuration-only changes
**Performance Goals**: N/A (CI configuration)
**Constraints**: Must not break existing release workflow or extension builds
**Scale/Scope**: 5 files modified, 1 file deleted, 1 file created

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| XVII. Cross-Agent Compatibility | ✅ PASS | pnpm works on hosted and self-hosted agents via corepack |
| XVIII. Actionable Failure Logs | ✅ PASS | All new CI guards provide clear error messages |
| QG-17. Lint + format checks pass | ✅ MAINTAINED | No code changes affect lint/format |
| QG-18. Type checking passes | ✅ MAINTAINED | No TypeScript changes |
| QG-19. Unit + integration tests pass | ✅ MAINTAINED | CI changes don't affect test execution |
| QG-21. Python package builds | ✅ MAINTAINED | Python build unchanged |
| QG-22. VSIX extension builds | ✅ MAINTAINED | Extension build already uses pnpm |

**Pre-Design Gate Result**: ✅ PASS - No constitution violations. Change is configuration-only.

## Project Structure

### Documentation (this feature)

```text
specs/014-root-pnpm-migration/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 output
├── quickstart.md        # Phase 1 output (implementation guide)
└── checklists/
    └── requirements.md  # Specification quality checklist
```

### Source Code (repository root)

```text
# Files to modify:
package.json                           # Add preinstall script + engines.pnpm
.npmrc                                 # Add engine-strict=true
.github/workflows/release.yml          # Use setup-pnpm action, add strict lockfile verification
.github/workflows/ci.yml               # Extend lockfile guard, add expanded npm grep check

# Files to delete:
package-lock.json                      # Remove npm lockfile

# Files to create:
pnpm-lock.yaml                         # New root lockfile (generated by pnpm install)
```

**Structure Decision**: Configuration-only changes at repository root and `.github/workflows/`. No new directories or architectural changes.

## Complexity Tracking

No complexity violations. This is a configuration migration with no new abstractions.

## Implementation Steps

### Step 1: Delete package-lock.json and generate pnpm-lock.yaml

**Files**: `/package-lock.json` (delete), `/pnpm-lock.yaml` (create)

1. Delete the existing `package-lock.json` at repository root
2. Run `pnpm install` to generate `pnpm-lock.yaml`
3. Verify lockfile stability: run `pnpm install` again, confirm no changes
4. Commit the new lockfile

**Verification**: `git diff` shows no changes after second `pnpm install`

### Step 2: Add defense-in-depth npm blocking

**Files**: `/package.json`, `/.npmrc`

Add multiple layers of npm blocking:

**package.json** - Add preinstall script AND engines field:
```json
{
  "scripts": {
    "preinstall": "node -e \"if(process.env.npm_config_user_agent && process.env.npm_config_user_agent.includes('npm/')) { console.error('Error: Use pnpm, not npm'); process.exit(1); }\""
  },
  "engines": {
    "pnpm": "9.15.0"
  }
}
```

**.npmrc** - Add engine-strict:
```ini
engine-strict=true
```

**Verification**: Running `npm install` at root fails with BOTH preinstall error AND engine mismatch

### Step 3: Update release.yml to use pnpm with strict verification

**File**: `/.github/workflows/release.yml`

Changes to the `release` job:
1. Replace `setup-node@v4` with `.github/actions/setup-pnpm` action
2. Replace `npm ci` with `pnpm install --frozen-lockfile`
3. Add strict lockfile verification step (NO exit code masking)

```yaml
- uses: ./.github/actions/setup-pnpm

- name: Install dependencies
  run: pnpm install --frozen-lockfile

# ... semantic release step ...

- name: Verify no lockfile changes
  run: |
    set -euo pipefail
    # Hard-fail if pnpm-lock.yaml was modified
    if ! git diff --exit-code pnpm-lock.yaml; then
      echo "::error::pnpm-lock.yaml was modified during release"
      exit 1
    fi
    # Hard-fail if package-lock.json was created
    if [ -f "package-lock.json" ]; then
      echo "::error::package-lock.json was created during release"
      exit 1
    fi
    echo "[OK] No lockfile changes detected"
```

**Verification**: Release workflow hard-fails on ANY lockfile mutation (no swallowed exit codes)

### Step 4: Extend CI lockfile guard to check entire workspace

**File**: `/.github/workflows/ci.yml`

Update the `pnpm-lockfile-guard` job to check for `package-lock.json` anywhere:

```yaml
- name: Check for npm lockfile
  run: |
    FOUND=$(find . -name "package-lock.json" -not -path "./node_modules/*" 2>/dev/null)
    if [ -n "$FOUND" ]; then
      echo "::error::package-lock.json found:"
      echo "$FOUND"
      echo "::error::This repository uses pnpm exclusively. Remove package-lock.json and use pnpm install."
      exit 1
    fi
    echo "[OK] No package-lock.json found anywhere - pnpm policy enforced"
```

**Verification**: CI fails when `package-lock.json` exists at root or any subdirectory

### Step 5: Add CI job to verify no npm commands (expanded scope)

**File**: `/.github/workflows/ci.yml`

Add new job `npm-command-guard` that scans workflows, package.json scripts, AND scripts/ directory:

```yaml
npm-command-guard:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4

    - name: Check for npm install/ci commands
      run: |
        set -euo pipefail

        # Define search locations
        SEARCH_PATHS=".github/workflows/ package.json scripts/"

        # Allowlist: tfx-cli global install is OK
        echo "Scanning for npm ci/install commands in: $SEARCH_PATHS"

        MATCHES=""
        for path in $SEARCH_PATHS; do
          if [ -e "$path" ]; then
            FOUND=$(git grep -n "npm ci\|npm install" "$path" 2>/dev/null | grep -v "npm install -g tfx-cli" || true)
            if [ -n "$FOUND" ]; then
              MATCHES="$MATCHES$FOUND\n"
            fi
          fi
        done

        if [ -n "$MATCHES" ]; then
          echo "::error::Found npm ci/install commands (not allowlisted):"
          echo -e "$MATCHES"
          echo "::error::This repository uses pnpm exclusively. Replace with pnpm install --frozen-lockfile."
          exit 1
        fi

        echo "[OK] No npm ci/install commands found (except allowlisted tfx-cli)"
```

**Verification**: CI fails if `npm ci` or `npm install` appears in workflows, package.json scripts, OR scripts/ directory (except tfx-cli)

## Post-Design Constitution Re-Check

| Principle | Status | Notes |
|-----------|--------|-------|
| XVII. Cross-Agent Compatibility | ✅ PASS | pnpm/action-setup works everywhere |
| XVIII. Actionable Failure Logs | ✅ PASS | All guards provide clear remediation steps |
| QG-17 through QG-22 | ✅ MAINTAINED | No impact on existing gates |

**Post-Design Gate Result**: ✅ PASS

## Rollback Plan

If the migration causes issues:
1. Revert the commit that deletes `package-lock.json`
2. Revert the workflow changes
3. Revert package.json and .npmrc changes
4. Run `npm install` to regenerate `package-lock.json`

The migration is fully reversible via git revert.

## Dependencies

- `.github/actions/setup-pnpm` action must exist (verified: it does)
- `pnpm@9.15.0` must be compatible with semantic-release (verified: standard tooling)
- GitHub App token must work with pnpm workflows (verified: already works for extension)
