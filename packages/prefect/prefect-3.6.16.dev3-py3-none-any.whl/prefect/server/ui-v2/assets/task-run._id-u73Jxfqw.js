import{r as o,s as E,j as e,t as O,L as B,I as V,g as G,d as k}from"./vendor-tanstack-BcZfOOfy.js";import{bz as Q,C as U,o as $,c9 as z,a_ as q,ca as H,I as _,br as J,aQ as W,av as K,cb as X,S as A,a as P,c as M,e as C,b as Y,cc as Z,aq as R,cd as ee,B as se,g as ae,h as y,bw as T,bF as S,bH as le,au as te,q as re,bT as ne,y as f,aA as ie,aB as ce,aC as j,bU as oe,bV as de,bW as xe,aD as p,L as me,b9 as x,ce as D}from"./index-B8vo2Lrg.js";import{A as he}from"./artifact-card-BclosG8t.js";import{T as ue,a as w}from"./toggle-group-7WUJn2Tx.js";import{R as ge,a as fe,u as je,b as pe,C as Ne}from"./use-state-favicon-au2TZdMV.js";import{L as ye}from"./lazy-markdown-1Hz0xzca.js";import{D as be}from"./delete-confirmation-dialog-CwDK_2QS.js";import{u as ve}from"./use-delete-confirmation-dialog-CUdii6Lo.js";import{D as _e,a as Ce,b as Te,d as b}from"./dropdown-menu-D7Gwbd15.js";import{u as Se}from"./use-page-title-DEH55Ovu.js";import{o as De,e as we}from"./vendor-forms-ClCIacbh.js";import"./vendor-react-Bce9NwRC.js";import"./vendor-radix-BTiKGWfR.js";import"./vendor-recharts-BvvJP9Po.js";import"./vendor-date-wwuDAncJ.js";import"./index-D6ynV6U7.js";const Le=({taskRun:s})=>{const[t,a]=o.useState("grid"),{data:n}=E(Q({artifacts:{operator:"and_",task_run_id:{any_:[s.id]},type:{not_any_:["result"]}},sort:"ID_DESC",offset:0}));return n.length===0?e.jsx(U,{children:e.jsx($,{className:"text-center",children:e.jsxs("p",{children:["This task run did not produce any artifacts; for more information on creating artifacts, see the"," ",e.jsx("a",{href:"https://docs.prefect.io/v3/develop/artifacts",target:"_blank",rel:"noopener noreferrer",className:"text-blue-500",children:"documentation"}),"."]})})}):e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsxs(ue,{type:"single",variant:"outline",value:t,onValueChange:r=>a(r),children:[e.jsx(w,{value:"grid","aria-label":"Grid view",children:e.jsx(z,{className:"w-4 h-4"})}),e.jsx(w,{value:"list","aria-label":"List view",children:e.jsx(ge,{className:"w-4 h-4"})})]})}),e.jsx("div",{className:q("grid",t==="grid"?"grid-cols-1 lg:grid-cols-2 xl:grid-cols-3":"grid-cols-1","gap-4"),"data-testid":"task-run-artifacts-grid",children:n.map(r=>e.jsx(he,{artifact:r,compact:t==="list"},r.id))})]})};function N(s){return s?W(s,"dateTimeNumeric"):"N/A"}function v(s){return s==null?"N/A":K(s*1e3,{maxDecimalPoints:2,units:["s"]})}const L=({taskRun:s})=>{const{data:t}=O({...H(s?.id??""),enabled:!!s?.id});return s?e.jsxs("div",{className:"flex flex-col gap-2 p-2 text-xs",children:[s.flow_run_id?e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Flow Run"}),e.jsx("dd",{children:e.jsxs(B,{to:"/runs/flow-run/$id",params:{id:s.flow_run_id},className:"text-blue-500 hover:underline cursor-pointer flex items-center",children:[e.jsx(_,{id:"ExternalLink",className:"mr-1 size-4"}),s.flow_run_name]})})]}):e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Flow Run"}),e.jsx("dd",{children:"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Start Time"}),e.jsx("dd",{className:"font-mono",children:s.start_time?N(s.start_time):"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Duration"}),e.jsx("dd",{className:"",children:e.jsxs("span",{className:"flex items-center",children:[e.jsx(_,{id:"Clock",className:"mr-1 size-4"}),s.total_run_time!==null&&s.total_run_time!==void 0?v(s.total_run_time):"None"]})})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Run Count"}),e.jsx("dd",{className:"",children:s.run_count??0})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Estimated Run Time"}),e.jsx("dd",{className:"",children:s.estimated_run_time!==null&&s.estimated_run_time!==void 0?v(s.estimated_run_time):"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Created"}),e.jsx("dd",{className:"font-mono",children:s.created?N(s.created):"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Last Updated"}),e.jsx("dd",{className:"font-mono",children:s.updated?N(s.updated):"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Cache Key"}),e.jsx("dd",{className:"font-mono",children:s.cache_key||"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Cache Expiration"}),e.jsx("dd",{className:"font-mono",children:s.cache_expiration?N(s.cache_expiration):"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Dynamic Key"}),e.jsx("dd",{className:"font-mono",children:s.dynamic_key||"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Task Run ID"}),e.jsx("dd",{className:"font-mono",children:s.id})]}),t?.description&&e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-muted-foreground",children:"Result"}),e.jsx("dd",{children:e.jsx("div",{className:"prose max-w-none dark:prose-invert",children:e.jsx(ye,{children:t.description})})})]}),e.jsx("div",{className:"border-t border-gray-200 mt-2 pt-4"}),e.jsx("h3",{className:"text-sm font-semibold mb-2",children:"Task configuration"}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:" text-gray-500",children:"Version"}),e.jsx("dd",{className:"",children:s.task_version||"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Retries"}),e.jsx("dd",{className:"",children:s.empirical_policy?.retries?.toString()??"0"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Retry Delay"}),e.jsx("dd",{className:"",children:typeof s.empirical_policy?.retry_delay=="number"?v(s.empirical_policy.retry_delay):"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:"text-gray-500",children:"Retry Jitter Factor"}),e.jsx("dd",{className:"",children:s.empirical_policy?.retry_jitter_factor!==null&&s.empirical_policy?.retry_jitter_factor!==void 0?s.empirical_policy.retry_jitter_factor.toString():"None"})]}),e.jsxs("dl",{className:"flex flex-col gap-1 mb-2",children:[e.jsx("dt",{className:" text-gray-500",children:"Tags"}),e.jsx("dd",{className:"",children:s.tags&&s.tags.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:s.tags.map(a=>e.jsx(J,{tag:a},a))}):"None"})]})]}):e.jsx("div",{className:"flex flex-col gap-2 bg-gray-100 p-4 rounded-md",children:e.jsx("span",{className:"text-gray-500",children:"No task run details available"})})},Ie=({taskRun:s,virtualize:t=!0})=>{const[a,n]=o.useState(0),[r,l]=o.useState("TIMESTAMP_ASC"),c=o.useMemo(()=>({...X({limit:50,sort:r,logs:{operator:"and_",level:{ge_:a},task_run_id:{any_:[s.id]}}}),refetchInterval:s.state_type==="RUNNING"?5e3:!1}),[a,r,s.id,s.state_type]),{data:i,hasNextPage:d,fetchNextPage:u,isFetchingNextPage:g}=V(c),m=i.pages.length===1&&i.pages[0].length===0;let h="This run did not produce any logs.";return m&&(a>0?h="No logs match your filter criteria":s.state_type==="SCHEDULED"&&s.state_name==="Scheduled"?h="Run has not yet started. Check back soon for logs.":s.state_type==="RUNNING"&&(h="Waiting for logs...")),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row gap-2 justify-end",children:[e.jsx(Ee,{levelFilter:a,setLevelFilter:n}),e.jsx(Ae,{sortOrder:r,setSortOrder:l})]}),m?e.jsx("div",{className:"flex flex-col gap-2 text-center bg-muted p-2 rounded-md",children:e.jsx("span",{className:"text-muted-foreground",children:h})}):e.jsx("div",{className:"rounded-md",children:e.jsx(fe,{taskRun:s,logs:i.pages.flat(),onBottomReached:()=>{d&&!g&&u().catch(F=>{console.error(F)})},className:"max-h-[85vh]",virtualize:t})})]})},I=[{label:"All",value:0},{label:"Critical only",value:50},{label:"Error and above",value:40},{label:"Warning and above",value:30},{label:"Info and above",value:20},{label:"Debug and above",value:10}],Ee=({levelFilter:s,setLevelFilter:t})=>e.jsxs(A,{value:s.toString(),onValueChange:a=>t(Number(a)),children:[e.jsx(P,{"aria-label":"log level filter",children:e.jsx("span",{children:`Level:
							${I.find(a=>a.value===s)?.label}`})}),e.jsx(M,{children:I.map(a=>e.jsx(C,{value:a.value.toString(),children:a.label},a.value))})]}),Ae=({sortOrder:s,setSortOrder:t})=>e.jsxs(A,{value:s,onValueChange:a=>t(a),children:[e.jsx(P,{"aria-label":"log sort order",children:e.jsx(Y,{placeholder:"Sort log order"})}),e.jsxs(M,{children:[e.jsx(C,{value:"TIMESTAMP_ASC",children:"Oldest to newest"}),e.jsx(C,{value:"TIMESTAMP_DESC",children:"Newest to oldest"})]})]}),Pe=({id:s,tab:t,onTabChange:a})=>{const[n,r]=o.useState(!1),{data:l}=E({...Z(s),refetchInterval:n}),{deleteTaskRun:c}=R(),{navigate:i}=G();Se(l?.name?`Task Run: ${l.name}`:"Task Run"),je(l?.state_type),o.useEffect(()=>{l.state_type==="RUNNING"||l.state_type==="PENDING"?r(5e3):r(!1)},[l]);const d=()=>{c({id:l.id},{onSuccess:()=>{r(!1),f.success("Task run deleted"),l.flow_run_id?i({to:"/runs/flow-run/$id",params:{id:l.flow_run_id},replace:!0}):i({to:"/runs",replace:!0})},onError:u=>{const g=u.message||"Unknown error while deleting task run.";f.error(g)}})};return e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("div",{className:"flex flex-col gap-2",children:e.jsx(Me,{taskRun:l,onDeleteRunClicked:d})}),e.jsxs("div",{className:"grid lg:grid-cols-[1fr_250px] grid-cols-[1fr] gap-4",children:[e.jsx(Fe,{currentTab:t,onTabChange:a,logsContent:e.jsx(o.Suspense,{fallback:e.jsx(Oe,{}),children:e.jsx(Ie,{taskRun:l})}),artifactsContent:e.jsx(o.Suspense,{fallback:e.jsx(Be,{}),children:e.jsx(Le,{taskRun:l})}),taskInputsContent:e.jsx(Ve,{taskRun:l}),detailsContent:e.jsx(L,{taskRun:l})}),e.jsx("div",{className:"hidden lg:block",children:e.jsx(L,{taskRun:l})})]})]})},Me=({taskRun:s,onDeleteRunClicked:t})=>{const[a,n]=ve(),{open:r,onOpenChange:l,openDialog:c}=pe(),{setTaskRunState:i,isPending:d}=ee(),u=s.state_type&&["COMPLETED","FAILED","CANCELLED","CRASHED"].includes(s.state_type),g=m=>{i({id:s.id,state:{type:m.type,name:m.type.charAt(0)+m.type.slice(1).toLowerCase(),message:m.message},force:!0},{onSuccess:()=>{f.success("Task run state changed"),l(!1)},onError:h=>{f.error(h.message||"Failed to change state")}})};return e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsx(se,{children:e.jsxs(ae,{children:[e.jsx(y,{children:e.jsx(T,{to:"/runs",search:{tab:"task-runs"},className:"text-xl font-semibold",children:"Runs"})}),e.jsx(S,{}),s.flow_run_id&&e.jsxs(e.Fragment,{children:[e.jsx(y,{children:e.jsx(T,{to:"/runs/flow-run/$id",params:{id:s.flow_run_id},className:"text-xl font-semibold",children:s.flow_run_name})}),e.jsx(S,{})]}),e.jsxs(y,{className:"text-xl",children:[e.jsx(le,{className:"font-semibold",children:s.name}),s.state&&e.jsx(te,{type:s.state.type,name:s.state.name,className:"ml-2"})]})]})}),e.jsxs(_e,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(re,{variant:"outline",className:"p-2",children:e.jsx(ne,{className:"w-4 h-4"})})}),e.jsxs(Te,{children:[u&&e.jsx(b,{onClick:c,children:"Change state"}),e.jsx(b,{onClick:()=>{f.success("Copied task run ID to clipboard"),navigator.clipboard.writeText(s.id)},children:"Copy ID"}),e.jsx(b,{onClick:()=>n({title:"Delete Task Run",description:`Are you sure you want to delete task run ${s.name}?`,onConfirm:t}),children:"Delete"})]})]}),e.jsx(be,{...a}),e.jsx(Ne,{open:r,onOpenChange:l,currentState:s.state?{type:s.state.type,name:s.state.name??s.state.type.charAt(0)+s.state.type.slice(1).toLowerCase()}:null,label:"Task Run",onConfirm:g,isLoading:d})]})},Fe=({currentTab:s,onTabChange:t,logsContent:a,artifactsContent:n,taskInputsContent:r,detailsContent:l})=>(o.useEffect(()=>{const c=getComputedStyle(document.documentElement).getPropertyValue("--breakpoint-lg").trim(),i=window.matchMedia(`(max-width: ${c})`),d=()=>{s==="Details"&&t("Logs")};return i.addEventListener("change",d),()=>i.removeEventListener("change",d)},[s,t]),e.jsxs(ie,{value:s,onValueChange:c=>t(c),children:[e.jsxs(ce,{children:[e.jsx(j,{value:"Details",className:"lg:hidden",children:"Details"}),e.jsx(j,{value:"Logs",children:"Logs"}),e.jsx(j,{value:"Artifacts",children:"Artifacts"}),e.jsxs(j,{value:"TaskInputs",children:["Task Inputs",e.jsxs(oe,{children:[e.jsx(de,{asChild:!0,children:e.jsx(_,{id:"Info",className:"w-4 h-4"})}),e.jsx(xe,{children:"Task inputs show parameter keys and can also show task run relationships."})]})]})]}),e.jsx(p,{value:"Details",children:l}),e.jsx(p,{value:"Logs",children:a}),e.jsx(p,{value:"Artifacts",children:n}),e.jsx(p,{value:"TaskInputs",children:r})]})),Oe=()=>e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-row gap-2 justify-end",children:[e.jsx(x,{className:"h-8 w-25"}),e.jsx(x,{className:"h-8 w-32"})]}),e.jsx(x,{className:"h-32"})]}),Be=()=>e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"flex flex-row justify-end",children:e.jsx(x,{className:"h-8 w-12"})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2 xl:grid-cols-3",children:[e.jsx(x,{className:"h-40"}),e.jsx(x,{className:"h-40"}),e.jsx(x,{className:"h-40"}),e.jsx(x,{className:"h-40"})]})]}),Ve=({taskRun:s})=>e.jsx(me,{value:JSON.stringify(s.task_inputs,null,2),disabled:!0,copy:!0});De({tab:we(["Logs","Artifacts","TaskInputs","Details"]).default("Logs").catch("Logs")});function ss(){const{id:s}=D.useParams(),{tab:t}=D.useSearch(),a=k(),n=r=>{a({to:".",search:l=>({...l,tab:r})})};return e.jsx(Pe,{id:s,tab:t,onTabChange:n})}export{ss as component};
//# sourceMappingURL=task-run._id-u73Jxfqw.js.map
