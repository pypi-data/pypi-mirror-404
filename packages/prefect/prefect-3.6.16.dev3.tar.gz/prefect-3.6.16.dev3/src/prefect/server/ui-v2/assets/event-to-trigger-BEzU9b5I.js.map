{"version":3,"file":"event-to-trigger-BEzU9b5I.js","sources":["../../src/components/automations/automations-wizard/event-to-trigger.ts"],"sourcesContent":["import type { Event } from \"@/api/events\";\nimport type { EventTriggerInput, TriggerTemplate } from \"./automation-schema\";\n\n/**\n * Known Prefect event prefixes used to identify resource types from event names.\n * These prefixes help determine the resource role (e.g., \"flow-run\", \"work-queue\")\n * from event strings like \"prefect.flow-run.Completed\".\n */\nconst PREFECT_EVENT_PREFIXES = [\n\t\"prefect.block-document\",\n\t\"prefect.deployment\",\n\t\"prefect.flow-run\",\n\t\"prefect.flow\",\n\t\"prefect.task-run\",\n\t\"prefect.work-queue\",\n\t\"prefect.work-pool\",\n\t\"prefect.tag\",\n\t\"prefect.concurrency-limit\",\n\t\"prefect.artifact-collection\",\n\t\"prefect.automation\",\n] as const;\n\ntype PrefectResourceRole =\n\t| \"block-document\"\n\t| \"deployment\"\n\t| \"flow-run\"\n\t| \"flow\"\n\t| \"task-run\"\n\t| \"work-queue\"\n\t| \"work-pool\"\n\t| \"tag\"\n\t| \"concurrency-limit\"\n\t| \"artifact-collection\"\n\t| \"automation\";\n\n/**\n * Extracts the Prefect resource role from an event type string.\n *\n * @param eventType - The event type string (e.g., \"prefect.flow-run.Completed\")\n * @returns The resource role (e.g., \"flow-run\") or null if not a known Prefect event\n *\n * @example\n * getPrefectResourceRole(\"prefect.flow-run.Completed\") // returns \"flow-run\"\n * getPrefectResourceRole(\"prefect.work-queue.ready\") // returns \"work-queue\"\n * getPrefectResourceRole(\"custom.event\") // returns null\n */\nexport function getPrefectResourceRole(\n\teventType: string,\n): PrefectResourceRole | null {\n\tconst roleRegex = new RegExp(\n\t\t`^(${PREFECT_EVENT_PREFIXES.join(\"|\")})\\\\.`,\n\t\t\"g\",\n\t);\n\tconst match = roleRegex.exec(eventType);\n\tif (!match) {\n\t\treturn null;\n\t}\n\n\tconst prefix = match[1];\n\tconst role = prefix?.split(\".\").at(-1);\n\n\tif (role && isPrefectResourceRole(role)) {\n\t\treturn role;\n\t}\n\n\treturn null;\n}\n\nfunction isPrefectResourceRole(value: string): value is PrefectResourceRole {\n\tconst validRoles: PrefectResourceRole[] = [\n\t\t\"block-document\",\n\t\t\"deployment\",\n\t\t\"flow-run\",\n\t\t\"flow\",\n\t\t\"task-run\",\n\t\t\"work-queue\",\n\t\t\"work-pool\",\n\t\t\"tag\",\n\t\t\"concurrency-limit\",\n\t\t\"artifact-collection\",\n\t\t\"automation\",\n\t];\n\treturn validRoles.includes(value as PrefectResourceRole);\n}\n\n/**\n * Type for a related resource from an event.\n */\ntype RelatedResource = NonNullable<Event[\"related\"]>[number];\n\n/**\n * Finds a related resource by its role from an event's related resources array.\n *\n * @param related - Array of related resources from the event\n * @param role - The role to search for (e.g., \"flow\", \"work-queue\")\n * @returns The related resource with the matching role, or undefined if not found\n */\nfunction getRelatedByRole(\n\trelated: Event[\"related\"],\n\trole: string,\n): RelatedResource | undefined {\n\tif (!related) {\n\t\treturn undefined;\n\t}\n\treturn related.find((r) => r[\"prefect.resource.role\"] === role);\n}\n\n/**\n * Result of transforming an event to automation wizard default values.\n */\nexport type EventToTriggerResult = {\n\ttrigger: EventTriggerInput;\n\ttriggerTemplate: TriggerTemplate;\n};\n\n/**\n * Transforms an Event into default values for the automation wizard.\n *\n * This function creates a trigger configuration based on the event type:\n * - For flow-run events: includes match_related for the associated flow\n * - For work-queue events: includes match_related for the work-queue\n * - For other events: creates a basic custom trigger\n *\n * All triggers use:\n * - posture: \"Reactive\"\n * - match: { \"prefect.resource.id\": <event's resource id> }\n * - for_each: [\"prefect.resource.id\"]\n * - expect: [<event type>]\n * - triggerTemplate: \"custom\"\n *\n * @param event - The event to transform\n * @returns An object containing the trigger configuration and template type\n *\n * @example\n * const event = {\n *   event: \"prefect.flow-run.Completed\",\n *   resource: { \"prefect.resource.id\": \"prefect.flow-run.abc123\" },\n *   related: [{ \"prefect.resource.role\": \"flow\", \"prefect.resource.id\": \"prefect.flow.xyz789\" }]\n * };\n * const result = transformEventToTrigger(event);\n * // result.trigger.match_related = { \"prefect.resource.role\": \"flow\", \"prefect.resource.id\": \"prefect.flow.xyz789\" }\n */\nexport function transformEventToTrigger(event: Event): EventToTriggerResult {\n\tconst role = getPrefectResourceRole(event.event);\n\n\tswitch (role) {\n\t\tcase \"flow-run\":\n\t\t\treturn createFlowRunTrigger(event);\n\t\tcase \"work-queue\":\n\t\t\treturn createWorkQueueTrigger(event);\n\t\tdefault:\n\t\t\treturn createCustomTrigger(event);\n\t}\n}\n\n/**\n * Creates a trigger for flow-run events with match_related for the associated flow.\n */\nfunction createFlowRunTrigger(event: Event): EventToTriggerResult {\n\tconst relatedFlow = getRelatedByRole(event.related, \"flow\");\n\n\tconst trigger: EventTriggerInput = {\n\t\ttype: \"event\",\n\t\tmatch: {\n\t\t\t\"prefect.resource.id\": event.resource[\"prefect.resource.id\"],\n\t\t},\n\t\tmatch_related: relatedFlow\n\t\t\t? {\n\t\t\t\t\t\"prefect.resource.role\": \"flow\",\n\t\t\t\t\t\"prefect.resource.id\": relatedFlow[\"prefect.resource.id\"],\n\t\t\t\t}\n\t\t\t: {},\n\t\tafter: [],\n\t\texpect: [event.event],\n\t\tfor_each: [\"prefect.resource.id\"],\n\t\tposture: \"Reactive\",\n\t\tthreshold: 1,\n\t\twithin: 0,\n\t};\n\n\treturn {\n\t\ttrigger,\n\t\ttriggerTemplate: \"custom\",\n\t};\n}\n\n/**\n * Creates a trigger for work-queue events with match_related for the work-queue.\n */\nfunction createWorkQueueTrigger(event: Event): EventToTriggerResult {\n\tconst relatedWorkQueue = getRelatedByRole(event.related, \"work-queue\");\n\n\tconst trigger: EventTriggerInput = {\n\t\ttype: \"event\",\n\t\tmatch: {\n\t\t\t\"prefect.resource.id\": event.resource[\"prefect.resource.id\"],\n\t\t},\n\t\tmatch_related: relatedWorkQueue\n\t\t\t? {\n\t\t\t\t\t\"prefect.resource.role\": \"work-queue\",\n\t\t\t\t\t\"prefect.resource.id\": relatedWorkQueue[\"prefect.resource.id\"],\n\t\t\t\t}\n\t\t\t: {},\n\t\tafter: [],\n\t\texpect: [event.event],\n\t\tfor_each: [\"prefect.resource.id\"],\n\t\tposture: \"Reactive\",\n\t\tthreshold: 1,\n\t\twithin: 0,\n\t};\n\n\treturn {\n\t\ttrigger,\n\t\ttriggerTemplate: \"custom\",\n\t};\n}\n\n/**\n * Creates a basic custom trigger for events that don't have special handling.\n */\nfunction createCustomTrigger(event: Event): EventToTriggerResult {\n\treturn {\n\t\ttrigger: {\n\t\t\ttype: \"event\",\n\t\t\tmatch: {\n\t\t\t\t\"prefect.resource.id\": event.resource[\"prefect.resource.id\"],\n\t\t\t},\n\t\t\tmatch_related: {},\n\t\t\tafter: [],\n\t\t\texpect: [event.event],\n\t\t\tfor_each: [],\n\t\t\tposture: \"Reactive\",\n\t\t\tthreshold: 1,\n\t\t\twithin: 0,\n\t\t},\n\t\ttriggerTemplate: \"custom\",\n\t};\n}\n\n/**\n * Formats a date to YYYY-MM-DD string format for use in URL search parameters.\n *\n * @param date - The date to format (can be a Date object or ISO string)\n * @returns The formatted date string in YYYY-MM-DD format\n *\n * @example\n * formatEventDate(new Date(\"2024-01-15T10:30:00Z\")) // returns \"2024-01-15\"\n * formatEventDate(\"2024-01-15T10:30:00Z\") // returns \"2024-01-15\"\n */\nexport function formatEventDate(date: Date | string): string {\n\tconst dateObj = typeof date === \"string\" ? new Date(date) : date;\n\treturn dateObj.toISOString().split(\"T\")[0];\n}\n"],"names":["PREFECT_EVENT_PREFIXES","getPrefectResourceRole","eventType","match","role","isPrefectResourceRole","value","getRelatedByRole","related","r","transformEventToTrigger","event","createFlowRunTrigger","createWorkQueueTrigger","createCustomTrigger","relatedFlow","relatedWorkQueue","formatEventDate","date"],"mappings":"AAQA,MAAMA,EAAyB,CAC9B,yBACA,qBACA,mBACA,eACA,mBACA,qBACA,oBACA,cACA,4BACA,8BACA,oBACD,EA0BO,SAASC,EACfC,EAC6B,CAK7B,MAAMC,EAJY,IAAI,OACrB,KAAKH,EAAuB,KAAK,GAAG,CAAC,OACrC,GAAA,EAEuB,KAAKE,CAAS,EACtC,GAAI,CAACC,EACJ,OAAO,KAIR,MAAMC,EADSD,EAAM,CAAC,GACD,MAAM,GAAG,EAAE,GAAG,EAAE,EAErC,OAAIC,GAAQC,EAAsBD,CAAI,EAC9BA,EAGD,IACR,CAEA,SAASC,EAAsBC,EAA6C,CAc3E,MAb0C,CACzC,iBACA,aACA,WACA,OACA,WACA,aACA,YACA,MACA,oBACA,sBACA,YAAA,EAEiB,SAASA,CAA4B,CACxD,CAcA,SAASC,EACRC,EACAJ,EAC8B,CAC9B,GAAKI,EAGL,OAAOA,EAAQ,KAAMC,GAAMA,EAAE,uBAAuB,IAAML,CAAI,CAC/D,CAqCO,SAASM,EAAwBC,EAAoC,CAG3E,OAFaV,EAAuBU,EAAM,KAAK,EAEvC,CACP,IAAK,WACJ,OAAOC,EAAqBD,CAAK,EAClC,IAAK,aACJ,OAAOE,EAAuBF,CAAK,EACpC,QACC,OAAOG,EAAoBH,CAAK,CAAA,CAEnC,CAKA,SAASC,EAAqBD,EAAoC,CACjE,MAAMI,EAAcR,EAAiBI,EAAM,QAAS,MAAM,EAqB1D,MAAO,CACN,QApBkC,CAClC,KAAM,QACN,MAAO,CACN,sBAAuBA,EAAM,SAAS,qBAAqB,CAAA,EAE5D,cAAeI,EACZ,CACA,wBAAyB,OACzB,sBAAuBA,EAAY,qBAAqB,CAAA,EAExD,CAAA,EACH,MAAO,CAAA,EACP,OAAQ,CAACJ,EAAM,KAAK,EACpB,SAAU,CAAC,qBAAqB,EAChC,QAAS,WACT,UAAW,EACX,OAAQ,CAAA,EAKR,gBAAiB,QAAA,CAEnB,CAKA,SAASE,EAAuBF,EAAoC,CACnE,MAAMK,EAAmBT,EAAiBI,EAAM,QAAS,YAAY,EAqBrE,MAAO,CACN,QApBkC,CAClC,KAAM,QACN,MAAO,CACN,sBAAuBA,EAAM,SAAS,qBAAqB,CAAA,EAE5D,cAAeK,EACZ,CACA,wBAAyB,aACzB,sBAAuBA,EAAiB,qBAAqB,CAAA,EAE7D,CAAA,EACH,MAAO,CAAA,EACP,OAAQ,CAACL,EAAM,KAAK,EACpB,SAAU,CAAC,qBAAqB,EAChC,QAAS,WACT,UAAW,EACX,OAAQ,CAAA,EAKR,gBAAiB,QAAA,CAEnB,CAKA,SAASG,EAAoBH,EAAoC,CAChE,MAAO,CACN,QAAS,CACR,KAAM,QACN,MAAO,CACN,sBAAuBA,EAAM,SAAS,qBAAqB,CAAA,EAE5D,cAAe,CAAA,EACf,MAAO,CAAA,EACP,OAAQ,CAACA,EAAM,KAAK,EACpB,SAAU,CAAA,EACV,QAAS,WACT,UAAW,EACX,OAAQ,CAAA,EAET,gBAAiB,QAAA,CAEnB,CAYO,SAASM,EAAgBC,EAA6B,CAE5D,OADgB,OAAOA,GAAS,SAAW,IAAI,KAAKA,CAAI,EAAIA,GAC7C,YAAA,EAAc,MAAM,GAAG,EAAE,CAAC,CAC1C"}