name: Test

permissions:
  contents: write

on:
  push:
  pull_request:

defaults:
  run:
    shell: bash --noprofile --norc -CeEuo pipefail {0}

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macos-arm64
            os: macos-latest
          - name: windows
            os: windows-latest
          - name: ubuntu
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}
    name: test-${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: latest
      - uses: denoland/setup-deno@v2
        with:
          deno-version: latest
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      # - uses: browser-actions/setup-chrome@v2
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
      - name: install
        run: |
          curl -fsSL https://raw.githubusercontent.com/easy-install/easy-install/main/install.sh | sh

          python3 -m venv venv
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_BIN="venv/Scripts"
            PLUGIN_DIR="$APPDATA/yt-dlp/plugins"
          else
            VENV_BIN="venv/bin"
            PLUGIN_DIR="$HOME/.yt-dlp/plugins"
          fi
          source $VENV_BIN/activate

          uv tool install maturin
          uv tool install pipx
          uv tool install pyinstaller

          pipx install yt-dlp
          which yt-dlp

          maturin build --release
          # maturin develop

          WHEELS_DIR="target/wheels"
          mkdir -p "$PLUGIN_DIR"
          WHL_FILE=$(find "$WHEELS_DIR" -name "*.whl" -type f | head -n 1)
          if [[ -z "$WHL_FILE" ]]; then
              echo "Error: No .whl file found in $WHEELS_DIR"
              exit 1
          fi
          echo "Installing: $WHL_FILE"
          echo "Target: $PLUGIN_DIR"

          # pip install "$WHL_FILE" --target "$PLUGIN_DIR" --force-reinstall --no-deps
          pipx inject yt-dlp "$WHL_FILE"
          pipx install "$WHL_FILE"
          # pip install ytdlp-jsc --no-index --find-links=./target/wheels/
          pip install ytdlp-jsc --no-index --find-links=./target/wheels/ --target=$PLUGIN_DIR
          pip install ytdlp-jsc --no-index --find-links=./target/wheels/ --target=./whl

          pyinstaller whl/ytdlp_jsc/cli.py --onedir --collect-all ytdlp_jsc
          # pyinstaller dist/ytdlp_jsc/cli.py --onefile  --collect-all ytdlp_jsc

          # ln -sf "$(pwd)/dist/cli/cli" ~/.ei/ytdlp-jsc-cli
          cp -rf dist/cli/cli ~/.ei/ytdlp-jsc-cli
          cp -rf dist/cli/_internal ~/.ei/_internal

      - name: Check IP
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: curl https://ifconfig.me

      - name: Set up WARP
        uses: fscarmen/warp-on-actions@v1.4
        if: ${{ matrix.os == 'ubuntu-latest' }}
        with:
          stack: dual # Optional. Support [ ipv4, ipv6, dual ]. Default is dual.
          mode: client # Optional. Support [ wireguard, client ]. Default is wireguard.
      - name: Check IP
        run: curl https://ifconfig.me

      - name: test
        env:
          YT_COOKIE: ${{ secrets.YT_COOKIE }}
        run: |
          echo "$YT_COOKIE" > cookies.txt
          ls -lh cookies.txt
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
          # --user-agent "$UA"
          # --cookies cookies.txt
          yt-dlp -v --extractor-args "youtube:jsc_trace=true" -F "https://www.youtube.com/watch?v=BnnbP7pCIvQ" 2>&1 | grep -E "(jsc|Provider|challenge)" || echo "Command failed, continuing..."
          yt-dlp -F "https://www.youtube.com/watch?v=BnnbP7pCIvQ" || echo "Command failed, continuing..."
      - name: install hyperfine
        run: |
          ei https://github.com/sharkdp/hyperfine
          ei https://github.com/ahaoboy/ytdlp-ejs

      - name: build run.js
        run: |
          git clone https://github.com/yt-dlp/ejs
          cd ejs
          bun i
          bun i esbuild -g
          mkdir players
          curl -o players/3d3ba064-main "https://www.youtube.com/s/player/3d3ba064/player_ias.vflset/en_US/base.js"
          esbuild run.ts --bundle --platform=node --format=esm > run.js
      - name: bench
        run: |
          RUN_JS="ejs/run.js"
          PLAYER_JS="ejs/players/3d3ba064-main"
          ARG="n:ZdZIqFPQK-Ty8wId"

          deno --allow-read=. $RUN_JS $PLAYER_JS $ARG
          bun $RUN_JS $PLAYER_JS $ARG
          node $RUN_JS $PLAYER_JS $ARG
          ytdlp-jsc $PLAYER_JS $ARG
          ytdlp-jsc-cli $PLAYER_JS $ARG
          ejs --runtime qjs $PLAYER_JS $ARG

          hyperfine \
              "deno --allow-read=. $RUN_JS $PLAYER_JS $ARG" \
              "bun $RUN_JS $PLAYER_JS $ARG" \
              "node $RUN_JS $PLAYER_JS $ARG" \
              "ytdlp-jsc $PLAYER_JS $ARG" \
              "ytdlp-jsc-cli $PLAYER_JS $ARG" \
              "ejs --runtime qjs $PLAYER_JS $ARG"
