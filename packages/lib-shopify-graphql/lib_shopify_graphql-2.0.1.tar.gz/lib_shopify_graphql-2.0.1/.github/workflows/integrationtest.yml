name: Integration Tests

on:
  workflow_dispatch:  # Manual trigger only (requires real Shopify credentials)
  schedule:
    # Run weekly on Sunday at 4:17 AM UTC
    - cron: '17 4 * * 0'

jobs:
  integration:
    name: Integration Tests (Python 3.14, Linux)
    runs-on: ubuntu-latest
    env:
      PYTHONIOENCODING: "utf-8"
      # Shopify credentials from repository secrets
      # Format: LIB_SHOPIFY_GRAPHQL___SECTION__KEY (triple underscore after prefix)
      LIB_SHOPIFY_GRAPHQL___SHOPIFY__SHOP_URL: ${{ secrets.SHOPIFY_SHOP_URL }}
      LIB_SHOPIFY_GRAPHQL___SHOPIFY__CLIENT_ID: ${{ secrets.SHOPIFY_CLIENT_ID }}
      LIB_SHOPIFY_GRAPHQL___SHOPIFY__CLIENT_SECRET: ${{ secrets.SHOPIFY_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.14"
          cache: 'pip'
          cache-dependency-path: 'pyproject.toml'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install journald prerequisites
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-systemd

      - name: Upgrade pip
        shell: bash
        run: python -m pip install --upgrade pip

      - name: Install dev deps
        shell: bash
        run: uv pip install -e .[dev] --system

      - name: Check Shopify credentials
        shell: bash
        run: |
          if [ -z "$LIB_SHOPIFY_GRAPHQL___SHOPIFY__SHOP_URL" ] || [ -z "$LIB_SHOPIFY_GRAPHQL___SHOPIFY__CLIENT_ID" ] || [ -z "$LIB_SHOPIFY_GRAPHQL___SHOPIFY__CLIENT_SECRET" ]; then
            echo "::error::Missing Shopify credentials. Set SHOPIFY_SHOP_URL, SHOPIFY_CLIENT_ID, and SHOPIFY_CLIENT_SECRET as repository secrets."
            exit 1
          fi
          echo "Shopify credentials configured for: $LIB_SHOPIFY_GRAPHQL___SHOPIFY__SHOP_URL"

      - name: Run integration tests (test-slow)
        shell: bash
        run: make test-slow
