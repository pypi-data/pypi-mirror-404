Metadata-Version: 2.4
Name: isagellm-gateway
Version: 0.4.0.6
Summary: sageLLM Gateway - OpenAI/Anthropic compatible API Gateway (L6)
Author-email: IntelliStream Team <intellistream@github.com>
License: Apache-2.0
Project-URL: Documentation, https://intellistream.github.io/sagellm-docs/
Project-URL: Homepage, https://github.com/intellistream/sagellm-gateway
Project-URL: Issues, https://github.com/intellistream/sagellm-gateway/issues
Project-URL: Repository, https://github.com/intellistream/sagellm-gateway
Keywords: sagellm,gateway,llm,openai,anthropic,inference
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: Apache Software License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Topic :: Scientific/Engineering :: Artificial Intelligence
Requires-Python: ==3.11.*
Description-Content-Type: text/markdown
Requires-Dist: isagellm-protocol<0.5.0,>=0.4.0.0
Requires-Dist: fastapi<1.0.0,>=0.115.0
Requires-Dist: uvicorn[standard]<1.0.0,>=0.34.0
Requires-Dist: pydantic<3.0.0,>=2.10.0
Requires-Dist: sse-starlette>=1.8.0
Requires-Dist: httpx<1.0.0,>=0.28.0
Provides-Extra: dev
Requires-Dist: pytest>=7.4.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: pytest-cov>=4.1.0; extra == "dev"
Requires-Dist: ruff>=0.4.0; extra == "dev"
Requires-Dist: mypy>=1.7.0; extra == "dev"
Requires-Dist: isage-pypi-publisher>=0.2.0; extra == "dev"

# sageLLM Gateway

## Protocol Compliance (Mandatory)

- MUST follow Protocol v0.1: https://github.com/intellistream/sagellm-docs/blob/main/docs/specs/protocol_v0.1.md
- Any globally shared definitions (fields, error codes, metrics, IDs, schemas) MUST be added to Protocol first.

[![CI](https://github.com/intellistream/sagellm-gateway/actions/workflows/ci.yml/badge.svg)](https://github.com/intellistream/sagellm-gateway/actions/workflows/ci.yml)
[![PyPI version](https://badge.fury.io/py/isagellm-gateway.svg)](https://badge.fury.io/py/isagellm-gateway)
[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![Pre-commit](https://img.shields.io/badge/pre--commit-enabled-brightgreen?logo=pre-commit&logoColor=white)](https://github.com/pre-commit/pre-commit)

**isagellm-gateway** - OpenAI/Anthropic Compatible API Gateway for sageLLM

## Overview

OpenAI-compatible API gateway for sageLLM inference engine.

**Features:**

- OpenAI-compatible endpoints (`/v1/chat/completions`, `/v1/models`)
- Session management with multiple storage backends
- Control Plane integration (optional)

## Installation

```bash
# åŸºç¡€å®‰è£…
pip install isagellm-gateway

# åŒ…å« Control Plane é›†æˆ
pip install isagellm-gateway[control-plane]

# å®Œæ•´åŠŸèƒ½ï¼ˆåŒ…å« Redis ç­‰ï¼‰
pip install isagellm-gateway[full]
```

## ğŸš€ å¼€å‘è€…å¿«é€Ÿå¼€å§‹

```bash
git clone git@github.com:intellistream/sagellm-gateway.git
cd sagellm-gateway
./quickstart.sh   # ä¸€é”®å®‰è£…å¼€å‘ç¯å¢ƒï¼ˆå«ä¾èµ–ï¼‰

# æˆ–æ‰‹åŠ¨å®‰è£…
pip install -e ".[dev]"
```

è¿è¡Œæµ‹è¯•ï¼š

```bash
pytest tests/ -v
```

## Quick Start

### Production Mode

For real inference with Control Plane:

```bash
pip install 'isagellm-gateway[control-plane]'
sagellm-gateway --control-plane --port 8080
```

### å‘é€è¯·æ±‚

```bash
# Chat Completion
curl http://localhost:8080/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "sshleifer/tiny-gpt2",
    "messages": [{"role": "user", "content": "Hello!"}]
  }'

# Health Check
curl http://localhost:8080/health

# List Models
curl http://localhost:8080/v1/models
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         sageLLM Gateway                 â”‚
â”‚  â€¢ OpenAI-compatible API                â”‚
â”‚  â€¢ Session management                   â”‚
â”‚  â€¢ Multiple storage backends            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Control Plane (optional)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Inference Backend                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Configuration

### Environment Variables

| Variable                                    | Description                                       | Default                            |
| ------------------------------------------- | ------------------------------------------------- | ---------------------------------- |
| `SAGELLM_GATEWAY_HOST`                      | Server host                                       | `0.0.0.0`                          |
| `SAGELLM_GATEWAY_PORT`                      | Server port                                       | `8080`                             |
| `SAGELLM_GATEWAY_SESSION_BACKEND`           | Session storage backend (`memory`/`file`/`redis`) | `memory`                           |
| `SAGELLM_GATEWAY_SESSION_FILE_PATH`         | File backend path                                 | `~/.sagellm/gateway/sessions.json` |
| `SAGELLM_GATEWAY_SESSION_FILE_COMPRESS`     | Enable gzip compression for file backend          | `false`                            |
| `SAGELLM_GATEWAY_SESSION_FILE_AUTO_CLEANUP` | Auto-cleanup expired sessions on load             | `false`                            |
| `SAGELLM_GATEWAY_SESSION_TTL_MINUTES`       | Session TTL in minutes                            | `1440` (24h)                       |
| `SAGELLM_GATEWAY_SESSION_REDIS_URL`         | Redis URL for redis backend                       | `redis://localhost:6379/0`         |
| `SAGELLM_GATEWAY_ENABLE_CONTROL_PLANE`      | Enable Control Plane                              | `false`                            |

### CLI Options

```bash
sagellm-gateway --help

Options:
  --host TEXT      Server host [default: 0.0.0.0]
  --port INTEGER   Server port [default: 8080]
  --control-plane  Enable Control Plane integration
  --log-level      Log level (debug/info/warning/error)
```

## API Reference

### POST /v1/chat/completions

OpenAI å…¼å®¹çš„ Chat Completion ç«¯ç‚¹ã€‚

**Request:**

```json
{
  "model": "string",
  "messages": [{ "role": "user", "content": "Hello!" }],
  "stream": false,
  "temperature": 1.0,
  "max_tokens": null,
  "session_id": null
}
```

**Response:**

```json
{
  "id": "chatcmpl-xxx",
  "object": "chat.completion",
  "created": 1234567890,
  "model": "sshleifer/tiny-gpt2",
  "choices": [
    {
      "index": 0,
      "message": { "role": "assistant", "content": "Hello! How can I help?" },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 5,
    "total_tokens": 15
  }
}
```

### GET /v1/models

åˆ—å‡ºå¯ç”¨æ¨¡å‹ã€‚

### GET /health

å¥åº·æ£€æŸ¥ç«¯ç‚¹ã€‚

### Session Management

- `GET /sessions` - åˆ—å‡ºä¼šè¯
- `POST /sessions` - åˆ›å»ºä¼šè¯
- `GET /sessions/{id}` - è·å–ä¼šè¯è¯¦æƒ…
- `DELETE /sessions/{id}` - åˆ é™¤ä¼šè¯
- `POST /sessions/{id}/clear` - æ¸…ç©ºä¼šè¯å†å²

## Session Storage

sageLLM Gateway æ”¯æŒå¤šç§ä¼šè¯å­˜å‚¨åç«¯ï¼š

### InMemoryStore (é»˜è®¤)

æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿›ç¨‹é€€å‡ºåä¸¢å¤±ã€‚é€‚ç”¨äºæµ‹è¯•å’Œä¸´æ—¶åœºæ™¯ã€‚

```bash
export SAGELLM_GATEWAY_SESSION_BACKEND=memory
```

### FileStore

å°†ä¼šè¯æŒä¹…åŒ–åˆ° JSON æ–‡ä»¶ï¼Œæ”¯æŒï¼š

- **å‹ç¼©å­˜å‚¨**ï¼šä½¿ç”¨ gzip å‡å°‘ç£ç›˜å ç”¨
- **å¹¶å‘å®‰å…¨**ï¼šæ–‡ä»¶é”ä¿è¯å¤šè¿›ç¨‹å®‰å…¨
- **è‡ªåŠ¨æ¸…ç†**ï¼šåœ¨åŠ è½½æ—¶æ¸…ç†è¿‡æœŸä¼šè¯

```bash
# åŸºæœ¬ä½¿ç”¨
export SAGELLM_GATEWAY_SESSION_BACKEND=file
export SAGELLM_GATEWAY_SESSION_FILE_PATH=/path/to/sessions.json

# å¯ç”¨å‹ç¼©
export SAGELLM_GATEWAY_SESSION_FILE_COMPRESS=true

# å¯ç”¨è‡ªåŠ¨æ¸…ç†ï¼ˆ24å°æ—¶è¿‡æœŸï¼‰
export SAGELLM_GATEWAY_SESSION_FILE_AUTO_CLEANUP=true
export SAGELLM_GATEWAY_SESSION_TTL_MINUTES=1440
```

### RedisStore (å¯é€‰ä¾èµ–)

ä½¿ç”¨ Redis ä½œä¸ºåˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨ï¼Œæ”¯æŒï¼š

- **è¿æ¥æ± **ï¼šé«˜æ•ˆçš„è¿æ¥ç®¡ç†
- **TTL è‡ªåŠ¨è¿‡æœŸ**ï¼šRedis åŸç”Ÿè¿‡æœŸæœºåˆ¶
- **é«˜å¯ç”¨**ï¼šé€‚åˆç”Ÿäº§ç¯å¢ƒ

```bash
# å®‰è£… Redis ä¾èµ–
pip install isagellm-gateway[full]

# é…ç½®
export SAGELLM_GATEWAY_SESSION_BACKEND=redis
export SAGELLM_GATEWAY_SESSION_REDIS_URL=redis://localhost:6379/0
export SAGELLM_GATEWAY_SESSION_TTL_MINUTES=1440
```

### Session Export/Import

æ”¯æŒä¼šè¯çš„å¯¼å‡ºå’Œå¯¼å…¥ï¼Œä¾¿äºå¤‡ä»½å’Œè¿ç§»ï¼š

```python
from sagellm_gateway.session import SessionManager, ChatSession

manager = SessionManager()

# å¯¼å‡ºæ‰€æœ‰ä¼šè¯åˆ°æ–‡ä»¶
manager.export_all_to_file("/path/to/backup.json")

# ä»æ–‡ä»¶å¯¼å…¥ä¼šè¯
imported, skipped = manager.import_from_file("/path/to/backup.json")

# å¯¼å‡ºå•ä¸ªä¼šè¯
session = manager.get("session-id")
json_str = session.export_json()

# ä» JSON æ¢å¤ä¼šè¯
restored = ChatSession.from_json(json_str)
```

## Development

### Run Tests

```bash
pytest -v

# With coverage
pytest --cov=sagellm_gateway --cov-report=html
```

### Code Quality

```bash
ruff format .
ruff check . --fix
mypy src/
```

## CPU Backend Validation

Gateway éªŒè¯ä¸è”è°ƒè¯·ä½¿ç”¨ CPU backendï¼š

- é€šè¿‡ Control Plane å¯åŠ¨å¹¶æ³¨å†Œ CPU å¼•æ“
- Gateway ä»…å¯¹æ¥ Control Plane

---

## ğŸ“š Documentation

### å¿«é€Ÿé“¾æ¥

- **[éƒ¨ç½²æŒ‡å—](https://github.com/intellistream/sagellm/blob/main/docs/DEPLOYMENT_GUIDE.md)** - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯¦è§£
- **[æ•…éšœæ’æŸ¥](https://github.com/intellistream/sagellm/blob/main/docs/TROUBLESHOOTING.md)** - å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³
- **[ç¯å¢ƒå˜é‡](https://github.com/intellistream/sagellm/blob/main/docs/ENVIRONMENT_VARIABLES.md)** - å®Œæ•´ç¯å¢ƒå˜é‡å‚è€ƒ

## ğŸ”„ è´¡çŒ®æŒ‡å—

è¯·éµå¾ªä»¥ä¸‹å·¥ä½œæµç¨‹ï¼š

1. **åˆ›å»º Issue** - æè¿°é—®é¢˜/éœ€æ±‚

   ```bash
   gh issue create --title "[Bug] æè¿°" --label "bug,sagellm-gateway"
   ```

2. **å¼€å‘ä¿®å¤** - åœ¨æœ¬åœ° `fix/#123-xxx` åˆ†æ”¯è§£å†³

   ```bash
   git checkout -b fix/#123-xxx origin/main-dev
   # å¼€å‘ã€æµ‹è¯•...
   pytest -v
   ruff format . && ruff check . --fix
   ```

3. **å‘èµ· PR** - æäº¤åˆ° `main-dev` åˆ†æ”¯

   ```bash
   gh pr create --base main-dev --title "Fix: æè¿°" --body "Closes #123"
   ```

4. **åˆå¹¶** - å®¡æ‰¹ååˆå¹¶åˆ° `main-dev`

æ›´å¤šè¯¦æƒ…è§ [.github/copilot-instructions.md](.github/copilot-instructions.md)

### ç›¸å…³ä»“åº“

- [sagellm](https://github.com/intellistream/sagellm) - Umbrella åŒ… + CLI
- [sagellm-protocol](https://github.com/intellistream/sagellm-protocol) - åè®®å®šä¹‰
- [sagellm-control-plane](https://github.com/intellistream/sagellm-control-plane) - æ§åˆ¶é¢
- [sagellm-backend](https://github.com/intellistream/sagellm-backend) - åç«¯æŠ½è±¡

---

## License

Apache-2.0

# Test auto-push fix

# Final test
