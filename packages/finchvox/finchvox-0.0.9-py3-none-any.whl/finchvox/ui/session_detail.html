<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Detail - Finchvox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'span-stt': '#f97316',
                        'span-llm': '#ec4899',
                        'span-tts': '#a855f7',
                        'span-turn': '#10b981',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/css/app.css">
    <script defer src="/lib/alpine.min.js"></script>
    <script src="/lib/wavesurfer.min.js"></script>
    <script src="/lib/chart.min.js"></script>
</head>
<body class="bg-[#050507] text-white min-h-screen flex flex-col overflow-y-auto overflow-x-hidden text-sm font-sans" x-data="sessionDetailApp()" x-init="init()">

    <!-- Main flex container for content and side panel -->
    <div class="flex flex-1 overflow-y-hidden overflow-x-visible relative">
        <!-- Main content area -->
        <div class="flex-1 flex flex-col overflow-y-auto overflow-x-visible transition-[margin-right] duration-300 ease-out" :class="{ 'mr-[400px]': isPanelOpen || isLogPanelOpen }">
            <!-- Fixed container for header and audio player -->
            <div class="fixed top-0 left-0 z-[100] bg-[#050507]" :class="{ 'right-[400px]': isPanelOpen || isLogPanelOpen, 'right-0': !isPanelOpen && !isLogPanelOpen }">
                <!-- Back button -->
                <div class="py-3.5 px-8 border-b border-white/10 flex items-center gap-2.5 bg-[#050507]">
                    <img src="/images/finchvox-logo.png" alt="FinchVox Logo" class="h-5 w-auto"> <a href="/" class="text-amber-400 underline hover:text-amber-300 transition-colors">Sessions</a> / <span x-show="serviceName" x-text="serviceName"></span> <span x-show="serviceName">/ </span><span x-text="sessionId">loading...</span>
                    <span x-show="isPolling" class="live-badge">Live</span>
                </div>

                <!-- Audio Player Section -->
                <section class="py-4 px-8 border-b border-white/10 bg-white/[0.02] h-[236px]">
                <div class="flex items-center justify-between gap-4 mb-4">
                    <div class="flex items-center gap-4">
                        <button @click="!audioError && togglePlay()" :disabled="audioError" class="flex items-center bg-white/5 text-white/40 border border-white/10 rounded px-3 py-1.5 text-xs font-mono transition-all duration-200" :class="audioError ? 'opacity-50 cursor-not-allowed' : 'hover:bg-white/10 hover:text-white/60 cursor-pointer'" title="SPACEBAR">
                            <span x-show="!playing" class="flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                                  </svg> <span>Play</span>
                            </span>
                            <span x-show="playing" class="flex items-center justify-center gap-2">
                                <span>⏸</span><span>Pause</span>
                            </span>
                        </button>
                        <div class="flex items-center gap-4 text-xs">
                            <span class="text-[#f97316] flex items-center gap-1.5">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M1 10v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-2 0zM6 6v12a1 1 0 0 0 2 0V6a1 1 0 0 0-2 0zM21 10v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-2 0zM16 6v12a1 1 0 0 0 2 0V6a1 1 0 0 0-2 0zM11 2v20a1 1 0 0 0 2 0V2a1 1 0 0 0-2 0z"/>
                                </svg>
                                User
                            </span>
                            <span class="text-[#a855f7] flex items-center gap-1.5">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M1 10v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-2 0zM6 6v12a1 1 0 0 0 2 0V6a1 1 0 0 0-2 0zM21 10v4a1 1 0 0 0 2 0v-4a1 1 0 0 0-2 0zM16 6v12a1 1 0 0 0 2 0V6a1 1 0 0 0-2 0zM11 2v20a1 1 0 0 0 2 0V2a1 1 0 0 0-2 0z"/>
                                </svg>
                                Agent
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-xs">
                            <span class="text-white/70" x-text="formatTime(currentTime)">00:00</span>
                            <span class="text-white/40">/</span>
                            <span class="text-white/70" x-text="formatTime(duration)">00:00</span>
                        </span>
                        <a :href="'/api/sessions/' + sessionId + '/raw'" target="_blank" class="flex items-center bg-white/5 text-white/40 border border-white/10 hover:bg-white/10 hover:text-white/60 rounded px-3 py-1.5 text-xs font-mono transition-all duration-200 cursor-pointer no-underline" title="View raw data">
                            <span class="flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" />
                                </svg>
                                <span>Raw Data</span>
                            </span>
                        </a>
                        <a :href="'/api/sessions/' + sessionId + '/audio/download'" download class="flex items-center gap-2 bg-white/5 text-white/40 border border-white/10 hover:bg-white/10 hover:text-white/60 rounded px-3 py-1.5 text-xs font-mono transition-all duration-200 cursor-pointer no-underline" title="Download Audio">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                        </a>
                    </div>
                </div>


                <!-- Hover Marker Overlay -->
                <div class="absolute top-[108px] left-0 h-[157px] pointer-events-none z-20" x-show="hoverMarker.visible" :style="`left: ${getMarkerPosition()}`">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 bg-gray-500 text-black py-0.5 px-1.5 rounded-sm text-[10px] font-medium tracking-wide font-mono whitespace-nowrap z-20" x-text="getMarkerTimeLabel()"></div>
                    <div class="absolute top-4 h-[117px] left-0 w-px bg-gray-500"></div>
                </div>

                <!-- Timeline -->
                <div id="timeline" class="h-6 mb-1 border-b border-white/10 pb-0.5"></div>

                <!-- Human text chunks -->
                <div class="relative h-[22px] mb-1 pointer-events-none"
                    x-show="getTurnChunks().length > 0">
                    <template x-for="chunk in getTurnChunks()" :key="chunk.span_id_hex">
                        <div class="absolute h-5 px-1.5 flex items-center bg-white/5 rounded-sm overflow-hidden whitespace-nowrap pointer-events-auto cursor-pointer transition-colors border border-black text-ellipsis text-white/70 hover:bg-[#3a3a3a]"
                            x-show="chunk.humanText"
                            :class="{ 'bg-[#3a3a3a]': hoveredSpan?.span_id_hex === chunk.span_id_hex }"
                            :style="`left: ${chunk.style.left}; max-width: ${chunk.style.width}`"
                            @mouseenter="highlightSpanFromChunk(chunk.span)"
                            @mouseleave="unhighlightSpanFromChunk()"
                            @click="handleChunkClick(chunk.span)">
                            <span class="text-[10px] leading-[10px]" x-text="chunk.humanText"></span>
                        </div>
                    </template>
                </div>

                <!-- Waveform -->
                <div id="waveform" class="rounded overflow-hidden border-b border-white/10 h-[81px] mb-1 relative">
                    <div x-show="audioError" x-cloak class="absolute inset-0 flex items-center gap-3 px-4 text-orange-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 shrink-0">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                        </svg>
                        <span x-show="isPolling">Waiting for audio data... (session is live)</span>
                        <span x-show="!isPolling">No audio data available. See the <a href="https://github.com/finchvox/finchvox#troubleshooting" target="_blank" class="text-orange-400 underline hover:text-orange-300 transition-colors">troubleshooting guide</a>.</span>
                    </div>
                </div>

                <!-- Bot text chunks -->
                <div class="relative h-[22px] mb-0 pointer-events-none"
                    x-show="getTurnChunks().length > 0">
                    <template x-for="chunk in getTurnChunks()" :key="chunk.span_id_hex">
                        <div class="absolute h-5 px-1.5 flex items-center bg-white/5 rounded-sm overflow-hidden whitespace-nowrap pointer-events-auto cursor-pointer transition-colors border border-black text-ellipsis text-white/70 hover:bg-[#3a3a3a]"
                            x-show="chunk.botText"
                            :class="{ 'bg-[#3a3a3a]': hoveredSpan?.span_id_hex === chunk.span_id_hex }"
                            :style="`left: ${chunk.style.left}; max-width: ${chunk.style.width}`"
                            @mouseenter="highlightSpanFromChunk(chunk.span)"
                            @mouseleave="unhighlightSpanFromChunk()"
                            @click="handleChunkClick(chunk.span)">
                            <span class="text-[10px] leading-[10px]" x-html="formatBotChunkText(chunk)"></span>
                        </div>
                    </template>
                </div>
            </section>

                <!-- View Tabs -->
                <div class="flex gap-6 px-8 py-2 bg-[#050507]">
                    <button @click="switchView('logs')"
                            class="pb-1 text-sm font-medium transition-colors border-b-2"
                            :class="selectedView === 'logs' ? 'border-amber-500 text-white' : 'border-transparent text-white/50 hover:text-white/70'">
                        Logs
                    </button>
                    <button @click="switchView('conversation')"
                            class="pb-1 text-sm font-medium transition-colors border-b-2"
                            :class="selectedView === 'conversation' ? 'border-amber-500 text-white' : 'border-transparent text-white/50 hover:text-white/70'">
                        Conversation
                    </button>
                    <button @click="switchView('trace')"
                            class="pb-1 text-sm font-medium transition-colors border-b-2"
                            :class="selectedView === 'trace' ? 'border-amber-500 text-white' : 'border-transparent text-white/50 hover:text-white/70'">
                        Trace
                    </button>
                    <button @click="switchView('metrics'); loadMetricsIfNeeded()"
                            class="pb-1 text-sm font-medium transition-colors border-b-2"
                            :class="selectedView === 'metrics' ? 'border-amber-500 text-white' : 'border-transparent text-white/50 hover:text-white/70'">
                        Metrics
                    </button>
                </div>
            </div><!-- End fixed-container -->

    <!-- Trace View -->
    <main x-show="selectedView === 'trace'" class="flex-1 mt-[322px]">
        <div class="overflow-y-hidden overflow-x-visible flex flex-col h-[calc(100vh-362px)]">

            <!-- Swimlane Body (Scrollable) -->
            <div class="flex-1 overflow-y-auto overflow-x-visible space-y-2">
                <template x-for="(spanType, index) in getSpanTypes()" :key="spanType">
                    <div class="flex flex-col gap-1 px-8 py-1" :class="{ 'bg-white/[0.02]': index % 2 === 1 }">
                        <!-- Type Label -->
                        <div class="text-[11px] text-white/50 font-mono uppercase" x-text="spanType"></div>

                        <!-- Timeline Track -->
                        <div class="relative h-5">
                            <template x-for="span in getSpansByType(spanType)" :key="span.span_id_hex">
                                <div class="timeline-bar cursor-pointer"
                                     :class="`bar-${span.name} ${(highlightedSpan?.span_id_hex === span.span_id_hex || selectedSpan?.span_id_hex === span.span_id_hex || chunkHoveredSpan?.span_id_hex === span.span_id_hex) ? 'selected' : ''}`"
                                     :style="`left: ${getTimelineBarStyle(span).left}; width: ${getTimelineBarStyle(span).width}; opacity: ${selectedSpan && selectedSpan.span_id_hex !== span.span_id_hex ? 0.5 : 1}`"
                                     :data-span-id="span.span_id_hex"
                                     @click="selectSpan(span, true)"
                                     @mouseenter="highlightSpan(span)"
                                     @mouseleave="unhighlightSpan()">
                                    <span x-show="!shouldHideLabel(span)" class="text-white/85 text-xs font-mono whitespace-nowrap px-1.5" x-html="formatBarDuration(span)"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

        </div>
    </main>

    <!-- Logs View -->
    <main x-show="selectedView === 'logs'" class="flex-1 mt-[322px]">
        <div class="overflow-y-hidden overflow-x-visible flex flex-col h-[calc(100vh-332px)]">
            <!-- Filter Bar -->
            <div class="flex items-center justify-between px-8 py-2 border-b border-white/10 shrink-0">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-white/40">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                        <input type="text"
                               x-model="logSearchQuery"
                               placeholder="Filter logs..."
                               class="bg-white/5 border border-white/10 rounded pl-9 pr-3 py-1.5 text-xs font-mono text-white placeholder-white/40 focus:outline-none focus:border-white/20 w-64">
                    </div>
                    <span x-show="!logsLoading && logs.length > 0" class="text-white/40 text-xs">Showing <span x-text="getFilteredLogs().length"></span> of <span x-text="logs.length"></span> logs<span x-show="logsTotalCount > logsLimit"> (limited to <span x-text="logsLimit"></span>)</span></span>
                </div>
                <div class="flex gap-1">
                    <template x-for="level in ['DEBUG', 'INFO', 'WARN', 'ERROR']" :key="level">
                        <button @click="toggleLogLevel(level)"
                                class="px-3 py-1.5 text-xs rounded font-mono transition-all duration-200 cursor-pointer"
                                :class="logLevelFilters[level]
                                    ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30'
                                    : 'bg-white/5 text-white/40 border border-white/10 hover:bg-white/10 hover:text-white/60'"
                                x-text="level"></button>
                    </template>
                </div>
            </div>

            <!-- Loading state -->
            <div x-show="logsLoading" class="flex-1 flex items-center justify-center">
                <span class="text-white/40">Loading logs...</span>
            </div>

            <!-- Empty state -->
            <div x-show="!logsLoading && logs.length === 0" class="flex-1 flex items-center justify-center">
                <span class="text-white/40">No logs for this session</span>
            </div>

            <!-- No matches state -->
            <div x-show="!logsLoading && logs.length > 0 && getFilteredLogs().length === 0" class="flex-1 flex items-center justify-center">
                <span class="text-white/40">No logs match the current filters</span>
            </div>

            <!-- Logs table -->
            <div class="flex-1 overflow-y-auto overflow-x-hidden" x-show="!logsLoading && getFilteredLogs().length > 0">
                <table class="w-full table-fixed">
                    <thead class="sticky top-0 bg-[#050507] z-10">
                        <tr class="border-b border-white/10 text-white/40 text-xs font-semibold">
                            <th class="w-28 px-8 py-2 text-left font-semibold">Time</th>
                            <th class="w-20 px-4 py-2 text-left font-semibold">Level</th>
                            <th class="w-48 px-4 py-2 text-left font-semibold">Logger</th>
                            <th class="px-4 py-2 text-left font-semibold">Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(log, index) in getFilteredLogs()" :key="index">
                            <tr class="h-8 cursor-pointer border-l-2 border-transparent transition-colors"
                                :class="{
                                    'bg-[#0f0f0f]': index % 2 === 1 && selectedLog !== log && highlightedLogIndex !== index && !['WARN', 'WARNING', 'ERROR', 'FATAL', 'CRITICAL'].includes(log.severity_text?.toUpperCase()),
                                    'bg-amber-500/10': ['WARN', 'WARNING'].includes(log.severity_text?.toUpperCase()) && selectedLog !== log,
                                    'bg-red-500/10': ['ERROR', 'FATAL', 'CRITICAL'].includes(log.severity_text?.toUpperCase()) && selectedLog !== log,
                                    'hover:bg-amber-500/[0.08]': selectedLog !== log,
                                    'bg-amber-500/[0.15] border-l-amber-500': selectedLog === log || highlightedLogIndex === index
                                }"
                                :data-log-index="index"
                                @click="selectLog(log, index)"
                                @mouseenter="highlightLog(log)"
                                @mouseleave="unhighlightLog()">
                                <td class="px-8 py-2 text-white/60 text-xs truncate font-mono" x-text="formatLogRelativeTime(log.time_unix_nano)"></td>
                                <td class="px-4 py-2 text-xs whitespace-nowrap font-mono" :class="getLogLevelClass(log.severity_text)" x-text="log.severity_text"></td>
                                <td class="px-4 py-2 text-white/70 text-xs truncate font-mono" x-text="log.instrumentation_scope?.name || ''"></td>
                                <td class="px-4 py-2 text-white text-xs truncate font-mono" x-text="getLogBody(log)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

        </div>
    </main>

    <!-- Conversation View -->
    <main x-show="selectedView === 'conversation'" class="flex-1 mt-[322px]">
        <div class="overflow-y-hidden overflow-x-visible flex flex-col h-[calc(100vh-332px)]">
            <!-- Loading state -->
            <div x-show="conversationLoading" class="flex-1 flex items-center justify-center">
                <span class="text-white/40">Loading conversation...</span>
            </div>

            <!-- Error state -->
            <div x-show="!conversationLoading && conversationError" class="flex-1 flex items-center justify-center">
                <span class="text-red-400" x-text="conversationError"></span>
            </div>

            <!-- Empty state -->
            <div x-show="!conversationLoading && !conversationError && conversationMessages.length === 0" class="flex-1 flex items-center justify-center">
                <span class="text-white/40">No conversation messages for this session</span>
            </div>

            <!-- Messages -->
            <div class="flex-1 overflow-y-auto px-8 py-4 space-y-4" x-show="!conversationLoading && !conversationError && conversationMessages.length > 0">
                <template x-for="(message, index) in conversationMessages" :key="index">
                    <div class="flex gap-4 py-3 rounded-lg cursor-pointer transition-colors hover:bg-white/5"
                         @click="seekToMessage(message)"
                         @mouseenter="seekToMessage(message)"
                         @mouseleave="hideConversationMarker()">
                        <!-- Role indicator -->
                        <div class="shrink-0 w-20">
                            <span class="text-xs font-semibold uppercase tracking-wide"
                                  :class="message.role === 'user' ? 'text-[#f97316]' : 'text-[#a855f7]'"
                                  x-text="message.role === 'user' ? 'User' : 'Agent'"></span>
                        </div>
                        <!-- Message content -->
                        <div class="flex-1 min-w-0">
                            <p class="text-white text-sm leading-relaxed whitespace-pre-wrap break-words" x-text="message.content"></p>
                            <!-- Interruption indicator for assistant -->
                            <span x-show="message.role === 'assistant' && message.was_interrupted"
                                  class="inline-flex items-center gap-1 mt-2 text-xs text-amber-400">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3.5 h-3.5">
                                    <path d="M10.5 1.875a1.125 1.125 0 0 1 2.25 0v8.219c.517.162 1.02.382 1.5.659V3.375a1.125 1.125 0 0 1 2.25 0v10.937a4.505 4.505 0 0 0-3.25 2.373 8.963 8.963 0 0 1 4-.935A.75.75 0 0 0 18 15v-2.266a3.368 3.368 0 0 1 .988-2.37 1.125 1.125 0 0 1 1.591 1.59 1.118 1.118 0 0 0-.329.79v3.006h-.005a6 6 0 0 1-1.752 4.007l-1.736 1.736a6 6 0 0 1-4.242 1.757H10.5a7.5 7.5 0 0 1-7.5-7.5V6.375a1.125 1.125 0 0 1 2.25 0v5.519c.46-.452.965-.832 1.5-1.141V3.375a1.125 1.125 0 0 1 2.25 0v6.526c.495-.1.997-.151 1.5-.151V1.875Z"/>
                                </svg>
                                Interrupted
                            </span>
                        </div>
                        <!-- Timestamp -->
                        <div class="shrink-0 text-right">
                            <span class="text-xs text-white/40 font-mono" x-text="formatConversationTime(message.timestamp)"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <!-- Metrics View -->
    <main x-show="selectedView === 'metrics'" class="flex-1 mt-[322px]">
        <div class="overflow-y-auto flex flex-col h-[calc(100vh-332px)] px-8 py-4">
            <!-- Loading state -->
            <div x-show="metricsLoading" class="flex-1 flex items-center justify-center">
                <span class="text-white/40">Loading metrics...</span>
            </div>

            <!-- Error state -->
            <div x-show="!metricsLoading && metricsError" class="flex-1 flex items-center justify-center">
                <span class="text-red-400" x-text="metricsError"></span>
            </div>

            <!-- Empty state -->
            <div x-show="!metricsLoading && !metricsError && (!metricsData || !metricsData.services || metricsData.services.length === 0)" class="flex-1 flex items-center justify-center">
                <span class="text-white/40">No TTFB metrics available for this session</span>
            </div>

            <!-- Charts Grid -->
            <div x-show="!metricsLoading && !metricsError && metricsData && metricsData.services && metricsData.services.length > 0"
                 class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <template x-for="service in metricsData?.services || []" :key="service">
                    <div class="bg-white/[0.02] rounded-lg border border-white/10 p-4">
                        <!-- Header with service name and stats -->
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-mono uppercase"
                                  :class="{
                                      'text-span-stt': service === 'stt',
                                      'text-span-llm': service === 'llm',
                                      'text-span-tts': service === 'tts'
                                  }"
                                  x-text="service.toUpperCase() + ' - TTFB'"></span>
                            <div class="flex gap-4 text-xs text-white/50">
                                <span>AVG <span class="text-white/70 font-mono" x-text="formatStatValue(getMetricsStats(service)?.avg_ms)"></span><span class="font-mono">ms</span></span>
                                <span>p50 <span class="text-white/70 font-mono" x-text="formatStatValue(getMetricsStats(service)?.p50_ms)"></span><span class="font-mono">ms</span></span>
                                <span>p95 <span class="text-white/70 font-mono" x-text="formatStatValue(getMetricsStats(service)?.p95_ms)"></span><span class="font-mono">ms</span></span>
                            </div>
                        </div>
                        <!-- Chart canvas -->
                        <div style="height: 200px;">
                            <canvas :id="`ttfb-chart-${service}`"></canvas>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

        </div><!-- End main-content -->

        <!-- Side Panel (span details) -->
        <aside class="fixed top-12 right-0 bottom-0 w-[400px] bg-[#050507] border-l border-t border-white/10 overflow-y-auto z-[100] shadow-[-4px_0_20px_rgba(0,0,0,0.5)]"
           x-show="isPanelOpen"
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="translate-x-full">
            <div class="flex justify-between items-center py-2 px-8 border-b border-white/10 sticky top-0 z-10 bg-[#050507]">
                <h3 class="text-sm font-semibold tracking-wide uppercase" x-text="selectedSpan?.name">Span Details</h3>
                <button @click="closePanel()" class="bg-transparent border-none text-white/70 text-sm cursor-pointer w-10 h-10 flex items-center justify-center rounded transition-all hover:bg-white/[0.02] hover:text-white" title="ESC">✕</button>
            </div>
            <div class="p-8">
                <div class="grid gap-4 mb-8">
                    <div class="grid grid-cols-[150px_1fr] gap-4">
                        <label class="text-white/40 font-semibold text-xs">Duration:</label>
                        <span class="text-white text-xs" x-text="formatSpanDuration(selectedSpan)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4" x-show="getTTFB(selectedSpan) !== null">
                        <label class="text-white/40 font-semibold text-xs" title="Time to First Byte">TTFB</label>
                        <span class="text-white text-xs" x-text="formatTTFB(selectedSpan)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4" x-show="getUserBotLatency(selectedSpan) !== null">
                        <label class="text-white/40 font-semibold text-xs">User ↔ Bot Latency</label>
                        <span class="text-white text-xs" x-html="formatUserBotLatency(selectedSpan)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4">
                        <label class="text-white/40 font-semibold text-xs">Relative start time</label>
                        <span class="text-white text-xs" x-text="formatRelativeStartTime(selectedSpan)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4">
                        <label class="text-white/40 font-semibold text-xs">Start time</label>
                        <span class="text-white text-xs" x-text="formatTimestamp(selectedSpan?.start_time_unix_nano)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4">
                        <label class="text-white/40 font-semibold text-xs">End time</label>
                        <span class="text-white text-xs" x-text="formatTimestamp(selectedSpan?.end_time_unix_nano)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4" x-show="spanHasToolCalls(selectedSpan)">
                        <label class="text-white/40 font-semibold text-xs">Tool Calls</label>
                        <span class="text-white text-xs" x-text="getToolCallNames(selectedSpan)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4" x-show="wasInterrupted(selectedSpan) !== null">
                        <label class="text-white/40 font-semibold text-xs">Interrupted?</label>
                        <span class="text-white text-xs" x-html="formatInterrupted(selectedSpan)"></span>
                    </div>
                </div>

                <!-- Dedicated attribute displays for specific span types -->

                <!-- LLM Input -->
                <div x-show="selectedSpan?.name === 'llm' && hasAttribute(selectedSpan, 'input')">
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">Input</label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="formatAttributeValue(selectedSpan, 'input')"></pre>
                </div>

                <!-- Tool Calls -->
                <div x-show="selectedSpan?.name === 'llm' && getToolCalls(selectedSpan).length > 0">
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">Tool Calls</label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="formatToolCalls(selectedSpan)"></pre>
                </div>

                <!-- LLM Output -->
                <div x-show="selectedSpan?.name === 'llm' && hasAttribute(selectedSpan, 'output')">
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">Output</label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="formatAttributeValue(selectedSpan, 'output')"></pre>
                </div>

                <!-- TTS Text -->
                <div x-show="selectedSpan?.name === 'tts' && hasAttribute(selectedSpan, 'text')">
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">Text</label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="formatAttributeValue(selectedSpan, 'text')"></pre>
                </div>

                <!-- STT Transcript -->
                <div x-show="selectedSpan?.name === 'stt' && hasAttribute(selectedSpan, 'transcript')">
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">Transcript</label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="formatAttributeValue(selectedSpan, 'transcript')"></pre>
                </div>

                <!-- Turn User Transcript -->
                <div x-show="selectedSpan?.name === 'turn' && getTurnUserTranscript(selectedSpan)">
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">User</label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="getTurnUserTranscript(selectedSpan)"></pre>
                </div>

                <!-- Turn Bot Response -->
                <div x-show="selectedSpan?.name === 'turn' && getTurnBotText(selectedSpan)">
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">Agent</label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="getTurnBotText(selectedSpan)"></pre>
                </div>

                <!-- Raw Span JSON -->
                <div>
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">
                        Raw
                        <button class="flex items-center bg-white/5 text-white/40 border border-white/10 hover:bg-white/10 hover:text-white/60 rounded px-3 py-1.5 text-xs font-mono transition-all duration-200 cursor-pointer ml-4"
                              :class="{ 'text-emerald-500': spanCopied }"
                              @click="copySpanToClipboard()"
                              title="Copy to Clipboard">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
                              </svg>
                        </button>
                    </label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="getRawSpanJSON(selectedSpan)"></pre>
                </div>
            </div>
        </aside>

        <!-- Side Panel (log details) -->
        <aside class="fixed top-12 right-0 bottom-0 w-[400px] bg-[#050507] border-l border-t border-white/10 overflow-y-auto overflow-x-hidden z-[100] shadow-[-4px_0_20px_rgba(0,0,0,0.5)]"
           x-show="isLogPanelOpen"
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="translate-x-full">
            <div class="flex justify-between items-center py-2 px-8 border-b border-white/10 sticky top-0 z-10 bg-[#050507]">
                <h3 class="text-sm font-semibold tracking-wide">Inspect log</h3>
                <div class="flex items-center gap-1">
                    <button x-show="logHasSpan()"
                            @click="jumpToSpanFromLog()"
                            class="flex items-center gap-2 bg-white/5 text-white/40 border border-white/10 hover:bg-white/10 hover:text-white/60 rounded px-3 py-1.5 text-xs font-mono transition-all duration-200 cursor-pointer"
                            title="View in Trace">
                        <span>Trace</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25 21 12m0 0-3.75 3.75M21 12H3" />
                        </svg>
                    </button>
                    <button @click="closeLogPanel()" class="bg-transparent border-none text-white/70 text-sm cursor-pointer w-10 h-10 flex items-center justify-center rounded transition-all hover:bg-white/[0.02] hover:text-white" title="ESC">✕</button>
                </div>
            </div>
            <div class="p-8" x-show="selectedLog">
                <div class="grid gap-4 mb-8">
                    <div class="grid grid-cols-[150px_1fr] gap-4 min-w-0">
                        <label class="text-white/40 font-semibold text-xs">Severity:</label>
                        <span class="text-xs truncate" :class="getLogLevelClass(selectedLog?.severity_text)" x-text="selectedLog?.severity_text"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4 min-w-0">
                        <label class="text-white/40 font-semibold text-xs">Relative start time:</label>
                        <span class="text-white text-xs truncate" x-text="formatLogRelativeTime(selectedLog?.time_unix_nano)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4 min-w-0">
                        <label class="text-white/40 font-semibold text-xs">Timestamp:</label>
                        <span class="text-white text-xs truncate" x-text="formatLogTimestamp(selectedLog?.time_unix_nano)"></span>
                    </div>
                    <div class="grid grid-cols-[150px_1fr] gap-4 min-w-0">
                        <label class="text-white/40 font-semibold text-xs">Logger:</label>
                        <span class="text-white text-xs truncate" x-text="selectedLog?.instrumentation_scope?.name || 'N/A'"></span>
                    </div>
                </div>

                <!-- Message -->
                <div class="mb-6">
                    <label class="text-white/40 font-semibold text-xs mb-2 block">Message</label>
                    <div class="text-emerald-500 text-[13px] bg-[#050507] p-2 border border-white/10 whitespace-pre-wrap break-words font-mono" x-text="getLogBody(selectedLog)"></div>
                </div>

                <!-- Raw JSON -->
                <div>
                    <label class="text-white/40 font-semibold text-xs mb-2 flex justify-between items-center">
                        Raw
                        <button class="flex items-center bg-white/5 text-white/40 border border-white/10 hover:bg-white/10 hover:text-white/60 rounded px-3 py-1.5 text-xs font-mono transition-all duration-200 cursor-pointer ml-4"
                              :class="{ 'text-emerald-500': logCopied }"
                              @click="copyLogToClipboard()"
                              title="Copy to Clipboard">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" />
                              </svg>
                        </button>
                    </label>
                    <pre class="bg-[#050507] p-2 overflow-x-auto font-mono text-[13px] leading-relaxed text-emerald-500 border border-white/10 mb-4 max-h-[300px] overflow-y-auto whitespace-pre-wrap break-words" x-text="getRawLogJSON(selectedLog)"></pre>
                </div>
            </div>
        </aside>

    </div><!-- End page-layout -->

    <script src="/js/time-utils.js"></script>
    <script src="/js/logs_view.js"></script>
    <script src="/js/conversation.js"></script>
    <script src="/js/metrics_view.js"></script>
    <script src="/js/session_detail.js"></script>
</body>
</html>
