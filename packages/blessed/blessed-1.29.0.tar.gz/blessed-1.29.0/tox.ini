[tox]
ignore_basepython_conflict = True
skip_missing_interpreters = True
envlist =
    about
    autopep8
    docformatter
    isort
    pylint
    pylint_tests
    flake8
    flake8_tests
    pydocstyle
    mypy
    sphinx
    py{38,39,310,311,312,313,314}


####### Python Test Environments #######

[testenv]
basepython = python3.14
passenv =
    TEST_QUICK
    TEST_KEYBOARD
    TEST_RAW
setenv =
    TEST_QUICK = {env:TEST_QUICK:1}
deps =
    pytest
    pytest-cov
    pytest-xdist
    pytest-codspeed
commands =
    pytest {posargs: --strict-markers --verbose --durations=3} tests

[testenv:py314]
setenv =
    TEST_QUICK = {env:TEST_QUICK:0}
    TEST_KEYBOARD = {env:TEST_KEYBOARD:1}

####### Linting and Formatting Environments #######

[testenv:autopep8]
deps =
    autopep8
commands =
    autopep8 --in-place  --recursive --aggressive --aggressive blessed/ bin/ tests/

[testenv:docformatter]
# docformatter not yet compatible with py314, https://github.com/PyCQA/docformatter/issues/327
basepython = python3.13
deps =
    docformatter>=1.7.7
    untokenize
commands =
    docformatter \
        --in-place \
        --recursive \
        --pre-summary-newline \
        --wrap-summaries=100 \
        --wrap-descriptions=100 \
        {toxinidir}/blessed/ \
        {toxinidir}/bin \
        {toxinidir}/docs/conf.py

[testenv:docformatter_check]
# docformatter not yet compatible with py314, https://github.com/PyCQA/docformatter/issues/327
basepython = python3.13
deps =
    docformatter>=1.7.7
    untokenize
commands =
    docformatter \
        --check \
        --diff \
        --recursive \
        --pre-summary-newline \
        --wrap-summaries=100 \
        --wrap-descriptions=100 \
        {toxinidir}/blessed/ \
        {toxinidir}/bin \
        {toxinidir}/docs/conf.py

[testenv:flake8]
deps =
    flake8
commands =
    flake8 --exclude=tests,docs/sphinxext/github.py docs/ blessed/ bin/

[testenv:flake8_tests]
deps =
    {[testenv:flake8]deps}
commands =
    flake8 --ignore=W504,F401 tests/

[testenv:isort]
extras = docs
deps =
    {[testenv]deps}
    isort
commands =
    isort blessed


[testenv:isort_check]
deps =
    {[testenv:isort]deps}
commands =
    isort --diff --check-only blessed

[testenv:linkcheck]
extras = docs
commands =
    sphinx-build -v -W -d {toxinidir}/docs/_build/doctrees -b linkcheck docs docs/_build/linkcheck

[testenv:mypy]
deps =
    mypy
commands =
    mypy --config-file=tox.ini --strict --explicit-package-bases blessed

[mypy]
# Our typing information is very poorly done, it was designed by Erik Rose before python
# typing was possible, and was considered "pythonic" at the time, but can't pass mustard
# today, that 'term.any_thing' can be resolved to a termcap, and that terminical
# capability can be used like a string, but also that it can be called, and those calls
# could be strings, or numbers -- it's too much dynamism for quality type checking.

warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
disallow_untyped_defs = true
enable_error_code = ignore-without-code
disable_error_code = name-defined,operator,attr-defined,comparison-overlap,arg-type,no-any-return,has-type,return-value,call-overload,override

[mypy-curses.has_key.*]
ignore_missing_imports = True

[mypy-jinxed.*]
ignore_missing_imports = True

[mypy-wcwidth.*]
ignore_missing_imports = True


[testenv:pydocstyle]
deps =
    pydocstyle
    restructuredtext_lint
    doc8
    pygments
commands =
    pydocstyle --source --explain {toxinidir}/blessed
    rst-lint README.rst
    doc8 --ignore-path docs/_build --ignore D000 docs

[testenv:pylint]
deps =
    pylint
commands =
    pylint {posargs} blessed

[testenv:pylint_tests]
deps =
    {[testenv]deps}
    pylint
commands =
    # Disable test-specific checks here. Global disables are in pyproject.toml
    pylint \
        --disable invalid-name \
        --disable import-outside-toplevel \
        --disable protected-access \
        --disable use-implicit-booleaness-not-comparison-to-string \
        --disable unused-argument \
        {posargs} tests

[testenv:codespell]
deps =
    codespell
commands =
    codespell --skip="MANIFEST.in,*.pyc,htmlcov,_build,build,*.egg-info" \
              --ignore-words .spelling-ignore-words.txt \
              --uri-ignore-words-list '*' \
              --summary --count

[testenv:format]
# docformatter not yet compatible with py314
basepython = python3.13
deps =
    {[testenv:isort]deps}
    {[testenv:docformatter]deps}
    {[testenv:autopep8]deps}
commands =
    {[testenv:isort]commands}
    {[testenv:docformatter]commands}
    {[testenv:autopep8]commands}

[testenv:lint]
# docformatter not yet compatible with py314
basepython = python3.14
deps =
    {[testenv:flake8]deps}
    {[testenv:flake8_tests]deps}
    {[testenv:isort_check]deps}
    {[testenv:mypy]deps}
    {[testenv:pydocstyle]deps}
    {[testenv:pylint]deps}
    {[testenv:pylint_tests]deps}
    {[testenv:codespell]deps}

commands =
    {[testenv:flake8]commands}
    {[testenv:flake8_tests]commands}
    {[testenv:isort_check]commands}
    {[testenv:mypy]commands}
    {[testenv:pydocstyle]commands}
    {[testenv:pylint]commands}
    {[testenv:pylint_tests]commands}
    {[testenv:codespell]commands}


####### Utility Environments #######

[testenv:about]
basepython = {env:TOXPYTHON:{[testenv]basepython}}
commands =
    python -VV
    python {toxinidir}/bin/display-sighandlers.py
    python {toxinidir}/bin/display-terminalinfo.py
    python {toxinidir}/bin/display-fpathconf.py
    python {toxinidir}/bin/display-modes.py
    python {toxinidir}/bin/display-version.py

[testenv:develop]
commands =
    {posargs}

[testenv:publish_static]
# Synchronize the artifacts in docs/_static/ with https://dxtz6bzwq9sxx.cloudfront.net/
deps =
    awscli
commands =
    aws s3 sync --exclude '*.DS_Store*' --delete --acl=public-read docs/_static/ s3://python-blessed/

[testenv:sphinx]
extras = docs
commands =
    sphinx-build {posargs:-v -W -d {toxinidir}/docs/_build/doctrees -b html docs {toxinidir}/docs/_build/html}


####### TOOL CONFIGS #######

[coverage:run]
branch = True
parallel = True
source =
    blessed
omit =
    tests/*
data_file = .coverage.${TOX_ENV_NAME}

[coverage:report]
precision = 1
exclude_lines =
    pragma: no cover

[doc8]
max-line-length = 100

[flake8]
max-line-length = 100
exclude = .tox,build

[isort]
line_length = 100
indent = '    '
multi_line_output = 1
length_sort = 1
import_heading_stdlib = std imports
import_heading_thirdparty = 3rd party
import_heading_firstparty = local
import_heading_localfolder = local
sections=FUTURE,STDLIB,THIRDPARTY,FIRSTPARTY,LOCALFOLDER
no_lines_before=LOCALFOLDER
known_third_party = jinxed
atomic = true

[pydocstyle]
ignore =
    D101,  # Missing docstring in public class
    D105,  # Missing docstring in magic method
    D203,  # 1 blank line required before class docstring
    D204,  # 1 blank line required after class docstring
    D212,  # Multi-line docstring summary should start at the first line
    D401  # First line should be in imperative mood

[pytest]
addopts =
    --color=yes
    --cov
    --cov-append
    --cov-report=xml
    --disable-pytest-warnings
    --ignore=.tox
    --junit-xml=.tox/results.{envname}.xml
# if any test takes over 30 seconds, dump traceback
faulthandler_timeout = 30
filterwarnings = error
junit_family = xunit1
log_format=%(levelname)s %(relativeCreated)2.2f %(filename)s:%(lineno)d %(message)s
norecursedirs = .git .tox build
