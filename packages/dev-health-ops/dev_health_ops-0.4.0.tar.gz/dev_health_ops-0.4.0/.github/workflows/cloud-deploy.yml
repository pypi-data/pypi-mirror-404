name: Deploy cloud services

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Image tag to deploy (matches what docker-images.yml pushed)"
        required: false
        default: "latest"
      image_registry:
        description: "Container registry hosting the artifacts"
        required: false
        default: "ghcr.io/chrisgeo/dev-health-ops"

env:
  CLOUD_RUN_PROJECT: ${{ secrets.CLOUD_RUN_PROJECT }}
  CLOUD_RUN_REGION: ${{ secrets.CLOUD_RUN_REGION }}
  CLOUD_RUN_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}
  DATABASE_URI: ${{ secrets.DATABASE_URI }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_PAGES_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
  CLOUDFLARE_PAGES_BUILD_DIR: ${{ secrets.CLOUDFLARE_PAGES_BUILD_DIR || 'webapp' }}

jobs:
  deploy:
    name: Deploy API + front-end
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
      IMAGE_REGISTRY: ${{ github.event.inputs.image_registry }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
    steps:
      - name: Skip Cloud Run deployment without credentials
        if: ${{ !(env.CLOUD_RUN_PROJECT && env.CLOUD_RUN_REGION && env.CLOUD_RUN_SERVICE && env.GCP_SA_KEY) }}
        run: |
          echo "Cloud Run deploy skipped because GCP configuration/secrets are missing."
          echo "Set CLOUD_RUN_* secrets and GCP_SA_KEY to enable deployments."

      - name: Authenticate to Google Cloud
        if: ${{ env.CLOUD_RUN_PROJECT && env.CLOUD_RUN_REGION && env.CLOUD_RUN_SERVICE && env.GCP_SA_KEY }}
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        if: ${{ env.CLOUD_RUN_PROJECT && env.CLOUD_RUN_REGION && env.CLOUD_RUN_SERVICE && env.GCP_SA_KEY }}
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ env.CLOUD_RUN_PROJECT }}

      - name: Deploy API to Cloud Run
        if: ${{ env.CLOUD_RUN_PROJECT && env.CLOUD_RUN_REGION && env.CLOUD_RUN_SERVICE && env.DATABASE_URI && env.GCP_SA_KEY }}
        run: |
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --image "${{ env.IMAGE_REGISTRY }}/dev-hops-api:${{ env.VERSION }}" \
            --region "${{ env.CLOUD_RUN_REGION }}" \
            --project "${{ env.CLOUD_RUN_PROJECT }}" \
            --allow-unauthenticated \
            --platform managed \
            --set-env-vars DATABASE_URI="${{ env.DATABASE_URI }}"

      - name: Publish Cloudflare Pages
        if: ${{ env.CLOUDFLARE_API_TOKEN && env.CLOUDFLARE_ACCOUNT_ID && env.CLOUDFLARE_PAGES_PROJECT_NAME }}
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ env.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ env.CLOUDFLARE_PAGES_PROJECT_NAME }}
          directory: ${{ env.CLOUDFLARE_PAGES_BUILD_DIR }}
