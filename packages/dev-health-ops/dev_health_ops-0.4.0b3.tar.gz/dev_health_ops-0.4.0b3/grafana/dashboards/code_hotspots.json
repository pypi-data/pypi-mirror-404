{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 0,
  "links": [],
  "panels": [
    {
      "id": 1,
      "title": "Hotspot Explorer",
      "type": "devhealth-ops-panel",
      "datasource": {
        "type": "grafana-clickhouse-datasource",
        "uid": "clickhouse"
      },
      "gridPos": {
        "h": 20,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "targets": [
        {
          "refId": "A",
          "format": 1,
          "rawQuery": true,
          "rawSql": "SELECT metrics.repo_id AS repo_id, metrics.path AS file_path, sum(metrics.churn) AS churn_loc_30d, lookup.cyclomatic_total AS cyclomatic_total, lookup.ownership_concentration AS ownership_concentration, 0 AS incident_count, log1p(churn_loc_30d) AS churn_signal, log1p(coalesce(cyclomatic_total, 0)) AS complexity_signal, coalesce(ownership_concentration, 0) AS ownership_signal, log1p(incident_count) AS incident_signal, (0.5 * churn_signal + 0.3 * complexity_signal + 0.2 * ownership_signal) AS risk_score FROM stats.file_metrics_daily AS metrics INNER JOIN repos AS r ON r.id = metrics.repo_id LEFT JOIN (SELECT repo_id, file_path, argMax(cyclomatic_total, computed_at) AS cyclomatic_total, argMax(blame_concentration, computed_at) AS ownership_concentration FROM stats.file_hotspot_daily GROUP BY repo_id, file_path) AS lookup ON lookup.repo_id = metrics.repo_id AND lookup.file_path = metrics.path WHERE match(r.repo, '${repo_id:regex}') AND metrics.day >= toDate(toDateTime(intDiv($__from, 1000))) AND metrics.day < toDate(toDateTime(intDiv($__to, 1000))) GROUP BY metrics.repo_id, metrics.path, lookup.cyclomatic_total, lookup.ownership_concentration ORDER BY risk_score DESC LIMIT 50"
        },
        {
          "refId": "B",
          "format": 1,
          "rawQuery": true,
          "rawSql": "SELECT metrics.path AS file_path, metrics.day, sum(metrics.churn) AS churn_loc FROM stats.file_metrics_daily AS metrics INNER JOIN repos AS r ON r.id = metrics.repo_id WHERE match(r.repo, '${repo_id:regex}') AND metrics.day >= toDate(toDateTime(intDiv($__from, 1000))) AND metrics.day < toDate(toDateTime(intDiv($__to, 1000))) GROUP BY metrics.path, metrics.day ORDER BY metrics.day, metrics.path"
        }
      ],
      "options": {
        "mode": "hotspotExplorer",
        "hotspotExplorer": {
          "defaultSortByRisk": true
        }
      }
    }
  ],
  "preload": false,
  "refresh": "5m",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": [
      {
        "allValue": ".*",
        "current": {
          "text": "All",
          "value": [
            "$__all"
          ]
        },
        "datasource": {
          "type": "grafana-clickhouse-datasource",
          "uid": "clickhouse"
        },
        "includeAll": true,
        "label": "Repo",
        "multi": true,
        "name": "repo_id",
        "options": [],
        "query": "SELECT repo AS __text, repo AS __value FROM repos ORDER BY repo",
        "refresh": 1,
        "type": "query"
      }
    ]
  },
  "time": {
    "from": "now-30d",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "utc",
  "title": "Code Hotspots",
  "uid": "ghznlq",
  "version": 4
}
