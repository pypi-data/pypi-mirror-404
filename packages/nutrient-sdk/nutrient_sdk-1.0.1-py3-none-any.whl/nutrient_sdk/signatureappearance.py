"""
SignatureAppearance module.
"""

import ctypes
import os
import sys
from typing import Optional, Any, Union
from enum import Enum
from pathlib import Path
from importlib import import_module
from . import sdk_helpers
from . import sdk_loader

sdk_loader.initialize_sdk()
_lib = sdk_loader.get_library_handle()


class SignatureAppearanceError(Exception):
    """Exception raised by SignatureAppearance operations."""
    pass

class ErrorInfo(ctypes.Structure):
    """Structure to hold error information from native code."""
    _fields_ = [
        ("code", ctypes.c_int),
        ("message", ctypes.c_char * 1024),
        ("source", ctypes.c_char * 256)
    ]

_lib.BridgeSignatureAppearanceInitNSDKH.restype = ctypes.c_void_p
_lib.BridgeSignatureAppearanceInitNSDKH.argtypes = []

_lib.BridgeSignatureAppearanceCloseNSDKH.restype = None
_lib.BridgeSignatureAppearanceCloseNSDKH.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceGetLastErrorCode.restype = ctypes.c_int
_lib.BridgeSignatureAppearanceGetLastErrorCode.argtypes = []

_lib.BridgeSignatureAppearanceGetLastErrorMessage.restype = ctypes.c_void_p
_lib.BridgeSignatureAppearanceGetLastErrorMessage.argtypes = []

_lib.BridgeSignatureAppearanceFreeErrorString.restype = None
_lib.BridgeSignatureAppearanceFreeErrorString.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceGetUseAutoGeneratedText.restype = ctypes.c_bool
_lib.BridgeSignatureAppearanceGetUseAutoGeneratedText.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceSetUseAutoGeneratedTextBoolean.restype = None
_lib.BridgeSignatureAppearanceSetUseAutoGeneratedTextBoolean.argtypes = [ctypes.c_void_p, ctypes.c_bool]

_lib.BridgeSignatureAppearanceGetText.restype = ctypes.c_void_p
_lib.BridgeSignatureAppearanceGetText.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceSetTextString.restype = None
_lib.BridgeSignatureAppearanceSetTextString.argtypes = [ctypes.c_void_p, ctypes.c_void_p]

_lib.BridgeSignatureAppearanceGetFontName.restype = ctypes.c_void_p
_lib.BridgeSignatureAppearanceGetFontName.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceSetFontNameString.restype = None
_lib.BridgeSignatureAppearanceSetFontNameString.argtypes = [ctypes.c_void_p, ctypes.c_void_p]

_lib.BridgeSignatureAppearanceGetFontSize.restype = ctypes.c_float
_lib.BridgeSignatureAppearanceGetFontSize.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceSetFontSizeSingle.restype = None
_lib.BridgeSignatureAppearanceSetFontSizeSingle.argtypes = [ctypes.c_void_p, ctypes.c_float]

_lib.BridgeSignatureAppearanceGetTextColor.restype = ctypes.c_void_p
_lib.BridgeSignatureAppearanceGetTextColor.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceSetTextColorColor.restype = None
_lib.BridgeSignatureAppearanceSetTextColorColor.argtypes = [ctypes.c_void_p, ctypes.c_void_p]

_lib.BridgeSignatureAppearanceGetImagePath.restype = ctypes.c_void_p
_lib.BridgeSignatureAppearanceGetImagePath.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceSetImagePathString.restype = None
_lib.BridgeSignatureAppearanceSetImagePathString.argtypes = [ctypes.c_void_p, ctypes.c_void_p]

_lib.BridgeSignatureAppearanceGetShowValidationMark.restype = ctypes.c_bool
_lib.BridgeSignatureAppearanceGetShowValidationMark.argtypes = [ctypes.c_void_p]

_lib.BridgeSignatureAppearanceSetShowValidationMarkBoolean.restype = None
_lib.BridgeSignatureAppearanceSetShowValidationMarkBoolean.argtypes = [ctypes.c_void_p, ctypes.c_bool]


class SignatureAppearance:
    """
    Defines the visual appearance of a signature in a PDF document. Used for both digital signatures (with certificate) and electronic signatures (visual only).
    """

    def __init__(self):
        """Initialize a new SignatureAppearance instance."""
        self._handle = _lib.BridgeSignatureAppearanceInitNSDKH()
        if not self._handle:
            self._check_error()
        self._closed = False

    def __del__(self):
        self.close()

    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        self.close()
        return False

    def close(self):
        """Close and cleanup the native resources."""
        if not self._closed and self._handle:
            _lib.BridgeSignatureAppearanceCloseNSDKH(self._handle)
            self._handle = None
            self._closed = True

    def _check_error(self):
        error_code = _lib.BridgeSignatureAppearanceGetLastErrorCode()
        if error_code != 0:
            message_ptr = _lib.BridgeSignatureAppearanceGetLastErrorMessage()
            if message_ptr:
                message = ctypes.string_at(message_ptr).decode('utf-8')
                _lib.BridgeSignatureAppearanceFreeErrorString(message_ptr)
            else:
                message = "Unknown error"
            raise SignatureAppearanceError(f"SignatureAppearance: {message} (code: {error_code})")
    
    def _ensure_not_closed(self):
        if self._closed:
            raise ValueError("SignatureAppearance instance has been closed")

    @classmethod
    def _from_handle(cls, handle):
        if not handle:
            return None  # Null handle means object not found or null return
        instance = cls.__new__(cls)
        instance._handle = handle
        instance._closed = False
        return instance

    def get_use_auto_generated_text(self) -> bool:
        """
        Gets when true, automatically generates text from signature metadata (signer name, reason, location, date). This is the default behavior when no custom text or image is provided.

        Returns:
            bool: The value of the UseAutoGeneratedText property.

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        result = _lib.BridgeSignatureAppearanceGetUseAutoGeneratedText(self._handle)
        self._check_error()
        return result

    def set_use_auto_generated_text(self, value: bool) -> None:
        """
        Sets when true, automatically generates text from signature metadata (signer name, reason, location, date). This is the default behavior when no custom text or image is provided.

        Args:
            value (bool)

        Returns:
            None: The result of the operation

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        _lib.BridgeSignatureAppearanceSetUseAutoGeneratedTextBoolean(self._handle, value)
        self._check_error()

    def get_text(self) -> str:
        """
        Gets custom text to display in the signature appearance. When set, this overrides .

        Returns:
            str: The value of the Text property.

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        result = _lib.BridgeSignatureAppearanceGetText(self._handle)
        self._check_error()
        return sdk_loader.convert_string_handle(result)

    def set_text(self, value: str) -> None:
        """
        Sets custom text to display in the signature appearance. When set, this overrides .

        Args:
            value (str)

        Returns:
            None: The result of the operation

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        _lib.BridgeSignatureAppearanceSetTextString(self._handle, value.encode('utf-8') if value else None)
        self._check_error()

    def get_font_name(self) -> str:
        """
        Gets the name of the font to use for text in the signature appearance.

        Returns:
            str: The value of the FontName property.

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        result = _lib.BridgeSignatureAppearanceGetFontName(self._handle)
        self._check_error()
        return sdk_loader.convert_string_handle(result)

    def set_font_name(self, value: str) -> None:
        """
        Sets the name of the font to use for text in the signature appearance.

        Args:
            value (str)

        Returns:
            None: The result of the operation

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        _lib.BridgeSignatureAppearanceSetFontNameString(self._handle, value.encode('utf-8') if value else None)
        self._check_error()

    def get_font_size(self) -> float:
        """
        Gets the font size in points for text in the signature appearance.

        Returns:
            float: The value of the FontSize property.

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        result = _lib.BridgeSignatureAppearanceGetFontSize(self._handle)
        self._check_error()
        return result

    def set_font_size(self, value: float) -> None:
        """
        Sets the font size in points for text in the signature appearance.

        Args:
            value (float)

        Returns:
            None: The result of the operation

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        _lib.BridgeSignatureAppearanceSetFontSizeSingle(self._handle, value)
        self._check_error()

    def get_text_color(self) -> 'Color':
        """
        Gets the color of the text in the signature appearance.

        Returns:
            'Color': The value of the TextColor property.

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        result = _lib.BridgeSignatureAppearanceGetTextColor(self._handle)
        self._check_error()
        return import_module('.color', package=__package__).Color._from_handle(result)

    def set_text_color(self, value: 'Color') -> None:
        """
        Sets the color of the text in the signature appearance.

        Args:
            value ('Color')

        Returns:
            None: The result of the operation

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        _lib.BridgeSignatureAppearanceSetTextColorColor(self._handle, value._handle if value else None)
        self._check_error()

    def get_image_path(self) -> str:
        """
        Gets the file path to an image to display in the signature appearance.

        Returns:
            str: The value of the ImagePath property.

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        result = _lib.BridgeSignatureAppearanceGetImagePath(self._handle)
        self._check_error()
        return sdk_loader.convert_string_handle(result)

    def set_image_path(self, value: str) -> None:
        """
        Sets the file path to an image to display in the signature appearance.

        Args:
            value (str)

        Returns:
            None: The result of the operation

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        _lib.BridgeSignatureAppearanceSetImagePathString(self._handle, value.encode('utf-8') if value else None)
        self._check_error()

    def get_show_validation_mark(self) -> bool:
        """
        Gets when true, displays a validation mark icon in the signature appearance. Only applicable for digital signatures (with certificate).

        Returns:
            bool: The value of the ShowValidationMark property.

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        result = _lib.BridgeSignatureAppearanceGetShowValidationMark(self._handle)
        self._check_error()
        return result

    def set_show_validation_mark(self, value: bool) -> None:
        """
        Sets when true, displays a validation mark icon in the signature appearance. Only applicable for digital signatures (with certificate).

        Args:
            value (bool)

        Returns:
            None: The result of the operation

        Raises:
            SignatureAppearanceError: If the operation fails
        """
        self._ensure_not_closed()

        _lib.BridgeSignatureAppearanceSetShowValidationMarkBoolean(self._handle, value)
        self._check_error()

    @property
    def use_auto_generated_text(self) -> bool:
        """
        Gets when true, automatically generates text from signature metadata (signer name, reason, location, date). This is the default behavior when no custom text or image is provided.

        Returns:
            bool: The value of the UseAutoGeneratedText property.
        """
        return self.get_use_auto_generated_text()

    @use_auto_generated_text.setter
    def use_auto_generated_text(self, value: bool) -> None:
        """
        Sets the use auto generated text.

        Args:
            value (bool): The value to set.
        """
        self.set_use_auto_generated_text(value)

    @property
    def text(self) -> str:
        """
        Gets custom text to display in the signature appearance. When set, this overrides .

        Returns:
            str: The value of the Text property.
        """
        return self.get_text()

    @text.setter
    def text(self, value: str) -> None:
        """
        Sets the text.

        Args:
            value (str): The value to set.
        """
        self.set_text(value)

    @property
    def font_name(self) -> str:
        """
        Gets the name of the font to use for text in the signature appearance.

        Returns:
            str: The value of the FontName property.
        """
        return self.get_font_name()

    @font_name.setter
    def font_name(self, value: str) -> None:
        """
        Sets the font name.

        Args:
            value (str): The value to set.
        """
        self.set_font_name(value)

    @property
    def font_size(self) -> float:
        """
        Gets the font size in points for text in the signature appearance.

        Returns:
            float: The value of the FontSize property.
        """
        return self.get_font_size()

    @font_size.setter
    def font_size(self, value: float) -> None:
        """
        Sets the font size.

        Args:
            value (float): The value to set.
        """
        self.set_font_size(value)

    @property
    def text_color(self) -> 'Color':
        """
        Gets the color of the text in the signature appearance.

        Returns:
            'Color': The value of the TextColor property.
        """
        return self.get_text_color()

    @text_color.setter
    def text_color(self, value: 'Color') -> None:
        """
        Sets the text color.

        Args:
            value ('Color'): The value to set.
        """
        self.set_text_color(value)

    @property
    def image_path(self) -> str:
        """
        Gets the file path to an image to display in the signature appearance.

        Returns:
            str: The value of the ImagePath property.
        """
        return self.get_image_path()

    @image_path.setter
    def image_path(self, value: str) -> None:
        """
        Sets the image path.

        Args:
            value (str): The value to set.
        """
        self.set_image_path(value)

    @property
    def show_validation_mark(self) -> bool:
        """
        Gets when true, displays a validation mark icon in the signature appearance. Only applicable for digital signatures (with certificate).

        Returns:
            bool: The value of the ShowValidationMark property.
        """
        return self.get_show_validation_mark()

    @show_validation_mark.setter
    def show_validation_mark(self, value: bool) -> None:
        """
        Sets the show validation mark.

        Args:
            value (bool): The value to set.
        """
        self.set_show_validation_mark(value)


