# Использование

## Настройка

Создание или изменение личных данных и настроек доступа к IBKR.

```bash
ibkr-porez config
```

Вам будет предложено ввести:

*   **IBKR Flex Token**: [Получение токена](ibkr.md/#flex-web-service)
*   **IBKR Query ID**: [Создание Flex Query](ibkr.md/#flex-query)
*   **Personal ID**: JMBG / EBS
*   **Full Name**: Имя и Фамилия
*   **Address**: Адрес регистрации
*   **City Code**: 3-значный код муниципалитета. Пример: `223` (Нови Сад). Код можно найти в [справочнике](https://www.apml.gov.rs/uploads/useruploads/Documents/1533_1_pravilnik-javni_prihodi_prilog-3.pdf) (смотрите колонку "Шифра"). Также код доступен в выпадающем списке на портале ePorezi.
*   **Phone**: Телефон
*   **Email**: Email

## Получение данных (`get`)

Загружает последние данные из IBKR и синхронизирует курсы валют с НБС (Национальный банк Сербии).

Сохраняет их в локальное хранилище.

```bash
ibkr-porez get
```

## Импорт исторических данных (`import`)

Загрузка истории транзакций старше 365 дней, которые невозможно получить через Flex Query (`get`).

1.  Скачайте CSV: [Экспорт всей истории](ibkr.md/#import)
2.  Импортируйте файл:

```bash
ibkr-porez import /path/to/activity_statement.csv
```

> ⚠️ Не забудьте после `import` выполнить `get` чтобы приложение добавило максимум деталей хотя бы в последний год
> в менее подробные данные загруженные из CSV.

### Логика синхронизации (`import` + `get`)
При загрузке данных из CSV (`import`) и Flex Query (`get`) система отдает приоритет более полным данным Flex Query:

*   Данные Flex Query (`get`) являются источником правды. Они перезаписывают данные CSV за любые совпадающие даты.
*   Если запись Flex Query совпадает с CSV по смыслу (Дата, Тикер, Цена, Количество), это считается обновлением (заменой на официальный ID).
*   Если структура данных отличается (например, сплит ордеров в Flex Query против "склеенной" записи в CSV), старая запись CSV удаляется, а новые записи Flex Query добавляются.
*   Полностью идентичные записи пропускаются.

## Просмотр статистики (`show`)

```bash
ibkr-porez show
```

Показывает:

*   Полученные дивиденды (в RSD).
*   Количество продаж (налогооблагаемых событий).
*   Оценку реализованного P/L (Капитальный доход) (в RSD).

## Генерация налогового отчета Капитальный доход (`report`)

```bash
# Отчет за последнее полное полугодие
ibkr-porez report

# Отчет за второе полугодие 2025 (1 июл - 31 дек)
ibkr-porez report --year 2025 --half 2
```

* **Результат**: `ppdg3r_2025_H1.xml`
* Импортируйте этот файл на портал Налоговой администрации Сербии (ePorezi)
* Вручную загрузите в пункт 8 файл с [Документ подтверждения](ibkr.md#_1)
