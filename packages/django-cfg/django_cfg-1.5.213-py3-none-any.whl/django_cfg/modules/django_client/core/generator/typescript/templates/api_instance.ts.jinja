{% include '_header.jinja' %}

/**
 * Global API Instance - Singleton configuration with auto-configuration support
 *
 * This module provides a global API instance that auto-configures from
 * environment variables or can be configured manually.
 *
 * AUTO-CONFIGURATION (recommended):
 * Set one of these environment variables and the API will auto-configure:
 * - NEXT_PUBLIC_API_URL (Next.js)
 * - VITE_API_URL (Vite)
 * - REACT_APP_API_URL (Create React App)
 * - API_URL (generic)
 *
 * Then just use fetchers and hooks directly:
 * ```typescript
 * import { getUsers } from './_utils/fetchers'
 * const users = await getUsers({ page: 1 })
 * ```
 *
 * MANUAL CONFIGURATION:
 * ```typescript
 * import { configureAPI } from './api-instance'
 *
 * configureAPI({
 *   baseUrl: 'https://api.example.com',
 *   token: 'your-jwt-token'
 * })
 * ```
 *
 * For SSR or multiple instances:
 * ```typescript
 * import { API } from './index'
 * import { getUsers } from './_utils/fetchers'
 *
 * const api = new API('https://api.example.com')
 * const users = await getUsers({ page: 1 }, api)
 * ```
 */

import { API, type APIOptions } from './index'

let globalAPI: API | null = null
let autoConfigAttempted = false

/**
 * Auto-configure from environment variable if available (Next.js pattern)
 * This allows hooks and fetchers to work without explicit configureAPI() call
 *
 * Supported environment variables:
 * - NEXT_PUBLIC_API_URL (Next.js)
 * - VITE_API_URL (Vite)
 * - REACT_APP_API_URL (Create React App)
 * - API_URL (generic)
 */
function tryAutoConfigureFromEnv(): void {
  // Only attempt once
  if (autoConfigAttempted) return
  autoConfigAttempted = true

  // Skip if already configured
  if (globalAPI) return

  // Skip if process is not available (pure browser without bundler)
  if (typeof process === 'undefined' || !process.env) return

  // Try different environment variable patterns
  const baseUrl =
    process.env.NEXT_PUBLIC_API_URL ||
    process.env.VITE_API_URL ||
    process.env.REACT_APP_API_URL ||
    process.env.API_URL

  if (baseUrl) {
    globalAPI = new API(baseUrl)
  }
}

/**
 * Get the global API instance
 * Auto-configures from environment variables on first call if not manually configured.
 * @throws Error if API is not configured and no env variable is set
 */
export function getAPIInstance(): API {
  // Try auto-configuration on first access (lazy initialization)
  tryAutoConfigureFromEnv()

  if (!globalAPI) {
    throw new Error(
      'API not configured. Call configureAPI() with your base URL before using fetchers or hooks.\n\n' +
      'Example:\n' +
      '  import { configureAPI } from "./api-instance"\n' +
      '  configureAPI({ baseUrl: "https://api.example.com" })\n\n' +
      'Or set environment variable: NEXT_PUBLIC_API_URL, VITE_API_URL, or REACT_APP_API_URL'
    )
  }
  return globalAPI
}

/**
 * Check if API is configured (or can be auto-configured)
 */
export function isAPIConfigured(): boolean {
  tryAutoConfigureFromEnv()
  return globalAPI !== null
}

/**
 * Configure the global API instance
 *
 * @param baseUrl - Base URL for the API
 * @param options - Optional configuration (storage, retry, logger)
 *
 * @example
 * ```typescript
 * configureAPI({
 *   baseUrl: 'https://api.example.com',
 *   token: 'jwt-token',
 *   options: {
 *     retryConfig: { maxRetries: 3 },
 *     loggerConfig: { enabled: true }
 *   }
 * })
 * ```
 */
export function configureAPI(config: {
  baseUrl: string
  token?: string
  refreshToken?: string
  options?: APIOptions
}): API {
  globalAPI = new API(config.baseUrl, config.options)

  if (config.token) {
    globalAPI.setToken(config.token, config.refreshToken)
  }

  return globalAPI
}

/**
 * Reconfigure the global API instance with new settings
 * Useful for updating tokens or base URL
 */
export function reconfigureAPI(updates: {
  baseUrl?: string
  token?: string
  refreshToken?: string
}): API {
  const instance = getAPIInstance()

  if (updates.baseUrl) {
    instance.setBaseUrl(updates.baseUrl)
  }

  if (updates.token) {
    instance.setToken(updates.token, updates.refreshToken)
  }

  return instance
}

/**
 * Clear tokens from the global API instance
 */
export function clearAPITokens(): void {
  const instance = getAPIInstance()
  instance.clearTokens()
}

/**
 * Reset the global API instance
 * Useful for testing or logout scenarios
 */
export function resetAPI(): void {
  if (globalAPI) {
    globalAPI.clearTokens()
  }
  globalAPI = null
}
