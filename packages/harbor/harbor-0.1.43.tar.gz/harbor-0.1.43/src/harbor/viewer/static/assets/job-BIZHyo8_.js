import{x as we,B as De,v as Te,b as l,t as e,A as Fe}from"./index-CYR-HZan.js";import{d as X,u as A,B as Pe,a as Me,b as Z,q as Ee,r as Ke,e as Ae,f as $,g as Be,t as Ie,L as Re,v as Le,w as qe,x as Oe,y as Ve}from"./api-BgrBwReI.js";import{u as re,t as f,l as $e}from"./index-JVv6katd.js";import{u as te,X as ze,E as Ue,a as Je,b as Qe,c as Ge,d as He}from"./empty-TlmgxYvO.js";import{u as j,a as v,p as w,T as We,I as ne,S as Xe,C as D}from"./input-BPzPo60M.js";import{C as Ze,B as Ye}from"./code-block-CUSGUC3x.js";import{u as es,a as ss,D as as,P as rs,b as ts,d as m,e as ns,f as T,g as Y,h as ls,S as c,C as os}from"./hooks-BI573EzM.js";import{T as is,a as cs,b as ee,c as se,F as ds,D as us,d as ms,e as hs,f as xs,g as gs,h as ps,L as q,S as js,i as vs,j as bs,k as fs,l as O}from"./tabs-DnzvJY73.js";import{K as N}from"./kbd-CNHFVw7L.js";import"./mutation--h5hHClj.js";import"./index-DvJT0nJi.js";import"./compare-Br3z3FUS-D09VrqaM.js";import"./scroll-area-Bnf4hdko.js";function ys({value:s}){const a=async()=>{await navigator.clipboard.writeText(s),f("Copied to clipboard",{description:s})};return e.jsx("span",{onClick:a,className:"cursor-default hover:text-foreground transition-colors",children:s})}function Ns({jobName:s}){const a=re(),[t,i]=l.useState(!1),[h,b]=l.useState("haiku"),[n,d]=l.useState(32),[y,F]=l.useState(!0),u=te({mutationFn:()=>Ie(s,h,n,y),onSuccess:o=>{a.invalidateQueries({queryKey:["job-summary",s]}),i(!1),o.n_trials_summarized>0&&o.job_summary_created?f.success(`Summarized ${o.n_trials_summarized} trial${o.n_trials_summarized===1?"":"s"}`):o.job_summary_created?f.success("Job summary updated"):f.info("No trials to summarize")},onError:o=>{f.error("Failed to generate summary",{description:o.message})}});return e.jsxs(us,{open:t,onOpenChange:i,children:[e.jsx(ms,{asChild:!0,children:e.jsx($,{children:"Generate Summary"})}),e.jsxs(hs,{children:[e.jsxs(xs,{children:[e.jsx(gs,{children:"Generate Summary"}),e.jsx(ps,{children:"Use Claude to analyze all failing trials and generate a summary. This can take a couple minutes."})]}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"model",children:"Model"}),e.jsxs(js,{value:h,onValueChange:b,children:[e.jsx(vs,{id:"model",children:e.jsx(bs,{})}),e.jsxs(fs,{children:[e.jsx(O,{value:"haiku",children:"Haiku (Recommended)"}),e.jsx(O,{value:"sonnet",children:"Sonnet"}),e.jsx(O,{value:"opus",children:"Opus"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"n-concurrent",children:"Concurrent Claude Codes"}),e.jsx(ne,{id:"n-concurrent",type:"number",min:1,max:100,value:n,onChange:o=>d(parseInt(o.target.value)||1)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{id:"only-failed",checked:y,onCheckedChange:o=>F(o===!0)}),e.jsx(q,{htmlFor:"only-failed",className:"font-normal",children:"Only analyze failed trials"})]}),e.jsx($,{className:"w-full",onClick:()=>u.mutate(),disabled:u.isPending,children:u.isPending?e.jsx(Re,{text:"Generating"}):"Generate"})]})]})]})}function Cs(s){const a=Math.floor(s/1e3),t=Math.floor(a/60),i=Math.floor(t/60);return i>0?`${i}h ${t%60}m`:t>0?`${t}m ${a%60}s`:`${a}s`}function _s({reward:s}){const a=Math.max(0,Math.min(1,s)),t=Math.round(a*100);return e.jsx(Ye,{variant:"outline",className:"tabular-nums border-transparent rounded-none",style:{backgroundColor:`color-mix(in oklab, var(--foreground) ${t}%, transparent)`,color:a>.5?"var(--background)":void 0},children:s.toFixed(2)})}function ae(s,a){const t=s.source||"_",i=s.agent_name||"_",h=s.model_provider||"_",b=s.model_name||"_";return`/jobs/${encodeURIComponent(a)}/tasks/${encodeURIComponent(t)}/${encodeURIComponent(i)}/${encodeURIComponent(h)}/${encodeURIComponent(b)}/${encodeURIComponent(s.task_name)}`}const ks=[{accessorKey:"task_name",header:({column:s})=>e.jsx(c,{column:s,children:"Task"})},{accessorKey:"agent_name",header:({column:s})=>e.jsx(c,{column:s,children:"Agent"}),cell:({row:s})=>s.original.agent_name||"-"},{accessorKey:"model_provider",header:({column:s})=>e.jsx(c,{column:s,children:"Provider"}),cell:({row:s})=>s.original.model_provider||"-"},{accessorKey:"model_name",header:({column:s})=>e.jsx(c,{column:s,children:"Model"}),cell:({row:s})=>s.original.model_name||"-"},{accessorKey:"source",header:({column:s})=>e.jsx(c,{column:s,children:"Dataset"}),cell:({row:s})=>s.original.source||"-"},{accessorKey:"n_trials",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Trials"})}),cell:({row:s})=>{const{n_trials:a,n_completed:t}=s.original;return t<a?e.jsxs("div",{className:"text-right",children:[t,"/",a]}):e.jsx("div",{className:"text-right",children:a})}},{accessorKey:"n_errors",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Errors"})}),cell:({row:s})=>{const a=s.original.n_errors;return e.jsx("div",{className:"text-right",children:a})}},{accessorKey:"avg_duration_ms",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Avg Duration"})}),cell:({row:s})=>{const a=s.original.avg_duration_ms;return a===null?e.jsx("div",{className:"text-right text-muted-foreground",children:"-"}):e.jsx("div",{className:"text-right",children:Cs(a)})}},{accessorKey:"exception_types",header:({column:s})=>e.jsx(c,{column:s,children:"Exceptions"}),sortingFn:(s,a)=>{const t=s.original.exception_types[0]??"",i=a.original.exception_types[0]??"";return t.localeCompare(i)},cell:({row:s})=>{const a=s.original.exception_types;return a.length===0?e.jsx("span",{className:"text-muted-foreground",children:"-"}):a.length===1?e.jsx("span",{className:"text-sm",children:a[0]}):e.jsxs("span",{className:"text-sm",children:[a[0]," ",e.jsxs("span",{className:"text-muted-foreground",children:["+",a.length-1," more"]})]})}},{accessorKey:"avg_reward",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Avg Reward"})}),cell:({row:s})=>{const a=s.original.avg_reward;return a===null?e.jsx("div",{className:"text-right text-muted-foreground",children:"-"}):e.jsx("div",{className:"text-right",children:e.jsx(_s,{reward:a})})}}],V=100,Ls=we(function(){const{jobName:a}=De(),t=Te(),i=re(),[h,b]=l.useState(!1),[n,d]=l.useState(1),[y,F]=j("q",v.withDefault("")),[u,o]=j("agent",w(v).withDefault([])),[C,le]=j("provider",w(v).withDefault([])),[_,oe]=j("model",w(v).withDefault([])),[k,ie]=j("task",w(v).withDefault([])),[P,ce]=j("hide",w(v).withDefault([])),[S,z]=j("sort_by",v),[M,U]=j("sort_order",v.withDefault("asc")),J=l.useRef(null),de=S?[{id:S,desc:M==="desc"}]:[],ue=r=>{r.length===0?(z(null),U(null)):(z(r[0].id),U(r[0].desc?"desc":"asc"))},E=l.useMemo(()=>[{value:"task_name",label:"Task"},{value:"agent_name",label:"Agent"},{value:"model_provider",label:"Provider"},{value:"model_name",label:"Model"},{value:"source",label:"Dataset"},{value:"n_trials",label:"Trials"},{value:"n_errors",label:"Errors"},{value:"avg_duration_ms",label:"Avg Duration"},{value:"exception_types",label:"Exceptions"},{value:"avg_reward",label:"Avg Reward"}],[]),me=l.useMemo(()=>{const r={};for(const K of P)r[K]=!1;return r},[P]),he=l.useMemo(()=>E.filter(r=>!P.includes(r.value)).map(r=>r.value),[E,P]),xe=r=>{const K=E.filter(L=>!r.includes(L.value)).map(L=>L.value);ce(K.length>0?K:null)};X("mod+k",r=>{r.preventDefault(),J.current?.focus()},{enableOnFormTags:!0});const B=es(y,300);l.useEffect(()=>{d(1)},[B,u,C,_,k,S,M]);const{data:x,isLoading:ge}=A({queryKey:["job",a],queryFn:()=>Le(a),enabled:!!a}),{data:g}=A({queryKey:["task-filters",a],queryFn:()=>qe(a),enabled:!!a,staleTime:6e4}),pe=l.useMemo(()=>(g?.agents??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[g?.agents]),je=l.useMemo(()=>(g?.providers??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[g?.providers]),ve=l.useMemo(()=>(g?.models??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[g?.models]),be=l.useMemo(()=>(g?.tasks??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[g?.tasks]),{data:I,isLoading:fe}=A({queryKey:["tasks",a,n,B,u,C,_,k,S,M],queryFn:()=>Oe(a,n,V,{search:B||void 0,agents:u.length>0?u:void 0,providers:C.length>0?C:void 0,models:_.length>0?_:void 0,tasks:k.length>0?k:void 0,sortBy:S||void 0,sortOrder:M}),enabled:!!a,placeholderData:$e}),Q=I?.items??[],p=I?.total_pages??0,G=I?.total??0,[R,ye]=l.useState("results");X("escape",()=>t("/"),{enabled:R!=="results"});const{highlightedIndex:Ne}=ss({rows:Q,onNavigate:r=>t(ae(r,a)),onEscapeUnhighlighted:()=>t("/"),enabled:R==="results"}),{data:H}=A({queryKey:["job-summary",a],queryFn:()=>Ve(a),enabled:!!a}),W=te({mutationFn:()=>Be(a),onSuccess:()=>{i.invalidateQueries({queryKey:["jobs"]}),f("Job deleted",{description:a}),t("/")},onError:r=>{f.error("Failed to delete job",{description:r.message}),b(!1)}}),Ce=()=>{h?W.mutate():b(!0)};if(!ge&&!x)return e.jsx("div",{className:"container mx-auto py-10",children:e.jsx("div",{className:"text-destructive",children:"Failed to load job"})});const _e=x?.stats.n_trials??0,ke=x?.n_total_trials??0,Se=x?.stats.n_errors??0;return e.jsxs("div",{className:"container mx-auto py-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx(Pe,{className:"mb-4",children:e.jsxs(Me,{children:[e.jsx(Z,{children:e.jsx(Ee,{asChild:!0,children:e.jsx(Fe,{to:"/",children:"Jobs"})})}),e.jsx(Ke,{}),e.jsx(Z,{children:e.jsx(Ae,{children:a})})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-4xl font-medium",children:a}),e.jsxs($,{variant:h?"destructive":"secondary",onClick:Ce,onBlur:()=>b(!1),disabled:W.isPending,children:[e.jsx(We,{className:"h-4 w-4"}),h?"Confirm delete":"Delete"]})]}),e.jsxs("div",{className:"flex gap-2 text-sm text-muted-foreground mt-2",children:[e.jsxs("span",{children:[_e,"/",ke," trials completed"]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsxs("span",{children:[Se," errors"]})]}),x?.job_uri&&e.jsx("div",{className:"text-xs text-muted-foreground mt-3",children:e.jsx(ys,{value:x.job_uri.startsWith("file://")?x.job_uri.slice(7):x.job_uri})})]}),e.jsxs(is,{value:R,onValueChange:ye,className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between bg-card border border-b-0",children:[e.jsxs(cs,{className:"border-0",children:[e.jsx(ee,{value:"results",children:"Results"}),e.jsx(ee,{value:"summary",children:"Summary"})]}),e.jsxs("div",{className:"flex items-center gap-3 px-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{children:"j"}),e.jsx(N,{children:"k"}),e.jsx("span",{children:"to navigate"})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{children:"Enter"}),e.jsx("span",{children:"to open"})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(N,{children:"Esc"}),e.jsx("span",{children:"to deselect"})]})]})]}),e.jsxs(se,{value:"results",children:[e.jsxs("div",{className:"grid grid-cols-7 -mb-px",children:[e.jsxs("div",{className:"col-span-2 relative",children:[e.jsx(ne,{ref:J,placeholder:"Search for tasks...",value:y,onChange:r=>F(r.target.value||null),size:"lg",variant:"card",className:"peer pl-9 pr-16 shadow-none"}),e.jsx(Xe,{className:"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-border transition-colors peer-focus-visible:text-ring"}),y?e.jsx("button",{type:"button",onClick:()=>F(null),className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors",children:e.jsx(ze,{className:"h-4 w-4"})}):e.jsxs("div",{className:"pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-0.5",children:[e.jsx(N,{children:"âŒ˜"}),e.jsx(N,{children:"K"})]})]}),e.jsx(D,{options:pe,value:u,onValueChange:o,placeholder:"All agents",searchPlaceholder:"Search agents...",emptyText:"No agents found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(D,{options:je,value:C,onValueChange:le,placeholder:"All providers",searchPlaceholder:"Search providers...",emptyText:"No providers found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(D,{options:ve,value:_,onValueChange:oe,placeholder:"All models",searchPlaceholder:"Search models...",emptyText:"No models found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(D,{options:be,value:k,onValueChange:ie,placeholder:"All tasks",searchPlaceholder:"Search tasks...",emptyText:"No tasks found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(D,{options:E,value:he,onValueChange:xe,placeholder:"Columns",searchPlaceholder:"Search columns...",emptyText:"No columns.",variant:"card",className:"w-full border-l-0 shadow-none",multiSelectLabel:"columns"})]}),e.jsx(as,{columns:ks,data:Q,onRowClick:r=>t(ae(r,a)),isLoading:fe,className:"border-t-0",highlightedIndex:Ne,columnVisibility:me,sorting:de,onSortingChange:ue,manualSorting:!0}),p>1&&e.jsxs("div",{className:"grid grid-cols-3 items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",(n-1)*V+1,"-",Math.min(n*V,G)," of ",G," tasks"]}),e.jsx(rs,{children:e.jsxs(ts,{children:[e.jsx(m,{children:e.jsx(ns,{onClick:()=>d(r=>Math.max(1,r-1)),className:n===1?"pointer-events-none opacity-50":"cursor-pointer"})}),n>2&&e.jsx(m,{children:e.jsx(T,{onClick:()=>d(1),className:"cursor-pointer",children:"1"})}),n>3&&e.jsx(m,{children:e.jsx(Y,{})}),n>1&&e.jsx(m,{children:e.jsx(T,{onClick:()=>d(n-1),className:"cursor-pointer",children:n-1})}),e.jsx(m,{children:e.jsx(T,{isActive:!0,children:n})}),n<p&&e.jsx(m,{children:e.jsx(T,{onClick:()=>d(n+1),className:"cursor-pointer",children:n+1})}),n<p-2&&e.jsx(m,{children:e.jsx(Y,{})}),n<p-1&&e.jsx(m,{children:e.jsx(T,{onClick:()=>d(p),className:"cursor-pointer",children:p})}),e.jsx(m,{children:e.jsx(ls,{onClick:()=>d(r=>Math.min(p,r+1)),className:n===p?"pointer-events-none opacity-50":"cursor-pointer"})})]})}),e.jsx("div",{})]})]}),e.jsx(se,{value:"summary",children:H?.summary?e.jsx(Ze,{code:H.summary,lang:"markdown",wrap:!0}):e.jsxs(Ue,{className:"bg-card border",children:[e.jsxs(Je,{children:[e.jsx(Qe,{variant:"icon",children:e.jsx(ds,{})}),e.jsx(Ge,{children:"No summary"}),e.jsx(He,{children:"Generate a summary of all trials in this job using Claude."})]}),e.jsx(Ns,{jobName:a})]})})]})]})});export{Ls as default};
