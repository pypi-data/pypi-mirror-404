name: Publish to PyPI

permissions:
  id-token: write

on:
  release:
    types: [published]

jobs:
  release:
    name: Build and Publish
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install

      - name: Set version from GITHUB_REF
        run: |
          # GITHUB_REF is refs/tags/v1.2.3 - extract "1.2.3"
          echo "GITHUB_REF: ${{ github.ref }}"
          export VERSION=$(echo ${{ github.ref }} | sed -e 's,.*/\(.*\),\1,' -e 's/^v//')
          echo "Setting version to $VERSION"
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
          echo "======================================"
          echo "Version line in pyproject.toml:"
          grep "^version" pyproject.toml
          echo "======================================"

      - name: Build wheels and source tarball
        run: uv build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.13.0
