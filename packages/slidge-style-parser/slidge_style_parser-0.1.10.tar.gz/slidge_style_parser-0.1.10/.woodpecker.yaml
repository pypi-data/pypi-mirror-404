when:
  event: [ push, tag ]

matrix:
  arch:
    - amd64
    - arm64
  python_version:
    - "3.11"
    - "3.12"
    - "3.13"
    - "3.14"

labels:
  platform: linux/${arch}

clone:
  - name: clone-deep
    image: woodpeckerci/plugin-git
    settings:
      tags: true
      partial: false

steps:
  build:
    image: ghcr.io/pyo3/maturin
    commands:
      - uv build -p $python_version
      - auditwheel repair dist/*.whl  # for some reason the wheels are sometimes not "manylinux", this fixes it

  publish-codeberg:
    image: ghcr.io/pyo3/maturin
    environment:
      TOKEN:
        from_secret: CODEBERG_TOKEN
    depends_on: [ build ]
    commands:
      - if [ "${python_version}" = "3.11" ] && [ "${arch}" = "amd64" ]; then SDIST="dist/*.tar.gz"; else SDIST=""; fi
      - uv publish --token $TOKEN --index codeberg wheelhouse/* $SDIST

  publish-pypi:
    image: ghcr.io/pyo3/maturin
    when:
      event: [ tag ]
    depends_on: [ build ]
    environment:
      TOKEN:
        from_secret: PYPI_TOKEN
    commands:
      - if [ "${python_version}" = "3.11" ] && [ "${arch}" = "amd64" ]; then SDIST="dist/*.tar.gz"; else SDIST=""; fi
      - uv publish --token $TOKEN wheelhouse/* $SDIST
