---
name: Deploy Versioned Documentation

# Manage versioned documentation using mike
# Creates separate versions for different releases and branches

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 0.1.0, latest, dev)'
        required: true
        default: 'dev'
      alias:
        description: 'Alias for this version (e.g., latest, stable)'
        required: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy-versioned-docs:
    name: Deploy Versioned Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history needed for mike versioning

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # MANDATORY: AI Assistant Validation Protocol
      - name: ğŸ” Validate Current API Surface
        run: |
          echo "AI Assistant Validation Protocol: Checking current API exports..."

          # Verify __init__.py exists and contains expected exports
          if [ ! -f "src/honeyhive/__init__.py" ]; then
            echo "âŒ src/honeyhive/__init__.py not found"
            exit 1
          fi

          # Check that HoneyHive and HoneyHiveTracer are in __all__
          if ! grep -q '"HoneyHive"' src/honeyhive/__init__.py; then
            echo "âŒ HoneyHive not found in __all__ exports"
            exit 1
          fi

          if ! grep -q '"HoneyHiveTracer"' src/honeyhive/__init__.py; then
            echo "âŒ HoneyHiveTracer not found in __all__ exports"
            exit 1
          fi

          echo "âœ… API validation passed"

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Install package
          pip install -e .

          # Install documentation and versioning tools
          pip install mike>=2.0.0
          pip install sphinx>=7.0.0 sphinx-rtd-theme>=1.3.0
          pip install sphinx-autodoc-typehints myst-parser sphinx-copybutton sphinx-design
          pip install sphinxcontrib-mermaid sphinx-tabs

      - name: Test imports before versioning
        run: |
          # Ensure our API is working before we document it
          python -c "
          from honeyhive import HoneyHive, HoneyHiveTracer
          import honeyhive
          print(f'âœ… API working, version: {honeyhive.__version__}')
          "

      - name: Determine version and alias
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            ALIAS="${{ github.event.inputs.alias }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            ALIAS="stable"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="dev"
            ALIAS="latest"
          else
            VERSION="dev"
            ALIAS=""
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "alias=$ALIAS" >> $GITHUB_OUTPUT
          echo "ğŸ“ Deploying version: $VERSION with alias: $ALIAS"

      - name: Build and deploy with mike
        run: |
          cd docs

          # Build the documentation
          make clean
          make html

          VERSION="${{ steps.version.outputs.version }}"
          ALIAS="${{ steps.version.outputs.alias }}"

          # Initialize mike if this is the first run
          if ! git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "ğŸ“ Initializing mike for first-time versioned docs"
            mike deploy --push --update-aliases "$VERSION" "$ALIAS" || true
          fi

          # Deploy the version
          if [ -n "$ALIAS" ]; then
            mike deploy --push --update-aliases "$VERSION" "$ALIAS"
            echo "âœ… Deployed version $VERSION with alias $ALIAS"
          else
            mike deploy --push "$VERSION"
            echo "âœ… Deployed version $VERSION"
          fi

          # Set default version to latest
          if [ "$ALIAS" = "latest" ]; then
            mike set-default --push latest
            echo "âœ… Set 'latest' as default version"
          fi

      - name: Show deployed versions
        run: |
          cd docs
          echo "ğŸ“š Available documentation versions:"
          mike list
