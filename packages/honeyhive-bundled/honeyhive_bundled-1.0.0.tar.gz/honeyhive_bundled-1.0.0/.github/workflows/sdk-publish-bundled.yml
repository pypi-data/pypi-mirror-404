---
name: Publish honeyhive-bundled to PyPI

# Manual trigger only for bundled releases
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to publish from'
        required: false
        default: 'main'

permissions:
  contents: write
  id-token: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  publish-bundled:
    name: ðŸ“¦ Build and Publish honeyhive-bundled to PyPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine hatchling

      # === VERSION VALIDATION ===

      - name: Extract version from __init__.py
        id: get_version
        run: |
          # Extract bundled version from source
          version=$(sed -n 's/^__version_bundled__[[:space:]]*=[[:space:]]*"\([^"]*\)".*/\1/p' src/honeyhive/__init__.py)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Detected bundled version: $version"

          # Validate version format (more permissive for bundled - allows .post suffix)
          if ! echo "$version" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "âŒ Invalid version format: $version"
            exit 1
          fi

          echo "âœ… Version format is valid"

      - name: Check if version already published to PyPI
        id: check_pypi
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "ðŸ” Checking if version $VERSION exists on PyPI for honeyhive-bundled..."

          # Query PyPI API for package versions
          response=$(curl -s https://pypi.org/pypi/honeyhive-bundled/json || echo '{}')

          # Check if version exists in releases
          if echo "$response" | python -c \
            "import sys, json; \
            data = json.load(sys.stdin); \
            sys.exit(0 if '$VERSION' in data.get('releases', {}) else 1)"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Version $VERSION already published to PyPI"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ†• Version $VERSION is new - will publish to PyPI"
          fi

      - name: Skip publishing (version already exists)
        if: steps.check_pypi.outputs.exists == 'true'
        run: |
          echo "## âœ… Version Already Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** honeyhive-bundled" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.get_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This version is already available on PyPI." >> $GITHUB_STEP_SUMMARY
          exit 0

      # === BUILD AND PUBLISH ===

      - name: Swap pyproject.toml for bundled build
        if: steps.check_pypi.outputs.exists == 'false'
        run: |
          echo "ðŸ“¦ Swapping to bundled pyproject.toml..."
          cp pyproject.toml pyproject.toml.backup
          cp pyproject.bundled.toml pyproject.toml
          echo "âœ… Using pyproject.bundled.toml for build"

      - name: Build distribution packages
        if: steps.check_pypi.outputs.exists == 'false'
        run: |
          echo "ðŸ“¦ Building honeyhive-bundled package..."
          python -m build

          echo "ðŸ“‹ Package contents:"
          ls -lh dist/

      - name: Restore original pyproject.toml
        if: always()
        run: |
          if [ -f pyproject.toml.backup ]; then
            mv pyproject.toml.backup pyproject.toml
            echo "âœ… Restored original pyproject.toml"
          fi

      - name: Verify package integrity
        if: steps.check_pypi.outputs.exists == 'false'
        run: |
          echo "ðŸ” Checking package integrity..."
          python -m twine check dist/*
          echo "âœ… Package integrity verified"

      - name: Test package installation
        if: steps.check_pypi.outputs.exists == 'false'
        run: |
          echo "ðŸ§ª Testing package installation..."

          # Create clean test environment
          python -m venv test-install
          source test-install/bin/activate

          # Install the wheel
          pip install dist/*.whl

          # Test imports (import name is still 'honeyhive')
          python -c "
          import honeyhive
          from honeyhive import HoneyHive, HoneyHiveTracer
          from honeyhive import trace

          print(f'âœ… Package installation successful')
          print(f'HoneyHive bundled version: {honeyhive.__version_bundled__}')
          "

          deactivate
          echo "âœ… Installation test passed"

      - name: Publish to PyPI
        if: steps.check_pypi.outputs.exists == 'false'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          echo "ðŸš€ Publishing honeyhive-bundled version ${{ steps.get_version.outputs.version }} to PyPI..."
          python -m twine upload dist/*
          echo "âœ… Published to PyPI successfully!"

      - name: Verify publication
        if: steps.check_pypi.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          echo "â³ Waiting 30 seconds for PyPI to update..."
          sleep 30

          echo "ðŸ” Verifying package is available on PyPI..."
          max_attempts=5
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            if pip index versions honeyhive-bundled | grep -q "$VERSION"; then
              echo "âœ… Package verified on PyPI!"
              echo "ðŸ”— https://pypi.org/project/honeyhive-bundled/$VERSION/"
              exit 0
            fi

            echo "Attempt $attempt/$max_attempts: Not yet available, waiting..."
            sleep 10
            attempt=$((attempt + 1))
          done

          echo "âš ï¸ Could not verify package on PyPI within timeout"
          echo "ðŸ”— https://pypi.org/project/honeyhive-bundled/$VERSION/"

      # === SUMMARY ===

      - name: Generate release summary
        if: steps.check_pypi.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "# ðŸš€ honeyhive-bundled Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** honeyhive-bundled" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Published:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install honeyhive-bundled==$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI Package](https://pypi.org/project/honeyhive-bundled/$VERSION/)" >> $GITHUB_STEP_SUMMARY
