---
name: Build Release Candidate

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      pre_release:
        description: 'Pre-release identifier (e.g., rc, beta, alpha)'
        required: false
        default: 'rc'
        type: string
      skip_tests:
        description: 'Skip tests (for emergency releases only)'
        required: false
        default: false
        type: boolean
      force_aws_tests:
        description: 'Force AWS Lambda tests to run'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  actions: read

env:
  PYTHON_VERSION: "3.11"

jobs:
  # === COMPREHENSIVE TESTING PHASE ===

  pre-release-validation:
    name: üìã Pre-Release Validation
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.check-tests.outputs.should-run }}
      should-run-aws: ${{ steps.check-aws.outputs.should-run }}
      version-info: ${{ steps.version.outputs.info }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check if tests should run
        id: check-tests
        run: |
          if [ "${{ inputs.skip_tests }}" = "true" ]; then
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Tests will be SKIPPED (emergency release mode)"
          else
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Tests will be executed"
          fi

      - name: Check if AWS tests should run
        id: check-aws
        run: |
          if [ "${{ inputs.force_aws_tests }}" = "true" ] && [ "${{ inputs.skip_tests }}" = "false" ]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ AWS Lambda tests will be executed"
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è AWS Lambda tests will be SKIPPED"
          fi

      - name: Generate version info
        id: version
        run: |
          echo "info=${{ inputs.version_type }}-${{ inputs.pre_release }}" >> $GITHUB_OUTPUT

  # Call the full Tox test suite
  full-test-suite:
    name: üß™ Full Test Suite
    needs: pre-release-validation
    if: needs.pre-release-validation.outputs.should-run-tests == 'true'
    uses: ./.github/workflows/tox-full-suite.yml
    with:
      python_versions: '3.11,3.12,3.13'
      tox_environments: 'lint,format,docs'
      upload_coverage: true
    secrets: inherit

  # Call Lambda tests with AWS enabled
  lambda-compatibility-tests:
    name: üê≥ Lambda Compatibility Tests
    needs: pre-release-validation
    if: needs.pre-release-validation.outputs.should-run-tests == 'true'
    uses: ./.github/workflows/lambda-tests.yml
    with:
      force_aws_tests: ${{ inputs.force_aws_tests }}
      skip_performance_tests: false
    secrets: inherit

  # === PACKAGE BUILDING PHASE ===

  build-package:
    name: üì¶ Build Distribution Package
    needs: [pre-release-validation, full-test-suite, lambda-compatibility-tests]
    if: always() && (needs.pre-release-validation.outputs.should-run-tests == 'false' ||
        (needs.full-test-suite.result == 'success' && needs.lambda-compatibility-tests.result == 'success'))
    runs-on: ubuntu-latest
    outputs:
      RC_VERSION: ${{ env.RC_VERSION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for proper versioning

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling twine

      - name: Configure version for release candidate
        run: |
          # Get current version from pyproject.toml
          current_version=$(python -c \
            "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "Current version: $current_version"

          # Parse version components
          IFS='.' read -ra VERSION_PARTS <<< "$current_version"
          major=${VERSION_PARTS[0]}
          minor=${VERSION_PARTS[1]}
          patch=${VERSION_PARTS[2]}

          # Increment based on version type
          case "${{ inputs.version_type }}" in
            "major")
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            "minor")
              minor=$((minor + 1))
              patch=0
              ;;
            "patch")
              patch=$((patch + 1))
              ;;
          esac

          # Create release candidate version
          rc_version="${major}.${minor}.${patch}${{ inputs.pre_release }}$(date +%Y%m%d%H%M)"
          echo "Release candidate version: $rc_version"
          echo "RC_VERSION=$rc_version" >> $GITHUB_ENV

          # Update pyproject.toml temporarily for build
          sed -i "s/version = \"$current_version\"/version = \"$rc_version\"/" pyproject.toml

      - name: Build source distribution and wheel
        run: |
          python -m build

      - name: Verify package integrity
        run: |
          python -m twine check dist/*

      - name: Test package installation
        run: |
          # Test wheel installation in clean environment
          python -m venv test-install
          source test-install/bin/activate
          pip install dist/*.whl

          # Basic import test
          python -c "
          import honeyhive
          from honeyhive import HoneyHiveTracer
          print(f'‚úÖ Package installation successful')
          print(f'HoneyHive version: {honeyhive.__version__}')
          "

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: honeyhive-python-sdk-${{ env.RC_VERSION }}
          path: dist/
          retention-days: 30

      - name: Generate package metadata
        run: |
          echo "## üì¶ Release Candidate Package Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ env.RC_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Version Type:** ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release Identifier:** ${{ inputs.pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Verification" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Source distribution built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Wheel built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Package integrity verified" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Installation test passed" >> $GITHUB_STEP_SUMMARY

  # === VALIDATION PHASE ===

  validate-release-candidate:
    name: üîç Validate Release Candidate
    needs: [build-package]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download release candidate package
        uses: actions/download-artifact@v4
        with:
          name: honeyhive-python-sdk-${{ needs.build-package.outputs.RC_VERSION }}
          path: dist/

      - name: Test package on Python ${{ matrix.python-version }}
        run: |
          # Install the wheel
          pip install dist/*.whl

          # Comprehensive import test
          python -c "
          import sys
          print(f'Testing on Python {sys.version}')

          # Test core imports
          import honeyhive
          from honeyhive import HoneyHiveTracer, HoneyHive
          from honeyhive.tracer import trace
          from honeyhive.evaluation import evaluate

          # Test basic functionality
          client = HoneyHive(api_key='test-key', test_mode=True)
          tracer = HoneyHiveTracer.init(project='test-project', api_key='test-key')

          print('‚úÖ All core imports successful')
          print('‚úÖ Basic instantiation successful')
          print(f'HoneyHive version: {honeyhive.__version__}')
          "

  # === RELEASE SUMMARY ===

  release-summary:
    name: üìä Release Summary
    needs: [pre-release-validation, full-test-suite, lambda-compatibility-tests,
            build-package, validate-release-candidate]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate release summary
        run: |
          echo "# üöÄ Release Candidate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test Results
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.pre-release-validation.outputs.should-run-tests }}" = "true" ]; then
            test_result="${{ needs.full-test-suite.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
            echo "- **Full Test Suite:** $test_result" >> $GITHUB_STEP_SUMMARY
            lambda_result="${{ needs.lambda-compatibility-tests.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
            echo "- **Lambda Tests:** $lambda_result" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Tests:** ‚ö†Ô∏è SKIPPED (emergency release mode)" >> $GITHUB_STEP_SUMMARY
          fi

          # Build Results
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Build Results" >> $GITHUB_STEP_SUMMARY
          build_result="${{ needs.build-package.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
          echo "- **Package Build:** $build_result" >> $GITHUB_STEP_SUMMARY
          validate_result="${{ needs.validate-release-candidate.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}"
          echo "- **Package Validation:** $validate_result" >> $GITHUB_STEP_SUMMARY

          # Overall Status
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-package.result }}" = "success" ] && \
             [ "${{ needs.validate-release-candidate.result }}" = "success" ]; then
            echo "## üéâ **RELEASE CANDIDATE READY**" >> $GITHUB_STEP_SUMMARY
            echo "The release candidate package has been built and validated successfully." >> $GITHUB_STEP_SUMMARY
            echo "Download from the artifacts section above." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå **RELEASE CANDIDATE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "The release candidate build encountered errors. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi

          # Next Steps
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the release candidate package from artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the package in your target environments" >> $GITHUB_STEP_SUMMARY
          echo "3. If satisfied, create a proper release using the package contents" >> $GITHUB_STEP_SUMMARY
