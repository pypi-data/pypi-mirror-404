[tox]
envlist = py311, py312, py313, lint, format, docs, unit, integration, traceloop-integration, compatibility
isolated_build = True
requires = tox>=4.0

[testenv]
deps =
    pytest>=7.0.0
    pytest-asyncio>=0.21.0
    pytest-cov==7.0.0
    pytest-xdist>=3.0.0
    httpx>=0.24.0
    opentelemetry-api>=1.20.0
    opentelemetry-sdk>=1.20.0
    opentelemetry-exporter-otlp-proto-http>=1.20.0
    wrapt>=1.14.0
    pydantic>=2.0.0
    python-dotenv>=1.0.0
    psutil>=5.9.0

commands =
    # Unit tests WITH coverage (code quality focus) - parallel execution enabled
    pytest tests/unit -v --asyncio-mode=auto --cov=src/honeyhive --cov-report=term-missing --cov-fail-under=80 -n auto --dist=worksteal
    pytest tests/tracer -v --asyncio-mode=auto --cov=src/honeyhive --cov-report=term-missing --cov-append --cov-fail-under=80 -n auto --dist=worksteal
    # Integration tests WITHOUT coverage (behavior focus) - parallel execution enabled
    pytest tests/integration -v --asyncio-mode=auto --tb=short -n auto --dist=worksteal

setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONUNBUFFERED = 1
    HH_API_KEY = test-api-key-12345
    HH_API_URL = https://api.honeyhive.ai
    # HH_PROJECT is deprecated - project derived from API key
    HH_SOURCE = test
    HH_DEBUG_MODE = true
    HH_DISABLE_TRACING = false
    HH_DISABLE_HTTP_TRACING = false
    HH_OTLP_ENABLED = false
    HH_TEST_MODE = true

passenv =
    HH_API_KEY
    HH_PROJECT
    HH_API_URL
    HH_SOURCE
    HH_TEST_MODE
    HH_DEBUG_MODE
    HH_DISABLE_TRACING
    HH_DISABLE_HTTP_TRACING
    HH_OTLP_ENABLED
    HH_OTLP_ENDPOINT
    HH_OTLP_HEADERS
    # LLM Provider API keys for real instrumentor testing
    OPENAI_API_KEY
    ANTHROPIC_API_KEY
    GOOGLE_API_KEY
    GOOGLE_ADK_API_KEY
    AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY
    AWS_DEFAULT_REGION
    AZURE_OPENAI_API_KEY
    AZURE_OPENAI_ENDPOINT
    # CI environment indicators
    CI
    GITHUB_ACTIONS
    GITLAB_CI
    JENKINS_URL

[testenv:py311]
description = run full test suite with Python 3.11
basepython = python3.11

[testenv:py312]
description = run full test suite with Python 3.12
basepython = python3.12

[testenv:py313]
description = run full test suite with Python 3.13
basepython = python3.13

[testenv:lint]
description = run linting checks
deps =
    pylint==3.3.8
    mypy==1.17.1
    pytest>=7.0.0
    pytest-asyncio>=0.21.0
    types-python-dateutil>=2.9.0.20240316
    types-requests>=2.31.0
    types-urllib3>=1.26.0
    types-psutil>=5.9.0
    memory-profiler>=0.61.0
    httpx>=0.27.0
    pydantic>=2.10.0
    opentelemetry-api>=1.21.0
    opentelemetry-sdk>=1.21.0
    opentelemetry-exporter-otlp-proto-http>=1.21.0
    opentelemetry-instrumentation>=0.42b0
    wrapt>=1.16.0
    python-dateutil>=2.8.2
    typing-inspect>=0.9.0
    requests>=2.25.1
    dataclasses-json>=0.6.7
    jsonpath-python>=1.0.6
    uplink>=0.1.0
    eval-type-backport>=0.2.0
    psutil>=5.9.0
commands =
    pylint {posargs:src/honeyhive tests} --rcfile=pyproject.toml --ignore-paths=".*\.tox.*"
    mypy {posargs:src/honeyhive} --config-file=pyproject.toml
setenv =
    PYTHONPATH = {toxinidir}/src
passenv = {[testenv]passenv}

[testenv:format]
description = check code formatting
deps =
    black==25.1.0
    isort==5.13.2
commands =
    black --check {posargs:src tests}
    isort --check-only {posargs:src tests}

[testenv:docs]
description = build documentation
deps =
    sphinx>=7.0.0
    sphinx-rtd-theme>=1.3.0
    myst-parser>=2.0.0
    sphinxcontrib-mermaid>=0.9.2
    sphinx-tabs>=3.4.0
commands =
    # Clean previous builds to prevent Sphinx caching from masking warnings
    python -c "import shutil; import os; path='docs/_build'; shutil.rmtree(path) if os.path.exists(path) else None"
    # Build with warnings as errors - fail fast on any warnings
    sphinx-build -W -b html docs docs/_build/html

[testenv:integration]
description = run integration tests with REAL API credentials (NO MOCKS, NO COVERAGE)
deps = 
    {[testenv]deps}
    pytest-xdist>=3.0.0
    # LLM provider dependencies for real instrumentor testing
    openai>=1.0.0
    anthropic>=0.25.0
    google-generativeai>=0.4.0
    boto3>=1.26.0
    openinference-instrumentation-openai
    openinference-instrumentation-anthropic
    openinference-instrumentation-bedrock
commands =
    # Integration tests WITHOUT coverage - focus on real API behavior and system interactions
    # This includes backwards compatibility tests in tests/integration/backwards_compatibility/
    # PARALLEL EXECUTION: Re-enabled after fixing import violations and fixture issues
    # Using worksteal for more aggressive load balancing (as mentioned by user)
    pytest tests/integration {posargs:--tb=short -v} --durations=10 --maxfail=10 -n 8 --dist=worksteal
setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONUNBUFFERED = 1
    HH_TEST_MODE = false
    HH_DISABLE_TRACING = false
    HH_DISABLE_HTTP_TRACING = false
    HH_OTLP_ENABLED = true
    HH_TEST_MAX_ATTEMPTS=4      # Default: 10 attempts
    HH_TEST_BASE_DELAY=2.0       # Default: 1.5 seconds
    HH_TEST_MAX_DELAY_CAP=30.0   # Default: 30 seconds max
passenv = 
    {[testenv]passenv}
    HH_API_KEY
    HH_PROJECT
    HH_API_URL
    HH_SOURCE
    # Note: HH_PROJECT is required for backend API authentication

[testenv:unit]
description = run unit tests only (fast, mocked)
deps = 
    {[testenv]deps}
    pytest-xdist>=3.0.0
    coverage==7.10.7
commands =
    # Clean any existing coverage data to prevent conflicts
    python -c "import os, glob; [os.remove(f) for f in glob.glob('.coverage*') if os.path.isfile(f)]"
    # Unit tests WITH coverage and parallel execution - leveraging multi-instance architecture
    pytest tests/unit {posargs} --cov=src/honeyhive --cov-report=term-missing --cov-report=html --cov-fail-under=80 -n auto --dist=worksteal
    # Generate additional coverage report (pytest-cov 7.0+ automatically combines parallel data)
    coverage report --fail-under=80
setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONUNBUFFERED = 1
    HH_API_KEY = test-api-key-12345
    HH_API_URL = https://api.honeyhive.ai
    HH_SOURCE = test
    HH_TEST_MODE = true
    HH_DISABLE_TRACING = false
    HH_DISABLE_HTTP_TRACING = false
    HH_OTLP_ENABLED = false
passenv = 
    # Unit tests should be isolated - don't pass through real environment variables
    # Only pass through CI environment indicators for test reporting
    CI
    GITHUB_ACTIONS
    GITLAB_CI
    JENKINS_URL

[testenv:traceloop-integration]
description = run Traceloop (OpenLLMetry) compatibility matrix tests
# Note: opentelemetry-instrumentation-* packages are published by Traceloop, not OpenTelemetry
deps = 
    {[testenv]deps}
    opentelemetry-instrumentation-anthropic>=0.46.0,<1.0.0
    opentelemetry-instrumentation-openai>=0.46.0,<1.0.0
    anthropic>=0.17.0
    openai>=1.0.0
commands = 
    pytest {posargs:tests/compatibility_matrix} -k "traceloop" -v --asyncio-mode=auto --no-cov
setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONUNBUFFERED = 1
    HH_TEST_MODE = true
    HH_DEBUG_MODE = true
    HH_DISABLE_TRACING = false
    HH_DISABLE_HTTP_TRACING = false
    HH_OTLP_ENABLED = false
passenv = 
    {[testenv]passenv}
    HH_API_KEY
    HH_API_URL
    HH_PROJECT
    HH_PROJECT_ID
    HH_SOURCE
    ANTHROPIC_API_KEY
    OPENAI_API_KEY

[testenv:compatibility]
description = Run model provider compatibility matrix tests
deps = 
    {[testenv]deps}
    # Use the compatibility matrix requirements file
    -r tests/compatibility_matrix/requirements.txt
    # Traceloop instrumentors for enhanced testing
    traceloop-sdk
commands = 
    python tests/compatibility_matrix/run_compatibility_tests.py --output compatibility_matrix_py{py_dot_ver}.md
setenv =
    {[testenv]setenv}
    HH_TEST_MODE = true
    # Allow tests to be skipped if credentials are missing
    PYTEST_SKIP_MISSING_CREDENTIALS = true

# Python version-specific compatibility testing
[testenv:compatibility-py311]
description = Run compatibility matrix tests on Python 3.11
basepython = python3.11
deps = {[testenv:compatibility]deps}
commands = {[testenv:compatibility]commands}
setenv = {[testenv:compatibility]setenv}
passenv = {[testenv:compatibility]passenv}

[testenv:compatibility-py312]
description = Run compatibility matrix tests on Python 3.12
basepython = python3.12
deps = {[testenv:compatibility]deps}
commands = {[testenv:compatibility]commands}
setenv = {[testenv:compatibility]setenv}
passenv = {[testenv:compatibility]passenv}

[testenv:compatibility-py313]
description = Run compatibility matrix tests on Python 3.13
basepython = python3.13
deps = {[testenv:compatibility]deps}
commands = {[testenv:compatibility]commands}
setenv = {[testenv:compatibility]setenv}
passenv = {[testenv:compatibility]passenv}

# Run compatibility tests across all Python versions
[testenv:compatibility-all]
description = Run compatibility matrix tests across all supported Python versions
deps = 
commands = 
    tox -e compatibility-py311
    tox -e compatibility-py312
    tox -e compatibility-py313
    python tests/compatibility_matrix/generate_version_matrix.py
passenv =
    {[testenv]passenv}
    # Provider API keys for compatibility testing (only for tests that exist)
    OPENAI_API_KEY
    ANTHROPIC_API_KEY
    GOOGLE_API_KEY
    GOOGLE_ADK_API_KEY
    GOOGLE_APPLICATION_CREDENTIALS
    GCP_PROJECT
    GCP_REGION
    AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY
    AWS_DEFAULT_REGION
    # Azure OpenAI configuration
    AZURE_OPENAI_ENDPOINT
    AZURE_OPENAI_API_KEY
    AZURE_OPENAI_DEPLOYMENT_NAME
    AZURE_OPENAI_API_VERSION
    AZURE_OPENAI_DEPLOYMENT
    AZURE_OPENAI_GPT4_DEPLOYMENT
