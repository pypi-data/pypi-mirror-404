name: nightly-test-release

on:
  schedule:
    - cron: '0 16 * * *'  # Run at 4 PM every day
  workflow_dispatch:  # Allow manual triggering


env:
  CACHE_TYPE: "pip"
  DISABLE_TELEMETRY: "true"
  NOTTE_RELEASE_TEST_API_KEY: ${{ secrets.NOTTE_RELEASE_TEST_API_KEY }}

jobs:
  example-tests:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 10
    steps:
      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
            enable-cache: true
            cache-dependency-glob: "uv.lock"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"
          cache: ${{ env.CACHE_TYPE }}

      - name: Run test release
        id: test_release
        run: bash scripts/test_release.sh
        continue-on-error: true

      - name: Prepare error message
        if: steps.test_release.outcome == 'failure'
        id: error_msg
        run: |
          # Escape quotes and backslashes for JSON
          ERROR_MSG=$(echo "${{ env.TEST_OUTPUT }}" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr '\n' ' ')
          echo "escaped_error=$ERROR_MSG" >> $GITHUB_OUTPUT

      - name: Send Slack Notification on Failure
        if: steps.test_release.outcome == 'failure'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "username": "GitHub Nightly Release Pipeline (${{ steps.timestamp.outputs.timestamp }})",
              "text": "‚ùå Nightly Release Pipeline FAILED: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline Run>\n```\n${{ steps.error_msg.outputs.escaped_error }}\n```"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NIGHTLY_WEBHOOK_URL }}
