[project]
name = "gobby"
version = "0.2.9"
description = "A local-first daemon to unify your AI coding tools. Session tracking and handoffs across Claude Code, Gemini CLI, and Codex. An MCP proxy that discovers tools without flooding context. Task management with dependencies, validation, and TDD expansion. Agent spawning and worktree orchestration. Persistent memory, extensible workflows, and hooks."
readme = "README.md"
license = "MIT"
authors = [
    { name = "Josh Wilhelmi", email = "josh@gobby.ai" }
]
keywords = ["cli", "mcp", "claude", "gemini", "codex", "daemon", "session-management"]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Environment :: Console",
    "Intended Audience :: Developers",
    "Programming Language :: Python :: 3.13",
    "Programming Language :: Python :: 3.14",
    "Topic :: Software Development :: Libraries :: Python Modules",
]
requires-python = ">=3.13"
dependencies = [
    "anthropic>=0.75.0",
    "click>=8.1.0",
    "fastapi>=0.115.0",
    "fastmcp>=2.14.0",
    "httpx>=0.27.0",
    "litellm>=1.0.0",
    "psutil>=6.1.0",
    "py-machineid>=0.6.0",
    "pydantic>=2.9.0",
    "uvicorn[standard]>=0.30.0",
    "websockets>=15.0",
    "pyyaml>=6.0.3",
    "jinja2>=3.1.0",
    "claude-agent-sdk>=0.1.18",
    "wcwidth>=0.2.14",
    "tomli-w>=1.0.0",
    "msgspec>=0.20.0",
    # gitingest>=0.3.1 includes CVE-2024-56074 fix (commit 9996a06, Dec 2024)
    "gitingest>=0.3.1",
    # scikit-learn for TF-IDF memory search
    "scikit-learn>=1.0.0",
    "textual>=7.3.0",
    # mem0ai moved to optional [mem0] extra due to CVE-2026-0994 (protobuf<=6.33.4 vulnerable)
    "memu-py>=1.0.0",
    # python-multipart 0.0.21 has CVE-2026-24486 - pin to fixed version
    "python-multipart>=0.0.22",
]

[project.optional-dependencies]
mem0 = ["mem0ai"]

[project.scripts]
gobby = "gobby.cli:cli"

[project.urls]
Homepage = "https://github.com/GobbyAI/gobby"
Repository = "https://github.com/GobbyAI/gobby"
Documentation = "https://github.com/GobbyAI/gobby#readme"
Issues = "https://github.com/GobbyAI/gobby/issues"

[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[tool.setuptools.packages.find]
where = ["src"]

[tool.setuptools.package-data]
gobby = [
    "install/claude/**/*",
    "install/gemini/**/*",
    "install/codex/**/*",
    "install/antigravity/**/*",
    "prompts/defaults/**/*.md",
]

[tool.pytest.ini_options]
asyncio_mode = "auto"
testpaths = ["tests"]
pythonpath = ["src"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = [
    "--cov=gobby",
    "--cov-report=term-missing",
    "--cov-report=html",
    "-v",
    "-p", "no:faulthandler",  # Disable faulthandler - gitingest closes FDs during logging config
]
# Note: --cov-fail-under=80 is enforced in CI via the test command
# To run locally with coverage threshold: uv run pytest --cov-fail-under=80
markers = [
    "unit: marks tests as fast unit tests",
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
    "e2e: marks tests as end-to-end tests",
    "cli: marks tests as CLI command tests",
    "no_config_protection: skip config protection for this test",
]
filterwarnings = [
    # Ignore coroutine warnings from fire-and-forget async patterns in hook/webhook code
    "ignore:coroutine .* was never awaited:RuntimeWarning",
    # Ignore Pydantic deprecation warnings from workflow loader
    "ignore:The `dict` method is deprecated:DeprecationWarning",
    # Ignore coverage module-not-measured warning
    "ignore:Module gobby was previously imported:coverage.exceptions.CoverageWarning",
    # Ignore pathspec GitWildMatchPattern deprecation (upstream dependency issue)
    "ignore:GitWildMatchPattern.*is deprecated:DeprecationWarning:pathspec",
    # Ignore ResourceWarnings from test infrastructure (coverage, unittest.mock)
    "ignore:unclosed database:ResourceWarning:coverage",
    "ignore:unclosed database:ResourceWarning:unittest.mock",
    "ignore:unclosed database:ResourceWarning",
    # Ignore fork() deprecation warning from embedded spawner tests (expected on macOS)
    "ignore:This process.*is multi-threaded.*use of fork:DeprecationWarning",
]

[tool.ruff]
line-length = 100
target-version = "py313"
exclude = [".archive"]

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # pyflakes
    "I",      # isort
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "UP",     # pyupgrade
    "TID252", # ban relative imports from parent packages (from .. import)
]
ignore = [
    "E501",  # line too long (handled by formatter)
    "B008",  # do not perform function calls in argument defaults
]

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401"]  # unused imports in __init__.py

[tool.mypy]
python_version = "3.13"
plugins = ["pydantic.mypy"]
strict = true
warn_return_any = true
warn_unused_configs = true
# Disabled: pre-commit mypy runs on individual files with different type inference,
# causing type: ignore comments needed for partial context to be flagged as unused
warn_unused_ignores = false
disallow_untyped_defs = true
disallow_any_generics = false
ignore_missing_imports = true
exclude = ["build"]

[[tool.mypy.overrides]]
module = "tests.*"
disallow_untyped_defs = false

[tool.bandit]
targets = ["src"]
exclude_dirs = ["tests", ".venv", "build", "examples"]
# Skip these checks (expected patterns for local daemon/CLI tool):
# B101: assert_used (internal invariants and type checking)
# B104: hardcoded_bind_all_interfaces (intentional for local daemon)
# B108: hardcoded_tmp_directory (temp file handling)
# B110, B112: try_except_pass/continue (cleanup/fallback code)
# B307: eval (workflow condition evaluator with controlled globals)
# B404, B602, B603, B606, B607: subprocess/exec usage expected for CLI tool
# B608: sql_expressions (local SQLite with parameterized queries)
# B701: jinja2 autoescape (not used for HTML)
skips = ["B101", "B104", "B108", "B110", "B112", "B307", "B404", "B602", "B603", "B606", "B607", "B608", "B701"]

[tool.black]
line-length = 100
target-version = ['py313']
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | _build
  | buck-out
  | build
  | dist
)/
'''

[dependency-groups]
dev = [
    "bandit>=1.8.0",
    "black>=24.0.0",
    "mypy>=1.8.0",
    "pip-audit>=2.7.0",
    "pre-commit>=4.0.0",
    "pytest>=8.4.2",
    "pytest-asyncio>=1.2.0",
    "pytest-cov>=7.0.0",
    "pytest-mock>=3.14.0",
    "pytest-xdist>=3.8.0",
    "ruff>=0.8.0",
    "types-PyYAML>=6.0.12.12",
]

[tool.coverage.run]
source = ["src/gobby"]
# parallel = true

[tool.coverage.paths]
gobby = ["src/gobby", "*/gobby", "*/site-packages/gobby"]
tests = ["tests"]

[tool.coverage.report]
exclude_lines = [
    "no cov",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
]
