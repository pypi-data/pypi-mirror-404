"""Discover command for finding installed programs on the system."""

from typing import List, Optional

import typer

from ..discovery import (
    DiscoveredProgram,
    SystemScanner,
    compare_with_config,
    filter_notable_tools,
    generate_yaml_snippet,
    get_suggestions,
)
from .helpers import get_config
from .output import (
    console,
    header,
    info,
    plain,
    success,
)


def register(app: typer.Typer) -> None:
    """Register the discover command with the app."""
    app.command()(discover)


def discover(
    source: Optional[List[str]] = typer.Option(
        None,
        "--source",
        "-s",
        help="Specific sources to scan (brew, cargo, uv_tool, npm, apt)",
    ),
    include_gui: bool = typer.Option(
        False,
        "--gui",
        "-g",
        help="Include GUI apps (Applications, brew casks, flatpak)",
    ),
    format_: str = typer.Option(
        "default",
        "--format",
        "-f",
        help="Output format: yaml, json",
    ),
):
    """Discover installed programs on your system.

    Scans various package managers and sources to find installed programs,
    then compares with your freckle.yaml configuration.

    Examples:
        freckle discover              # Scan CLI tools
        freckle discover --gui        # Include GUI apps
        freckle discover -s brew      # Only scan Homebrew
        freckle discover --format yaml  # Output as YAML snippet
    """
    scanner = SystemScanner()

    # Show scanning progress
    if format_ == "default":
        plain("Scanning system...")

    # Perform scan
    discovered = scanner.scan_all(
        include_gui=include_gui,
        sources=source,
    )

    # Get scan stats
    stats = scanner.get_scan_stats()

    # Show scan summary
    if format_ == "default" and stats:
        for src, count in stats.items():
            if count > 0:
                success(f"{src}: {count} programs", prefix="  ✓")

    # Load config and compare
    try:
        config = get_config()
        config_tools = config.data.get("tools", {})
    except Exception:
        config_tools = {}

    report = compare_with_config(discovered, config_tools)
    report.scan_stats = stats

    # Filter out dependencies and system packages
    unfiltered_untracked_count = len(report.untracked)
    report.untracked = filter_notable_tools(
        report.untracked,
        exclude_deps=True,
        exclude_system=True,
    )
    filtered_count = unfiltered_untracked_count - len(report.untracked)

    # Output based on format
    if format_ == "json":
        _output_json(report)
    elif format_ == "yaml":
        _output_yaml(report)
    else:
        _output_default(report, filtered_count)


def _output_default(report, filtered_count: int = 0) -> None:
    """Output discovery results in default format."""
    plain("")
    header("Summary")
    total_scanned = sum(report.scan_stats.values())
    plain(f"  Total scanned:          {total_scanned}")
    plain(f"  Managed by freckle:     {len(report.managed)}")
    if filtered_count > 0:
        hidden = f"({filtered_count} deps/system hidden)"
        plain(f"  Untracked:              {len(report.untracked)} {hidden}")
    else:
        plain(f"  Untracked:              {len(report.untracked)}")

    # Show untracked tools
    plain("")
    header("Untracked Programs")

    if not report.untracked:
        success("All discovered programs are tracked!", prefix="  ✓")
    else:
        # Group by source
        by_source = {}
        for prog in report.untracked:
            by_source.setdefault(prog.source, []).append(prog)

        for src, progs in sorted(by_source.items()):
            plain(f"  {src} ({len(progs)}):")
            for prog in progs:
                _print_program(prog, indent=4)
            plain("")

    # Show next steps
    if report.untracked:
        plain("")
        info("  Tip: Run 'freckle discover --format yaml' to generate config")


def _print_program(prog: DiscoveredProgram, indent: int = 2) -> None:
    """Print a single program line."""
    spaces = " " * indent
    version_str = f" ({prog.version})" if prog.version else ""
    plain(f"{spaces}• {prog.name}{version_str}")


def _output_yaml(report) -> None:
    """Output discovery results as YAML snippet."""
    if not report.untracked:
        console.print("# No untracked programs to add")
        return

    # Get suggestions for cleaner output (prioritized order)
    suggestions = get_suggestions(report.untracked, max_suggestions=50)

    console.print("# Discovered tools not in freckle.yaml")
    console.print("# Generated by: freckle discover --format yaml")
    console.print("")
    console.print(generate_yaml_snippet(suggestions))


def _output_json(report) -> None:
    """Output discovery results as JSON."""
    import json

    data = {
        "summary": {
            "managed": len(report.managed),
            "untracked": len(report.untracked),
        },
        "scan_stats": report.scan_stats,
        "managed": [
            {"name": p.name, "source": p.source}
            for p in report.managed
        ],
        "untracked": [
            {
                "name": p.name,
                "source": p.source,
                "version": p.version,
            }
            for p in report.untracked
        ],
    }

    console.print(json.dumps(data, indent=2))
