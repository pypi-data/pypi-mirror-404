{#
 # Template for Ansible playbook spec files for use by ansible-doc-template-extractor.
 # This template uses the playbook spec file format defined in the ansible-doc-template-extractor project.
 # This template produces an .rst file.
 # For the input variables that are set, run: ansible-doc-template-extractor --help-template.
 #}
{% macro para_generation(paras, level) %}
{# Macro that generates a list of paragraphs #}
{% if paras is string %}
{{ "  " * level }}{{ paras | to_rst }}

{% elif paras is iterable %}
{%   for para in paras %}
{{ "  " * level }}{{ para | to_rst }}

{%   endfor %}
{% else %}
{{ "  " * level }}{{ para | to_rst }}
{% endif %}
{% endmacro %}
{% macro indent(multiline, level) %}
{# Macro that generates an indented multi-line string #}
{%   for line in multiline.split('\n') %}
{{ "  " * level }}{{ line }}
{%   endfor %}
{% endmacro %}
{% macro option_generation(opts, level) %}
{# Macro that generates a list of options, recursively #}
{%   set sorted = false %}{# Flag to sort options by name #}
{%   for name, spec in (opts | dictsort if sorted else opts.items()) %}
{%     if spec.required | default(False) == True %}
{%       set required_txt = "Required." %}
{%     elif spec.default is defined %}
{%       set required_txt = "Optional, default: {}.".format(spec.default) %}
{%     else %}
{%       set required_txt = "Optional." %}
{%     endif %}
{%     set spec_type = spec.type | default('str') %}
{%     if spec_type == 'list' %}
{%       set type_txt = "list of {}".format(spec.elements) %}
{%     else %}
{%       set type_txt = spec_type %}
{%     endif %}
{%     if spec.choices is defined %}
{%       set choices_txt = "Choices: {}.".format(spec.choices | join(', ')) %}
{%     else %}
{%       set choices_txt = "" %}
{%     endif %}
{{ "  " * level }}* **{{ name }}** ({{ type_txt }}):

{%     set _ = spec.description | mandatory("Property '{name}' defined in 'options' or 'output' has no 'description' element".format(name=name)) %}
{{ para_generation(spec.description, level + 1) }}
{{ "  " * level }}  {{ required_txt | to_rst }}
{%     if spec.choices is defined %}

{{ "  " * level }}  {{ choices_txt | to_rst }}
{%     endif %}
{%     if spec.options is defined %}

{{ "  " * level }}  Dict items:

{{ option_generation(spec.options, level + 1) }}
{%     endif %}

{%   endfor %}
{% endmacro %}
{% macro ansible_type_txt(json_types) %}
{# Macro that returns the Ansible type name for a JSON type or list of types #}
{%   set ansible_type = {
       'string': 'str',
       'integer': 'int',
       'number': 'float',
       'boolean': 'bool',
       'object': 'dict',
       'array': 'list',
     } %}
{%  if json_types is string %}
{%    set json_types = [json_types] %}
{%  endif %}
{%  set a_types = [] %}
{%  for j_type in json_types %}
{%    do a_types.append(ansible_type.get(j_type, j_type)) %}
{%  endfor %}
{{- '/'.join(a_types) -}}
{% endmacro %}
{% macro schema_generation(obj, root_obj, level) %}
{# Macro that generates a list of properties and patternProperties defined in an object within a JSON schema, recursively #}
{%   for name, spec in (obj.properties | default([]) | combine(obj.patternProperties | default([]))).items() %}
{%     if '$ref' in spec %}
{%       set spec_description = spec.description | default(None) %}
{%       set ref = spec['$ref'] %}
{%       set def_name = ref | regex_replace('^#/definitions/', '') %}
{%       set _ = ('' if '/' not in def_name and def_name != '') | mandatory("Invalid format of $ref value in JSON schema for input or output parameters: '{}'".format(ref)) %}
{%       set spec = root_obj.definitions[def_name] %}
{%       if spec_description %}
{%         do spec.update({'description': spec_description}) %}
{%       endif %}
{%     endif %}
{%     set spec_type = spec.type | default('string') %}
{%     set required = name in obj.required | default([]) %}
{%     if required %}
{%       set required_txt = "Required." %}
{%     elif spec.default is defined %}
{%       set required_txt = "Optional, default: {}.".format(spec.default) %}
{%     else %}
{%       set required_txt = "Optional." %}
{%     endif %}
{%     if spec_type == 'array' %}
{%       if 'items' in spec %}
{%         set json_types = spec['items'].type | default('string') %}
{%         set type_txt = "list of {}".format(ansible_type_txt(json_types)) %}
{%       else %}
{%         set type_txt = "list" %}
{%       endif %}
{%     else %}
{%       set type_txt = ansible_type_txt(spec_type) %}
{%     endif %}
{%     if spec.enum is defined %}
{%       set choices_txt = "Choices: {}.".format(spec.enum | join(', ')) %}
{%     else %}
{%       set choices_txt = "" %}
{%     endif %}
{{ "  " * level }}* **{{ name }}** ({{ type_txt }}):

{%     set _ = spec.description | mandatory("Property '{name}' defined in 'options_schema' or 'output_schema' or in the JSON schema file referenced by 'options_schema_file' or 'output_schema_file' has no 'description' element".format(name=name)) %}
{{ para_generation(spec.description, level + 1) }}
{{ "  " * level }}  {{ required_txt | to_rst }}
{%     if spec.choices is defined %}

{{ "  " * level }}  {{ choices_txt | to_rst }}
{%     endif %}
{%     if spec_type == 'array' and 'items' in spec %}

{%       if spec['items'].type | default('string') == 'object' %}
{{ "  " * level }}  Dict items:

{%       endif %}
{{ schema_generation(spec['items'], root_obj, level + 1) }}
{%     elif spec_type == 'object' and (spec.properties is defined or spec.patternProperties is defined) %}

{{ "  " * level }}  Dict items:

{{ schema_generation(spec, root_obj, level + 1) }}
{%     endif %}

{%   endfor %}
{% endmacro %}

..
    # This file has been generated by ansible-doc-template-extractor.
    # Do not modify this file manually, but modify its spec file source!

{% set playbook_dict = spec_file_dict.argument_specs[name] |
   mandatory("The child element of 'argument_specs' does not specify the playbook name '{}', but '{}'".
   format(name, spec_file_dict.argument_specs.keys() | first)) %}
.. _{{ name }}_playbook:

{% set title = "Playbook {} -- {}".format(name, playbook_dict.short_description) %}
{{ title }}
{{ '=' * title | length }}

Synopsis
--------

{% if playbook_dict.description is iterable and playbook_dict.description is not string %}
{%   for item in playbook_dict.description %}
{{ para_generation(item, 0) }}
{%   endfor %}
{% else %}
{{ para_generation(playbook_dict.description, 0) }}
{% endif %}
{% if playbook_dict.requirements is defined %}

Requirements
------------

{%   if playbook_dict.requirements is iterable and playbook_dict.requirements is not string %}
{%     for item in playbook_dict.requirements %}
{{ para_generation(item, 0) }}
{%     endfor %}
{%   else %}
{{ para_generation(playbook_dict.requirements, 0) }}
{%   endif %}
{% endif %}
{% if playbook_dict.version_added is defined %}

Version added
-------------

{{ playbook_dict.version_added }}
{% endif %}
{% if playbook_dict.options is defined %}

Input Parameters
----------------

{{ option_generation(playbook_dict.options, 0) }}
{% elif playbook_dict.options_schema is defined %}

Input Parameters
----------------

{{ schema_generation(playbook_dict.options_schema, playbook_dict.options_schema, 0) }}
{% elif playbook_dict.options_schema_file is defined %}

Input Parameters
----------------

{%   set options_schema = load_schema_file(playbook_dict.options_schema_file, spec_file_name, "input parameters") %}
{{ schema_generation(options_schema, options_schema, 0) }}
{% endif %}
{% if playbook_dict.output is defined %}

Output Parameters
-----------------

{{ option_generation(playbook_dict.output, 0) }}
{% elif playbook_dict.output_schema is defined %}

Output Parameters
-----------------

{{ schema_generation(playbook_dict.output_schema, playbook_dict.output_schema, 0) }}
{% elif playbook_dict.output_schema_file is defined %}

Output Parameters
-----------------

{%   set output_schema = load_schema_file(playbook_dict.output_schema_file, spec_file_name, "output parameters") %}
{{ schema_generation(output_schema, output_schema, 0) }}
{% endif %}
{% if playbook_dict.examples is defined %}

Examples
--------

{%     for example in playbook_dict.examples %}
{%       if example.short_description is defined %}
* {{ para_generation(example.short_description, 0) }}
{%       else %}
* Example
{%       endif %}
{%       if example.description is defined %}

{{ para_generation(example.description, 1) }}
{%       endif %}

  .. code-block:: bash

{{ indent(example.command | trim, 3) }}

{%   endfor %}
{% endif %}
{% if playbook_dict.author is defined %}

Authors
-------

{%   if playbook_dict.author is iterable and playbook_dict.author is not string %}
{%     for item in playbook_dict.author %}
* {{ item }}
{%     endfor %}
{%   else %}
* {{ playbook_dict.author }}
{%   endif %}
{% endif %}
