# ==============================================================================
# Sisyphus API Engine - 脚本执行测试
# ==============================================================================
# 功能说明：演示脚本执行功能
# - Python脚本执行
# - 变量读写（get_var/set_var）
# ==============================================================================

name: "脚本执行测试"
description: "演示Python脚本执行和变量操作"

config:
  name: "测试配置"
  timeout: 60
  variables:
    counter: 0
  profiles:
    prod:
      base_url: "https://httpbin.org"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: Python脚本-设置变量
  # 类型: script
  # 用途：演示使用Python脚本设置变量
  # ----------------------------------------------------------------------------
  - name: "Python脚本-设置变量"
    description: "使用Python脚本设置变量"
    type: script
    # 脚本类型：python/javascript
    script_type: python  # 可选值: python/javascript
    # 是否允许导入模块（可选值：true/false）
    allow_imports: false
    # 脚本代码
    script: |
      # 设置变量
      set_var('username', 'testuser')
      set_var('email', 'test@example.com')
      set_var('age', 28)
      # 返回成功消息
      "Variables set successfully"

  # ----------------------------------------------------------------------------
  # 步骤2: 使用脚本变量发送请求
  # 类型: request
  # 用途：演示使用脚本设置的变量
  # ----------------------------------------------------------------------------
  - name: "使用脚本变量"
    description: "使用Python脚本设置的变量发送请求"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      username: "${username}"
      email: "${email}"
      age: "${age}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.username"
        expect: "testuser"
        description: "验证用户名正确"

  # ----------------------------------------------------------------------------
  # 步骤3: Python脚本-读取和修改变量
  # 类型: script
  # 用途：演示读取和修改变量
  # ----------------------------------------------------------------------------
  - name: "读取和修改变量"
    description: "读取变量并修改"
    type: script
    script_type: python
    script: |
      # 读取变量
      current_age = get_var('age')
      # 修改变量
      new_age = current_age + 1
      set_var('age', new_age)
      # 返回新年龄
      f"Age updated from {current_age} to {new_age}"

  # ----------------------------------------------------------------------------
  # 步骤4: 验证变量修改
  # 类型: request
  # 用途：验证变量已被修改
  # ----------------------------------------------------------------------------
  - name: "验证变量修改"
    description: "验证age变量已更新"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      username: "${username}"
      age: "${age}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.age"
        expect: "29"
        description: "验证年龄已更新为29"

  # ----------------------------------------------------------------------------
  # 步骤5: Python脚本-复杂数据处理
  # 类型: script
  # 用途：演示复杂数据处理和计算
  # ----------------------------------------------------------------------------
  - name: "复杂数据处理"
    description: "使用Python脚本进行数据处理"
    type: script
    script_type: python
    script: |
      # 计算数据
      numbers = [1, 2, 3, 4, 5]
      total = sum(numbers)
      average = total / len(numbers)
      # 设置结果变量
      set_var('total', total)
      set_var('average', average)
      set_var('count', len(numbers))
      f"Processed {len(numbers)} numbers: total={total}, average={average}"

  # ----------------------------------------------------------------------------
  # 步骤6: 使用计算结果
  # 类型: request
  # 用途：演示使用脚本计算的结果
  # ----------------------------------------------------------------------------
  - name: "使用计算结果"
    description: "使用Python脚本计算的结果"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      total: "${total}"
      average: "${average}"
      count: "${count}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.total"
        expect: "15"
        description: "验证总和为15"
      - type: eq
        path: "$.json.count"
        expect: "5"
        description: "验证数量为5"

  # ----------------------------------------------------------------------------
  # 步骤7: Python脚本-条件逻辑
  # 类型: script
  # 用途：演示条件逻辑和分支
  # ----------------------------------------------------------------------------
  - name: "条件逻辑处理"
    description: "演示Python脚本的条件逻辑"
    type: script
    script_type: python
    script: |
      # 获取变量
      age = get_var('age')
      # 条件判断
      if age >= 18:
        status = "adult"
        message = f"Age {age} is adult"
      else:
        status = "minor"
        message = f"Age {age} is minor"
      # 设置结果
      set_var('status', status)
      message

  # ----------------------------------------------------------------------------
  # 步骤8: 验证条件逻辑结果
  # 类型: request
  # ----------------------------------------------------------------------------
  - name: "验证条件逻辑"
    description: "验证条件逻辑的执行结果"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      age: "${age}"
      status: "${status}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.status"
        expect: "adult"
        description: "验证状态为adult"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "脚本执行"
  - "script"
  - "python"

enabled: true
