# ==============================================================================
# Sisyphus API Engine - 重试机制测试
# ==============================================================================
# 功能说明：演示简单重试和增强重试策略的使用
# - retry_times: 简单重试次数
# - retry_policy: 增强重试策略
#   - max_attempts: 最大重试次数
#   - strategy: 重试策略（fixed/exponential/linear）
#   - base_delay: 基础延迟时间（秒）
#   - max_delay: 最大延迟时间（秒）
#   - backoff_multiplier: 退避倍数
#   - jitter: 是否添加随机抖动
# ==============================================================================

name: "重试机制测试"
description: "演示简单重试和增强重试策略（fixed/exponential/linear）"

config:
  name: "测试配置"
  timeout: 60
  profiles:
    prod:
      base_url: "https://httpbin.org"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: 简单重试机制（retry_times）
  # 用途：演示基本的重试功能
  # 配置：retry_times: 3（失败后重试3次）
  # 注意：此步骤演示配置格式，实际重试行为需要配合失败场景
  # ----------------------------------------------------------------------------
  - name: "简单重试-配置演示"
    description: "演示简单重试机制的配置格式"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    # 简单重试配置（可选值：0-10，0表示不重试）
    retry_times: 3
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.url"
        expect: "https://httpbin.org/get"
        description: "验证URL正确"

  # ----------------------------------------------------------------------------
  # 步骤2: 固定延迟重试策略（fixed）
  # 用途：演示固定延迟的重试策略
  # 配置：strategy: fixed, base_delay: 1.0
  # 说明：每次重试前等待固定的时间（1秒）
  # ----------------------------------------------------------------------------
  - name: "固定延迟重试策略"
    description: "演示固定延迟重试策略，每次重试间隔1秒"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    retry_policy:
      max_attempts: 3
      strategy: fixed  # 可选值: fixed/exponential/linear
      base_delay: 1.0  # 可选值: 0.1-60.0
      max_delay: 5.0   # 可选值: 0.1-300.0
      jitter: false
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤3: 指数退避重试策略（exponential）
  # 用途：演示指数退避的重试策略
  # 配置：strategy: exponential, base_delay: 1.0, backoff_multiplier: 2.0
  # 说明：每次重试延迟时间为前一次的2倍（1秒、2秒、4秒...）
  # ----------------------------------------------------------------------------
  - name: "指数退避重试策略"
    description: "演示指数退避重试策略，延迟时间指数增长"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    retry_policy:
      max_attempts: 4
      strategy: exponential  # 指数退避策略
      base_delay: 1.0
      max_delay: 10.0
      backoff_multiplier: 2.0  # 退避倍数（可选值: 1.0-10.0）
      jitter: false
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤4: 线性增长重试策略（linear）
  # 用途：演示线性增长的重试策略
  # 配置：strategy: linear, base_delay: 1.0, backoff_multiplier: 1.5
  # 说明：每次重试延迟时间线性增长
  # ----------------------------------------------------------------------------
  - name: "线性增长重试策略"
    description: "演示线性增长重试策略，延迟时间线性增长"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    retry_policy:
      max_attempts: 3
      strategy: linear  # 线性增长策略
      base_delay: 1.0
      max_delay: 5.0
      backoff_multiplier: 1.5  # 增长因子
      jitter: false
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤5: 带随机抖动的重试策略
  # 用途：演示带随机抖动的重试策略，避免惊群效应
  # 配置：jitter: true
  # 说明：在延迟时间基础上添加随机抖动（±25%）
  # ----------------------------------------------------------------------------
  - name: "带随机抖动的重试策略"
    description: "演示带随机抖动的重试策略"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    retry_policy:
      max_attempts: 3
      strategy: fixed
      base_delay: 1.0
      max_delay: 5.0
      jitter: true  # 启用随机抖动（可选值: true/false）
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤6: 按错误类型重试（retry_on）
  # 用途：演示只对特定错误类型进行重试
  # 配置：retry_on: [network, timeout]
  # 说明：只有网络错误和超时错误才重试，其他错误不重试
  # ----------------------------------------------------------------------------
  - name: "按错误类型重试"
    description: "演示按错误类型选择性重试"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    retry_policy:
      max_attempts: 3
      strategy: fixed
      base_delay: 1.0
      # 按错误类型重试（可选值: network/timeout/assertion/validation/all）
      retry_on:
        - network    # 网络错误
        - timeout    # 超时错误
      # 按错误类型停止重试（可选值: network/timeout/assertion/validation/all）
      stop_on:
        - assertion  # 断言错误立即停止
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.url"
        expect: "https://httpbin.org/get"
        description: "验证URL正确"

  # ----------------------------------------------------------------------------
  # 步骤7: 成功场景（无需重试）
  # 用途：演示成功的请求不会触发重试
  # ----------------------------------------------------------------------------
  - name: "成功场景-无需重试"
    description: "演示成功的请求不会触发重试机制"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    retry_policy:
      max_attempts: 3
      strategy: fixed
      base_delay: 1.0
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.url"
        expect: "https://httpbin.org/get"
        description: "验证URL正确"

  # ----------------------------------------------------------------------------
  # 步骤8: 完整的重试策略配置
  # 用途：演示完整的重试策略配置
  # ----------------------------------------------------------------------------
  - name: "完整的重试策略配置"
    description: "演示完整的重试策略配置"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      test_data: "retry test"
      timestamp: "${timestamp()}"
    retry_policy:
      # 最大重试次数
      max_attempts: 5
      # 重试策略
      strategy: exponential
      # 基础延迟
      base_delay: 0.5
      # 最大延迟
      max_delay: 10.0
      # 退避倍数
      backoff_multiplier: 2.0
      # 随机抖动
      jitter: true
      # 按错误类型重试
      retry_on:
        - network
        - timeout
        - validation
      # 按错误类型停止
      stop_on:
        - assertion
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.test_data"
        expect: "retry test"
        description: "验证请求数据正确"

# ============================================================================
# 标签（用于测试用例分类和过滤）
# ============================================================================
tags:
  - "重试机制"
  - "retry"
  - "错误处理"

# 是否启用此测试用例（可选值: true/false）
enabled: true
