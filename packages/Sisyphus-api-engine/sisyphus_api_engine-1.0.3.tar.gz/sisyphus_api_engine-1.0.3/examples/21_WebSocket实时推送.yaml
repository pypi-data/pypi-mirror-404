# ==============================================================================
# Sisyphus API Engine - WebSocket实时推送测试
# ==============================================================================
# 功能说明：演示WebSocket实时推送功能的配置和使用
# - WebSocket连接
# - 消息推送
# - 实时通知
# ==============================================================================

name: "WebSocket实时推送测试"
description: "演示WebSocket实时推送功能的配置"

config:
  name: "WebSocket配置"
  timeout: 60

  # ========================================================================
  # WebSocket配置
  # ========================================================================
  websocket:
    # WebSocket服务器地址
    server_url: "ws://localhost:8888"

    # 是否启用SSL/TLS
    ssl_enabled: false

    # 心跳间隔（秒）
    heartbeat_interval: 30

    # 重连配置
    reconnect:
      # 是否自动重连
      enabled: true
      # 最大重连次数
      max_attempts: 5
      # 重连延迟（秒）
      delay: 5

    # 消息队列配置
    message_queue:
      # 队列大小
      size: 1000
      # 是否持久化
      persistent: false

  profiles:
    prod:
      base_url: "https://httpbin.org"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: WebSocket配置说明
  # 用途：说明WebSocket的基本配置
  # ----------------------------------------------------------------------------
  - name: "WebSocket配置说明"
    description: "演示WebSocket的配置格式和参数"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      feature: "WebSocket Real-time Push"
      description: "实时推送测试执行进度和结果"
      configuration:
        # WebSocket服务器
        server:
          url: "ws://localhost:8888"
          protocol: "WebSocket"
          version: "13"
        # 连接配置
        connection:
          timeout: 10
          ping_interval: 30
          ping_timeout: 5
        # 消息格式
        message_format:
          type: "json"
          encoding: "utf-8"
      features:
        - "实时进度推送"
        - "测试结果通知"
        - "性能指标上报"
        - "错误实时告警"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤2: WebSocket消息类型演示
  # 用途：说明WebSocket推送的各种消息类型
  # ----------------------------------------------------------------------------
  - name: "WebSocket消息类型"
    description: "演示WebSocket推送的各种消息类型"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      message_types:
        # 测试开始消息
        test_start:
          type: "test_start"
          data:
            test_case_id: "001"
            test_case_name: "用户登录测试"
            start_time: "2025-01-29T00:00:00Z"
        # 步骤开始消息
        step_start:
          type: "step_start"
          data:
            step_id: "001-01"
            step_name: "打开登录页面"
            step_index: 1
        # 进度更新消息
        progress:
          type: "progress"
          data:
            current_step: 5
            total_steps: 10
            progress_percent: 50
        # 步骤完成消息
        step_complete:
          type: "step_complete"
          data:
            step_id: "001-01"
            status: "passed"
            duration: 1.234
        # 测试完成消息
        test_complete:
          type: "test_complete"
          data:
            test_case_id: "001"
            status: "passed"
            duration: 10.567
            total_steps: 10
            passed_steps: 10
            failed_steps: 0
      message_format:
        content_type: "application/json"
        fields:
          - type
          - timestamp
          - data
          - metadata
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: length_eq
        path: "$.json.message_types"
        expect: 5
        description: "验证配置了5种消息类型"

  # ----------------------------------------------------------------------------
  # 步骤3: WebSocket实时进度推送
  # 用途：演示测试执行进度的实时推送
  # ----------------------------------------------------------------------------
  - name: "实时进度推送"
    description: "演示测试执行过程中的实时进度推送"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      event_type: "progress_update"
      test_info:
        test_case_name: "用户注册流程测试"
        total_steps: 10
      progress:
        current_step: 5
        step_name: "验证注册成功"
        status: "running"
        percentage: 50
      timing:
        elapsed_time: 5.234
        estimated_remaining: 5.0
      details:
        message: "正在执行第5个步骤"
        current_action: "验证用户注册响应"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤4: WebSocket测试结果通知
  # 用途：演示测试结果的实时通知
  # ----------------------------------------------------------------------------
  - name: "测试结果通知"
    description: "演示测试完成后的结果通知"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      event_type: "test_result"
      test_summary:
        test_case_name: "用户登录测试"
        status: "passed"
        start_time: "2025-01-29T00:00:00Z"
        end_time: "2025-01-29T00:00:10Z"
        duration: 10.567
      statistics:
        total_steps: 10
        passed_steps: 9
        failed_steps: 1
        skipped_steps: 0
        pass_rate: 90.0
      performance:
        avg_response_time: 0.5
        max_response_time: 1.2
        min_response_time: 0.2
      failed_steps:
        - step_name: "验证用户信息"
          error: "Assertion failed: 用户名不匹配"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤5: WebSocket性能指标上报
  # 用途：演示性能指标的实时上报
  # ----------------------------------------------------------------------------
  - name: "性能指标上报"
    description: "演示性能测试指标的实时上报"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      event_type: "performance_metrics"
      metrics:
        # 请求性能
        request:
          total_count: 100
          success_count: 98
          failure_count: 2
          avg_duration: 0.5
          p95_duration: 1.0
          p99_duration: 1.5
        # 系统资源
        system:
          cpu_usage: 45.5
          memory_usage: 68.2
          disk_io: 120.5
          network_io: 85.3
        # 并发指标
        concurrency:
          current_concurrent: 10
          max_concurrent: 50
          avg_concurrent: 25
      thresholds:
        - metric: "avg_duration"
          threshold: 1.0
          status: "passed"
        - metric: "failure_rate"
          threshold: 0.05
          actual: 0.02
          status: "passed"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤6: WebSocket错误实时告警
  # 用途：演示错误和异常的实时告警
  # ----------------------------------------------------------------------------
  - name: "错误实时告警"
    description: "演示测试过程中错误的实时告警"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      event_type: "error_alert"
      alert:
        level: "error"
        timestamp: "2025-01-29T00:00:00Z"
        test_case: "用户注册测试"
        step: "步骤5-验证邮箱格式"
      error_info:
        error_type: "AssertionError"
        error_message: "Validation failed: 邮箱格式不正确"
        stack_trace: "..."
      context:
        expected: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        actual: "invalid-email"
        path: "$.json.email"
      notification:
        recipients:
          - "qa-team@example.com"
          - "dev-team@example.com"
        channels:
          - "email"
          - "slack"
          - "webhook"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤7: WebSocket连接管理
  # 用途：演示WebSocket连接的生命周期管理
  # ----------------------------------------------------------------------------
  - name: "WebSocket连接管理"
    description: "演示WebSocket连接的建立、维持和关闭"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      connection_lifecycle:
        # 连接建立
        connect:
          event: "connected"
          server_url: "ws://localhost:8888"
          timestamp: "2025-01-29T00:00:00Z"
        # 心跳维持
        heartbeat:
          event: "ping"
          interval: 30
          timeout: 5
        # 连接断开
        disconnect:
          event: "disconnected"
          reason: "test_completed"
          timestamp: "2025-01-29T00:10:00Z"
      connection_states:
        - "connecting"
        - "connected"
        - "authenticating"
        - "authenticated"
        - "subscribing"
        - "subscribed"
        - "receiving"
        - "disconnecting"
        - "disconnected"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "WebSocket"
  - "实时推送"
  - "进度通知"
  - "实时监控"

enabled: true
