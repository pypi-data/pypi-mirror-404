# ==============================================================================
# Sisyphus API Engine - 并发执行测试
# ==============================================================================
# 功能说明：演示并发执行功能
# - 并发请求
# - 并发数量控制
# ==============================================================================

name: "并发执行测试"
description: "演示并发执行多个请求"

config:
  name: "测试配置"
  timeout: 60
  profiles:
    prod:
      base_url: "https://httpbin.org"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: 并发执行多个请求
  # 类型: concurrent
  # 用途：演示同时执行多个请求
  # ----------------------------------------------------------------------------
  - name: "并发执行3个请求"
    description: "同时并发执行3个GET请求"
    type: concurrent
    # 最大并发数（可选值：1-10）
    max_concurrency: 3
    # 并发执行的步骤列表
    concurrent_steps:
      - name: "并发请求1"
        type: request
        method: GET
        url: "${config.profiles.prod.base_url}/get?request=1"
        validations:
          - type: status_code
            path: "$.status_code"
            expect: "200"
          - type: contains
            path: "$.args.request"
            expect: "1"
            description: "验证请求参数"

      - name: "并发请求2"
        type: request
        method: GET
        url: "${config.profiles.prod.base_url}/get?request=2"
        validations:
          - type: status_code
            path: "$.status_code"
            expect: "200"
          - type: contains
            path: "$.args.request"
            expect: "2"
            description: "验证请求参数"

      - name: "并发请求3"
        type: request
        method: GET
        url: "${config.profiles.prod.base_url}/get?request=3"
        validations:
          - type: status_code
            path: "$.status_code"
            expect: "200"
          - type: contains
            path: "$.args.request"
            expect: "3"
            description: "验证请求参数"

  # ----------------------------------------------------------------------------
  # 步骤2: 并发执行不同类型的请求
  # 用途：演示并发执行GET和POST请求
  # ----------------------------------------------------------------------------
  - name: "并发执行GET和POST"
    description: "同时并发执行GET和POST请求"
    type: concurrent
    max_concurrency: 2
    concurrent_steps:
      - name: "并发GET请求"
        type: request
        method: GET
        url: "${config.profiles.prod.base_url}/get"
        validations:
          - type: status_code
            path: "$.status_code"
            expect: "200"

      - name: "并发POST请求"
        type: request
        method: POST
        url: "${config.profiles.prod.base_url}/post"
        headers:
          Content-Type: "application/json"
        body:
          concurrent_test: true
          request_type: "POST"
        validations:
          - type: status_code
            path: "$.status_code"
            expect: "200"
          - type: eq
            path: "$.json.concurrent_test"
            expect: true
            description: "验证并发测试字段"

  # ----------------------------------------------------------------------------
  # 步骤3: 并发执行后验证
  # 用途：验证所有并发请求都已完成
  # ----------------------------------------------------------------------------
  - name: "并发后验证"
    description: "验证所有并发请求执行完成"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.url"
        expect: "https://httpbin.org/get"
        description: "验证URL正确"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "并发执行"
  - "concurrent"
  - "性能测试"

enabled: true
