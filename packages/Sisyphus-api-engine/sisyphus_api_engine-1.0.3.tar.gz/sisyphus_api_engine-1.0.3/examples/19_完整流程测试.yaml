# ==============================================================================
# Sisyphus API Engine - 完整流程测试
# ==============================================================================
# 功能说明：综合运用所有功能的完整测试流程
# 涵盖功能：
# - 多环境配置
# - 变量引用和提取
# - 请求方法（GET/POST/PUT/DELETE）
# - 断言验证
# - 重试机制
# - 步骤控制
# - 等待机制
# - 脚本执行
# ==============================================================================

name: "完整流程测试"
description: "综合运用所有功能的完整API测试流程"

config:
  name: "完整测试配置"
  timeout: 120
  variables:
    base_url: "https://httpbin.org"
    user_id: "10086"
    test_mode: true
  profiles:
    dev:
      base_url: "https://httpbin.org"
      variables:
        env: "dev"
        timeout: 10
    prod:
      base_url: "https://httpbin.org"
      variables:
        env: "prod"
        timeout: 30
  active_profile: "prod"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ============================================================================
  # 阶段1：用户注册流程
  # ============================================================================
  - name: "步骤1-生成用户数据"
    description: "使用脚本生成测试用户数据"
    type: script
    script_type: python
    script: |
      import random
      import string
      # 生成随机用户名
      username = 'user_' + ''.join(random.choices(string.ascii_lowercase, k=8))
      # 生成随机邮箱
      email = f'{username}@example.com'
      # 生成随机年龄
      age = random.randint(18, 65)
      # 设置变量
      set_var('test_username', username)
      set_var('test_email', email)
      set_var('test_age', age)
      set_var('user_created', False)
      f"Generated user: {username}, {email}, age={age}"

  - name: "步骤2-注册用户"
    description: "发送POST请求注册新用户"
    type: request
    method: POST
    url: "${config.variables.base_url}/post"
    headers:
      Content-Type: "application/json"
      X-Environment: "${config.profiles.prod.variables.env}"
    body:
      username: "${test_username}"
      email: "${test_email}"
      age: "${test_age}"
      action: "register"
    # 重试配置
    retry_policy:
      max_attempts: 3
      strategy: fixed
      base_delay: 1.0
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.action"
        expect: "register"
        description: "验证操作类型"
    # 提取响应数据
    extractors:
      - type: jsonpath
        name: user_id
        path: "$.body.json.username"
        description: "提取用户名"

  - name: "步骤3-等待处理"
    description: "等待2秒模拟后台处理"
    type: wait
    wait_type: delay
    duration: 2.0

  # ============================================================================
  # 阶段2：用户信息查询
  # ============================================================================
  - name: "步骤4-查询用户信息"
    description: "使用GET请求查询用户信息"
    type: request
    method: GET
    url: "${config.variables.base_url}/get?user=${user_id}"
    headers:
      X-Request-Type: "query"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: contains
        path: "$.args.user"
        expect: "user_"
        description: "验证用户参数"

  - name: "步骤5-验证用户数据"
    description: "使用脚本验证用户数据完整性"
    type: script
    script_type: python
    script: |
      # 获取用户变量
      username = get_var('test_username')
      email = get_var('test_email')
      age = get_var('test_age')
      # 验证数据
      if username and email and age:
        set_var('user_created', True)
        return "User data validation passed"
      else:
        return "User data validation failed"

  # ============================================================================
  # 阶段3：用户信息更新
  # ============================================================================
  - name: "步骤6-更新用户信息"
    description: "使用PUT请求更新用户信息"
    type: request
    method: PUT
    url: "${config.variables.base_url}/put"
    headers:
      Content-Type: "application/json"
    body:
      username: "${test_username}"
      email: "${test_email}"
      age: "${test_age}"
      action: "update"
      updated_at: "${timestamp()}"
    # 条件执行：只有用户创建成功才执行
    only_if: "${user_created}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.action"
        expect: "update"
        description: "验证操作为update"
      - type: exists
        path: "$.json.updated_at"
        expect: true
        description: "验证更新时间存在"

  # ============================================================================
  # 阶段4：数据验证和清理
  # ============================================================================
  - name: "步骤7-验证所有操作"
    description: "综合验证所有操作结果"
    type: request
    method: POST
    url: "${config.variables.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      summary:
        username: "${test_username}"
        email: "${test_email}"
        age: "${test_age}"
        user_id: "${user_id}"
        created: "${user_created}"
        environment: "${config.profiles.prod.variables.env}"
      operations:
        - "register"
        - "query"
        - "update"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.summary.created"
        expect: "True"
        description: "验证用户已创建"
      - type: contains
        path: "$.json.summary.environment"
        expect: "prod"
        description: "验证生产环境"

  - name: "步骤8-统计测试结果"
    description: "使用脚本统计测试结果"
    type: script
    script_type: python
    script: |
      # 获取测试变量
      username = get_var('test_username')
      created = get_var('user_created')
      # 统计结果
      results = {
          'username': username,
          'created': created,
          'operations_completed': 3,
          'tests_passed': 7
      }
      # 设置结果变量
      set_var('test_results', results)
      f"Test completed: {results['operations_completed']} operations, {results['tests_passed']} tests passed"

  # ============================================================================
  # 阶段5：清理（可选）
  # ============================================================================
  - name: "步骤9-清理测试数据"
    description: "使用DELETE请求清理测试数据（可选）"
    type: request
    method: DELETE
    url: "${config.variables.base_url}/delete"
    headers:
      Content-Type: "application/json"
    body:
      username: "${test_username}"
      cleanup: true
    # 条件跳过：如果test_mode为true则跳过清理
    skip_if: "${config.variables.test_mode}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证删除成功"

  - name: "步骤10-最终验证"
    description: "最终验证整个测试流程"
    type: request
    method: GET
    url: "${config.variables.base_url}/get"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证服务可用"
      - type: eq
        path: "$.url"
        expect: "https://httpbin.org/get"
        description: "验证URL正确"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "完整流程"
  - "综合测试"
  - "integration"

enabled: true
