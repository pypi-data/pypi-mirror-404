# ==============================================================================
# Sisyphus API Engine - Mock服务器测试
# ==============================================================================
# 功能说明：演示Mock服务器的配置和使用
# - Mock服务器启动
# - Mock路由配置
# - Mock响应设置
# - Mock服务器停止
# ==============================================================================

name: "Mock服务器测试"
description: "演示Mock服务器的配置和使用"

config:
  name: "Mock服务器配置"
  timeout: 60
  profiles:
    prod:
      base_url: "https://httpbin.org"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: Mock服务器配置说明
  # 用途：说明Mock服务器的基本配置
  # ----------------------------------------------------------------------------
  - name: "Mock服务器配置说明"
    description: "演示Mock服务器的配置格式和参数"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      feature: "Mock Server"
      description: "模拟HTTP服务器响应"
      configuration:
        # Mock服务器配置
        mock_server:
          # 服务器地址
          host: "localhost"
          # 服务器端口
          port: 8888
          # 是否启用HTTPS
          https: false
        # Mock路由配置
        routes:
          - path: "/api/users"
            method: "GET"
            response:
              status_code: 200
              body:
                users:
                  - id: 1
                    name: "Mock User 1"
                  - id: 2
                    name: "Mock User 2"
          - path: "/api/users/{id}"
            method: "GET"
            response:
              status_code: 200
              body:
                id: "{id}"
                name: "Mock User"
      features:
        - "快速原型开发"
        - "独立测试环境"
        - "模拟各种响应场景"
        - "无需依赖后端服务"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: eq
        path: "$.json.feature"
        expect: "Mock Server"
        description: "验证功能名称"

  # ----------------------------------------------------------------------------
  # 步骤2: Mock GET请求示例
  # 用途：演示Mock GET请求的配置
  # ----------------------------------------------------------------------------
  - name: "Mock GET请求配置"
    description: "演示Mock GET请求的路由和响应配置"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      mock_route:
        # 请求路径
        path: "/api/users"
        # 请求方法
        method: "GET"
        # 响应配置
        response:
          # HTTP状态码
          status_code: 200
          # 响应头
          headers:
            Content-Type: "application/json"
            X-Mock: "true"
          # 响应体
          body:
            code: 0
            message: "success"
            data:
              users:
                - id: 1
                  username: "mock_user_1"
                  email: "mock1@example.com"
                - id: 2
                  username: "mock_user_2"
                  email: "mock2@example.com"
      usage_example:
        description: "当访问 http://localhost:8888/api/users 时返回模拟数据"
        curl_command: "curl http://localhost:8888/api/users"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤3: Mock POST请求示例
  # 用途：演示Mock POST请求的配置
  # ----------------------------------------------------------------------------
  - name: "Mock POST请求配置"
    description: "演示Mock POST请求的路由和响应配置"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      mock_route:
        path: "/api/users"
        method: "POST"
        response:
          status_code: 201
          headers:
            Content-Type: "application/json"
          body:
            code: 0
            message: "User created successfully"
            data:
              id: 100
              username: "new_user"
              created_at: "2025-01-29T00:00:00Z"
      features:
        - "支持创建资源"
        - "返回201状态码"
        - "包含创建的资源信息"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤4: Mock动态响应示例
  # 用途：演示根据请求参数动态生成响应
  # ----------------------------------------------------------------------------
  - name: "Mock动态响应配置"
    description: "演示根据请求参数动态生成Mock响应"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      mock_route:
        path: "/api/users/{user_id}"
        method: "GET"
        response:
          status_code: 200
          # 动态响应：使用路径参数
          body:
            id: "${path_params.user_id}"
            username: "mock_user_${path_params.user_id}"
            email: "mock${path_params.user_id}@example.com"
      advanced_features:
        - "路径参数提取"
        - "查询参数处理"
        - "请求体解析"
        - "条件响应"
        - "延迟响应模拟"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤5: Mock错误响应示例
  # 用途：演示Mock各种错误响应场景
  # ----------------------------------------------------------------------------
  - name: "Mock错误响应配置"
    description: "演示Mock各种错误响应场景的配置"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      error_scenarios:
        # 404错误
        - route: "/api/users/999"
          method: "GET"
          response:
            status_code: 404
            body:
              code: 404
              message: "User not found"
        # 500错误
        - route: "/api/error"
          method: "GET"
          response:
            status_code: 500
            body:
              code: 500
              message: "Internal server error"
        # 401错误
        - route: "/api/protected"
          method: "GET"
          response:
            status_code: 401
            body:
              code: 401
              message: "Unauthorized"
      error_testing:
        description: "使用Mock服务器测试各种错误场景"
        benefits:
          - "无需实际后端"
          - "快速验证错误处理"
          - "测试边界条件"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"
      - type: length_eq
        path: "$.json.error_scenarios"
        expect: 3
        description: "验证配置了3种错误场景"

  # ----------------------------------------------------------------------------
  # 步骤6: Mock延迟响应示例
  # 用途：演示模拟慢速API响应
  # ----------------------------------------------------------------------------
  - name: "Mock延迟响应配置"
    description: "演示Mock服务器延迟响应配置"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      mock_route:
        path: "/api/slow"
        method: "GET"
        response:
          status_code: 200
          delay: 5000  # 延迟5秒（毫秒）
          body:
            code: 0
            message: "Slow response"
      use_cases:
        - "测试超时处理"
        - "测试加载状态"
        - "测试重试机制"
        - "测试用户体验"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤7: Mock综合示例
  # 用途：演示完整的Mock服务器配置
  # ----------------------------------------------------------------------------
  - name: "Mock服务器综合配置"
    description: "演示完整的Mock服务器配置和使用流程"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      mock_server_config:
        # 服务器配置
        server:
          host: "localhost"
          port: 8888
          # 日志级别
          log_level: "debug"
        # 路由配置
        routes:
          # 用户列表
          - path: "/api/users"
            method: GET
            response:
              status_code: 200
              body:
                users: []
          # 用户详情
          - path: "/api/users/{id}"
            method: GET
            response:
              status_code: 200
              body:
                id: "${path_params.id}"
                name: "User ${path_params.id}"
          # 创建用户
          - path: "/api/users"
            method: POST
            response:
              status_code: 201
              body:
                id: 101
                message: "Created"
          # 更新用户
          - path: "/api/users/{id}"
            method: PUT
            response:
              status_code: 200
              body:
                id: "${path_params.id}"
                message: "Updated"
          # 删除用户
          - path: "/api/users/{id}"
            method: DELETE
            response:
              status_code: 204
              body: null
      usage_workflow:
        step1: "启动Mock服务器"
        step2: "配置Mock路由"
        step3: "执行测试用例"
        step4: "验证响应结果"
        step5: "停止Mock服务器"
      benefits:
        - "隔离测试环境"
        - "提高测试速度"
        - "模拟边缘情况"
        - "降低测试成本"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证状态码为200"

  # ----------------------------------------------------------------------------
  # 步骤6: Mock条件判断 - 基于请求体的条件
  # 用途：演示根据请求内容返回不同的响应
  # 场景：金额超限时返回错误，否则返回成功
  # ----------------------------------------------------------------------------
  - name: "Mock条件判断示例-请求体条件"
    description: "演示基于请求体的条件Mock"
    type: request
    method: POST
    url: "http://localhost:8888/payment/create"
    headers:
      Content-Type: "application/json"
    body:
      amount: 150
      currency: "USD"
    # 配置Mock响应
    mock:
      enabled: true
      rules:
        - name: "payment-amount-check"
          priority: 10
          request:
            method: "POST"
            url: "/payment/create"
          # 条件判断：金额大于100时返回错误
          condition: "${request.body.amount > 100}"
          response:
            status_code: 200
            body:
              code: 1
              msg: "金额超限"
              data: null
          # 条件为假时的响应
          else_response:
            status_code: 200
            body:
              code: 0
              msg: "success"
              data:
                payment_id: "MOCK_123"
    validations:
      - type: eq
        path: "$.json.body.code"
        expect: 1
        description: "验证返回超限错误"

  # ----------------------------------------------------------------------------
  # 步骤7: Mock条件判断 - 基于请求路径和方法的条件
  # 用途：演示根据不同的API版本返回不同的响应
  # 场景：v1和v2 API返回不同的版本号
  # ----------------------------------------------------------------------------
  - name: "Mock条件判断示例-API版本"
    description: "演示基于API路径的条件Mock"
    type: request
    method: POST
    url: "http://localhost:8888/api/v1/test"
    headers:
      Content-Type: "application/json"
    body:
      test: "data"
    # 配置Mock响应
    mock:
      enabled: true
      rules:
        # v1 API的Mock规则
        - name: "api-v1-handler"
          priority: 10
          request:
            method: "POST"
            url: "/api/v1/.*"
          # 条件：路径匹配v1
          condition: "'/api/v1/' in request.path"
          response:
            status_code: 200
            body:
              version: "v1"
              message: "API v1 response"
        # v2 API的Mock规则
        - name: "api-v2-handler"
          priority: 10
          request:
            method: "POST"
            url: "/api/v2/.*"
          # 条件：路径匹配v2
          condition: "'/api/v2/' in request.path"
          response:
            status_code: 200
            body:
              version: "v2"
              message: "API v2 response"
    validations:
      - type: eq
        path: "$.json.body.version"
        expect: "v1"
        description: "验证返回v1版本"

  # ----------------------------------------------------------------------------
  # 步骤8: Mock条件判断 - 基于请求头的条件
  # 用途：演示根据请求头返回不同的响应
  # 场景：带有特殊token的请求返回额外数据
  # ----------------------------------------------------------------------------
  - name: "Mock条件判断示例-请求头条件"
    description: "演示基于请求头的条件Mock"
    type: request
    method: GET
    url: "http://localhost:8888/api/data"
    headers:
      Content-Type: "application/json"
      X-Special-Token: "secret_token"
    # 配置Mock响应
    mock:
      enabled: true
      rules:
        - name: "premium-data-handler"
          priority: 10
          request:
            method: "GET"
            url: "/api/data"
          # 条件：请求头包含特殊token
          condition: "request.headers.get('X-Special-Token') == 'secret_token'"
          response:
            status_code: 200
            body:
              role: "premium"
              data:
                field1: "value1"
                field2: "value2"
          # 条件为假时的响应（普通用户）
          else_response:
            status_code: 200
            body:
              role: "guest"
              data:
                field1: "limited_value"
    validations:
      - type: eq
        path: "$.json.body.role"
        expect: "premium"
        description: "验证返回premium角色"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "Mock服务器"
  - "mock"
  - "模拟响应"
  - "测试隔离"
  - "条件判断"

enabled: true
