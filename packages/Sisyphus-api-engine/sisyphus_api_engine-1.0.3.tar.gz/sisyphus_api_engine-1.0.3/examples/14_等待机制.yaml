# ==============================================================================
# Sisyphus API Engine - 等待机制测试
# ==============================================================================
# 功能说明：演示等待机制
# - 固定延迟等待
# - 条件等待
# ==============================================================================

name: "等待机制测试"
description: "演示固定延迟和条件等待"

config:
  name: "测试配置"
  timeout: 60
  profiles:
    prod:
      base_url: "https://httpbin.org"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: 固定延迟等待（2秒）
  # 类型: wait
  # 用途：演示固定延迟等待
  # ----------------------------------------------------------------------------
  - name: "固定延迟等待2秒"
    description: "等待2秒后继续执行"
    type: wait
    # 等待类型：delay（固定延迟）
    wait_type: delay
    # 延迟时间（秒）
    duration: 2.0

  # ----------------------------------------------------------------------------
  # 步骤2: 固定延迟等待（1秒）
  # 用途：演示不同的延迟时间
  # ----------------------------------------------------------------------------
  - name: "固定延迟等待1秒"
    description: "等待1秒后继续执行"
    type: wait
    wait_type: delay
    duration: 1.0

  # ----------------------------------------------------------------------------
  # 步骤3: 条件等待（最多等待10秒）
  # 类型: wait
  # 用途：演示条件等待功能
  # 注意：此示例演示配置格式，实际使用需要配合会返回动态状态的API
  # ----------------------------------------------------------------------------
  - name: "条件等待示例"
    description: "演示条件等待配置（最多等待10秒）"
    type: wait
    # 等待类型：condition（条件等待）
    wait_type: condition
    # 最大等待时间（秒）
    timeout: 10.0
    # 轮询间隔（秒）
    interval: 1.0
    # 等待条件（示例：检查某个变量或条件）
    # 注意：实际条件表达式需要根据具体场景配置
    condition: "${config.variables.condition_met}"

  # ----------------------------------------------------------------------------
  # 步骤4: 在请求之间使用延迟
  # 用途：演示在API请求之间添加延迟
  # ----------------------------------------------------------------------------
  - name: "第一个请求"
    description: "发送第一个请求"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 步骤5: 延迟3秒
  # ----------------------------------------------------------------------------
  - name: "延迟3秒"
    description: "在请求之间等待3秒"
    type: wait
    wait_type: delay
    duration: 3.0

  # ----------------------------------------------------------------------------
  # 步骤6: 第二个请求
  # 用途：验证延迟后继续执行
  # ----------------------------------------------------------------------------
  - name: "第二个请求"
    description: "延迟后发送第二个请求"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.url"
        expect: "https://httpbin.org/get"
        description: "验证URL正确"

  # ----------------------------------------------------------------------------
  # 步骤7: API条件等待示例
  # 类型: wait (wait_condition)
  # 用途：等待API响应满足特定条件
  # 场景：轮询检查异步任务状态，直到完成
  # ----------------------------------------------------------------------------
  - name: "API条件等待示例"
    description: "等待API响应满足条件（演示配置）"
    type: wait
    # 条件等待配置
    wait_condition:
      type: "api"  # 类型：api
      timeout: 30.0  # 最大等待30秒
      interval: 2.0  # 每2秒轮询一次
      # API请求配置
      request:
        method: "GET"
        url: "${config.profiles.prod.base_url}/status/200"
        headers: {}
      # 检查条件（Jinja2模板表达式）
      # 可用变量：status_code, body, headers, response
      check: "${status_code == 200}"

  # ----------------------------------------------------------------------------
  # 步骤8: Database条件等待示例
  # 类型: wait (wait_condition)
  # 用途：等待数据库查询结果满足特定条件
  # 场景：等待数据入库或状态变更
  # ----------------------------------------------------------------------------
  - name: "Database条件等待示例"
    description: "等待数据库查询结果满足条件（演示配置）"
    type: wait
    # 条件等待配置
    wait_condition:
      type: "database"  # 类型：database
      timeout: 10.0  # 最大等待10秒
      interval: 1.0  # 每1秒轮询一次
      # 数据库配置
      database:
        type: "sqlite"
        connection: "test.db"
      # SQL查询
      sql: "SELECT status FROM orders WHERE order_id = %s"
      params: ["${order_id}"]
      # 检查条件（Jinja2模板表达式）
      # 可用变量：result, rows, row
      check: "${row.status == 'confirmed'}"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "等待机制"
  - "延迟"
  - "条件等待"
  - "API条件等待"
  - "Database条件等待"

enabled: true
