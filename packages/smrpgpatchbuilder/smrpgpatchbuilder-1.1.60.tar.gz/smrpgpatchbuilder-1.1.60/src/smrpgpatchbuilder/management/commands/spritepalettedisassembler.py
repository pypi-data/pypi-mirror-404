"""Django management command to disassemble sprite palettes from ROM and generate Python definitions."""

from django.core.management.base import BaseCommand
from pathlib import Path

from smrpgpatchbuilder.datatypes.sprites.ids.misc import (
    COLORS_PER_PALETTE,
    PALETTE_SIZE,
    SPRITE_PALETTE_OFFSET,
    TOTAL_SPRITE_PALETTES,
)
from smrpgpatchbuilder.datatypes.sprites.palette import snes_bytes_to_color


class Command(BaseCommand):
    help = "Disassemble sprite palettes from ROM and generate Python palette definitions"

    def add_arguments(self, parser):
        parser.add_argument(
            "-r",
            "--rom",
            dest="rom",
            required=True,
            help="Path to a Mario RPG ROM file",
        )
        parser.add_argument(
            "-o",
            "--output",
            dest="output",
            default="src/disassembler_output/sprite_palettes/sprite_palettes.py",
            help="Output file path",
        )

    def handle(self, *args, **options):
        rom_path = options["rom"]
        output_path = options["output"]

        # read rom
        with open(rom_path, "rb") as f:
            rom = bytearray(f.read())

        # generate output
        output_lines = []
        output_lines.append("# AUTOGENERATED DO NOT EDIT!!")
        output_lines.append("# Run the following command to rebuild:")
        output_lines.append("# python manage.py spritepalettedisassembler --rom <ROM_PATH>")
        output_lines.append("")
        output_lines.append("from smrpgpatchbuilder.datatypes.sprites.palette import (")
        output_lines.append("    SpritePalette,")
        output_lines.append("    SpritePaletteCollection,")
        output_lines.append(")")
        output_lines.append("from smrpgpatchbuilder.datatypes.sprites.ids.sprite_palettes import (")
        # Generate SPAL constant imports
        spal_imports = [f"SPAL{i:03d}" for i in range(TOTAL_SPRITE_PALETTES)]
        # Break into chunks for readability
        chunk_size = 10
        for i in range(0, len(spal_imports), chunk_size):
            chunk = spal_imports[i:i + chunk_size]
            output_lines.append(f"    {', '.join(chunk)},")
        output_lines.append(")")
        output_lines.append("")
        output_lines.append("")

        # process each palette
        palette_names = []
        for pal_id in range(TOTAL_SPRITE_PALETTES):
            offset = SPRITE_PALETTE_OFFSET + pal_id * PALETTE_SIZE
            palette_bytes = rom[offset:offset + PALETTE_SIZE]

            # Convert bytes to colors
            colors = []
            for i in range(COLORS_PER_PALETTE):
                byte1 = palette_bytes[i * 2]
                byte2 = palette_bytes[i * 2 + 1]
                color = snes_bytes_to_color(byte1, byte2)
                colors.append(color)

            # Generate palette definition
            pal_name = f"SPRITE_PALETTE_{pal_id:03d}"
            palette_names.append(pal_name)

            output_lines.append(f"{pal_name} = SpritePalette(SPAL{pal_id:03d}, [")
            # Write colors in groups of 5 for readability
            for i in range(0, COLORS_PER_PALETTE, 5):
                chunk = colors[i:i + 5]
                color_strs = [f"0x{c:06X}" for c in chunk]
                output_lines.append(f"    {', '.join(color_strs)},")
            output_lines.append("])")
            output_lines.append("")

        # generate SpritePaletteCollection
        output_lines.append("")
        output_lines.append("# Sprite palette collection containing all palettes")
        output_lines.append("ALL_SPRITE_PALETTES = SpritePaletteCollection([")
        # Write in groups for readability
        for i in range(0, len(palette_names), 5):
            chunk = palette_names[i:i + 5]
            output_lines.append(f"    {', '.join(chunk)},")
        output_lines.append("])")
        output_lines.append("")

        # write output file
        output_file = Path(output_path)
        output_file.parent.mkdir(parents=True, exist_ok=True)
        output_file.write_text("\n".join(output_lines))

        # generate __init__.py with all palette imports
        init_lines = []
        init_lines.append("# AUTOGENERATED DO NOT EDIT!!")
        init_lines.append("# This file imports all sprite palette definitions from sprite_palettes.py")
        init_lines.append("")
        init_lines.append("from .sprite_palettes import (")
        for name in palette_names:
            init_lines.append(f"    {name},")
        init_lines.append("    ALL_SPRITE_PALETTES,")
        init_lines.append(")")
        init_lines.append("")

        init_file = output_file.parent / "__init__.py"
        init_file.write_text("\n".join(init_lines))

        self.stdout.write(
            self.style.SUCCESS(f"Successfully generated {TOTAL_SPRITE_PALETTES} sprite palette definitions to {output_path}")
        )
        self.stdout.write(
            self.style.SUCCESS(f"Successfully generated __init__.py with {len(palette_names)} palette imports")
        )
