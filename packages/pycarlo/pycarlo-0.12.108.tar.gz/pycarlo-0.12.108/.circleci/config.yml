version: 2.1

deploy_filter:
  &deploy_filter # YAML reference for tag based filtering on deployments
  filters:
    tags:
      only: /^v.*/
    branches:
      ignore: /.*/

test_steps: &test_steps
  steps:
    - checkout
    - run:
        name: Update pip
        command: pip install --upgrade pip
    - run:
        name: Run tests and checks
        command: |
          make install
          make test

sanity_check: &sanity_check_steps
  steps:
    - checkout
    - run:
        name: Make Sanity Check
        command: |
          make install
          echo "MCD_API_ENDPOINT=https://api.getmontecarlo.com/graphql" > utils/.env
          echo "MCD_DEFAULT_API_ID=${MCD_DEFAULT_API_ID}" >> utils/.env
          echo "MCD_DEFAULT_API_TOKEN=${MCD_DEFAULT_API_TOKEN}" >> utils/.env
          make sanity-check

jobs:
  run-test-3-8:
    docker:
      - image: python:3.8
    <<: *test_steps

  run-test-3-9:
    docker:
      - image: python:3.9
    <<: *test_steps

  run-test-3-10:
    docker:
      - image: python:3.10
    <<: *test_steps

  run-test-3-11:
    docker:
      - image: python:3.11
    <<: *test_steps

  run-test-3-12:
    docker:
      - image: python:3.12
    <<: *test_steps

  run-sanity-check:
    docker:
      - image: python:3.9
    <<: *sanity_check_steps

  deploy: # cci-ignore
    docker:
      - image: python:3.8.6

    steps:
      - checkout
      - run:
          name: Deploy to PyPI
          command: make distribute

workflows:
  build:
    jobs:
      - run-test-3-8
      - run-test-3-9
      - run-test-3-10
      - run-test-3-11
      - run-test-3-12
      - run-sanity-check:
          context: mc-prod # cci-ignore

  deploy: # cci-ignore
    jobs:
      - run-test-3-8:
          <<: *deploy_filter
      - run-test-3-9:
          <<: *deploy_filter
      - run-test-3-10:
          <<: *deploy_filter
      - run-test-3-11:
          <<: *deploy_filter
      - run-test-3-12:
          <<: *deploy_filter
      - run-sanity-check:
          context: mc-prod # cci-ignore
          <<: *deploy_filter
      - deploy:
          requires:
            - run-test-3-8
            - run-test-3-9
            - run-test-3-10
            - run-test-3-11
            - run-test-3-12
            - run-sanity-check
          <<: *deploy_filter
