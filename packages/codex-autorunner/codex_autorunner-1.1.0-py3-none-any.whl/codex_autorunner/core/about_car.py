from __future__ import annotations

from pathlib import Path
from typing import Mapping, Optional

from .config import (
    REPO_OVERRIDE_FILENAME,
    ROOT_CONFIG_FILENAME,
    ROOT_OVERRIDE_FILENAME,
    Config,
    find_nearest_hub_config_path,
)

ABOUT_CAR_BASENAME = "ABOUT_CAR.md"
ABOUT_CAR_REL_PATH = Path(".codex-autorunner") / ABOUT_CAR_BASENAME

# If this marker is present, codex-autorunner may safely refresh the file content.
ABOUT_CAR_GENERATED_MARKER = "<!-- CAR:AUTOGENERATED -->"

CAR_CONTEXT_KEYWORDS = (
    "car",
    "codex",
    "spec",
    "autorunner",
    "workspace",
    "ticket",
    "tickets",
    "context",
    "decision",
    "decisions",
    "handoff",
    "dispatch",
    "inbox",
)

CAR_CONTEXT_HINT = (
    "Context: read .codex-autorunner/ABOUT_CAR.md for repo-specific rules."
)


def _display_path(repo_root: Path, path: Path) -> str:
    try:
        return str(path.relative_to(repo_root))
    except ValueError:
        return str(path)


def build_about_car_markdown(
    *,
    repo_root: Path,
    active_context_path: Path,
    decisions_path: Path,
    spec_path: Path,
    hub_config_path: Optional[Path] = None,
    repo_override_path: Optional[Path] = None,
) -> str:
    hub_config_path = (
        hub_config_path
        or find_nearest_hub_config_path(repo_root)
        or (repo_root / ".codex-autorunner" / "config.yml")
    )
    repo_override_path = repo_override_path or (repo_root / REPO_OVERRIDE_FILENAME)
    root_config_path = repo_root / ROOT_CONFIG_FILENAME
    root_override_path = repo_root / ROOT_OVERRIDE_FILENAME
    active_context_disp = _display_path(repo_root, active_context_path)
    decisions_disp = _display_path(repo_root, decisions_path)
    spec_disp = _display_path(repo_root, spec_path)
    hub_config_disp = _display_path(repo_root, hub_config_path)
    repo_override_disp = _display_path(repo_root, repo_override_path)
    root_config_disp = _display_path(repo_root, root_config_path)
    root_override_disp = _display_path(repo_root, root_override_path)

    return (
        f"{ABOUT_CAR_GENERATED_MARKER}\n"
        "# ABOUT_CAR â€” Codex Autorunner (CAR)\n\n"
        "You are running inside **Codex Autorunner (CAR)**.\n\n"
        "CAR uses a ticket-first workflow.\n\n"
        "## Required for operation\n"
        "- Tickets live under `.codex-autorunner/tickets/`.\n"
        "- Lint ticket frontmatter after edits (runs against all tickets): `python3 .codex-autorunner/bin/lint_tickets.py`.\n\n"
        "## Optional workspace docs\n"
        "- **Active context**: "
        f"`{active_context_disp}`\n"
        "- **Decisions**: "
        f"`{decisions_disp}`\n"
        "- **Spec**: "
        f"`{spec_disp}`\n\n"
        "## Critical rules\n"
        "- Do **not** create new copies of workspace docs elsewhere in the repo.\n"
        "- Treat `.codex-autorunner/` as intentional project structure even though it is hidden/gitignored.\n\n"
        "## Agent Flow\n"
        "- **Dispatch**: An update or message from the agent.\n"
        "- **Handoff**: Passing control from agent to user (or vice versa).\n"
        "- **Inbox**: Where the agent receives files/messages.\n\n"
        "## Ticket helpers\n"
        "- Use `.codex-autorunner/bin/ticket_tool.py` to list/create/insert/move tickets; it is portable and venv-free.\n"
        '- Common workflows: insert gap before N (`python3 .codex-autorunner/bin/ticket_tool.py insert --before N`); move a block (`... move --start A --end B --to T`); create with auto-quoted frontmatter (`... create --title "Fix #123" --agent codex`).\n'
        "- After any ticket edits, lint all tickets: `python3 .codex-autorunner/bin/lint_tickets.py`.\n\n"
        "## How CAR works (short)\n"
        "- The web UI provides ticket editing + unified file chat.\n"
        "- `car serve` starts the hub web UI. The **Terminal** tab launches the configured `codex` binary in a PTY.\n"
        f"- Hub config lives at `{hub_config_disp}` (generated).\n"
        f"- Repo overrides (optional) live at `{repo_override_disp}`.\n"
        f"- Root defaults live at `{root_config_disp}` with optional `{root_override_disp}` overrides.\n"
    )


def ensure_about_car_file_for_repo(
    repo_root: Path,
    *,
    doc_paths: Mapping[str, Path],
    force: bool = False,
) -> Path:
    """
    Ensure `.codex-autorunner/ABOUT_CAR.md` exists for this repo.

    If the file already exists and contains the generated marker, it may be refreshed
    (unless force=False and content already matches).
    """
    path = repo_root / ABOUT_CAR_REL_PATH
    path.parent.mkdir(parents=True, exist_ok=True)

    content = build_about_car_markdown(
        repo_root=repo_root,
        active_context_path=doc_paths["active_context"],
        decisions_path=doc_paths["decisions"],
        spec_path=doc_paths["spec"],
    )
    if content and not content.endswith("\n"):
        content += "\n"

    if path.exists() and not force:
        try:
            existing = path.read_text(encoding="utf-8")
        except OSError:
            existing = ""
        # Only overwrite if it's our generated file (marker) and content changed.
        if ABOUT_CAR_GENERATED_MARKER not in existing:
            return path
        if existing == content:
            return path

    path.write_text(content, encoding="utf-8")
    return path


def ensure_about_car_file(config: Config, *, force: bool = False) -> Path:
    """Config-aware wrapper that uses configured doc paths."""
    repo_root = config.root
    docs = {
        "active_context": config.doc_path("active_context"),
        "decisions": config.doc_path("decisions"),
        "spec": config.doc_path("spec"),
    }
    return ensure_about_car_file_for_repo(repo_root, doc_paths=docs, force=force)
