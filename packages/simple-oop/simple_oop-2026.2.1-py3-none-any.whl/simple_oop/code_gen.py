import logging
from pathlib import Path
from typing import Any

from jinja2 import FileSystemLoader, Environment, TemplateNotFound

from simple_oop import NodeContext
from simple_oop.config import TemplateConfig
from simple_oop.node import Node

log = logging.getLogger("simple-oop")


class TemplateEnvironment:
    generated_file_marker = "// autogenerated by simple-oop\n"

    def __init__(self, ctx: NodeContext):
        self.ctx = ctx
        self.env = Environment(loader=FileSystemLoader(ctx.config.template_directory), autoescape=False)

    def check_file(self, file: Path) -> bool:
        file.parent.mkdir(parents=True, exist_ok=True)
        if file.exists() and not file.read_text().startswith(self.generated_file_marker):
            log.error(f"Any files generated by simple-oop must start with "
                      f"\"{self.generated_file_marker}\" otherwise they will "
                      f"not be overwritten, you probably deleted that line. It is "
                      f"normally automatically prepended")
            return False

        return True

    def render_filename(self, filename: str, node: Node) -> str:
        return self.env.from_string(filename).render(node=node)

    def generate(self, template_config: TemplateConfig):
        try:
            template = Template(self, template_config)
        except TemplateNotFound as e:
            print(e)
            return
        out = self.ctx.config.output_directory

        if template.config.foreach is None:
            template.render(out / template_config.name, {
                "nodes": self.ctx.nodes.values()
            })
        else:
            for node in self.ctx.nodes.values():
                if template.node_matches(node):
                    filename = self.render_filename(template_config.name, node)
                    template.render(out / filename, {
                        "nodes": self.ctx.nodes.values(),
                        "node": node
                    })


class Template:
    def __init__(self, env: TemplateEnvironment, config: TemplateConfig):
        self.env: TemplateEnvironment = env
        self.config: TemplateConfig = config
        self.jinja_template: Any

        try:
            self.jinja_template = self.env.env.get_template(config.name)
        except TemplateNotFound as e:
            self.jinja_template = None
            raise e

    def render(self, file: Path, variables: dict[str, Any]):
        if not self.env.check_file(file):
            return

        file.write_text(self.env.generated_file_marker + self.jinja_template.render(**variables))
        log.info(f"Generated {file.name}")

    def node_matches(self, node: Node):
        assert self.config.foreach is not None
        for r in self.config.foreach:
            if not node[r]:
                return False
        return True
