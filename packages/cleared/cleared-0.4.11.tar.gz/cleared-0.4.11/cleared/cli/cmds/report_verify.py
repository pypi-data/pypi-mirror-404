"""Report-verify command for generating HTML verification reports."""

from __future__ import annotations

import json
from datetime import datetime
from pathlib import Path

import typer
from jinja2 import Environment, FileSystemLoader, select_autoescape

from cleared.cli.cmds.verify.model import (
    ColumnComparisonResult,
    TableVerificationResult,
    VerificationOverview,
    VerificationResult,
)
import cleared


def register_report_verify_command(app: typer.Typer) -> None:
    """Register the report-verify command with the Typer app."""

    @app.command("report-verify")
    def report_verify(
        json_path: Path = typer.Argument(  # noqa: B008
            ...,
            help="Path to the verification JSON file",
            exists=True,
            file_okay=True,
            dir_okay=False,
            readable=True,
        ),
        output: Path | None = typer.Option(  # noqa: B008
            None,
            "--output",
            "-o",
            help="Output HTML file path (default: verify-report.html in current directory)",
        ),
        verbose: bool = typer.Option(
            False,
            "--verbose",
            "-v",
            help="Enable verbose output",
        ),
    ) -> None:
        """
        Generate an HTML report from verification JSON results.

        This command loads a verification JSON file (generated by `cleared verify`)
        and generates a comprehensive HTML report with verification results,
        including overview statistics and per-table column comparison results.

        Examples:
            cleared report-verify verify-results.json
            cleared report-verify verify-results.json -o report.html
            cleared report-verify verify-results.json -o /path/to/report.html --verbose

        """
        try:
            # Load JSON file
            with open(json_path) as f:
                json_data = json.load(f)

            # Convert JSON to VerificationResult dataclass
            verification_result = _json_to_verification_result(json_data)

            # Determine output path
            output_path = output or Path.cwd() / "verify-report.html"
            output_path = output_path.resolve()

            # Prepare template data
            template_data = _prepare_template_data(verification_result, json_path)

            # Generate HTML
            html_content = _generate_html(template_data)

            # Write to file
            output_path.parent.mkdir(parents=True, exist_ok=True)
            with open(output_path, "w", encoding="utf-8") as f:
                f.write(html_content)

            _print_success(output_path, verbose)

        except Exception as e:
            _print_error(e, verbose)
            raise typer.Exit(1) from e


def _json_to_verification_result(json_data: dict) -> VerificationResult:
    """Convert JSON data to VerificationResult dataclass."""
    # Convert overview
    overview_data = json_data["overview"]
    overview = VerificationOverview(
        total_tables=overview_data["total_tables"],
        passed_tables=overview_data["passed_tables"],
        failed_tables=overview_data["failed_tables"],
        warning_tables=overview_data["warning_tables"],
        total_errors=overview_data["total_errors"],
        total_warnings=overview_data["total_warnings"],
        total_columns_checked=overview_data["total_columns_checked"],
        total_columns_passed=overview_data["total_columns_passed"],
        total_columns_errored=overview_data["total_columns_errored"],
        total_columns_warned=overview_data["total_columns_warned"],
    )

    # Convert tables
    tables = []
    for table_data in json_data["tables"]:
        # Convert column results
        column_results = []
        for col_data in table_data["column_results"]:
            column_results.append(
                ColumnComparisonResult(
                    column_name=col_data["column_name"],
                    status=col_data["status"],
                    message=col_data["message"],
                    original_length=col_data.get("original_length", 0),
                    reversed_length=col_data.get("reversed_length", 0),
                    mismatch_count=col_data.get("mismatch_count", 0),
                    mismatch_percentage=col_data.get("mismatch_percentage", 0.0),
                    sample_mismatch_indices=col_data.get("sample_mismatch_indices", []),
                )
            )

        tables.append(
            TableVerificationResult(
                table_name=table_data["table_name"],
                status=table_data["status"],
                total_columns=table_data["total_columns"],
                passed_columns=table_data["passed_columns"],
                error_columns=table_data["error_columns"],
                warning_columns=table_data["warning_columns"],
                errors=table_data.get("errors", []),
                warnings=table_data.get("warnings", []),
                column_results=column_results,
            )
        )

    return VerificationResult(
        overview=overview,
        tables=tables,
        config_path=json_data["config_path"],
        reverse_data_path=json_data["reverse_data_path"],
    )


def _prepare_template_data(
    verification_result: VerificationResult, json_path: Path | None = None
) -> dict:
    """Prepare data structure for template rendering."""
    return {
        "config_name": verification_result.config_path,
        "generated_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "version": cleared.__version__,
        "json_file": str(json_path) if json_path else None,
        "overview": verification_result.overview,
        "tables": verification_result.tables,
        "config_path": verification_result.config_path,
        "reverse_data_path": verification_result.reverse_data_path,
    }


def _generate_html(template_data: dict) -> str:
    """Generate HTML content from template data."""
    # Get the template directory (relative to this file)
    template_dir = Path(__file__).parent.parent / "templates" / "report_verify"
    env = Environment(
        loader=FileSystemLoader(str(template_dir)),
        autoescape=select_autoescape(["html", "xml"]),
    )

    template = env.get_template("report.html.j2")
    return template.render(**template_data)


# ============================================================================
# Utility functions for printing/display
# ============================================================================


def _print_success(output_path: Path, verbose: bool) -> None:
    """Print success message."""
    typer.echo(f"✅ HTML report generated: {output_path}")
    if verbose:
        typer.echo(f"   File size: {output_path.stat().st_size:,} bytes")
        typer.echo(f"   Open in browser: file://{output_path}")


def _print_error(error: Exception, verbose: bool) -> None:
    """Print error message."""
    typer.echo(f"❌ Error generating report: {error}", err=True)
    if verbose:
        import traceback

        typer.echo(traceback.format_exc(), err=True)
