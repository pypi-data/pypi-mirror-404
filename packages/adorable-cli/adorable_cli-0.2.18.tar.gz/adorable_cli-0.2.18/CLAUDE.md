# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Adorable CLI is a Python-based autonomous agent built on the [Agno](https://github.com/agno-agi/agno) framework. It's a deep agent that performs complex, long-horizon tasks through continuous interleaved reasoning and action—thinking before every step, executing, and analyzing results. The agent operates through a terminal-based interactive interface and uses persistent memory (SQLite) to maintain context across long sessions.

## Key Commands

### Development Setup
```bash
# Install in editable/development mode
pip install -e .

# With dev dependencies (pytest, black, mypy already in venv)
pip install -e ".[dev]"

# Using uv (recommended)
uv pip install -e .
```

### Building and Packaging
```bash
# Build distribution (setuptools + setuptools_scm)
python -m build

# For development, just install editable mode (no build needed)
```

### Testing
```bash
# Run all unit tests
pytest tests/unit/

# Run specific test module
pytest tests/unit/ui/

# Run with verbose output
pytest -v tests/unit/

# Run with debug info (includes print statements)
pytest -s tests/unit/
```

### Code Quality
```bash
# Lint with ruff (line-length: 100)
ruff check src/

# Format with black (line-length: 100)
black src/

# Check types with mypy
mypy src/adorable_cli/
```

### Running the CLI
```bash
# Interactive mode
adorable

# Alias
ador

# Configure settings
ador config

# Show help
ador --help

# With custom model and API key
ador --api-key sk-xxxx --model gpt-4o
```

## Architecture

### Core Components

**1. Entry Point & CLI (`src/adorable_cli/main.py`)**
- Typer-based CLI with subcommands: `version`, `config`, `chat`
- Parses global options: `--model`, `--base-url`, `--api-key`, `--fast-model`, `--debug`, `--debug-level`, `--plain`
- Delegates to interactive UI or config management

**2. Agent System (`src/adorable_cli/agent/`)**
- `builder.py`: Assembles the agent with database, session memory, and compression manager
- `main_agent.py`: Defines tools available to the agent (reasoning, files, shell, Python, search, MCP, vision, todos)
- `prompts.py`: System prompts and role definitions emphasizing interleaved reasoning + action
- `patches.py`: Monkey patches for Agno framework robustness (handles missing functions, sanitizes malformed JSON)

**3. Settings & Configuration (`src/adorable_cli/settings.py`, `src/adorable_cli/config.py`)**
- `settings.py`: Central config dataclass loading from environment variables (`OPENAI_API_KEY`, `DEEPAGENTS_MODEL_ID`, etc.)
- `config.py`: File-based config at `~/.adorable/config` (KV format)
- Persistent memory database at `~/.adorable/memory.db` (SQLite)

**4. Interactive UI (`src/adorable_cli/ui/`)**
- `interactive.py`: Main event loop handling agent streams, tool calls, shell confirmations, and commands (`/help`, `/clear`, `/stats`, `/exit`)
- `enhanced_input.py`: Rich prompt toolkit with autocomplete (`@` for files, `/` for commands), history, and key bindings
- `stream_renderer.py`: Real-time rendering of agent responses with spinners and metrics
- `utils.py`: Syntax highlighting and argument summarization helpers

**5. Custom Tools (`src/adorable_cli/tools/`)**
- `todo_tools.py`: Task tracking (add, list, complete, remove) for agent planning
- `vision_tool.py`: Image understanding capability

### Agent Tool Stack
The agent combines multiple tool categories for structured reasoning and action:
- **Reasoning**: `ReasoningTools` (think, analyze) for planning/reflection
- **File Operations**: `FileTools` with current working directory base
- **Shell**: `ShellTools` with confirmation prompts for deletion operations
- **Python**: `PythonTools` limited to `run_python_code` only
- **Search**: `DuckDuckGoTools` for web search
- **MCP**: `MultiMCPTools` orchestrating `mcp-server-fetch` (Fetch MCP) and `@playwright/mcp@latest`
- **Vision**: Custom image understanding tool
- **Planning**: `TodoTools` for task tracking

### Memory & Context Management
- **Short-term**: History (last 3 runs with 3 tool calls each) added to context
- **Long-term**: SQLite database (`~/.adorable/memory.db`) with `SessionSummaryManager`
- **Session Summaries**: Plain-text summaries generated by fast model (prevents JSON parsing issues)
- **Compression**: `CompressionManager` compresses tool results when limit (50) exceeded; handles file paths and error messages carefully

### Key Prompt Principles (in `prompts.py`)
The system prompt enforces strict tool usage patterns:
1. **Interleaved Pattern**: Alternates between reasoning tools (think/analyze) and action tools
2. **Exact Tool Names**: Only canonical tool names allowed; no composition or hallucination
3. **No Tool Composition**: `think`, `analyze`, and action tools never combined in one call
4. **Reasoning Action Field**: The `action` field in `think()`/`analyze()` is descriptive text only—never contains tool names

## Development Patterns

### Adding a New Tool
1. Create a new class extending `agno.tools.Toolkit` in `src/adorable_cli/tools/`
2. Register methods via `self.register(method_name)` in `__init__`
3. Add docstrings describing tool behavior and parameters
4. Import and add to tools list in `main_agent.py` (around line 31-48)

### Modifying Agent Prompts
- Edit role and instructions in `src/adorable_cli/agent/prompts.py`
- Keep emphasis on interleaved reasoning → action pattern
- Avoid tool name examples in action field descriptions

### Handling Shell Confirmation
- Deletion commands (`rm`, `rmdir`, etc.) trigger user confirmation via `handle_tool_confirmation()` in `interactive.py`
- Safe commands auto-approve without prompting

### Testing Custom Code
- Unit tests are in `tests/unit/` (organized by module: `ui/` for UI tests)
- Use `pytest-asyncio` for async test functions (decorator: `@pytest.mark.asyncio`)
- Run pytest in verbose mode (`-v`) or with output (`-s`) for debugging

## Important Implementation Details

**MCP Tool Lifecycle Management** (`interactive.py`: `_pin_mcp_tools_to_current_task`, `_close_pinned_mcp_tools`)
- MCP tools (fetch, playwright) are pinned to the async task running the agent
- Prevents premature closure when task context is lost
- Use force reconnect to ensure availability within the correct task scope

**Config File Format** (`~/.adorable/config`)
- Simple KV format: `KEY=VALUE` (one per line)
- Supports comments starting with `#`
- Automatically loaded on startup; can be updated via `ador config`

**Monkey Patches** (`agent/patches.py`)
- Sanitizes malformed JSON in tool arguments (handles concatenated JSONs like `{...}{...}`)
- Intercepts missing function calls and returns friendly error messages
- Applied once during agent build; idempotent

## Debugging

### Enable Debug Logging
```bash
# Set debug environment variable
ador --debug

# With debug level (0-10, higher = more verbose)
ador --debug --debug-level 5
```

### View Console Logs
```bash
# Agno-specific logging (controlled by AGNO_LOG_LEVEL, AGNO_TOOLS_LOG_LEVEL)
# Defaults: WARNING level
```

### Session Statistics
- In interactive mode, use `/stats` command to view session metrics
- Metrics include token usage, run count, and elapsed time

## File Structure

```
adorable-cli/
├── src/adorable_cli/
│   ├── main.py                 # Typer CLI entry
│   ├── settings.py             # Config dataclass
│   ├── config.py               # Config file handling
│   ├── console.py              # Rich console setup
│   ├── agent/
│   │   ├── builder.py          # Agent assembly
│   │   ├── main_agent.py       # Agent + tool definitions
│   │   ├── prompts.py          # System prompts
│   │   └── patches.py          # Monkey patches for Agno
│   ├── tools/
│   │   ├── todo_tools.py       # Task tracking
│   │   └── vision_tool.py      # Image understanding
│   └── ui/
│       ├── interactive.py      # Main event loop & commands
│       ├── enhanced_input.py   # Rich prompt input
│       ├── stream_renderer.py  # Response rendering
│       └── utils.py            # Helpers
├── tests/unit/                 # Unit tests
├── pyproject.toml              # Build config (setuptools + setuptools_scm)
└── README.md                   # User documentation
```

## Common Development Tasks

**Adding a new agent command** (like `/stats` or `/clear`)
1. Edit `interactive.py`: Add a `cmd_*` function and register it with `register_command()`
2. Update `/help` text in `_show_commands_help()`
3. Command handling dispatches through `handle_special_command()`

**Changing the agent's reasoning loop**
1. Modify `AGENT_INSTRUCTIONS` in `prompts.py` to adjust think/act patterns
2. Ensure changes reinforce interleaved reasoning + action (don't allow merged tool calls)

**Customizing session summaries**
1. Edit `SESSION_SUMMARY_PROMPT` in `prompts.py`
2. Verify model generates plain text (not JSON/XML) to avoid parsing failures

**Updating tool stack**
1. Modify tools list in `create_adorable_agent()` in `main_agent.py`
2. Update `AGENT_INSTRUCTIONS` if tool names/categories change
3. Add any new tool imports at the top of `main_agent.py`
