# GitHub Actions Workflow for Schema Linting
#
# This workflow demonstrates how to integrate confiture schema linting
# into your CI/CD pipeline.
#
# Features:
# - Runs on pull requests and pushes to main/develop
# - Tests against multiple Python versions
# - Generates JSON report for failed checks
# - Uploads report as GitHub artifact for review
# - Fails builds that violate schema rules
#
# Installation:
# 1. Copy this file to .github/workflows/schema-lint.yaml
# 2. Commit and push to your repository
# 3. Workflow will automatically run on PRs and pushes

name: Schema Linting

# Trigger workflow on specific events
on:
  # Run on pull requests that modify schema files
  pull_request:
    branches: [main, develop]
    paths:
      - 'db/schema/**'
      - '.github/workflows/schema-lint.yaml'
      - 'confiture.yaml'

  # Run on pushes to main/develop that modify schema files
  push:
    branches: [main, develop]
    paths:
      - 'db/schema/**'
      - '.github/workflows/schema-lint.yaml'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

# Environment variables
env:
  PYTHON_VERSION: '3.11'

# Concurrency settings (cancel previous runs if new push)
concurrency:
  group: schema-lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ========================================================================
  # LINTING JOB
  # ========================================================================
  lint:
    name: Lint Schema
    runs-on: ubuntu-latest
    timeout-minutes: 5

    # Test against multiple Python versions
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      # Install uv (fast package manager)
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh

      # Install dependencies
      - name: Install dependencies
        run: |
          uv pip install confiture

      # Run linting on staging environment
      - name: Lint schema (staging)
        id: lint_staging
        continue-on-error: true
        run: |
          echo "Linting staging schema..."
          confiture lint --env staging --fail-on-error

      # Generate JSON report if linting failed
      - name: Generate lint report
        if: failure()
        run: |
          echo "Generating detailed lint report..."
          confiture lint --env staging --format json > lint-report.json
          cat lint-report.json

      # Upload report as artifact for review
      - name: Upload lint report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report-py${{ matrix.python-version }}
          path: lint-report.json
          retention-days: 7

      # Fail the job if linting failed
      - name: Check linting results
        if: failure()
        run: |
          echo "❌ Schema linting failed!"
          echo "Review the lint-report.json artifact for details."
          exit 1

  # ========================================================================
  # PRODUCTION VALIDATION JOB (only on main branch)
  # ========================================================================
  validate-production:
    name: Validate Production Schema
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: lint
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: |
          uv pip install confiture

      # Validate production schema with strict mode
      - name: Validate production schema (strict)
        run: |
          echo "Validating production schema with strict rules..."
          confiture lint --env production \
            --fail-on-error \
            --fail-on-warning

      # Generate production report
      - name: Generate production report
        if: always()
        run: |
          confiture lint --env production \
            --format json \
            --output prod-lint-report.json

      # Upload production report
      - name: Upload production report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prod-lint-report
          path: prod-lint-report.json
          retention-days: 30

  # ========================================================================
  # COMMENT ON PR WITH RESULTS
  # ========================================================================
  comment-results:
    name: Comment Results on PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: lint
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv pip install confiture

      # Generate lint report
      - name: Generate lint report
        id: report
        run: |
          confiture lint --env staging --format json > lint-report.json

          # Extract summary
          TOTAL=$(jq '.violations.total' lint-report.json)
          ERRORS=$(jq '.violations.errors' lint-report.json)
          WARNINGS=$(jq '.violations.warnings' lint-report.json)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

      # Comment on PR with results
      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const total = ${{ steps.report.outputs.total || 0 }};
            const errors = ${{ steps.report.outputs.errors || 0 }};
            const warnings = ${{ steps.report.outputs.warnings || 0 }};

            let status = '✅';
            if (errors > 0) status = '❌';
            else if (warnings > 0) status = '⚠️';

            const comment = `
            ${status} **Schema Linting Results**

            | Metric | Count |
            |--------|-------|
            | Total Violations | ${total} |
            | Errors | ${errors} |
            | Warnings | ${warnings} |

            ${errors > 0 ? '**Action Required**: This PR has schema errors that must be fixed before merging.' : 'Schema linting passed!'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# ============================================================================
# WORKFLOW SUMMARY
# ============================================================================
#
# This workflow:
#
# 1. LINT JOB
#    - Runs on all PRs and pushes that modify db/schema/
#    - Tests Python 3.11, 3.12, 3.13
#    - Lints staging schema (fail-on-error)
#    - Generates JSON report if failed
#    - Uploads report as artifact
#
# 2. VALIDATE-PRODUCTION JOB
#    - Runs only on main branch after lint succeeds
#    - Validates production schema (strict: errors + warnings)
#    - Generates and uploads production report
#
# 3. COMMENT-RESULTS JOB
#    - Runs only on PRs
#    - Comments results on the PR
#    - Shows summary of violations
#    - Links to artifacts
#
# ============================================================================
# USAGE
# ============================================================================
#
# 1. Copy this file to: .github/workflows/schema-lint.yaml
# 2. Commit and push
# 3. Workflow runs automatically on:
#    - All PRs to main/develop that modify db/schema/
#    - All pushes to main/develop that modify db/schema/
#    - Manual trigger via GitHub Actions UI
#
# Result:
# - PRs will have linting results as comments
# - Failed linting prevents merge to main
# - Production schema is strictly validated before main
# - Reports stored as artifacts for 7-30 days
#
# ============================================================================
# CUSTOMIZATION
# ============================================================================
#
# Environment config:
#   - Change 'staging' to 'development' for PRs
#   - Change 'production' to different environment for main
#
# Strictness:
#   - Remove --fail-on-warning for relaxed mode
#   - Add --no-fail-on-error to ignore errors
#
# Python versions:
#   - Add/remove versions in strategy.matrix.python-version
#
# Artifact retention:
#   - Change retention-days: 7 to preferred duration
#
# ============================================================================
