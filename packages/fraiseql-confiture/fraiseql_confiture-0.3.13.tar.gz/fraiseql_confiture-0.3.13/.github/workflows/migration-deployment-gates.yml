name: Migration Deployment Gates

# Validate migrations before deployment - comprehensive safety checks
on:
  push:
    branches: [ main ]
    paths:
      - 'db/migrations/**'
      - 'db/schema/**'
      - 'pyproject.toml'
      - '.github/workflows/migration-deployment-gates.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'db/migrations/**'
      - 'db/schema/**'
      - 'pyproject.toml'
      - '.github/workflows/migration-deployment-gates.yml'
  # Also support manual trigger
  workflow_dispatch:

concurrency:
  group: migration-gates-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Gate 1: Validate Migration Files
  migration-naming-validation:
    name: Migration Naming & Structure
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Validate Migration Naming Conventions
      run: |
        echo "=== Validating Migration Naming Conventions ==="

        if [ ! -d "db/migrations" ]; then
          echo "‚ÑπÔ∏è  No migrations directory found (expected for main branch)"
          exit 0
        fi

        # Check for migration files
        MIGRATION_COUNT=$(find db/migrations -name "*.sql" 2>/dev/null | wc -l)
        echo "‚úÖ Found $MIGRATION_COUNT migration files"

        # Validate naming pattern: NNN_description.sql
        INVALID=0
        while IFS= read -r file; do
          FILENAME=$(basename "$file")
          if ! [[ "$FILENAME" =~ ^[0-9]{3}_[a-z0-9_]+\.sql$ ]]; then
            echo "‚ùå Invalid migration name: $FILENAME"
            echo "   Expected format: NNN_description.sql (e.g., 001_create_users.sql)"
            ((INVALID++))
          fi
        done < <(find db/migrations -name "*.sql" 2>/dev/null)

        if [ $INVALID -gt 0 ]; then
          echo "‚ùå Found $INVALID migration files with invalid naming"
          exit 1
        fi

        echo "‚úÖ All migration files follow naming conventions"

    - name: Validate Migration File Content
      run: |
        echo "=== Validating Migration File Content ==="

        if [ ! -d "db/migrations" ]; then
          echo "‚ÑπÔ∏è  No migrations directory found"
          exit 0
        fi

        # Check that migrations contain SQL
        VALID=0
        INVALID=0

        while IFS= read -r file; do
          if grep -q "CREATE\|ALTER\|DROP\|INSERT\|UPDATE\|DELETE" "$file"; then
            ((VALID++))
          else
            echo "‚ö†Ô∏è  Migration file appears empty or invalid: $file"
            ((INVALID++))
          fi
        done < <(find db/migrations -name "*.sql" 2>/dev/null)

        echo "‚úÖ Valid migrations: $VALID"
        if [ $INVALID -gt 0 ]; then
          echo "‚ö†Ô∏è  Potentially invalid migrations: $INVALID (may be intentional)"
        fi

    - name: Check for Migration Comments
      run: |
        echo "=== Checking Migration Documentation ==="

        if [ ! -d "db/migrations" ]; then
          exit 0
        fi

        # Warn if migrations lack comments
        UNDOCUMENTED=0
        while IFS= read -r file; do
          if ! grep -q "^--" "$file"; then
            echo "‚ö†Ô∏è  Migration lacks documentation comments: $(basename $file)"
            ((UNDOCUMENTED++))
          fi
        done < <(find db/migrations -name "*.sql" 2>/dev/null)

        if [ $UNDOCUMENTED -gt 0 ]; then
          echo "‚ö†Ô∏è  $UNDOCUMENTED migrations lack documentation comments"
          echo "   Recommendation: Add -- comments to explain the migration"
        fi

  # Gate 2: Test Migration Rollback Compatibility
  migration-rollback-test:
    name: Rollback Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: confiture
          POSTGRES_PASSWORD: confiture
          POSTGRES_DB: confiture_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Setup environment
      run: |
        uv venv
        uv pip install ".[dev,testing]"

    - name: Verify PostgreSQL Connection
      env:
        PGPASSWORD: confiture
      run: |
        pg_isready -h localhost -p 5432 -U confiture && echo '‚úÖ PostgreSQL Ready' || exit 1

    - name: Create rollback test database
      env:
        PGPASSWORD: confiture
      run: |
        psql -h localhost -U confiture -d postgres -c "DROP DATABASE IF EXISTS confiture_rollback_test;"
        psql -h localhost -U confiture -d postgres -c "CREATE DATABASE confiture_rollback_test;"

    - name: Test Forward Migration + Rollback Cycle
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_rollback_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Testing Forward + Rollback Cycle ==="

        # Test that rollback migrations complement forward migrations
        uv run pytest tests/migration_testing/test_rollback_migrations.py::test_rollback_reverses_table_creation \
          -v \
          --tb=short \
          || {
            echo "‚ùå Rollback compatibility test failed"
            exit 1
          }

        echo "‚úÖ Forward/rollback cycle validated"

  # Gate 3: Schema Validation
  schema-validation:
    name: Schema DDL Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: confiture
          POSTGRES_PASSWORD: confiture
          POSTGRES_DB: confiture_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Setup environment
      run: |
        uv venv
        uv pip install ".[dev,testing]"

    - name: Verify PostgreSQL
      env:
        PGPASSWORD: confiture
      run: |
        pg_isready -h localhost -p 5432 -U confiture || exit 1

    - name: Create schema validation database
      env:
        PGPASSWORD: confiture
      run: |
        psql -h localhost -U confiture -d postgres -c "DROP DATABASE IF EXISTS confiture_schema_test;"
        psql -h localhost -U confiture -d postgres -c "CREATE DATABASE confiture_schema_test;"

    - name: Run Schema Validation Tests
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_schema_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Validating Schema DDL ==="

        uv run pytest tests/migration_testing/test_forward_migrations.py::test_schema_creates_valid_ddl \
          -v \
          --tb=short \
          || {
            echo "‚ö†Ô∏è  Schema validation tests completed with warnings"
            exit 0
          }

        echo "‚úÖ Schema DDL validation passed"

  # Gate 4: Data Integrity Validation
  data-integrity:
    name: Data Integrity Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: confiture
          POSTGRES_PASSWORD: confiture
          POSTGRES_DB: confiture_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Setup environment
      run: |
        uv venv
        uv pip install ".[dev,testing]"

    - name: Verify PostgreSQL
      env:
        PGPASSWORD: confiture
      run: |
        pg_isready -h localhost -p 5432 -U confiture || exit 1

    - name: Create data integrity test database
      env:
        PGPASSWORD: confiture
      run: |
        psql -h localhost -U confiture -d postgres -c "DROP DATABASE IF EXISTS confiture_integrity_test;"
        psql -h localhost -U confiture -d postgres -c "CREATE DATABASE confiture_integrity_test;"

    - name: Run Data Integrity Tests
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_integrity_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Validating Data Integrity ==="

        uv run pytest tests/migration_testing/ -k "data" \
          -v \
          --tb=short \
          || {
            echo "‚ö†Ô∏è  Data integrity tests completed"
            exit 0
          }

        echo "‚úÖ Data integrity validation passed"

  # Gate 5: Edge Case & Breaking Change Detection
  breaking-change-detection:
    name: Breaking Change Detection
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect Breaking Changes
      run: |
        echo "=== Detecting Breaking Changes ==="

        # Get list of changed files
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
        fi

        echo "Changed files:"
        echo "$CHANGED_FILES" | sed 's/^/  /'

        # Check for breaking changes
        BREAKING_CHANGES=0

        # Check for DROP TABLE in migrations (breaking)
        if echo "$CHANGED_FILES" | grep -q "db/migrations"; then
          while IFS= read -r file; do
            if grep -i "DROP TABLE" "$file" 2>/dev/null | grep -v "DROP TABLE IF EXISTS"; then
              echo "‚ö†Ô∏è  Potential breaking change: DROP TABLE without IF EXISTS in $file"
              ((BREAKING_CHANGES++))
            fi
            if grep -i "DROP COLUMN" "$file" 2>/dev/null | grep -v "DROP COLUMN IF EXISTS"; then
              echo "‚ö†Ô∏è  Potential breaking change: DROP COLUMN without IF EXISTS in $file"
              ((BREAKING_CHANGES++))
            fi
          done < <(echo "$CHANGED_FILES" | grep "\.sql$")
        fi

        if [ $BREAKING_CHANGES -gt 0 ]; then
          echo "‚ùå Found $BREAKING_CHANGES potential breaking changes"
          echo "   Use IF EXISTS to ensure safe rollback"
          exit 1
        fi

        echo "‚úÖ No obvious breaking changes detected"

  # Gate 6: Version & Documentation Check
  release-readiness:
    name: Release Readiness Check
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check Version Updated
      run: |
        echo "=== Checking Version Update ==="

        if [ ! -f "pyproject.toml" ]; then
          exit 0
        fi

        # Check for version in pyproject.toml
        if grep -q "version" pyproject.toml; then
          echo "‚úÖ Version field found in pyproject.toml"
        fi

    - name: Check Documentation Updated
      run: |
        echo "=== Checking Documentation ==="

        # List of documentation files that might need updates
        DOC_FILES=(
          "README.md"
          "CHANGELOG.md"
          "docs/"
        )

        for file in "${DOC_FILES[@]}"; do
          if [ -f "$file" ] || [ -d "$file" ]; then
            echo "‚úÖ Found documentation: $file"
          fi
        done

    - name: Migration Testing README Check
      run: |
        echo "=== Checking Migration Testing Documentation ==="

        if [ -d "tests/migration_testing" ] && [ ! -f "tests/migration_testing/README.md" ]; then
          echo "‚ÑπÔ∏è  Recommendation: Add README.md to tests/migration_testing/"
          echo "    This would help users understand test structure and patterns"
        fi

  # Summary Gate
  deployment-gates-summary:
    name: Deployment Gates Summary
    runs-on: ubuntu-latest
    needs: [migration-naming-validation, migration-rollback-test, schema-validation, data-integrity, breaking-change-detection, release-readiness]
    if: always()

    steps:
    - name: Check All Gates Passed
      run: |
        echo "========================================="
        echo "üö¶ Migration Deployment Gates Summary"
        echo "========================================="
        echo ""
        echo "Gate Status:"
        echo "  1. Migration Naming: ${{ needs.migration-naming-validation.result }}"
        echo "  2. Rollback Compat: ${{ needs.migration-rollback-test.result }}"
        echo "  3. Schema Validation: ${{ needs.schema-validation.result }}"
        echo "  4. Data Integrity: ${{ needs.data-integrity.result }}"
        echo "  5. Breaking Changes: ${{ needs.breaking-change-detection.result }}"
        echo "  6. Release Ready: ${{ needs.release-readiness.result }}"
        echo ""

        if [[ "${{ needs.migration-naming-validation.result }}" != "success" ]]; then
          echo "‚ùå Migration naming validation failed"
          exit 1
        fi
        if [[ "${{ needs.migration-rollback-test.result }}" != "success" ]]; then
          echo "‚ùå Rollback compatibility test failed"
          exit 1
        fi
        if [[ "${{ needs.schema-validation.result }}" != "success" ]]; then
          echo "‚ùå Schema validation failed"
          exit 1
        fi
        if [[ "${{ needs.data-integrity.result }}" != "success" ]]; then
          echo "‚ùå Data integrity check failed"
          exit 1
        fi
        if [[ "${{ needs.breaking-change-detection.result }}" != "success" ]]; then
          echo "‚ùå Breaking change detected"
          exit 1
        fi
        if [[ "${{ needs.release-readiness.result }}" != "success" ]]; then
          echo "‚ùå Release readiness check failed"
          exit 1
        fi

        echo "========================================="
        echo "‚úÖ All Deployment Gates Passed"
        echo "========================================="
        echo ""
        echo "‚úì Migrations follow naming conventions"
        echo "‚úì Rollback compatibility validated"
        echo "‚úì Schema DDL validated"
        echo "‚úì Data integrity assured"
        echo "‚úì No breaking changes detected"
        echo "‚úì Release documentation ready"
        echo ""
        echo "üöÄ Migration is SAFE to deploy"
