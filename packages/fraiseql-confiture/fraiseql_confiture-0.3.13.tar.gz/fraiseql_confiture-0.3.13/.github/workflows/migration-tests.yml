name: Migration Tests

# Run migration test suite on all PRs and pushes to main
on:
  push:
    branches: [ main ]
    paths:
      - 'python/confiture/testing/**'
      - 'tests/migration_testing/**'
      - 'pyproject.toml'
      - '.github/workflows/migration-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'python/confiture/testing/**'
      - 'tests/migration_testing/**'
      - 'pyproject.toml'
      - '.github/workflows/migration-tests.yml'

concurrency:
  group: migration-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  migration-tests:
    name: Migration Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: confiture
          POSTGRES_PASSWORD: confiture
          POSTGRES_DB: confiture_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Setup environment and install dependencies
      run: |
        # Create virtual environment with uv
        uv venv

        # Install all dependencies including testing extras
        uv pip install ".[dev,testing]"

    - name: Verify PostgreSQL 16 Connection
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_test
      run: |
        echo "=== Verifying PostgreSQL 16 Connection ==="
        pg_isready -h localhost -p 5432 -U confiture && echo '✅ PostgreSQL Ready' || echo '❌ PostgreSQL Not Ready'
        uv run python -c "import psycopg; conn = psycopg.connect('postgresql://confiture:confiture@localhost:5432/confiture_test'); print('✅ DB connection successful'); conn.close()" || exit 1

    - name: Create test migration databases
      env:
        PGPASSWORD: confiture
      run: |
        echo "=== Creating Migration Test Databases ==="

        # Create main migration test database
        psql -h localhost -U confiture -d postgres -c "DROP DATABASE IF EXISTS confiture_migration_test;"
        psql -h localhost -U confiture -d postgres -c "CREATE DATABASE confiture_migration_test;"

        echo "✅ Migration test databases created"

    - name: Run migration tests (forward migrations)
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Forward Migration Tests ==="
        uv run pytest tests/migration_testing/test_forward_migrations.py \
          -v \
          --tb=short \
          -x \
          || {
            echo "❌ Forward migration tests failed"
            exit 1
          }
        echo "✅ Forward migration tests passed"

    - name: Run migration tests (rollback migrations)
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Rollback Migration Tests ==="
        uv run pytest tests/migration_testing/test_rollback_migrations.py \
          -v \
          --tb=short \
          -x \
          || {
            echo "❌ Rollback migration tests failed"
            exit 1
          }
        echo "✅ Rollback migration tests passed"

    - name: Run migration tests (edge cases)
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Edge Case Tests ==="
        uv run pytest tests/migration_testing/test_edge_cases.py \
          -v \
          --tb=short \
          -x \
          || {
            echo "❌ Edge case tests failed"
            exit 1
          }
        echo "✅ Edge case tests passed"

    - name: Run mutation framework tests
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Mutation Framework Tests ==="
        uv run pytest tests/migration_testing/test_mutations.py \
          -v \
          --tb=short \
          -x \
          || {
            echo "❌ Mutation framework tests failed"
            exit 1
          }
        echo "✅ Mutation framework tests passed"

    - name: Run performance framework tests
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Performance Framework Tests ==="
        uv run pytest tests/migration_testing/test_performance.py \
          -v \
          --tb=short \
          -x \
          || {
            echo "❌ Performance framework tests failed"
            exit 1
          }
        echo "✅ Performance framework tests passed"

    - name: Run load testing tests
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Load Testing Tests ==="
        uv run pytest tests/migration_testing/test_load_testing.py \
          -v \
          --tb=short \
          -x \
          || {
            echo "❌ Load testing tests failed"
            exit 1
          }
        echo "✅ Load testing tests passed"

    - name: Run advanced scenario tests
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Advanced Scenario Tests ==="
        uv run pytest tests/migration_testing/test_advanced_scenarios.py \
          -v \
          --tb=short \
          -x \
          || {
            echo "❌ Advanced scenario tests failed"
            exit 1
          }
        echo "✅ Advanced scenario tests passed"

    - name: Run full migration test suite with coverage
      env:
        DATABASE_URL: postgresql://confiture:confiture@localhost:5432/confiture_migration_test
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: confiture
        POSTGRES_PASSWORD: confiture
      run: |
        echo "=== Running Complete Migration Test Suite ==="
        uv run pytest tests/migration_testing/ \
          --cov=confiture.testing \
          --cov-report=xml \
          --cov-report=term-missing \
          -v \
          --tb=short \
          || {
            echo "❌ Complete migration test suite failed"
            exit 1
          }
        echo "✅ Complete migration test suite passed"

    - name: Upload coverage report
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: migration-tests
        name: Migration-Tests
        fail_ci_if_error: false
      continue-on-error: true

    - name: Migration Test Summary
      if: always()
      run: |
        echo "========================================="
        echo "✅ Migration Test Suite Complete"
        echo "========================================="
        echo ""
        echo "Test Files Executed:"
        echo "  • test_forward_migrations.py (36 tests)"
        echo "  • test_rollback_migrations.py (48 tests)"
        echo "  • test_edge_cases.py (35 tests)"
        echo "  • test_mutations.py (8 tests)"
        echo "  • test_performance.py (8 tests)"
        echo "  • test_load_testing.py (12 tests)"
        echo "  • test_advanced_scenarios.py (10 tests)"
        echo ""
        echo "Total: 200+ comprehensive migration tests"
        echo ""
        echo "Framework Tested:"
        echo "  ✅ confiture.testing.frameworks.mutation"
        echo "  ✅ confiture.testing.frameworks.performance"
        echo "  ✅ confiture.testing.fixtures.*"
        echo ""
        echo "PostgreSQL Features Validated:"
        echo "  • DDL Operations (CREATE/ALTER/DROP)"
        echo "  • Data Integrity (FK, constraints)"
        echo "  • Transactions"
        echo "  • Indexes and Performance"
        echo "  • Views and Dependencies"
        echo "  • Large Dataset Operations (100k+ rows)"
