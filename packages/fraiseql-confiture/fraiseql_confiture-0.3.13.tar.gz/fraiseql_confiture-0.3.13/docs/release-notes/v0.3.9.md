# Confiture v0.3.9 Release Notes

**Release Date**: January 27, 2026
**Focus**: Migration File Validation and Auto-Fix

## Summary

This release introduces **migration file validation and automated fixing** to prevent silent migration failures. A common problem in migration-based workflows is misnamed files (missing `.up.sql` suffix) that are silently ignored, leading to schema mismatches and production failures. This release solves that problem with comprehensive detection, clear warnings, and auto-fix capabilities.

> **Problem Solved**: Files like `001_initial_schema.sql` (without `.up.sql`) are now detected and can be automatically renamed, preventing silent failures.

## Key Features

### 1. Orphaned Migration File Detection

Automatically detect `.sql` files that don't match the expected naming pattern:

```bash
$ confiture migrate status
‚ö†Ô∏è  WARNING: Orphaned migration files detected
These SQL files exist but won't be applied by Confiture:
  ‚Ä¢ 001_initial_schema.sql ‚Üí rename to: 001_initial_schema.up.sql
  ‚Ä¢ 002_add_columns.sql ‚Üí rename to: 002_add_columns.up.sql
```

**Detection occurs in**:
- `confiture migrate status` - Shows discovered migrations and orphaned files
- `confiture migrate up` - Warns before applying migrations with `--strict` option
- Integrated into both text and JSON output

### 2. New `confiture migrate validate` Command

Comprehensive validation and auto-fix for migration file naming:

```bash
# Check for orphaned files
confiture migrate validate

# Preview fixes without applying
confiture migrate validate --fix-naming --dry-run

# Automatically fix naming issues
confiture migrate validate --fix-naming

# Output as JSON for CI/CD
confiture migrate validate --format json
```

**Features**:
- ‚úÖ Detects all orphaned `.sql` files
- ‚úÖ Preview mode (`--dry-run`) for safe testing
- ‚úÖ Auto-fix with file preservation
- ‚úÖ JSON output for programmatic access
- ‚úÖ Detailed error reporting
- ‚úÖ Safe file operations (atomic renames)

### 3. Auto-Fix Capability

Safely rename orphaned files to match the expected pattern:

```bash
# Example: Before
$ ls db/migrations/
001_users.sql
002_posts.sql
003_comments.up.sql

# Fix
$ confiture migrate validate --fix-naming
‚úÖ Fixed orphaned migration files:
  ‚Ä¢ 001_users.sql ‚Üí 001_users.up.sql
  ‚Ä¢ 002_posts.sql ‚Üí 002_posts.up.sql

# After
$ ls db/migrations/
001_users.up.sql
002_posts.up.sql
003_comments.up.sql
```

**Safety Guarantees**:
- File contents are never modified
- Only filenames are changed
- Operations are atomic (all-or-nothing)
- Detailed error reporting if issues occur
- Dry-run mode for preview without changes

### 4. Strict Mode for Migration Application

Add `--strict` flag to `confiture migrate up` to fail on orphaned files:

```bash
# Fail if orphaned files exist
confiture migrate up --strict

# Useful for CI/CD pipelines to catch issues early
```

## Documentation

### New Comprehensive Guide

**[Migration Naming Best Practices](../guides/migration-naming-best-practices.md)** - 500+ line guide covering:

- The three recognized migration file patterns:
  - Python: `{NNN}_{name}.py`
  - SQL Forward: `{NNN}_{name}.up.sql`
  - SQL Rollback: `{NNN}_{name}.down.sql`

- Common naming mistakes and fixes:
  - Missing `.up` suffix
  - Inconsistent version numbers
  - Non-snake-case names
  - Files not starting with numbers

- Version numbering schemes:
  - Simple sequential (001, 002, 003)
  - Decade spacing (010, 020, 030) - **Recommended**
  - Grouped by layer (001-099, 101-199)
  - Timestamp-based (for distributed teams)

- Best practices:
  - Use decade spacing from day one
  - Descriptive migration names
  - One change per migration (usually)
  - Always create `.down` migrations
  - Document your numbering scheme

- Validation and CI/CD integration:
  - How to use `confiture migrate validate`
  - GitHub Actions CI/CD examples
  - Manual verification steps

- Real-world scenarios and FAQ:
  - Enterprise projects with 1000+ migrations
  - Troubleshooting common issues
  - Migration discovery best practices

### Updated Documentation

- **CLI Reference**: Complete `confiture migrate validate` documentation with all options and examples
- **Incremental Migrations Guide**: Added "Naming Requirements" section with pattern validation
- **Troubleshooting Guide**: New section on orphaned migration files with causes and solutions
- **Documentation Index**: New "Migration File Management" section

## Implementation Details

### Migrator Class Enhancements

New methods in `confiture.core.migrator.Migrator`:

```python
# Detect orphaned .sql files
orphaned = migrator.find_orphaned_sql_files(migrations_dir)

# Fix orphaned files (with dry-run support)
result = migrator.fix_orphaned_sql_files(migrations_dir, dry_run=False)
# Returns: {"renamed": [...], "errors": [...]}
```

### CLI Integration

- Integrated warnings into `migrate status` and `migrate up` commands
- Both text and JSON output support
- Helpful guidance messages with actionable fixes
- Links to documentation for learning more

## Why This Matters

### The Problem

Traditional migration tools silently skip misnamed files, creating a dangerous scenario:

1. Developer writes migration: `001_add_users_table.sql` (forgot `.up.sql`)
2. Confiture scans migrations: Doesn't match pattern, silently skips
3. No error or warning: Developer thinks migration is discoverable
4. Deploy to production: Code expects new schema, database is old
5. Application crashes: Schema mismatch causes failures

### The Solution

- **Automatic Detection**: Find misnamed files immediately
- **Clear Warnings**: Show exactly what's wrong and how to fix
- **Automated Repair**: Auto-fix with safe preview mode
- **Validation Integration**: Catch issues in CI/CD pipeline

## Testing

### New Tests Added

- 6 CLI integration tests for `validate` command
- 2 Migrator unit tests for fix functionality
- Tests for dry-run mode, JSON output, and error handling
- All existing tests continue to pass

### Quality Metrics

- ‚úÖ 2,660 unit tests passing
- ‚úÖ Full linting compliance (ruff, clippy)
- ‚úÖ No compiler warnings
- ‚úÖ Comprehensive documentation
- ‚úÖ Real-world examples

## Breaking Changes

**None**. This release is fully backward compatible:

- Existing migration files continue to work
- Warnings are non-blocking (informational only)
- `--strict` flag is opt-in
- All existing commands unchanged

## Upgrade Path

1. Update to v0.3.9: `pip install fraiseql-confiture==0.3.9`
2. Run validation: `confiture migrate validate`
3. Review orphaned files (if any)
4. Optionally auto-fix: `confiture migrate validate --fix-naming`
5. No other changes needed - backward compatible

## Use Cases

### For Development Teams

```bash
# Catch naming issues in code review
confiture migrate validate

# Quick check before commit
confiture migrate validate --format json | jq
```

### For CI/CD Pipelines

```yaml
# GitHub Actions example
- name: Validate migration naming
  run: confiture migrate validate --format json --output validation-report.json

- name: Fail if issues found
  run: |
    jq -e '.orphaned_files | length == 0' validation-report.json || \
    (echo "Orphaned migration files detected!" && exit 1)
```

### For Fixing Legacy Projects

```bash
# Preview changes
confiture migrate validate --fix-naming --dry-run

# Apply fixes
confiture migrate validate --fix-naming

# Verify all migrations are recognized
confiture migrate status
```

## Recognized Migration Patterns

Confiture now explicitly documents the three recognized patterns:

```
‚úÖ RECOGNIZED:
{NNN}_{name}.py           # Python class migration
{NNN}_{name}.up.sql       # Forward migration (SQL)
{NNN}_{name}.down.sql     # Rollback migration (SQL)

‚ùå NOT RECOGNIZED (will be silently ignored):
{NNN}_{name}.sql          # Missing .up suffix!
{NNN}_{name}_up.sql       # Wrong pattern!
v{NNN}_{name}.py          # Doesn't start with number!
```

## Performance Impact

- ‚úÖ No impact on migration execution
- ‚úÖ File scanning is <1ms for typical projects
- ‚úÖ Auto-fix is instantaneous (file renames)
- ‚úÖ Optional: warnings only show when issues detected

## Related Issues

- Resolves [GitHub Issue #13](https://github.com/evoludigit/confiture/issues/13) - Migration Discovery Validation
- Complete implementation across three phases:
  - Phase 1: Detection and warnings
  - Phase 2: Validation command with auto-fix
  - Phase 3: Comprehensive documentation

## Migration Path from v0.3.8

```bash
# Install new version
pip install --upgrade fraiseql-confiture

# Run validate command (optional, but recommended)
confiture migrate validate

# Fix any issues (optional)
confiture migrate validate --fix-naming

# Continue as normal
confiture migrate status
confiture migrate up
```

## Dependencies

No new dependencies added. Uses existing:
- `pathlib` (standard library)
- `typer` (CLI framework)
- `rich` (output formatting)

---

## Changelog

For detailed commit history, see:
- [GitHub Commits Since v0.3.8](https://github.com/fraiseql/confiture/compare/v0.3.8...v0.3.9)
- [Full Changelog](../../CHANGELOG.md)

## Contributors

This release includes work from:
- [@evoludigit](https://github.com/evoludigit) - Core implementation and documentation
- Claude Haiku 4.5 - AI-assisted development with TDD discipline

## Acknowledgments

Special thanks to everyone who reported issues with migration file naming and provided feedback that led to this comprehensive solution.

---

**Status**: Beta (Not yet production-tested, but comprehensive tests and documentation included)

For more information, see:
- [Getting Started Guide](../getting-started.md)
- [Migration Naming Best Practices](../guides/migration-naming-best-practices.md)
- [CLI Reference](../reference/cli.md)
- [Troubleshooting Guide](../troubleshooting.md)

---

*Confiture: PostgreSQL migrations, sweetly done üçì*
