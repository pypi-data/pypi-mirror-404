const k=e=>Array.isArray(e),ne=e=>e!==null&&typeof e=="object"&&!k(e),te=e=>typeof e=="string",E=(e,n)=>e===n?!0:e!==null&&n!==null&&typeof e=="object"&&typeof n=="object"&&Object.keys(e).length===Object.keys(n).length&&Object.entries(e).every(([t,r])=>E(r,n[t])),F=(e,n)=>{const t=e==null?void 0:e[n];if(t!==void 0){if(!Object.hasOwn(e,n)||Array.isArray(e)&&!/^\d+$/.test(n)||typeof e!="object")throw new TypeError(`Unsupported property "${n}"`);return t}};function d(e){return(...n)=>{const t=n.map(s=>g(s)),r=t[0],o=t[1];return t.length===1?s=>e(r(s)):t.length===2?s=>e(r(s),o(s)):s=>e(...t.map(y=>y(s)))}}const B={boolean:0,number:1,string:2},G=3,L=(e,n)=>typeof e==typeof n&&typeof e in B?e>n:!1,re=(e,n)=>E(e,n)||L(e,n),Q=(e,n)=>typeof e==typeof n&&typeof e in B?e<n:!1,oe=(e,n)=>E(e,n)||Q(e,n),_={pipe:(...e)=>{const n=e.map(t=>g(t));return t=>n.reduce((r,o)=>o(r),t)},object:e=>{const n=Object.keys(e).map(t=>[t,g(e[t])]);return t=>{const r={};for(const[o,s]of n)r[o]=s(t);return r}},array:(...e)=>{const n=e.map(t=>g(t));return t=>n.map(r=>r(t))},get:(...e)=>{if(e.length===0)return n=>n??null;if(e.length===1){const n=e[0];return t=>F(t,n)??null}return n=>{let t=n;for(const r of e)t=F(t,r);return t??null}},map:e=>{const n=g(e);return t=>t.map(n)},mapObject:e=>{const n=g(e);return t=>{const r={};for(const o of Object.keys(t)){const s=n({key:o,value:t[o]});r[s.key]=s.value}return r}},mapKeys:e=>{const n=g(e);return t=>{const r={};for(const o of Object.keys(t)){const s=n(o);r[s]=t[o]}return r}},mapValues:e=>{const n=g(e);return t=>{const r={};for(const o of Object.keys(t))r[o]=n(t[o]);return r}},filter:e=>{const n=g(e);return t=>t.filter(r=>D(n(r)))},sort:(e=["get"],n)=>{const t=g(e),r=n==="desc"?-1:1;function o(s,y){const i=t(s),v=t(y);if(typeof i!=typeof v){const I=B[typeof i]??G,A=B[typeof v]??G;return I>A?r:I<A?-r:0}return typeof i in B?i>v?r:i<v?-r:0:0}return s=>s.slice().sort(o)},reverse:()=>e=>e.toReversed(),pick:(...e)=>{const n=e.map(([r,...o])=>[o[o.length-1],_.get(...o)]),t=(r,o)=>{const s={};for(const[y,i]of o)s[y]=i(r);return s};return r=>k(r)?r.map(o=>t(o,n)):t(r,n)},groupBy:e=>{const n=g(e);return t=>{const r={};for(const o of t){const s=n(o);r[s]?r[s].push(o):r[s]=[o]}return r}},keyBy:e=>{const n=g(e);return t=>{const r={};for(const o of t){const s=n(o);s in r||(r[s]=o)}return r}},flatten:()=>e=>e.flat(),join:(e="")=>n=>n.join(e),split:d((e,n)=>n!==void 0?e.split(n):e.trim().split(/\s+/)),substring:d((e,n,t)=>e.slice(Math.max(n,0),t)),uniq:()=>e=>{const n=[];for(const t of e)n.findIndex(r=>E(r,t))===-1&&n.push(t);return n},uniqBy:e=>n=>Object.values(_.keyBy(e)(n)),limit:e=>n=>n.slice(0,Math.max(e,0)),size:()=>e=>e.length,keys:()=>Object.keys,values:()=>Object.values,prod:()=>e=>z(e,(n,t)=>n*t),sum:()=>e=>k(e)?e.reduce((n,t)=>n+t,0):K(),average:()=>e=>k(e)?e.length>0?e.reduce((n,t)=>n+t)/e.length:null:K(),min:()=>e=>z(e,(n,t)=>Math.min(n,t)),max:()=>e=>z(e,(n,t)=>Math.max(n,t)),and:d((...e)=>z(e,(n,t)=>!!(n&&t))),or:d((...e)=>z(e,(n,t)=>!!(n||t))),not:d(e=>!e),exists:e=>{const n=e.slice(1),t=n.pop(),r=_.get(...n);return o=>{const s=r(o);return!!s&&Object.hasOwnProperty.call(s,t)}},if:(e,n,t)=>{const r=g(e),o=g(n),s=g(t);return y=>D(r(y))?o(y):s(y)},in:(e,n)=>{const t=g(e),r=g(n);return o=>{const s=t(o);return r(o).findIndex(y=>E(y,s))!==-1}},"not in":(e,n)=>{const t=_.in(e,n);return r=>!t(r)},regex:(e,n,t)=>{const r=new RegExp(n,t),o=g(e);return s=>r.test(o(s))},match:(e,n,t)=>{const r=new RegExp(n,t),o=g(e);return s=>{const y=o(s).match(r);return y?H(y):null}},matchAll:(e,n,t)=>{const r=new RegExp(n,`${t??""}g`),o=g(e);return s=>Array.from(o(s).matchAll(r)).map(H)},eq:d(E),gt:d(L),gte:d(re),lt:d(Q),lte:d(oe),ne:d((e,n)=>!E(e,n)),add:d((e,n)=>e+n),subtract:d((e,n)=>e-n),multiply:d((e,n)=>e*n),divide:d((e,n)=>e/n),mod:d((e,n)=>e%n),pow:d((e,n)=>e**n),abs:d(Math.abs),round:d((e,n=0)=>+`${Math.round(+`${e}e${n}`)}e${-n}`),number:d(e=>{const n=Number(e);return Number.isNaN(Number(e))?null:n}),string:d(String)},D=e=>e!==null&&e!==0&&e!==!1,z=(e,n)=>(k(e)||K(),e.length===0?null:e.reduce(n)),H=e=>{const[n,...t]=e,r=e.groups;return t.length?r?{value:n,groups:t,namedGroups:r}:{value:n,groups:t}:{value:n}},K=()=>{P("Array expected")},P=e=>{throw new TypeError(e)},Z=[];function g(e,n){Z.unshift({..._,...Z[0]});try{const t=k(e)?se(e,Z[0]):ne(e)?P(`Function notation ["object", {...}] expected but got ${JSON.stringify(e)}`):()=>e;return r=>{try{return t(r)}catch(o){throw o.jsonquery=[{data:r,query:e},...o.jsonquery??[]],o}}}finally{Z.shift()}}function se(e,n){const[t,...r]=e,o=n[t];return o||P(`Unknown function '${t}'`),o(...r)}const W=[{pow:"^"},{multiply:"*",divide:"/",mod:"%"},{add:"+",subtract:"-"},{gt:">",gte:">=",lt:"<",lte:"<=",in:"in","not in":"not in"},{eq:"==",ne:"!="},{and:"and"},{or:"or"},{pipe:"|"}],ce=["|","and","or"],X=["|","and","or","*","/","%","+","-"];function Y(e,n){if(!k(n))throw new Error("Invalid custom operators");return n.reduce(ue,e)}function ue(e,{name:n,op:t,at:r,after:o,before:s}){if(r)return e.map(v=>Object.values(v).includes(r)?{...v,[n]:t}:v);const y=o??s,i=e.findIndex(v=>Object.values(v).includes(y));if(i!==-1)return e.toSpliced(i+(o?1:0),0,{[n]:t});throw new Error("Invalid custom operator")}const ie=/^[a-zA-Z_$][a-zA-Z\d_$]*$/,le=/^[a-zA-Z_$][a-zA-Z\d_$]*/,ae=/^"(?:[^"\\]|\\.)*"/,fe=/^-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?/,pe=/^(0|[1-9][0-9]*)/,de=/^(true|false|null)/,ge=/^[ \n\t\r]+/;function ye(e,n){const t=[],r=Y(W,t),o=Object.assign({},...r),s=ce.concat(t.filter(c=>c.vararg).map(c=>c.op)),y=X.concat(t.filter(c=>c.leftAssociative).map(c=>c.op)),i=(c=r.length-1)=>{const p=r[c];if(!p)return I();const h=e[u]==="(";let m=i(c-1);for(;;){if(f(),e[u]==="."&&"pipe"in p){const C=A();m=m[0]==="pipe"?[...m,C]:["pipe",m,C];continue}const q=u,M=v(p);if(!M)break;const T=i(c-1),ee=m[0],V=M===ee&&!h;if(V&&!y.includes(o[M])){u=q;break}m=V&&s.includes(o[M])?[...m,T]:[M,m,T]}return m},v=c=>{const p=Object.keys(c).sort((h,m)=>m.length-h.length);for(const h of p){const m=c[h];if(e.substring(u,u+m.length)===m)return u+=m.length,f(),h}},I=()=>{if(f(),e[u]==="("){u++;const c=i();return O(")"),c}return A()},A=()=>{if(e[u]==="."){const c=[];for(;e[u]===".";)u++,c.push(l()??b()??j()??S("Property expected")),f();return["get",...c]}return R()},R=()=>{const c=u,p=b();if(f(),!p||e[u]!=="(")return u=c,J();u++,f();const h=e[u]!==")"?[i()]:[];for(;u<e.length&&e[u]!==")";)f(),O(","),h.push(i());return O(")"),[p,...h]},J=()=>{if(e[u]==="{"){u++,f();const c={};let p=!0;for(;u<e.length&&e[u]!=="}";){p?p=!1:(O(","),f());const h=l()??b()??j()??S("Key expected");f(),O(":"),c[h]=i()}return O("}"),["object",c]}return a()},a=()=>{if(e[u]==="["){u++,f();const c=[];let p=!0;for(;u<e.length&&e[u]!=="]";)p?p=!1:(O(","),f()),c.push(i());return O("]"),["array",...c]}return l()??$()??x()},l=()=>w(ae,JSON.parse),b=()=>w(le,c=>c),$=()=>w(fe,JSON.parse),j=()=>w(pe,JSON.parse),x=()=>{const c=w(de,JSON.parse);if(c!==void 0)return c;S("Value expected")},N=()=>{f(),u<e.length&&S(`Unexpected part '${e.substring(u)}'`)},w=(c,p)=>{const h=e.substring(u).match(c);if(h)return u+=h[0].length,p(h[0])},f=()=>w(ge,c=>c),O=c=>{e[u]!==c&&S(`Character '${c}' expected`),u++},S=(c,p=u)=>{throw new SyntaxError(`${c} (pos: ${p})`)};let u=0;const U=i();return N(),U}const he=40,me="  ",be=(e,n)=>{const t=me,r=[],o=Y(W,r),s=Object.assign({},...o),y=X.concat(r.filter(a=>a.leftAssociative).map(a=>a.op)),i=(a,l,b=!1)=>k(a)?v(a,l,b):JSON.stringify(a),v=(a,l,b)=>{const[$,...j]=a;if($==="get"&&j.length>0)return A(j);if($==="object")return I(j[0],l);if($==="array"){const f=j.map(O=>i(O,l));return J(f,["[",", ","]"],[`[
${l+t}`,`,
${l+t}`,`
${l}]`])}const x=s[$];if(x){const f=b?"(":"",O=b?")":"",S=j.map((u,U)=>{const c=u==null?void 0:u[0],p=o.findIndex(q=>$ in q),h=o.findIndex(q=>c in q),m=p<h||p===h&&U>0||$===c&&!y.includes(x);return i(u,l+t,m)});return J(S,[f,` ${x} `,O],[f,`
${l+t}${x} `,O])}const N=j.length===1?l:l+t,w=j.map(f=>i(f,N));return J(w,[`${$}(`,", ",")"],j.length===1?[`${$}(`,`,
${l}`,")"]:[`${$}(
${N}`,`,
${N}`,`
${l})`])},I=(a,l)=>{const b=l+t,$=Object.entries(a).map(([j,x])=>`${R(j)}: ${i(x,b)}`);return J($,["{ ",", "," }"],[`{
${b}`,`,
${b}`,`
${l}}`])},A=a=>a.map(l=>`.${R(l)}`).join(""),R=a=>ie.test(a)?a:JSON.stringify(a),J=(a,[l,b,$],[j,x,N])=>l.length+a.reduce((w,f)=>w+f.length+b.length,0)-b.length+$.length<=he?l+a.join(b)+$:j+a.join(x)+N;return i(e,"")};function $e(e,n,t){return g(te(n)?ye(n):n)(e)}export{be as O,$e as b,ye as m};
