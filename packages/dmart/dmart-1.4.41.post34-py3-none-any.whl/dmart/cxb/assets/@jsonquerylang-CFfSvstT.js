const w=e=>Array.isArray(e),X=e=>e!==null&&typeof e=="object"&&!w(e),Y=e=>typeof e=="string",A=(e,n)=>e===n?!0:e!==null&&n!==null&&typeof e=="object"&&typeof n=="object"&&Object.keys(e).length===Object.keys(n).length&&Object.entries(e).every(([t,r])=>A(r,n[t]));function p(e){return(...n)=>{const t=n.map(s=>g(s)),r=t[0],o=t[1];return t.length===1?s=>e(r(s)):t.length===2?s=>e(r(s),o(s)):s=>e(...t.map(h=>h(s)))}}const B={boolean:0,number:1,string:2},F=3,T=(e,n)=>typeof e==typeof n&&typeof e in B?e>n:!1,ee=(e,n)=>A(e,n)||T(e,n),D=(e,n)=>typeof e==typeof n&&typeof e in B?e<n:!1,ne=(e,n)=>A(e,n)||D(e,n),_={pipe:(...e)=>{const n=e.map(t=>g(t));return t=>n.reduce((r,o)=>o(r),t)},object:e=>{const n=Object.keys(e).map(t=>[t,g(e[t])]);return t=>{const r={};for(const[o,s]of n)r[o]=s(t);return r}},array:(...e)=>{const n=e.map(t=>g(t));return t=>n.map(r=>r(t))},get:(...e)=>{if(e.length===0)return n=>n??null;if(e.length===1){const n=e[0];return t=>(t==null?void 0:t[n])??null}return n=>{let t=n;for(const r of e)t=t==null?void 0:t[r];return t??null}},map:e=>{const n=g(e);return t=>t.map(n)},mapObject:e=>{const n=g(e);return t=>{const r={};for(const o of Object.keys(t)){const s=n({key:o,value:t[o]});r[s.key]=s.value}return r}},mapKeys:e=>{const n=g(e);return t=>{const r={};for(const o of Object.keys(t)){const s=n(o);r[s]=t[o]}return r}},mapValues:e=>{const n=g(e);return t=>{const r={};for(const o of Object.keys(t))r[o]=n(t[o]);return r}},filter:e=>{const n=g(e);return t=>t.filter(r=>L(n(r)))},sort:(e=["get"],n)=>{const t=g(e),r=n==="desc"?-1:1;function o(s,h){const i=t(s),j=t(h);if(typeof i!=typeof j){const I=B[typeof i]??F,q=B[typeof j]??F;return I>q?r:I<q?-r:0}return typeof i in B?i>j?r:i<j?-r:0:0}return s=>s.slice().sort(o)},reverse:()=>e=>e.toReversed(),pick:(...e)=>{const n=e.map(([r,...o])=>[o[o.length-1],_.get(...o)]),t=(r,o)=>{const s={};for(const[h,i]of o)s[h]=i(r);return s};return r=>w(r)?r.map(o=>t(o,n)):t(r,n)},groupBy:e=>{const n=g(e);return t=>{const r={};for(const o of t){const s=n(o);r[s]?r[s].push(o):r[s]=[o]}return r}},keyBy:e=>{const n=g(e);return t=>{const r={};for(const o of t){const s=n(o);s in r||(r[s]=o)}return r}},flatten:()=>e=>e.flat(),join:(e="")=>n=>n.join(e),split:p((e,n)=>n!==void 0?e.split(n):e.trim().split(/\s+/)),substring:p((e,n,t)=>e.slice(Math.max(n,0),t)),uniq:()=>e=>{const n=[];for(const t of e)n.findIndex(r=>A(r,t))===-1&&n.push(t);return n},uniqBy:e=>n=>Object.values(_.keyBy(e)(n)),limit:e=>n=>n.slice(0,Math.max(e,0)),size:()=>e=>e.length,keys:()=>Object.keys,values:()=>Object.values,prod:()=>e=>z(e,(n,t)=>n*t),sum:()=>e=>w(e)?e.reduce((n,t)=>n+t,0):R(),average:()=>e=>w(e)?e.length>0?e.reduce((n,t)=>n+t)/e.length:null:R(),min:()=>e=>z(e,(n,t)=>Math.min(n,t)),max:()=>e=>z(e,(n,t)=>Math.max(n,t)),and:p((...e)=>z(e,(n,t)=>!!(n&&t))),or:p((...e)=>z(e,(n,t)=>!!(n||t))),not:p(e=>!e),exists:e=>{const n=e.slice(1),t=n.pop(),r=_.get(...n);return o=>{const s=r(o);return!!s&&Object.hasOwnProperty.call(s,t)}},if:(e,n,t)=>{const r=g(e),o=g(n),s=g(t);return h=>L(r(h))?o(h):s(h)},in:(e,n)=>{const t=g(e),r=g(n);return o=>{const s=t(o);return r(o).findIndex(h=>A(h,s))!==-1}},"not in":(e,n)=>{const t=_.in(e,n);return r=>!t(r)},regex:(e,n,t)=>{const r=new RegExp(n,t),o=g(e);return s=>r.test(o(s))},eq:p(A),gt:p(T),gte:p(ee),lt:p(D),lte:p(ne),ne:p((e,n)=>!A(e,n)),add:p((e,n)=>e+n),subtract:p((e,n)=>e-n),multiply:p((e,n)=>e*n),divide:p((e,n)=>e/n),mod:p((e,n)=>e%n),pow:p((e,n)=>e**n),abs:p(Math.abs),round:p((e,n=0)=>+`${Math.round(+`${e}e${n}`)}e${-n}`),number:p(e=>{const n=Number(e);return Number.isNaN(Number(e))?null:n}),string:p(String)},L=e=>e!==null&&e!==0&&e!==!1,z=(e,n)=>(w(e)||R(),e.length===0?null:e.reduce(n)),R=()=>{U("Array expected")},U=e=>{throw new TypeError(e)},K=[];function g(e,n){K.unshift({..._,...K[0]});try{const t=w(e)?te(e,K[0]):X(e)?U(`Function notation ["object", {...}] expected but got ${JSON.stringify(e)}`):()=>e;return r=>{try{return t(r)}catch(o){throw o.jsonquery=[{data:r,query:e},...o.jsonquery??[]],o}}}finally{K.shift()}}function te(e,n){const[t,...r]=e,o=n[t];return o||U(`Unknown function '${t}'`),o(...r)}const G=[{pow:"^"},{multiply:"*",divide:"/",mod:"%"},{add:"+",subtract:"-"},{gt:">",gte:">=",lt:"<",lte:"<=",in:"in","not in":"not in"},{eq:"==",ne:"!="},{and:"and"},{or:"or"},{pipe:"|"}],re=["|","and","or"],H=["|","and","or","*","/","%","+","-"];function Q(e,n){if(!w(n))throw new Error("Invalid custom operators");return n.reduce(oe,e)}function oe(e,{name:n,op:t,at:r,after:o,before:s}){if(r)return e.map(j=>Object.values(j).includes(r)?{...j,[n]:t}:j);const h=o??s,i=e.findIndex(j=>Object.values(j).includes(h));if(i!==-1)return e.toSpliced(i+(o?1:0),0,{[n]:t});throw new Error("Invalid custom operator")}const se=/^[a-zA-Z_$][a-zA-Z\d_$]*$/,ce=/^[a-zA-Z_$][a-zA-Z\d_$]*/,ue=/^"(?:[^"\\]|\\.)*"/,ie=/^-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?/,ae=/^(0|[1-9][0-9]*)/,le=/^(true|false|null)/,fe=/^[ \n\t\r]+/;function pe(e,n){const t=[],r=Q(G,t),o=Object.assign({},...r),s=re.concat(t.filter(c=>c.vararg).map(c=>c.op)),h=H.concat(t.filter(c=>c.leftAssociative).map(c=>c.op)),i=(c=r.length-1)=>{const d=r[c];if(!d)return I();const y=e[u]==="(";let v=i(c-1);for(;;){f();const J=u,M=j(d);if(!M)break;const V=i(c-1),W=v[0],C=M===W&&!y;if(C&&!h.includes(o[M])){u=J;break}v=C&&s.includes(o[M])?[...v,V]:[M,v,V]}return v},j=c=>{const d=Object.keys(c).sort((y,v)=>v.length-y.length);for(const y of d){const v=c[y];if(e.substring(u,u+v.length)===v)return u+=v.length,f(),y}},I=()=>{if(f(),e[u]==="("){u++;const c=i();return O(")"),c}return q()},q=()=>{if(e[u]==="."){const c=[];for(;e[u]===".";)u++,c.push(a()??m()??$()??S("Property expected"));return["get",...c]}return Z()},Z=()=>{const c=u,d=m();if(f(),!d||e[u]!=="(")return u=c,E();u++,f();const y=e[u]!==")"?[i()]:[];for(;u<e.length&&e[u]!==")";)f(),O(","),y.push(i());return O(")"),[d,...y]},E=()=>{if(e[u]==="{"){u++,f();const c={};let d=!0;for(;u<e.length&&e[u]!=="}";){d?d=!1:(O(","),f());const y=a()??m()??$()??S("Key expected");f(),O(":"),c[y]=i()}return O("}"),["object",c]}return l()},l=()=>{if(e[u]==="["){u++,f();const c=[];let d=!0;for(;u<e.length&&e[u]!=="]";)d?d=!1:(O(","),f()),c.push(i());return O("]"),["array",...c]}return a()??b()??x()},a=()=>k(ue,JSON.parse),m=()=>k(ce,c=>c),b=()=>k(ie,JSON.parse),$=()=>k(ae,JSON.parse),x=()=>{const c=k(le,JSON.parse);if(c!==void 0)return c;S("Value expected")},N=()=>{f(),u<e.length&&S(`Unexpected part '${e.substring(u)}'`)},k=(c,d)=>{const y=e.substring(u).match(c);if(y)return u+=y[0].length,d(y[0])},f=()=>k(fe,c=>c),O=c=>{e[u]!==c&&S(`Character '${c}' expected`),u++},S=(c,d=u)=>{throw new SyntaxError(`${c} (pos: ${d})`)};let u=0;const P=i();return N(),P}const de=40,ge="  ",ye=(e,n)=>{const t=ge,r=[],o=Q(G,r),s=Object.assign({},...o),h=H.concat(r.filter(l=>l.leftAssociative).map(l=>l.op)),i=(l,a,m=!1)=>w(l)?j(l,a,m):JSON.stringify(l),j=(l,a,m)=>{const[b,...$]=l;if(b==="get"&&$.length>0)return q($);if(b==="object")return I($[0],a);if(b==="array"){const f=$.map(O=>i(O,a));return E(f,["[",", ","]"],[`[
${a+t}`,`,
${a+t}`,`
${a}]`])}const x=s[b];if(x){const f=m?"(":"",O=m?")":"",S=$.map((u,P)=>{const c=u==null?void 0:u[0],d=o.findIndex(J=>b in J),y=o.findIndex(J=>c in J),v=d<y||d===y&&P>0||b===c&&!h.includes(x);return i(u,a+t,v)});return E(S,[f,` ${x} `,O],[f,`
${a+t}${x} `,O])}const N=$.length===1?a:a+t,k=$.map(f=>i(f,N));return E(k,[`${b}(`,", ",")"],$.length===1?[`${b}(`,`,
${a}`,")"]:[`${b}(
${N}`,`,
${N}`,`
${a})`])},I=(l,a)=>{const m=a+t,b=Object.entries(l).map(([$,x])=>`${Z($)}: ${i(x,m)}`);return E(b,["{ ",", "," }"],[`{
${m}`,`,
${m}`,`
${a}}`])},q=l=>l.map(a=>`.${Z(a)}`).join(""),Z=l=>se.test(l)?l:JSON.stringify(l),E=(l,[a,m,b],[$,x,N])=>a.length+l.reduce((k,f)=>k+f.length+m.length,0)-m.length+b.length<=de?a+l.join(m)+b:$+l.join(x)+N;return i(e,"")};function he(e,n,t){return g(Y(n)?pe(n):n)(e)}export{he as d,ye as m,pe as p};
